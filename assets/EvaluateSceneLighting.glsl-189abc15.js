import{n as vt}from"./compilerUtils-18d58939.js";import{b as u,g as Lt,m as St,a as Tt,c as It,s as $t,r as xt}from"./PhysicallyBasedRendering.glsl-d457fff5.js";import{u as Pt,a as G,r as wt}from"./Texture2DPassUniform-753de459.js";import{a as E,t as Y,n as l}from"./ShaderBuilder-a7d0da4e.js";import{_ as U}from"./preload-helper-3bce6601.js";import{a as b,t as c,r as h,o as O}from"./typedArrayUtil-4d7bb04c.js";import{r as N}from"./vec2-528adfe4.js";import{E as J,u as At,B as Ot}from"./VisualVariablePassParameters-d460182b.js";import{E as P,N as Q,S as Z,T as C,M as V,P as q,G as H,L as yt,D as Ft,Y as Rt,V as Ct}from"./enums-64ab819c.js";import{j as Dt}from"./cast-fcb46737.js";import{a as Bt,E as Wt}from"./Texture-243be4d7.js";import{u as Ut}from"./SSAOBlur.glsl-8bf33b65.js";import{n as k}from"./basicInterfaces-19ed850e.js";import{x as Mt}from"./SSAO.glsl-980b3771.js";import{n as zt}from"./vec2f64-30dc1443.js";import{n as y,x as F}from"./FramebufferObject-a3b9c52c.js";import{t as Gt}from"./PiUtils.glsl-db6418ee.js";import{o as D}from"./FloatPassUniform-68d54f51.js";import{a as Et,h as f}from"./mathUtils-b4bb77e2.js";import{o as Nt,r as T,j as Vt,g as j,u as qt,A as Ht}from"./vec3-e93e648f.js";import{n as p,r as M,t as K}from"./vec3f64-2f9cef06.js";let tt=class{constructor(t,e){this._module=t,this._loadModule=e}get(){return this._module}async reload(){return this._module=await this._loadModule(),this._module}},it=class{constructor(t,e,n){this.release=n,this.initializeConfiguration(t,e),this._configuration=e.snapshot(),this._program=this.initializeProgram(t),this._pipeline=this.initializePipeline(t.rctx.capabilities)}destroy(){this._program=b(this._program),this._pipeline=this._configuration=null}reload(t){b(this._program),this._program=this.initializeProgram(t),this._pipeline=this.initializePipeline(t.rctx.capabilities)}get program(){return this._program}get compiled(){return this.program.isCompiled}get key(){return this._configuration.key}get configuration(){return this._configuration}bindPipelineState(t,e=null,n){t.setPipelineState(this.getPipelineState(e,n))}ensureAttributeLocations(t){this.program.assertCompatibleVertexAttributeLocations(t)}get primitiveType(){return P.TRIANGLES}getPipelineState(t,e){return this._pipeline}initializeConfiguration(t,e){}},et=class{constructor(t,e,n){this._context=t,this._locations=n,this._textures=new Map,this._freeTextureUnits=new Dt({deallocator:null}),this._glProgram=t.programCache.acquire(e.generate("vertex"),e.generate("fragment"),n),this._glProgram.stop=()=>{throw new Error("Wrapped _glProgram used directly")},this.bindPass=e.generateBind(E.Pass,this),this.bindDraw=e.generateBind(E.Draw,this),this._fragmentUniforms=Bt()?e.fragmentUniforms:null}dispose(){this._glProgram.dispose()}get glName(){return this._glProgram.glName}get isCompiled(){return this._glProgram.isCompiled}setUniform1b(t,e){this._glProgram.setUniform1i(t,e?1:0)}setUniform1i(t,e){this._glProgram.setUniform1i(t,e)}setUniform1f(t,e){this._glProgram.setUniform1f(t,e)}setUniform2fv(t,e){this._glProgram.setUniform2fv(t,e)}setUniform3fv(t,e){this._glProgram.setUniform3fv(t,e)}setUniform4fv(t,e){this._glProgram.setUniform4fv(t,e)}setUniformMatrix3fv(t,e){this._glProgram.setUniformMatrix3fv(t,e)}setUniformMatrix4fv(t,e){this._glProgram.setUniformMatrix4fv(t,e)}setUniform1fv(t,e){this._glProgram.setUniform1fv(t,e)}setUniform1iv(t,e){this._glProgram.setUniform1iv(t,e)}setUniform2iv(t,e){this._glProgram.setUniform3iv(t,e)}setUniform3iv(t,e){this._glProgram.setUniform3iv(t,e)}setUniform4iv(t,e){this._glProgram.setUniform4iv(t,e)}assertCompatibleVertexAttributeLocations(t){t.locations!==this._locations&&console.error("VertexAttributeLocations are incompatible")}stop(){this._textures.clear(),this._freeTextureUnits.clear()}bindTexture(t,e){if(c(e)||e.glName==null){const s=this._textures.get(t);return s&&(this._context.bindTexture(null,s.unit),this._freeTextureUnit(s),this._textures.delete(t)),null}let n=this._textures.get(t);return n==null?(n=this._allocTextureUnit(e),this._textures.set(t,n)):n.texture=e,this._context.useProgram(this),this.setUniform1i(t,n.unit),this._context.bindTexture(e,n.unit),n.unit}rebindTextures(){this._context.useProgram(this),this._textures.forEach((t,e)=>{this._context.bindTexture(t.texture,t.unit),this.setUniform1i(e,t.unit)}),h(this._fragmentUniforms)&&this._fragmentUniforms.forEach(t=>{t.type!=="sampler2D"&&t.type!=="samplerCube"||this._textures.has(t.name)||console.error(`Texture sampler ${t.name} has no bound texture`)})}_allocTextureUnit(t){return{texture:t,unit:this._freeTextureUnits.length===0?this._textures.size:this._freeTextureUnits.pop()}}_freeTextureUnit(t){this._freeTextureUnits.push(t.unit)}};function ie(i,t,e=C.ADD,n=[0,0,0,0]){return{srcRgb:i,srcAlpha:i,dstRgb:t,dstAlpha:t,opRgb:e,opAlpha:e,color:{r:n[0],g:n[1],b:n[2],a:n[3]}}}function ee(i,t,e,n,s=C.ADD,o=C.ADD,r=[0,0,0,0]){return{srcRgb:i,srcAlpha:t,dstRgb:e,dstAlpha:n,opRgb:s,opAlpha:o,color:{r:r[0],g:r[1],b:r[2],a:r[3]}}}const kt={face:Q.BACK,mode:Z.CCW},jt={face:Q.FRONT,mode:Z.CCW},ne=i=>i===k.Back?kt:i===k.Front?jt:null,se={zNear:0,zFar:1},nt={r:!0,g:!0,b:!0,a:!0};function Kt(i){return ei.intern(i)}function Xt(i){return ni.intern(i)}function Yt(i){return si.intern(i)}function Jt(i){return ri.intern(i)}function Qt(i){return ai.intern(i)}function Zt(i){return oi.intern(i)}function ti(i){return li.intern(i)}function ii(i){return hi.intern(i)}function st(i){return ci.intern(i)}let m=class{constructor(t,e){this._makeKey=t,this._makeRef=e,this._interns=new Map}intern(t){if(!t)return null;const e=this._makeKey(t),n=this._interns;return n.has(e)||n.set(e,this._makeRef(t)),n.get(e)??null}};function g(i){return"["+i.join(",")+"]"}const ei=new m(rt,i=>({__tag:"Blending",...i}));function rt(i){return i?g([i.srcRgb,i.srcAlpha,i.dstRgb,i.dstAlpha,i.opRgb,i.opAlpha,i.color.r,i.color.g,i.color.b,i.color.a]):null}const ni=new m(at,i=>({__tag:"Culling",...i}));function at(i){return i?g([i.face,i.mode]):null}const si=new m(ot,i=>({__tag:"PolygonOffset",...i}));function ot(i){return i?g([i.factor,i.units]):null}const ri=new m(lt,i=>({__tag:"DepthTest",...i}));function lt(i){return i?g([i.func]):null}const ai=new m(ht,i=>({__tag:"StencilTest",...i}));function ht(i){return i?g([i.function.func,i.function.ref,i.function.mask,i.operation.fail,i.operation.zFail,i.operation.zPass]):null}const oi=new m(ct,i=>({__tag:"DepthWrite",...i}));function ct(i){return i?g([i.zNear,i.zFar]):null}const li=new m(ut,i=>({__tag:"ColorWrite",...i}));function ut(i){return i?g([i.r,i.g,i.b,i.a]):null}const hi=new m(dt,i=>({__tag:"StencilWrite",...i}));function dt(i){return i?g([i.mask]):null}const ci=new m(ui,i=>({blending:Kt(i.blending),culling:Xt(i.culling),polygonOffset:Yt(i.polygonOffset),depthTest:Jt(i.depthTest),stencilTest:Qt(i.stencilTest),depthWrite:Zt(i.depthWrite),colorWrite:ti(i.colorWrite),stencilWrite:ii(i.stencilWrite)}));function ui(i){return i?g([rt(i.blending),at(i.culling),ot(i.polygonOffset),lt(i.depthTest),ht(i.stencilTest),ct(i.depthWrite),ut(i.colorWrite),dt(i.stencilWrite)]):null}let ae=class{constructor(t){this._pipelineInvalid=!0,this._blendingInvalid=!0,this._cullingInvalid=!0,this._polygonOffsetInvalid=!0,this._depthTestInvalid=!0,this._stencilTestInvalid=!0,this._depthWriteInvalid=!0,this._colorWriteInvalid=!0,this._stencilWriteInvalid=!0,this._stateSetters=t}setPipeline(t){(this._pipelineInvalid||t!==this._pipeline)&&(this._setBlending(t.blending),this._setCulling(t.culling),this._setPolygonOffset(t.polygonOffset),this._setDepthTest(t.depthTest),this._setStencilTest(t.stencilTest),this._setDepthWrite(t.depthWrite),this._setColorWrite(t.colorWrite),this._setStencilWrite(t.stencilWrite),this._pipeline=t),this._pipelineInvalid=!1}invalidateBlending(){this._blendingInvalid=!0,this._pipelineInvalid=!0}invalidateCulling(){this._cullingInvalid=!0,this._pipelineInvalid=!0}invalidatePolygonOffset(){this._polygonOffsetInvalid=!0,this._pipelineInvalid=!0}invalidateDepthTest(){this._depthTestInvalid=!0,this._pipelineInvalid=!0}invalidateStencilTest(){this._stencilTestInvalid=!0,this._pipelineInvalid=!0}invalidateDepthWrite(){this._depthWriteInvalid=!0,this._pipelineInvalid=!0}invalidateColorWrite(){this._colorWriteInvalid=!0,this._pipelineInvalid=!0}invalidateStencilWrite(){this._stencilTestInvalid=!0,this._pipelineInvalid=!0}_setBlending(t){this._blending=this._setSubState(t,this._blending,this._blendingInvalid,this._stateSetters.setBlending),this._blendingInvalid=!1}_setCulling(t){this._culling=this._setSubState(t,this._culling,this._cullingInvalid,this._stateSetters.setCulling),this._cullingInvalid=!1}_setPolygonOffset(t){this._polygonOffset=this._setSubState(t,this._polygonOffset,this._polygonOffsetInvalid,this._stateSetters.setPolygonOffset),this._polygonOffsetInvalid=!1}_setDepthTest(t){this._depthTest=this._setSubState(t,this._depthTest,this._depthTestInvalid,this._stateSetters.setDepthTest),this._depthTestInvalid=!1}_setStencilTest(t){this._stencilTest=this._setSubState(t,this._stencilTest,this._stencilTestInvalid,this._stateSetters.setStencilTest),this._stencilTestInvalid=!1}_setDepthWrite(t){this._depthWrite=this._setSubState(t,this._depthWrite,this._depthWriteInvalid,this._stateSetters.setDepthWrite),this._depthWriteInvalid=!1}_setColorWrite(t){this._colorWrite=this._setSubState(t,this._colorWrite,this._colorWriteInvalid,this._stateSetters.setColorWrite),this._colorWriteInvalid=!1}_setStencilWrite(t){this._stencilWrite=this._setSubState(t,this._stencilWrite,this._stencilWriteInvalid,this._stateSetters.setStencilWrite),this._stencilTestInvalid=!1}_setSubState(t,e,n,s){return(n||t!==e)&&(s(t),this._pipelineInvalid=!0),t}};class di{constructor(t=p()){this.intensity=t}}let mi=class{constructor(t=p(),e=M(.57735,.57735,.57735)){this.intensity=t,this.direction=e}},B=class{constructor(t=p(),e=M(.57735,.57735,.57735),n=!0,s=1,o=1){this.intensity=t,this.direction=e,this.castShadows=n,this.specularStrength=s,this.environmentStrength=o}},mt=class{constructor(){this.r=[0],this.g=[0],this.b=[0]}};function gi(i,t,e){(e=e||i).length=i.length;for(let n=0;n<i.length;n++)e[n]=i[n]*t[n];return e}function R(i,t,e){(e=e||i).length=i.length;for(let n=0;n<i.length;n++)e[n]=i[n]*t;return e}function L(i,t,e){(e=e||i).length=i.length;for(let n=0;n<i.length;n++)e[n]=i[n]+t[n];return e}function gt(i){return(i+1)*(i+1)}function _i(i){return Et(Math.floor(Math.sqrt(i)-1),0,2)}function _t(i,t,e){const n=i[0],s=i[1],o=i[2],r=e||[];return r.length=gt(t),t>=0&&(r[0]=.28209479177),t>=1&&(r[1]=.4886025119*n,r[2]=.4886025119*o,r[3]=.4886025119*s),t>=2&&(r[4]=1.09254843059*n*s,r[5]=1.09254843059*s*o,r[6]=.31539156525*(3*o*o-1),r[7]=1.09254843059*n*o,r[8]=.54627421529*(n*n-s*s)),r}function pi(i,t){const e=gt(i),n=t||{r:[],g:[],b:[]};n.r.length=n.g.length=n.b.length=e;for(let s=0;s<e;s++)n.r[s]=n.g[s]=n.b[s]=0;return n}function fi(i,t){const e=_i(t.r.length);for(const n of i)Vt(W,n.direction),_t(W,e,d),gi(d,w),R(d,n.intensity[0],v),L(t.r,v),R(d,n.intensity[1],v),L(t.g,v),R(d,n.intensity[2],v),L(t.b,v);return t}function bi(i,t){_t(W,0,d);for(const e of i)t.r[0]+=d[0]*w[0]*e.intensity[0]*4*Math.PI,t.g[0]+=d[0]*w[0]*e.intensity[1]*4*Math.PI,t.b[0]+=d[0]*w[0]*e.intensity[2]*4*Math.PI;return t}function vi(i,t,e,n){pi(t,n),Nt(e.intensity,0,0,0);let s=!1;const o=Li,r=Si,_=Ti;o.length=0,r.length=0,_.length=0;for(const a of i)a instanceof B&&!s?(T(e.direction,a.direction),T(e.intensity,a.intensity),e.specularStrength=a.specularStrength,e.environmentStrength=a.environmentStrength,e.castShadows=a.castShadows,s=!0):a instanceof B||a instanceof mi?o.push(a):a instanceof di?r.push(a):a instanceof mt&&_.push(a);fi(o,n),bi(r,n);for(const a of _)L(n.r,a.r),L(n.g,a.g),L(n.b,a.b)}const Li=[],Si=[],Ti=[],d=[0],v=[0],W=p(),w=[3.141593,2.094395,2.094395,2.094395,.785398,.785398,.785398,.785398,.785398];class X{constructor(){this.color=p(),this.intensity=1}}let Ii=class{constructor(){this.direction=p(),this.ambient=new X,this.diffuse=new X}};const pt=.4;class de{constructor(){this._shOrder=2,this._legacy=new Ii,this.globalFactor=.5,this.noonFactor=.5,this._sphericalHarmonics=new mt,this._mainLight=new B(p(),M(1,0,0),!1)}get legacy(){return this._legacy}get sh(){return this._sphericalHarmonics}get mainLight(){return this._mainLight}set(t){vi(t,this._shOrder,this._mainLight,this._sphericalHarmonics),T(this._legacy.direction,this._mainLight.direction);const e=1/Math.PI;this._legacy.ambient.color[0]=.282095*this._sphericalHarmonics.r[0]*e,this._legacy.ambient.color[1]=.282095*this._sphericalHarmonics.g[0]*e,this._legacy.ambient.color[2]=.282095*this._sphericalHarmonics.b[0]*e,j(this._legacy.diffuse.color,this._mainLight.intensity,e),T(x,this._legacy.diffuse.color),j(x,x,pt*this.globalFactor),qt(this._legacy.ambient.color,this._legacy.ambient.color,x)}copyFrom(t){this._sphericalHarmonics.r=Array.from(t.sh.r),this._sphericalHarmonics.g=Array.from(t.sh.g),this._sphericalHarmonics.b=Array.from(t.sh.b),this._mainLight.direction=K(t.mainLight.direction),this._mainLight.intensity=K(t.mainLight.intensity),this._mainLight.castShadows=t.mainLight.castShadows,this._mainLight.specularStrength=t.mainLight.specularStrength,this._mainLight.environmentStrength=t.mainLight.environmentStrength,this.globalFactor=t.globalFactor,this.noonFactor=t.noonFactor}lerpLighting(t,e,n){if(Ht(this._mainLight.intensity,t.mainLight.intensity,e.mainLight.intensity,n),this._mainLight.environmentStrength=f(t.mainLight.environmentStrength,e.mainLight.environmentStrength,n),this._mainLight.specularStrength=f(t.mainLight.specularStrength,e.mainLight.specularStrength,n),T(this._mainLight.direction,e.mainLight.direction),this._mainLight.castShadows=e.mainLight.castShadows,this.globalFactor=f(t.globalFactor,e.globalFactor,n),this.noonFactor=f(t.noonFactor,e.noonFactor,n),t.sh.r.length===e.sh.r.length)for(let s=0;s<e.sh.r.length;s++)this._sphericalHarmonics.r[s]=f(t.sh.r[s],e.sh.r[s],n),this._sphericalHarmonics.g[s]=f(t.sh.g[s],e.sh.g[s],n),this._sphericalHarmonics.b[s]=f(t.sh.b[s],e.sh.b[s],n);else for(let s=0;s<e.sh.r.length;s++)this._sphericalHarmonics.r[s]=e.sh.r[s],this._sphericalHarmonics.g[s]=e.sh.g[s],this._sphericalHarmonics.b[s]=e.sh.b[s]}}const x=p();let ft=class bt extends it{initializeProgram(t){return new et(t.rctx,bt.shader.get().build(),J)}initializePipeline(){return st({colorWrite:nt})}};ft.shader=new tt(Ut,()=>U(()=>import("./SSAOBlur.glsl-0827a845.js"),["assets/SSAOBlur.glsl-0827a845.js","assets/vec3-e93e648f.js","assets/vec3f64-2f9cef06.js","assets/common-c186b691.js","assets/ShaderBuilder-a7d0da4e.js","assets/typedArrayUtil-4d7bb04c.js","assets/Error-ec6249b9.js","assets/string-a318751c.js","assets/VertexAttribute-9c5c630d.js","assets/vec2-528adfe4.js","assets/vec2f64-30dc1443.js","assets/Texture2DPassUniform-753de459.js","assets/SSAOBlur.glsl-8bf33b65.js","assets/ScreenSpacePass-d5e48a9b.js","assets/ReadLinearDepth.glsl-9c87a54a.js","assets/RgbaFloatEncoding.glsl-52af7fcf.js","assets/Texture2DDrawUniform-053796dc.js","assets/FloatPassUniform-68d54f51.js"]));class A extends it{initializeProgram(t){return new et(t.rctx,A.shader.get().build(),J)}initializePipeline(){return st({colorWrite:nt})}}A.shader=new tt(Mt,()=>U(()=>import("./SSAO.glsl-77d39519.js"),["assets/SSAO.glsl-77d39519.js","assets/vec2-528adfe4.js","assets/common-c186b691.js","assets/vec2f64-30dc1443.js","assets/ShaderBuilder-a7d0da4e.js","assets/typedArrayUtil-4d7bb04c.js","assets/Error-ec6249b9.js","assets/string-a318751c.js","assets/VertexAttribute-9c5c630d.js","assets/vec4-790471c0.js","assets/vec4f64-e407da96.js","assets/Texture2DPassUniform-753de459.js","assets/SSAO.glsl-980b3771.js","assets/ScreenSpacePass-d5e48a9b.js","assets/ReadLinearDepth.glsl-9c87a54a.js","assets/RgbaFloatEncoding.glsl-52af7fcf.js","assets/Float4PassUniform-d7bdbc81.js","assets/FloatPassUniform-68d54f51.js"]));class $i extends Y{constructor(){super(...arguments),this.projScale=1}}class xi extends $i{}class Pi extends Y{}class wi extends Pi{constructor(){super(...arguments),this.blurSize=zt()}}const S=2;class me{constructor(t,e,n){this._techniqueRepository=t,this._rctx=e,this._requestRender=n,this._enabled=!1,this._quadVAO=null,this._passParameters=new xi,this._drawParameters=new wi}dispose(){this._quadVAO=b(this._quadVAO)}disposeOffscreenBuffers(){O(this._ssaoFBO,t=>t.resize(0,0)),O(this._blur0FBO,t=>t.resize(0,0)),O(this._blur1FBO,t=>t.resize(0,0))}set enabled(t){t?this._enable():this._disable()}get enabled(){return this._enabled}get ready(){return this.enabled&&h(this._passParameters.noiseTexture)&&h(this._ssaoFBO)&&h(this._blur0FBO)&&h(this._blur1FBO)}get loading(){return this.enabled&&!this.ready}get colorTexture(){return h(this._blur1FBO)?this._blur1FBO.colorTexture:null}get width(){return h(this._ssaoFBO)?this._ssaoFBO.width:-1}get height(){return h(this._ssaoFBO)?this._ssaoFBO.height:-1}computeSSAO(t,e,n){if(!this.enabled||c(e)||c(n)||c(this._passParameters.noiseTexture)||c(this._ssaoFBO)||c(this._blur0FBO)||c(this._blur1FBO))return;const s=this._rctx,o=t.camera;this._passParameters.normalTexture=n,this._passParameters.depthTexture=e,this._passParameters.projScale=1/o.computeRenderPixelSizeAtDist(1);const r=o.fullViewport,_=r[2],a=r[3],I=_/S,$=a/S;this._ssaoFBO.resize(_,a),this._blur0FBO.resize(I,$),this._blur1FBO.resize(I,$),c(this._quadVAO)&&(this._quadVAO=At(this._rctx)),s.bindFramebuffer(this._ssaoFBO),s.setViewport(0,0,_,a),s.bindTechnique(this._ssaoTechnique,this._passParameters,t).bindDraw(this._drawParameters,t,this._passParameters),s.bindVAO(this._quadVAO),s.drawArrays(P.TRIANGLE_STRIP,0,y(this._quadVAO,"geometry"));const z=s.bindTechnique(this._blurTechnique,this._passParameters,t);s.setViewport(0,0,I,$),s.bindFramebuffer(this._blur0FBO),this._drawParameters.colorTexture=this._ssaoFBO.colorTexture,N(this._drawParameters.blurSize,0,S/a),z.bindDraw(this._drawParameters,t,this._passParameters),s.setViewport(0,0,I,$),s.drawArrays(P.TRIANGLE_STRIP,0,y(this._quadVAO,"geometry")),s.bindFramebuffer(this._blur1FBO),this._drawParameters.colorTexture=this._blur0FBO.colorTexture,N(this._drawParameters.blurSize,S/_,0),z.bindDraw(this._drawParameters,t,this._passParameters),s.drawArrays(P.TRIANGLE_STRIP,0,y(this._quadVAO,"geometry")),s.setViewport(r[0],r[1],r[2],r[3])}_selectPrograms(){c(this._ssaoTechnique)&&(this._ssaoTechnique=this._techniqueRepository.acquire(A)),c(this._blurTechnique)&&(this._blurTechnique=this._techniqueRepository.acquire(ft))}_enable(){this.enabled||(this._enabled=!0,this._loadResources(()=>{this._enabled&&this._initialize()}))}_loadResources(t){this._data?t():U(()=>import("./SSAOHelperData-348820a1.js"),[]).then(e=>{this._data=e,t()})}_initialize(){const t={target:V.TEXTURE_2D,pixelFormat:q.RGBA,dataType:H.UNSIGNED_BYTE,samplingMode:yt.LINEAR,wrapMode:Ft.CLAMP_TO_EDGE,width:0,height:0},e={colorTarget:Rt.TEXTURE,depthStencilTarget:Ct.NONE};Ot(this._data.noiseTexture).then(n=>{this._enabled&&(this._ssaoFBO=new F(this._rctx,e,t),this._blur0FBO=new F(this._rctx,e,t),this._blur1FBO=new F(this._rctx,e,t),this._passParameters.noiseTexture=new Wt(this._rctx,{target:V.TEXTURE_2D,pixelFormat:q.RGBA,dataType:H.UNSIGNED_BYTE,hasMipmap:!0,width:n.width,height:n.height},n),this._requestRender())}),this._selectPrograms()}_disable(){this._enabled=!1,this._passParameters.noiseTexture=b(this._passParameters.noiseTexture),this._blur1FBO=b(this._blur1FBO),this._blur0FBO=b(this._blur0FBO),this._ssaoFBO=b(this._ssaoFBO)}get gpuMemoryUsage(){return(h(this._blur0FBO)?this._blur0FBO.gpuMemoryUsage:0)+(h(this._blur1FBO)?this._blur1FBO.gpuMemoryUsage:0)+(h(this._ssaoFBO)?this._ssaoFBO.gpuMemoryUsage:0)}get test(){return{ssao:this._ssaoFBO,blur:this._blur1FBO}}}function Ai(i,t){const e=i.fragment;t.receiveAmbientOcclusion?(e.uniforms.add(Pt("ssaoTex",(n,s)=>s.ssaoHelper.colorTexture,t.hasWebGL2Context?G.None:G.InvSize)),e.constants.add("blurSizePixelsInverse","float",1/S),e.code.add(l`
      float evaluateAmbientOcclusionInverse() {
        vec2 ssaoTextureSizeInverse = ${wt(t,"ssaoTex",!0)};
        return texture2D(ssaoTex, gl_FragCoord.xy * blurSizePixelsInverse * ssaoTextureSizeInverse).a;
      }

      float evaluateAmbientOcclusion() {
        return 1.0 - evaluateAmbientOcclusionInverse();
      }
    `)):e.code.add(l`float evaluateAmbientOcclusionInverse() { return 1.0; }
float evaluateAmbientOcclusion() { return 0.0; }`)}function Oi(i){i.constants.add("ambientBoostFactor","float",pt)}function yi(i){i.uniforms.add(new D("lightingGlobalFactor",(t,e)=>e.lighting.globalFactor))}function ge(i,t){const e=i.fragment;switch(i.include(Ai,t),t.pbrMode!==u.Disabled&&i.include(Lt,t),i.include(St,t),i.include(Gt),e.code.add(l`
    const float GAMMA_SRGB = 2.1;
    const float INV_GAMMA_SRGB = 0.4761904;
    ${t.pbrMode===u.Disabled?"":"const vec3 GROUND_REFLECTANCE = vec3(0.2);"}
  `),Oi(e),yi(e),Tt(e),e.code.add(l`
    float additionalDirectedAmbientLight(vec3 vPosWorld) {
      float vndl = dot(${t.spherical?l`normalize(vPosWorld)`:l`vec3(0.0, 0.0, 1.0)`}, mainLightDirection);
      return smoothstep(0.0, 1.0, clamp(vndl * 2.5, 0.0, 1.0));
    }
  `),It(e),e.code.add(l`vec3 evaluateAdditionalLighting(float ambientOcclusion, vec3 vPosWorld) {
float additionalAmbientScale = additionalDirectedAmbientLight(vPosWorld);
return (1.0 - ambientOcclusion) * additionalAmbientScale * ambientBoostFactor * lightingGlobalFactor * mainLightIntensity;
}`),t.pbrMode){case u.Disabled:case u.WaterOnIntegratedMesh:case u.Water:i.include(xt,t),e.code.add(l`vec3 evaluateSceneLighting(vec3 normalWorld, vec3 albedo, float shadow, float ssao, vec3 additionalLight)
{
vec3 mainLighting = evaluateMainLighting(normalWorld, shadow);
vec3 ambientLighting = calculateAmbientIrradiance(normalWorld, ssao);
vec3 albedoLinear = pow(albedo, vec3(GAMMA_SRGB));
vec3 totalLight = mainLighting + ambientLighting + additionalLight;
totalLight = min(totalLight, vec3(PI));
vec3 outColor = vec3((albedoLinear / PI) * totalLight);
return pow(outColor, vec3(INV_GAMMA_SRGB));
}`);break;case u.Normal:case u.Schematic:e.code.add(l`const float fillLightIntensity = 0.25;
const float horizonLightDiffusion = 0.4;
const float additionalAmbientIrradianceFactor = 0.02;
vec3 evaluateSceneLightingPBR(vec3 normal, vec3 albedo, float shadow, float ssao, vec3 additionalLight, vec3 viewDir, vec3 normalGround, vec3 mrr, vec3 _emission, float additionalAmbientIrradiance)
{
vec3 viewDirection = -viewDir;
vec3 mainLightDirection = mainLightDirection;
vec3 h = normalize(viewDirection + mainLightDirection);
PBRShadingInfo inputs;
inputs.NdotL = clamp(dot(normal, mainLightDirection), 0.001, 1.0);
inputs.NdotV = clamp(abs(dot(normal, viewDirection)), 0.001, 1.0);
inputs.NdotH = clamp(dot(normal, h), 0.0, 1.0);
inputs.VdotH = clamp(dot(viewDirection, h), 0.0, 1.0);
inputs.NdotNG = clamp(dot(normal, normalGround), -1.0, 1.0);
vec3 reflectedView = normalize(reflect(viewDirection, normal));
inputs.RdotNG = clamp(dot(reflectedView, normalGround), -1.0, 1.0);
inputs.albedoLinear = pow(albedo, vec3(GAMMA_SRGB));
inputs.ssao = ssao;
inputs.metalness = mrr[0];
inputs.roughness = clamp(mrr[1] * mrr[1], 0.001, 0.99);`),e.code.add(l`inputs.f0 = (0.16 * mrr[2] * mrr[2]) * (1.0 - inputs.metalness) + inputs.albedoLinear * inputs.metalness;
inputs.f90 = vec3(clamp(dot(inputs.f0, vec3(50.0 * 0.33)), 0.0, 1.0));
inputs.diffuseColor = inputs.albedoLinear * (vec3(1.0) - inputs.f0) * (1.0 - inputs.metalness);`),t.useFillLights?e.uniforms.add(new $t("hasFillLights",(n,s)=>s.enableFillLights)):e.constants.add("hasFillLights","bool",!1),e.code.add(l`vec3 ambientDir = vec3(5.0 * normalGround[1] - normalGround[0] * normalGround[2], - 5.0 * normalGround[0] - normalGround[2] * normalGround[1], normalGround[1] * normalGround[1] + normalGround[0] * normalGround[0]);
ambientDir = ambientDir != vec3(0.0)? normalize(ambientDir) : normalize(vec3(5.0, -1.0, 0.0));
inputs.NdotAmbDir = hasFillLights ? abs(dot(normal, ambientDir)) : 1.0;
vec3 mainLightIrradianceComponent = inputs.NdotL * (1.0 - shadow) * mainLightIntensity;
vec3 fillLightsIrradianceComponent = inputs.NdotAmbDir * mainLightIntensity * fillLightIntensity;
vec3 ambientLightIrradianceComponent = calculateAmbientIrradiance(normal, ssao) + additionalLight;
inputs.skyIrradianceToSurface = ambientLightIrradianceComponent + mainLightIrradianceComponent + fillLightsIrradianceComponent ;
inputs.groundIrradianceToSurface = GROUND_REFLECTANCE * ambientLightIrradianceComponent + mainLightIrradianceComponent + fillLightsIrradianceComponent ;`),e.uniforms.add([new D("lightingSpecularStrength",(n,s)=>s.lighting.mainLight.specularStrength),new D("lightingEnvironmentStrength",(n,s)=>s.lighting.mainLight.environmentStrength)]),e.code.add(l`vec3 horizonRingDir = inputs.RdotNG * normalGround - reflectedView;
vec3 horizonRingH = normalize(viewDirection + horizonRingDir);
inputs.NdotH_Horizon = dot(normal, horizonRingH);
vec3 mainLightRadianceComponent = lightingSpecularStrength * normalDistribution(inputs.NdotH, inputs.roughness) * mainLightIntensity * (1.0 - shadow);
vec3 horizonLightRadianceComponent = lightingEnvironmentStrength * normalDistribution(inputs.NdotH_Horizon, min(inputs.roughness + horizonLightDiffusion, 1.0)) * mainLightIntensity * fillLightIntensity;
vec3 ambientLightRadianceComponent = lightingEnvironmentStrength * calculateAmbientRadiance(ssao) + additionalLight;
inputs.skyRadianceToSurface = ambientLightRadianceComponent + mainLightRadianceComponent + horizonLightRadianceComponent;
inputs.groundRadianceToSurface = GROUND_REFLECTANCE * (ambientLightRadianceComponent + horizonLightRadianceComponent) + mainLightRadianceComponent;
inputs.averageAmbientRadiance = ambientLightIrradianceComponent[1] * (1.0 + GROUND_REFLECTANCE[1]);`),e.code.add(l`
        vec3 reflectedColorComponent = evaluateEnvironmentIllumination(inputs);
        vec3 additionalMaterialReflectanceComponent = inputs.albedoLinear * additionalAmbientIrradiance;
        vec3 emissionComponent = pow(_emission, vec3(GAMMA_SRGB));
        vec3 outColorLinear = reflectedColorComponent + additionalMaterialReflectanceComponent + emissionComponent;
        ${t.pbrMode===u.Schematic?l`vec3 outColor = pow(max(vec3(0.0), outColorLinear - 0.005 * inputs.averageAmbientRadiance), vec3(INV_GAMMA_SRGB));`:l`vec3 outColor = pow(blackLevelSoftCompression(outColorLinear, inputs), vec3(INV_GAMMA_SRGB));`}
        return outColor;
      }
    `);break;default:vt(t.pbrMode);case u.COUNT:}}export{de as L,ae as M,me as P,st as W,nt as _,se as a,jt as b,mi as c,Ai as d,it as e,Oi as f,ne as h,di as i,ee as l,B as n,et as o,ge as p,kt as r,ie as s,tt as t,yi as u};
