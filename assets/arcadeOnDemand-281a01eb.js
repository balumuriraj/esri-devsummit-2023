import{_ as R}from"./preload-helper-3bce6601.js";import"./geometry-b7901087.js";import{s as T,a as A}from"./Error-ec6249b9.js";import{r as L}from"./typedArrayUtil-4d7bb04c.js";import{k as E}from"./Extent-da876e26.js";const M=T.getLogger("esri.support.arcadeOnDemand");let h;function O(){return h||(h=(async()=>{const t=await R(()=>import("./arcadeUtils-e61dca8e.js").then(e=>e.ay),["assets/arcadeUtils-e61dca8e.js","assets/geometry-b7901087.js","assets/ArrayPool-a8ee9378.js","assets/string-a318751c.js","assets/typedArrayUtil-4d7bb04c.js","assets/Error-ec6249b9.js","assets/Extent-da876e26.js","assets/cast-fcb46737.js","assets/nextTick-3ee5a785.js","assets/promiseUtils-1e54421e.js","assets/Ellipsoid-89682c5e.js","assets/Polyline-ff2d7c6b.js","assets/typeUtils-35750739.js","assets/jsonMap-7b8332c9.js","assets/preload-helper-3bce6601.js","assets/number-8d860409.js","assets/locale-30120714.js","assets/Field-61ec9870.js","assets/enumeration-3a03bd31.js","assets/fieldType-f31285f7.js","assets/jsonUtils-229211af.js","assets/featureConversionUtils-03a03f40.js","assets/OptimizedFeature-4ab8d380.js","assets/OptimizedFeatureSet-1d1ac4b9.js","assets/request-6fc81c4c.js","assets/unitUtils-45d1147c.js","assets/hash-0ddfbf4b.js","assets/Portal-2bb189b3.js","assets/Loadable-268c900a.js","assets/Promise-376ab9f6.js","assets/PortalGroup-8e41557a.js","assets/PortalUser-659cc1d2.js","assets/sizeVariableUtils-d4870b0d.js"]);return{arcade:t.arcade,arcadeUtils:t,Dictionary:t.Dictionary,Feature:t.arcadeFeature}})()),h}const J=(t,e,a)=>o.create(t,e,a,null,["$feature"]),N=(t,e,a)=>o.create(t,e,a,null,["$feature","$view"]),V=(t,e,a,c)=>o.create(t,e,a,c,["$feature","$view"]);class o{constructor(e,a,c,l,d,f,r,m){this.script=e,this.evaluate=d;const n=Array.isArray(r)?r:r.fields;this.fields=n,this._syntaxTree=l,this._arcade=a,this._arcadeDictionary=c,this._arcadeFeature=f,this._spatialReference=m,this._referencesGeometry=a.scriptTouchesGeometry(this._syntaxTree),this._referencesScale=this._arcade.referencesMember(this._syntaxTree,"scale")}static async create(e,a,c,l,d,f){const{arcade:r,Feature:m,Dictionary:n}=await O(),y=E.fromJSON(a);let i=null;try{i=r.parseScript(e,f)}catch(s){return M.error(new A("arcade-bad-expression","Failed to parse arcade script",{script:e,error:s})),null}const _=d.reduce((s,G)=>({...s,[G]:null}),{});let u=null;L(l)&&(u=new n(l),u.immutable=!0,_.$config=null);const w=r.scriptUsesGeometryEngine(i),S=w&&r.enableGeometrySupport(),b=r.scriptUsesFeatureSet(i)&&r.enableFeatureSetSupport(),F=r.scriptIsAsync(i),$=F&&r.enableAsyncSupport(),v={vars:_,spatialReference:y,useAsync:!!$};await Promise.all([S,b,$]);const x=new Set;await r.loadDependentModules(x,i,null,F,w);const p=new n;p.immutable=!1,p.setField("scale",0);const g=r.compileScript(i,v),D=s=>("$view"in s&&s.$view&&(p.setField("scale",s.$view.scale),s.$view=p),u&&(s.$config=u),g({vars:s,spatialReference:y}));return new o(e,r,n,i,D,new m,c,y)}repurposeFeature(e){return e.geometry&&!e.geometry.spatialReference&&(e.geometry.spatialReference=this._spatialReference),this._arcadeFeature.repurposeFromGraphicLikeObject(e.geometry,e.attributes,{fields:this.fields}),this._arcadeFeature}createDictionary(){return new this._arcadeDictionary}referencesMember(e){return this._arcade.referencesMember(this._syntaxTree,e)}referencesFunction(e){return this._arcade.referencesFunction(this._syntaxTree,e)}referencesGeometry(){return this._referencesGeometry}referencesScale(){return this._referencesScale}extractFieldLiterals(){return this._arcade.extractExpectedFieldLiterals(this._syntaxTree)}}export{O as i,J as n,N as o,o as p,V as u};
