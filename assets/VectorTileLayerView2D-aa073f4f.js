import{e as P,y as k,n as rt}from"./cast-fcb46737.js";import{g as ot}from"./Graphic-f0e54e86.js";import{y as at}from"./string-a318751c.js";import{s as V}from"./Error-ec6249b9.js";import{t as U,r as v,e as lt}from"./typedArrayUtil-4d7bb04c.js";import{D as nt,j as q}from"./promiseUtils-1e54421e.js";import{l as ht,h as pt}from"./reactiveUtils-4dabbb80.js";import"./ArrayPool-a8ee9378.js";import{m as dt,a as ct}from"./diffUtils-68b89c71.js";import{u as B}from"./aaBoundingRect-193543b5.js";import{E as mt}from"./Extent-da876e26.js";import{L as y}from"./enums-0fc02184.js";import{r as ut,i as _t,l as yt,t as ft,n as gt}from"./TileInfoViewPOT-35134b48.js";import{e as vt}from"./LRUCache-64ec42ee.js";import{a as tt}from"./TileStore-00ac650f.js";import{e as O}from"./TileKey-5aef17b6.js";import{a2 as Tt,a3 as Ct,a4 as bt}from"./index-3b3ee3bc.js";import{n as St}from"./Evented-a45c8b0f.js";import{c as wt,e as Rt}from"./config-1337d16e.js";import{i as N,a as f}from"./StyleDefinition-ff072275.js";import{I as w}from"./enums-4ca4641f.js";import{e as z}from"./mat3f32-d3d088e8.js";import{a as Dt,d as Et}from"./DefaultVertexAttributeLayouts-2bcf3941.js";import{i as It}from"./TileContainer-21007653.js";import{O as E,I as G,R as I,C as et,E as Lt,F as Y}from"./enums-64ab819c.js";import{l as j}from"./StyleRepository-0c36ed5d.js";import{y as Pt}from"./LayerView2D-bacb3dde.js";import{r as Ht,M as At,f as Mt}from"./mat3-3fc68e72.js";import{E as W,b as kt}from"./FramebufferObject-a3b9c52c.js";import"./Texture-243be4d7.js";import"./context-util-a4ce3a7b.js";import{t as Ot}from"./VertexElementDescriptor-2925c6af.js";import{y as K}from"./TileStrategy-a90cd1af.js";import{u as xt}from"./LayerView-bd9a2316.js";import"./nextTick-3ee5a785.js";import"./geometry-b7901087.js";import"./Polyline-ff2d7c6b.js";import"./typeUtils-35750739.js";import"./jsonMap-7b8332c9.js";import"./PopupTemplate-40f3c9aa.js";import"./Clonable-545593ce.js";import"./Collection-910b6f71.js";import"./SimpleObservable-23231131.js";import"./fieldUtils-7f54c4b1.js";import"./preload-helper-3bce6601.js";import"./arcadeOnDemand-281a01eb.js";import"./enumeration-3a03bd31.js";import"./number-27cf8195.js";import"./locale-30120714.js";import"./Identifiable-bfe1ff30.js";import"./symbols-f8232671.js";import"./CIMSymbol-539bd447.js";import"./Symbol-f93ed9fd.js";import"./Color-fb64d77d.js";import"./colorUtils-639f4d25.js";import"./mathUtils-b4bb77e2.js";import"./vec3-e93e648f.js";import"./vec3f64-2f9cef06.js";import"./common-c186b691.js";import"./vec4-790471c0.js";import"./screenUtils-410d12c0.js";import"./opacityUtils-1f7f5126.js";import"./symbolLayerUtils3D-76acc268.js";import"./aaBoundingBox-657a9b82.js";import"./request-6fc81c4c.js";import"./persistableUrlUtils-5f719c3b.js";import"./Symbol3DAnchorPosition2D-5726d999.js";import"./collectionUtils-803d9ba8.js";import"./Portal-2bb189b3.js";import"./Loadable-268c900a.js";import"./Promise-376ab9f6.js";import"./PortalGroup-8e41557a.js";import"./PortalUser-659cc1d2.js";import"./Ellipsoid-89682c5e.js";import"./jsonUtils-229211af.js";import"./workers-6e30d081.js";import"./Connection-9a1cf8da.js";import"./Queue-b7d3cd48.js";import"./assets-8d3e737a.js";import"./intl-65a3e389.js";import"./messages-2289086c.js";import"./Rect-ea14f53a.js";import"./pbf-0e99a620.js";import"./rasterizingUtils-ec11e94c.js";import"./floatRGBA-9ad35d39.js";import"./TileInfo-b0eb8c90.js";import"./unitUtils-45d1147c.js";import"./MemCache-18a255ed.js";import"./rbush-8e36784a.js";import"./quickselect-322ec8e1.js";import"./Query-b96bcde0.js";import"./TimeExtent-23e282b9.js";import"./Field-61ec9870.js";import"./fieldType-f31285f7.js";import"./Cyclical-151bcc41.js";import"./CollectionFlattener-8f4d518b.js";import"./projection-290b739f.js";import"./mat4-44a0988f.js";import"./zscale-89472cba.js";import"./widget-fb292a2f.js";import"./uuid-73213768.js";import"./HandleOwner-9b396af1.js";import"./byteSizeEstimations-f0cab514.js";import"./executeQueryJSON-2fe748db.js";import"./normalizeUtils-27e29a72.js";import"./query-694f7287.js";import"./pbfQueryUtils-4adda2cc.js";import"./OptimizedFeature-4ab8d380.js";import"./OptimizedFeatureSet-1d1ac4b9.js";import"./queryZScale-1481fa99.js";import"./FeatureSet-d32b0eb8.js";import"./RelationshipQuery-0dda77ad.js";import"./LegendOptions-010d0873.js";import"./utils-6786b611.js";import"./asyncUtils-437defc4.js";import"./parser-498c8be0.js";import"./mat4f32-77b3d8ac.js";import"./ItemCache-fd3aceaf.js";import"./jsonUtils-f5674613.js";import"./UniqueValueRenderer-08f8851c.js";import"./colorRamps-9dac42c1.js";import"./sizeVariableUtils-d4870b0d.js";import"./compilerUtils-18d58939.js";import"./lengthUtils-fa751420.js";import"./jsonUtils-0ff4ff96.js";import"./styleUtils-22b14a8b.js";import"./DictionaryLoader-1cbfea53.js";import"./deprecate-035b199e.js";import"./heatmapUtils-aaea3f32.js";import"./vec4f64-e407da96.js";import"./featureConversionUtils-03a03f40.js";import"./TopFeaturesQuery-cad97c37.js";import"./FeatureLayer-041050b6.js";import"./MultiOriginJSONSupport-aae3bc0c.js";import"./LayerFloorInfo-54b916a2.js";import"./FeatureLayerBase-ad5cfa1a.js";import"./HeightModelInfo-5d01231e.js";import"./arcgisLayerUrl-c09f09b4.js";import"./OperationalLayer-97084f13.js";import"./ElevationInfo-215614d8.js";import"./Layer-5ffe0eda.js";import"./editsZScale-6a661299.js";import"./APIKeyMixin-a0a8917a.js";import"./ArcGISService-21dc1d06.js";import"./BlendLayer-20d0571b.js";import"./CustomParametersMixin-47aab0a6.js";import"./EditBusLayer-e750b15b.js";import"./FeatureReductionLayer-d69dae71.js";import"./labelingInfo-607e66b8.js";import"./labelUtils-3108e8d7.js";import"./defaultsJSON-59981e75.js";import"./OrderedLayer-af7a6030.js";import"./PortalLayer-b2643f87.js";import"./PortalItem-bb7e98a6.js";import"./RefreshableLayer-7f154951.js";import"./ScaleRangeLayer-4be07229.js";import"./TemporalLayer-61549309.js";import"./TimeInfo-1d30dc7c.js";import"./FeatureTemplate-c1d0bb70.js";import"./FeatureType-34d71ade.js";import"./fieldProperties-e2eeb1d5.js";import"./FieldsIndex-f104cc5f.js";import"./versionUtils-fd91f55f.js";import"./styleUtils-a989c0af.js";import"./popupUtils-86dc6b94.js";import"./mat2d-2bbb5feb.js";import"./Scheduler-540208b6.js";import"./Basemap-af7f62f8.js";import"./loadAll-b5bfa7ab.js";import"./writeUtils-e686bd33.js";import"./layerUtils-f4d08f94.js";import"./TablesMixin-bc97d131.js";import"./GraphicsCollection-c37a9ffd.js";import"./ViewingMode-5d7d590b.js";import"./vec2-528adfe4.js";import"./vec2f64-30dc1443.js";import"./vec2f32-461e65a9.js";import"./capabilities-302cf20d.js";import"./BoundsStore-b9fa27cc.js";import"./PooledRBush-3e149119.js";import"./mat3f64-c6305894.js";import"./sphere-2af0d852.js";import"./mat4f64-1e28eae0.js";import"./quatf64-7fd38d64.js";import"./lineSegment-10422ca0.js";import"./plane-b575face.js";import"./scaleUtils-93ad8d0c.js";import"./ElevationSamplerData-b87e0e50.js";import"./PhysicallyBasedRendering.glsl-d457fff5.js";import"./View.glsl-3ce196d4.js";import"./ShaderBuilder-a7d0da4e.js";import"./FloatPassUniform-68d54f51.js";import"./Float4PassUniform-d7bdbc81.js";import"./RgbaFloatEncoding.glsl-52af7fcf.js";import"./Texture2DPassUniform-753de459.js";import"./vec3f32-c9aa289f.js";import"./VertexAttribute-9c5c630d.js";import"./Texture2DDrawUniform-053796dc.js";import"./basicInterfaces-19ed850e.js";import"./PiUtils.glsl-db6418ee.js";import"./ReadLinearDepth.glsl-9c87a54a.js";import"./WaterSurface.glsl-c64cb8f1.js";import"./ForwardLinearDepth.glsl-56affafd.js";import"./Matrix3PassUniform-ad9f953b.js";import"./Slice.glsl-3b39b1f7.js";import"./Transform.glsl-6d2e2fd9.js";import"./OutputHighlight.glsl-fbac199a.js";import"./MultipassTerrainTest.glsl-bb236672.js";import"./NormalUtils.glsl-c12729bf.js";import"./AlphaCutoff-96178e0d.js";import"./TransparencyPassType-a11868d2.js";import"./EvaluateSceneLighting.glsl-189abc15.js";import"./VisualVariablePassParameters-d460182b.js";import"./Util-a48361c6.js";import"./SSAOBlur.glsl-8bf33b65.js";import"./ScreenSpacePass-d5e48a9b.js";import"./SSAO.glsl-980b3771.js";import"./ShaderTechniqueConfiguration-9f5b4555.js";import"./HUD.glsl-d3a072ad.js";import"./VerticalOffset.glsl-87cbb2e3.js";import"./objectResourceUtils-d556a033.js";import"./devEnvironmentUtils-5002a058.js";import"./BufferView-903d1848.js";import"./vec33-e98769e8.js";import"./DefaultMaterial_COLOR_GAMMA-fe26fda8.js";import"./types-e1c0a5bf.js";import"./Version-2946cc03.js";import"./quat-3d5eec2d.js";import"./Texture-46c8c2cb.js";import"./TextureOnly.glsl-1ec9a9ef.js";import"./InterleavedLayout-984d67b2.js";import"./MixExternalColor.glsl-ab0706f7.js";import"./symbolColorUtils-b2b55883.js";import"./ObjectAndLayerIdColor.glsl-ad468647.js";import"./OutputDepth.glsl-470c8e2a.js";import"./VisualVariables.glsl-2b937327.js";import"./DiscardOrAdjustAlphaBlend.glsl-73258f38.js";import"./Normals.glsl-76f97814.js";import"./DefaultMaterial.glsl-885671b3.js";import"./VertexColor.glsl-8c022fa8.js";import"./DefaultTechniqueConfiguration-588e5ab2.js";import"./RealisticTree.glsl-b6cc03f2.js";import"./edgeProcessing-f733ce76.js";import"./deduplicate-03981d62.js";import"./projection-a69d43d0.js";import"./Octree-0a267ea2.js";import"./HUDMaterial.glsl-32cf019c.js";import"./sdfPrimitives-9858c36d.js";import"./dehydratedFeatures-0557137d.js";import"./quantizationUtils-4dd81f85.js";import"./labelFormatUtils-d25d1d9e.js";import"./I3SUtil-f31a4571.js";import"./I3SBinaryReader-f4829435.js";import"./LineCallout.glsl-358ef89b.js";import"./earcut-58237617.js";import"./SnappingCandidate-970faec6.js";import"./MeshComponent-a43522cc.js";import"./MarkerSizing.glsl-566261cc.js";import"./RibbonLine.glsl-0f7c2bbc.js";import"./LineStipple.glsl-ed22a88b.js";import"./callExpressionWithFeature-55effb7b.js";import"./LineMarker.glsl-8166d610.js";import"./NativeLine.glsl-742e9e29.js";import"./Path.glsl-9f6bab44.js";import"./ColorMaterial.glsl-3a70e4a7.js";import"./Pattern.glsl-67f4595b.js";import"./LercDecoder-4c9b29b3.js";import"./workerHelper-e756ac3a.js";import"./originUtils-1469eeaf.js";import"./multiOriginJSONSupportUtils-c978f4c3.js";import"./portalItemUtils-2ccd793f.js";import"./enums-2658a65c.js";import"./WGLContainer-8a3733a0.js";import"./WGLBrushVTLSymbol-d778c554.js";import"./number-954e4ab6.js";import"./GeometryUtils-c093d234.js";import"./pixelUtils-d9cd2e49.js";import"./Utils-69cc114d.js";import"./ShaderCompiler-77d0dcb6.js";import"./ProgramTemplate-cc7f8b69.js";import"./MaterialKey-0093a242.js";import"./alignmentUtils-ae955d28.js";import"./utils-317368cb.js";import"./heatmapTextureUtils-2627384f.js";import"./colorUtils-0c057879.js";import"./GeometryUtils-eebff0a0.js";import"./Geometry-daada628.js";const Z=512,Ut=1e-6,$t=(r,t)=>r+1/(1<<2*t);class Ft{constructor(t,e){this._tiles=new Map,this._tileCache=new vt(40,i=>i.dispose()),this._viewSize=[0,0],this._visibleTiles=new Map,this.acquireTile=t.acquireTile,this.releaseTile=t.releaseTile,this.tileInfoView=t.tileInfoView,this._container=e}destroy(){for(const[t,e]of this._tiles)e.dispose();this._tiles=null,this._tileCache.clear(),this._tileCache=null}update(t){this._updateCacheSize(t);const e=this.tileInfoView,i=e.getTileCoverage(t.state,0,"smallest"),{spans:s,lodInfo:o}=i,{level:l}=o,a=this._tiles,h=new Set,p=new Set;for(const{row:n,colFrom:d,colTo:m}of s)for(let g=d;g<=m;g++){const C=O.getId(l,n,o.normalizeCol(g),o.getWorldForColumn(g)),_=this._getOrAcquireTile(C);h.add(C),_.processed()?this._addToContainer(_):p.add(new O(C))}for(const[n,d]of a)d.isCoverage=h.has(n);for(const n of p)this._findPlaceholdersForMissingTiles(n,h);let c=!1;for(const[n,d]of a)d.neededForCoverage=h.has(n),d.neededForCoverage||d.isHoldingForFade&&e.intersects(i,d.key)&&h.add(n),d.isFading&&(c=!0);for(const[n,d]of this._tiles)h.has(n)||this._releaseTile(n);return tt.pool.release(i),!c}clear(){this._tiles.clear(),this._tileCache.clear(),this._visibleTiles.clear()}clearCache(){this._tileCache.clear()}_findPlaceholdersForMissingTiles(t,e){const i=[];for(const[o,l]of this._tiles)this._addPlaceholderChild(i,l,t,e);const s=i.reduce($t,0);Math.abs(1-s)<Ut||this._addPlaceholderParent(t.id,e)}_addPlaceholderChild(t,e,i,s){e.key.level<=i.level||!e.hasData()||zt(i,e.key)&&(this._addToContainer(e),s.add(e.id),t.push(e.key.level-i.level))}_addPlaceholderParent(t,e){const i=this._tiles;let s=t;for(;;){if(s=Bt(s),!s||e.has(s))return;const o=i.get(s);if(o&&o.hasData())return this._addToContainer(o),void e.add(o.id)}}_getOrAcquireTile(t){let e=this._tiles.get(t);return e||(e=this._tileCache.pop(t),e||(e=this.acquireTile(new O(t))),this._tiles.set(t,e),e)}_releaseTile(t){const e=this._tiles.get(t);this.releaseTile(e),this._removeFromContainer(e),this._tiles.delete(t),e.hasData()?this._tileCache.put(t,e,1):e.dispose()}_addToContainer(t){let e;const i=[],s=this._container;if(s.contains(t))return;const o=this._visibleTiles;for(const[l,a]of o)this._canConnectDirectly(t,a)&&i.push(a),U(e)&&this._canConnectDirectly(a,t)&&(e=a);if(v(e)){for(const l of i)e.childrenTiles.delete(l),t.childrenTiles.add(l),l.parentTile=t;e.childrenTiles.add(t),t.parentTile=e}else for(const l of i)t.childrenTiles.add(l),l.parentTile=t;o.set(t.id,t),s.addChild(t)}_removeFromContainer(t){if(this._visibleTiles.delete(t.id),this._container.removeChild(t),v(t.parentTile)){t.parentTile.childrenTiles.delete(t);for(const e of t.childrenTiles)v(t.parentTile)&&t.parentTile.childrenTiles.add(e)}for(const e of t.childrenTiles)e.parentTile=t.parentTile;t.parentTile=null,t.childrenTiles.clear()}_canConnectDirectly(t,e){const i=t.key;let{level:s,row:o,col:l,world:a}=e.key;const h=this._visibleTiles;for(;s>0;){if(s--,o>>=1,l>>=1,i.level===s&&i.row===o&&i.col===l&&i.world===a)return!0;if(h.has(`${s}/${o}/${l}/${a}`))return!1}return!1}_updateCacheSize(t){const e=t.state.size;if(e[0]===this._viewSize[0]&&e[1]===this._viewSize[1])return;const i=Math.ceil(e[0]/Z)+1,s=Math.ceil(e[1]/Z)+1;this._viewSize[0]=e[0],this._viewSize[1]=e[1],this._tileCache.maxSize=5*i*s}}function Bt(r){const[t,e,i,s]=r.split("/"),o=parseInt(t,10);return o===0?null:`${o-1}/${parseInt(e,10)>>1}/${parseInt(i,10)>>1}/${parseInt(s,10)}`}function zt(r,t){const e=t.level-r.level;return r.row===t.row>>e&&r.col===t.col>>e&&r.world===t.world}const Nt=.5,J=1e-6;class Qt extends St{constructor(t,e){super(),this.styleRepository=t,this._tileToHandle=new Map,this._viewState={scale:0,rotation:0,center:[0,0],size:[0,0]},this._declutterViewState={scale:0,rotation:0,center:[0,0],size:[0,0]},this._completed=!1,this._symbolRepository=new ut(4096,e,()=>new Tt),this._symbolDeclutterer=new _t(e,this._symbolRepository,(i,s,o)=>new yt(i,s,o,this.styleRepository,this._zoom,this._viewState.rotation),(i,s)=>{i.allSymbolsFadingOut=!0,i.lastOpacityUpdate=s,Ct(i,s,!0),i.decluttered=!0,i.requestRender()},(i,s)=>this.styleRepository.getStyleLayerByUID(i.styleLayerUID).z-this.styleRepository.getStyleLayerByUID(s.styleLayerUID).z,i=>{const s=this.styleRepository.getStyleLayerByUID(i);if(this._zoom+J<s.minzoom||this._zoom-J>=s.maxzoom)return!1;const o=s.getLayoutProperty("visibility");return!o||o.getValue()!==N.NONE})}addTile(t){t.decluttered=!1,this._tileToHandle.set(t,t.on("symbols-changed",()=>{this._symbolRepository.add(t),this.restartDeclutter()})),this._symbolRepository.add(t),this.restartDeclutter()}removeTile(t){const e=this._tileToHandle.get(t);e&&(this._symbolRepository.removeTile(t),this.restartDeclutter(),e.remove(),this._tileToHandle.delete(t))}update(t,e){return this._zoom=t,this._viewState={scale:e.scale,rotation:e.rotation,center:[e.center[0],e.center[1]],size:[e.size[0],e.size[1]]},this._continueDeclutter(),this._completed}restartDeclutter(){this._completed=!1,this._symbolDeclutterer.restart(),this._notifyUnstable()}clear(){this._completed=!1,this._symbolRepository=null,this._symbolDeclutterer.restart(),this._tileToHandle.forEach(t=>t.remove()),this._tileToHandle.clear()}get stale(){return this._zoom!==this._declutterZoom||this._viewState.size[0]!==this._declutterViewState.size[0]||this._viewState.size[1]!==this._declutterViewState.size[1]||this._viewState.scale!==this._declutterViewState.scale||this._viewState.rotation!==this._declutterViewState.rotation}deleteStyleLayers(t){this._symbolRepository.deleteStyleLayers(t)}_continueDeclutter(){this._completed&&!this.stale||(this._symbolDeclutterer.running||(this._declutterZoom=this._zoom,this._declutterViewState.center[0]=this._viewState.center[0],this._declutterViewState.center[1]=this._viewState.center[1],this._declutterViewState.rotation=this._viewState.rotation,this._declutterViewState.scale=this._viewState.scale,this._declutterViewState.size[0]=this._viewState.size[0],this._declutterViewState.size[1]=this._viewState.size[1],this._symbolDeclutterer.restart()),this._symbolDeclutterer.setScreenSize(this._viewState.size[0],this._viewState.size[1]),this._completed=this._symbolDeclutterer.continue(wt),this._completed&&this._scheduleNotifyStable())}_scheduleNotifyStable(){v(this._stableNotificationHandle)&&clearTimeout(this._stableNotificationHandle),this._stableNotificationHandle=setTimeout(()=>{this._stableNotificationHandle=null,this.emit("fade-complete")},(1+Nt)*Rt)}_notifyUnstable(){v(this._stableNotificationHandle)&&(clearTimeout(this._stableNotificationHandle),this._stableNotificationHandle=null),this.emit("fade-start")}}class Vt extends Dt{_createTransforms(){return{dvs:z(),tileMat3:z()}}}const x=1e-6;function X(r,t){if(r){const e=r.getLayoutProperty("visibility");if(!e||e.getValue()!==N.NONE&&(r.minzoom===void 0||r.minzoom<t+x)&&(r.maxzoom===void 0||r.maxzoom>=t-x))return!0}return!1}class qt extends It{constructor(t){super(t),this._backgroundTiles=[],this._pointToCallbacks=new Map}destroy(){this.removeAllChildren(),this._spriteMosaic&&(this._spriteMosaic.dispose(),this._spriteMosaic=null),this._glyphMosaic&&(this._glyphMosaic.dispose(),this._glyphMosaic=null),v(this._symbolFader)&&(this._symbolFader.clear(),this._symbolFader=null),this._styleRepository=null,this._backgroundTiles=[],this._pointToCallbacks.clear()}setStyleResources(t,e,i){if(this._spriteMosaic=t,this._glyphMosaic=e,this._styleRepository=i,U(this._symbolFader)){const s=new Qt(this._styleRepository,this.children);s.on("fade-start",()=>{this.emit("fade-start"),this.requestRender()}),s.on("fade-complete",()=>{this.emit("fade-complete"),this.requestRender()}),this._symbolFader=s}lt(this._symbolFader).styleRepository=i}setSpriteMosaic(t){this._spriteMosaic.dispose(),this._spriteMosaic=t}deleteStyleLayers(t){v(this._symbolFader)&&this._symbolFader.deleteStyleLayers(t)}async hitTest(t){const e=nt();return this._pointToCallbacks.set(t,e),this.requestRender(),e.promise}enterTileInvalidation(){for(const t of this.children)t.invalidating=!0}createRenderParams(t){return{...super.createRenderParams(t),renderPass:null,styleLayer:null,styleLayerUID:-1,glyphMosaic:this._glyphMosaic,spriteMosaic:this._spriteMosaic,hasClipping:!!this._clippingInfos}}doRender(t){!this.visible||t.drawPhase!==w.MAP&&t.drawPhase!==w.DEBUG||this._spriteMosaic===void 0||super.doRender(t)}addChild(t){return super.addChild(t),v(this._symbolFader)?this._symbolFader.addTile(t):t.decluttered=!0,this.requestRender(),t}removeChild(t){return v(this._symbolFader)&&this._symbolFader.removeTile(t),this.requestRender(),super.removeChild(t)}renderChildren(t){const{drawPhase:e}=t;if(e!==w.DEBUG){if(this._doRender(t),this._pointToCallbacks.size>0){t.drawPhase=w.HITTEST;const i=t.painter.effects.hittestVTL;i.bind(t),this._doRender(t),i.draw(t,this._pointToCallbacks),i.unbind(t),t.drawPhase=e}}else super.renderChildren(t)}removeAllChildren(){for(let t=0;t<this.children.length;t++){const e=this.children[t];v(this._symbolFader)&&this._symbolFader.removeTile(e),e.dispose()}super.removeAllChildren()}getStencilTarget(){return this.children.filter(t=>t.neededForCoverage&&t.hasData())}restartDeclutter(){v(this._symbolFader)&&this._symbolFader.restartDeclutter()}_doRender(t){const{context:e}=t,i=this._styleRepository;if(!i)return;const s=i.layers;let o=!0;t.drawPhase===w.HITTEST&&(o=!1),i.backgroundBucketIds.length>0&&(t.renderPass="background",this._renderBackgroundLayers(t,i.backgroundBucketIds)),super.renderChildren(t),t.drawPhase===w.MAP&&this._fade(t.displayLevel,t.state);const l=this.children.filter(a=>a.visible&&a.hasData());if(!l||l.length===0)return e.bindVAO(),e.setStencilTestEnabled(!0),void e.setBlendingEnabled(!0);for(const a of l)a.triangleCount=0;e.setStencilWriteMask(0),e.setColorMask(!0,!0,!0,!0),e.setStencilOp(E.KEEP,E.KEEP,E.REPLACE),e.setStencilTestEnabled(!0),e.setBlendingEnabled(!1),e.setDepthTestEnabled(!0),e.setDepthWriteEnabled(!0),e.setDepthFunction(G.LEQUAL),e.setClearDepth(1),e.clear(e.gl.DEPTH_BUFFER_BIT),t.renderPass="opaque";for(let a=s.length-1;a>=0;a--)this._renderStyleLayer(s[a],t,l);e.setDepthWriteEnabled(!1),e.setBlendingEnabled(o),e.setBlendFunctionSeparate(I.ONE,I.ONE_MINUS_SRC_ALPHA,I.ONE,I.ONE_MINUS_SRC_ALPHA),t.renderPass="translucent";for(let a=0;a<s.length;a++)this._renderStyleLayer(s[a],t,l);e.bindVAO(),e.setStencilTestEnabled(!0),e.setBlendingEnabled(!0)}_fade(t,e){v(this._symbolFader)&&(this._symbolFader.update(t,e)||this.requestRender())}_renderStyleLayer(t,e,i){const{painter:s,renderPass:o}=e;if(t===void 0)return;const l=t.getLayoutProperty("visibility");if(l&&l.getValue()===N.NONE)return;let a;switch(t.type){case f.BACKGROUND:return;case f.FILL:if(o!=="opaque"&&e.renderPass!=="translucent")return;a="vtlFill";break;case f.LINE:if(o!=="translucent")return;a="vtlLine";break;case f.CIRCLE:if(o!=="translucent")return;a="vtlCircle";break;case f.SYMBOL:if(o!=="translucent")return;a="vtlSymbol"}if(i=t.type===f.SYMBOL?i.filter(p=>p.decluttered):i.filter(p=>p.neededForCoverage),a!=="vtlSymbol"){const p=e.displayLevel;if(i.length===0||t.minzoom!==void 0&&t.minzoom>=p+x||t.maxzoom!==void 0&&t.maxzoom<p-x)return}const h=t.uid;e.styleLayerUID=h,e.styleLayer=t;for(const p of i)if(p.layerData.has(h)){s.renderObjects(e,i,a);break}}_renderBackgroundLayers(t,e){const{context:i,displayLevel:s,painter:o,state:l}=t,a=this._styleRepository;let h=!1;for(const T of e)if(a.getLayerById(T).type===f.BACKGROUND&&X(a.getLayerById(T),s)){h=!0;break}if(!h)return;const p=this._tileInfoView.getTileCoverage(t.state,0,"smallest"),{spans:c,lodInfo:n}=p,{level:d}=n,m=B(),g=[];if(this._renderPasses){const T=this._renderPasses[0];v(this._clippingInfos)&&(T.brushes[0].prepareState(t),T.brushes[0].drawMany(t,this._clippingInfos))}const C=this._backgroundTiles;let _,L=0;for(const{row:T,colFrom:b,colTo:$}of c)for(let S=b;S<=$;S++){if(L<C.length)_=C[L],_.key.set(d,T,n.normalizeCol(S),n.getWorldForColumn(S)),this._tileInfoView.getTileBounds(m,_.key,!1),_.x=m[0],_.y=m[3],_.resolution=this._tileInfoView.getTileResolution(d);else{const A=new O(d,T,n.normalizeCol(S),n.getWorldForColumn(S)),M=this._tileInfoView.getTileBounds(B(),A),D=this._tileInfoView.getTileResolution(d);_=new Vt(A,D,M[0],M[3],512,512,4096,4096),C.push(_)}_.setTransform(l),g.push(_),L++}i.setStencilWriteMask(0),i.setColorMask(!0,!0,!0,!0),i.setStencilOp(E.KEEP,E.KEEP,E.REPLACE),i.setStencilFunction(G.EQUAL,0,255);let H=!0;t.drawPhase===w.HITTEST&&(H=!1),i.setStencilTestEnabled(H);for(const T of e){const b=a.getLayerById(T);b.type===f.BACKGROUND&&X(b,s)&&(t.styleLayerUID=b.uid,t.styleLayer=b,o.renderObjects(t,g,"vtlBackground"))}tt.pool.release(p)}}const Gt={geometry:[new Ot("a_PositionAndFlags",3,et.SHORT,0,6)]},Q=new Map;Q.set("a_PositionAndFlags",0);const Yt={vsPath:"debug/overlay",fsPath:"debug/overlay",attributes:Q};class F extends Et{constructor(t){super(),this._conf=t}static makeFlags(t,e){return t|e<<2}_createTransforms(){return{dvs:z()}}doRender(t){this._updateTransforms(t),this._ensureResources(t);const{context:e}=t;e.useProgram(this._program),this._program.setUniformMatrix3fv("u_dvsMat3",this.transforms.dvs),this._program.setUniform4fv("u_colors",this._conf.getColors(t)),this._program.setUniform1fv("u_opacities",this._conf.getOpacities(t));const{vertexData:i,indexData:s}=this._conf.getMesh(t);this._vertexBuffer.setData(i),this._indexBuffer.setData(s),e.bindVAO(this._vertexArray),e.setBlendingEnabled(!0),e.setBlendFunction(I.ONE,I.ONE_MINUS_SRC_ALPHA),e.setDepthTestEnabled(!1),e.setStencilTestEnabled(!1),e.setColorMask(!0,!0,!0,!0),e.drawElements(Lt.TRIANGLES,s.length,et.UNSIGNED_INT,0)}onDetach(){this._vertexArray&&(this._vertexArray.dispose(),this._vertexArray=null)}_updateTransforms(t){Ht(this.transforms.dvs),At(this.transforms.dvs,this.transforms.dvs,[-1,1]),Mt(this.transforms.dvs,this.transforms.dvs,[2/t.state.size[0],-2/t.state.size[1],1])}_ensureResources(t){const{context:e}=t;this._program||(this._program=t.painter.materialManager.getProgram(Yt)),this._vertexBuffer||(this._vertexBuffer=W.createVertex(e,Y.STREAM_DRAW)),this._indexBuffer||(this._indexBuffer=W.createIndex(e,Y.STREAM_DRAW)),this._vertexArray||(this._vertexArray=new kt(e,Q,Gt,{geometry:this._vertexBuffer},this._indexBuffer))}}let R=class extends Pt(xt){constructor(){super(...arguments),this._styleChanges=[],this._fetchQueue=null,this._parseQueue=null,this._isTileHandlerReady=!1,this.fading=!1,this._getCollidersMesh=r=>{const{pixelRatio:t}=r.state;let e=0;const i=[],s=[];for(const o of this._vectorTileContainer.children)if(o.symbols)for(const[l,a]of o.symbols)for(const h of a)for(const p of h.colliders){const c=(p.xScreen+p.dxScreen)*t,n=(p.yScreen+p.dyScreen)*t,d=p.width*t,m=p.height*t,g=h.unique.parts[p.partIndex].targetOpacity>.5;if(!g&&this.layer.showCollisionBoxes!=="all")continue;const C=2,_=0,L=3,H=0,T=3,b=1,$=3,S=0,A=g?C:_,M=g?L:H,D=F.makeFlags(A,M);i.push(c,n,D,c+d,n,D,c,n+m,D,c+d,n+m,D),s.push(e+0,e+1,e+2,e+1,e+3,e+2),e+=4;const it=g?T:b,st=g?$:S,u=F.makeFlags(it,st);i.push(c,n,u,c+d,n,u,c,n+1,u,c+d,n+1,u),s.push(e+0,e+1,e+2,e+1,e+3,e+2),e+=4,i.push(c,n+m-1,u,c+d,n+m-1,u,c,n+m,u,c+d,n+m,u),s.push(e+0,e+1,e+2,e+1,e+3,e+2),e+=4,i.push(c,n,u,c+1,n,u,c,n+m,u,c+1,n+m,u),s.push(e+0,e+1,e+2,e+1,e+3,e+2),e+=4,i.push(c+d-1,n,u,c+d,n,u,c+d-1,n+m,u,c+d,n+m,u),s.push(e+0,e+1,e+2,e+1,e+3,e+2),e+=4}return{vertexData:new Int16Array(i),indexData:new Uint32Array(s)}},this._getCollidersColors=()=>[1,.5,0,1,1,0,0,1,0,1,.5,1,0,.5,0,1],this._getCollidersOpacities=()=>[.05,.01,.15,.2]}async hitTest(r,t){if(!this._tileHandlerPromise)return null;await this._tileHandlerPromise;const e=await this._vectorTileContainer.hitTest(t);if(!e||e.length===0)return null;const i=e[0]-1,s=this._styleRepository,o=s.getStyleLayerByUID(i);if(!o)return null;const l=s.getStyleLayerIndex(o.id);return[{type:"graphic",mapPoint:r,layer:this.layer,graphic:new ot({attributes:{layerId:l,layerName:o.id,layerUID:i},layer:this.layer,sourceLayer:this.layer})}]}update(r){if(this._tileHandlerPromise&&this._isTileHandlerReady)return r.pixelRatio!==this._tileHandler.devicePixelRatio?(this._start(),void(this._tileHandler.devicePixelRatio=r.pixelRatio)):void(this._styleChanges.length>0?this._tileHandlerPromise=this._applyStyleChanges():(this._fetchQueue.pause(),this._parseQueue.pause(),this._fetchQueue.state=r.state,this._parseQueue.state=r.state,this._tileManager.update(r)||this.requestUpdate(),this._parseQueue.resume(),this._fetchQueue.resume()))}attach(){const{style:r}=this.layer.currentStyleInfo;this._styleRepository=new j(r),this._tileInfoView=new ft(this.layer.tileInfo,this.layer.fullExtent),this._vectorTileContainer=new qt(this._tileInfoView),this._tileHandler=new gt(this.layer,this._styleRepository,window.devicePixelRatio||1),this.container.addChild(this._vectorTileContainer),this._start(),this.handles.add([this._vectorTileContainer.on("fade-start",()=>{this.fading=!0,this.notifyChange("updating"),this.requestUpdate()}),this._vectorTileContainer.on("fade-complete",()=>{var t;(t=this._collisionOverlay)==null||t.requestRender(),this.fading=!1,this.notifyChange("updating"),this.requestUpdate()}),ht(()=>this.layer.showCollisionBoxes,t=>{t!=="none"?this._collisionOverlay||(this._collisionOverlay=new F({getMesh:this._getCollidersMesh,getColors:this._getCollidersColors,getOpacities:this._getCollidersOpacities}),this.container.addChild(this._collisionOverlay)):(this.container.removeChild(this._collisionOverlay),this._collisionOverlay=null),this.container.requestRender()},pt),this.layer.on("paint-change",t=>{if(t.isDataDriven)this._styleChanges.push({type:y.PAINTER_CHANGED,data:t}),this.notifyChange("updating"),this.requestUpdate();else{const e=this._styleRepository,i=e.getLayerById(t.layer);if(!i)return;const s=i.type===f.SYMBOL;e.setPaintProperties(t.layer,t.paint),s&&this._vectorTileContainer.restartDeclutter(),this._vectorTileContainer.requestRender()}}),this.layer.on("layout-change",t=>{const e=this._styleRepository,i=e.getLayerById(t.layer);if(!i)return;const s=dt(i.layout,t.layout);if(!U(s)){if(ct(s,"visibility")&&jt(s)===1)return e.setLayoutProperties(t.layer,t.layout),i.type===f.SYMBOL&&this._vectorTileContainer.restartDeclutter(),void this._vectorTileContainer.requestRender();this._styleChanges.push({type:y.LAYOUT_CHANGED,data:t}),this.notifyChange("updating"),this.requestUpdate()}}),this.layer.on("style-layer-visibility-change",t=>{const e=this._styleRepository,i=e.getLayerById(t.layer);i&&(e.setStyleLayerVisibility(t.layer,t.visibility),i.type===f.SYMBOL&&this._vectorTileContainer.restartDeclutter(),this._vectorTileContainer.requestRender())}),this.layer.on("style-layer-change",t=>{this._styleChanges.push({type:y.LAYER_CHANGED,data:t}),this.notifyChange("updating"),this.requestUpdate()}),this.layer.on("delete-style-layer",t=>{this._styleChanges.push({type:y.LAYER_REMOVED,data:t}),this.notifyChange("updating"),this.requestUpdate()}),this.layer.on("load-style",()=>this._loadStyle()),this.layer.on("spriteSource-change",t=>{this._newSpriteSource=t.spriteSource,this._styleChanges.push({type:y.SPRITES_CHANGED,data:null});const e=this._styleRepository.layers;for(const i of e)switch(i.type){case f.SYMBOL:i.getLayoutProperty("icon-image")&&this._styleChanges.push({type:y.LAYOUT_CHANGED,data:{layer:i.id,layout:i.layout}});break;case f.LINE:i.getPaintProperty("line-pattern")&&this._styleChanges.push({type:y.PAINTER_CHANGED,data:{layer:i.id,paint:i.paint,isDataDriven:i.isPainterDataDriven()}});break;case f.FILL:i.getLayoutProperty("fill-pattern")&&this._styleChanges.push({type:y.PAINTER_CHANGED,data:{layer:i.id,paint:i.paint,isDataDriven:i.isPainterDataDriven()}})}this.notifyChange("updating"),this.requestUpdate()})],this.declaredClass)}detach(){var r,t;this._stop(),this.container.removeAllChildren(),(r=this._vectorTileContainer)==null||r.destroy(),this._vectorTileContainer=null,(t=this._tileHandler)==null||t.destroy(),this._tileHandler=null,this.handles.remove(this.declaredClass)}moveStart(){this.requestUpdate()}viewChange(){this.requestUpdate()}moveEnd(){this._collisionOverlay&&this._vectorTileContainer.restartDeclutter(),this.requestUpdate()}supportsSpatialReference(r){var t;return mt((t=this.layer.tileInfo)==null?void 0:t.spatialReference,r)}canResume(){let r=super.canResume();const{currentStyleInfo:t}=this.layer;if(r&&(t!=null&&t.layerDefinition)){const e=this.view.scale,{minScale:i,maxScale:s}=t.layerDefinition;t&&t.layerDefinition&&(i&&i<e&&(r=!1),s&&s>e&&(r=!1))}return r}isUpdating(){const r=this._vectorTileContainer.children;return!this._isTileHandlerReady||!this._fetchQueue||!this._parseQueue||this._fetchQueue.updating||this._parseQueue.updating||r.length>0&&r.some(t=>t.invalidating)||this.fading}acquireTile(r){const t=this._createVectorTile(r);return this._tileHandlerPromise.then(()=>{this._fetchQueue.push(t.key).then(e=>this._parseQueue.push({key:t.key,data:e})).then(e=>{t.once("attach",()=>this.requestUpdate()),t.setData(e),this.requestUpdate(),this.notifyChange("updating")}).catch(e=>{this.notifyChange("updating"),q(e)||V.getLogger(this.declaredClass).error(e)})}),t}releaseTile(r){const t=r.key.id;this._fetchQueue.abort(t),this._parseQueue.abort(t),this.requestUpdate()}_start(){if(this._stop(),this._tileManager=new Ft({acquireTile:e=>this.acquireTile(e),releaseTile:e=>this.releaseTile(e),tileInfoView:this._tileInfoView},this._vectorTileContainer),!this.layer.currentStyleInfo)return;const r=new AbortController,t=this._tileHandler.start({signal:r.signal}).then(()=>{this._fetchQueue=new K({tileInfoView:this._tileInfoView,process:(e,i)=>this._getTileData(e,i),concurrency:15}),this._parseQueue=new K({tileInfoView:this._tileInfoView,process:(e,i)=>this._parseTileData(e,i),concurrency:8}),this.requestUpdate(),this._isTileHandlerReady=!0});this._tileHandler.spriteMosaic.then(e=>{this._vectorTileContainer.setStyleResources(e,this._tileHandler.glyphMosaic,this._styleRepository),this.requestUpdate()}),this._tileHandlerAbortController=r,this._tileHandlerPromise=t}_stop(){if(!this._tileHandlerAbortController||!this._vectorTileContainer)return;const r=this._tileHandlerAbortController;r&&r.abort(),this._tileHandlerPromise=null,this._isTileHandlerReady=!1,this._fetchQueue&&(this._fetchQueue.destroy(),this._fetchQueue=null),this._parseQueue&&(this._parseQueue.destroy(),this._parseQueue=null),this._tileManager&&(this._tileManager.destroy(),this._tileManager=null),this._vectorTileContainer.removeAllChildren()}async _getTileData(r,t){const e=await this._tileHandler.fetchTileData(r,t);return this.notifyChange("updating"),e}async _parseTileData(r,t){return this._tileHandler.parseTileData(r,t)}async _applyStyleChanges(){this._isTileHandlerReady=!1,this._fetchQueue.pause(),this._parseQueue.pause(),this._fetchQueue.clear(),this._parseQueue.clear(),this._tileManager.clearCache();const r=this._styleChanges;try{await this._tileHandler.updateStyle(r)}catch(l){V.getLogger(this.declaredClass).error("error applying vector-tiles style update",l.message),this._fetchQueue.resume(),this._parseQueue.resume(),this._isTileHandlerReady=!0}const t=this._styleRepository,e=[];r.forEach(l=>{if(l.type!==y.LAYER_REMOVED)return;const a=l.data,h=t.getLayerById(a.layer);h&&e.push(h.uid)});const i=[];let s;r.forEach(l=>{const a=l.type,h=l.data;switch(a){case y.PAINTER_CHANGED:t.setPaintProperties(h.layer,h.paint),s=h.layer;break;case y.LAYOUT_CHANGED:t.setLayoutProperties(h.layer,h.layout),s=h.layer;break;case y.LAYER_REMOVED:return void t.deleteStyleLayer(h.layer);case y.LAYER_CHANGED:t.setStyleLayer(h.layer,h.index),s=h.layer.id;break;case y.SPRITES_CHANGED:this._vectorTileContainer.setSpriteMosaic(this._tileHandler.setSpriteSource(this._newSpriteSource)),this._newSpriteSource=null,s=null}const p=t.getLayerById(s);p&&i.push(p.uid)});const o=this._vectorTileContainer.children;if(e.length>0){this._vectorTileContainer.deleteStyleLayers(e);for(const l of o)l.deleteLayerData(e)}if(this._fetchQueue.resume(),this._parseQueue.resume(),i.length>0){const l=[];for(const a of o){const h=this._fetchQueue.push(a.key).then(p=>this._parseQueue.push({key:a.key,data:p,styleLayerUIDs:i})).then(p=>a.setData(p));l.push(h)}await Promise.all(l)}this._styleChanges=[],this._isTileHandlerReady=!0,this.notifyChange("updating"),this.requestUpdate()}async _loadStyle(){const{style:r}=this.layer.currentStyleInfo,t=at(r);this._isTileHandlerReady=!1,this._fetchQueue.pause(),this._parseQueue.pause(),this._fetchQueue.clear(),this._parseQueue.clear(),this.notifyChange("updating"),this._styleRepository=new j(t),this._vectorTileContainer.destroy(),this._tileManager.clear(),this._tileHandlerAbortController.abort(),this._tileHandlerAbortController=new AbortController;const{signal:e}=this._tileHandlerAbortController;try{this._tileHandlerPromise=this._tileHandler.setStyle(this._styleRepository,t),await this._tileHandlerPromise}catch(s){if(!q(s))throw s}if(e.aborted)return this._fetchQueue.resume(),this._parseQueue.resume(),this._isTileHandlerReady=!0,this.notifyChange("updating"),void this.requestUpdate();const i=await this._tileHandler.spriteMosaic;this._vectorTileContainer.setStyleResources(i,this._tileHandler.glyphMosaic,this._styleRepository),this._fetchQueue.resume(),this._parseQueue.resume(),this._isTileHandlerReady=!0,this.notifyChange("updating"),this.requestUpdate()}_createVectorTile(r){const t=this._tileInfoView.getTileBounds(B(),r),e=this._tileInfoView.getTileResolution(r.level);return new bt(r,e,t[0],t[3],512,512,this._styleRepository)}};function jt(r){if(U(r))return 0;switch(r.type){case"partial":return Object.keys(r.diff).length;case"complete":return Math.max(Object.keys(r.oldValue).length,Object.keys(r.newValue).length);case"collection":return Object.keys(r.added).length+Object.keys(r.changed).length+Object.keys(r.removed).length}}P([k()],R.prototype,"_fetchQueue",void 0),P([k()],R.prototype,"_parseQueue",void 0),P([k()],R.prototype,"_isTileHandlerReady",void 0),P([k()],R.prototype,"fading",void 0),R=P([rt("esri.views.2d.layers.VectorTileLayerView2D")],R);const ma=R;export{ma as default};
