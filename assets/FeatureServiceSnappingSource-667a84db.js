import{o as z,aB as M,e as o,y as n,a as _,v as H,R as u,mH as N,$ as k,l as w,ac as E,i6 as $,ad as R,h as S,aa as x,eA as U,dc as A,a7 as j,ey as V,jh as D,eh as J,K as q,M as Z,N as L,hn as W,cU as T,hO as f,dV as G,bn as B,b as K,n$ as Q,nq as C,qa as X,qb as Y}from"./calcite-c5ae4991.js";import{y as ee}from"./elevationInfoUtils-def3e352.js";import{aR as te,bT as ie,bU as re,bV as oe}from"./MediaLayerVideo-b25b4fca.js";import{i as ne,p as se}from"./queryEngineUtils-0c823715.js";import{b as ae}from"./TileTreeDebugger-775ec8ca.js";import{h as le}from"./LercDecoder-25ed2639.js";import{M as pe}from"./dehydratedFeatures-ce9ee959.js";import"./index-9a6385f7.js";import"./sphere-5ce3b13c.js";import"./mat3f64-50f3b9f6.js";import"./mat4f64-abdda1bb.js";import"./quatf64-f8f1c132.js";import"./Util-2b929b00.js";import"./plane-6ecad71b.js";import"./spatialReferenceEllipsoidUtils-87122df3.js";import"./scaleUtils-a8d07219.js";import"./ElevationSamplerData-41a54d7d.js";import"./objectResourceUtils-8fb711c9.js";import"./devEnvironmentUtils-5002a058.js";import"./BufferView-bc307796.js";import"./vec33-164586fc.js";import"./DefaultMaterial_COLOR_GAMMA-941dbf6c.js";import"./types-e1c0a5bf.js";import"./enums-e2e92c86.js";import"./Version-e2fa8281.js";import"./quat-8dcd84de.js";import"./resourceUtils-527631ac.js";import"./basicInterfaces-7449a8bf.js";import"./Indices-84de656e.js";import"./NestedMap-1b5db22e.js";import"./requestImageUtils-67552ee5.js";import"./symbolColorUtils-14fb8f64.js";import"./VertexAttribute-15d1866a.js";import"./doublePrecisionUtils-e3c3d0d8.js";import"./OrderIndependentTransparency-5f7257d7.js";import"./Texture-3d2bcec7.js";import"./FramebufferObject-d9042b3f.js";import"./VertexElementDescriptor-2925c6af.js";import"./InterleavedLayout-45bbbdfe.js";import"./vec3f32-01c06d8d.js";import"./Octree-65a3a6a2.js";import"./edgeProcessing-fca251f2.js";import"./deduplicate-54cc928a.js";import"./MeshComponent-9e26db57.js";import"./earcut-61f7b102.js";import"./imageUtils-c2d0d1ae.js";import"./projection-425e8064.js";import"./ZoomMomentumEstimator-f0d7cb62.js";import"./floatRGBA-2dd25736.js";import"./labelFormatUtils-2486d06e.js";import"./orientedBoundingBox-d2c06194.js";import"./quatf32-51a323b8.js";import"./SnappingCandidate-970faec6.js";import"./callExpressionWithFeature-94cb1131.js";import"./quantizationUtils-a15bd53f.js";import"./DefaultVertexAttributeLayouts-5f20d8dd.js";import"./geometryServiceUtils-b1997a16.js";import"./project-0e0370f9.js";import"./VectorTile-ade0a955.js";import"./enums-fb086c25.js";import"./config-1337d16e.js";import"./TiledDisplayObject-0268aa47.js";import"./DisplayObject-b5071d0a.js";import"./rasterUtils-0aabb0e8.js";import"./resources-4ce48b80.js";import"./workerHelper-33dafb63.js";import"./webgl-debug-7f880832.js";import"./RenderingContext-f0258ff2.js";import"./ProgramCache-ddf14e3e.js";import"./Program-2221c2b1.js";import"./MediaLayer-faedb24a.js";import"./MediaElementView-92573d58.js";import"./normalizeUtilsSync-f9670301.js";import"./resourceExtension-a1892050.js";import"./BoundsStore-32c0ea98.js";import"./PooledRBush-52d39e88.js";import"./prism-line-numbers-713161a8.js";import"./label2-e5a29f4c.js";import"./interactive-1de2e238.js";import"./loadable-6afd516d.js";import"./t9n-b59ffad1.js";import"./observers-c89705b8.js";import"./icon-179b3e31.js";import"./loader-dc9b20b1.js";import"./guid-51402ee7.js";import"./DimensionAnalysisView3D-afedf533.js";import"./LineVisualElement-520cb14e.js";import"./LengthDimension-f30ab776.js";import"./Segment-dbfb173b.js";import"./analysisViewUtils-ad794640.js";import"./ImageMaterial-b8486f1d.js";import"./Factory-7ff71f8e.js";import"./RightAngleQuadVisualElement-2c22a714.js";import"./VisualElementResources-de04f9e5.js";import"./PointVisualElement-e21f219e.js";import"./colorUtils-c0f43caf.js";import"./EditGeometryOperations-59135cd9.js";import"./QueryEngineResult-7bb9e34b.js";import"./WhereClause-19168e5f.js";import"./executionError-fb3f283a.js";import"./utils-d04d4fee.js";import"./generateRendererUtils-0781e0f0.js";import"./projectionSupport-c2c1f4b7.js";import"./json-48e3ea08.js";import"./utils-d27f2aa1.js";import"./dehydratedFeatureComparison-52788bbf.js";import"./RenderTexture-4c0a650d.js";import"./VertexSnappingCandidate-a79ea0a5.js";function I(e,t){return ie(t.extent,F),re(F,z(de,e.x,e.y,0))}const F=te(),de=M();let c=class extends H{get tiles(){const t=this.tilesCoveringView,i=u(this.pointOfInterest)?this.pointOfInterest:this.view.center;return t.sort((s,r)=>I(i,s)-I(i,r)),t}_scaleEnabled(){return N(this.view.scale,this.layer.minScale||0,this.layer.maxScale||0)}get tilesCoveringView(){if(!this.view.ready||!this.view.featuresTilingScheme||!this.view.state||k(this.tileInfo))return[];if(!this._scaleEnabled)return[];const{spans:t,lodInfo:i}=this.view.featuresTilingScheme.getTileCoverage(this.view.state,0),{level:s}=i,r=[];for(const{row:l,colFrom:a,colTo:p}of t)for(let y=a;y<=p;y++){const v=i.normalizeCol(y),b=new $(null,s,l,v);this.tileInfo.updateTileInfo(b),r.push(b)}return r}get tileInfo(){var t;return((t=this.view.featuresTilingScheme)==null?void 0:t.tileInfo)??null}get tileSize(){return u(this.tileInfo)?this.tileInfo.size[0]:256}constructor(t){super(t),this.pointOfInterest=null}initialize(){this.addHandles(w(()=>{var t,i;return(i=(t=this.view)==null?void 0:t.state)==null?void 0:i.viewpoint},()=>this.notifyChange("tilesCoveringView"),E))}};o([n({readOnly:!0})],c.prototype,"tiles",null),o([n({readOnly:!0})],c.prototype,"_scaleEnabled",null),o([n({readOnly:!0})],c.prototype,"tilesCoveringView",null),o([n({readOnly:!0})],c.prototype,"tileInfo",null),o([n({readOnly:!0})],c.prototype,"tileSize",null),o([n({constructOnly:!0})],c.prototype,"view",void 0),o([n({constructOnly:!0})],c.prototype,"layer",void 0),o([n()],c.prototype,"pointOfInterest",void 0),c=o([_("esri.views.interactive.snapping.featureSources.featureServiceSource.FeatureServiceTiles2D")],c);let m=class extends R{get tiles(){const e=this.tilesCoveringView,t=this._effectivePointOfInterest;if(u(t)){const i=e.map(s=>I(t,s));for(let s=1;s<i.length;s++)if(i[s-1]>i[s])return e.sort((r,l)=>I(t,r)-I(t,l)),e.slice()}return e}get tilesCoveringView(){var e,t;return this._filterTiles((t=(e=this.view.featureTiles)==null?void 0:e.tiles)==null?void 0:t.toArray()).map(ue)}get tileInfo(){var e;return((e=this.view.featureTiles)==null?void 0:e.tilingScheme.toTileInfo())??null}get tileSize(){var e;return((e=this.view.featureTiles)==null?void 0:e.tileSize)??256}get _effectivePointOfInterest(){var t;const e=this.pointOfInterest;return u(e)?e:(t=this.view.pointsOfInterest)==null?void 0:t.focus.location}constructor(e){super(e),this.pointOfInterest=null}initialize(){this.handles.add(w(()=>this.view.featureTiles,e=>{this.handles.remove(P),e&&this.handles.add(e.addClient(),P)},S))}_filterTiles(e){return k(e)?[]:e.filter(t=>Math.abs(t.measures.screenRect[3]-t.measures.screenRect[1])>he&&t.measures.visibility===oe.VISIBLE_ON_SURFACE)}};function ue({lij:[e,t,i],extent:s}){return new $(`${e}/${t}/${i}`,e,t,i,s)}o([n({readOnly:!0})],m.prototype,"tiles",null),o([n({readOnly:!0})],m.prototype,"tilesCoveringView",null),o([n({readOnly:!0})],m.prototype,"tileInfo",null),o([n({readOnly:!0})],m.prototype,"tileSize",null),o([n({constructOnly:!0})],m.prototype,"view",void 0),o([n()],m.prototype,"pointOfInterest",void 0),o([n()],m.prototype,"_effectivePointOfInterest",null),m=o([_("esri.views.interactive.snapping.featureSources.featureServiceSource.FeatureServiceTiles3D")],m);const he=50,P="feature-tiles";let O=class extends ae{constructor(e){super(e),this._handles=new x}initialize(){const e=setInterval(()=>this._fetchDebugInfo(),2e3);this._handles.add(U(()=>clearInterval(e)))}destroy(){this._handles.destroy()}getTiles(){if(!this._debugInfo)return[];const e=new Map,t=new Map;this._debugInfo.storedTiles.forEach(r=>{e.set(r.data.id,r.featureCount)}),this._debugInfo.pendingTiles.forEach(r=>{e.set(r.data.id,r.featureCount),t.set(r.data.id,r.state)});const i=r=>{const l=t.get(r),a=e.get(r)??"?";return l?`${l}:${a}
${r}`:`store:${a}
${r}`},s=new Map;return this._debugInfo.storedTiles.forEach(r=>{s.set(r.data.id,r.data)}),this._debugInfo.pendingTiles.forEach(r=>{s.set(r.data.id,r.data)}),Array.from(s.values()).map(r=>({lij:[r.level,r.row,r.col],geometry:A.fromExtent(j(r.extent,this.view.spatialReference)),label:i(r.id)}))}_fetchDebugInfo(){this.handle.getDebugInfo(null).then(e=>{this._debugInfo=e,this.update()})}};o([n({constructOnly:!0})],O.prototype,"handle",void 0),O=o([_("esri.views.interactive.snapping.featureSources.WorkerTileTreeDebugger")],O);let d=class extends R{get updating(){return this.updatingHandles.updating||this._workerHandleUpdating}constructor(e){super(e),this.schedule=null,this.hasZ=!1,this.elevationAlignPointsInFeatures=async t=>{const i=[];for(const{points:s}of t)for(const{z:r}of s)i.push(r);return{elevations:i,drapedObjectIds:new Set,failedObjectIds:new Set}},this.queryForSymbologySnapping=async()=>({candidates:[],sourceCandidateIndices:[]}),this.availability=0,this._workerHandleUpdating=!0,this._editId=0}destroy(){this._workerHandle.destroy()}initialize(){this._workerHandle=new ce(this.schedule,{alignElevation:async(e,{signal:t})=>({result:await this.elevationAlignPointsInFeatures(e.points,t)}),getSymbologyCandidates:async(e,{signal:t})=>({result:await this.queryForSymbologySnapping(e,t)})}),this.handles.add([this._workerHandle.on("notify-updating",({updating:e})=>this._workerHandleUpdating=e),this._workerHandle.on("notify-availability",({availability:e})=>this._set("availability",e))])}async setup(e,t){var r;const i=this._serviceInfoFromLayer(e.layer);if(k(i))return;const s={configuration:this._convertConfiguration(e.configuration),serviceInfo:i,spatialReference:e.spatialReference.toJSON(),hasZ:this.hasZ,elevationInfo:(r=e.layer.elevationInfo)==null?void 0:r.toJSON()};await this.updatingHandles.addPromise(this._workerHandle.invokeMethod("setup",s,t)),this.updatingHandles.addPromise(this._workerHandle.invokeMethod("whenNotUpdating",{},t))}async configure(e,t){const i=this._convertConfiguration(e);await this.updatingHandles.addPromise(this._workerHandle.invokeMethod("configure",i,t)),this.updatingHandles.addPromise(this._workerHandle.invokeMethod("whenNotUpdating",{},t))}async refresh(e){await this.updatingHandles.addPromise(this._workerHandle.invokeMethod("refresh",{},e)),this.updatingHandles.addPromise(this._workerHandle.invokeMethod("whenNotUpdating",{},e))}async fetchCandidates(e,t){const i=e.point,s={distance:e.distance,mode:e.mode,point:pe(i[0],i[1],i[2],e.coordinateHelper.spatialReference.toJSON()),types:e.types,filter:u(e.filter)?e.filter.toJSON():null};return this._workerHandle.invoke(s,t)}async updateTiles(e,t){const i={tiles:e.tiles,tileInfo:u(e.tileInfo)?e.tileInfo.toJSON():null,tileSize:e.tileSize};await this.updatingHandles.addPromise(this._workerHandle.invokeMethod("updateTiles",i,t)),this.updatingHandles.addPromise(this._workerHandle.invokeMethod("whenNotUpdating",{},t))}async applyEdits(e,t){var a,p,y;const i=this._editId++,s={id:i};await this.updatingHandles.addPromise(this._workerHandle.invokeMethod("beginApplyEdits",s,t));const r=await this.updatingHandles.addPromise(V(e.result,t)),l={id:i,edits:{addedFeatures:((a=r.addedFeatures)==null?void 0:a.map(({objectId:v})=>v).filter(u))??[],deletedFeatures:((p=r.deletedFeatures)==null?void 0:p.map(({objectId:v,globalId:b})=>({objectId:v,globalId:b})))??[],updatedFeatures:((y=r.updatedFeatures)==null?void 0:y.map(({objectId:v})=>v).filter(u))??[]}};await this.updatingHandles.addPromise(this._workerHandle.invokeMethod("endApplyEdits",l,t)),this.updatingHandles.addPromise(this._workerHandle.invokeMethod("whenNotUpdating",{},t))}getDebugInfo(e){return this._workerHandle.invokeMethod("getDebugInfo",{},e)}async notifyElevationSourceChange(){await this._workerHandle.invokeMethod("notifyElevationSourceChange",{})}async notifySymbologyChange(){await this._workerHandle.invokeMethod("notifySymbologyChange",{})}async setSymbologySnappingSupported(e){await this._workerHandle.invokeMethod("setSymbologySnappingSupported",e)}_convertConfiguration(e){return{filter:u(e.filter)?e.filter.toJSON():null,customParameters:e.customParameters,viewType:e.viewType}}_serviceInfoFromLayer(e){var t,i;return e.geometryType==="multipatch"||e.geometryType==="mesh"?null:{url:((t=e.parsedUrl)==null?void 0:t.path)??"",fields:e.fields.map(s=>s.toJSON()),geometryType:D.toJSON(e.geometryType),capabilities:e.capabilities,objectIdField:e.objectIdField,globalIdField:e.globalIdField,spatialReference:e.spatialReference.toJSON(),timeInfo:(i=e.timeInfo)==null?void 0:i.toJSON()}}};o([n({constructOnly:!0})],d.prototype,"schedule",void 0),o([n({constructOnly:!0})],d.prototype,"hasZ",void 0),o([n({constructOnly:!0})],d.prototype,"elevationAlignPointsInFeatures",void 0),o([n({constructOnly:!0})],d.prototype,"queryForSymbologySnapping",void 0),o([n({readOnly:!0})],d.prototype,"updating",null),o([n({readOnly:!0})],d.prototype,"availability",void 0),o([n()],d.prototype,"_workerHandleUpdating",void 0),d=o([_("esri.views.interactive.snapping.featureSources.featureServiceSource.FeatureServiceSnappingSourceWorkerHandle")],d);class ce extends le{constructor(t,i){super("FeatureServiceSnappingSourceWorker","fetchCandidates",{},t,{strategy:"dedicated",client:i})}}let g=class extends H{get tiles(){return[new $("0/0/0",0,0,0,J(-1e8,-1e8,1e8,1e8))]}get tileInfo(){return new q({origin:new Z({x:-1e8,y:1e8,spatialReference:this.layer.spatialReference}),size:[512,512],lods:[new L({level:0,scale:1,resolution:390625})],spatialReference:this.layer.spatialReference})}get tileSize(){return this.tileInfo.size[0]}constructor(e){super(e),this.pointOfInterest=null}};o([n({readOnly:!0})],g.prototype,"tiles",null),o([n({readOnly:!0})],g.prototype,"tileInfo",null),o([n({readOnly:!0})],g.prototype,"tileSize",null),o([n({constructOnly:!0})],g.prototype,"layer",void 0),o([n()],g.prototype,"pointOfInterest",void 0),g=o([_("esri.views.interactive.snapping.featureSources.featureServiceSource.FeatureServiceTilesSimple")],g);let h=class extends W(H){get _updateTilesParameters(){return{tiles:this._tilesOfInterest.tiles,tileInfo:this._tilesOfInterest.tileInfo,tileSize:this._tilesOfInterest.tileSize}}get updating(){var e;return((e=this._workerHandle)==null?void 0:e.updating)||this.updatingHandles.updating}get configuration(){const{view:e}=this,t=u(e)?e.type:"2d";return{filter:this._layer.createQuery(),customParameters:this._layer.customParameters,viewType:t}}get availability(){var e;return((e=this._workerHandle)==null?void 0:e.availability)??0}get _layer(){return this.layerSource.layer}constructor(e){super(e),this._workerHandle=null,this._debug=null}initialize(){let e;const t=this.view;if(u(t))switch(t.type){case"2d":this._tilesOfInterest=new c({view:t,layer:this._layer}),e=this._workerHandle=new d;break;case"3d":{const{resourceController:i}=t,s=this._layer,r=t.whenLayerView(s);this._tilesOfInterest=new m({view:t}),e=this._workerHandle=new d({schedule:a=>i.immediate.schedule(a),hasZ:this._layer.hasZ&&(this._layer.returnZ??!0),elevationAlignPointsInFeatures:async(a,p)=>{const y=await r;return T(p),y.elevationAlignPointsInFeatures(a,p)},queryForSymbologySnapping:async(a,p)=>{const y=await r;return T(p),y.queryForSymbologySnapping(a,p)}});const l=new Y(null);r.then(a=>l.set(a)),this.addHandles([t.elevationProvider.on("elevation-change",({context:a})=>{const{elevationInfo:p}=s;ee(a,p)&&f(e.notifyElevationSourceChange())}),w(()=>s.elevationInfo,()=>f(e.notifyElevationSourceChange()),S),w(()=>G(l.get(),({processor:a})=>a==null?void 0:a.renderer),()=>f(e.notifySymbologyChange()),S),w(()=>B(l.get(),!1,a=>a.symbologySnappingSupported),a=>f(e.setSymbologySnappingSupported(a)),S),K(()=>{var a;return(a=Q(l.get()))==null?void 0:a.layer},["edits","apply-edits","graphic-update"],()=>e.notifySymbologyChange())]);break}}else this._tilesOfInterest=new g({layer:this._layer}),e=this._workerHandle=new d;this.handles.add([C(e)]),f(e.setup({layer:this._layer,spatialReference:this.spatialReference,configuration:this.configuration},null)),this.updatingHandles.add(()=>this._updateTilesParameters,()=>f(e.updateTiles(this._updateTilesParameters,null)),S),this.handles.add([w(()=>this.configuration,i=>f(e.configure(i,null)),E)]),u(t)&&this.handles.add(w(()=>X.FEATURE_SERVICE_SNAPPING_SOURCE_TILE_TREE_SHOW_TILES,i=>{i&&!this._debug?(this._debug=new O({view:t,handle:e}),this.handles.add(C(this._debug),"debug")):!i&&this._debug&&this.handles.remove("debug")},S)),this.handles.add(this.layerSource.layer.on("apply-edits",i=>{f(e.applyEdits(i,null))}))}refresh(){var e;(e=this._workerHandle)==null||e.refresh(null)}async fetchCandidates(e,t){const{coordinateHelper:i,point:s}=e;this._tilesOfInterest.pointOfInterest=i.arrayToPoint(s);const r=this._getGroundElevation;return(await this._workerHandle.fetchCandidates({...e},t)).candidates.map(l=>ne(l,r))}getDebugInfo(e){return this._workerHandle.getDebugInfo(e)}get _getGroundElevation(){return se(this.view)}};o([n({constructOnly:!0})],h.prototype,"spatialReference",void 0),o([n({constructOnly:!0})],h.prototype,"layerSource",void 0),o([n({constructOnly:!0})],h.prototype,"view",void 0),o([n()],h.prototype,"_tilesOfInterest",void 0),o([n({readOnly:!0})],h.prototype,"_updateTilesParameters",null),o([n({readOnly:!0})],h.prototype,"updating",null),o([n({readOnly:!0})],h.prototype,"configuration",null),o([n({readOnly:!0})],h.prototype,"availability",null),o([n()],h.prototype,"_getGroundElevation",null),h=o([_("esri.views.interactive.snapping.featureSources.FeatureServiceSnappingSource")],h);export{h as FeatureServiceSnappingSource};
