import{l as Bt,e as d,y as u,s as je,n as oe,m as ze,t as ve,A as jt}from"./cast-fcb46737.js";import{T as qt,e as Pt,r as h,t as p,w as qe,s as q,h as Ke}from"./typedArrayUtil-4d7bb04c.js";import{a as Xe}from"./ArrayPool-a8ee9378.js";import{n as Kt,c as Xt,d as Zt,a as Yt,b as Jt}from"./LineVisualElement-ae15994e.js";import"./geometry-b7901087.js";import{i as Qt}from"./Clonable-545593ce.js";import{s as Ze}from"./Cyclical-151bcc41.js";import{g as ne}from"./persistable-ad5d84e1.js";import{w as ei}from"./Extent-da876e26.js";import{s as bt}from"./Error-ec6249b9.js";import{l as x,U as ti,w as Se}from"./reactiveUtils-4dabbb80.js";import{aj as ii,ak as ai,ac as si,b4 as Ve,bq as Ie,br as ni,bs as ri,bf as de,b5 as Re,be as Vt,b6 as B,V as Mt,bt as D,bu as ke,bv as we,bw as oi,aV as li,bx as hi,by as Ye,bz as di,x as ci,t as ui,bp as re,bA as $,bd as pi,aT as gi}from"./index-38ff5066.js";import{b as Je}from"./Layer-5ffe0eda.js";import{M as _i}from"./BuildingComponentSublayer-cd73d2b0.js";import{h as yi}from"./string-a318751c.js";import{m as fe,b as mi}from"./mathUtils-b4bb77e2.js";import{p as xe,c as vi,d as Qe,i as wi}from"./screenUtils-410d12c0.js";import{m as fi,R as Ge,i as Tt,u as Y,b as Et,r as et,c as tt,I as it,g as Pi,q as $t}from"./mat4-44a0988f.js";import{e as Me}from"./mat4f64-1e28eae0.js";import{Q as at}from"./quat-3d5eec2d.js";import{g as v,r as L,P as A,_ as j,z as I,u as P,s as C,e as N,o as ie,v as bi,O as st}from"./vec3-e93e648f.js";import{r as G,t as Dt,n as J}from"./vec3f64-2f9cef06.js";import{i as Vi}from"./projection-290b739f.js";import{d as Ct,c as l,e as H,i as Mi,n as nt,o as rt,t as Ti}from"./sphere-2af0d852.js";import{O as Ot,_ as St,R as ot,p as Le,q as ye,Y as Ei}from"./plane-b575face.js";import{e as le,r as Q,l as $i}from"./vec4f64-e407da96.js";import{D as Di,i as It,R as Ci,x as Oi,a as Si,d as ce,z as Ii,s as Ri,m as ki}from"./analysisViewUtils-6a390636.js";import{a as lt}from"./vec4-790471c0.js";import{E as xi,d as Li,x as Ai,c as S}from"./VisualVariablePassParameters-d460182b.js";import{h as Hi}from"./Matrix3PassUniform-ad9f953b.js";import{t as Ni}from"./ShaderTechniqueConfiguration-9f5b4555.js";import{E as zi,t as Gi}from"./objectResourceUtils-d556a033.js";import{_ as Ui}from"./preload-helper-3bce6601.js";import{o as Fi,n as ht,t as Wi}from"./ShaderBuilder-a7d0da4e.js";import{t as Bi,e as ji,o as qi,W as Ki,l as Xi,_ as Zi}from"./EvaluateSceneLighting.glsl-189abc15.js";import{v as Yi}from"./View.glsl-3ce196d4.js";import{e as dt}from"./Float4PassUniform-d7bdbc81.js";import{o as Ji}from"./FloatPassUniform-68d54f51.js";import{O as ct}from"./VertexAttribute-9c5c630d.js";import{R as ue,I as Qi}from"./enums-64ab819c.js";import{n as pe}from"./basicInterfaces-19ed850e.js";import{n as ea}from"./compilerUtils-18d58939.js";import{t as ta}from"./promiseUtils-1e54421e.js";import{o as ia,i as aa,C as ge}from"./Factory-83aaa3aa.js";let z=class extends Qt(Bt){constructor(t){super(t),this.type="plane",this.position=null,this.heading=0,this.tilt=0,this.width=10,this.height=10}equals(t){return this.heading===t.heading&&this.tilt===t.tilt&&qt(this.position,t.position)&&this.width===t.width&&this.height===t.height}};d([u({readOnly:!0,json:{read:!1,write:!0}})],z.prototype,"type",void 0),d([u({type:ei}),ne()],z.prototype,"position",void 0),d([u({type:Number,nonNullable:!0,range:{min:0,max:360}}),ne(),je(e=>Ze.normalize(Xe(e),0,!0))],z.prototype,"heading",void 0),d([u({type:Number,nonNullable:!0,range:{min:0,max:360}}),ne(),je(e=>Ze.normalize(Xe(e),0,!0))],z.prototype,"tilt",void 0),d([u({type:Number,nonNullable:!0}),ne()],z.prototype,"width",void 0),d([u({type:Number,nonNullable:!0}),ne()],z.prototype,"height",void 0),z=d([oe("esri.analysis.SlicePlane")],z);const Ue=z,Te=yi("mac")?"Meta":"Control",Ee="Shift",sa=2,na=1.15,ra=1.15,oa=2500,la=.02,ha=Math.cos(fe(45)),ut=Math.cos(fe(5)),da=.95,ca=.3,ua=.7,he=G(1,.5,0),Rt=2,kt=1,ee=le([...he,ua]),te=[0,0,0,.04],xt=le([...he,.5]),pa=Q(1,1,1,1),ga=Q(1,.8,.6,1),_a=Q(1,.93,.86,1),ya=le([...he,1]),ma=le([...he,1]),va=3,pt=11,Ae=22.5,me=40,gt=48,wa=2.25,fa=le([...he,1]),Pa=4,_t=1,ba=.3,Va=6,Ma=4,yt=1600,Ta=.4;function Ea(e){const t=new Fi;t.extensions.add("GL_OES_standard_derivatives");const{vertex:i,fragment:a,attributes:s,varyings:n}=t;return Yi(i,e),s.add(ct.POSITION,"vec3"),s.add(ct.UV0,"vec2"),n.add("vUV","vec2"),i.code.add(ht`void main(void) {
vUV = uv0;
gl_Position = proj * view * vec4(position, 1.0);
}`),a.uniforms.add([new dt("backgroundColor",r=>r.backgroundColor),new dt("gridColor",r=>r.gridColor),new Ji("gridWidth",r=>r.gridWidth)]),a.code.add(ht`void main() {
const float LINE_WIDTH = 1.0;
vec2 uvScaled = vUV * gridWidth;
vec2 gridUV = (fract(uvScaled + 0.5) - 0.5) / (LINE_WIDTH * fwidth(uvScaled));
vec2 grid = (1.0 - step(0.5, gridUV)) * step(-0.5, gridUV);
grid.x *= step(0.5, uvScaled.x) * step(uvScaled.x, gridWidth - 0.5);
grid.y *= step(0.5, uvScaled.y) * step(uvScaled.y, gridWidth - 0.5);
float gridFade = max(grid.x, grid.y);
float gridAlpha = gridColor.a * gridFade;
gl_FragColor =
vec4(backgroundColor.rgb * backgroundColor.a, backgroundColor.a) * (1.0 - gridAlpha) +
vec4(gridColor.rgb, 1.0) * gridAlpha;
}`),t}const $a=Object.freeze(Object.defineProperty({__proto__:null,build:Ea},Symbol.toStringTag,{value:"Module"}));let Da=class extends Wi{constructor(){super(...arguments),this.backgroundColor=Q(1,0,0,.5),this.gridColor=Q(0,1,0,.5),this.gridWidth=4}},Lt=class At extends ji{initializeProgram(t){return new qi(t.rctx,At.shader.get().build(this.configuration),xi)}initializePipeline(){return Ki({blending:Xi(ue.ONE,ue.ONE,ue.ONE_MINUS_SRC_ALPHA,ue.ONE_MINUS_SRC_ALPHA),depthTest:{func:Qi.LESS},colorWrite:Zi})}};Lt.shader=new Bi($a,()=>Ui(()=>import("./SlicePlaneMaterial.glsl-feaf83cc.js"),["assets/SlicePlaneMaterial.glsl-feaf83cc.js","assets/View.glsl-3ce196d4.js","assets/mat4-44a0988f.js","assets/vec3f64-2f9cef06.js","assets/common-c186b691.js","assets/mat4f32-77b3d8ac.js","assets/vec3-e93e648f.js","assets/ShaderBuilder-a7d0da4e.js","assets/typedArrayUtil-4d7bb04c.js","assets/Error-ec6249b9.js","assets/string-a318751c.js","assets/VertexAttribute-9c5c630d.js","assets/cast-fcb46737.js","assets/ArrayPool-a8ee9378.js","assets/nextTick-3ee5a785.js","assets/promiseUtils-1e54421e.js","assets/LineVisualElement-ae15994e.js","assets/Promise-376ab9f6.js","assets/projection-290b739f.js","assets/preload-helper-3bce6601.js","assets/mathUtils-b4bb77e2.js","assets/vec4-790471c0.js","assets/unitUtils-45d1147c.js","assets/jsonMap-7b8332c9.js","assets/Extent-da876e26.js","assets/Ellipsoid-89682c5e.js","assets/SimpleObservable-23231131.js","assets/Polyline-ff2d7c6b.js","assets/assets-8d3e737a.js","assets/request-6fc81c4c.js","assets/aaBoundingRect-193543b5.js","assets/zscale-89472cba.js","assets/index-38ff5066.js","assets/Graphic-f0e54e86.js","assets/geometry-b7901087.js","assets/typeUtils-35750739.js","assets/PopupTemplate-40f3c9aa.js","assets/Clonable-545593ce.js","assets/Collection-910b6f71.js","assets/Evented-a45c8b0f.js","assets/fieldUtils-7f54c4b1.js","assets/arcadeOnDemand-281a01eb.js","assets/enumeration-3a03bd31.js","assets/number-27cf8195.js","assets/locale-30120714.js","assets/Identifiable-bfe1ff30.js","assets/symbols-f8232671.js","assets/CIMSymbol-539bd447.js","assets/Symbol-f93ed9fd.js","assets/Color-fb64d77d.js","assets/colorUtils-639f4d25.js","assets/screenUtils-410d12c0.js","assets/opacityUtils-1f7f5126.js","assets/symbolLayerUtils3D-76acc268.js","assets/aaBoundingBox-657a9b82.js","assets/persistableUrlUtils-5f719c3b.js","assets/Symbol3DAnchorPosition2D-5726d999.js","assets/collectionUtils-803d9ba8.js","assets/Portal-2bb189b3.js","assets/Loadable-268c900a.js","assets/PortalGroup-8e41557a.js","assets/PortalUser-659cc1d2.js","assets/jsonUtils-229211af.js","assets/Cyclical-151bcc41.js","assets/CollectionFlattener-8f4d518b.js","assets/reactiveUtils-4dabbb80.js","assets/workers-6e30d081.js","assets/Connection-9a1cf8da.js","assets/Queue-b7d3cd48.js","assets/intl-65a3e389.js","assets/messages-2289086c.js","assets/TileInfo-b0eb8c90.js","assets/widget-fb292a2f.js","assets/uuid-73213768.js","assets/HandleOwner-9b396af1.js","assets/byteSizeEstimations-f0cab514.js","assets/executeQueryJSON-2fe748db.js","assets/normalizeUtils-27e29a72.js","assets/query-694f7287.js","assets/pbfQueryUtils-4adda2cc.js","assets/pbf-0e99a620.js","assets/OptimizedFeature-4ab8d380.js","assets/OptimizedFeatureSet-1d1ac4b9.js","assets/queryZScale-1481fa99.js","assets/FeatureSet-d32b0eb8.js","assets/Field-61ec9870.js","assets/fieldType-f31285f7.js","assets/Query-b96bcde0.js","assets/TimeExtent-23e282b9.js","assets/RelationshipQuery-0dda77ad.js","assets/LegendOptions-010d0873.js","assets/utils-6786b611.js","assets/asyncUtils-437defc4.js","assets/parser-498c8be0.js","assets/ItemCache-fd3aceaf.js","assets/MemCache-18a255ed.js","assets/jsonUtils-f5674613.js","assets/UniqueValueRenderer-08f8851c.js","assets/diffUtils-68b89c71.js","assets/colorRamps-9dac42c1.js","assets/sizeVariableUtils-d4870b0d.js","assets/compilerUtils-18d58939.js","assets/lengthUtils-fa751420.js","assets/jsonUtils-0ff4ff96.js","assets/styleUtils-22b14a8b.js","assets/DictionaryLoader-1cbfea53.js","assets/LRUCache-64ec42ee.js","assets/deprecate-035b199e.js","assets/heatmapUtils-aaea3f32.js","assets/vec4f64-e407da96.js","assets/featureConversionUtils-03a03f40.js","assets/TopFeaturesQuery-cad97c37.js","assets/FeatureLayer-041050b6.js","assets/MultiOriginJSONSupport-aae3bc0c.js","assets/LayerFloorInfo-54b916a2.js","assets/FeatureLayerBase-ad5cfa1a.js","assets/HeightModelInfo-5d01231e.js","assets/arcgisLayerUrl-c09f09b4.js","assets/OperationalLayer-97084f13.js","assets/ElevationInfo-215614d8.js","assets/Layer-5ffe0eda.js","assets/editsZScale-6a661299.js","assets/APIKeyMixin-a0a8917a.js","assets/ArcGISService-21dc1d06.js","assets/BlendLayer-20d0571b.js","assets/CustomParametersMixin-47aab0a6.js","assets/EditBusLayer-e750b15b.js","assets/FeatureReductionLayer-d69dae71.js","assets/labelingInfo-607e66b8.js","assets/labelUtils-3108e8d7.js","assets/defaultsJSON-59981e75.js","assets/OrderedLayer-af7a6030.js","assets/PortalLayer-b2643f87.js","assets/PortalItem-bb7e98a6.js","assets/RefreshableLayer-7f154951.js","assets/ScaleRangeLayer-4be07229.js","assets/TemporalLayer-61549309.js","assets/TimeInfo-1d30dc7c.js","assets/FeatureTemplate-c1d0bb70.js","assets/FeatureType-34d71ade.js","assets/fieldProperties-e2eeb1d5.js","assets/FieldsIndex-f104cc5f.js","assets/versionUtils-fd91f55f.js","assets/styleUtils-a989c0af.js","assets/popupUtils-86dc6b94.js","assets/mat2d-2bbb5feb.js","assets/Scheduler-540208b6.js","assets/Basemap-af7f62f8.js","assets/loadAll-b5bfa7ab.js","assets/writeUtils-e686bd33.js","assets/layerUtils-f4d08f94.js","assets/TablesMixin-bc97d131.js","assets/GraphicsCollection-c37a9ffd.js","assets/ViewingMode-5d7d590b.js","assets/enums-0fc02184.js","assets/vec2-528adfe4.js","assets/vec2f64-30dc1443.js","assets/mat3-3fc68e72.js","assets/mat3f32-d3d088e8.js","assets/vec2f32-461e65a9.js","assets/TileStrategy-a90cd1af.js","assets/TileStore-00ac650f.js","assets/TileKey-5aef17b6.js","assets/rbush-8e36784a.js","assets/quickselect-322ec8e1.js","assets/capabilities-302cf20d.js","assets/context-util-a4ce3a7b.js","assets/BoundsStore-b9fa27cc.js","assets/PooledRBush-3e149119.js","assets/mat3f64-c6305894.js","assets/sphere-2af0d852.js","assets/mat4f64-1e28eae0.js","assets/quatf64-7fd38d64.js","assets/lineSegment-10422ca0.js","assets/plane-b575face.js","assets/scaleUtils-93ad8d0c.js","assets/ElevationSamplerData-b87e0e50.js","assets/PhysicallyBasedRendering.glsl-d457fff5.js","assets/FloatPassUniform-68d54f51.js","assets/Float4PassUniform-d7bdbc81.js","assets/RgbaFloatEncoding.glsl-52af7fcf.js","assets/Texture2DPassUniform-753de459.js","assets/vec3f32-c9aa289f.js","assets/Texture2DDrawUniform-053796dc.js","assets/basicInterfaces-19ed850e.js","assets/PiUtils.glsl-db6418ee.js","assets/ReadLinearDepth.glsl-9c87a54a.js","assets/WaterSurface.glsl-c64cb8f1.js","assets/ForwardLinearDepth.glsl-56affafd.js","assets/Matrix3PassUniform-ad9f953b.js","assets/Slice.glsl-3b39b1f7.js","assets/Transform.glsl-6d2e2fd9.js","assets/OutputHighlight.glsl-fbac199a.js","assets/MultipassTerrainTest.glsl-bb236672.js","assets/NormalUtils.glsl-c12729bf.js","assets/AlphaCutoff-96178e0d.js","assets/TransparencyPassType-a11868d2.js","assets/EvaluateSceneLighting.glsl-189abc15.js","assets/VisualVariablePassParameters-d460182b.js","assets/enums-64ab819c.js","assets/VertexElementDescriptor-2925c6af.js","assets/FramebufferObject-a3b9c52c.js","assets/Texture-243be4d7.js","assets/Util-a48361c6.js","assets/SSAOBlur.glsl-8bf33b65.js","assets/ScreenSpacePass-d5e48a9b.js","assets/SSAO.glsl-980b3771.js","assets/ShaderTechniqueConfiguration-9f5b4555.js","assets/HUD.glsl-d3a072ad.js","assets/VerticalOffset.glsl-87cbb2e3.js","assets/objectResourceUtils-d556a033.js","assets/devEnvironmentUtils-5002a058.js","assets/BufferView-903d1848.js","assets/vec33-e98769e8.js","assets/DefaultMaterial_COLOR_GAMMA-fe26fda8.js","assets/types-e1c0a5bf.js","assets/Version-2946cc03.js","assets/quat-3d5eec2d.js","assets/Texture-46c8c2cb.js","assets/TextureOnly.glsl-1ec9a9ef.js","assets/InterleavedLayout-984d67b2.js","assets/MixExternalColor.glsl-ab0706f7.js","assets/symbolColorUtils-b2b55883.js","assets/ObjectAndLayerIdColor.glsl-ad468647.js","assets/OutputDepth.glsl-470c8e2a.js","assets/VisualVariables.glsl-2b937327.js","assets/DiscardOrAdjustAlphaBlend.glsl-73258f38.js","assets/Normals.glsl-76f97814.js","assets/DefaultMaterial.glsl-885671b3.js","assets/VertexColor.glsl-8c022fa8.js","assets/DefaultTechniqueConfiguration-588e5ab2.js","assets/RealisticTree.glsl-b6cc03f2.js","assets/edgeProcessing-f733ce76.js","assets/deduplicate-03981d62.js","assets/projection-a69d43d0.js","assets/Octree-0a267ea2.js","assets/HUDMaterial.glsl-32cf019c.js","assets/sdfPrimitives-9858c36d.js","assets/floatRGBA-9ad35d39.js","assets/dehydratedFeatures-0557137d.js","assets/quantizationUtils-4dd81f85.js","assets/labelFormatUtils-d25d1d9e.js","assets/I3SUtil-f31a4571.js","assets/I3SBinaryReader-f4829435.js","assets/LineCallout.glsl-358ef89b.js","assets/earcut-58237617.js","assets/SnappingCandidate-970faec6.js","assets/MeshComponent-a43522cc.js","assets/MarkerSizing.glsl-566261cc.js","assets/RibbonLine.glsl-0f7c2bbc.js","assets/LineStipple.glsl-ed22a88b.js","assets/callExpressionWithFeature-55effb7b.js","assets/LineMarker.glsl-8166d610.js","assets/NativeLine.glsl-742e9e29.js","assets/Path.glsl-9f6bab44.js","assets/ColorMaterial.glsl-3a70e4a7.js","assets/Pattern.glsl-67f4595b.js","assets/DefaultVertexAttributeLayouts-2bcf3941.js","assets/LercDecoder-4c9b29b3.js","assets/config-1337d16e.js","assets/workerHelper-e756ac3a.js","assets/originUtils-1469eeaf.js","assets/multiOriginJSONSupportUtils-c978f4c3.js","assets/portalItemUtils-2ccd793f.js","assets/index-8df10e3d.css","assets/persistable-ad5d84e1.js","assets/BuildingComponentSublayer-cd73d2b0.js","assets/capabilities-a18453f6.js","assets/I3SIndexInfo-7af1a739.js","assets/I3SLayerDefinitions-ec48d9ab.js","assets/popupUtils-af06d391.js","assets/analysisViewUtils-6a390636.js","assets/ImageMaterial-f710e8d5.js","assets/ImageMaterial.glsl-befce2a1.js","assets/Factory-83aaa3aa.js"]));class Ca extends Li{constructor(t){super(t,new Sa),this._configuration=new Ni}intersect(t,i,a,s,n,r,o){return Ai(t,i,s,n,r,void 0,o)}createBufferWriter(){return new ii(ai)}requiresSlot(t,i){return i===Hi.Color&&t===zi.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL}createGLMaterial(t){return new Oa(t)}getConfiguration(){return this._configuration}}class Oa extends Gi{constructor(t){super(t),this.ensureTechnique(Lt,null)}beginSlot(){return Pt(this.technique)}}class Sa extends Da{constructor(){super(...arguments),this.renderOccluded=S.Occlude}}class Ia extends Kt{constructor(t){super(t),this._material=null,this._renderOccluded=S.OccludeAndTransparent,this._gridWidth=1,this._gridColor=Q(1,0,0,1),this._backgroundColor=Q(1,0,0,1),this.applyProps(t)}get renderOccluded(){return this._renderOccluded}set renderOccluded(t){t!==this._renderOccluded&&(this._renderOccluded=t,this._updateMaterial())}get gridWidth(){return this._gridWidth}set gridWidth(t){this._gridWidth!==t&&(this._gridWidth=t,this._updateMaterial())}get gridColor(){return this._gridColor}set gridColor(t){lt(this._gridColor,t),this._updateMaterial()}get backgroundColor(){return this._backgroundColor}set backgroundColor(t){lt(this._backgroundColor,t),this._updateMaterial()}createExternalResources(){this._material=new Ca(this._materialParameters)}destroyExternalResources(){this._material=null}forEachExternalMaterial(t){h(this._material)&&t(this._material)}createGeometries(t){if(h(this._material)){const i=si();t.addGeometry(i,this._material)}}get _materialParameters(){return{backgroundColor:this._backgroundColor,gridWidth:this._gridWidth,gridColor:this._gridColor,renderOccluded:this._renderOccluded}}_updateMaterial(){h(this._material)&&this._material.setParameters(this._materialParameters)}}function Ra(e,t,i,a,s,n,r,o){return ka(t,r.worldUpAtPosition(e,l.get()),s,n,o.basis1,o.basis2),v(o.basis1,o.basis1,i),v(o.basis2,o.basis2,a),L(o.origin,e),Ot(o.basis2,o.basis1,o.origin,o.plane),o}function ka(e,t,i,a,s,n){const r=A(e,t),o=l.get(),c=l.get();switch(a===O.HORIZONTAL_OR_VERTICAL?Math.abs(r)>ha?O.HORIZONTAL:O.VERTICAL:a){case O.VERTICAL:{const g=Math.abs(r)<=ut?e:i.viewUp;j(o,g,t),L(c,t);break}case O.HORIZONTAL:j(o,i.viewUp,t),j(c,t,o);break;case O.TILTED:{const g=Math.abs(r)<=ut?t:i.viewUp;j(o,g,e),j(c,e,o);break}}const y=j(l.get(),o,c);A(y,i.viewForward)>0&&v(c,c,-1),I(s,o),I(n,c)}function xa(e,t,i){const a=t.worldUpAtPosition(e.origin,l.get()),s=e.basis1,n=Be(e,a),r=Math.round(n/se)*se;return ke(e,r-n,s,i)}function La(e,t,i,a,s,n){const r=L(l.get(),s.origin);P(r,r,v(l.get(),s.basis1,e.direction[0]<0?1:-1)),P(r,r,v(l.get(),s.basis2,e.direction[1]<0?1:-1));const o=C(s.basis1),c=C(s.basis2),y=N(l.get(),i,r),g=N(l.get(),t,r);let _=0,E=0;if(We(e)){const V=He(s),F=He(n);_=o-.5*e.direction[0]*A(s.basis1,g)/o,E=c-.5*e.direction[1]*A(s.basis2,g)/c;const K=F/V;_*=K,E*=K}const R=_+.5*e.direction[0]*A(s.basis1,y)/o,f=E+.5*e.direction[1]*A(s.basis2,y)/c,m=v(l.get(),s.basis1,R/o),w=v(l.get(),s.basis2,f/c);(R<=0||vt(n.origin,m,a)<=yt)&&L(m,n.basis1),(f<=0||vt(n.origin,w,a)<=yt)&&L(w,n.basis2);const b=L(l.get(),r);return P(b,b,v(l.get(),m,e.direction[0]<0?-1:1)),P(b,b,v(l.get(),w,e.direction[1]<0?-1:1)),Ie(b,m,w,n)}function Aa(e,t){return Ta*Math.min(t.width,t.height)*t.computeRenderPixelSizeAt(e)}function Ha(e,t,i,a){const s=j(l.get(),t,i);return j(s,s,t),St(e,s,a)}function Ht(e,t){return Di(e.basis1,e.basis2,e.origin,t)}function mt(e,t,i,a){const s=t.worldUpAtPosition(e.origin,l.get()),n=l.get();switch(i){case ae.HEADING:L(n,s);break;case ae.TILT:L(n,e.basis1)}return St(e.origin,n,a)}function Na(e,t,i,a){const s=Fe(i,U.NEGATIVE_X),n=H.get();fi(n,t,s.edge*Math.PI/2);const r=I(l.get(),s.basis);let o=v(l.get(),r,s.direction*a.computeScreenPixelSizeAt(s.position)*me);P(o,o,s.position);const c=a.projectToRenderScreen(o,xe(l.get())),y=za(a,c);ni(a,c,_e),I(_e.direction,_e.direction);const g=l.get();!y&&ri(i,_e,g)&&(o=g),n[12]=0,n[13]=0,n[14]=0,e.modelTransform=n,e.renderLocation=Dt(o),y?e.state|=Pe:e.state&=~Pe}function za(e,t){const[i,a,s,n]=e.viewport,r=Math.min(s,n)/16;let o=!0;return t[0]<i+r?(t[0]=i+r,o=!1):t[0]>i+s-r&&(t[0]=i+s-r,o=!1),t[1]<a+r?(t[1]=a+r,o=!1):t[1]>a+n-r&&(t[1]=a+n-r,o=!1),o}function Ga(e,t,i,a){const s=C(a.basis1),n=C(a.basis2),r=Nt(a),o=He(a),c=ie(l.get(),0,0,0);P(c,v(l.get(),a.basis1,t.direction[0]),v(l.get(),a.basis2,t.direction[1])),P(c,a.origin,c);let y=0,g=1;if(We(t))t.direction[0]===1&&t.direction[1]===-1?y=se:t.direction[0]===1&&t.direction[1]===1?y=Math.PI:t.direction[0]===-1&&t.direction[1]===1&&(y=3*Math.PI/2),g=o;else{const E=t.direction[0]!==0?1:2;y=E===1?se:0,g=(E===1?n:s)-r}const _=Ge(H.get(),y);Tt(_,_,ie(l.get(),g,g,g)),Y(_,i,_),_[12]=0,_[13]=0,_[14]=0,e.modelTransform=_,e.renderLocation=c}function Ua(e,t,i,a){const s=a.worldUpAtPosition(i.origin,l.get()),n=Fe(i,U.POSITIVE_X),r=Ge(H.get(),n.edge*Math.PI/2);Et(r,r,-Be(i,s)),Y(r,t,r),r[12]=0,r[13]=0,r[14]=0,e.modelTransform=r,e.renderLocation=n.position}function Fa(e,t,i){const a=Fe(i,U.POSITIVE_Y),s=Ge(H.get(),a.edge*Math.PI/2);Et(s,s,se),Y(s,t,s),s[12]=0,s[13]=0,s[14]=0,e.modelTransform=s,e.renderLocation=a.position}var U;function Fe(e,t){switch(t){case U.POSITIVE_X:return{basis:e.basis1,direction:1,position:P(l.get(),e.origin,e.basis1),edge:t};case U.POSITIVE_Y:return{basis:e.basis2,direction:1,position:P(l.get(),e.origin,e.basis2),edge:t};case U.NEGATIVE_X:return{basis:e.basis1,direction:-1,position:N(l.get(),e.origin,e.basis1),edge:t};case U.NEGATIVE_Y:return{basis:e.basis2,direction:-1,position:N(l.get(),e.origin,e.basis2),edge:t}}}function vt(e,t,i){const a=i.projectToRenderScreen(P(l.get(),e,t),xe(l.get())),s=i.projectToRenderScreen(N(l.get(),e,t),xe(l.get()));return bi(N(a,a,s))}function Nt(e){const t=C(e.basis1),i=C(e.basis2);return ba*Math.min(t,i)}function He(e){return Nt(e)}function We(e){return e.direction[0]!==0&&e.direction[1]!==0}function Wa(e,t=be.CENTER_ON_ARROW){const i=t===be.CENTER_ON_CALLOUT?me:0,a=[G(i,0,-gt/2),G(i,0,gt/2)],s=Ka(a,!0),n=(m,w)=>ja(a,a,{tubeRadius:va,tipRadius:pt,tipLength:Ae,tubeFocusMultiplier:na,tipFocusMultiplier:ra,padding:m,bothEnds:!0,flat:null,focusTipLength:!0,addCap:w}),r=n(0,!1),o=n(wa,!0),c=new de({color:pa,cullFace:pe.Back,renderOccluded:S.Opaque}),y=new de({color:ga,cullFace:pe.Back,renderOccluded:S.Opaque}),g=new de({color:_a,cullFace:pe.Back,renderOccluded:S.Opaque}),_=new de({color:ma,transparent:!0,writeDepth:!1,cullFace:pe.Front,renderOccluded:S.Transparent}),E=Re([[i,0,0],[i-me,0,0]]),R=Re([[i,0,0],[i-me,0,0]]),f=new Vt({color:ya,renderOccluded:S.OccludeAndTransparent});return new It({view:e,renderObjects:[...r.normal.map(({part:m,geometry:w,transform:b})=>({geometry:w,material:m==="tip"?c:m==="cap"?y:g,transform:b,stateMask:B.Unfocused|T})),...o.normal.map(({geometry:m,transform:w})=>({geometry:m,material:_,transform:w,stateMask:B.Unfocused|T})),{geometry:E,material:f,stateMask:B.Unfocused|T|Pe},...r.focused.map(({part:m,geometry:w,transform:b})=>({geometry:w,material:m==="tip"?c:m==="cap"?y:g,transform:b,stateMask:B.Focused|T})),...o.focused.map(({geometry:m,transform:w})=>({geometry:m,material:_,transform:w,stateMask:B.Focused|T})),{geometry:R,material:f,stateMask:B.Focused|T|Pe}],autoScaleRenderObjects:!1,collisionType:{type:"line",paths:[s]},collisionPriority:1,radius:pt,state:T})}function wt(e,t){const i=Ci(e,{customStateMask:T,texture:t});return i.state=T,i}function zt(e){const t=[[-1,-1,0],[1,-1,0],[1,1,0],[-1,1,0],[-1,-1,0]];return new Xt({view:e,attached:!1,color:ee,width:kt,writeDepthEnabled:!1,renderOccluded:S.OccludeAndTransparent,geometry:[t]})}function Gt(e){return new Ia({view:e,attached:!1,backgroundColor:[...te],gridColor:xt,gridWidth:4,renderOccluded:S.OccludeAndTransparent})}function Ba(e,t){const i=We(t),a=i?[G(1,0,0),G(0,0,0),G(0,1,0)]:[G(1,0,0),G(-1,0,0)],s=Re(a),n=fa,r=f=>new li({color:n,width:f,renderOccluded:S.OccludeAndTransparent}),o=()=>new Vt({color:n,renderOccluded:S.OccludeAndTransparent}),c=i?Pa:_t,y=c*sa,g=_t,_=f=>f>1?r(f):o(),E=[{geometry:s,material:_(c),stateMask:B.Unfocused|$e},{geometry:s,material:_(y),stateMask:B.Focused|$e},{geometry:s,material:_(g),stateMask:Ja}],R=new It({view:e,renderObjects:E,collisionType:{type:"line",paths:[a]},radius:i?Va:Ma,...Oi});return R.state=$e,R}function ja(e,t,i){const a=s=>{const n=(s?t:e).slice(0),r=N(l.get(),n[0],n[1]);I(r,r);const o=N(l.get(),n[n.length-1],n[n.length-2]);if(I(o,o),i.padding>0){const V=v(J(),o,-i.padding);if(n[n.length-1]=P(V,V,n[n.length-1]),i.bothEnds){const F=v(J(),r,-i.padding);n[0]=P(F,F,n[0])}}const c=s?i.tipFocusMultiplier:1,y=i.tipLength*(i.focusTipLength?c:1),g=i.tipRadius*c,_=et(H.get());if(i.padding>0){const V=y/4,F=ie(l.get(),0,V,0),K=1+i.padding/V;tt(_,_,F),Tt(_,_,ie(l.get(),K,K,K)),tt(_,_,v(F,F,-1/K))}const E=et(Me()),R=G(0,1,0),f=it(Me(),at(rt.get(),R,o));f[12]=n[n.length-1][0],f[13]=n[n.length-1][1],f[14]=n[n.length-1][2],Y(f,f,_);const m=[{part:"tube",geometry:qa(i.tubeRadius*(s?i.tubeFocusMultiplier:1)+i.padding,i.flat,n),transform:E}];let w,b;if(h(i.flat)?w=hi(y,g,g,i.flat.thickness):(w=Ye(y,g,24,!1,!1,!0),b=Ye(y,g,24,!1,!0,!1)),m.push({part:"tip",geometry:w,transform:f}),b&&m.push({part:"cap",geometry:b,transform:f}),i.bothEnds){const V=it(Me(),at(rt.get(),R,r));V[12]=n[0][0],V[13]=n[0][1],V[14]=n[0][2],Y(V,V,_),m.push({part:"tip",geometry:w,transform:V}),b&&m.push({part:"cap",geometry:b,transform:V})}return m};return{normal:a(!1),focused:a(!0)}}function qa(e,t,i){const a=[];if(h(t))a.push([e,t.thickness/2],[-e,t.thickness/2],[-e,-t.thickness/2],[e,-t.thickness/2]);else for(let n=0;n<12;n++){const r=n/12*2*Math.PI;a.push([Math.cos(r)*e,Math.sin(r)*e])}return di(a,i,[],[],!1)}function Ka(e,t){const i=N(J(),e[e.length-1],e[e.length-2]);if(I(i,i),v(i,i,Ae),P(i,i,e[e.length-1]),t){const a=N(J(),e[0],e[1]);return I(a,a),v(a,a,Ae),P(a,a,e[0]),[a,...e,i]}return[...e,i]}function Ut(e,t,i,a=new Ue){if(p(e))return null;const{renderCoordsHelper:s}=t,n=s.fromRenderCoords(e.origin,t.spatialReference);if(p(n))return null;const r=Vi(n,i);if(p(r))return null;a.position=r;const o=2*C(e.basis1),c=2*C(e.basis2),y=Mt.renderUnitScaleFactor(t.spatialReference,i);a.width=o*y,a.height=c*y;const g=s.worldUpAtPosition(e.origin,l.get());return a.tilt=mi(Be(e,g)),a.heading=s.headingAtPosition(e.origin,e.basis1)-90,a}function Be(e,t){return Mi(t,e.basis2,e.basis1)+se}function Xa(e,t,i,a,s,n,r=D()){return n.toRenderCoords(e,r.origin)?(n.worldBasisAtPosition(r.origin,nt.X,r.basis1),n.worldBasisAtPosition(r.origin,nt.Y,r.basis2),Ot(r.basis2,r.basis1,r.origin,r.plane),ke(r,-fe(t),we(r),r),ke(r,fe(i),r.basis1,r),v(r.basis1,r.basis1,a/2),v(r.basis2,r.basis2,s/2),oi(r),r):(bt.getLogger("esri.views.3d.analysis.Slice.sliceToolUtils").error(`Failed to project slice plane position, projection from ${e.spatialReference.wkid} is not supported`),null)}function Za(e,t){if(p(e)||p(e.position))return null;const i=Zt(e.position,t.spatialReference,t.elevationProvider);if(p(i))return null;const a=Mt.renderUnitScaleFactor(e.position.spatialReference,t.spatialReference),s=e.width*a,n=e.height*a;return{position:i,heading:e.heading,tilt:e.tilt,renderWidth:s,renderHeight:n}}function Ya(e,t,i,a=D()){if(p(e))return null;const s=Xa(e.position,e.heading,e.tilt,e.renderWidth,e.renderHeight,t.renderCoordsHelper,a);return!i.tiltEnabled&&h(s)&&xa(s,t.renderCoordsHelper,s),s}(function(e){e[e.POSITIVE_X=0]="POSITIVE_X",e[e.POSITIVE_Y=1]="POSITIVE_Y",e[e.NEGATIVE_X=2]="NEGATIVE_X",e[e.NEGATIVE_Y=3]="NEGATIVE_Y"})(U||(U={}));const T=Ve.Custom1;var ae,O;(function(e){e[e.HEADING=1]="HEADING",e[e.TILT=2]="TILT"})(ae||(ae={})),function(e){e[e.HORIZONTAL_OR_VERTICAL=0]="HORIZONTAL_OR_VERTICAL",e[e.HORIZONTAL=1]="HORIZONTAL",e[e.VERTICAL=2]="VERTICAL",e[e.TILTED=3]="TILTED"}(O||(O={}));const Pe=Ve.Custom2,_e=Ct(),se=Math.PI/2,$e=Ve.Custom1,Ja=Ve.Custom2;var be;function Qa(e){const t=e.type==="building-scene-3d"?e:null;return h(t)}(function(e){e[e.CENTER_ON_CALLOUT=0]="CENTER_ON_CALLOUT",e[e.CENTER_ON_ARROW=1]="CENTER_ON_ARROW"})(be||(be={}));function es(e){switch(e.type){case"building-scene":case"csv":case"dimension":case"feature":case"geo-rss":case"geojson":case"graphics":case"group":case"integrated-mesh":case"kml":case"line-of-sight":case"map-notes":case"ogc-feature":case"oriented-imagery":case"point-cloud":case"route":case"scene":case"stream":case"voxel":case"subtype-group":case"unknown":case"unsupported":case"wfs":case null:return!1;case"base-dynamic":case"base-elevation":case"base-tile":case"bing-maps":case"elevation":case"imagery":case"imagery-tile":case"map-image":case"media":case"open-street-map":case"tile":case"vector-tile":case"wcs":case"web-tile":case"wms":case"wmts":return!0;default:return ea(e.type),!1}}const Ft="esri.views.3d.analysis.Slice.SliceController",De=bt.getLogger(Ft);let X=class extends ze{constructor(e){super(e),this._handles=new ve,this._internalChange=!1,this._currentSlicePlane=null}initialize(){this._handles.add(this.analysis.excludedLayers.on("before-add",e=>{const t=e.item;t!=null&&(t instanceof Je||t instanceof _i)?t instanceof Je&&es(t)?(De.error("excludedLayers",`Layer '${t.title}, id:${t.id}' of type '${t.type}' can not be individually excluded from slicing. Use 'excludeGroundSurface' instead.`),e.preventDefault()):this.analysis.excludedLayers.includes(t)&&e.preventDefault():(De.error("excludedLayers","Invalid layer type, layer must derive from Layer or BuildingComponentSublayer"),e.preventDefault())})),is(this.view,this),this._handles.add([x(()=>this.analysisViewData.plane,()=>{this._internalChange||this._updateSlicePlaneFromBoundedPlane(),this._updateLayerViews()},{sync:!0}),x(()=>this.analysis.excludeGroundSurface,()=>this._updateLayerViews(),{sync:!0}),this.analysis.excludedLayers.on("change",()=>this._updateLayerViews()),x(()=>[this.analysisViewData.active,this.analysisViewData.visible],()=>{this._updateActiveController(),this._updateViewSlicePlane()},{sync:!0}),x(()=>this._allLayerAndSubLayerViews,()=>this._updateLayerViews())]),this._handles.add([x(()=>this.analysis.shape,()=>{this._internalChange||(this._updateBoundedPlaneFromSlicePlane(),this._updateViewSlicePlane())},{sync:!0})],"analysis"),this._updateActiveController(),this._updateBoundedPlaneFromSlicePlane(),this._updateViewSlicePlane()}destroy(){this.analysisViewData.active&&(this.analysisViewData.active=!1,this.view.slicePlane=null),as(this.view,this),this._handles.destroy(),this.set("view",null)}get _allLayerAndSubLayerViews(){const e=this.view.allLayerViews.items;return e.concat(e.filter(Qa).flatMap(({sublayerViews:t})=>t.items))}_updateBoundedPlaneFromSlicePlane(){const e=this.analysis.shape,t=this._currentSlicePlane;if(p(t)&&p(e)||h(t)&&h(e)&&e.equals(t))return;let i=null,a=null;if(h(e)&&h(e.position)){const s=e.position.spatialReference,n=Za(e,this.view);p(n)&&Yt(this.analysis,s,De),i=Ya(n,this.view,{tiltEnabled:this.analysis.tiltEnabled},D()),h(i)&&(a={heading:e.heading,tilt:e.tilt,position:e.position,width:e.width,height:e.height})}this._currentSlicePlane=a,this._internalChange=!0,this.analysisViewData.plane=i,this._internalChange=!1}_updateSlicePlaneFromBoundedPlane(){const e=this.analysisViewData.plane,t=Ut(e,this.view,this.view.spatialReference,new Ue);let i=null;h(t)&&(i={heading:t.heading,tilt:t.tilt,position:t.position,width:t.width,height:t.height}),this._currentSlicePlane=i,this._internalChange=!0,this.analysis.shape=t,this._internalChange=!1,this._updateViewSlicePlane()}_updateActiveController(){if(Ce)return;const e=Wt(this.view);if(this.analysisViewData.active)h(e.activeController)&&e.activeController!==this?(Ce=!0,e.activeController.analysisViewData.active=!1,Ce=!1):h(e.activeController)&&e.activeController,this._updateLayerViews(),e.activeController=this;else{if(h(e.activeController)&&e.activeController!==this)return;h(e.activeController)&&e.activeController===this&&(e.activeController=null,this._updateLayerViews())}}_updateViewSlicePlane(){ts(this.view)}_updateLayerViews(){const e=h(this.analysisViewData.plane)&&this.analysisViewData.visible&&this.analysisViewData.active,t=[],i=a=>{"layers"in a?a.layers.forEach(i):t.push(a)};this.analysis.excludedLayers.forEach(i),this.view.allLayerViews.forEach(a=>{a.destroyed||("slicePlaneEnabled"in a&&(a.slicePlaneEnabled=e&&!t.includes(a.layer)),"sublayerViews"in a&&a.sublayerViews.forEach(s=>{s.slicePlaneEnabled=e&&!t.includes(s.sublayer)}))}),this.view.basemapTerrain!=null&&(this.view.basemapTerrain.slicePlaneEnabled=e&&!this.analysis.excludeGroundSurface)}};d([u()],X.prototype,"view",void 0),d([u()],X.prototype,"analysis",void 0),d([u()],X.prototype,"analysisViewData",void 0),d([u()],X.prototype,"_allLayerAndSubLayerViews",null),X=d([oe(Ft)],X);const Z=new Map;let Ce=!1;function ts(e){const t=Wt(e).activeController;h(t)&&h(t.analysisViewData.plane)&&t.analysisViewData.visible?e.slicePlane=t.analysisViewData.plane:e.slicePlane=null}function is(e,t){Z.has(e)||Z.set(e,{all:[],activeController:null}),Z.get(e).all.push(t)}function Wt(e){return Z.get(e)}function as(e,t){if(!Z.has(e))throw new Error("view expected in global slice register");const i=Z.get(e),a=i.all.lastIndexOf(t);if(a===-1)throw new Error("controller expected in global slice register");i.all.splice(a,1),i.all.length===0&&Z.delete(e)}var Ne;let M=Ne=class extends Si{constructor(e){super(e),this._clock=ta,this._previewPlaneOpacity=1,this.removeIncompleteOnCancel=!1,this.layersMode="none",this.shiftManipulator=null,this.rotateHeadingManipulator=null,this.rotateTiltManipulator=null,this.resizeManipulators=null,this._handles=new ve,this._viewHandles=new ve,this._frameTask=null,this._pointerMoveTimerMs=oa,this._prevPointerMoveTimeout=null,this._previewPlaneGridVisualElement=null,this._previewPlaneOutlineVisualElement=null,this._startPlane=D(),this._previewPlane=null,this._activeKeyModifiers={},this._lastCursorPosition=vi(),this._resizeHandles=[{direction:[1,0]},{direction:[1,1]},{direction:[0,1]},{direction:[-1,1]},{direction:[-1,0]},{direction:[-1,-1]},{direction:[0,-1]},{direction:[1,-1]}],this._intersector=ci(e.view.state.viewingMode),this._intersector.options.store=ui.MIN}initialize(){if(this.analysis==null)throw new Error("SliceTool requires valid analysis, but null was provided.");this._rotateHeadingImage=ia(this.view.toolViewManager.textures),this._rotateTiltImage=aa(this.view.toolViewManager.textures);const e=i=>{this._updateManipulatorsInteractive(i),i.grabbing||(h(this.analysisViewData.plane)&&$(this.analysisViewData.plane,this._startPlane),this.inputState=null)};this.shiftManipulator=Wa(this.view),this.manipulators.add(this.shiftManipulator),this.shiftManipulator.events.on("grab-changed",i=>{this._onShiftGrab(i),e(this.shiftManipulator)}),this._handles.add(this._createShiftDragPipeline(this.shiftManipulator)),this.rotateHeadingManipulator=wt(this.view,this._rotateHeadingImage.texture),this.manipulators.add(this.rotateHeadingManipulator),this.rotateHeadingManipulator.events.on("grab-changed",i=>{this._onRotateHeadingGrab(i),e(this.rotateHeadingManipulator)}),this._handles.add(this._createRotateHeadingDragPipeline(this.rotateHeadingManipulator)),this.rotateTiltManipulator=wt(this.view,this._rotateTiltImage.texture),this.manipulators.add(this.rotateTiltManipulator),this.rotateTiltManipulator.events.on("grab-changed",i=>{this._onRotateTiltGrab(i),e(this.rotateTiltManipulator)}),this._handles.add(this._createRotateTiltDragPipeline(this.rotateTiltManipulator)),this.resizeManipulators=this._resizeHandles.map((i,a)=>{const s=Ba(this.view,i);return s.events.on("grab-changed",n=>{this._onResizeGrab(n,a),e(s)}),this._handles.add(this._createResizeDragPipeline(s)),s}),this.manipulators.addMany(this.resizeManipulators),this._previewPlaneGridVisualElement=Gt(this.view),this._previewPlaneOutlineVisualElement=zt(this.view),this._previewPlaneOutlineVisualElement.width=Rt,this._handles.add(x(()=>this.analysisViewData.plane,()=>this._updateManipulators(),ti));const t=x(()=>this.state,i=>{i==="sliced"&&this.finishToolCreation()},Se);this._handles.add([t,x(()=>this.view.state.camera,()=>this._onCameraChange())])}destroy(){this._rotateHeadingImage=qe(this._rotateHeadingImage),this._rotateTiltImage=qe(this._rotateTiltImage),this._handles=q(this._handles),this._viewHandles=q(this._viewHandles),this._removeFrameTask(),this._clearPointerMoveTimeout(),this._previewPlaneOutlineVisualElement=q(this._previewPlaneOutlineVisualElement),this._previewPlaneGridVisualElement=q(this._previewPlaneGridVisualElement)}get state(){const e=!!this.analysisViewData.plane,t=!!this.inputState;return e?e&&t?"slicing":e&&!t?"sliced":"ready":"ready"}get cursor(){return this._isPlacingSlicePlane||this.layersMode==="exclude"?"crosshair":h(this._creatingPointerId)?"grabbing":null}set analysis(e){if(e==null)throw new Error("SliceTool requires valid analysis, but null was provided.");this._handles.remove("analysis"),this._set("analysis",e)}get inputState(){return this._get("inputState")}set inputState(e){this._set("inputState",e),this.analysisViewData.showGrid=h(e)&&e.type==="resize",this._updateMaterials()}get _isPlacingSlicePlane(){return!this.inputState&&!this.analysisViewData.plane&&this.active}get _creatingPointerId(){return h(this.inputState)&&this.inputState.type==="shift"?this.inputState.creatingPointerId:null}enterExcludeLayerMode(){p(this.analysisViewData.plane)||(this._set("layersMode","exclude"),this.active||(this.view.activeTool=this))}exitExcludeLayerMode(){p(this.analysisViewData.plane)||(this._set("layersMode","none"),this.active&&(this.view.activeTool=null))}onDeactivate(){this._set("layersMode","none"),this._updatePreviewPlane(null)}onShow(){this._updateVisibility(!0)}onHide(){this._updateVisibility(!1)}_updateVisibility(e){this._updateManipulators(),e||this._clearPointerMoveTimeout()}onInputEvent(e){switch(e.type){case"pointer-drag":if(!Oe(e))return;this._isPlacingSlicePlane?this._onClickPlacePlane(e)&&e.stopPropagation():this._onPointerDrag(e)&&e.stopPropagation();break;case"pointer-move":this._onPointerMove(e);break;case"pointer-up":this._onPointerUp(e)&&e.stopPropagation();break;case"immediate-click":if(!Oe(e))return;this._onClickPlacePlane(e)&&e.stopPropagation();break;case"click":if(!Oe(e))return;this._onClickExcludeLayer(e)&&e.stopPropagation();break;case"drag":this.inputState&&e.stopPropagation();break;case"key-down":this._onKeyDown(e)&&e.stopPropagation();break;case"key-up":this._onKeyUp(e)&&e.stopPropagation()}}onEditableChange(){this.analysisViewData.editable=this.internallyEditable}_onPointerDrag(e){const t=this.inputState;if(e.pointerId===this._creatingPointerId&&h(t)&&t.type==="shift"){const i=re(e);return this.shiftManipulator.events.emit("drag",{action:t.hasBeenDragged?"update":"start",pointerType:e.pointerType,start:i,screenPoint:i}),t.hasBeenDragged=!0,!0}return!1}_onPointerMove(e){this._lastCursorPosition.x=e.x,this._lastCursorPosition.y=e.y,this._resetPointerMoveTimeout(),e.pointerType!=="touch"&&this._updatePreviewPlane(re(e),this._activeKeyModifiers)}_onCameraChange(){this._updatePreviewPlane(this._lastCursorPosition,this._activeKeyModifiers),this._updateManipulators()}_onPointerUp(e){if(e.pointerId===this._creatingPointerId&&h(this.analysisViewData.plane)){const t=re(e);return this.shiftManipulator.events.emit("drag",{action:"end",start:t,screenPoint:t}),$(this.analysisViewData.plane,this._startPlane),this.inputState=null,!0}return!1}_onClickPlacePlane(e){if(this.layersMode==="exclude")return!1;if(this._isPlacingSlicePlane){const t=re(e),i=D();if(this._pickPlane(t,!1,this._activeKeyModifiers,i)){if($(i,this._startPlane),this.analysis.shape=Ut(i,this.view,this.view.spatialReference,new Ue),e.type==="pointer-drag"){const a=this._calculatePickRay(t);this.inputState=ft(a,e.pointerId,i.origin,i)}return!0}}return!1}_onClickExcludeLayer(e){return!(this.layersMode!=="exclude"||!this.created)&&(this.view.hitTest(re(e)).then(t=>{if(t.results.length){const i=t.results[0],a=(i==null?void 0:i.type)==="graphic"&&i.graphic;if(a){const s=a.sourceLayer||a.layer;s&&this.analysis.excludedLayers.push(s)}}else t.ground.layer?this.analysis.excludedLayers.push(t.ground.layer):this.analysis.excludeGroundSurface=!0}),this._set("layersMode","none"),this.active&&(this.view.activeTool=null),!0)}_onKeyDown(e){return(e.key===Ee||e.key===Te)&&(this._activeKeyModifiers[e.key]=!0,h(this._previewPlane)&&this._updatePreviewPlane(this._lastCursorPosition,this._activeKeyModifiers),!0)}_onKeyUp(e){return!(e.key!==Ee&&e.key!==Te||!this._activeKeyModifiers[e.key])&&(delete this._activeKeyModifiers[e.key],h(this._previewPlane)&&this._updatePreviewPlane(this._lastCursorPosition,this._activeKeyModifiers),!0)}_onShiftGrab(e){if(e.action!=="start"||p(this.analysisViewData.plane))return;const t=this._calculatePickRay(e.screenPoint);$(this.analysisViewData.plane,this._startPlane),this.inputState=ft(t,null,this.shiftManipulator.renderLocation,this.analysisViewData.plane)}_createShiftDragPipeline(e){return ce(e,(t,i,a)=>{const s=this.inputState;if(p(s)||s.type!=="shift")return;const n=h(this.analysisViewData.plane)?$(this.analysisViewData.plane,D()):null;i.next(ge(this.view,s.shiftPlane)).next(this._shiftDragAdjustSensitivity(s)).next(this._shiftDragUpdatePlane(s)),a.next(()=>{h(n)&&this._updateBoundedPlane(n)})})}_shiftDragAdjustSensitivity(e){return t=>{if(p(this.analysisViewData.plane))return null;const i=.001,a=Math.min((1-Math.abs(A(we(this.analysisViewData.plane),t.ray.direction)/C(t.ray.direction)))/i,1),s=-ot(this._startPlane.plane,t.renderEnd),n=-ot(this._startPlane.plane,e.startPoint);return e.depth=e.depth*(1-a)+s*a-n,t}}_shiftDragUpdatePlane(e){return()=>{if(p(this.analysisViewData.plane))return;const t=L(l.get(),this._startPlane.origin),i=L(l.get(),we(this._startPlane));v(i,i,-e.depth),P(i,i,t);const a=Ie(i,this.analysisViewData.plane.basis1,this.analysisViewData.plane.basis2,D());this._updateBoundedPlane(a)}}_onRotateHeadingGrab(e){if(e.action!=="start"||p(this.analysisViewData.plane))return;const t=mt(this.analysisViewData.plane,this.view.renderCoordsHelper,ae.HEADING,Le()),i=this._calculatePickRay(e.screenPoint),a=J();ye(t,i,a)&&($(this.analysisViewData.plane,this._startPlane),this.inputState={type:"rotate",rotatePlane:t,startPoint:a})}_createRotateHeadingDragPipeline(e){return ce(e,(t,i,a)=>{const s=this.inputState;if(p(s)||s.type!=="rotate")return;const n=h(this.analysisViewData.plane)?$(this.analysisViewData.plane,D()):null;i.next(ge(this.view,s.rotatePlane)).next(this._rotateDragRenderPlaneToRotate(s)).next(this._rotateDragUpdatePlaneFromRotate()),a.next(()=>{h(n)&&this._updateBoundedPlane(n)})})}_onRotateTiltGrab(e){if(e.action!=="start"||p(this.analysisViewData.plane))return;const t=mt(this.analysisViewData.plane,this.view.renderCoordsHelper,ae.TILT,Le()),i=this._calculatePickRay(e.screenPoint),a=J();ye(t,i,a)&&($(this.analysisViewData.plane,this._startPlane),this.inputState={type:"rotate",rotatePlane:t,startPoint:a})}_createRotateTiltDragPipeline(e){return ce(e,(t,i,a)=>{const s=this.inputState;if(p(s)||s.type!=="rotate")return;const n=h(this.analysisViewData.plane)?$(this.analysisViewData.plane,D()):null;i.next(ge(this.view,s.rotatePlane)).next(this._rotateDragRenderPlaneToRotate(s)).next(this._rotateDragUpdatePlaneFromRotate()),a.next(()=>{h(n)&&this._updateBoundedPlane(n)})})}_rotateDragRenderPlaneToRotate(e){return t=>{if(p(this.analysisViewData.plane))return null;const i=Ei(e.rotatePlane),a=Ii(e.startPoint,t.renderEnd,this.analysisViewData.plane.origin,i);return{...t,rotateAxis:i,rotateAngle:a}}}_rotateDragUpdatePlaneFromRotate(){return e=>{if(p(this.analysisViewData.plane))return;const t=Pi(H.get(),e.rotateAngle,e.rotateAxis);if(p(t))return;const i=st(l.get(),this._startPlane.basis1,t),a=st(l.get(),this._startPlane.basis2,t),s=Ie(this.analysisViewData.plane.origin,i,a,D());this._updateBoundedPlane(s)}}_onResizeGrab(e,t){if(e.action!=="start"||p(this.analysisViewData.plane))return;const i=this._calculatePickRay(e.screenPoint),a=l.get();ye(this.analysisViewData.plane.plane,i,a)&&($(this.analysisViewData.plane,this._startPlane),this.inputState={type:"resize",activeHandleIdx:t,startPoint:Dt(a)})}_createResizeDragPipeline(e){return ce(e,(t,i,a)=>{const s=this.inputState;if(p(s)||s.type!=="resize"||p(this.analysisViewData.plane))return;const n=$(this.analysisViewData.plane,D());i.next(ge(this.view,this.analysisViewData.plane.plane)).next(this._resizeDragUpdatePlane(s)),a.next(()=>{this._updateBoundedPlane(n)})})}_resizeDragUpdatePlane(e){return t=>{if(p(this.analysisViewData.plane))return;const i=this._resizeHandles[e.activeHandleIdx],a=La(i,e.startPoint,t.renderEnd,this.view.state.camera,this._startPlane,$(this.analysisViewData.plane));this._updateBoundedPlane(a)}}_updateBoundedPlane(e){const t=this.analysisViewData;if(!h(t))throw new Error("valid internal object expected");t.plane=e}_updatePreviewPlane(e,t={}){let i=this._previewPlane;if(this._previewPlane=null,p(e))return this._removeFrameTask(),void this._updateManipulators();if(!this.analysisViewData.plane&&this.active){const a=h(i)?i:D();if(i=h(i)?$(i,ss):null,this._pickPlane(e,!0,t,a)){const s=da;let n=!1;h(i)&&(n=A(i.plane,a.plane)<s||A(I(l.get(),i.basis1),I(l.get(),a.basis1))<s),n&&(this._previewPlaneOpacity=0),this._previewPlane=a}}h(this._previewPlane)&&p(this._frameTask)&&this._previewPlaneOpacity===0?this._frameTask=jt({update:({deltaTime:a})=>{this._previewPlaneOpacity=Math.min(this._previewPlaneOpacity+a/(1e3*ca),1),this._updateManipulators(),this._previewPlaneOpacity===1&&this._removeFrameTask()}}):p(this._previewPlane)&&h(this._frameTask)?this._removeFrameTask():h(this._previewPlane)&&this._updateManipulators()}_removeFrameTask(){this._frameTask=Ke(this._frameTask)}_calculatePickRay(e){const t=Ct(),i=Qe(e,ns);return pi(this.view.state.camera,i,t),I(t.direction,t.direction),t}_pickMinResult(e){const t=Qe(e,Ti.get());return this.view.sceneIntersectionHelper.intersectToolIntersectorScreen(t,this._intersector),this._intersector.results.min}_pickPlane(e,t,i,a){const s=this._pickMinResult(e),n=l.get();if(!s.getIntersectionPoint(n))return!1;const r=s.getTransformedNormal(l.get()),o=this.view.state.camera;A(r,o.viewForward)>0&&v(r,r,-1);const c=Aa(n,o),y=(t?1:-1)*c*la,g=v(l.get(),r,y);P(g,g,n);const _=this.analysis.tiltEnabled?O.TILTED:O.HORIZONTAL_OR_VERTICAL,E=i[Ee]?O.VERTICAL:i[Te]?O.HORIZONTAL:_;return Ra(g,r,c,c,o,E,this.view.renderCoordsHelper,a),!0}_clearPointerMoveTimeout(){this._prevPointerMoveTimeout=Ke(this._prevPointerMoveTimeout)}_resetPointerMoveTimeout(){this._clearPointerMoveTimeout(),this.shiftManipulator.state|=T,this.rotateHeadingManipulator.state|=T,this.rotateTiltManipulator.state|=T,this._prevPointerMoveTimeout=this._clock.setTimeout(()=>{this.shiftManipulator.state&=~T,this.rotateHeadingManipulator.state&=~T,this.rotateTiltManipulator.state&=~T},this._pointerMoveTimerMs)}_updateManipulators(){if(Ne.disableEngineLayers)return;let e=null,t=!1;if(h(this.analysisViewData.plane))e=this.analysisViewData.plane,t=!1;else{if(!h(this._previewPlane))return this.shiftManipulator.available=!1,this.rotateHeadingManipulator.available=!1,this.rotateTiltManipulator.available=!1,this.resizeManipulators.forEach(r=>r.available=!1),this._previewPlaneOutlineVisualElement.visible=!1,void(this._previewPlaneGridVisualElement.visible=!1);e=this._previewPlane,t=!0}const i=Ht(e,H.get());t?(this.shiftManipulator.available=!1,this.rotateHeadingManipulator.available=!1,this.rotateTiltManipulator.available=!1,this.resizeManipulators.forEach(r=>r.available=!1),this._previewPlaneOutlineVisualElement.attached=!0,this._previewPlaneGridVisualElement.attached=!0,this._previewPlaneOutlineVisualElement.visible=!0,this._previewPlaneGridVisualElement.visible=!0):(this.shiftManipulator.available=!0,this.rotateHeadingManipulator.available=!0,this.rotateTiltManipulator.available=this.analysis.tiltEnabled,this.resizeManipulators.forEach(r=>r.available=!0),Na(this.shiftManipulator,i,e,this.view.state.camera),Ua(this.rotateHeadingManipulator,i,e,this.view.renderCoordsHelper),Fa(this.rotateTiltManipulator,i,e),this.resizeManipulators.forEach((r,o)=>Ga(r,this._resizeHandles[o],i,e)),this._previewPlaneOutlineVisualElement.visible=!1,this._previewPlaneGridVisualElement.visible=!1);const a=ie(l.get(),C(e.basis1),C(e.basis2),1),s=$t(H.get(),a),n=Y(s,i,s);this._previewPlaneOutlineVisualElement.transform=n,this._previewPlaneGridVisualElement.transform=n,this._updateMaterials()}_updateMaterials(){const e=[ee[0],ee[1],ee[2],ee[3]*this._previewPlaneOpacity];this._previewPlaneOutlineVisualElement.color=e;const t=[te[0],te[1],te[2],te[3]*this._previewPlaneOpacity],i=[0,0,0,0];this._previewPlaneGridVisualElement.backgroundColor=t,this._previewPlaneGridVisualElement.gridColor=i}_updateManipulatorsInteractive(e){if(!e.grabbing)return this.shiftManipulator.interactive=!0,this.rotateHeadingManipulator.interactive=!0,this.rotateTiltManipulator.interactive=!0,void this.resizeManipulators.forEach(t=>{t.interactive=!0});this.shiftManipulator.interactive=this.shiftManipulator===e,this.rotateHeadingManipulator.interactive=this.rotateHeadingManipulator===e,this.rotateTiltManipulator.interactive=this.rotateTiltManipulator===e,this.resizeManipulators.forEach(t=>{t.interactive=t===e})}testData(){return{plane:this.analysisViewData.plane,setPointerMoveTimerMs:e=>{this._pointerMoveTimerMs=e}}}};function ft(e,t,i,a){const s=Ha(i,we(a),e.direction,Le()),n=J();return ye(s,e,n)?{type:"shift",creatingPointerId:t,hasBeenDragged:!1,shiftPlane:s,depth:0,startPoint:n}:null}function Oe(e){return e.pointerType!=="mouse"||e.button===0}M.disableEngineLayers=!1,d([u()],M.prototype,"_clock",void 0),d([u({constructOnly:!0})],M.prototype,"view",void 0),d([u()],M.prototype,"analysisViewData",void 0),d([u({readOnly:!0})],M.prototype,"state",null),d([u({readOnly:!0})],M.prototype,"cursor",null),d([u()],M.prototype,"analysis",null),d([u()],M.prototype,"removeIncompleteOnCancel",void 0),d([u({readOnly:!0})],M.prototype,"layersMode",void 0),d([u({value:null})],M.prototype,"inputState",null),d([u()],M.prototype,"_isPlacingSlicePlane",null),d([u()],M.prototype,"_creatingPointerId",null),M=Ne=d([oe("esri.views.3d.analysis.Slice.SliceTool")],M);const ss=D(),ns=wi(),rs=M;let W=class extends ze{constructor(e){super(e),this._handles=new ve,this._gridVisualElement=null,this._outlineVisualElement=null,this.showGrid=!1,this.preview=!0}initialize(){const e=this.analysisViewData;if(p(e))throw new Error("expected internal object to be valid");this._gridVisualElement=Gt(this.view),this._outlineVisualElement=zt(this.view),this._handles.add([x(()=>({visible:h(e.plane)&&this.analysisViewData.visible,active:this.analysisViewData.active,preview:this.preview,showGrid:this.showGrid}),t=>this._updateMaterials(t),Se),x(()=>e.plane,t=>this._updatePlane(t),Se)],"internal")}destroy(){this._handles.destroy(),this._gridVisualElement=q(this._gridVisualElement),this._outlineVisualElement=q(this._outlineVisualElement),this.set("view",null)}_updatePlane(e){if(p(e))return;this._gridVisualElement.attached=!0,this._outlineVisualElement.attached=!0;const t=ie(l.get(),C(e.basis1),C(e.basis2),1),i=$t(H.get(),t),a=Ht(e,H.get()),s=Y(i,a,i);this._outlineVisualElement.transform=s,this._gridVisualElement.transform=s}_updateMaterials({visible:e,active:t,preview:i,showGrid:a}){this._outlineVisualElement.color=ee,this._outlineVisualElement.width=i?Rt:kt,this._outlineVisualElement.stipplePattern=t?null:gi(5),this._gridVisualElement.backgroundColor=te,this._gridVisualElement.gridColor=a?xt:$i,this._gridVisualElement.visible=e,this._outlineVisualElement.visible=e}};d([u()],W.prototype,"view",void 0),d([u()],W.prototype,"analysis",void 0),d([u()],W.prototype,"analysisViewData",void 0),d([u()],W.prototype,"showGrid",void 0),d([u()],W.prototype,"preview",void 0),W=d([oe("esri.views.3d.analysis.Slice.SliceVisualization")],W);let k=class extends Jt(ze){constructor(e){super(e),this.type="slice-view-3d",this.analysis=null,this.tool=null,this.analysisVisualization=null,this.analysisController=null,this.plane=null,this.active=!0}initialize(){this.analysisVisualization=new W({view:this.view,analysis:this.analysis,analysisViewData:this}),this.analysisController=new X({view:this.view,analysis:this.analysis,analysisViewData:this}),this.addHandles(Ri(this,rs))}destroy(){ki(this),this.analysisVisualization=q(this.analysisVisualization),this.analysisController=q(this.analysisController)}get showGrid(){var e;return((e=this.analysisVisualization)==null?void 0:e.showGrid)??!1}set showGrid(e){this.analysisVisualization&&(this.analysisVisualization.showGrid=e)}get editable(){return!this.analysisVisualization.preview}set editable(e){this.analysisVisualization.preview=!e}get testData(){return{visualization:this.analysisVisualization,controller:this.analysisController,tool:Pt(this.tool)}}};d([u({readOnly:!0})],k.prototype,"type",void 0),d([u({constructOnly:!0,nonNullable:!0})],k.prototype,"analysis",void 0),d([u()],k.prototype,"tool",void 0),d([u()],k.prototype,"plane",void 0),d([u()],k.prototype,"active",void 0),d([u()],k.prototype,"showGrid",null),d([u()],k.prototype,"editable",null),k=d([oe("esri.views.3d.analysis.SliceAnalysisView3D")],k);const os=k,en=Object.freeze(Object.defineProperty({__proto__:null,default:os},Symbol.toStringTag,{value:"Module"}));export{en as S,Ea as t};
