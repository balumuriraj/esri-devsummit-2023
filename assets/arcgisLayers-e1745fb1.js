import{_ as v}from"./preload-helper-3bce6601.js";import{a as w}from"./Error-ec6249b9.js";import{t as S,r as d}from"./typedArrayUtil-4d7bb04c.js";import{i as L,j as O}from"./request-6fc81c4c.js";import{m as P,w as T}from"./arcgisLayerUrl-c09f09b4.js";import{a as c,r as g}from"./fetchService-2100186c.js";import{a as C}from"./lazyLayerLoader-41b90a4f.js";import"./string-a318751c.js";import"./promiseUtils-1e54421e.js";import"./persistableUrlUtils-5f719c3b.js";async function G(e){var s;const l=(s=e.properties)==null?void 0:s.customParameters,r=await N(e.url,l),a={...e.properties,url:e.url};if(!r.sublayerIds)return r.layerOrTableId!=null&&(a.layerId=r.layerOrTableId,a.sourceJSON=r.sourceJSON),new r.Constructor(a);const n=new(await v(()=>import("./GroupLayer-6de1ba0f.js"),["assets/GroupLayer-6de1ba0f.js","assets/cast-fcb46737.js","assets/typedArrayUtil-4d7bb04c.js","assets/string-a318751c.js","assets/Error-ec6249b9.js","assets/ArrayPool-a8ee9378.js","assets/nextTick-3ee5a785.js","assets/promiseUtils-1e54421e.js","assets/CollectionFlattener-8f4d518b.js","assets/Collection-910b6f71.js","assets/Evented-a45c8b0f.js","assets/SimpleObservable-23231131.js","assets/loadAll-b5bfa7ab.js","assets/asyncUtils-437defc4.js","assets/Loadable-268c900a.js","assets/Promise-376ab9f6.js","assets/MultiOriginJSONSupport-aae3bc0c.js","assets/reactiveUtils-4dabbb80.js","assets/Extent-da876e26.js","assets/Ellipsoid-89682c5e.js","assets/Layer-5ffe0eda.js","assets/preload-helper-3bce6601.js","assets/geometry-b7901087.js","assets/Polyline-ff2d7c6b.js","assets/typeUtils-35750739.js","assets/jsonMap-7b8332c9.js","assets/request-6fc81c4c.js","assets/Identifiable-bfe1ff30.js","assets/BlendLayer-20d0571b.js","assets/parser-498c8be0.js","assets/colorUtils-639f4d25.js","assets/screenUtils-410d12c0.js","assets/mat4f32-77b3d8ac.js","assets/mat4-44a0988f.js","assets/vec3f64-2f9cef06.js","assets/common-c186b691.js","assets/OperationalLayer-97084f13.js","assets/TimeExtent-23e282b9.js","assets/persistableUrlUtils-5f719c3b.js","assets/ElevationInfo-215614d8.js","assets/fieldUtils-7f54c4b1.js","assets/arcadeOnDemand-281a01eb.js","assets/lengthUtils-fa751420.js","assets/unitUtils-45d1147c.js","assets/opacityUtils-1f7f5126.js","assets/PortalLayer-b2643f87.js","assets/Portal-2bb189b3.js","assets/locale-30120714.js","assets/PortalGroup-8e41557a.js","assets/PortalUser-659cc1d2.js","assets/PortalItem-bb7e98a6.js","assets/assets-8d3e737a.js","assets/ScaleRangeLayer-4be07229.js","assets/lazyLayerLoader-41b90a4f.js","assets/TablesMixin-bc97d131.js","assets/collectionUtils-803d9ba8.js","assets/writeUtils-e686bd33.js","assets/layerUtils-f4d08f94.js"])).default({title:r.parsedUrl.title});return F(n,r,a),n}function b(e,l){return e?e.find(r=>r.id===l):null}function F(e,l,r){function a(n,s){const o={...r,layerId:n,sublayerTitleMode:"service-name"};return d(s)&&(o.sourceJSON=s),new l.Constructor(o)}l.sublayerIds.forEach(n=>{const s=a(n,b(l.sublayerInfos,n));e.add(s)}),l.tableIds.forEach(n=>{const s=a(n,b(l.tableInfos,n));e.tables.add(s)})}async function N(e,l){let r=P(e);if(S(r)&&(r=await U(e,l)),S(r))throw new w("arcgis-layers:url-mismatch","The url '${url}' is not a valid arcgis resource",{url:e});const{serverType:a,sublayer:n}=r;let s;const o={FeatureServer:"FeatureLayer",StreamServer:"StreamLayer",VectorTileServer:"VectorTileLayer"};switch(a){case"MapServer":s=n!=null?"FeatureLayer":V(e,l).then(t=>t?"TileLayer":"MapImageLayer");break;case"ImageServer":s=c(e,{customParameters:l}).then(t=>{const y=t.tileInfo&&t.tileInfo.format;return t.tileInfo?(y==null?void 0:y.toUpperCase())!=="LERC"||t.cacheType&&t.cacheType.toLowerCase()!=="elevation"?"ImageryTileLayer":"ElevationLayer":"ImageryLayer"});break;case"SceneServer":s=c(r.url.path,{customParameters:l}).then(t=>{var y;if(t){if((t==null?void 0:t.layerType)==="Voxel")return"VoxelLayer";if(t!=null&&t.layers&&Array.isArray(t.layers)&&t.layers.length>0){const f={Point:"SceneLayer","3DObject":"SceneLayer",IntegratedMesh:"IntegratedMeshLayer",PointCloud:"PointCloudLayer",Building:"BuildingSceneLayer"},I=(y=t.layers[0])==null?void 0:y.layerType;if(f[I]!=null)return f[I]}}return"SceneLayer"});break;default:s=o[a]}const u={FeatureLayer:!0,SceneLayer:!0},m=a==="FeatureServer",i={parsedUrl:r,Constructor:null,layerOrTableId:m?n:null,sublayerIds:null,tableIds:null},p=await s;if(u[p]&&n==null){const t=await _(e,a,l);m&&(i.sublayerInfos=t.layerInfos,i.tableInfos=t.tableInfos),t.layerIds.length+t.tableIds.length!==1?(i.sublayerIds=t.layerIds,i.tableIds=t.tableIds):m&&(i.layerOrTableId=t.layerIds[0]??t.tableIds[0],i.sourceJSON=t.layerInfos[0]??t.tableInfos[0])}return i.Constructor=await J(p),i}async function U(e,l){var u;const r=await c(e,{customParameters:l});let a=null,n=null;const s=r.type;if(s==="Feature Layer"||s==="Table"?(a="FeatureServer",n=r.id):s==="indexedVector"?a="VectorTileServer":r.hasOwnProperty("mapName")?a="MapServer":r.hasOwnProperty("bandCount")&&r.hasOwnProperty("pixelSizeX")?a="ImageServer":r.hasOwnProperty("maxRecordCount")&&r.hasOwnProperty("allowGeometryUpdates")?a="FeatureServer":r.hasOwnProperty("streamUrls")?a="StreamServer":h(r)?(a="SceneServer",n=r.id):r.hasOwnProperty("layers")&&h((u=r.layers)==null?void 0:u[0])&&(a="SceneServer"),!a)return null;const o=n!=null?T(e):null;return{title:d(o)&&r.name||L(e),serverType:a,sublayer:n,url:{path:d(o)?o.serviceUrl:O(e).path}}}function h(e){return(e==null?void 0:e.hasOwnProperty("store"))&&e.hasOwnProperty("id")&&typeof e.id=="number"}async function _(e,l,r){let a,n=!1;if(l==="FeatureServer"){const u=await g(e,{customParameters:r});n=!!u.layersJSON,a=u.layersJSON||u.serviceJSON}else a=await c(e,{customParameters:r});const s=a==null?void 0:a.layers,o=a==null?void 0:a.tables;return{layerIds:(s==null?void 0:s.map(u=>u.id).reverse())||[],tableIds:(o==null?void 0:o.map(u=>u.id).reverse())||[],layerInfos:n?s:[],tableInfos:n?o:[]}}async function J(e){return(0,C[e])()}async function V(e,l){return(await c(e,{customParameters:l})).tileInfo}export{G as fromUrl};
