import{_ as _e,r as ou,j as DS,a as lu}from"./index-00759e4a.js";import{z as W,d as es,P as J,_ as Be,f as T,o as j,g as pe,k as B,u as X,A as Gr,m as Q,p as Pe,r as Ge,t as aa,q as H,x as yi,H as Bd,F as An,B as $a,C as iT,O as xe,D as go,E as sn,G as li,I as Et,J as Kr,K as O0,M as Ht,N as R0,Q as yt,R as g,S as Pd,T as Ff,U as zf,V as IS,X as fx,Y as ut,w as ds,Z as s1,$ as P,a0 as g4,a1 as bt,a2 as Hd,a3 as Si,a4 as f4,a5 as _4,a6 as Ms,a7 as MA,a8 as je,a9 as y4,e as d,y as v,a as Y,j as Od,v as Ie,aa as Vi,ab as Rd,l as te,ac as Bt,ad as v4,ae as ea,af as rT,ag as b4,ah as fo,ai as Te,aj as Th,ak as Qo,al as Uf,am as Ys,an as ve,ao as ee,ap as Gg,aq as ln,ar as LS,as as a1,at as tc,au as Kp,av as x4,aw as ui,ax as Gl,ay as w4,az as _o,aA as Vf,aB as Pt,aC as $e,aD as zt,aE as Br,aF as st,aG as Lp,aH as er,aI as De,aJ as vi,aK as It,aL as fs,aM as hi,aN as sv,aO as T4,aP as E0,aQ as Zc,aR as pr,aS as C4,aT as DA,aU as S4,aV as $S,aW as Xr,aX as NS,aY as IA,aZ as Pi,a_ as Ul,a$ as sT,b0 as Zr,b1 as P4,b2 as Zi,h as Ji,b3 as na,b4 as O4,b5 as Xl,b6 as LA,b7 as R4,b8 as av,b9 as aT,ba as Qi,bb as Bg,bc as E4,bd as yo,be as Ed,bf as ii,bg as Mn,bh as ny,bi as ul,bj as Ad,bk as Hg,bl as nT,bm as A4,bn as Vc,bo as M4,bp as FS,bq as D4,br as ol,bs as $A,bt as el,bu as ic,bv as Je,bw as to,bx as NA,by as I4,bz as $p,bA as Np,bB as L4,bC as lh,bD as wo,bE as $4,bF as N4,bG as ts,bH as Jr,bI as oa,bJ as F4,bK as kg,bL as z4,bM as gm,bN as vo,bO as ch,bP as oT,bQ as lT,bR as _s,bS as FA,bT as oy,bU as Ql,bV as zA,bW as di,bX as oo,bY as cT,bZ as U4,b_ as hT,b$ as V4,c0 as G4,c1 as nv,c2 as ha,c3 as Fp,c4 as ly,c5 as zp,c6 as Zl,c7 as UA,c8 as dT,c9 as VA,ca as jg,cb as _x,cc as wn,cd as GA,ce as hh,b as ll,cf as uT,cg as pT,ch as qg,ci as zS,cj as n1,ck as US,cl as pl,cm as Zo,cn as B4,co as H4,cp as k4,cq as j4,cr as q4,cs as W4,ct as X4,cu as Q4,cv as VS,cw as Ot,cx as Bl,cy as Z4,cz as da,cA as on,cB as bo,cC as cy,cD as Yo,cE as dh,cF as eh,cG as ov,cH as At,cI as Ks,cJ as Y4,cK as BA,cL as HA,cM as kA,cN as jA,cO as K4,cP as J4,cQ as lv,cR as no,cS as Yc,cT as eN,cU as lr,cV as tN,cW as iN,cX as rN,cY as sN,cZ as qA,c_ as cv,c$ as WA,d0 as aN,d1 as mT,d2 as cu,d3 as uh,d4 as ta,d5 as XA,d6 as gT,d7 as lo,d8 as fT,d9 as nN,da as QA,db as hv,dc as _T,dd as oN,de as lN,df as On,dg as yT,dh as cN,di as yx,dj as ZA,dk as Wg,dl as hN,dm as Up,dn as qo,dp as fm,dq as GS,dr as kc,ds as _r,dt as dN,du as hy,dv as uN,dw as pN,dx as dy,dy as mN,dz as o1,dA as Ea,dB as gN,dC as YA,dD as Ur,dE as fN,dF as _N,dG as nn,dH as co,dI as yN,dJ as KA,dK as JA,dL as BS,dM as vN,dN as bN,dO as xN,dP as wN,dQ as TN,dR as CN,dS as vx,dT as e3,dU as SN,dV as th,dW as t3,dX as i3,dY as Jp,dZ as r3,d_ as PN,d$ as t_,e0 as l1,e1 as hu,e2 as ON,e3 as vT,e4 as HS,e5 as RN,e6 as i_,e7 as bx,e8 as EN,e9 as c1,ea as kS,eb as dv,ec as bT,ed as AN,ee as MN,ef as xT,eg as wT,eh as s3,ei as DN,ej as IN,ek as LN,el as $N,em as NN,en as FN,eo as zN,ep as h1,eq as xx,er as UN,es as VN,et as a3,eu as GN,ev as BN,ew as HN,ex as kN,ey as jN,ez as n3,eA as wx,eB as qN,eC as WN,eD as XN,eE as xd,eF as xg,eG as QN,eH as ZN,eI as Tx,eJ as jS,eK as YN,eL as Vp,eM as o3,eN as Xg,eO as TT,eP as KN,eQ as io,eR as l3,eS as JN,eT as e9,eU as t9,eV as c3,eW as i9,eX as r9,eY as s9,eZ as qS,e_ as a9,e$ as Cx,f0 as n9,f1 as o9,f2 as l9,f3 as c9,f4 as h9,f5 as d9,f6 as h3,f7 as WS,f8 as d3,f9 as u9,fa as u3,fb as p9,fc as m9,fd as r_,fe as g9,ff as f9,fg as XS,fh as _9,fi as y9,fj as v9,fk as b9,fl as x9,fm as w9,fn as T9,fo as p3,fp as C9,fq as S9,fr as P9,fs as O9,ft as d1,fu as QS,fv as ZS,fw as u1,fx as p1,fy as R9,fz as E9,fA as A9,fB as YS,fC as KS,fD as JS,fE as e2,fF as M9,fG as D9,fH as t2,fI as I9,fJ as L9,fK as $9,fL as N9,fM as F9,s as z9,L as U9}from"./calcite-8912bd40.js";import{s as CT,c as Ve,b as V9,f as wg,n as Kc,E as G9,$ as B9,d as Aa,p as xo,z as uv,q as H9,h as k9,k as Sx,Y as pv,O as ST,W as PT,r as j9,a as m3,e as q9,R as Nn,F as W9,g as OT,C as X9,w as Q9,i as g3,T as f3}from"./sphere-d0e5285d.js";import{e as ce,t as _3,o as ph,r as Z9}from"./mat4f64-abdda1bb.js";import{v as em,A as i2,M as RT,s as dt,u as r2,l as y3,b as wd,k as v3,a as Y9,c as du,f as s_,h as K9}from"./Util-6d3f024a.js";import{p as Ui,E as J9,A as b3,O as Qg,F as eF,x as kd,U as tF,w as iF,B as x3,J as rF,Y as As,L as Px,_ as mv,V as Ri,T as w3,P as Ox,j as tl,b as sF,Q as s2}from"./plane-5e2b046c.js";import{c as aF}from"./spatialReferenceEllipsoidUtils-afb35af9.js";import{o as nF,r as oF}from"./scaleUtils-d13015f2.js";import{h as lF,t as cF}from"./ElevationSamplerData-e3118b17.js";import{o as $t,a as gv,d as mh,e as ir,b as pi,c as si,f as ai,g as ue,h as lt,i as tm,j as ml,k as Mt,l as Rt,E as Lt,t as Dt,r as D,m as ua,n as pa,A as Gf,p as Ch,q as fv,s as ih,u as im,v as rc,w as To,x as T3,y as Wt,z as C3,B as S3,C as sc,D as Rx,F as K,L as m1,G as hF,H as Vn,I as il,J as Cr,K as ps,M as ac,N as P3,O as A,P as dF,Q as O3,R as uF,S as pF,T as a2,U as jc,V as R3,W as nc,X as rm,Y as mF,Z as Zg,_ as ET,$ as Bf,a0 as _v,a1 as ms,a2 as ia,a3 as Qr,a4 as gF,a5 as AT,a6 as fF,a7 as MT,a8 as rh,a9 as Ps,aa as ra,ab as Ex,ac as Sh,ad as jd,ae as _F,af as E3,ag as n2,ah as yF,ai as A3,aj as vF,ak as qi,al as DT,am as M3,an as D3,ao as uy,ap as o2,aq as bF,ar as I3,as as Ax,at as l2,au as c2,av as qd,aw as Hf,ax as sm,ay as gh,az as Gp,aA as L3,aB as Yl,aC as Kl,aD as Md,aE as Wd,aF as py,aG as $3,aH as N3,aI as F3,aJ as IT,aK as LT,aL as xF,aM as wF,aN as TF,aO as yv,aP as Yg,aQ as kf,aR as CF,aS as SF,aT as z3,aU as U3,aV as Kg,aW as jf,aX as PF,aY as _m,aZ as OF,a_ as RF,a$ as EF,b0 as AF,b1 as $T,b2 as V3,b3 as Jg,b4 as ef,b5 as G3,b6 as MF,b7 as B3,b8 as NT,b9 as Ia,ba as H3,bb as h2,bc as DF,bd as k3,be as IF,bf as j3,bg as FT,bh as LF,bi as $F,bj as NF,bk as FF,bl as q3,bm as zF,bn as W3,bo as UF,bp as Rn,bq as VF,br as GF,bs as vv,bt as BF,bu as HF,bv as Tp,bw as A0,bx as X3,by as kF,bz as jF,bA as qF,bB as WF,bC as XF,bD as QF,bE as Q3,bF as ZF,bG as YF,bH as KF,bI as Z3,bJ as zT,bK as Y3,bL as UT,bM as JF,bN as e6,bO as t6,bP as i6,bQ as K3,bR as d2,bS as u2,bT as r6}from"./objectResourceUtils-782953c3.js";import{o as _,n as Gi,W as qe,l as Ar,_ as at,s as oc,a as We,r as J3,b as cn,A as Ph,c as In,d as Xd,E as bv,e as VT,f as GT,S as BT,g as s6,h as HT}from"./OrderIndependentTransparency-5f7257d7.js";import{O as w}from"./VertexAttribute-15d1866a.js";import{R as ae,I as Fa,E as Ut,T as eM,Y as la,M as tr,P as St,G as Zt,D as kt,L as Qt,F as ca,V as La,_ as Xi,A as a6,C as Cp,B as n6,U as g1}from"./enums-e2e92c86.js";import{r as qt,a as o6,n as Li,t as p2}from"./vec3f32-01c06d8d.js";import{e as ys}from"./mat3f64-50f3b9f6.js";import{x as Rs,n as Os,E as gs,R as tM,a as iM,u as my,f as l6,s as c6}from"./FramebufferObject-8b18fc0c.js";import{H as tf,u as gy,s as rM,l as ei,I as h6,L as d6,i as xv,P as u6,m as p6,p as sM,k as m6,V as ho,U as $i,v as g6}from"./Octree-499541ed.js";import{o as Co,m as f6,A as Mx,a as aM,f as _6,e as y6,u as m2,T as v6,d as b6,w as x6}from"./edgeProcessing-20e12367.js";import{T as mr}from"./InterleavedLayout-d57c91d0.js";import{s as be,n as w6,o as nM,r as fy}from"./symbolColorUtils-c9d24716.js";import{n as Fn,l as wv,f as Bp,a as mo,g as T6,c as C6,t as S6}from"./MeshComponent-788e605a.js";import{o as kT,n as f1}from"./Indices-d8bff7b2.js";import{E as Ai}from"./Texture-563cf5e5.js";import{a as P6,q as g2,g as f2,O as O6,v as R6,j as E6,V as A6,k as M6}from"./projection-5969b753.js";import{t as Tv}from"./NestedMap-1b5db22e.js";import{S as D6}from"./quat-7b70e9a8.js";import{e as I6}from"./quatf64-f8f1c132.js";import{t as _1,a as L6,s as oM,b as lM,l as cM}from"./ZoomMomentumEstimator-ef57e6a4.js";import{x as fh,T as _y,i as _h,u as hM,b as _2,l as rf,h as $6,c as sf,d as y2}from"./BufferView-379a78a4.js";import{o as af,r as N6}from"./floatRGBA-ca2b39ca.js";import{M as lc,v as F6,z as z6}from"./dehydratedFeatures-3a140d03.js";import{createLabelFunction as U6}from"./labelFormatUtils-71e1f841.js";import{t as Hp,i as yy,N as M0,n as Tr,D as jT,u as en,O as Wi,a as Tg,s as nf}from"./basicInterfaces-7449a8bf.js";import{A as ht,a as V6,f as dM,e as G6,R as B6,O as v2,n as H6,b as k6}from"./orientedBoundingBox-a14b97b5.js";import{r as of}from"./earcut-61f7b102.js";import{t as uM,r as vy,e as pM}from"./vec33-69c9e93b.js";import{t as j6,e as b2}from"./SnappingCandidate-970faec6.js";import{i as q6}from"./callExpressionWithFeature-df1a8f01.js";import{t as y1}from"./resourceUtils-527631ac.js";import{r as lf}from"./DefaultVertexAttributeLayouts-5f20d8dd.js";import{getGeometryServiceURL as W6}from"./geometryServiceUtils-a536bb19.js";import{a as X6,n as Q6}from"./project-909a4219.js";import{m as Z6,n as Y6}from"./DefaultMaterial_COLOR_GAMMA-6ed76d86.js";import{n as K6,e as J6,h as e8}from"./LercDecoder-65586d50.js";import{m as v1,p as t8}from"./VectorTile-d41a1f0f.js";import{l as i8,p as r8,g as s8,E as a8,A as n8,c as o8,_ as x2}from"./rasterUtils-7694cc98.js";import{t as cf}from"./requestImageUtils-d1ba3b36.js";import{s as l8}from"./resources-7587d8f4.js";import{D as a_}from"./workerHelper-6131d203.js";import{E as c8}from"./webgl-debug-7f880832.js";import{I as h8}from"./RenderingContext-0f21aa0e.js";import{e as b1}from"./imageUtils-c2d0d1ae.js";import{a as d8,x as u8,v as p8}from"./MediaLayer-4c42fc2f.js";import{P as m8,h as g8,C as f8}from"./prism-line-numbers-eff41b13.js";function Dd(i){const e=i[0]*i[0]+i[4]*i[4]+i[8]*i[8],t=i[1]*i[1]+i[5]*i[5]+i[9]*i[9],r=i[2]*i[2]+i[6]*i[6]+i[10]*i[10];return Math.sqrt(Math.max(e,t,r))}function _8(i,e){const t=Math.sqrt(e[0]*e[0]+e[4]*e[4]+e[8]*e[8]),r=Math.sqrt(e[1]*e[1]+e[5]*e[5]+e[9]*e[9]),s=Math.sqrt(e[2]*e[2]+e[6]*e[6]+e[10]*e[10]);return j(i,t,r,s),i}function Hre(i,e,t){t=t||i;const r=J(i,e);j(t,i[0]-r*e[0],i[1]-r*e[1],i[2]-r*e[2]),W(t,t)}function kre(i,e,t){Math.abs(i[0])>Math.abs(i[1])?j(e,0,1,0):j(e,1,0,0),Be(t,i,e),W(e,e),Be(e,t,i),W(t,t)}function n_(i,e,t,r,s,a){const n=i+(e-i)*s;return n+(t+(r-t)*s-n)*a}function y8(i,e,t,r=T()){const s=pe(i),a=pe(e),n=J(i,e)/(s*a);if(n<.9999999999999999){const o=Math.acos(n),l=((1-t)*s+t*a)/Math.sin(o),c=l/s*Math.sin((1-t)*o),h=l/a*Math.sin(t*o);return B(fd,i,c),B(_d,e,h),X(r,fd,_d)}return Gr(r,i,e,t)}function jre(i,e,t,r=T(),s=T()){const a=pe(i),n=pe(e),o=J(i,e)/(a*n);if(o<.9999999999999999){const l=Math.acos(o),c=Math.sin(l),h=Math.sin(t*l),u=Math.sin((1-t)*l),p=(1-t)*a+t*n;{const m=p/c,f=m/n*h;B(fd,i,m/a*u),B(_d,e,f),X(r,fd,_d)}{const m=1/a*(-Math.cos((1-t)*l)*l*p+u*(-a+n));B(fd,i,m);const f=1/n*(Math.cos(t*l)*l*p+h*(-a+n));B(_d,e,f),X(s,fd,_d),B(s,s,1/c)}return s}return Gr(r,i,e,t),Q(s,e,i),W(s,s),s}function D0(i,e,t){i=W(fd,i),e=W(_d,e);const r=es(J(i,e));if(t){const s=Be(v8,i,e);if(J(s,t)<0)return-r}return r}function I0(i){const e=i.length;return t=>{if(t<=i[0][0])return i[0][1];if(t>=i[e-1][0])return i[e-1][1];let r=1;for(;t>i[r][0];)r++;const s=i[r-1][0],a=i[r][0],n=(a-t)/(a-s);return n*i[r-1][1]+(1-n)*i[r][1]}}function qre(i,e,t,r){Q(w2,e,i),Q(T2,t,i),Be(r,w2,T2),W(r,r),r[3]=-J(i,r)}const w2=T(),T2=T(),v8=T(),fd=T(),_d=T(),x1=Pe.getLogger("esri.views.3d.support.geometryUtils.boundedPlane");let b8=class{constructor(){this.plane=Ui(),this.origin=T(),this.basis1=T(),this.basis2=T()}};const mM=b8;function cc(i=SM){return{plane:Ui(i.plane),origin:aa(i.origin),basis1:aa(i.basis1),basis2:aa(i.basis2)}}function x8(i,e,t){const r=I8.get();return r.origin=i,r.basis1=e,r.basis2=t,r.plane=J9(0,0,0,0),Cv(r),r}function Qd(i,e=cc()){return qT(i.origin,i.basis1,i.basis2,e)}function w8(i,e){H(e.origin,i.origin),H(e.basis1,i.basis1),H(e.basis2,i.basis2),b3(e.plane,i.plane)}function qT(i,e,t,r=cc()){return H(r.origin,i),H(r.basis1,e),H(r.basis2,t),Cv(r),M8(r,"fromValues()"),r}function Cv(i){Qg(i.basis2,i.basis1,i.origin,i.plane)}function gM(i,e,t){i!==t&&Qd(i,t);const r=B(Ve.get(),Jl(i),e);return X(t.origin,t.origin,r),t.plane[3]-=e,t}function T8(i,e,t){return fM(e,t),gM(t,ZT(i,i.origin),t),t}function fM(i,e=cc()){const t=(i[2]-i[0])/2,r=(i[3]-i[1])/2;return j(e.origin,i[0]+t,i[1]+r,0),j(e.basis1,t,0,0),j(e.basis2,0,r,0),eF(0,0,1,0,e.plane),e}function WT(i,e,t){return!!kd(i.plane,e,t)&&TM(i,t)}function C8(i,e,t){if(WT(i,e,t))return t;const r=_M(i,e,Ve.get());return X(t,e.origin,B(Ve.get(),e.direction,yi(e.origin,r)/pe(e.direction))),t}function _M(i,e,t){const r=by.get();CM(i,e,r,by.get());let s=Number.POSITIVE_INFINITY;for(const a of KT){const n=YT(i,a,Sv.get()),o=Ve.get();if(tF(r,n,o)){const l=Bd(Ve.get(),e.origin,o),c=Math.abs(es(J(e.direction,l)));c<s&&(s=c,H(t,o))}}return s===Number.POSITIVE_INFINITY?yM(i,e,t):t}function yM(i,e,t){if(WT(i,e,t))return t;const r=by.get(),s=by.get();CM(i,e,r,s);let a=Number.POSITIVE_INFINITY;for(const n of KT){const o=YT(i,n,Sv.get()),l=Ve.get();if(iF(r,o,l)){const c=V9(e,l);if(!x3(s,l))continue;c<a&&(a=c,H(t,l))}}return XT(i,e.origin)<a&&vM(i,e.origin,t),t}function vM(i,e,t){const r=rF(i.plane,e,Ve.get()),s=i2(C2(i,i.basis1),r,-1,1,Ve.get()),a=i2(C2(i,i.basis2),r,-1,1,Ve.get());return Q(t,X(Ve.get(),s,a),i.origin),t}function bM(i,e,t){const{origin:r,basis1:s,basis2:a}=i,n=Q(Ve.get(),e,r),o=wg(s,n),l=wg(a,n),c=wg(Jl(i),n);return j(t,o,l,c)}function XT(i,e){const t=bM(i,e,Ve.get()),{basis1:r,basis2:s}=i,a=pe(r),n=pe(s),o=Math.max(Math.abs(t[0])-a,0),l=Math.max(Math.abs(t[1])-n,0),c=t[2];return o*o+l*l+c*c}function S8(i,e){return Math.sqrt(XT(i,e))}function P8(i,e){let t=Number.NEGATIVE_INFINITY;for(const r of KT){const s=YT(i,r,Sv.get()),a=RT(s,e);a>t&&(t=a)}return Math.sqrt(t)}function QT(i,e){return x3(i.plane,e)&&TM(i,e)}function O8(i,e,t,r){return A8(i,t,r)}function ZT(i,e){const t=-i.plane[3];return wg(Jl(i),e)-t}function R8(i,e,t,r){const s=ZT(i,e),a=B(D8,Jl(i),t-s);return X(r,e,a),r}function xM(i,e){return An(i.basis1,e.basis1)&&An(i.basis2,e.basis2)&&An(i.origin,e.origin)}function wM(i,e,t){return i!==t&&Qd(i,t),$a(uu,e),iT(uu,uu),xe(t.basis1,i.basis1,uu),xe(t.basis2,i.basis2,uu),xe(As(t.plane),As(i.plane),uu),xe(t.origin,i.origin,e),Px(t.plane,t.plane,t.origin),t}function E8(i,e,t,r){return i!==r&&Qd(i,r),go(w1,e,t),xe(r.basis1,i.basis1,w1),xe(r.basis2,i.basis2,w1),Cv(r),r}function Jl(i){return As(i.plane)}function A8(i,e,t){switch(e){case Kc.X:H(t,i.basis1),W(t,t);break;case Kc.Y:H(t,i.basis2),W(t,t);break;case Kc.Z:H(t,Jl(i))}return t}function TM(i,e){const t=Q(Ve.get(),e,i.origin),r=sn(i.basis1),s=sn(i.basis2),a=J(i.basis1,t),n=J(i.basis2,t);return-a-r<0&&a-r<0&&-n-s<0&&n-s<0}function C2(i,e){const t=Sv.get();return H(t.origin,i.origin),H(t.vector,e),t}function YT(i,e,t){const{basis1:r,basis2:s,origin:a}=i,n=B(Ve.get(),r,e.origin[0]),o=B(Ve.get(),s,e.origin[1]);X(t.origin,n,o),X(t.origin,t.origin,a);const l=B(Ve.get(),r,e.direction[0]),c=B(Ve.get(),s,e.direction[1]);return B(t.vector,X(l,l,c),2),t}function M8(i,e){Math.abs(J(i.basis1,i.basis2)/(pe(i.basis1)*pe(i.basis2)))>1e-6&&x1.warn(e,"Provided basis vectors are not perpendicular"),Math.abs(J(i.basis1,Jl(i)))>1e-6&&x1.warn(e,"Basis vectors and plane normal are not perpendicular"),Math.abs(-J(Jl(i),i.origin)-i.plane[3])>1e-6&&x1.warn(e,"Plane offset is not consistent with plane origin")}function CM(i,e,t,r){const s=Jl(i);Qg(s,e.direction,e.origin,t),Qg(As(t),s,e.origin,r)}const SM={plane:Ui(),origin:Ge(0,0,0),basis1:Ge(1,0,0),basis2:Ge(0,1,0)},by=new CT(Ui),Sv=new CT(em),D8=T(),I8=new CT(()=>cc()),KT=[{origin:[-1,-1],direction:[1,0]},{origin:[1,-1],direction:[0,1]},{origin:[1,1],direction:[-1,0]},{origin:[-1,1],direction:[0,-1]}],uu=ce(),w1=ce(),L8=Object.freeze(Object.defineProperty({__proto__:null,BoundedPlaneClass:mM,UP:SM,altitudeAt:ZT,axisAt:O8,closestPoint:yM,closestPointOnSilhouette:_M,copy:Qd,copyWithoutVerify:w8,create:cc,distance:S8,distance2:XT,distanceToSilhouette:P8,elevate:gM,equals:xM,extrusionContainsPoint:QT,fromAABoundingRect:fM,fromValues:qT,intersectRay:WT,intersectRayClosestSilhouette:C8,normal:Jl,projectPoint:vM,projectPointLocal:bM,rotate:E8,setAltitudeAt:R8,setExtent:T8,transform:wM,updateUnboundedPlane:Cv,wrap:x8},Symbol.toStringTag,{value:"Module"}));function $8(i){const{value:e,operations:t}=i;return{operations:t,value:t.create(e)}}function N8(i,e,t){return i.operations.setExtent(i.value,e,t.value),t}function F8(i){return{operations:i,value:i.create()}}function PM(i,e,t=F8(i)){return t.operations=i,i.copy(e,t.value),t}function z8(i){return PM(B9,G9(0,0,0,Et(i).radius))}const S2=2**50;function U8(){return PM(L8,qT([0,0,0],[S2,0,0],[0,S2,0]))}function V8(i,e,t){return i.operations.axisAt(i.value,e,Kc.Z,t)}function G8(i,e,t,r){return i.operations.axisAt(i.value,e,t,r)}function B8(i,e,t){return i.operations.intersectRay(i.value,e,t)}function H8(i,e,t){return i.operations.intersectRayClosestSilhouette(i.value,e,t)}function k8(i,e){return i.operations.altitudeAt(i.value,e)}function OM(i,e,t,r){return i.operations.setAltitudeAt(i.value,e,t,r)}function j8(i,e,t,r){return e!==r&&Kr(r,e),j(pu,r[12],r[13],r[14]),OM(i,pu,t,pu),r[12]=pu[0],r[13]=pu[1],r[14]=pu[2],r}function T1(i,e,t){return i.operations.elevate(i.value,e,t.value)}const pu=T();function P2(i,e,t,r,s){return s[0]=J(i,e),s[1]=J(i,t),s[2]=J(i,r),s}function Dx(i,e,t,r,s){H(t,i),H(o_,e),W(o_,o_),Be(r,o_,t),Be(s,r,t)}function RM(i,e){return i?aF(e):e.isGeographic?li.PlateCarree:e}const o_=T(),q8=12;let Ra=class Us{constructor(e){const t=Us.checkUnsupported(e);if(g(t))throw t;const r=Si(e);this.spatialReference=r.spatialReference,this._isWebMercator=this.spatialReference.isWebMercator,this._isGCS=Pd(this.spatialReference)||Ff(this.spatialReference)||zf(this.spatialReference),this.origin=[r.origin.x,r.origin.y],this.pixelSize=r.size[0],this.dpi=r.dpi;const s=r.lods.reduce((c,h,u)=>(h.level<c.min&&(c.min=h.level,c.minIndex=u),c.max=Math.max(c.max,h.level),c),{min:1/0,minIndex:0,max:-1/0}),a=r.lods[s.minIndex],n=2**a.level;let o=a.resolution*n,l=a.scale*n;this.levels=new Array(s.max+1);for(let c=0;c<this.levels.length;c++)this.levels[c]={resolution:o,scale:l,tileSize:[o*r.size[0],o*r.size[1]]},o/=2,l/=2}clone(){return new Us(this.toTileInfo())}toTileInfo(){return new O0({dpi:this.dpi,origin:new Ht({x:this.origin[0],y:this.origin[1],spatialReference:this.spatialReference}),size:[this.pixelSize,this.pixelSize],spatialReference:this.spatialReference,lods:this.levels.map((e,t)=>new R0({level:t,scale:e.scale,resolution:e.resolution}))})}getExtent(e,t,r,s){const a=this.levels[e],n=a.tileSize[0],o=a.tileSize[1];s[0]=this.origin[0]+r*n,s[2]=this.origin[0]+(r+1)*n,s[3]=this.origin[1]-t*o,s[1]=this.origin[1]-(t+1)*o}convertExtentToRadians(e,t){this._isWebMercator?(t[0]=IS(e[0]),t[1]=fx(e[1]),t[2]=IS(e[2]),t[3]=fx(e[3])):this._isGCS&&(t[0]=ut(e[0]),t[1]=ut(e[1]),t[2]=ut(e[2]),t[3]=ut(e[3]))}getExtentGeometry(e,t,r,s=new ds){return this.getExtent(e,t,r,Ro),s.spatialReference=this.spatialReference,s.xmin=Ro[0],s.ymin=Ro[1],s.xmax=Ro[2],s.ymax=Ro[3],s.zmin=void 0,s.zmax=void 0,s}ensureMaxLod(e){if(e==null)return!1;let t=!1;for(;this.levels.length<=e;){const r=this.levels[this.levels.length-1],s=r.resolution/2;this.levels.push({resolution:s,scale:r.scale/2,tileSize:[s*this.pixelSize,s*this.pixelSize]}),t=!0}return t}capMaxLod(e){this.levels.length>e+1&&(this.levels.length=e+1)}getMaxLod(){return this.levels.length-1}scaleAtLevel(e){return this.levels[0].scale/2**e}levelAtScale(e){const t=this.levels[0].scale;return e>=t?0:Math.log(t/e)*Math.LOG2E}resolutionAtLevel(e){return this.levels[0].resolution/2**e}compatibleWith(e){if(!(e instanceof Us)){if(Us.checkUnsupported(e))return!1;e=new Us(e)}if(!e.spatialReference.equals(this.spatialReference)||e.pixelSize!==this.pixelSize)return!1;const t=Math.min(this.levels.length,e.levels.length)-1,r=this.levels[t].resolution;let s=.5*r;return!s1(e.origin[0],this.origin[0],s)||!s1(e.origin[1],this.origin[1],s)?!1:(s=.5*r/2**t/this.pixelSize*q8,s1(r,e.levels[t].resolution,s))}rootTilesInExtent(e,t=null,r=1/0){const s=new Array,a=this.levels[0].tileSize;if(P(e)||a[0]===0||a[1]===0)return s;Us.computeRowColExtent(e,a,this.origin,Ro);let n=Ro[1],o=Ro[3],l=Ro[0],c=Ro[2];const h=c-l,u=o-n;if(h*u>r){const p=Math.floor(Math.sqrt(r));u>p&&(n=n+Math.floor(.5*u)-Math.floor(.5*p),o=n+p),h>p&&(l=l+Math.floor(.5*h)-Math.floor(.5*p),c=l+p)}for(let p=n;p<o;p++)for(let m=l;m<c;m++)s.push([0,p,m]);return g(t)&&(t[0]=this.origin[0]+l*a[0],t[1]=this.origin[1]-o*a[1],t[2]=this.origin[0]+c*a[0],t[3]=this.origin[1]-n*a[1]),s}static computeRowColExtent(e,t,r,s){const a=.001*(e[2]-e[0]+(e[3]-e[1]));s[0]=Math.max(0,Math.floor((e[0]+a-r[0])/t[0])),s[2]=Math.max(0,Math.ceil((e[2]-a-r[0])/t[0])),s[1]=Math.max(0,Math.floor((r[1]-e[3]+a)/t[1])),s[3]=Math.max(0,Math.ceil((r[1]-e[1]-a)/t[1]))}static isPowerOfTwo(e){const t=e.lods,r=t[0].resolution*2**t[0].level;return!t.some(s=>!g4(s.resolution,r/2**s.level))}static hasGapInLevels(e){const t=e.lods.map(r=>r.level);t.sort((r,s)=>r-s);for(let r=1;r<t.length;r++)if(t[r]!==t[0]+r)return!0;return!1}static tileSizeSupported(e){const t=e.size[1];return t===e.size[0]&&(t&t-1)==0&&t>=128&&t<=512}static hasOriginPerLODs(e){const t=e.origin;return e.lods.some(r=>r.origin!=null&&(r.origin[0]!==t.x||r.origin[1]!==t.y))}static getMissingTileInfoError(){return new bt("tilingscheme:tile-info-missing","Tiling scheme must have tiling information")}static checkUnsupported(e){return P(e)?JT():e.lods.length<1?new bt("tilingscheme:generic","Tiling scheme must have at least one level"):Us.isPowerOfTwo(e)?Us.hasGapInLevels(e)?new bt("tilingscheme:gaps","Tiling scheme levels must not have gaps between min and max level"):Us.tileSizeSupported(e)?Us.hasOriginPerLODs(e)?new bt("tilingscheme:multiple-origin","Tiling scheme levels must not have their own origin"):null:new bt("tilingscheme:tile-size","Tiles must be square and size must be one of [128, 256, 512]"):new bt("tilingscheme:power-of-two","Tiling scheme must be power of two")}static fromExtent(e,t){const r=e[2]-e[0],s=e[3]-e[1],a=Hd(t),n=1.2*Math.max(r,s),o=256,l=96,c=.0254,h=new Us(new O0({size:[o,o],origin:new Ht({x:e[0]-.5*(n-r),y:e[3]+.5*(n-s)}),lods:[new R0({level:0,resolution:n/o,scale:1/(o/l*c/(n*a))})],spatialReference:t}));return h.ensureMaxLod(20),h}static makeWebMercatorAuxiliarySphere(e){const t=new Us(Us.WebMercatorAuxiliarySphereTileInfo);return t.ensureMaxLod(e),t}static makeGCSWithTileSize(e,t=256,r=16){const s=256/t,a=new Us(new O0({size:[t,t],origin:new Ht({x:-180,y:90,spatialReference:e}),spatialReference:e,lods:[new R0({level:0,resolution:.703125*s,scale:295497598570834e-6*s})]}));return a.ensureMaxLod(r),a}get test(){return{isWebMercator:this._isWebMercator,isGCS:this._isGCS}}};function JT(){return new bt("tilingscheme:tile-info-missing","Tiling scheme must have tiling information")}Ra.WebMercatorAuxiliarySphereTileInfo=new O0({size:[256,256],origin:new Ht({x:-20037508342787e-6,y:20037508342787e-6,spatialReference:li.WebMercator}),spatialReference:li.WebMercator,lods:[new R0({level:0,resolution:156543.03392800014,scale:591657527591555e-6})]}),Ra.WebMercatorAuxiliarySphere=Ra.makeWebMercatorAuxiliarySphere(19);const Ro=yt(),dp=64,Xm=512,W8=2.5,hf=f4(_4/10),EM=2,AM=yt();Ra.WebMercatorAuxiliarySphere.getExtent(0,0,0,AM);const X8=yt([-180,-90,180,90]),Q8="Cannot extend surface to encompass all layers because it would result in too many root tiles.",Z8="Surface extent is too large for tile resolution at level 0.",Y8=3;let K8=Y8;function Ix(i){return i<4?3:K8}let $c=class extends Ms.EventedAccessor{constructor(e){super(e),this.demResolution={min:-1,max:-1},this.noDataValue=hf}initialize(){this.view.basemapTerrain.on("elevation-change",()=>this.emit("changed",{}))}get extent(){const e=this.view.basemapTerrain;if(e==null||P(e.extent)||P(e.spatialReference))return null;const t=MA(e.extent,e.spatialReference);return t.zmin=e.visibleElevationBounds.min,t.zmax=e.visibleElevationBounds.max,t}get spatialReference(){var e;return je((e=this.view.basemapTerrain)==null?void 0:e.spatialReference,li.WGS84)}elevationAt(e,t){var r;if(P(this.extent)||!y4(this.extent,e,t)){const s=g(this.extent)?`${this.extent.xmin}, ${this.extent.ymin}, ${this.extent.xmax}, ${this.extent.ymax}`:null;return Pe.getLogger(this.declaredClass).warn("#elevationAt()",`Point used to sample elevation (${e}, ${t}) is outside of the sampler extent (${s})`),this.noDataValue}return je((r=this.view.elevationProvider)==null?void 0:r.getElevation(e,t,0,this.spatialReference,"ground"),this.noDataValue)}queryElevation(e){return lF(e.clone(),this)}};d([v({readOnly:!0})],$c.prototype,"demResolution",void 0),d([v({readOnly:!0})],$c.prototype,"extent",null),d([v({readOnly:!0})],$c.prototype,"noDataValue",void 0),d([v()],$c.prototype,"spatialReference",null),d([v({constructOnly:!0})],$c.prototype,"view",void 0),$c=d([Y("esri.views.support.GroundViewElevationSampler")],$c);const J8=$c;let Nc=class extends Ie{constructor(e){super(e),this._handles=new Vi,this.view=null,this.layerViews=new Od}initialize(){this._handles.add(Rd(()=>{var e,t;return(t=(e=this.view)==null?void 0:e.map)==null?void 0:t.ground},e=>e.load())),this._handles.add(this.layerViews.on("after-changes",()=>this._layerViewsAfterChangesHandler()))}destroy(){this._set("view",null),this._handles&&(this._handles.destroy(),this._handles=null)}get elevationSampler(){return this.view?this.view.type==="2d"?null:this.view.ready&&this.view.basemapTerrain&&this.view.basemapTerrain.ready?new J8({view:this.view}):null:null}get updating(){return!this.suspended&&this.layerViews.some(e=>e.updating)}get suspended(){return!this.view||this.view.suspended}_layerViewsAfterChangesHandler(){this._handles.remove("updating"),this._handles.add(this.layerViews.map(e=>te(()=>e.updating,()=>this._updateUpdating(),Bt)).toArray(),"updating"),this._updateUpdating()}_updateUpdating(){this.notifyChange("updating")}};d([v({readOnly:!0})],Nc.prototype,"elevationSampler",null),d([v({type:Boolean,readOnly:!0})],Nc.prototype,"updating",null),d([v({constructOnly:!0})],Nc.prototype,"view",void 0),d([v({type:Od,readOnly:!0})],Nc.prototype,"layerViews",void 0),d([v({readOnly:!0})],Nc.prototype,"suspended",null),Nc=d([Y("esri.views.GroundView")],Nc);const ez=Nc,ym=()=>_e(()=>import("./TileLayerView3D-6c706424.js"),["assets/TileLayerView3D-6c706424.js","assets/calcite-8912bd40.js","assets/index-00759e4a.js","assets/index-5026a37a.css","assets/calcite-96fa36fd.css","assets/LayerView3D-4128a20f.js","assets/TiledLayerView3D-7d5deb80.js","assets/LayerView-abbb3570.js","assets/RefreshableLayerView-e4d9e9c9.js","assets/MapServiceLayerViewHelper-ee55984a.js","assets/scaleUtils-d13015f2.js","assets/floorFilterUtils-080a7cd2.js","assets/sublayerUtils-43bc6a74.js","assets/popupUtils-54bd9deb.js","assets/drapedUtils-08d2401b.js","assets/sphere-d0e5285d.js","assets/mat3f64-50f3b9f6.js","assets/mat4f64-abdda1bb.js","assets/quatf64-f8f1c132.js","assets/Util-6d3f024a.js","assets/plane-5e2b046c.js","assets/spatialReferenceEllipsoidUtils-afb35af9.js","assets/ElevationSamplerData-e3118b17.js","assets/objectResourceUtils-782953c3.js","assets/devEnvironmentUtils-5002a058.js","assets/BufferView-379a78a4.js","assets/vec33-69c9e93b.js","assets/DefaultMaterial_COLOR_GAMMA-6ed76d86.js","assets/types-e1c0a5bf.js","assets/enums-e2e92c86.js","assets/Version-aa0a1d91.js","assets/quat-7b70e9a8.js","assets/resourceUtils-527631ac.js","assets/basicInterfaces-7449a8bf.js","assets/Indices-d8bff7b2.js","assets/NestedMap-1b5db22e.js","assets/requestImageUtils-d1ba3b36.js","assets/symbolColorUtils-c9d24716.js","assets/VertexAttribute-15d1866a.js","assets/doublePrecisionUtils-e3c3d0d8.js","assets/OrderIndependentTransparency-5f7257d7.js","assets/Texture-563cf5e5.js","assets/FramebufferObject-8b18fc0c.js","assets/VertexElementDescriptor-2925c6af.js","assets/InterleavedLayout-d57c91d0.js","assets/vec3f32-01c06d8d.js","assets/Octree-499541ed.js","assets/edgeProcessing-20e12367.js","assets/deduplicate-769a6f51.js","assets/MeshComponent-788e605a.js","assets/earcut-61f7b102.js","assets/imageUtils-c2d0d1ae.js","assets/projection-5969b753.js","assets/ZoomMomentumEstimator-ef57e6a4.js","assets/floatRGBA-ca2b39ca.js","assets/dehydratedFeatures-3a140d03.js","assets/quantizationUtils-b3b2ae2a.js","assets/labelFormatUtils-71e1f841.js","assets/orientedBoundingBox-a14b97b5.js","assets/quatf32-51a323b8.js","assets/SnappingCandidate-970faec6.js","assets/callExpressionWithFeature-df1a8f01.js","assets/DefaultVertexAttributeLayouts-5f20d8dd.js","assets/geometryServiceUtils-a536bb19.js","assets/project-909a4219.js","assets/LercDecoder-65586d50.js","assets/VectorTile-d41a1f0f.js","assets/enums-fb086c25.js","assets/config-1337d16e.js","assets/TiledDisplayObject-419c008b.js","assets/DisplayObject-87c37b69.js","assets/rasterUtils-7694cc98.js","assets/resources-7587d8f4.js","assets/workerHelper-6131d203.js","assets/webgl-debug-7f880832.js","assets/RenderingContext-0f21aa0e.js","assets/ProgramCache-f29c900e.js","assets/Program-77209250.js","assets/MediaLayer-4c42fc2f.js","assets/MediaElementView-06baa4d4.js","assets/normalizeUtilsSync-3ea564a9.js","assets/resourceExtension-f31d9f10.js","assets/BoundsStore-00da37da.js","assets/PooledRBush-5a11bc7e.js","assets/prism-line-numbers-eff41b13.js","assets/label2-a2f37e65.js","assets/interactive-1de2e238.js","assets/loadable-6afd516d.js","assets/t9n-81df3a71.js","assets/observers-c89705b8.js","assets/icon-8e47fbec.js","assets/loader-c773e800.js","assets/guid-51402ee7.js","assets/prism-line-numbers-7c5d72ff.css"]),O2=()=>_e(()=>import("./ElevationLayerView3D-e312bf62.js"),["assets/ElevationLayerView3D-e312bf62.js","assets/calcite-8912bd40.js","assets/index-00759e4a.js","assets/index-5026a37a.css","assets/calcite-96fa36fd.css","assets/LayerView3D-4128a20f.js","assets/TiledLayerView3D-7d5deb80.js","assets/LayerView-abbb3570.js","assets/sphere-d0e5285d.js","assets/mat3f64-50f3b9f6.js","assets/mat4f64-abdda1bb.js","assets/quatf64-f8f1c132.js","assets/Util-6d3f024a.js","assets/plane-5e2b046c.js","assets/spatialReferenceEllipsoidUtils-afb35af9.js","assets/scaleUtils-d13015f2.js","assets/ElevationSamplerData-e3118b17.js","assets/objectResourceUtils-782953c3.js","assets/devEnvironmentUtils-5002a058.js","assets/BufferView-379a78a4.js","assets/vec33-69c9e93b.js","assets/DefaultMaterial_COLOR_GAMMA-6ed76d86.js","assets/types-e1c0a5bf.js","assets/enums-e2e92c86.js","assets/Version-aa0a1d91.js","assets/quat-7b70e9a8.js","assets/resourceUtils-527631ac.js","assets/basicInterfaces-7449a8bf.js","assets/Indices-d8bff7b2.js","assets/NestedMap-1b5db22e.js","assets/requestImageUtils-d1ba3b36.js","assets/symbolColorUtils-c9d24716.js","assets/VertexAttribute-15d1866a.js","assets/doublePrecisionUtils-e3c3d0d8.js","assets/OrderIndependentTransparency-5f7257d7.js","assets/Texture-563cf5e5.js","assets/FramebufferObject-8b18fc0c.js","assets/VertexElementDescriptor-2925c6af.js","assets/InterleavedLayout-d57c91d0.js","assets/vec3f32-01c06d8d.js","assets/Octree-499541ed.js","assets/edgeProcessing-20e12367.js","assets/deduplicate-769a6f51.js","assets/MeshComponent-788e605a.js","assets/earcut-61f7b102.js","assets/imageUtils-c2d0d1ae.js","assets/projection-5969b753.js","assets/ZoomMomentumEstimator-ef57e6a4.js","assets/floatRGBA-ca2b39ca.js","assets/dehydratedFeatures-3a140d03.js","assets/quantizationUtils-b3b2ae2a.js","assets/labelFormatUtils-71e1f841.js","assets/orientedBoundingBox-a14b97b5.js","assets/quatf32-51a323b8.js","assets/SnappingCandidate-970faec6.js","assets/callExpressionWithFeature-df1a8f01.js","assets/DefaultVertexAttributeLayouts-5f20d8dd.js","assets/geometryServiceUtils-a536bb19.js","assets/project-909a4219.js","assets/LercDecoder-65586d50.js","assets/VectorTile-d41a1f0f.js","assets/enums-fb086c25.js","assets/config-1337d16e.js","assets/TiledDisplayObject-419c008b.js","assets/DisplayObject-87c37b69.js","assets/rasterUtils-7694cc98.js","assets/resources-7587d8f4.js","assets/workerHelper-6131d203.js","assets/webgl-debug-7f880832.js","assets/RenderingContext-0f21aa0e.js","assets/ProgramCache-f29c900e.js","assets/Program-77209250.js","assets/MediaLayer-4c42fc2f.js","assets/MediaElementView-06baa4d4.js","assets/normalizeUtilsSync-3ea564a9.js","assets/resourceExtension-f31d9f10.js","assets/BoundsStore-00da37da.js","assets/PooledRBush-5a11bc7e.js","assets/prism-line-numbers-eff41b13.js","assets/label2-a2f37e65.js","assets/interactive-1de2e238.js","assets/loadable-6afd516d.js","assets/t9n-81df3a71.js","assets/observers-c89705b8.js","assets/icon-8e47fbec.js","assets/loader-c773e800.js","assets/guid-51402ee7.js","assets/prism-line-numbers-7c5d72ff.css"]),R2={"base-dynamic":()=>_e(()=>import("./BaseDynamicLayerView3D-95e569a2.js"),["assets/BaseDynamicLayerView3D-95e569a2.js","assets/calcite-8912bd40.js","assets/index-00759e4a.js","assets/index-5026a37a.css","assets/calcite-96fa36fd.css","assets/DynamicLayerView3D-7a33cc06.js","assets/LayerView3D-4128a20f.js","assets/symbolColorUtils-c9d24716.js","assets/MeshComponent-788e605a.js","assets/earcut-61f7b102.js","assets/deduplicate-769a6f51.js","assets/Indices-d8bff7b2.js","assets/imageUtils-c2d0d1ae.js","assets/objectResourceUtils-782953c3.js","assets/devEnvironmentUtils-5002a058.js","assets/mat3f64-50f3b9f6.js","assets/mat4f64-abdda1bb.js","assets/BufferView-379a78a4.js","assets/vec33-69c9e93b.js","assets/DefaultMaterial_COLOR_GAMMA-6ed76d86.js","assets/types-e1c0a5bf.js","assets/enums-e2e92c86.js","assets/Version-aa0a1d91.js","assets/quat-7b70e9a8.js","assets/quatf64-f8f1c132.js","assets/resourceUtils-527631ac.js","assets/basicInterfaces-7449a8bf.js","assets/NestedMap-1b5db22e.js","assets/requestImageUtils-d1ba3b36.js","assets/Util-6d3f024a.js","assets/sphere-d0e5285d.js","assets/VertexAttribute-15d1866a.js","assets/doublePrecisionUtils-e3c3d0d8.js","assets/OrderIndependentTransparency-5f7257d7.js","assets/Texture-563cf5e5.js","assets/FramebufferObject-8b18fc0c.js","assets/VertexElementDescriptor-2925c6af.js","assets/InterleavedLayout-d57c91d0.js","assets/vec3f32-01c06d8d.js","assets/projectExtentUtils-e8c7cde0.js","assets/geometryServiceUtils-a536bb19.js","assets/project-909a4219.js","assets/ImageMaterial-e77d3ec9.js","assets/LayerView-abbb3570.js","assets/RefreshableLayerView-e4d9e9c9.js","assets/plane-5e2b046c.js","assets/spatialReferenceEllipsoidUtils-afb35af9.js","assets/scaleUtils-d13015f2.js","assets/ElevationSamplerData-e3118b17.js","assets/Octree-499541ed.js","assets/edgeProcessing-20e12367.js","assets/projection-5969b753.js","assets/ZoomMomentumEstimator-ef57e6a4.js","assets/floatRGBA-ca2b39ca.js","assets/dehydratedFeatures-3a140d03.js","assets/quantizationUtils-b3b2ae2a.js","assets/labelFormatUtils-71e1f841.js","assets/orientedBoundingBox-a14b97b5.js","assets/quatf32-51a323b8.js","assets/SnappingCandidate-970faec6.js","assets/callExpressionWithFeature-df1a8f01.js","assets/DefaultVertexAttributeLayouts-5f20d8dd.js","assets/LercDecoder-65586d50.js","assets/VectorTile-d41a1f0f.js","assets/enums-fb086c25.js","assets/config-1337d16e.js","assets/TiledDisplayObject-419c008b.js","assets/DisplayObject-87c37b69.js","assets/rasterUtils-7694cc98.js","assets/resources-7587d8f4.js","assets/workerHelper-6131d203.js","assets/webgl-debug-7f880832.js","assets/RenderingContext-0f21aa0e.js","assets/ProgramCache-f29c900e.js","assets/Program-77209250.js","assets/MediaLayer-4c42fc2f.js","assets/MediaElementView-06baa4d4.js","assets/normalizeUtilsSync-3ea564a9.js","assets/resourceExtension-f31d9f10.js","assets/BoundsStore-00da37da.js","assets/PooledRBush-5a11bc7e.js","assets/prism-line-numbers-eff41b13.js","assets/label2-a2f37e65.js","assets/interactive-1de2e238.js","assets/loadable-6afd516d.js","assets/t9n-81df3a71.js","assets/observers-c89705b8.js","assets/icon-8e47fbec.js","assets/loader-c773e800.js","assets/guid-51402ee7.js","assets/prism-line-numbers-7c5d72ff.css"]),"base-elevation":O2,"base-tile":ym,"bing-maps":ym,"building-scene":()=>_e(()=>import("./BuildingSceneLayerView3D-05e46944.js"),["assets/BuildingSceneLayerView3D-05e46944.js","assets/calcite-8912bd40.js","assets/index-00759e4a.js","assets/index-5026a37a.css","assets/calcite-96fa36fd.css","assets/BuildingGroupSublayer-6e1d5e03.js","assets/BuildingComponentSublayer-47c7091c.js","assets/capabilities-a18453f6.js","assets/I3SIndexInfo-eecf1e00.js","assets/I3SLayerDefinitions-edc5d4c2.js","assets/I3SUtil-930fc7a4.js","assets/mat3f64-50f3b9f6.js","assets/mat4f64-abdda1bb.js","assets/quat-7b70e9a8.js","assets/quatf64-f8f1c132.js","assets/quatf32-51a323b8.js","assets/spatialReferenceEllipsoidUtils-afb35af9.js","assets/I3SBinaryReader-533328a5.js","assets/VertexAttribute-15d1866a.js","assets/orientedBoundingBox-a14b97b5.js","assets/vec3f32-01c06d8d.js","assets/plane-5e2b046c.js","assets/sphere-d0e5285d.js","assets/symbolColorUtils-c9d24716.js","assets/popupUtils-54bd9deb.js","assets/WhereClause-8339ee75.js","assets/executionError-fb3f283a.js","assets/I3SMeshView3D-e9677f38.js","assets/I3SOverrides-37467bf0.js","assets/dehydratedFeatures-3a140d03.js","assets/quantizationUtils-b3b2ae2a.js","assets/I3SNode-fcca117e.js","assets/RenderTexture-6105e069.js","assets/objectResourceUtils-782953c3.js","assets/devEnvironmentUtils-5002a058.js","assets/BufferView-379a78a4.js","assets/vec33-69c9e93b.js","assets/DefaultMaterial_COLOR_GAMMA-6ed76d86.js","assets/types-e1c0a5bf.js","assets/enums-e2e92c86.js","assets/Version-aa0a1d91.js","assets/resourceUtils-527631ac.js","assets/basicInterfaces-7449a8bf.js","assets/Indices-d8bff7b2.js","assets/NestedMap-1b5db22e.js","assets/requestImageUtils-d1ba3b36.js","assets/Util-6d3f024a.js","assets/doublePrecisionUtils-e3c3d0d8.js","assets/OrderIndependentTransparency-5f7257d7.js","assets/Texture-563cf5e5.js","assets/FramebufferObject-8b18fc0c.js","assets/VertexElementDescriptor-2925c6af.js","assets/InterleavedLayout-d57c91d0.js","assets/Octree-499541ed.js","assets/featureQueryAll-47bc4c6c.js","assets/FeatureLayerView3D-1358730d.js","assets/FeatureLayerViewBase3D-6a29452c.js","assets/FeatureLikeLayerView3D-55d9655f.js","assets/geometryServiceUtils-a536bb19.js","assets/project-909a4219.js","assets/dehydratedFeatureComparison-409d2bff.js","assets/queryForSymbologySnapping-f85651d3.js","assets/elevationInfoUtils-551ce894.js","assets/hash-0ddfbf4b.js","assets/Graphics3DObjectStates-8688d43e.js","assets/optimizedFeatureQueryEngineAdapter-b6d8def7.js","assets/centroid-bf48eee6.js","assets/PooledRBush-5a11bc7e.js","assets/floorFilterUtils-080a7cd2.js","assets/QueryEngine-dd47d379.js","assets/QueryEngineResult-dfcfeac3.js","assets/utils-e5a50699.js","assets/generateRendererUtils-5b0c1ef7.js","assets/projectionSupport-d23d7a2d.js","assets/json-48e3ea08.js","assets/SnappingCandidate-970faec6.js","assets/utils-046b23b4.js","assets/QueryEngineCapabilities-42e44ded.js","assets/timeSupport-a3b9e468.js","assets/scaleUtils-d13015f2.js","assets/FeatureStore-b2e1c75d.js","assets/BoundsStore-00da37da.js","assets/heatmapTextureUtils-56fc7bff.js","assets/projectExtentUtils-e8c7cde0.js","assets/LayerView3D-4128a20f.js","assets/LercDecoder-65586d50.js","assets/EventedSet-7ad75bee.js","assets/FeatureLayerView-36f7cadb.js","assets/LayerView-abbb3570.js","assets/RefreshableLayerView-e4d9e9c9.js","assets/ElevationSamplerData-e3118b17.js","assets/edgeProcessing-20e12367.js","assets/deduplicate-769a6f51.js","assets/MeshComponent-788e605a.js","assets/earcut-61f7b102.js","assets/imageUtils-c2d0d1ae.js","assets/projection-5969b753.js","assets/ZoomMomentumEstimator-ef57e6a4.js","assets/floatRGBA-ca2b39ca.js","assets/labelFormatUtils-71e1f841.js","assets/callExpressionWithFeature-df1a8f01.js","assets/DefaultVertexAttributeLayouts-5f20d8dd.js","assets/VectorTile-d41a1f0f.js","assets/enums-fb086c25.js","assets/config-1337d16e.js","assets/TiledDisplayObject-419c008b.js","assets/DisplayObject-87c37b69.js","assets/rasterUtils-7694cc98.js","assets/resources-7587d8f4.js","assets/workerHelper-6131d203.js","assets/webgl-debug-7f880832.js","assets/RenderingContext-0f21aa0e.js","assets/ProgramCache-f29c900e.js","assets/Program-77209250.js","assets/MediaLayer-4c42fc2f.js","assets/MediaElementView-06baa4d4.js","assets/normalizeUtilsSync-3ea564a9.js","assets/resourceExtension-f31d9f10.js","assets/prism-line-numbers-eff41b13.js","assets/label2-a2f37e65.js","assets/interactive-1de2e238.js","assets/loadable-6afd516d.js","assets/t9n-81df3a71.js","assets/observers-c89705b8.js","assets/icon-8e47fbec.js","assets/loader-c773e800.js","assets/guid-51402ee7.js","assets/prism-line-numbers-7c5d72ff.css","assets/SceneModification-5174816b.js","assets/persistable-cb99c020.js","assets/multiOriginJSONSupportUtils-c978f4c3.js","assets/SceneLayerWorker-acafa874.js","assets/I3SQueryFeatureStore-e5073b38.js","assets/DefinitionExpressionSceneLayerView-3bb456ca.js"]),csv:()=>_e(()=>import("./CSVLayerView3D-d8839d8e.js"),["assets/CSVLayerView3D-d8839d8e.js","assets/calcite-8912bd40.js","assets/index-00759e4a.js","assets/index-5026a37a.css","assets/calcite-96fa36fd.css","assets/FeatureLayerViewBase3D-6a29452c.js","assets/FeatureLikeLayerView3D-55d9655f.js","assets/geometryServiceUtils-a536bb19.js","assets/project-909a4219.js","assets/dehydratedFeatures-3a140d03.js","assets/quantizationUtils-b3b2ae2a.js","assets/dehydratedFeatureComparison-409d2bff.js","assets/queryForSymbologySnapping-f85651d3.js","assets/elevationInfoUtils-551ce894.js","assets/hash-0ddfbf4b.js","assets/Graphics3DObjectStates-8688d43e.js","assets/optimizedFeatureQueryEngineAdapter-b6d8def7.js","assets/centroid-bf48eee6.js","assets/PooledRBush-5a11bc7e.js","assets/basicInterfaces-7449a8bf.js","assets/floorFilterUtils-080a7cd2.js","assets/QueryEngine-dd47d379.js","assets/QueryEngineResult-dfcfeac3.js","assets/WhereClause-8339ee75.js","assets/executionError-fb3f283a.js","assets/utils-e5a50699.js","assets/generateRendererUtils-5b0c1ef7.js","assets/projectionSupport-d23d7a2d.js","assets/json-48e3ea08.js","assets/SnappingCandidate-970faec6.js","assets/utils-046b23b4.js","assets/QueryEngineCapabilities-42e44ded.js","assets/timeSupport-a3b9e468.js","assets/scaleUtils-d13015f2.js","assets/FeatureStore-b2e1c75d.js","assets/BoundsStore-00da37da.js","assets/symbolColorUtils-c9d24716.js","assets/objectResourceUtils-782953c3.js","assets/devEnvironmentUtils-5002a058.js","assets/mat3f64-50f3b9f6.js","assets/mat4f64-abdda1bb.js","assets/BufferView-379a78a4.js","assets/vec33-69c9e93b.js","assets/DefaultMaterial_COLOR_GAMMA-6ed76d86.js","assets/types-e1c0a5bf.js","assets/enums-e2e92c86.js","assets/Version-aa0a1d91.js","assets/quat-7b70e9a8.js","assets/quatf64-f8f1c132.js","assets/resourceUtils-527631ac.js","assets/Indices-d8bff7b2.js","assets/NestedMap-1b5db22e.js","assets/requestImageUtils-d1ba3b36.js","assets/Util-6d3f024a.js","assets/sphere-d0e5285d.js","assets/VertexAttribute-15d1866a.js","assets/doublePrecisionUtils-e3c3d0d8.js","assets/OrderIndependentTransparency-5f7257d7.js","assets/Texture-563cf5e5.js","assets/FramebufferObject-8b18fc0c.js","assets/VertexElementDescriptor-2925c6af.js","assets/InterleavedLayout-d57c91d0.js","assets/vec3f32-01c06d8d.js","assets/heatmapTextureUtils-56fc7bff.js","assets/projectExtentUtils-e8c7cde0.js","assets/LayerView3D-4128a20f.js","assets/LercDecoder-65586d50.js","assets/EventedSet-7ad75bee.js","assets/FeatureLayerView-36f7cadb.js","assets/popupUtils-54bd9deb.js","assets/LayerView-abbb3570.js","assets/RefreshableLayerView-e4d9e9c9.js","assets/plane-5e2b046c.js","assets/spatialReferenceEllipsoidUtils-afb35af9.js","assets/ElevationSamplerData-e3118b17.js","assets/Octree-499541ed.js","assets/edgeProcessing-20e12367.js","assets/deduplicate-769a6f51.js","assets/MeshComponent-788e605a.js","assets/earcut-61f7b102.js","assets/imageUtils-c2d0d1ae.js","assets/projection-5969b753.js","assets/ZoomMomentumEstimator-ef57e6a4.js","assets/floatRGBA-ca2b39ca.js","assets/labelFormatUtils-71e1f841.js","assets/orientedBoundingBox-a14b97b5.js","assets/quatf32-51a323b8.js","assets/callExpressionWithFeature-df1a8f01.js","assets/DefaultVertexAttributeLayouts-5f20d8dd.js","assets/VectorTile-d41a1f0f.js","assets/enums-fb086c25.js","assets/config-1337d16e.js","assets/TiledDisplayObject-419c008b.js","assets/DisplayObject-87c37b69.js","assets/rasterUtils-7694cc98.js","assets/resources-7587d8f4.js","assets/workerHelper-6131d203.js","assets/webgl-debug-7f880832.js","assets/RenderingContext-0f21aa0e.js","assets/ProgramCache-f29c900e.js","assets/Program-77209250.js","assets/MediaLayer-4c42fc2f.js","assets/MediaElementView-06baa4d4.js","assets/normalizeUtilsSync-3ea564a9.js","assets/resourceExtension-f31d9f10.js","assets/prism-line-numbers-eff41b13.js","assets/label2-a2f37e65.js","assets/interactive-1de2e238.js","assets/loadable-6afd516d.js","assets/t9n-81df3a71.js","assets/observers-c89705b8.js","assets/icon-8e47fbec.js","assets/loader-c773e800.js","assets/guid-51402ee7.js","assets/prism-line-numbers-7c5d72ff.css"]),dimension:()=>_e(()=>import("./DimensionLayerView3D-fd4e4000.js"),["assets/DimensionLayerView3D-fd4e4000.js","assets/index-00759e4a.js","assets/index-5026a37a.css","assets/calcite-8912bd40.js","assets/calcite-96fa36fd.css","assets/LayerView3D-4128a20f.js","assets/LayerView-abbb3570.js"]),elevation:O2,feature:()=>_e(()=>import("./FeatureLayerView3D-1358730d.js"),["assets/FeatureLayerView3D-1358730d.js","assets/calcite-8912bd40.js","assets/index-00759e4a.js","assets/index-5026a37a.css","assets/calcite-96fa36fd.css","assets/FeatureLayerViewBase3D-6a29452c.js","assets/FeatureLikeLayerView3D-55d9655f.js","assets/geometryServiceUtils-a536bb19.js","assets/project-909a4219.js","assets/dehydratedFeatures-3a140d03.js","assets/quantizationUtils-b3b2ae2a.js","assets/dehydratedFeatureComparison-409d2bff.js","assets/queryForSymbologySnapping-f85651d3.js","assets/elevationInfoUtils-551ce894.js","assets/hash-0ddfbf4b.js","assets/Graphics3DObjectStates-8688d43e.js","assets/optimizedFeatureQueryEngineAdapter-b6d8def7.js","assets/centroid-bf48eee6.js","assets/PooledRBush-5a11bc7e.js","assets/basicInterfaces-7449a8bf.js","assets/floorFilterUtils-080a7cd2.js","assets/QueryEngine-dd47d379.js","assets/QueryEngineResult-dfcfeac3.js","assets/WhereClause-8339ee75.js","assets/executionError-fb3f283a.js","assets/utils-e5a50699.js","assets/generateRendererUtils-5b0c1ef7.js","assets/projectionSupport-d23d7a2d.js","assets/json-48e3ea08.js","assets/SnappingCandidate-970faec6.js","assets/utils-046b23b4.js","assets/QueryEngineCapabilities-42e44ded.js","assets/timeSupport-a3b9e468.js","assets/scaleUtils-d13015f2.js","assets/FeatureStore-b2e1c75d.js","assets/BoundsStore-00da37da.js","assets/symbolColorUtils-c9d24716.js","assets/objectResourceUtils-782953c3.js","assets/devEnvironmentUtils-5002a058.js","assets/mat3f64-50f3b9f6.js","assets/mat4f64-abdda1bb.js","assets/BufferView-379a78a4.js","assets/vec33-69c9e93b.js","assets/DefaultMaterial_COLOR_GAMMA-6ed76d86.js","assets/types-e1c0a5bf.js","assets/enums-e2e92c86.js","assets/Version-aa0a1d91.js","assets/quat-7b70e9a8.js","assets/quatf64-f8f1c132.js","assets/resourceUtils-527631ac.js","assets/Indices-d8bff7b2.js","assets/NestedMap-1b5db22e.js","assets/requestImageUtils-d1ba3b36.js","assets/Util-6d3f024a.js","assets/sphere-d0e5285d.js","assets/VertexAttribute-15d1866a.js","assets/doublePrecisionUtils-e3c3d0d8.js","assets/OrderIndependentTransparency-5f7257d7.js","assets/Texture-563cf5e5.js","assets/FramebufferObject-8b18fc0c.js","assets/VertexElementDescriptor-2925c6af.js","assets/InterleavedLayout-d57c91d0.js","assets/vec3f32-01c06d8d.js","assets/heatmapTextureUtils-56fc7bff.js","assets/projectExtentUtils-e8c7cde0.js","assets/LayerView3D-4128a20f.js","assets/LercDecoder-65586d50.js","assets/EventedSet-7ad75bee.js","assets/FeatureLayerView-36f7cadb.js","assets/popupUtils-54bd9deb.js","assets/LayerView-abbb3570.js","assets/RefreshableLayerView-e4d9e9c9.js","assets/plane-5e2b046c.js","assets/spatialReferenceEllipsoidUtils-afb35af9.js","assets/ElevationSamplerData-e3118b17.js","assets/Octree-499541ed.js","assets/edgeProcessing-20e12367.js","assets/deduplicate-769a6f51.js","assets/MeshComponent-788e605a.js","assets/earcut-61f7b102.js","assets/imageUtils-c2d0d1ae.js","assets/projection-5969b753.js","assets/ZoomMomentumEstimator-ef57e6a4.js","assets/floatRGBA-ca2b39ca.js","assets/labelFormatUtils-71e1f841.js","assets/orientedBoundingBox-a14b97b5.js","assets/quatf32-51a323b8.js","assets/callExpressionWithFeature-df1a8f01.js","assets/DefaultVertexAttributeLayouts-5f20d8dd.js","assets/VectorTile-d41a1f0f.js","assets/enums-fb086c25.js","assets/config-1337d16e.js","assets/TiledDisplayObject-419c008b.js","assets/DisplayObject-87c37b69.js","assets/rasterUtils-7694cc98.js","assets/resources-7587d8f4.js","assets/workerHelper-6131d203.js","assets/webgl-debug-7f880832.js","assets/RenderingContext-0f21aa0e.js","assets/ProgramCache-f29c900e.js","assets/Program-77209250.js","assets/MediaLayer-4c42fc2f.js","assets/MediaElementView-06baa4d4.js","assets/normalizeUtilsSync-3ea564a9.js","assets/resourceExtension-f31d9f10.js","assets/prism-line-numbers-eff41b13.js","assets/label2-a2f37e65.js","assets/interactive-1de2e238.js","assets/loadable-6afd516d.js","assets/t9n-81df3a71.js","assets/observers-c89705b8.js","assets/icon-8e47fbec.js","assets/loader-c773e800.js","assets/guid-51402ee7.js","assets/prism-line-numbers-7c5d72ff.css"]),geojson:()=>_e(()=>import("./GeoJSONLayerView3D-f50290da.js"),["assets/GeoJSONLayerView3D-f50290da.js","assets/calcite-8912bd40.js","assets/index-00759e4a.js","assets/index-5026a37a.css","assets/calcite-96fa36fd.css","assets/FeatureLayerViewBase3D-6a29452c.js","assets/FeatureLikeLayerView3D-55d9655f.js","assets/geometryServiceUtils-a536bb19.js","assets/project-909a4219.js","assets/dehydratedFeatures-3a140d03.js","assets/quantizationUtils-b3b2ae2a.js","assets/dehydratedFeatureComparison-409d2bff.js","assets/queryForSymbologySnapping-f85651d3.js","assets/elevationInfoUtils-551ce894.js","assets/hash-0ddfbf4b.js","assets/Graphics3DObjectStates-8688d43e.js","assets/optimizedFeatureQueryEngineAdapter-b6d8def7.js","assets/centroid-bf48eee6.js","assets/PooledRBush-5a11bc7e.js","assets/basicInterfaces-7449a8bf.js","assets/floorFilterUtils-080a7cd2.js","assets/QueryEngine-dd47d379.js","assets/QueryEngineResult-dfcfeac3.js","assets/WhereClause-8339ee75.js","assets/executionError-fb3f283a.js","assets/utils-e5a50699.js","assets/generateRendererUtils-5b0c1ef7.js","assets/projectionSupport-d23d7a2d.js","assets/json-48e3ea08.js","assets/SnappingCandidate-970faec6.js","assets/utils-046b23b4.js","assets/QueryEngineCapabilities-42e44ded.js","assets/timeSupport-a3b9e468.js","assets/scaleUtils-d13015f2.js","assets/FeatureStore-b2e1c75d.js","assets/BoundsStore-00da37da.js","assets/symbolColorUtils-c9d24716.js","assets/objectResourceUtils-782953c3.js","assets/devEnvironmentUtils-5002a058.js","assets/mat3f64-50f3b9f6.js","assets/mat4f64-abdda1bb.js","assets/BufferView-379a78a4.js","assets/vec33-69c9e93b.js","assets/DefaultMaterial_COLOR_GAMMA-6ed76d86.js","assets/types-e1c0a5bf.js","assets/enums-e2e92c86.js","assets/Version-aa0a1d91.js","assets/quat-7b70e9a8.js","assets/quatf64-f8f1c132.js","assets/resourceUtils-527631ac.js","assets/Indices-d8bff7b2.js","assets/NestedMap-1b5db22e.js","assets/requestImageUtils-d1ba3b36.js","assets/Util-6d3f024a.js","assets/sphere-d0e5285d.js","assets/VertexAttribute-15d1866a.js","assets/doublePrecisionUtils-e3c3d0d8.js","assets/OrderIndependentTransparency-5f7257d7.js","assets/Texture-563cf5e5.js","assets/FramebufferObject-8b18fc0c.js","assets/VertexElementDescriptor-2925c6af.js","assets/InterleavedLayout-d57c91d0.js","assets/vec3f32-01c06d8d.js","assets/heatmapTextureUtils-56fc7bff.js","assets/projectExtentUtils-e8c7cde0.js","assets/LayerView3D-4128a20f.js","assets/LercDecoder-65586d50.js","assets/EventedSet-7ad75bee.js","assets/FeatureLayerView-36f7cadb.js","assets/popupUtils-54bd9deb.js","assets/LayerView-abbb3570.js","assets/RefreshableLayerView-e4d9e9c9.js","assets/plane-5e2b046c.js","assets/spatialReferenceEllipsoidUtils-afb35af9.js","assets/ElevationSamplerData-e3118b17.js","assets/Octree-499541ed.js","assets/edgeProcessing-20e12367.js","assets/deduplicate-769a6f51.js","assets/MeshComponent-788e605a.js","assets/earcut-61f7b102.js","assets/imageUtils-c2d0d1ae.js","assets/projection-5969b753.js","assets/ZoomMomentumEstimator-ef57e6a4.js","assets/floatRGBA-ca2b39ca.js","assets/labelFormatUtils-71e1f841.js","assets/orientedBoundingBox-a14b97b5.js","assets/quatf32-51a323b8.js","assets/callExpressionWithFeature-df1a8f01.js","assets/DefaultVertexAttributeLayouts-5f20d8dd.js","assets/VectorTile-d41a1f0f.js","assets/enums-fb086c25.js","assets/config-1337d16e.js","assets/TiledDisplayObject-419c008b.js","assets/DisplayObject-87c37b69.js","assets/rasterUtils-7694cc98.js","assets/resources-7587d8f4.js","assets/workerHelper-6131d203.js","assets/webgl-debug-7f880832.js","assets/RenderingContext-0f21aa0e.js","assets/ProgramCache-f29c900e.js","assets/Program-77209250.js","assets/MediaLayer-4c42fc2f.js","assets/MediaElementView-06baa4d4.js","assets/normalizeUtilsSync-3ea564a9.js","assets/resourceExtension-f31d9f10.js","assets/prism-line-numbers-eff41b13.js","assets/label2-a2f37e65.js","assets/interactive-1de2e238.js","assets/loadable-6afd516d.js","assets/t9n-81df3a71.js","assets/observers-c89705b8.js","assets/icon-8e47fbec.js","assets/loader-c773e800.js","assets/guid-51402ee7.js","assets/prism-line-numbers-7c5d72ff.css"]),graphics:()=>_e(()=>import("./GraphicsLayerView3D-7fc161e1.js"),["assets/GraphicsLayerView3D-7fc161e1.js","assets/calcite-8912bd40.js","assets/index-00759e4a.js","assets/index-5026a37a.css","assets/calcite-96fa36fd.css","assets/LayerView3D-4128a20f.js","assets/queryForSymbologySnapping-f85651d3.js","assets/dehydratedFeatures-3a140d03.js","assets/quantizationUtils-b3b2ae2a.js","assets/elevationInfoUtils-551ce894.js","assets/GraphicsProcessor-d49a2131.js","assets/Graphics3DObjectStates-8688d43e.js","assets/optimizedFeatureQueryEngineAdapter-b6d8def7.js","assets/centroid-bf48eee6.js","assets/PooledRBush-5a11bc7e.js","assets/basicInterfaces-7449a8bf.js","assets/projectExtentUtils-e8c7cde0.js","assets/geometryServiceUtils-a536bb19.js","assets/project-909a4219.js","assets/LayerView-abbb3570.js","assets/sphere-d0e5285d.js","assets/mat3f64-50f3b9f6.js","assets/mat4f64-abdda1bb.js","assets/quatf64-f8f1c132.js","assets/Util-6d3f024a.js","assets/plane-5e2b046c.js","assets/spatialReferenceEllipsoidUtils-afb35af9.js","assets/scaleUtils-d13015f2.js","assets/ElevationSamplerData-e3118b17.js","assets/objectResourceUtils-782953c3.js","assets/devEnvironmentUtils-5002a058.js","assets/BufferView-379a78a4.js","assets/vec33-69c9e93b.js","assets/DefaultMaterial_COLOR_GAMMA-6ed76d86.js","assets/types-e1c0a5bf.js","assets/enums-e2e92c86.js","assets/Version-aa0a1d91.js","assets/quat-7b70e9a8.js","assets/resourceUtils-527631ac.js","assets/Indices-d8bff7b2.js","assets/NestedMap-1b5db22e.js","assets/requestImageUtils-d1ba3b36.js","assets/symbolColorUtils-c9d24716.js","assets/VertexAttribute-15d1866a.js","assets/doublePrecisionUtils-e3c3d0d8.js","assets/OrderIndependentTransparency-5f7257d7.js","assets/Texture-563cf5e5.js","assets/FramebufferObject-8b18fc0c.js","assets/VertexElementDescriptor-2925c6af.js","assets/InterleavedLayout-d57c91d0.js","assets/vec3f32-01c06d8d.js","assets/Octree-499541ed.js","assets/edgeProcessing-20e12367.js","assets/deduplicate-769a6f51.js","assets/MeshComponent-788e605a.js","assets/earcut-61f7b102.js","assets/imageUtils-c2d0d1ae.js","assets/projection-5969b753.js","assets/ZoomMomentumEstimator-ef57e6a4.js","assets/floatRGBA-ca2b39ca.js","assets/labelFormatUtils-71e1f841.js","assets/orientedBoundingBox-a14b97b5.js","assets/quatf32-51a323b8.js","assets/SnappingCandidate-970faec6.js","assets/callExpressionWithFeature-df1a8f01.js","assets/DefaultVertexAttributeLayouts-5f20d8dd.js","assets/LercDecoder-65586d50.js","assets/VectorTile-d41a1f0f.js","assets/enums-fb086c25.js","assets/config-1337d16e.js","assets/TiledDisplayObject-419c008b.js","assets/DisplayObject-87c37b69.js","assets/rasterUtils-7694cc98.js","assets/resources-7587d8f4.js","assets/workerHelper-6131d203.js","assets/webgl-debug-7f880832.js","assets/RenderingContext-0f21aa0e.js","assets/ProgramCache-f29c900e.js","assets/Program-77209250.js","assets/MediaLayer-4c42fc2f.js","assets/MediaElementView-06baa4d4.js","assets/normalizeUtilsSync-3ea564a9.js","assets/resourceExtension-f31d9f10.js","assets/BoundsStore-00da37da.js","assets/prism-line-numbers-eff41b13.js","assets/label2-a2f37e65.js","assets/interactive-1de2e238.js","assets/loadable-6afd516d.js","assets/t9n-81df3a71.js","assets/observers-c89705b8.js","assets/icon-8e47fbec.js","assets/loader-c773e800.js","assets/guid-51402ee7.js","assets/prism-line-numbers-7c5d72ff.css"]),group:()=>_e(()=>import("./GroupLayerView-3a4ee2ca.js"),["assets/GroupLayerView-3a4ee2ca.js","assets/calcite-8912bd40.js","assets/index-00759e4a.js","assets/index-5026a37a.css","assets/calcite-96fa36fd.css","assets/LayerView-abbb3570.js"]),imagery:()=>_e(()=>import("./ImageryLayerView3D-1356a558.js"),["assets/ImageryLayerView3D-1356a558.js","assets/calcite-8912bd40.js","assets/index-00759e4a.js","assets/index-5026a37a.css","assets/calcite-96fa36fd.css","assets/DynamicLayerView3D-7a33cc06.js","assets/LayerView3D-4128a20f.js","assets/symbolColorUtils-c9d24716.js","assets/MeshComponent-788e605a.js","assets/earcut-61f7b102.js","assets/deduplicate-769a6f51.js","assets/Indices-d8bff7b2.js","assets/imageUtils-c2d0d1ae.js","assets/objectResourceUtils-782953c3.js","assets/devEnvironmentUtils-5002a058.js","assets/mat3f64-50f3b9f6.js","assets/mat4f64-abdda1bb.js","assets/BufferView-379a78a4.js","assets/vec33-69c9e93b.js","assets/DefaultMaterial_COLOR_GAMMA-6ed76d86.js","assets/types-e1c0a5bf.js","assets/enums-e2e92c86.js","assets/Version-aa0a1d91.js","assets/quat-7b70e9a8.js","assets/quatf64-f8f1c132.js","assets/resourceUtils-527631ac.js","assets/basicInterfaces-7449a8bf.js","assets/NestedMap-1b5db22e.js","assets/requestImageUtils-d1ba3b36.js","assets/Util-6d3f024a.js","assets/sphere-d0e5285d.js","assets/VertexAttribute-15d1866a.js","assets/doublePrecisionUtils-e3c3d0d8.js","assets/OrderIndependentTransparency-5f7257d7.js","assets/Texture-563cf5e5.js","assets/FramebufferObject-8b18fc0c.js","assets/VertexElementDescriptor-2925c6af.js","assets/InterleavedLayout-d57c91d0.js","assets/vec3f32-01c06d8d.js","assets/projectExtentUtils-e8c7cde0.js","assets/geometryServiceUtils-a536bb19.js","assets/project-909a4219.js","assets/ImageMaterial-e77d3ec9.js","assets/LayerView-abbb3570.js","assets/RefreshableLayerView-e4d9e9c9.js","assets/ImageryLayerView-96ac5e24.js","assets/popupUtils-54bd9deb.js","assets/plane-5e2b046c.js","assets/spatialReferenceEllipsoidUtils-afb35af9.js","assets/scaleUtils-d13015f2.js","assets/ElevationSamplerData-e3118b17.js","assets/Octree-499541ed.js","assets/edgeProcessing-20e12367.js","assets/projection-5969b753.js","assets/ZoomMomentumEstimator-ef57e6a4.js","assets/floatRGBA-ca2b39ca.js","assets/dehydratedFeatures-3a140d03.js","assets/quantizationUtils-b3b2ae2a.js","assets/labelFormatUtils-71e1f841.js","assets/orientedBoundingBox-a14b97b5.js","assets/quatf32-51a323b8.js","assets/SnappingCandidate-970faec6.js","assets/callExpressionWithFeature-df1a8f01.js","assets/DefaultVertexAttributeLayouts-5f20d8dd.js","assets/LercDecoder-65586d50.js","assets/VectorTile-d41a1f0f.js","assets/enums-fb086c25.js","assets/config-1337d16e.js","assets/TiledDisplayObject-419c008b.js","assets/DisplayObject-87c37b69.js","assets/rasterUtils-7694cc98.js","assets/resources-7587d8f4.js","assets/workerHelper-6131d203.js","assets/webgl-debug-7f880832.js","assets/RenderingContext-0f21aa0e.js","assets/ProgramCache-f29c900e.js","assets/Program-77209250.js","assets/MediaLayer-4c42fc2f.js","assets/MediaElementView-06baa4d4.js","assets/normalizeUtilsSync-3ea564a9.js","assets/resourceExtension-f31d9f10.js","assets/BoundsStore-00da37da.js","assets/PooledRBush-5a11bc7e.js","assets/prism-line-numbers-eff41b13.js","assets/label2-a2f37e65.js","assets/interactive-1de2e238.js","assets/loadable-6afd516d.js","assets/t9n-81df3a71.js","assets/observers-c89705b8.js","assets/icon-8e47fbec.js","assets/loader-c773e800.js","assets/guid-51402ee7.js","assets/prism-line-numbers-7c5d72ff.css"]),"integrated-mesh":()=>_e(()=>import("./IntegratedMeshLayerView3D-9a53ec29.js"),["assets/IntegratedMeshLayerView3D-9a53ec29.js","assets/calcite-8912bd40.js","assets/index-00759e4a.js","assets/index-5026a37a.css","assets/calcite-96fa36fd.css","assets/I3SMeshView3D-e9677f38.js","assets/mat4f64-abdda1bb.js","assets/quatf64-f8f1c132.js","assets/I3SOverrides-37467bf0.js","assets/dehydratedFeatures-3a140d03.js","assets/quantizationUtils-b3b2ae2a.js","assets/I3SNode-fcca117e.js","assets/sphere-d0e5285d.js","assets/mat3f64-50f3b9f6.js","assets/I3SUtil-930fc7a4.js","assets/quat-7b70e9a8.js","assets/quatf32-51a323b8.js","assets/spatialReferenceEllipsoidUtils-afb35af9.js","assets/I3SBinaryReader-533328a5.js","assets/VertexAttribute-15d1866a.js","assets/orientedBoundingBox-a14b97b5.js","assets/vec3f32-01c06d8d.js","assets/plane-5e2b046c.js","assets/symbolColorUtils-c9d24716.js","assets/RenderTexture-6105e069.js","assets/objectResourceUtils-782953c3.js","assets/devEnvironmentUtils-5002a058.js","assets/BufferView-379a78a4.js","assets/vec33-69c9e93b.js","assets/DefaultMaterial_COLOR_GAMMA-6ed76d86.js","assets/types-e1c0a5bf.js","assets/enums-e2e92c86.js","assets/Version-aa0a1d91.js","assets/resourceUtils-527631ac.js","assets/basicInterfaces-7449a8bf.js","assets/Indices-d8bff7b2.js","assets/NestedMap-1b5db22e.js","assets/requestImageUtils-d1ba3b36.js","assets/Util-6d3f024a.js","assets/doublePrecisionUtils-e3c3d0d8.js","assets/OrderIndependentTransparency-5f7257d7.js","assets/Texture-563cf5e5.js","assets/FramebufferObject-8b18fc0c.js","assets/VertexElementDescriptor-2925c6af.js","assets/InterleavedLayout-d57c91d0.js","assets/Octree-499541ed.js","assets/featureQueryAll-47bc4c6c.js","assets/FeatureLayerView3D-1358730d.js","assets/FeatureLayerViewBase3D-6a29452c.js","assets/FeatureLikeLayerView3D-55d9655f.js","assets/geometryServiceUtils-a536bb19.js","assets/project-909a4219.js","assets/dehydratedFeatureComparison-409d2bff.js","assets/queryForSymbologySnapping-f85651d3.js","assets/elevationInfoUtils-551ce894.js","assets/hash-0ddfbf4b.js","assets/Graphics3DObjectStates-8688d43e.js","assets/optimizedFeatureQueryEngineAdapter-b6d8def7.js","assets/centroid-bf48eee6.js","assets/PooledRBush-5a11bc7e.js","assets/floorFilterUtils-080a7cd2.js","assets/QueryEngine-dd47d379.js","assets/QueryEngineResult-dfcfeac3.js","assets/WhereClause-8339ee75.js","assets/executionError-fb3f283a.js","assets/utils-e5a50699.js","assets/generateRendererUtils-5b0c1ef7.js","assets/projectionSupport-d23d7a2d.js","assets/json-48e3ea08.js","assets/SnappingCandidate-970faec6.js","assets/utils-046b23b4.js","assets/QueryEngineCapabilities-42e44ded.js","assets/timeSupport-a3b9e468.js","assets/scaleUtils-d13015f2.js","assets/FeatureStore-b2e1c75d.js","assets/BoundsStore-00da37da.js","assets/heatmapTextureUtils-56fc7bff.js","assets/projectExtentUtils-e8c7cde0.js","assets/LayerView3D-4128a20f.js","assets/LercDecoder-65586d50.js","assets/EventedSet-7ad75bee.js","assets/FeatureLayerView-36f7cadb.js","assets/popupUtils-54bd9deb.js","assets/LayerView-abbb3570.js","assets/RefreshableLayerView-e4d9e9c9.js","assets/ElevationSamplerData-e3118b17.js","assets/edgeProcessing-20e12367.js","assets/deduplicate-769a6f51.js","assets/MeshComponent-788e605a.js","assets/earcut-61f7b102.js","assets/imageUtils-c2d0d1ae.js","assets/projection-5969b753.js","assets/ZoomMomentumEstimator-ef57e6a4.js","assets/floatRGBA-ca2b39ca.js","assets/labelFormatUtils-71e1f841.js","assets/callExpressionWithFeature-df1a8f01.js","assets/DefaultVertexAttributeLayouts-5f20d8dd.js","assets/VectorTile-d41a1f0f.js","assets/enums-fb086c25.js","assets/config-1337d16e.js","assets/TiledDisplayObject-419c008b.js","assets/DisplayObject-87c37b69.js","assets/rasterUtils-7694cc98.js","assets/resources-7587d8f4.js","assets/workerHelper-6131d203.js","assets/webgl-debug-7f880832.js","assets/RenderingContext-0f21aa0e.js","assets/ProgramCache-f29c900e.js","assets/Program-77209250.js","assets/MediaLayer-4c42fc2f.js","assets/MediaElementView-06baa4d4.js","assets/normalizeUtilsSync-3ea564a9.js","assets/resourceExtension-f31d9f10.js","assets/prism-line-numbers-eff41b13.js","assets/label2-a2f37e65.js","assets/interactive-1de2e238.js","assets/loadable-6afd516d.js","assets/t9n-81df3a71.js","assets/observers-c89705b8.js","assets/icon-8e47fbec.js","assets/loader-c773e800.js","assets/guid-51402ee7.js","assets/prism-line-numbers-7c5d72ff.css","assets/SceneModification-5174816b.js","assets/persistable-cb99c020.js","assets/multiOriginJSONSupportUtils-c978f4c3.js","assets/SceneLayerWorker-acafa874.js"]),"line-of-sight":()=>_e(()=>import("./LineOfSightLayerView3D-0ca3d773.js"),["assets/LineOfSightLayerView3D-0ca3d773.js","assets/index-00759e4a.js","assets/index-5026a37a.css","assets/calcite-8912bd40.js","assets/calcite-96fa36fd.css","assets/LayerView3D-4128a20f.js","assets/LayerView-abbb3570.js"]),"map-image":()=>_e(()=>import("./MapImageLayerView3D-2a9858ee.js"),["assets/MapImageLayerView3D-2a9858ee.js","assets/calcite-8912bd40.js","assets/index-00759e4a.js","assets/index-5026a37a.css","assets/calcite-96fa36fd.css","assets/DynamicLayerView3D-7a33cc06.js","assets/LayerView3D-4128a20f.js","assets/symbolColorUtils-c9d24716.js","assets/MeshComponent-788e605a.js","assets/earcut-61f7b102.js","assets/deduplicate-769a6f51.js","assets/Indices-d8bff7b2.js","assets/imageUtils-c2d0d1ae.js","assets/objectResourceUtils-782953c3.js","assets/devEnvironmentUtils-5002a058.js","assets/mat3f64-50f3b9f6.js","assets/mat4f64-abdda1bb.js","assets/BufferView-379a78a4.js","assets/vec33-69c9e93b.js","assets/DefaultMaterial_COLOR_GAMMA-6ed76d86.js","assets/types-e1c0a5bf.js","assets/enums-e2e92c86.js","assets/Version-aa0a1d91.js","assets/quat-7b70e9a8.js","assets/quatf64-f8f1c132.js","assets/resourceUtils-527631ac.js","assets/basicInterfaces-7449a8bf.js","assets/NestedMap-1b5db22e.js","assets/requestImageUtils-d1ba3b36.js","assets/Util-6d3f024a.js","assets/sphere-d0e5285d.js","assets/VertexAttribute-15d1866a.js","assets/doublePrecisionUtils-e3c3d0d8.js","assets/OrderIndependentTransparency-5f7257d7.js","assets/Texture-563cf5e5.js","assets/FramebufferObject-8b18fc0c.js","assets/VertexElementDescriptor-2925c6af.js","assets/InterleavedLayout-d57c91d0.js","assets/vec3f32-01c06d8d.js","assets/projectExtentUtils-e8c7cde0.js","assets/geometryServiceUtils-a536bb19.js","assets/project-909a4219.js","assets/ImageMaterial-e77d3ec9.js","assets/LayerView-abbb3570.js","assets/RefreshableLayerView-e4d9e9c9.js","assets/MapImageLayerView-90b22327.js","assets/ExportImageParameters-99094deb.js","assets/floorFilterUtils-080a7cd2.js","assets/sublayerUtils-43bc6a74.js","assets/MapServiceLayerViewHelper-ee55984a.js","assets/scaleUtils-d13015f2.js","assets/popupUtils-54bd9deb.js","assets/drapedUtils-08d2401b.js","assets/plane-5e2b046c.js","assets/spatialReferenceEllipsoidUtils-afb35af9.js","assets/ElevationSamplerData-e3118b17.js","assets/Octree-499541ed.js","assets/edgeProcessing-20e12367.js","assets/projection-5969b753.js","assets/ZoomMomentumEstimator-ef57e6a4.js","assets/floatRGBA-ca2b39ca.js","assets/dehydratedFeatures-3a140d03.js","assets/quantizationUtils-b3b2ae2a.js","assets/labelFormatUtils-71e1f841.js","assets/orientedBoundingBox-a14b97b5.js","assets/quatf32-51a323b8.js","assets/SnappingCandidate-970faec6.js","assets/callExpressionWithFeature-df1a8f01.js","assets/DefaultVertexAttributeLayouts-5f20d8dd.js","assets/LercDecoder-65586d50.js","assets/VectorTile-d41a1f0f.js","assets/enums-fb086c25.js","assets/config-1337d16e.js","assets/TiledDisplayObject-419c008b.js","assets/DisplayObject-87c37b69.js","assets/rasterUtils-7694cc98.js","assets/resources-7587d8f4.js","assets/workerHelper-6131d203.js","assets/webgl-debug-7f880832.js","assets/RenderingContext-0f21aa0e.js","assets/ProgramCache-f29c900e.js","assets/Program-77209250.js","assets/MediaLayer-4c42fc2f.js","assets/MediaElementView-06baa4d4.js","assets/normalizeUtilsSync-3ea564a9.js","assets/resourceExtension-f31d9f10.js","assets/BoundsStore-00da37da.js","assets/PooledRBush-5a11bc7e.js","assets/prism-line-numbers-eff41b13.js","assets/label2-a2f37e65.js","assets/interactive-1de2e238.js","assets/loadable-6afd516d.js","assets/t9n-81df3a71.js","assets/observers-c89705b8.js","assets/icon-8e47fbec.js","assets/loader-c773e800.js","assets/guid-51402ee7.js","assets/prism-line-numbers-7c5d72ff.css"]),media:()=>_e(()=>import("./MediaLayerView3D-378eb715.js"),["assets/MediaLayerView3D-378eb715.js","assets/calcite-8912bd40.js","assets/index-00759e4a.js","assets/index-5026a37a.css","assets/calcite-96fa36fd.css","assets/MediaElementView-06baa4d4.js","assets/mat3f64-50f3b9f6.js","assets/normalizeUtilsSync-3ea564a9.js","assets/LayerView3D-4128a20f.js","assets/symbolColorUtils-c9d24716.js","assets/basicInterfaces-7449a8bf.js","assets/objectResourceUtils-782953c3.js","assets/devEnvironmentUtils-5002a058.js","assets/mat4f64-abdda1bb.js","assets/BufferView-379a78a4.js","assets/vec33-69c9e93b.js","assets/DefaultMaterial_COLOR_GAMMA-6ed76d86.js","assets/types-e1c0a5bf.js","assets/enums-e2e92c86.js","assets/Version-aa0a1d91.js","assets/quat-7b70e9a8.js","assets/quatf64-f8f1c132.js","assets/resourceUtils-527631ac.js","assets/Indices-d8bff7b2.js","assets/NestedMap-1b5db22e.js","assets/requestImageUtils-d1ba3b36.js","assets/Util-6d3f024a.js","assets/sphere-d0e5285d.js","assets/VertexAttribute-15d1866a.js","assets/doublePrecisionUtils-e3c3d0d8.js","assets/OrderIndependentTransparency-5f7257d7.js","assets/Texture-563cf5e5.js","assets/FramebufferObject-8b18fc0c.js","assets/VertexElementDescriptor-2925c6af.js","assets/InterleavedLayout-d57c91d0.js","assets/vec3f32-01c06d8d.js","assets/ImageMaterial-e77d3ec9.js","assets/LayerView-abbb3570.js","assets/plane-5e2b046c.js","assets/spatialReferenceEllipsoidUtils-afb35af9.js","assets/scaleUtils-d13015f2.js","assets/ElevationSamplerData-e3118b17.js","assets/Octree-499541ed.js","assets/edgeProcessing-20e12367.js","assets/deduplicate-769a6f51.js","assets/MeshComponent-788e605a.js","assets/earcut-61f7b102.js","assets/imageUtils-c2d0d1ae.js","assets/projection-5969b753.js","assets/ZoomMomentumEstimator-ef57e6a4.js","assets/floatRGBA-ca2b39ca.js","assets/dehydratedFeatures-3a140d03.js","assets/quantizationUtils-b3b2ae2a.js","assets/labelFormatUtils-71e1f841.js","assets/orientedBoundingBox-a14b97b5.js","assets/quatf32-51a323b8.js","assets/SnappingCandidate-970faec6.js","assets/callExpressionWithFeature-df1a8f01.js","assets/DefaultVertexAttributeLayouts-5f20d8dd.js","assets/geometryServiceUtils-a536bb19.js","assets/project-909a4219.js","assets/LercDecoder-65586d50.js","assets/VectorTile-d41a1f0f.js","assets/enums-fb086c25.js","assets/config-1337d16e.js","assets/TiledDisplayObject-419c008b.js","assets/DisplayObject-87c37b69.js","assets/rasterUtils-7694cc98.js","assets/resources-7587d8f4.js","assets/workerHelper-6131d203.js","assets/webgl-debug-7f880832.js","assets/RenderingContext-0f21aa0e.js","assets/ProgramCache-f29c900e.js","assets/Program-77209250.js","assets/MediaLayer-4c42fc2f.js","assets/resourceExtension-f31d9f10.js","assets/BoundsStore-00da37da.js","assets/PooledRBush-5a11bc7e.js","assets/prism-line-numbers-eff41b13.js","assets/label2-a2f37e65.js","assets/interactive-1de2e238.js","assets/loadable-6afd516d.js","assets/t9n-81df3a71.js","assets/observers-c89705b8.js","assets/icon-8e47fbec.js","assets/loader-c773e800.js","assets/guid-51402ee7.js","assets/prism-line-numbers-7c5d72ff.css"]),"ogc-feature":()=>_e(()=>import("./OGCFeatureLayerView3D-197805bc.js"),["assets/OGCFeatureLayerView3D-197805bc.js","assets/calcite-8912bd40.js","assets/index-00759e4a.js","assets/index-5026a37a.css","assets/calcite-96fa36fd.css","assets/FeatureLayerViewBase3D-6a29452c.js","assets/FeatureLikeLayerView3D-55d9655f.js","assets/geometryServiceUtils-a536bb19.js","assets/project-909a4219.js","assets/dehydratedFeatures-3a140d03.js","assets/quantizationUtils-b3b2ae2a.js","assets/dehydratedFeatureComparison-409d2bff.js","assets/queryForSymbologySnapping-f85651d3.js","assets/elevationInfoUtils-551ce894.js","assets/hash-0ddfbf4b.js","assets/Graphics3DObjectStates-8688d43e.js","assets/optimizedFeatureQueryEngineAdapter-b6d8def7.js","assets/centroid-bf48eee6.js","assets/PooledRBush-5a11bc7e.js","assets/basicInterfaces-7449a8bf.js","assets/floorFilterUtils-080a7cd2.js","assets/QueryEngine-dd47d379.js","assets/QueryEngineResult-dfcfeac3.js","assets/WhereClause-8339ee75.js","assets/executionError-fb3f283a.js","assets/utils-e5a50699.js","assets/generateRendererUtils-5b0c1ef7.js","assets/projectionSupport-d23d7a2d.js","assets/json-48e3ea08.js","assets/SnappingCandidate-970faec6.js","assets/utils-046b23b4.js","assets/QueryEngineCapabilities-42e44ded.js","assets/timeSupport-a3b9e468.js","assets/scaleUtils-d13015f2.js","assets/FeatureStore-b2e1c75d.js","assets/BoundsStore-00da37da.js","assets/symbolColorUtils-c9d24716.js","assets/objectResourceUtils-782953c3.js","assets/devEnvironmentUtils-5002a058.js","assets/mat3f64-50f3b9f6.js","assets/mat4f64-abdda1bb.js","assets/BufferView-379a78a4.js","assets/vec33-69c9e93b.js","assets/DefaultMaterial_COLOR_GAMMA-6ed76d86.js","assets/types-e1c0a5bf.js","assets/enums-e2e92c86.js","assets/Version-aa0a1d91.js","assets/quat-7b70e9a8.js","assets/quatf64-f8f1c132.js","assets/resourceUtils-527631ac.js","assets/Indices-d8bff7b2.js","assets/NestedMap-1b5db22e.js","assets/requestImageUtils-d1ba3b36.js","assets/Util-6d3f024a.js","assets/sphere-d0e5285d.js","assets/VertexAttribute-15d1866a.js","assets/doublePrecisionUtils-e3c3d0d8.js","assets/OrderIndependentTransparency-5f7257d7.js","assets/Texture-563cf5e5.js","assets/FramebufferObject-8b18fc0c.js","assets/VertexElementDescriptor-2925c6af.js","assets/InterleavedLayout-d57c91d0.js","assets/vec3f32-01c06d8d.js","assets/heatmapTextureUtils-56fc7bff.js","assets/projectExtentUtils-e8c7cde0.js","assets/LayerView3D-4128a20f.js","assets/LercDecoder-65586d50.js","assets/EventedSet-7ad75bee.js","assets/FeatureLayerView-36f7cadb.js","assets/popupUtils-54bd9deb.js","assets/LayerView-abbb3570.js","assets/RefreshableLayerView-e4d9e9c9.js","assets/OGCFeatureLayerView-f0048231.js","assets/plane-5e2b046c.js","assets/spatialReferenceEllipsoidUtils-afb35af9.js","assets/ElevationSamplerData-e3118b17.js","assets/Octree-499541ed.js","assets/edgeProcessing-20e12367.js","assets/deduplicate-769a6f51.js","assets/MeshComponent-788e605a.js","assets/earcut-61f7b102.js","assets/imageUtils-c2d0d1ae.js","assets/projection-5969b753.js","assets/ZoomMomentumEstimator-ef57e6a4.js","assets/floatRGBA-ca2b39ca.js","assets/labelFormatUtils-71e1f841.js","assets/orientedBoundingBox-a14b97b5.js","assets/quatf32-51a323b8.js","assets/callExpressionWithFeature-df1a8f01.js","assets/DefaultVertexAttributeLayouts-5f20d8dd.js","assets/VectorTile-d41a1f0f.js","assets/enums-fb086c25.js","assets/config-1337d16e.js","assets/TiledDisplayObject-419c008b.js","assets/DisplayObject-87c37b69.js","assets/rasterUtils-7694cc98.js","assets/resources-7587d8f4.js","assets/workerHelper-6131d203.js","assets/webgl-debug-7f880832.js","assets/RenderingContext-0f21aa0e.js","assets/ProgramCache-f29c900e.js","assets/Program-77209250.js","assets/MediaLayer-4c42fc2f.js","assets/MediaElementView-06baa4d4.js","assets/normalizeUtilsSync-3ea564a9.js","assets/resourceExtension-f31d9f10.js","assets/prism-line-numbers-eff41b13.js","assets/label2-a2f37e65.js","assets/interactive-1de2e238.js","assets/loadable-6afd516d.js","assets/t9n-81df3a71.js","assets/observers-c89705b8.js","assets/icon-8e47fbec.js","assets/loader-c773e800.js","assets/guid-51402ee7.js","assets/prism-line-numbers-7c5d72ff.css"]),"open-street-map":ym,"oriented-imagery":()=>_e(()=>import("./FeatureLayerView3D-1358730d.js"),["assets/FeatureLayerView3D-1358730d.js","assets/calcite-8912bd40.js","assets/index-00759e4a.js","assets/index-5026a37a.css","assets/calcite-96fa36fd.css","assets/FeatureLayerViewBase3D-6a29452c.js","assets/FeatureLikeLayerView3D-55d9655f.js","assets/geometryServiceUtils-a536bb19.js","assets/project-909a4219.js","assets/dehydratedFeatures-3a140d03.js","assets/quantizationUtils-b3b2ae2a.js","assets/dehydratedFeatureComparison-409d2bff.js","assets/queryForSymbologySnapping-f85651d3.js","assets/elevationInfoUtils-551ce894.js","assets/hash-0ddfbf4b.js","assets/Graphics3DObjectStates-8688d43e.js","assets/optimizedFeatureQueryEngineAdapter-b6d8def7.js","assets/centroid-bf48eee6.js","assets/PooledRBush-5a11bc7e.js","assets/basicInterfaces-7449a8bf.js","assets/floorFilterUtils-080a7cd2.js","assets/QueryEngine-dd47d379.js","assets/QueryEngineResult-dfcfeac3.js","assets/WhereClause-8339ee75.js","assets/executionError-fb3f283a.js","assets/utils-e5a50699.js","assets/generateRendererUtils-5b0c1ef7.js","assets/projectionSupport-d23d7a2d.js","assets/json-48e3ea08.js","assets/SnappingCandidate-970faec6.js","assets/utils-046b23b4.js","assets/QueryEngineCapabilities-42e44ded.js","assets/timeSupport-a3b9e468.js","assets/scaleUtils-d13015f2.js","assets/FeatureStore-b2e1c75d.js","assets/BoundsStore-00da37da.js","assets/symbolColorUtils-c9d24716.js","assets/objectResourceUtils-782953c3.js","assets/devEnvironmentUtils-5002a058.js","assets/mat3f64-50f3b9f6.js","assets/mat4f64-abdda1bb.js","assets/BufferView-379a78a4.js","assets/vec33-69c9e93b.js","assets/DefaultMaterial_COLOR_GAMMA-6ed76d86.js","assets/types-e1c0a5bf.js","assets/enums-e2e92c86.js","assets/Version-aa0a1d91.js","assets/quat-7b70e9a8.js","assets/quatf64-f8f1c132.js","assets/resourceUtils-527631ac.js","assets/Indices-d8bff7b2.js","assets/NestedMap-1b5db22e.js","assets/requestImageUtils-d1ba3b36.js","assets/Util-6d3f024a.js","assets/sphere-d0e5285d.js","assets/VertexAttribute-15d1866a.js","assets/doublePrecisionUtils-e3c3d0d8.js","assets/OrderIndependentTransparency-5f7257d7.js","assets/Texture-563cf5e5.js","assets/FramebufferObject-8b18fc0c.js","assets/VertexElementDescriptor-2925c6af.js","assets/InterleavedLayout-d57c91d0.js","assets/vec3f32-01c06d8d.js","assets/heatmapTextureUtils-56fc7bff.js","assets/projectExtentUtils-e8c7cde0.js","assets/LayerView3D-4128a20f.js","assets/LercDecoder-65586d50.js","assets/EventedSet-7ad75bee.js","assets/FeatureLayerView-36f7cadb.js","assets/popupUtils-54bd9deb.js","assets/LayerView-abbb3570.js","assets/RefreshableLayerView-e4d9e9c9.js","assets/plane-5e2b046c.js","assets/spatialReferenceEllipsoidUtils-afb35af9.js","assets/ElevationSamplerData-e3118b17.js","assets/Octree-499541ed.js","assets/edgeProcessing-20e12367.js","assets/deduplicate-769a6f51.js","assets/MeshComponent-788e605a.js","assets/earcut-61f7b102.js","assets/imageUtils-c2d0d1ae.js","assets/projection-5969b753.js","assets/ZoomMomentumEstimator-ef57e6a4.js","assets/floatRGBA-ca2b39ca.js","assets/labelFormatUtils-71e1f841.js","assets/orientedBoundingBox-a14b97b5.js","assets/quatf32-51a323b8.js","assets/callExpressionWithFeature-df1a8f01.js","assets/DefaultVertexAttributeLayouts-5f20d8dd.js","assets/VectorTile-d41a1f0f.js","assets/enums-fb086c25.js","assets/config-1337d16e.js","assets/TiledDisplayObject-419c008b.js","assets/DisplayObject-87c37b69.js","assets/rasterUtils-7694cc98.js","assets/resources-7587d8f4.js","assets/workerHelper-6131d203.js","assets/webgl-debug-7f880832.js","assets/RenderingContext-0f21aa0e.js","assets/ProgramCache-f29c900e.js","assets/Program-77209250.js","assets/MediaLayer-4c42fc2f.js","assets/MediaElementView-06baa4d4.js","assets/normalizeUtilsSync-3ea564a9.js","assets/resourceExtension-f31d9f10.js","assets/prism-line-numbers-eff41b13.js","assets/label2-a2f37e65.js","assets/interactive-1de2e238.js","assets/loadable-6afd516d.js","assets/t9n-81df3a71.js","assets/observers-c89705b8.js","assets/icon-8e47fbec.js","assets/loader-c773e800.js","assets/guid-51402ee7.js","assets/prism-line-numbers-7c5d72ff.css"]),"point-cloud":()=>_e(()=>import("./PointCloudLayerView3D-bd6355ff.js").then(i=>i.P),["assets/PointCloudLayerView3D-bd6355ff.js","assets/calcite-8912bd40.js","assets/index-00759e4a.js","assets/index-5026a37a.css","assets/calcite-96fa36fd.css","assets/vec3f32-01c06d8d.js","assets/plane-5e2b046c.js","assets/sphere-d0e5285d.js","assets/mat3f64-50f3b9f6.js","assets/mat4f64-abdda1bb.js","assets/quatf64-f8f1c132.js","assets/dehydratedFeatures-3a140d03.js","assets/quantizationUtils-b3b2ae2a.js","assets/LayerView3D-4128a20f.js","assets/LercDecoder-65586d50.js","assets/I3SUtil-930fc7a4.js","assets/quat-7b70e9a8.js","assets/quatf32-51a323b8.js","assets/spatialReferenceEllipsoidUtils-afb35af9.js","assets/I3SBinaryReader-533328a5.js","assets/VertexAttribute-15d1866a.js","assets/orientedBoundingBox-a14b97b5.js","assets/symbolColorUtils-c9d24716.js","assets/PointCloudWorkerUtil-e60ffde3.js","assets/PointCloudUniqueValueRenderer-00dd1cae.js","assets/basicInterfaces-7449a8bf.js","assets/objectResourceUtils-782953c3.js","assets/devEnvironmentUtils-5002a058.js","assets/BufferView-379a78a4.js","assets/vec33-69c9e93b.js","assets/DefaultMaterial_COLOR_GAMMA-6ed76d86.js","assets/types-e1c0a5bf.js","assets/enums-e2e92c86.js","assets/Version-aa0a1d91.js","assets/resourceUtils-527631ac.js","assets/Indices-d8bff7b2.js","assets/NestedMap-1b5db22e.js","assets/requestImageUtils-d1ba3b36.js","assets/Util-6d3f024a.js","assets/doublePrecisionUtils-e3c3d0d8.js","assets/OrderIndependentTransparency-5f7257d7.js","assets/Texture-563cf5e5.js","assets/FramebufferObject-8b18fc0c.js","assets/VertexElementDescriptor-2925c6af.js","assets/InterleavedLayout-d57c91d0.js","assets/PopupSceneLayerView-b1856080.js","assets/popupUtils-54bd9deb.js","assets/LayerView-abbb3570.js"]),voxel:()=>_e(()=>import("./VoxelLayerView3D-cb761dbf.js"),["assets/VoxelLayerView3D-cb761dbf.js","assets/calcite-8912bd40.js","assets/index-00759e4a.js","assets/index-5026a37a.css","assets/calcite-96fa36fd.css","assets/LayerView3D-4128a20f.js","assets/PopupSceneLayerView-b1856080.js","assets/popupUtils-54bd9deb.js","assets/LayerView-abbb3570.js"]),route:()=>_e(()=>import("./RouteLayerView3D-745a99fc.js"),["assets/RouteLayerView3D-745a99fc.js","assets/calcite-8912bd40.js","assets/index-00759e4a.js","assets/index-5026a37a.css","assets/calcite-96fa36fd.css","assets/Stop-3cbfb43d.js","assets/LayerView3D-4128a20f.js","assets/GraphicsProcessor-d49a2131.js","assets/Graphics3DObjectStates-8688d43e.js","assets/dehydratedFeatures-3a140d03.js","assets/quantizationUtils-b3b2ae2a.js","assets/optimizedFeatureQueryEngineAdapter-b6d8def7.js","assets/centroid-bf48eee6.js","assets/PooledRBush-5a11bc7e.js","assets/basicInterfaces-7449a8bf.js","assets/projectExtentUtils-e8c7cde0.js","assets/geometryServiceUtils-a536bb19.js","assets/project-909a4219.js","assets/EventedSet-7ad75bee.js","assets/LayerView-abbb3570.js","assets/sphere-d0e5285d.js","assets/mat3f64-50f3b9f6.js","assets/mat4f64-abdda1bb.js","assets/quatf64-f8f1c132.js","assets/Util-6d3f024a.js","assets/plane-5e2b046c.js","assets/spatialReferenceEllipsoidUtils-afb35af9.js","assets/scaleUtils-d13015f2.js","assets/ElevationSamplerData-e3118b17.js","assets/objectResourceUtils-782953c3.js","assets/devEnvironmentUtils-5002a058.js","assets/BufferView-379a78a4.js","assets/vec33-69c9e93b.js","assets/DefaultMaterial_COLOR_GAMMA-6ed76d86.js","assets/types-e1c0a5bf.js","assets/enums-e2e92c86.js","assets/Version-aa0a1d91.js","assets/quat-7b70e9a8.js","assets/resourceUtils-527631ac.js","assets/Indices-d8bff7b2.js","assets/NestedMap-1b5db22e.js","assets/requestImageUtils-d1ba3b36.js","assets/symbolColorUtils-c9d24716.js","assets/VertexAttribute-15d1866a.js","assets/doublePrecisionUtils-e3c3d0d8.js","assets/OrderIndependentTransparency-5f7257d7.js","assets/Texture-563cf5e5.js","assets/FramebufferObject-8b18fc0c.js","assets/VertexElementDescriptor-2925c6af.js","assets/InterleavedLayout-d57c91d0.js","assets/vec3f32-01c06d8d.js","assets/Octree-499541ed.js","assets/edgeProcessing-20e12367.js","assets/deduplicate-769a6f51.js","assets/MeshComponent-788e605a.js","assets/earcut-61f7b102.js","assets/imageUtils-c2d0d1ae.js","assets/projection-5969b753.js","assets/ZoomMomentumEstimator-ef57e6a4.js","assets/floatRGBA-ca2b39ca.js","assets/labelFormatUtils-71e1f841.js","assets/orientedBoundingBox-a14b97b5.js","assets/quatf32-51a323b8.js","assets/SnappingCandidate-970faec6.js","assets/callExpressionWithFeature-df1a8f01.js","assets/DefaultVertexAttributeLayouts-5f20d8dd.js","assets/LercDecoder-65586d50.js","assets/VectorTile-d41a1f0f.js","assets/enums-fb086c25.js","assets/config-1337d16e.js","assets/TiledDisplayObject-419c008b.js","assets/DisplayObject-87c37b69.js","assets/rasterUtils-7694cc98.js","assets/resources-7587d8f4.js","assets/workerHelper-6131d203.js","assets/webgl-debug-7f880832.js","assets/RenderingContext-0f21aa0e.js","assets/ProgramCache-f29c900e.js","assets/Program-77209250.js","assets/MediaLayer-4c42fc2f.js","assets/MediaElementView-06baa4d4.js","assets/normalizeUtilsSync-3ea564a9.js","assets/resourceExtension-f31d9f10.js","assets/BoundsStore-00da37da.js","assets/prism-line-numbers-eff41b13.js","assets/label2-a2f37e65.js","assets/interactive-1de2e238.js","assets/loadable-6afd516d.js","assets/t9n-81df3a71.js","assets/observers-c89705b8.js","assets/icon-8e47fbec.js","assets/loader-c773e800.js","assets/guid-51402ee7.js","assets/prism-line-numbers-7c5d72ff.css"]),scene:i=>i.profile==null||i.profile==="mesh-pyramids"?_e(()=>import("./SceneLayerView3D-0a3d1091.js"),["assets/SceneLayerView3D-0a3d1091.js","assets/calcite-8912bd40.js","assets/index-00759e4a.js","assets/index-5026a37a.css","assets/calcite-96fa36fd.css","assets/WhereClause-8339ee75.js","assets/executionError-fb3f283a.js","assets/floorFilterUtils-080a7cd2.js","assets/I3SMeshView3D-e9677f38.js","assets/mat4f64-abdda1bb.js","assets/quatf64-f8f1c132.js","assets/I3SOverrides-37467bf0.js","assets/dehydratedFeatures-3a140d03.js","assets/quantizationUtils-b3b2ae2a.js","assets/I3SNode-fcca117e.js","assets/sphere-d0e5285d.js","assets/mat3f64-50f3b9f6.js","assets/I3SUtil-930fc7a4.js","assets/quat-7b70e9a8.js","assets/quatf32-51a323b8.js","assets/spatialReferenceEllipsoidUtils-afb35af9.js","assets/I3SBinaryReader-533328a5.js","assets/VertexAttribute-15d1866a.js","assets/orientedBoundingBox-a14b97b5.js","assets/vec3f32-01c06d8d.js","assets/plane-5e2b046c.js","assets/symbolColorUtils-c9d24716.js","assets/RenderTexture-6105e069.js","assets/objectResourceUtils-782953c3.js","assets/devEnvironmentUtils-5002a058.js","assets/BufferView-379a78a4.js","assets/vec33-69c9e93b.js","assets/DefaultMaterial_COLOR_GAMMA-6ed76d86.js","assets/types-e1c0a5bf.js","assets/enums-e2e92c86.js","assets/Version-aa0a1d91.js","assets/resourceUtils-527631ac.js","assets/basicInterfaces-7449a8bf.js","assets/Indices-d8bff7b2.js","assets/NestedMap-1b5db22e.js","assets/requestImageUtils-d1ba3b36.js","assets/Util-6d3f024a.js","assets/doublePrecisionUtils-e3c3d0d8.js","assets/OrderIndependentTransparency-5f7257d7.js","assets/Texture-563cf5e5.js","assets/FramebufferObject-8b18fc0c.js","assets/VertexElementDescriptor-2925c6af.js","assets/InterleavedLayout-d57c91d0.js","assets/Octree-499541ed.js","assets/featureQueryAll-47bc4c6c.js","assets/FeatureLayerView3D-1358730d.js","assets/FeatureLayerViewBase3D-6a29452c.js","assets/FeatureLikeLayerView3D-55d9655f.js","assets/geometryServiceUtils-a536bb19.js","assets/project-909a4219.js","assets/dehydratedFeatureComparison-409d2bff.js","assets/queryForSymbologySnapping-f85651d3.js","assets/elevationInfoUtils-551ce894.js","assets/hash-0ddfbf4b.js","assets/Graphics3DObjectStates-8688d43e.js","assets/optimizedFeatureQueryEngineAdapter-b6d8def7.js","assets/centroid-bf48eee6.js","assets/PooledRBush-5a11bc7e.js","assets/QueryEngine-dd47d379.js","assets/QueryEngineResult-dfcfeac3.js","assets/utils-e5a50699.js","assets/generateRendererUtils-5b0c1ef7.js","assets/projectionSupport-d23d7a2d.js","assets/json-48e3ea08.js","assets/SnappingCandidate-970faec6.js","assets/utils-046b23b4.js","assets/QueryEngineCapabilities-42e44ded.js","assets/timeSupport-a3b9e468.js","assets/scaleUtils-d13015f2.js","assets/FeatureStore-b2e1c75d.js","assets/BoundsStore-00da37da.js","assets/heatmapTextureUtils-56fc7bff.js","assets/projectExtentUtils-e8c7cde0.js","assets/LayerView3D-4128a20f.js","assets/LercDecoder-65586d50.js","assets/EventedSet-7ad75bee.js","assets/FeatureLayerView-36f7cadb.js","assets/popupUtils-54bd9deb.js","assets/LayerView-abbb3570.js","assets/RefreshableLayerView-e4d9e9c9.js","assets/ElevationSamplerData-e3118b17.js","assets/edgeProcessing-20e12367.js","assets/deduplicate-769a6f51.js","assets/MeshComponent-788e605a.js","assets/earcut-61f7b102.js","assets/imageUtils-c2d0d1ae.js","assets/projection-5969b753.js","assets/ZoomMomentumEstimator-ef57e6a4.js","assets/floatRGBA-ca2b39ca.js","assets/labelFormatUtils-71e1f841.js","assets/callExpressionWithFeature-df1a8f01.js","assets/DefaultVertexAttributeLayouts-5f20d8dd.js","assets/VectorTile-d41a1f0f.js","assets/enums-fb086c25.js","assets/config-1337d16e.js","assets/TiledDisplayObject-419c008b.js","assets/DisplayObject-87c37b69.js","assets/rasterUtils-7694cc98.js","assets/resources-7587d8f4.js","assets/workerHelper-6131d203.js","assets/webgl-debug-7f880832.js","assets/RenderingContext-0f21aa0e.js","assets/ProgramCache-f29c900e.js","assets/Program-77209250.js","assets/MediaLayer-4c42fc2f.js","assets/MediaElementView-06baa4d4.js","assets/normalizeUtilsSync-3ea564a9.js","assets/resourceExtension-f31d9f10.js","assets/prism-line-numbers-eff41b13.js","assets/label2-a2f37e65.js","assets/interactive-1de2e238.js","assets/loadable-6afd516d.js","assets/t9n-81df3a71.js","assets/observers-c89705b8.js","assets/icon-8e47fbec.js","assets/loader-c773e800.js","assets/guid-51402ee7.js","assets/prism-line-numbers-7c5d72ff.css","assets/SceneModification-5174816b.js","assets/persistable-cb99c020.js","assets/multiOriginJSONSupportUtils-c978f4c3.js","assets/SceneLayerWorker-acafa874.js","assets/SceneLayerView-138f0e97.js","assets/DefinitionExpressionSceneLayerView-3bb456ca.js","assets/I3SQueryFeatureStore-e5073b38.js","assets/PopupSceneLayerView-b1856080.js"]):_e(()=>import("./SceneLayerGraphicsView3D-82ecc2b8.js"),["assets/SceneLayerGraphicsView3D-82ecc2b8.js","assets/index-00759e4a.js","assets/index-5026a37a.css","assets/calcite-8912bd40.js","assets/calcite-96fa36fd.css","assets/dehydratedFeatures-3a140d03.js","assets/quantizationUtils-b3b2ae2a.js","assets/I3SOverrides-37467bf0.js","assets/I3SNode-fcca117e.js","assets/sphere-d0e5285d.js","assets/mat3f64-50f3b9f6.js","assets/mat4f64-abdda1bb.js","assets/quatf64-f8f1c132.js","assets/I3SUtil-930fc7a4.js","assets/quat-7b70e9a8.js","assets/quatf32-51a323b8.js","assets/spatialReferenceEllipsoidUtils-afb35af9.js","assets/I3SBinaryReader-533328a5.js","assets/VertexAttribute-15d1866a.js","assets/orientedBoundingBox-a14b97b5.js","assets/vec3f32-01c06d8d.js","assets/plane-5e2b046c.js","assets/symbolColorUtils-c9d24716.js","assets/RenderTexture-6105e069.js","assets/objectResourceUtils-782953c3.js","assets/devEnvironmentUtils-5002a058.js","assets/BufferView-379a78a4.js","assets/vec33-69c9e93b.js","assets/DefaultMaterial_COLOR_GAMMA-6ed76d86.js","assets/types-e1c0a5bf.js","assets/enums-e2e92c86.js","assets/Version-aa0a1d91.js","assets/resourceUtils-527631ac.js","assets/basicInterfaces-7449a8bf.js","assets/Indices-d8bff7b2.js","assets/NestedMap-1b5db22e.js","assets/requestImageUtils-d1ba3b36.js","assets/Util-6d3f024a.js","assets/doublePrecisionUtils-e3c3d0d8.js","assets/OrderIndependentTransparency-5f7257d7.js","assets/Texture-563cf5e5.js","assets/FramebufferObject-8b18fc0c.js","assets/VertexElementDescriptor-2925c6af.js","assets/InterleavedLayout-d57c91d0.js","assets/Octree-499541ed.js","assets/featureQueryAll-47bc4c6c.js","assets/FeatureLayerView3D-1358730d.js","assets/FeatureLayerViewBase3D-6a29452c.js","assets/FeatureLikeLayerView3D-55d9655f.js","assets/geometryServiceUtils-a536bb19.js","assets/project-909a4219.js","assets/dehydratedFeatureComparison-409d2bff.js","assets/queryForSymbologySnapping-f85651d3.js","assets/elevationInfoUtils-551ce894.js","assets/hash-0ddfbf4b.js","assets/Graphics3DObjectStates-8688d43e.js","assets/optimizedFeatureQueryEngineAdapter-b6d8def7.js","assets/centroid-bf48eee6.js","assets/PooledRBush-5a11bc7e.js","assets/floorFilterUtils-080a7cd2.js","assets/QueryEngine-dd47d379.js","assets/QueryEngineResult-dfcfeac3.js","assets/WhereClause-8339ee75.js","assets/executionError-fb3f283a.js","assets/utils-e5a50699.js","assets/generateRendererUtils-5b0c1ef7.js","assets/projectionSupport-d23d7a2d.js","assets/json-48e3ea08.js","assets/SnappingCandidate-970faec6.js","assets/utils-046b23b4.js","assets/QueryEngineCapabilities-42e44ded.js","assets/timeSupport-a3b9e468.js","assets/scaleUtils-d13015f2.js","assets/FeatureStore-b2e1c75d.js","assets/BoundsStore-00da37da.js","assets/heatmapTextureUtils-56fc7bff.js","assets/projectExtentUtils-e8c7cde0.js","assets/LayerView3D-4128a20f.js","assets/LercDecoder-65586d50.js","assets/EventedSet-7ad75bee.js","assets/FeatureLayerView-36f7cadb.js","assets/popupUtils-54bd9deb.js","assets/LayerView-abbb3570.js","assets/RefreshableLayerView-e4d9e9c9.js","assets/ElevationSamplerData-e3118b17.js","assets/edgeProcessing-20e12367.js","assets/deduplicate-769a6f51.js","assets/MeshComponent-788e605a.js","assets/earcut-61f7b102.js","assets/imageUtils-c2d0d1ae.js","assets/projection-5969b753.js","assets/ZoomMomentumEstimator-ef57e6a4.js","assets/floatRGBA-ca2b39ca.js","assets/labelFormatUtils-71e1f841.js","assets/callExpressionWithFeature-df1a8f01.js","assets/DefaultVertexAttributeLayouts-5f20d8dd.js","assets/VectorTile-d41a1f0f.js","assets/enums-fb086c25.js","assets/config-1337d16e.js","assets/TiledDisplayObject-419c008b.js","assets/DisplayObject-87c37b69.js","assets/rasterUtils-7694cc98.js","assets/resources-7587d8f4.js","assets/workerHelper-6131d203.js","assets/webgl-debug-7f880832.js","assets/RenderingContext-0f21aa0e.js","assets/ProgramCache-f29c900e.js","assets/Program-77209250.js","assets/MediaLayer-4c42fc2f.js","assets/MediaElementView-06baa4d4.js","assets/normalizeUtilsSync-3ea564a9.js","assets/resourceExtension-f31d9f10.js","assets/prism-line-numbers-eff41b13.js","assets/label2-a2f37e65.js","assets/interactive-1de2e238.js","assets/loadable-6afd516d.js","assets/t9n-81df3a71.js","assets/observers-c89705b8.js","assets/icon-8e47fbec.js","assets/loader-c773e800.js","assets/guid-51402ee7.js","assets/prism-line-numbers-7c5d72ff.css","assets/SceneLayerView-138f0e97.js","assets/DefinitionExpressionSceneLayerView-3bb456ca.js","assets/PopupSceneLayerView-b1856080.js"]),stream:()=>_e(()=>import("./StreamLayerView3D-f78a6278.js"),["assets/StreamLayerView3D-f78a6278.js","assets/calcite-8912bd40.js","assets/index-00759e4a.js","assets/index-5026a37a.css","assets/calcite-96fa36fd.css","assets/StreamFeatureManager-fbac28f2.js","assets/CircularArray-edd903b3.js","assets/createConnection-83d39580.js","assets/EventedSet-7ad75bee.js","assets/FeatureLikeLayerView3D-55d9655f.js","assets/geometryServiceUtils-a536bb19.js","assets/project-909a4219.js","assets/dehydratedFeatures-3a140d03.js","assets/quantizationUtils-b3b2ae2a.js","assets/dehydratedFeatureComparison-409d2bff.js","assets/queryForSymbologySnapping-f85651d3.js","assets/elevationInfoUtils-551ce894.js","assets/hash-0ddfbf4b.js","assets/Graphics3DObjectStates-8688d43e.js","assets/optimizedFeatureQueryEngineAdapter-b6d8def7.js","assets/centroid-bf48eee6.js","assets/PooledRBush-5a11bc7e.js","assets/basicInterfaces-7449a8bf.js","assets/floorFilterUtils-080a7cd2.js","assets/QueryEngine-dd47d379.js","assets/QueryEngineResult-dfcfeac3.js","assets/WhereClause-8339ee75.js","assets/executionError-fb3f283a.js","assets/utils-e5a50699.js","assets/generateRendererUtils-5b0c1ef7.js","assets/projectionSupport-d23d7a2d.js","assets/json-48e3ea08.js","assets/SnappingCandidate-970faec6.js","assets/utils-046b23b4.js","assets/QueryEngineCapabilities-42e44ded.js","assets/timeSupport-a3b9e468.js","assets/scaleUtils-d13015f2.js","assets/FeatureStore-b2e1c75d.js","assets/BoundsStore-00da37da.js","assets/symbolColorUtils-c9d24716.js","assets/objectResourceUtils-782953c3.js","assets/devEnvironmentUtils-5002a058.js","assets/mat3f64-50f3b9f6.js","assets/mat4f64-abdda1bb.js","assets/BufferView-379a78a4.js","assets/vec33-69c9e93b.js","assets/DefaultMaterial_COLOR_GAMMA-6ed76d86.js","assets/types-e1c0a5bf.js","assets/enums-e2e92c86.js","assets/Version-aa0a1d91.js","assets/quat-7b70e9a8.js","assets/quatf64-f8f1c132.js","assets/resourceUtils-527631ac.js","assets/Indices-d8bff7b2.js","assets/NestedMap-1b5db22e.js","assets/requestImageUtils-d1ba3b36.js","assets/Util-6d3f024a.js","assets/sphere-d0e5285d.js","assets/VertexAttribute-15d1866a.js","assets/doublePrecisionUtils-e3c3d0d8.js","assets/OrderIndependentTransparency-5f7257d7.js","assets/Texture-563cf5e5.js","assets/FramebufferObject-8b18fc0c.js","assets/VertexElementDescriptor-2925c6af.js","assets/InterleavedLayout-d57c91d0.js","assets/vec3f32-01c06d8d.js","assets/heatmapTextureUtils-56fc7bff.js","assets/projectExtentUtils-e8c7cde0.js","assets/LayerView3D-4128a20f.js","assets/LayerView-abbb3570.js","assets/plane-5e2b046c.js","assets/spatialReferenceEllipsoidUtils-afb35af9.js","assets/ElevationSamplerData-e3118b17.js","assets/Octree-499541ed.js","assets/edgeProcessing-20e12367.js","assets/deduplicate-769a6f51.js","assets/MeshComponent-788e605a.js","assets/earcut-61f7b102.js","assets/imageUtils-c2d0d1ae.js","assets/projection-5969b753.js","assets/ZoomMomentumEstimator-ef57e6a4.js","assets/floatRGBA-ca2b39ca.js","assets/labelFormatUtils-71e1f841.js","assets/orientedBoundingBox-a14b97b5.js","assets/quatf32-51a323b8.js","assets/callExpressionWithFeature-df1a8f01.js","assets/DefaultVertexAttributeLayouts-5f20d8dd.js","assets/LercDecoder-65586d50.js","assets/VectorTile-d41a1f0f.js","assets/enums-fb086c25.js","assets/config-1337d16e.js","assets/TiledDisplayObject-419c008b.js","assets/DisplayObject-87c37b69.js","assets/rasterUtils-7694cc98.js","assets/resources-7587d8f4.js","assets/workerHelper-6131d203.js","assets/webgl-debug-7f880832.js","assets/RenderingContext-0f21aa0e.js","assets/ProgramCache-f29c900e.js","assets/Program-77209250.js","assets/MediaLayer-4c42fc2f.js","assets/MediaElementView-06baa4d4.js","assets/normalizeUtilsSync-3ea564a9.js","assets/resourceExtension-f31d9f10.js","assets/prism-line-numbers-eff41b13.js","assets/label2-a2f37e65.js","assets/interactive-1de2e238.js","assets/loadable-6afd516d.js","assets/t9n-81df3a71.js","assets/observers-c89705b8.js","assets/icon-8e47fbec.js","assets/loader-c773e800.js","assets/guid-51402ee7.js","assets/prism-line-numbers-7c5d72ff.css"]),tile:ym,"imagery-tile":()=>_e(()=>import("./ImageryTileLayerView3D-822e28a0.js"),["assets/ImageryTileLayerView3D-822e28a0.js","assets/calcite-8912bd40.js","assets/index-00759e4a.js","assets/index-5026a37a.css","assets/calcite-96fa36fd.css","assets/LayerView3D-4128a20f.js","assets/TiledLayerView3D-7d5deb80.js","assets/ImageryTileLayerView-15bc95f1.js","assets/rasterProjectionHelper-664970f2.js","assets/popupUtils-54bd9deb.js","assets/LayerView-abbb3570.js","assets/RefreshableLayerView-e4d9e9c9.js","assets/drapedUtils-08d2401b.js","assets/sphere-d0e5285d.js","assets/mat3f64-50f3b9f6.js","assets/mat4f64-abdda1bb.js","assets/quatf64-f8f1c132.js","assets/Util-6d3f024a.js","assets/plane-5e2b046c.js","assets/spatialReferenceEllipsoidUtils-afb35af9.js","assets/scaleUtils-d13015f2.js","assets/ElevationSamplerData-e3118b17.js","assets/objectResourceUtils-782953c3.js","assets/devEnvironmentUtils-5002a058.js","assets/BufferView-379a78a4.js","assets/vec33-69c9e93b.js","assets/DefaultMaterial_COLOR_GAMMA-6ed76d86.js","assets/types-e1c0a5bf.js","assets/enums-e2e92c86.js","assets/Version-aa0a1d91.js","assets/quat-7b70e9a8.js","assets/resourceUtils-527631ac.js","assets/basicInterfaces-7449a8bf.js","assets/Indices-d8bff7b2.js","assets/NestedMap-1b5db22e.js","assets/requestImageUtils-d1ba3b36.js","assets/symbolColorUtils-c9d24716.js","assets/VertexAttribute-15d1866a.js","assets/doublePrecisionUtils-e3c3d0d8.js","assets/OrderIndependentTransparency-5f7257d7.js","assets/Texture-563cf5e5.js","assets/FramebufferObject-8b18fc0c.js","assets/VertexElementDescriptor-2925c6af.js","assets/InterleavedLayout-d57c91d0.js","assets/vec3f32-01c06d8d.js","assets/Octree-499541ed.js","assets/edgeProcessing-20e12367.js","assets/deduplicate-769a6f51.js","assets/MeshComponent-788e605a.js","assets/earcut-61f7b102.js","assets/imageUtils-c2d0d1ae.js","assets/projection-5969b753.js","assets/ZoomMomentumEstimator-ef57e6a4.js","assets/floatRGBA-ca2b39ca.js","assets/dehydratedFeatures-3a140d03.js","assets/quantizationUtils-b3b2ae2a.js","assets/labelFormatUtils-71e1f841.js","assets/orientedBoundingBox-a14b97b5.js","assets/quatf32-51a323b8.js","assets/SnappingCandidate-970faec6.js","assets/callExpressionWithFeature-df1a8f01.js","assets/DefaultVertexAttributeLayouts-5f20d8dd.js","assets/geometryServiceUtils-a536bb19.js","assets/project-909a4219.js","assets/LercDecoder-65586d50.js","assets/VectorTile-d41a1f0f.js","assets/enums-fb086c25.js","assets/config-1337d16e.js","assets/TiledDisplayObject-419c008b.js","assets/DisplayObject-87c37b69.js","assets/rasterUtils-7694cc98.js","assets/resources-7587d8f4.js","assets/workerHelper-6131d203.js","assets/webgl-debug-7f880832.js","assets/RenderingContext-0f21aa0e.js","assets/ProgramCache-f29c900e.js","assets/Program-77209250.js","assets/MediaLayer-4c42fc2f.js","assets/MediaElementView-06baa4d4.js","assets/normalizeUtilsSync-3ea564a9.js","assets/resourceExtension-f31d9f10.js","assets/BoundsStore-00da37da.js","assets/PooledRBush-5a11bc7e.js","assets/prism-line-numbers-eff41b13.js","assets/label2-a2f37e65.js","assets/interactive-1de2e238.js","assets/loadable-6afd516d.js","assets/t9n-81df3a71.js","assets/observers-c89705b8.js","assets/icon-8e47fbec.js","assets/loader-c773e800.js","assets/guid-51402ee7.js","assets/prism-line-numbers-7c5d72ff.css"]),"vector-tile":()=>_e(()=>import("./VectorTileLayerView3D-0f1211d5.js"),["assets/VectorTileLayerView3D-0f1211d5.js","assets/calcite-8912bd40.js","assets/index-00759e4a.js","assets/index-5026a37a.css","assets/calcite-96fa36fd.css","assets/TileInfoViewPOT-d2612f57.js","assets/Rect-ea14f53a.js","assets/enums-e2e92c86.js","assets/Texture-563cf5e5.js","assets/rasterizingUtils-c992e204.js","assets/floatRGBA-ca2b39ca.js","assets/config-1337d16e.js","assets/VectorTile-d41a1f0f.js","assets/enums-fb086c25.js","assets/FramebufferObject-8b18fc0c.js","assets/TiledDisplayObject-419c008b.js","assets/DisplayObject-87c37b69.js","assets/StyleDefinition-7d58136b.js","assets/enums-4b2a86a0.js","assets/TileInfoView-9dfc6c79.js","assets/WGLBrushVTLSymbol-a588e1a9.js","assets/DefaultVertexAttributeLayouts-5f20d8dd.js","assets/VertexElementDescriptor-2925c6af.js","assets/definitions-3ddd14a8.js","assets/enums-b1d611e3.js","assets/number-b10bd8f5.js","assets/GeometryUtils-dd03fc25.js","assets/VTLMaterialManager-18d63fe3.js","assets/ShaderCompiler-77d0dcb6.js","assets/programUtils-f035fe8a.js","assets/StyleRepository-4d79813f.js","assets/colorUtils-c0f43caf.js","assets/GeometryUtils-53652037.js","assets/unitBezier-881ac1eb.js","assets/LayerView3D-4128a20f.js","assets/TiledLayerView3D-7d5deb80.js","assets/LayerView-abbb3570.js","assets/sphere-d0e5285d.js","assets/mat3f64-50f3b9f6.js","assets/mat4f64-abdda1bb.js","assets/quatf64-f8f1c132.js","assets/Util-6d3f024a.js","assets/plane-5e2b046c.js","assets/spatialReferenceEllipsoidUtils-afb35af9.js","assets/scaleUtils-d13015f2.js","assets/ElevationSamplerData-e3118b17.js","assets/objectResourceUtils-782953c3.js","assets/devEnvironmentUtils-5002a058.js","assets/BufferView-379a78a4.js","assets/vec33-69c9e93b.js","assets/DefaultMaterial_COLOR_GAMMA-6ed76d86.js","assets/types-e1c0a5bf.js","assets/Version-aa0a1d91.js","assets/quat-7b70e9a8.js","assets/resourceUtils-527631ac.js","assets/basicInterfaces-7449a8bf.js","assets/Indices-d8bff7b2.js","assets/NestedMap-1b5db22e.js","assets/requestImageUtils-d1ba3b36.js","assets/symbolColorUtils-c9d24716.js","assets/VertexAttribute-15d1866a.js","assets/doublePrecisionUtils-e3c3d0d8.js","assets/OrderIndependentTransparency-5f7257d7.js","assets/InterleavedLayout-d57c91d0.js","assets/vec3f32-01c06d8d.js","assets/Octree-499541ed.js","assets/edgeProcessing-20e12367.js","assets/deduplicate-769a6f51.js","assets/MeshComponent-788e605a.js","assets/earcut-61f7b102.js","assets/imageUtils-c2d0d1ae.js","assets/projection-5969b753.js","assets/ZoomMomentumEstimator-ef57e6a4.js","assets/dehydratedFeatures-3a140d03.js","assets/quantizationUtils-b3b2ae2a.js","assets/labelFormatUtils-71e1f841.js","assets/orientedBoundingBox-a14b97b5.js","assets/quatf32-51a323b8.js","assets/SnappingCandidate-970faec6.js","assets/callExpressionWithFeature-df1a8f01.js","assets/geometryServiceUtils-a536bb19.js","assets/project-909a4219.js","assets/LercDecoder-65586d50.js","assets/rasterUtils-7694cc98.js","assets/resources-7587d8f4.js","assets/workerHelper-6131d203.js","assets/webgl-debug-7f880832.js","assets/RenderingContext-0f21aa0e.js","assets/ProgramCache-f29c900e.js","assets/Program-77209250.js","assets/MediaLayer-4c42fc2f.js","assets/MediaElementView-06baa4d4.js","assets/normalizeUtilsSync-3ea564a9.js","assets/resourceExtension-f31d9f10.js","assets/BoundsStore-00da37da.js","assets/PooledRBush-5a11bc7e.js","assets/prism-line-numbers-eff41b13.js","assets/label2-a2f37e65.js","assets/interactive-1de2e238.js","assets/loadable-6afd516d.js","assets/t9n-81df3a71.js","assets/observers-c89705b8.js","assets/icon-8e47fbec.js","assets/loader-c773e800.js","assets/guid-51402ee7.js","assets/prism-line-numbers-7c5d72ff.css"]),wcs:()=>_e(()=>import("./ImageryTileLayerView3D-822e28a0.js"),["assets/ImageryTileLayerView3D-822e28a0.js","assets/calcite-8912bd40.js","assets/index-00759e4a.js","assets/index-5026a37a.css","assets/calcite-96fa36fd.css","assets/LayerView3D-4128a20f.js","assets/TiledLayerView3D-7d5deb80.js","assets/ImageryTileLayerView-15bc95f1.js","assets/rasterProjectionHelper-664970f2.js","assets/popupUtils-54bd9deb.js","assets/LayerView-abbb3570.js","assets/RefreshableLayerView-e4d9e9c9.js","assets/drapedUtils-08d2401b.js","assets/sphere-d0e5285d.js","assets/mat3f64-50f3b9f6.js","assets/mat4f64-abdda1bb.js","assets/quatf64-f8f1c132.js","assets/Util-6d3f024a.js","assets/plane-5e2b046c.js","assets/spatialReferenceEllipsoidUtils-afb35af9.js","assets/scaleUtils-d13015f2.js","assets/ElevationSamplerData-e3118b17.js","assets/objectResourceUtils-782953c3.js","assets/devEnvironmentUtils-5002a058.js","assets/BufferView-379a78a4.js","assets/vec33-69c9e93b.js","assets/DefaultMaterial_COLOR_GAMMA-6ed76d86.js","assets/types-e1c0a5bf.js","assets/enums-e2e92c86.js","assets/Version-aa0a1d91.js","assets/quat-7b70e9a8.js","assets/resourceUtils-527631ac.js","assets/basicInterfaces-7449a8bf.js","assets/Indices-d8bff7b2.js","assets/NestedMap-1b5db22e.js","assets/requestImageUtils-d1ba3b36.js","assets/symbolColorUtils-c9d24716.js","assets/VertexAttribute-15d1866a.js","assets/doublePrecisionUtils-e3c3d0d8.js","assets/OrderIndependentTransparency-5f7257d7.js","assets/Texture-563cf5e5.js","assets/FramebufferObject-8b18fc0c.js","assets/VertexElementDescriptor-2925c6af.js","assets/InterleavedLayout-d57c91d0.js","assets/vec3f32-01c06d8d.js","assets/Octree-499541ed.js","assets/edgeProcessing-20e12367.js","assets/deduplicate-769a6f51.js","assets/MeshComponent-788e605a.js","assets/earcut-61f7b102.js","assets/imageUtils-c2d0d1ae.js","assets/projection-5969b753.js","assets/ZoomMomentumEstimator-ef57e6a4.js","assets/floatRGBA-ca2b39ca.js","assets/dehydratedFeatures-3a140d03.js","assets/quantizationUtils-b3b2ae2a.js","assets/labelFormatUtils-71e1f841.js","assets/orientedBoundingBox-a14b97b5.js","assets/quatf32-51a323b8.js","assets/SnappingCandidate-970faec6.js","assets/callExpressionWithFeature-df1a8f01.js","assets/DefaultVertexAttributeLayouts-5f20d8dd.js","assets/geometryServiceUtils-a536bb19.js","assets/project-909a4219.js","assets/LercDecoder-65586d50.js","assets/VectorTile-d41a1f0f.js","assets/enums-fb086c25.js","assets/config-1337d16e.js","assets/TiledDisplayObject-419c008b.js","assets/DisplayObject-87c37b69.js","assets/rasterUtils-7694cc98.js","assets/resources-7587d8f4.js","assets/workerHelper-6131d203.js","assets/webgl-debug-7f880832.js","assets/RenderingContext-0f21aa0e.js","assets/ProgramCache-f29c900e.js","assets/Program-77209250.js","assets/MediaLayer-4c42fc2f.js","assets/MediaElementView-06baa4d4.js","assets/normalizeUtilsSync-3ea564a9.js","assets/resourceExtension-f31d9f10.js","assets/BoundsStore-00da37da.js","assets/PooledRBush-5a11bc7e.js","assets/prism-line-numbers-eff41b13.js","assets/label2-a2f37e65.js","assets/interactive-1de2e238.js","assets/loadable-6afd516d.js","assets/t9n-81df3a71.js","assets/observers-c89705b8.js","assets/icon-8e47fbec.js","assets/loader-c773e800.js","assets/guid-51402ee7.js","assets/prism-line-numbers-7c5d72ff.css"]),"web-tile":ym,wfs:()=>_e(()=>import("./WFSLayerView3D-6fc941cf.js"),["assets/WFSLayerView3D-6fc941cf.js","assets/calcite-8912bd40.js","assets/index-00759e4a.js","assets/index-5026a37a.css","assets/calcite-96fa36fd.css","assets/FeatureLayerViewBase3D-6a29452c.js","assets/FeatureLikeLayerView3D-55d9655f.js","assets/geometryServiceUtils-a536bb19.js","assets/project-909a4219.js","assets/dehydratedFeatures-3a140d03.js","assets/quantizationUtils-b3b2ae2a.js","assets/dehydratedFeatureComparison-409d2bff.js","assets/queryForSymbologySnapping-f85651d3.js","assets/elevationInfoUtils-551ce894.js","assets/hash-0ddfbf4b.js","assets/Graphics3DObjectStates-8688d43e.js","assets/optimizedFeatureQueryEngineAdapter-b6d8def7.js","assets/centroid-bf48eee6.js","assets/PooledRBush-5a11bc7e.js","assets/basicInterfaces-7449a8bf.js","assets/floorFilterUtils-080a7cd2.js","assets/QueryEngine-dd47d379.js","assets/QueryEngineResult-dfcfeac3.js","assets/WhereClause-8339ee75.js","assets/executionError-fb3f283a.js","assets/utils-e5a50699.js","assets/generateRendererUtils-5b0c1ef7.js","assets/projectionSupport-d23d7a2d.js","assets/json-48e3ea08.js","assets/SnappingCandidate-970faec6.js","assets/utils-046b23b4.js","assets/QueryEngineCapabilities-42e44ded.js","assets/timeSupport-a3b9e468.js","assets/scaleUtils-d13015f2.js","assets/FeatureStore-b2e1c75d.js","assets/BoundsStore-00da37da.js","assets/symbolColorUtils-c9d24716.js","assets/objectResourceUtils-782953c3.js","assets/devEnvironmentUtils-5002a058.js","assets/mat3f64-50f3b9f6.js","assets/mat4f64-abdda1bb.js","assets/BufferView-379a78a4.js","assets/vec33-69c9e93b.js","assets/DefaultMaterial_COLOR_GAMMA-6ed76d86.js","assets/types-e1c0a5bf.js","assets/enums-e2e92c86.js","assets/Version-aa0a1d91.js","assets/quat-7b70e9a8.js","assets/quatf64-f8f1c132.js","assets/resourceUtils-527631ac.js","assets/Indices-d8bff7b2.js","assets/NestedMap-1b5db22e.js","assets/requestImageUtils-d1ba3b36.js","assets/Util-6d3f024a.js","assets/sphere-d0e5285d.js","assets/VertexAttribute-15d1866a.js","assets/doublePrecisionUtils-e3c3d0d8.js","assets/OrderIndependentTransparency-5f7257d7.js","assets/Texture-563cf5e5.js","assets/FramebufferObject-8b18fc0c.js","assets/VertexElementDescriptor-2925c6af.js","assets/InterleavedLayout-d57c91d0.js","assets/vec3f32-01c06d8d.js","assets/heatmapTextureUtils-56fc7bff.js","assets/projectExtentUtils-e8c7cde0.js","assets/LayerView3D-4128a20f.js","assets/LercDecoder-65586d50.js","assets/EventedSet-7ad75bee.js","assets/FeatureLayerView-36f7cadb.js","assets/popupUtils-54bd9deb.js","assets/LayerView-abbb3570.js","assets/RefreshableLayerView-e4d9e9c9.js","assets/plane-5e2b046c.js","assets/spatialReferenceEllipsoidUtils-afb35af9.js","assets/ElevationSamplerData-e3118b17.js","assets/Octree-499541ed.js","assets/edgeProcessing-20e12367.js","assets/deduplicate-769a6f51.js","assets/MeshComponent-788e605a.js","assets/earcut-61f7b102.js","assets/imageUtils-c2d0d1ae.js","assets/projection-5969b753.js","assets/ZoomMomentumEstimator-ef57e6a4.js","assets/floatRGBA-ca2b39ca.js","assets/labelFormatUtils-71e1f841.js","assets/orientedBoundingBox-a14b97b5.js","assets/quatf32-51a323b8.js","assets/callExpressionWithFeature-df1a8f01.js","assets/DefaultVertexAttributeLayouts-5f20d8dd.js","assets/VectorTile-d41a1f0f.js","assets/enums-fb086c25.js","assets/config-1337d16e.js","assets/TiledDisplayObject-419c008b.js","assets/DisplayObject-87c37b69.js","assets/rasterUtils-7694cc98.js","assets/resources-7587d8f4.js","assets/workerHelper-6131d203.js","assets/webgl-debug-7f880832.js","assets/RenderingContext-0f21aa0e.js","assets/ProgramCache-f29c900e.js","assets/Program-77209250.js","assets/MediaLayer-4c42fc2f.js","assets/MediaElementView-06baa4d4.js","assets/normalizeUtilsSync-3ea564a9.js","assets/resourceExtension-f31d9f10.js","assets/prism-line-numbers-eff41b13.js","assets/label2-a2f37e65.js","assets/interactive-1de2e238.js","assets/loadable-6afd516d.js","assets/t9n-81df3a71.js","assets/observers-c89705b8.js","assets/icon-8e47fbec.js","assets/loader-c773e800.js","assets/guid-51402ee7.js","assets/prism-line-numbers-7c5d72ff.css"]),wms:()=>_e(()=>import("./WMSLayerView3D-2f5cc0d8.js"),["assets/WMSLayerView3D-2f5cc0d8.js","assets/calcite-8912bd40.js","assets/index-00759e4a.js","assets/index-5026a37a.css","assets/calcite-96fa36fd.css","assets/DynamicLayerView3D-7a33cc06.js","assets/LayerView3D-4128a20f.js","assets/symbolColorUtils-c9d24716.js","assets/MeshComponent-788e605a.js","assets/earcut-61f7b102.js","assets/deduplicate-769a6f51.js","assets/Indices-d8bff7b2.js","assets/imageUtils-c2d0d1ae.js","assets/objectResourceUtils-782953c3.js","assets/devEnvironmentUtils-5002a058.js","assets/mat3f64-50f3b9f6.js","assets/mat4f64-abdda1bb.js","assets/BufferView-379a78a4.js","assets/vec33-69c9e93b.js","assets/DefaultMaterial_COLOR_GAMMA-6ed76d86.js","assets/types-e1c0a5bf.js","assets/enums-e2e92c86.js","assets/Version-aa0a1d91.js","assets/quat-7b70e9a8.js","assets/quatf64-f8f1c132.js","assets/resourceUtils-527631ac.js","assets/basicInterfaces-7449a8bf.js","assets/NestedMap-1b5db22e.js","assets/requestImageUtils-d1ba3b36.js","assets/Util-6d3f024a.js","assets/sphere-d0e5285d.js","assets/VertexAttribute-15d1866a.js","assets/doublePrecisionUtils-e3c3d0d8.js","assets/OrderIndependentTransparency-5f7257d7.js","assets/Texture-563cf5e5.js","assets/FramebufferObject-8b18fc0c.js","assets/VertexElementDescriptor-2925c6af.js","assets/InterleavedLayout-d57c91d0.js","assets/vec3f32-01c06d8d.js","assets/projectExtentUtils-e8c7cde0.js","assets/geometryServiceUtils-a536bb19.js","assets/project-909a4219.js","assets/ImageMaterial-e77d3ec9.js","assets/LayerView-abbb3570.js","assets/RefreshableLayerView-e4d9e9c9.js","assets/WMSLayerView-a3d25dbf.js","assets/ExportWMSImageParameters-d52d2b49.js","assets/plane-5e2b046c.js","assets/spatialReferenceEllipsoidUtils-afb35af9.js","assets/scaleUtils-d13015f2.js","assets/ElevationSamplerData-e3118b17.js","assets/Octree-499541ed.js","assets/edgeProcessing-20e12367.js","assets/projection-5969b753.js","assets/ZoomMomentumEstimator-ef57e6a4.js","assets/floatRGBA-ca2b39ca.js","assets/dehydratedFeatures-3a140d03.js","assets/quantizationUtils-b3b2ae2a.js","assets/labelFormatUtils-71e1f841.js","assets/orientedBoundingBox-a14b97b5.js","assets/quatf32-51a323b8.js","assets/SnappingCandidate-970faec6.js","assets/callExpressionWithFeature-df1a8f01.js","assets/DefaultVertexAttributeLayouts-5f20d8dd.js","assets/LercDecoder-65586d50.js","assets/VectorTile-d41a1f0f.js","assets/enums-fb086c25.js","assets/config-1337d16e.js","assets/TiledDisplayObject-419c008b.js","assets/DisplayObject-87c37b69.js","assets/rasterUtils-7694cc98.js","assets/resources-7587d8f4.js","assets/workerHelper-6131d203.js","assets/webgl-debug-7f880832.js","assets/RenderingContext-0f21aa0e.js","assets/ProgramCache-f29c900e.js","assets/Program-77209250.js","assets/MediaLayer-4c42fc2f.js","assets/MediaElementView-06baa4d4.js","assets/normalizeUtilsSync-3ea564a9.js","assets/resourceExtension-f31d9f10.js","assets/BoundsStore-00da37da.js","assets/PooledRBush-5a11bc7e.js","assets/prism-line-numbers-eff41b13.js","assets/label2-a2f37e65.js","assets/interactive-1de2e238.js","assets/loadable-6afd516d.js","assets/t9n-81df3a71.js","assets/observers-c89705b8.js","assets/icon-8e47fbec.js","assets/loader-c773e800.js","assets/guid-51402ee7.js","assets/prism-line-numbers-7c5d72ff.css"]),wmts:()=>_e(()=>import("./WMTSLayerView3D-e3aed4af.js"),["assets/WMTSLayerView3D-e3aed4af.js","assets/calcite-8912bd40.js","assets/index-00759e4a.js","assets/index-5026a37a.css","assets/calcite-96fa36fd.css","assets/LayerView3D-4128a20f.js","assets/TiledLayerView3D-7d5deb80.js","assets/LayerView-abbb3570.js","assets/RefreshableLayerView-e4d9e9c9.js","assets/sphere-d0e5285d.js","assets/mat3f64-50f3b9f6.js","assets/mat4f64-abdda1bb.js","assets/quatf64-f8f1c132.js","assets/Util-6d3f024a.js","assets/plane-5e2b046c.js","assets/spatialReferenceEllipsoidUtils-afb35af9.js","assets/scaleUtils-d13015f2.js","assets/ElevationSamplerData-e3118b17.js","assets/objectResourceUtils-782953c3.js","assets/devEnvironmentUtils-5002a058.js","assets/BufferView-379a78a4.js","assets/vec33-69c9e93b.js","assets/DefaultMaterial_COLOR_GAMMA-6ed76d86.js","assets/types-e1c0a5bf.js","assets/enums-e2e92c86.js","assets/Version-aa0a1d91.js","assets/quat-7b70e9a8.js","assets/resourceUtils-527631ac.js","assets/basicInterfaces-7449a8bf.js","assets/Indices-d8bff7b2.js","assets/NestedMap-1b5db22e.js","assets/requestImageUtils-d1ba3b36.js","assets/symbolColorUtils-c9d24716.js","assets/VertexAttribute-15d1866a.js","assets/doublePrecisionUtils-e3c3d0d8.js","assets/OrderIndependentTransparency-5f7257d7.js","assets/Texture-563cf5e5.js","assets/FramebufferObject-8b18fc0c.js","assets/VertexElementDescriptor-2925c6af.js","assets/InterleavedLayout-d57c91d0.js","assets/vec3f32-01c06d8d.js","assets/Octree-499541ed.js","assets/edgeProcessing-20e12367.js","assets/deduplicate-769a6f51.js","assets/MeshComponent-788e605a.js","assets/earcut-61f7b102.js","assets/imageUtils-c2d0d1ae.js","assets/projection-5969b753.js","assets/ZoomMomentumEstimator-ef57e6a4.js","assets/floatRGBA-ca2b39ca.js","assets/dehydratedFeatures-3a140d03.js","assets/quantizationUtils-b3b2ae2a.js","assets/labelFormatUtils-71e1f841.js","assets/orientedBoundingBox-a14b97b5.js","assets/quatf32-51a323b8.js","assets/SnappingCandidate-970faec6.js","assets/callExpressionWithFeature-df1a8f01.js","assets/DefaultVertexAttributeLayouts-5f20d8dd.js","assets/geometryServiceUtils-a536bb19.js","assets/project-909a4219.js","assets/LercDecoder-65586d50.js","assets/VectorTile-d41a1f0f.js","assets/enums-fb086c25.js","assets/config-1337d16e.js","assets/TiledDisplayObject-419c008b.js","assets/DisplayObject-87c37b69.js","assets/rasterUtils-7694cc98.js","assets/resources-7587d8f4.js","assets/workerHelper-6131d203.js","assets/webgl-debug-7f880832.js","assets/RenderingContext-0f21aa0e.js","assets/ProgramCache-f29c900e.js","assets/Program-77209250.js","assets/MediaLayer-4c42fc2f.js","assets/MediaElementView-06baa4d4.js","assets/normalizeUtilsSync-3ea564a9.js","assets/resourceExtension-f31d9f10.js","assets/BoundsStore-00da37da.js","assets/PooledRBush-5a11bc7e.js","assets/prism-line-numbers-eff41b13.js","assets/label2-a2f37e65.js","assets/interactive-1de2e238.js","assets/loadable-6afd516d.js","assets/t9n-81df3a71.js","assets/observers-c89705b8.js","assets/icon-8e47fbec.js","assets/loader-c773e800.js","assets/guid-51402ee7.js","assets/prism-line-numbers-7c5d72ff.css"]),"geo-rss":null,kml:null,"knowledge-graph":null,"link-chart":null,"knowledge-graph-sublayer":null,"map-notes":null,"subtype-group":null,unknown:null,unsupported:null};function tz(i){const e=i.declaredClass?i.declaredClass.slice(i.declaredClass.lastIndexOf(".")+1):"Unknown",t=e.replace(/([a-z])([A-Z])/g,"$1-$2").toLowerCase();return new bt(`${t}:view-not-supported`,`${e} is not supported in 3D`)}const E2={hasLayerViewModule:i=>g(R2[i.type]),importLayerView:i=>{const e=R2[i.type];if(P(e))throw tz(i);return e(i)}},A2="analyses-owner-handles";var up,hd;(function(i){i[i.PENDING=0]="PENDING",i[i.CREATED=1]="CREATED"})(up||(up={})),function(i){i[i.ADDED=0]="ADDED",i[i.REMOVED=1]="REMOVED"}(hd||(hd={}));let td=class extends v4{constructor(e){super(e),this._allAnalysisViews=new Od,this._creatingViewCount=0,this._items=new Map,this._scheduledUpdateHandle=null,this._attachedToViewResolver=M2(),this._analysisModules={"area-measurement":{module:null},dimension:{module:null},"direct-line-measurement":{module:null},"line-of-sight":{module:null},slice:{module:null}}}destroy(){this._disconnectOwners(),this._attachedToViewResolver.reject(ea("AnalysisViewManager was destroyed"))}attach(){this._connectOwners(),this._attachedToViewResolver.resolve()}detach(){this._disconnectOwners(),this._attachedToViewResolver.reject(ea()),this._attachedToViewResolver=M2()}get updating(){return!this.view.ready||this._creatingViewCount!==0||this._allAnalysisViews.some(e=>e.updating)}get testInfo(){return{allAnalysisViews:this._allAnalysisViews}}async whenAnalysisView(e){await this._attachedToViewResolver.promise;const t=this._items.get(e);if(P(t)||t.state.list===hd.REMOVED)throw new bt("AnalysisViewManager:no-analysisview-for-analysis","The analysis has not been added to view.analyses",{analysis:e});return t.createAnalysisViewTask.promise}_connectOwners(){this.handles.add(this._connectAnalysesCollection(this.view.analyses),A2)}_disconnectOwners(){this.handles.remove(A2),this._update(),this._creatingViewCount=0}_connectAnalysesCollection(e){for(const s of e)this._addAnalysis(s);const t=e.on("after-add",s=>this._addAnalysis(s.item)),r=e.on("after-remove",s=>this._removeAnalysis(s.item));return{remove:()=>{t.remove(),r.remove();for(const s of e)this._removeAnalysis(s)}}}_addAnalysis(e){const t=this._items.get(e);if(t==null){const r={state:{view:up.PENDING,list:hd.ADDED},analysis:e,view:null,createAnalysisViewTask:null};this._items.set(e,r),r.createAnalysisViewTask=rT(s=>this._createAnalysisViewPromise(r,s))}else t.state.list=hd.ADDED}_removeAnalysis(e){const t=this._items.get(e);t!=null?(t.state.list=hd.REMOVED,this._scheduleUpdate()):Pe.getLogger(this.declaredClass).error("Trying to remove analysis which was not added")}_scheduleUpdate(){g(this._scheduledUpdateHandle)||(this._scheduledUpdateHandle=b4(()=>this._update()))}_update(){this._scheduledUpdateHandle=fo(this._scheduledUpdateHandle),this._items.forEach(e=>{if(e.state.list===hd.REMOVED)switch(this._items.delete(e.analysis),e.state.view){case up.PENDING:e.createAnalysisViewTask=Th(e.createAnalysisViewTask);break;case up.CREATED:g(e.view)&&(this._allAnalysisViews.remove(e.view),e.view=Te(e.view),e.createAnalysisViewTask=null)}})}async _createAnalysisViewPromise(e,t){const r=e.analysis,s=r.type,a=this._analysisModules[s];if(this._creatingViewCount+=1,P(a.module))try{a.module=await this._loadAnalysisModule(s)}catch(o){throw this._creatingViewCount-=1,o}if(Qo(t))throw this._creatingViewCount-=1,ea("AnalysisView creation aborted");const n=new a.module.default({analysis:r,view:this.view});try{await n.when()}catch(o){throw this._creatingViewCount-=1,o}if(Qo(t))throw this._creatingViewCount-=1,n.destroy(),ea("AnalysisView creation aborted");return e.view=n,e.state.view=up.CREATED,this._allAnalysisViews.add(n),this._creatingViewCount-=1,n}_loadAnalysisModule(e){switch(e){case"area-measurement":return _e(()=>import("./AreaMeasurementAnalysisView3D-d5d94eb3.js").then(t=>t.A),["assets/AreaMeasurementAnalysisView3D-d5d94eb3.js","assets/calcite-8912bd40.js","assets/index-00759e4a.js","assets/index-5026a37a.css","assets/calcite-96fa36fd.css","assets/analysisThemeUtils-73a6aa2d.js","assets/Segment-499df512.js","assets/LineVisualElement-b0e5ebeb.js","assets/mat4f64-abdda1bb.js","assets/objectResourceUtils-782953c3.js","assets/devEnvironmentUtils-5002a058.js","assets/mat3f64-50f3b9f6.js","assets/BufferView-379a78a4.js","assets/vec33-69c9e93b.js","assets/DefaultMaterial_COLOR_GAMMA-6ed76d86.js","assets/types-e1c0a5bf.js","assets/enums-e2e92c86.js","assets/Version-aa0a1d91.js","assets/quat-7b70e9a8.js","assets/quatf64-f8f1c132.js","assets/resourceUtils-527631ac.js","assets/basicInterfaces-7449a8bf.js","assets/Indices-d8bff7b2.js","assets/NestedMap-1b5db22e.js","assets/requestImageUtils-d1ba3b36.js","assets/symbolColorUtils-c9d24716.js","assets/Util-6d3f024a.js","assets/sphere-d0e5285d.js","assets/VertexAttribute-15d1866a.js","assets/doublePrecisionUtils-e3c3d0d8.js","assets/OrderIndependentTransparency-5f7257d7.js","assets/Texture-563cf5e5.js","assets/FramebufferObject-8b18fc0c.js","assets/VertexElementDescriptor-2925c6af.js","assets/InterleavedLayout-d57c91d0.js","assets/vec3f32-01c06d8d.js","assets/dehydratedFeatures-3a140d03.js","assets/quantizationUtils-b3b2ae2a.js","assets/elevationInfoUtils-551ce894.js","assets/spatialReferenceEllipsoidUtils-afb35af9.js","assets/geometryEngine-4d106848.js","assets/geometryEngineBase-e1a33b0a.js","assets/hydrated-4aa5a9fa.js","assets/earcut-61f7b102.js","assets/plane-5e2b046c.js","assets/EditGeometryOperations-f7a23176.js"]);case"dimension":return _e(()=>import("./DimensionAnalysisView3D-96b9bbd9.js").then(t=>t.D),["assets/DimensionAnalysisView3D-96b9bbd9.js","assets/calcite-8912bd40.js","assets/index-00759e4a.js","assets/index-5026a37a.css","assets/calcite-96fa36fd.css","assets/LineVisualElement-b0e5ebeb.js","assets/mat4f64-abdda1bb.js","assets/objectResourceUtils-782953c3.js","assets/devEnvironmentUtils-5002a058.js","assets/mat3f64-50f3b9f6.js","assets/BufferView-379a78a4.js","assets/vec33-69c9e93b.js","assets/DefaultMaterial_COLOR_GAMMA-6ed76d86.js","assets/types-e1c0a5bf.js","assets/enums-e2e92c86.js","assets/Version-aa0a1d91.js","assets/quat-7b70e9a8.js","assets/quatf64-f8f1c132.js","assets/resourceUtils-527631ac.js","assets/basicInterfaces-7449a8bf.js","assets/Indices-d8bff7b2.js","assets/NestedMap-1b5db22e.js","assets/requestImageUtils-d1ba3b36.js","assets/symbolColorUtils-c9d24716.js","assets/Util-6d3f024a.js","assets/sphere-d0e5285d.js","assets/VertexAttribute-15d1866a.js","assets/doublePrecisionUtils-e3c3d0d8.js","assets/OrderIndependentTransparency-5f7257d7.js","assets/Texture-563cf5e5.js","assets/FramebufferObject-8b18fc0c.js","assets/VertexElementDescriptor-2925c6af.js","assets/InterleavedLayout-d57c91d0.js","assets/vec3f32-01c06d8d.js","assets/LengthDimension-ebecad1f.js","assets/Segment-499df512.js","assets/dehydratedFeatures-3a140d03.js","assets/quantizationUtils-b3b2ae2a.js","assets/elevationInfoUtils-551ce894.js","assets/spatialReferenceEllipsoidUtils-afb35af9.js","assets/plane-5e2b046c.js","assets/analysisViewUtils-1aeb817c.js","assets/ImageMaterial-e77d3ec9.js","assets/Factory-befbd753.js","assets/DefaultVertexAttributeLayouts-5f20d8dd.js","assets/Octree-499541ed.js","assets/RightAngleQuadVisualElement-10d61437.js","assets/VisualElementResources-b14774ca.js","assets/PointVisualElement-18444051.js","assets/edgeProcessing-20e12367.js","assets/deduplicate-769a6f51.js","assets/MeshComponent-788e605a.js","assets/earcut-61f7b102.js","assets/imageUtils-c2d0d1ae.js","assets/colorUtils-c0f43caf.js","assets/EditGeometryOperations-f7a23176.js","assets/QueryEngineResult-dfcfeac3.js","assets/WhereClause-8339ee75.js","assets/executionError-fb3f283a.js","assets/utils-e5a50699.js","assets/generateRendererUtils-5b0c1ef7.js","assets/projectionSupport-d23d7a2d.js","assets/json-48e3ea08.js","assets/SnappingCandidate-970faec6.js","assets/utils-046b23b4.js","assets/dehydratedFeatureComparison-409d2bff.js","assets/RenderTexture-6105e069.js"]);case"direct-line-measurement":return _e(()=>import("./DirectLineMeasurementAnalysisView3D-e2840162.js").then(t=>t.D),["assets/DirectLineMeasurementAnalysisView3D-e2840162.js","assets/calcite-8912bd40.js","assets/index-00759e4a.js","assets/index-5026a37a.css","assets/calcite-96fa36fd.css","assets/analysisThemeUtils-73a6aa2d.js","assets/Segment-499df512.js","assets/LineVisualElement-b0e5ebeb.js","assets/mat4f64-abdda1bb.js","assets/objectResourceUtils-782953c3.js","assets/devEnvironmentUtils-5002a058.js","assets/mat3f64-50f3b9f6.js","assets/BufferView-379a78a4.js","assets/vec33-69c9e93b.js","assets/DefaultMaterial_COLOR_GAMMA-6ed76d86.js","assets/types-e1c0a5bf.js","assets/enums-e2e92c86.js","assets/Version-aa0a1d91.js","assets/quat-7b70e9a8.js","assets/quatf64-f8f1c132.js","assets/resourceUtils-527631ac.js","assets/basicInterfaces-7449a8bf.js","assets/Indices-d8bff7b2.js","assets/NestedMap-1b5db22e.js","assets/requestImageUtils-d1ba3b36.js","assets/symbolColorUtils-c9d24716.js","assets/Util-6d3f024a.js","assets/sphere-d0e5285d.js","assets/VertexAttribute-15d1866a.js","assets/doublePrecisionUtils-e3c3d0d8.js","assets/OrderIndependentTransparency-5f7257d7.js","assets/Texture-563cf5e5.js","assets/FramebufferObject-8b18fc0c.js","assets/VertexElementDescriptor-2925c6af.js","assets/InterleavedLayout-d57c91d0.js","assets/vec3f32-01c06d8d.js","assets/dehydratedFeatures-3a140d03.js","assets/quantizationUtils-b3b2ae2a.js","assets/elevationInfoUtils-551ce894.js","assets/spatialReferenceEllipsoidUtils-afb35af9.js","assets/geometryEngine-4d106848.js","assets/geometryEngineBase-e1a33b0a.js","assets/hydrated-4aa5a9fa.js","assets/RightAngleQuadVisualElement-10d61437.js","assets/VisualElementResources-b14774ca.js"]);case"line-of-sight":return _e(()=>import("./LineOfSightAnalysisView3D-2e65289b.js"),["assets/LineOfSightAnalysisView3D-2e65289b.js","assets/calcite-8912bd40.js","assets/index-00759e4a.js","assets/index-5026a37a.css","assets/calcite-96fa36fd.css","assets/LineVisualElement-b0e5ebeb.js","assets/mat4f64-abdda1bb.js","assets/objectResourceUtils-782953c3.js","assets/devEnvironmentUtils-5002a058.js","assets/mat3f64-50f3b9f6.js","assets/BufferView-379a78a4.js","assets/vec33-69c9e93b.js","assets/DefaultMaterial_COLOR_GAMMA-6ed76d86.js","assets/types-e1c0a5bf.js","assets/enums-e2e92c86.js","assets/Version-aa0a1d91.js","assets/quat-7b70e9a8.js","assets/quatf64-f8f1c132.js","assets/resourceUtils-527631ac.js","assets/basicInterfaces-7449a8bf.js","assets/Indices-d8bff7b2.js","assets/NestedMap-1b5db22e.js","assets/requestImageUtils-d1ba3b36.js","assets/symbolColorUtils-c9d24716.js","assets/Util-6d3f024a.js","assets/sphere-d0e5285d.js","assets/VertexAttribute-15d1866a.js","assets/doublePrecisionUtils-e3c3d0d8.js","assets/OrderIndependentTransparency-5f7257d7.js","assets/Texture-563cf5e5.js","assets/FramebufferObject-8b18fc0c.js","assets/VertexElementDescriptor-2925c6af.js","assets/InterleavedLayout-d57c91d0.js","assets/vec3f32-01c06d8d.js","assets/LineOfSightAnalysisTarget-91a38e61.js","assets/persistable-cb99c020.js","assets/multiOriginJSONSupportUtils-c978f4c3.js","assets/resourceExtension-f31d9f10.js","assets/elevationInfoUtils-551ce894.js","assets/dehydratedFeatures-3a140d03.js","assets/quantizationUtils-b3b2ae2a.js","assets/analysisViewUtils-1aeb817c.js","assets/plane-5e2b046c.js","assets/ImageMaterial-e77d3ec9.js","assets/PointVisualElement-18444051.js","assets/Octree-499541ed.js","assets/edgeProcessing-20e12367.js","assets/deduplicate-769a6f51.js","assets/MeshComponent-788e605a.js","assets/earcut-61f7b102.js","assets/imageUtils-c2d0d1ae.js","assets/VisualElementResources-b14774ca.js","assets/spatialReferenceEllipsoidUtils-afb35af9.js","assets/scaleUtils-d13015f2.js","assets/ElevationSamplerData-e3118b17.js","assets/projection-5969b753.js","assets/ZoomMomentumEstimator-ef57e6a4.js","assets/floatRGBA-ca2b39ca.js","assets/labelFormatUtils-71e1f841.js","assets/orientedBoundingBox-a14b97b5.js","assets/quatf32-51a323b8.js","assets/SnappingCandidate-970faec6.js","assets/callExpressionWithFeature-df1a8f01.js","assets/DefaultVertexAttributeLayouts-5f20d8dd.js","assets/geometryServiceUtils-a536bb19.js","assets/project-909a4219.js","assets/LercDecoder-65586d50.js","assets/VectorTile-d41a1f0f.js","assets/enums-fb086c25.js","assets/config-1337d16e.js","assets/TiledDisplayObject-419c008b.js","assets/DisplayObject-87c37b69.js","assets/rasterUtils-7694cc98.js","assets/resources-7587d8f4.js","assets/workerHelper-6131d203.js","assets/webgl-debug-7f880832.js","assets/RenderingContext-0f21aa0e.js","assets/ProgramCache-f29c900e.js","assets/Program-77209250.js","assets/MediaLayer-4c42fc2f.js","assets/MediaElementView-06baa4d4.js","assets/normalizeUtilsSync-3ea564a9.js","assets/BoundsStore-00da37da.js","assets/PooledRBush-5a11bc7e.js","assets/prism-line-numbers-eff41b13.js","assets/label2-a2f37e65.js","assets/interactive-1de2e238.js","assets/loadable-6afd516d.js","assets/t9n-81df3a71.js","assets/observers-c89705b8.js","assets/icon-8e47fbec.js","assets/loader-c773e800.js","assets/guid-51402ee7.js","assets/prism-line-numbers-7c5d72ff.css"]);case"slice":return _e(()=>import("./SliceAnalysisView3D-2df07c34.js").then(t=>t.S),["assets/SliceAnalysisView3D-2df07c34.js","assets/calcite-8912bd40.js","assets/index-00759e4a.js","assets/index-5026a37a.css","assets/calcite-96fa36fd.css","assets/LineVisualElement-b0e5ebeb.js","assets/mat4f64-abdda1bb.js","assets/objectResourceUtils-782953c3.js","assets/devEnvironmentUtils-5002a058.js","assets/mat3f64-50f3b9f6.js","assets/BufferView-379a78a4.js","assets/vec33-69c9e93b.js","assets/DefaultMaterial_COLOR_GAMMA-6ed76d86.js","assets/types-e1c0a5bf.js","assets/enums-e2e92c86.js","assets/Version-aa0a1d91.js","assets/quat-7b70e9a8.js","assets/quatf64-f8f1c132.js","assets/resourceUtils-527631ac.js","assets/basicInterfaces-7449a8bf.js","assets/Indices-d8bff7b2.js","assets/NestedMap-1b5db22e.js","assets/requestImageUtils-d1ba3b36.js","assets/symbolColorUtils-c9d24716.js","assets/Util-6d3f024a.js","assets/sphere-d0e5285d.js","assets/VertexAttribute-15d1866a.js","assets/doublePrecisionUtils-e3c3d0d8.js","assets/OrderIndependentTransparency-5f7257d7.js","assets/Texture-563cf5e5.js","assets/FramebufferObject-8b18fc0c.js","assets/VertexElementDescriptor-2925c6af.js","assets/InterleavedLayout-d57c91d0.js","assets/vec3f32-01c06d8d.js","assets/persistable-cb99c020.js","assets/multiOriginJSONSupportUtils-c978f4c3.js","assets/resourceExtension-f31d9f10.js","assets/BuildingComponentSublayer-47c7091c.js","assets/capabilities-a18453f6.js","assets/I3SIndexInfo-eecf1e00.js","assets/I3SLayerDefinitions-edc5d4c2.js","assets/I3SUtil-930fc7a4.js","assets/quatf32-51a323b8.js","assets/spatialReferenceEllipsoidUtils-afb35af9.js","assets/I3SBinaryReader-533328a5.js","assets/orientedBoundingBox-a14b97b5.js","assets/plane-5e2b046c.js","assets/popupUtils-54bd9deb.js","assets/analysisViewUtils-1aeb817c.js","assets/ImageMaterial-e77d3ec9.js","assets/Factory-befbd753.js"])}}};function M2(){const i=Uf();return i.promise.catch(()=>{}),i}d([v()],td.prototype,"updating",null),d([v({constructOnly:!0})],td.prototype,"view",void 0),d([v()],td.prototype,"_allAnalysisViews",void 0),d([v()],td.prototype,"_creatingViewCount",void 0),td=d([Y("esri.views.3d.analysis.AnalysisViewManager3D")],td);const iz=td;let Dl=class extends Ie{constructor(e){super(e),this.collision=new Qm,this.distance=1/0,this.minimumPoiDistance=4,this.tilt=null}get altitude(){return this.mode===ve.Local?null:this._get("altitude")||null}set altitude(e){this.mode!==ve.Local?this._set("altitude",e):Pe.getLogger(this.declaredClass).warn("Altitude constraint is ignored in local scenes")}clampAltitude(e){return this.altitude?ee(e,this.altitude.min,this.altitude.max):e}clampTilt(e,t){if(!this.tilt)return t;const r=this.tilt(e);return ee(t,r.min,r.max)}clampDistance(e){return Math.min(e,this.distance)}createDefaultTilt(){return this.mode===ve.Local?this._createDefaultTiltLocal():this._createDefaultTiltGlobal()}createConstantMaxTilt(e){return(t,r=C1)=>(r.min=Wr.min,r.max=e,r)}_createDefaultTiltLocal(){const e=this.collision.enabled?I0([[4e3,Wr.max],[1e4,ut(88)],[6e6,ut(88)]]):()=>Wr.max;return(t,r=C1)=>(r.min=Wr.min,r.max=e(t),r)}_createDefaultTiltGlobal(){const e=this.collision.enabled?I0([[4e3,Wr.max],[5e4,ut(88)],[6e6,ut(88)],[2e7,Wr.min]]):I0([[3e5,Wr.max],[3e6,ut(88)],[6e6,ut(88)],[2e7,Wr.min]]);return(t,r=C1)=>(r.min=Wr.min,r.max=e(t),r)}};function rz(i){return{min:-2e5,max:4*i.radius}}d([v()],Dl.prototype,"altitude",null),d([v({readOnly:!0})],Dl.prototype,"collision",void 0),d([v()],Dl.prototype,"distance",void 0),d([v({readOnly:!0})],Dl.prototype,"minimumPoiDistance",void 0),d([v()],Dl.prototype,"tilt",void 0),d([v({constructOnly:!0})],Dl.prototype,"mode",void 0),Dl=d([Y("esri.views.3d.state.Constraints")],Dl);const D2=rz(Ys),Wr={min:ut(.5),max:ut(179.5)},C1={min:0,max:0};let Qm=class extends Ie{constructor(){super(...arguments),this.enabled=!0,this.elevationMargin=5}};d([v({type:Boolean})],Qm.prototype,"enabled",void 0),d([v({type:Number})],Qm.prototype,"elevationMargin",void 0),Qm=d([Y("esri.views.3d.state.Constraints.CollisionConstraint")],Qm);let pp=class extends Ie{constructor(){super(...arguments),this.min=D2.min,this.max=D2.max}};d([v({type:Number})],pp.prototype,"min",void 0),d([v({type:Number})],pp.prototype,"max",void 0),pp=d([Y("esri.views.3d.constraints.AltitudeConstraint")],pp);let $l=class extends Ie{constructor(){super(...arguments),this.mode="auto"}get near(){return this._get("near")}set near(e){this._set("near",e),e>=this._get("far")&&(this.far=e+1e-9),this.mode="manual"}castNear(e){return Math.max(1e-8,e)}get far(){return this._get("far")}set far(e){this._set("far",e),e<=this._get("near")&&(this.near=e-1e-9),this.mode="manual"}castFar(e){return Math.max(1e-8,e)}autoUpdate(e,t){this.mode==="auto"&&(this._get("near")!==e&&this._set("near",e),this._get("far")!==t&&this._set("far",t))}};d([v({type:Number,value:1e-8})],$l.prototype,"near",null),d([Gg("near")],$l.prototype,"castNear",null),d([v({type:Number,value:1e-8})],$l.prototype,"far",null),d([Gg("far")],$l.prototype,"castFar",null),d([v({type:["auto","manual"]})],$l.prototype,"mode",void 0),$l=d([Y("esri.views.3d.constraints.ClipDistanceConstraint")],$l);const Lx={min:ln(Wr.min),max:ln(Wr.max)};let dd=class extends Ie{constructor(){super(...arguments),this.mode="auto"}get max(){return this._get("max")}set max(e){this._set("max",e),this.mode="manual"}castMax(e){return ee(e,Lx.min,Lx.max)}autoUpdate(e){this.mode==="auto"&&this._get("max")!==e&&this._set("max",e)}};d([v({type:["auto","manual"]})],dd.prototype,"mode",void 0),d([v({type:Number,value:Lx.max})],dd.prototype,"max",null),d([Gg("max")],dd.prototype,"castMax",null),dd=d([Y("esri.views.3d.constraints.TiltConstraint")],dd);let ud=class extends Ie{constructor(){super(...arguments),this.tilt=new dd,this.altitude=new pp,this.clipDistance=new $l}};d([v({type:dd})],ud.prototype,"tilt",void 0),d([v({type:pp})],ud.prototype,"altitude",void 0),d([v({type:$l})],ud.prototype,"clipDistance",void 0),ud=d([Y("esri.views.3d.constraints.Constraints")],ud);var $x;let mn=$x=class extends tc{constructor(i){super(i),this.type="sun",this.date=null,this.directShadowsEnabled=!1,this.displayUTCOffset=null}readDate(i,e){return e.datetime!=null&&new Date(e.datetime)||null}writeDate(i,e,t){e[t]=i.getTime()}readDirectShadowsEnabled(i,e){return!!e.directShadows}writedirectShadowsEnabled(i,e,t){i&&(e[t]=i)}writeDisplayUTCOffset(i,e){i!=null&&(e.displayUTCOffset=i)}clone(){return new $x(this.cloneConstructProperties())}cloneConstructProperties(){const i={directShadowsEnabled:this.directShadowsEnabled,displayUTCOffset:this.displayUTCOffset!=null?this.displayUTCOffset:null};return this.date!=null&&(i.date=new Date(this.date.getTime())),i}};d([v({readOnly:!0,type:["sun"],json:{write:!0}})],mn.prototype,"type",void 0),d([v({type:Date,json:{type:Number,write:{target:"datetime"}}})],mn.prototype,"date",void 0),d([LS("date",["datetime"])],mn.prototype,"readDate",null),d([a1("date")],mn.prototype,"writeDate",null),d([v({type:Boolean,json:{default:!1,write:{target:"directShadows"}}})],mn.prototype,"directShadowsEnabled",void 0),d([LS("directShadowsEnabled",["directShadows"])],mn.prototype,"readDirectShadowsEnabled",null),d([a1("directShadowsEnabled")],mn.prototype,"writedirectShadowsEnabled",null),d([v({type:Number,json:{write:!0}})],mn.prototype,"displayUTCOffset",void 0),d([a1("displayUTCOffset")],mn.prototype,"writeDisplayUTCOffset",null),mn=$x=d([Y("esri.webscene.SunLighting")],mn);const df=mn;var Ju;let Uo=Ju=class extends Ms.EventedMixin(df){constructor(i){super(i),this.cameraTrackingEnabled=!0,this.ambientOcclusionEnabled=!1,this.waterReflectionEnabled=!1,this.positionTimezoneInfo={hours:0,minutes:0,seconds:0,autoUpdated:!0};const e=new Date().getFullYear(),t=new Date("March 15, "+e+" 12:00:00 UTC");this._set("defaultDate",t),this._set("date",t)}get defaultDate(){return new Date(this._get("defaultDate").getTime())}static fromWebsceneLighting(i){return new Ju(i.cloneConstructProperties())}set defaultDate(i){const e=this._get("date")===this._get("defaultDate");i=new Date(i.getTime()),this._set("defaultDate",i),e&&this._set("date",i)}set date(i){i!=null&&(this.positionTimezoneInfo.autoUpdated=!1,this._set("date",new Date(i.getTime())))}autoUpdate(i,e){const t=Ju.calculateTimezoneOffset(this.positionTimezoneInfo);this.positionTimezoneInfo.hours=e.hours,this.positionTimezoneInfo.minutes=e.minutes,this.positionTimezoneInfo.seconds=e.seconds;let r=null;g(i)&&(this.positionTimezoneInfo.autoUpdated=!0,isNaN(i.getTime())?(r=this.defaultDate.getTime(),this._set("date",this.defaultDate)):(r=this.date&&this.date.getTime(),this._set("date",new Date(i.getTime()))));const s=Ju.calculateTimezoneOffset(this.positionTimezoneInfo);if(t!==s&&(S1.target=this,S1.timezoneOffset=s,this.emit("timezone-will-change",S1)),g(i))return!!isNaN(i.getTime())||r!==i.getTime()}clone(){const i=this._get("date")===this._get("defaultDate"),e=new Ju({...this.cloneConstructProperties(),defaultDate:this.defaultDate,cameraTrackingEnabled:this.cameraTrackingEnabled,ambientOcclusionEnabled:this.ambientOcclusionEnabled,waterReflectionEnabled:this.waterReflectionEnabled});return i&&e._set("date",e._get("defaultDate")),e.positionTimezoneInfo.autoUpdated=this.positionTimezoneInfo.autoUpdated,e.positionTimezoneInfo.hours=this.positionTimezoneInfo.hours,e.positionTimezoneInfo.minutes=this.positionTimezoneInfo.minutes,e.positionTimezoneInfo.seconds=this.positionTimezoneInfo.seconds,e}cloneWithWebsceneLighting(i){const e=this.clone();return i.date!=null&&(e.date=i.date),e.directShadowsEnabled=i.directShadowsEnabled,e.displayUTCOffset=i.displayUTCOffset,e}cloneNonPersistentConstructProperties(){return{ambientOcclusionEnabled:this.ambientOcclusionEnabled,waterReflectionEnabled:this.waterReflectionEnabled,cameraTrackingEnabled:this.cameraTrackingEnabled}}};d([v({type:Boolean})],Uo.prototype,"cameraTrackingEnabled",void 0),d([v({type:Boolean})],Uo.prototype,"ambientOcclusionEnabled",void 0),d([v({type:Boolean})],Uo.prototype,"waterReflectionEnabled",void 0),d([v({type:Date})],Uo.prototype,"defaultDate",null),d([v({type:Date})],Uo.prototype,"date",null),Uo=Ju=d([Y("esri.views.3d.environment.SunLighting")],Uo),function(i){function e({hours:t,minutes:r,seconds:s}){return Math.round(t+r/60+s/3600)}i.calculateTimezoneOffset=e}(Uo||(Uo={}));const S1={target:null,timezoneOffset:0},Fc=Uo;var Nx;let Zm=Nx=class extends tc{constructor(i){super(i),this.type="virtual",this.directShadowsEnabled=!1}clone(){return new Nx(this.cloneConstructProperties())}cloneConstructProperties(){return{directShadowsEnabled:this.directShadowsEnabled}}};d([v({readOnly:!0,type:["virtual"],json:{write:!0}})],Zm.prototype,"type",void 0),d([v({type:Boolean,json:{default:!1,name:"directShadows",write:!0}})],Zm.prototype,"directShadowsEnabled",void 0),Zm=Nx=d([Y("esri.webscene.VirtualLighting")],Zm);const Pv=Zm;var L0;let ep=L0=class extends Ms.EventedMixin(Pv){constructor(i){super(i),this.ambientOcclusionEnabled=!1,this.waterReflectionEnabled=!1,this.cameraTrackingEnabled=!0}clone(){return new L0({...this.cloneConstructProperties(),ambientOcclusionEnabled:this.ambientOcclusionEnabled,waterReflectionEnabled:this.waterReflectionEnabled,cameraTrackingEnabled:this.cameraTrackingEnabled})}static fromWebsceneLighting(i){return new L0(i.cloneConstructProperties())}cloneWithWebsceneLighting(i){const e=this.clone();return e.directShadowsEnabled=i.directShadowsEnabled,e}cloneNonPersistentConstructProperties(){return{ambientOcclusionEnabled:this.ambientOcclusionEnabled,waterReflectionEnabled:this.waterReflectionEnabled,cameraTrackingEnabled:this.cameraTrackingEnabled}}};d([v({type:Boolean})],ep.prototype,"ambientOcclusionEnabled",void 0),d([v({type:Boolean})],ep.prototype,"waterReflectionEnabled",void 0),d([v({type:Boolean})],ep.prototype,"cameraTrackingEnabled",void 0),ep=L0=d([Y("esri.views.3d.environment.VirtualLighting")],ep);const Ym=ep,sz={key:"type",defaultKeyValue:"sun",base:null,typeMap:{sun:Fc,virtual:Ym}};var Fx;let Cg=Fx=class extends Ie{set quality(i){["low","high"].includes(i)&&this._set("quality",i)}clone(){return new Fx({quality:this.quality})}};d([v({type:["low","high"],value:"low"})],Cg.prototype,"quality",null),Cg=Fx=d([Y("esri.views.3d.environment.SceneViewAtmosphere")],Cg);var zx;let Km=zx=class extends tc{constructor(i){super(i),this.type="sunny",this.cloudCover=.5}clone(){return new zx({cloudCover:this.cloudCover})}};d([Kp({sunny:"sunny"})],Km.prototype,"type",void 0),d([v({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],Km.prototype,"cloudCover",void 0),Km=zx=d([Y("esri.views.3d.environment.SunnyWeather")],Km);const Ux=Km;var Vx;let Jm=Vx=class extends tc{constructor(i){super(i),this.type="cloudy",this.cloudCover=.5}clone(){return new Vx({cloudCover:this.cloudCover})}};d([Kp({cloudy:"cloudy"})],Jm.prototype,"type",void 0),d([v({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],Jm.prototype,"cloudCover",void 0),Jm=Vx=d([Y("esri.views.3d.environment.CloudyWeather")],Jm);const az=Jm;var Gx;let eg=Gx=class extends tc{constructor(i){super(i),this.type="foggy",this.fogStrength=.5}clone(){return new Gx({fogStrength:this.fogStrength})}};d([Kp({foggy:"foggy"})],eg.prototype,"type",void 0),d([v({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],eg.prototype,"fogStrength",void 0),eg=Gx=d([Y("esri.views.3d.environment.FoggyWeather")],eg);const nz=eg;var Bx;let tp=Bx=class extends tc{constructor(i){super(i),this.type="rainy",this.cloudCover=.5,this.precipitation=.5}clone(){return new Bx({cloudCover:this.cloudCover,precipitation:this.precipitation})}};d([Kp({rainy:"rainy"})],tp.prototype,"type",void 0),d([v({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],tp.prototype,"cloudCover",void 0),d([v({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],tp.prototype,"precipitation",void 0),tp=Bx=d([Y("esri.views.3d.environment.RainyWeather")],tp);const oz=tp;var Hx;let id=Hx=class extends tc{constructor(i){super(i),this.type="snowy",this.cloudCover=.5,this.precipitation=.5,this.snowCover="disabled"}clone(){return new Hx({cloudCover:this.cloudCover,precipitation:this.precipitation,snowCover:this.snowCover})}};d([Kp({snowy:"snowy"})],id.prototype,"type",void 0),d([v({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],id.prototype,"cloudCover",void 0),d([v({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],id.prototype,"precipitation",void 0),d([v({type:["enabled","disabled"],nonNullable:!0,json:{write:!0}})],id.prototype,"snowCover",void 0),id=Hx=d([Y("esri.views.3d.environment.SnowyWeather")],id);const lz=id,MM={key:"type",base:Ux,typeMap:{sunny:Ux,cloudy:az,rainy:oz,snowy:lz,foggy:nz}},cz=Object.keys(MM.typeMap);function hz(i,e){return!!cz.includes(i)||(e.error(`"${i}" is not a valid weather type`),!1)}const Tn=1e4,dz={key:"type",defaultKeyValue:"sun",base:null,typeMap:{sun:df,virtual:Pv}};let $0=class extends tc{constructor(e){super(e)}clone(){}};d([v({readOnly:!0,json:{read:!1}})],$0.prototype,"type",void 0),$0=d([Y("esri.webscene.background.Background")],$0);const DM=$0;var kx;const uz={...x4,nonNullable:!0};let tg=kx=class extends DM{constructor(i){super(i),this.type="color",this.color=new ui([0,0,0,1])}clone(){return new kx(this.cloneProperties())}cloneProperties(){return{color:this.color.clone()}}};d([Kp({color:"color"},{readOnly:!0})],tg.prototype,"type",void 0),d([v(uz)],tg.prototype,"color",void 0),tg=kx=d([Y("esri.webscene.background.ColorBackground")],tg);const IM=tg,I2={base:DM,key:"type",typeMap:{color:IM}};function pz(i){return(e,t,r)=>{if(!e)return e;for(const s in i.typeMap)if(e.type===s){const a=new i.typeMap[s];return a.read(e,r),a}}}const mz={types:I2,json:{read:pz(I2),write:{overridePolicy:(i,e,t)=>({enabled:!t||!t.isPresentation})}}};var jx;const LM="esri.webscene.Environment",gz=Pe.getLogger(LM),L2=(i,e,t)=>({enabled:!t||!t.isPresentation});let zc=jx=class extends tc{constructor(i){super(i),this.lighting=new df,this.background=null,this.atmosphereEnabled=!0,this.starsEnabled=!0}set weather(i){hz(i==null?void 0:i.type,gz)&&this._set("weather",i)}clone(){return new jx(this.cloneConstructProperties())}cloneConstructProperties(){return{lighting:this.lighting&&this.lighting.type==="virtual"?Pv.prototype.clone.call(this.lighting):df.prototype.clone.call(this.lighting),background:Gl(this.background),atmosphereEnabled:this.atmosphereEnabled,starsEnabled:this.starsEnabled,weather:this.weather.clone()}}};d([v({types:dz,nonNullable:!0,json:{write:!0}})],zc.prototype,"lighting",void 0),d([v(mz)],zc.prototype,"background",void 0),d([v({type:Boolean,nonNullable:!0,json:{write:{overridePolicy:L2}}})],zc.prototype,"atmosphereEnabled",void 0),d([v({type:Boolean,nonNullable:!0,json:{write:{overridePolicy:L2}}})],zc.prototype,"starsEnabled",void 0),d([v({types:MM,nonNullable:!0,json:{write:!0},value:new Ux})],zc.prototype,"weather",null),zc=jx=d([Y(LM)],zc);const $M=zc;var ig;let ip=ig=class extends $M{constructor(i){super(i),this.atmosphere=new Cg,this.lighting=new Fc,this.cachedCameraTrackingEnabled=null}static fromWebsceneEnvironment(i){const e=i.cloneConstructProperties();return new ig({...e,lighting:e.lighting?e.lighting.type==="virtual"?Ym.fromWebsceneLighting(e.lighting):Fc.fromWebsceneLighting(e.lighting):void 0})}castLighting(i){return this._convertLighting(i)}applyLighting(i){this.lighting=this._convertLighting(i)}_convertLighting(i){var e,t;return i?i instanceof Fc||i instanceof Ym?i:i instanceof df?this.lighting&&this.lighting.type!=="virtual"?this.lighting.cloneWithWebsceneLighting(i):new Fc({...i.cloneConstructProperties(),...(e=this.lighting)==null?void 0:e.cloneNonPersistentConstructProperties()}):i instanceof Pv?this.lighting&&this.lighting.type==="virtual"?this.lighting.cloneWithWebsceneLighting(i):new Ym({...i.cloneConstructProperties(),...(t=this.lighting)==null?void 0:t.cloneNonPersistentConstructProperties()}):w4(sz,i):new Fc}clone(){return new ig({lighting:this.lighting.clone(),atmosphere:this.atmosphere.clone(),weather:this.weather.clone(),atmosphereEnabled:this.atmosphereEnabled,starsEnabled:this.starsEnabled,background:Gl(this.background)})}cloneWithWebsceneEnvironment(i){return new ig({atmosphere:this.atmosphere.clone(),weather:this.weather.clone(),atmosphereEnabled:this.atmosphereEnabled,starsEnabled:this.starsEnabled,background:Gl(this.background),...i.cloneConstructProperties(),lighting:this._getLighting(i)})}_getLighting(i){switch(i.lighting.type){case"sun":return this.lighting&&this.lighting.type==="sun"?this.lighting.cloneWithWebsceneLighting(i.lighting):Fc.fromWebsceneLighting(i.lighting);case"virtual":return this.lighting&&this.lighting.type==="virtual"?this.lighting.cloneWithWebsceneLighting(i.lighting):Ym.fromWebsceneLighting(i.lighting);default:return _o(i.lighting),Fc.fromWebsceneLighting(i.lighting)}}};d([v({type:Cg,json:{read:!1},nonNullable:!0})],ip.prototype,"atmosphere",void 0),d([v({nonNullable:!0})],ip.prototype,"lighting",void 0),d([Gg("lighting")],ip.prototype,"castLighting",null),ip=ig=d([Y("esri.views.3d.environment.SceneViewEnvironment")],ip);const rp=ip;var fr;(function(i){i[i.Simple=0]="Simple",i[i.Realistic=1]="Realistic",i[i.Panoramic=2]="Panoramic",i[i.None=3]="None"})(fr||(fr={}));function eC(i){return ee((i-1e5)/(1e6-1e5),0,1)}const qx=1e4,fz=.085,uf=1e5;function Ov(i){i.fragment.code.add(_`const float GAMMA = 2.2;
const float INV_GAMMA = 0.4545454545;
vec4 delinearizeGamma(vec4 color) {
return vec4(pow(color.rgb, vec3(INV_GAMMA)), color.w);
}
vec3 linearizeGamma(vec3 color) {
return pow(color, vec3(GAMMA));
}`)}const Sg=Ge(parseFloat(Number(5802e-9).toFixed(6)),parseFloat(Number(13558e-9).toFixed(6)),parseFloat(Number(331e-7).toFixed(6))),P1=3,O1=Ge(P1*parseFloat(Number(65e-8).toFixed(6)),P1*parseFloat(Number(1881e-9).toFixed(6)),P1*parseFloat(Number(85e-9).toFixed(6))),_z=3996e-9,yz=Ge(parseFloat(Number(Sg[0]+O1[0]).toFixed(6)),parseFloat(Number(Sg[1]+O1[1]).toFixed(6)),parseFloat(Number(Sg[2]+O1[2]).toFixed(6)));function vz(i){const e=new $t;e.attributes.add(w.POSITION,"vec2"),e.include(gv,{textureCoordinateType:mh.Default}),e.varyings.add("worldRay","vec3"),e.varyings.add("eyeDir","vec3");const{vertex:t,fragment:r}=e;return t.uniforms.add([new ir("inverseProjectionMatrix",(s,a)=>a.camera.inverseProjectionMatrix),new ir("inverseViewMatrix",(s,a)=>Vf(bz,a.camera.viewMatrix))]),t.code.add(_`void main(void) {
vec3 posViewNear = (inverseProjectionMatrix * vec4(position, -1, 1)).xyz;
eyeDir = posViewNear;
worldRay = (inverseViewMatrix * vec4(posViewNear, 0)).xyz;
forwardTextureCoordinates();
gl_Position = vec4(position, 1, 1);
}`),r.uniforms.add([new pi("radii",s=>s.radii),new si("cameraPosition",(s,a)=>a.camera.eye),new ai("heightParameters",s=>s.heightParameters),new ue("innerFadeDistance",s=>s.innerFadeDistance),new ue("altitudeFade",s=>s.altitudeFade),new lt("depthTex",s=>s.depthTex),new ue("hazeStrength",s=>s.hazeStrength)]),r.constants.add("betaRayleigh","vec3",Sg),r.constants.add("betaCombined","vec3",yz),r.constants.add("betaMie","float",_z),r.constants.add("scaleHeight","float",fz*uf),tm(r),e.include(Ov),i.haze&&(r.include(ml),r.uniforms.add(new pi("nearFar",(s,a)=>a.camera.nearFar))),r.code.add(_`vec2 sphereIntersect(vec3 start, vec3 dir, float radius, bool planet) {
float a = dot(dir, dir);
float b = 2.0 * dot(dir, start);
float c = planet ? heightParameters[1] - radius * radius : heightParameters[2];
float d = (b * b) - 4.0 * a * c;
if (d < 0.0) {
return vec2(1e5, -1e5);
}
return vec2((-b - sqrt(d)) / (2.0 * a), (-b + sqrt(d)) / (2.0 * a));
}`),r.code.add(_`float chapmanApproximation(float X, float h, float cosZenith) {
float c = sqrt(X + h);
float cExpH = c * exp(-h);
if (cosZenith >= 0.0) {
return cExpH / (c * cosZenith + 1.0);
} else {
float x0 = sqrt(1.0 - cosZenith * cosZenith) * (X + h);
float c0 = sqrt(x0);
return 2.0 * c0 * exp(X - x0) - cExpH / (1.0 - c * cosZenith);
}
}`),r.code.add(_`float getOpticalDepth(vec3 position, vec3 dir, float h) {
return scaleHeight * chapmanApproximation(radii[0] / scaleHeight, h, dot(normalize(position), dir));
}`),r.code.add(_`
    const int STEPS = 6;

    float getGlow(float dist, float radius, float intensity) {
      return pow(radius / max(dist, 1e-6), intensity);
    }

    vec3 getAtmosphereColour(vec3 cameraPos, vec3 rayDir, vec3 lightDir, float terrainDepth) {
      float reducedPlanetRadius = radii[0] - 20000.0;
      vec2 rayPlanetIntersect = sphereIntersect(cameraPos, rayDir, reducedPlanetRadius, true);
      vec2 rayAtmosphereIntersect = sphereIntersect(cameraPos, rayDir, radii[1], false);
      bool hitsAtmosphere = (rayAtmosphereIntersect.x <= rayAtmosphereIntersect.y) && rayAtmosphereIntersect.x > 0.0;
      bool insideAtmosphere = heightParameters[0] < radii[1];

      if (!(hitsAtmosphere || insideAtmosphere)) {
        return vec3(0);
      }

      bool hitsPlanet = (rayPlanetIntersect.x <= rayPlanetIntersect.y) && rayPlanetIntersect.x > 0.0;

      float start = insideAtmosphere ? 0.0 : rayAtmosphereIntersect.x;

      if (heightParameters[0] < reducedPlanetRadius) {
        // Long light rays from the night side of the planet lead to numerical instability
        // Do not render the atmosphere in such cases
        if (dot(rayDir, normalize(cameraPos)) < -0.025) {
          return vec3(0);
        }
        start = rayPlanetIntersect.y;
      }

      float end = hitsPlanet ? rayPlanetIntersect.x : rayAtmosphereIntersect.y;
      float maxEnd = end;

      ${i.haze?_`if (terrainDepth != -1.0) { end = terrainDepth; }`:""}

      vec3 samplePoint = cameraPos + rayDir * end;
      float multiplier = hitsPlanet ? -1.0 : 1.0;

      vec3 scattering = vec3(0);
      float scaleFract = (length(samplePoint) - radii[0]) / scaleHeight;
      float lastOpticalDepth = getOpticalDepth(samplePoint, rayDir, scaleFract);
      float stepSize = (end - start) / float(STEPS);
      for (int i = 0; i < STEPS; i++) {
        samplePoint -= stepSize * rayDir;
        scaleFract = (length(samplePoint) - radii[0]) / scaleHeight;
        float opticalDepth = multiplier * getOpticalDepth(samplePoint, rayDir * multiplier, scaleFract);

        if (i > 0) {
          scattering *= ${i.haze?_``:" mix(2.5, 1.0, clamp((length(cameraPos) - radii[0]) / 50e3, 0.0, 1.0)) * "} exp(-(mix(betaCombined, betaRayleigh, 0.5) + betaMie) * max(0.0, (opticalDepth - lastOpticalDepth)));
        }

        if (dot(normalize(samplePoint), lightDir) > -0.3) {

          float scale = exp(-scaleFract);
          float lightDepth = getOpticalDepth(samplePoint, lightDir, scaleFract);

          scattering += scale * exp(-(betaCombined + betaMie) * lightDepth);
          ${i.haze?"":_`scattering += scale * exp(-(0.25 * betaCombined ) * lightDepth);`}
        }

        lastOpticalDepth = opticalDepth;

      }

      float mu = dot(rayDir, lightDir);
      float mumu = 1.0 + mu * mu;

      float phaseRayleigh = 0.0596831 * mumu;

      ${i.haze?_`return 3.0 * scattering * stepSize * phaseRayleigh * betaRayleigh;`:_`
            const float g = 0.8;
            const float gg = g * g;
            float phaseMie = end == maxEnd ? 0.1193662 * ((1.0 - gg) * mumu) / (pow(1.0 + gg - 2.0 * mu * g, 1.5) * (2.0 + gg)) : 0.0;
            phaseMie += getGlow(1.0 - mu, 5e-5, 3.0) * smoothstep(0.01, 0.1, length(scattering));
            phaseMie = clamp(phaseMie, 0.0, 128.0);
            return 3.0 * scattering * stepSize * (phaseRayleigh * betaRayleigh + 0.025 * phaseMie * betaMie);`}
    }

    vec3 tonemapACES(vec3 x) {
      return clamp((x * (2.51 * x + 0.03)) / (x * (2.43 * x + 0.59) + 0.14), 0.0, 1.0);
    }

    vec4 applyUndergroundAtmosphere(vec3 rayDir, vec3 lightDirection, vec4 fragColor) {
      vec2 rayPlanetIntersect = sphereIntersect(cameraPosition, rayDir, radii[0], true);
      if (!((rayPlanetIntersect.x <= rayPlanetIntersect.y) && rayPlanetIntersect.y > 0.0)) {
        return fragColor;
      }

      float lightAngle = dot(lightDirection, normalize(cameraPosition + rayDir * max(0.0, rayPlanetIntersect.x)));
      vec4 surfaceColor = vec4(vec3(max(0.0, (smoothstep(-1.0, 0.8, 2.0 * lightAngle)))), 1.0 - altitudeFade);
      float relDist = (rayPlanetIntersect.y - max(0.0, rayPlanetIntersect.x)) / innerFadeDistance;
      if (relDist > 1.0) {
        return surfaceColor;
      }

      return mix(gl_FragColor, surfaceColor, smoothstep(0.0, 1.0, relDist * relDist));
    }

    void main() {
      vec3 rayDir = normalize(worldRay);
      float terrainDepth = -1.0;
      ${i.haze?_`
          vec4 depthSample = texture2D(depthTex, vuv0).rgba;
          if (depthSample != vec4(0)) {
            vec3 cameraSpaceRay = normalize(eyeDir);
            cameraSpaceRay /= cameraSpaceRay.z;
            cameraSpaceRay *= -linearDepthFromTexture(depthTex, vuv0, nearFar);
            terrainDepth = max(0.0, length(cameraSpaceRay));
          }`:_`
          float depthSample = texture2D(depthTex, vuv0).r;
          if (depthSample != 1.0) {
            gl_FragColor = vec4(0);
            return;
          }`}

      ${i.haze?_`
            vec3 col = vec3(0);
            float fadeOut = smoothstep(-10000.0, -15000.0, heightParameters[0] - radii[0]);
            if(depthSample != vec4(0)){
              col = (1.0 - fadeOut) * hazeStrength * getAtmosphereColour(cameraPosition, rayDir, mainLightDirection, terrainDepth);
            }
            float alpha = 1.0 - fadeOut;`:_`
            vec3 col = getAtmosphereColour(cameraPosition, rayDir, mainLightDirection, terrainDepth);;
            float alpha = smoothstep(0.0, mix(0.15, 0.01, heightParameters[3]), length(col));`}
      col = tonemapACES(col);
      gl_FragColor = delinearizeGamma(vec4(col, alpha));
      ${i.haze?"":_`
          if (depthSample == 1.0) {
            gl_FragColor = applyUndergroundAtmosphere(rayDir, mainLightDirection, gl_FragColor);
          }`}
    }
  `),e}const bz=ce(),xz=Object.freeze(Object.defineProperty({__proto__:null,betaRayleigh:Sg,build:vz},Symbol.toStringTag,{value:"Module"}));let wz=class extends Gi{constructor(){super(...arguments),this.heightParameters=Pt(),this.radii=$e(),this.innerFadeDistance=0,this.altitudeFade=0,this.hazeStrength=1}},Wx=class NM extends Mt{initializeProgram(e){return new Rt(e.rctx,NM.shader.get().build(this.configuration),Lt)}initializePipeline(){return this.configuration.haze?qe({blending:Ar(ae.ONE,ae.ZERO,ae.ONE_MINUS_SRC_COLOR,ae.ONE),colorWrite:at}):qe({blending:Ar(ae.SRC_ALPHA,ae.ONE,ae.ONE_MINUS_SRC_ALPHA,ae.ONE_MINUS_SRC_ALPHA),depthTest:{func:Fa.LEQUAL},colorWrite:at})}};Wx.shader=new Dt(xz,()=>_e(()=>import("./ChapmanAtmosphere.glsl-a17c80cc.js"),["assets/ChapmanAtmosphere.glsl-a17c80cc.js","assets/calcite-8912bd40.js","assets/index-00759e4a.js","assets/index-5026a37a.css","assets/calcite-96fa36fd.css","assets/mat4f64-abdda1bb.js","assets/objectResourceUtils-782953c3.js","assets/devEnvironmentUtils-5002a058.js","assets/mat3f64-50f3b9f6.js","assets/BufferView-379a78a4.js","assets/vec33-69c9e93b.js","assets/DefaultMaterial_COLOR_GAMMA-6ed76d86.js","assets/types-e1c0a5bf.js","assets/enums-e2e92c86.js","assets/Version-aa0a1d91.js","assets/quat-7b70e9a8.js","assets/quatf64-f8f1c132.js","assets/resourceUtils-527631ac.js","assets/basicInterfaces-7449a8bf.js","assets/Indices-d8bff7b2.js","assets/NestedMap-1b5db22e.js","assets/requestImageUtils-d1ba3b36.js","assets/symbolColorUtils-c9d24716.js","assets/Util-6d3f024a.js","assets/sphere-d0e5285d.js","assets/VertexAttribute-15d1866a.js","assets/doublePrecisionUtils-e3c3d0d8.js","assets/OrderIndependentTransparency-5f7257d7.js","assets/Texture-563cf5e5.js","assets/FramebufferObject-8b18fc0c.js","assets/VertexElementDescriptor-2925c6af.js","assets/InterleavedLayout-d57c91d0.js","assets/vec3f32-01c06d8d.js","assets/plane-5e2b046c.js","assets/spatialReferenceEllipsoidUtils-afb35af9.js","assets/scaleUtils-d13015f2.js","assets/ElevationSamplerData-e3118b17.js","assets/Octree-499541ed.js","assets/edgeProcessing-20e12367.js","assets/deduplicate-769a6f51.js","assets/MeshComponent-788e605a.js","assets/earcut-61f7b102.js","assets/imageUtils-c2d0d1ae.js","assets/projection-5969b753.js","assets/ZoomMomentumEstimator-ef57e6a4.js","assets/floatRGBA-ca2b39ca.js","assets/dehydratedFeatures-3a140d03.js","assets/quantizationUtils-b3b2ae2a.js","assets/labelFormatUtils-71e1f841.js","assets/orientedBoundingBox-a14b97b5.js","assets/quatf32-51a323b8.js","assets/SnappingCandidate-970faec6.js","assets/callExpressionWithFeature-df1a8f01.js","assets/DefaultVertexAttributeLayouts-5f20d8dd.js","assets/geometryServiceUtils-a536bb19.js","assets/project-909a4219.js","assets/LercDecoder-65586d50.js","assets/VectorTile-d41a1f0f.js","assets/enums-fb086c25.js","assets/config-1337d16e.js","assets/TiledDisplayObject-419c008b.js","assets/DisplayObject-87c37b69.js","assets/rasterUtils-7694cc98.js","assets/resources-7587d8f4.js","assets/workerHelper-6131d203.js","assets/webgl-debug-7f880832.js","assets/RenderingContext-0f21aa0e.js","assets/ProgramCache-f29c900e.js","assets/Program-77209250.js","assets/MediaLayer-4c42fc2f.js","assets/MediaElementView-06baa4d4.js","assets/normalizeUtilsSync-3ea564a9.js","assets/resourceExtension-f31d9f10.js","assets/BoundsStore-00da37da.js","assets/PooledRBush-5a11bc7e.js","assets/prism-line-numbers-eff41b13.js","assets/label2-a2f37e65.js","assets/interactive-1de2e238.js","assets/loadable-6afd516d.js","assets/t9n-81df3a71.js","assets/observers-c89705b8.js","assets/icon-8e47fbec.js","assets/loader-c773e800.js","assets/guid-51402ee7.js","assets/prism-line-numbers-7c5d72ff.css"]));let FM=class extends ua{constructor(){super(...arguments),this.haze=!1}};d([D()],FM.prototype,"haze",void 0);let R1=class{constructor(e,t){this._view=e,this.type=fr.Realistic,this._handles=new Vi,this._passParameters=new wz,this._rootTileElevationMin=NaN,this._lowerBoundEarthRadius=Ys.radius,this._fadeHaze=0,this._updateRadius(Ys.radius);const r=t.renderContext.rctx;this._updateRootTileElevationBounds(),this._handles.add([te(()=>this._view.basemapTerrain.rootTileElevationBounds,()=>this._updateRootTileElevationBounds()),te(()=>this._view.basemapTerrain.visibleElevationBounds,()=>this._updateVisibleElevationBounds())]);const s=new FM;s.haze=!1,this._atmosphereTechnique=t.techniqueRepository.acquire(Wx,s),s.haze=!0,this._atmosphereHazeTechnique=t.techniqueRepository.acquire(Wx,s),this._vao=pa(r,Gf)}destroy(){this._atmosphereTechnique.release(),this._atmosphereHazeTechnique.release(),this._vao.dispose(),this._handles.destroy()}render(e){this._render(e,this._atmosphereTechnique,e.offscreenRenderingHelper.depthTexture)}renderHaze(e,t){this._fadeHaze=t,this._render(e,this._atmosphereHazeTechnique,e.offscreenRenderingHelper.linearDepthTexture)}_render(e,t,r){if(P(r))return;this._update(e.bindParameters.camera),this._passParameters.depthTex=r;const s=e.rctx.bindTechnique(t,this._passParameters,e.bindParameters);e.offscreenRenderingHelper.renderDepthDetached(()=>this._renderCommon(s,e))}_renderCommon(e,t){P(this._vao)||(t.rctx.bindVAO(this._vao),e.assertCompatibleVertexAttributeLocations(this._vao),t.rctx.drawArrays(Ut.TRIANGLE_STRIP,0,4))}_adjustRadiusForTesselation(e){return e*Math.cos(Math.PI/16/16)}_updateRootTileElevationBounds(){const e=this._view.basemapTerrain.rootTileElevationBounds.min;e!==this._rootTileElevationMin&&(this._rootTileElevationMin=e,this._lowerBoundEarthRadius=Ys.radius,this._updateVisibleElevationBounds())}_updateVisibleElevationBounds(){const e=this._adjustRadiusForTesselation(Ys.radius+this._view.basemapTerrain.visibleElevationBounds.min);e<this._lowerBoundEarthRadius&&this._updateRadius(e)}_updateRadius(e){this._lowerBoundEarthRadius=e,zt(this._passParameters.radii,e,e+uf),this._passParameters.innerFadeDistance=2*Math.sqrt((2*e-qx)*qx)}_update(e){if(P(e))return;const t=sn(e.eye),r=Math.sqrt(t),s=t-this._passParameters.radii[1]*this._passParameters.radii[1],a=ee((r-this._passParameters.radii[0])/uf,0,1);Br(this._passParameters.heightParameters,r,t,s,a),this._passParameters.altitudeFade=eC(r-this._lowerBoundEarthRadius),this._passParameters.hazeStrength=st(st(.6,1,Lp(9500,10500,r-Ys.radius)),1,this._fadeHaze)}static isSupported(e){return e.renderContext.rctx.capabilities.depthTexture}};var Ei,Id;function Tz(i){return g(i)&&g(i.cubeMap)}function tC(i){return g(i)&&!i.running}(function(i){i[i.RENDERING=0]="RENDERING",i[i.FINISHED_RENDERING=1]="FINISHED_RENDERING",i[i.FADING_TEXTURE_CHANNELS=2]="FADING_TEXTURE_CHANNELS",i[i.SWITCH_CHANNELS=3]="SWITCH_CHANNELS",i[i.FINISHED=4]="FINISHED"})(Ei||(Ei={})),function(i){i[i.RG=0]="RG",i[i.BA=1]="BA"}(Id||(Id={}));let Cz=class{constructor(){this.readChannels=Id.RG,this.renderingStage=Ei.FINISHED,this.startTime=0,this.startTimeHeightFade=0,this.cameraPositionLastFrame=T(),this.isCameraPositionFinal=!0,this.parallax=new $2,this.parallaxNew=new $2,this.crossFade={enabled:!1,factor:1,distanceThresholdFactor:.3},this.fadeInOut={stage:yr.FINISHED,factor:1,distanceThresholdFactor:.6},this.fadeIn={stage:Oa.FINISHED,factor:1,distanceThresholdFactor:2},this.fadeInOutHeight={stage:yh.FINISHED,factor:-1}}get isFading(){return this.fadeInOut.stage===yr.FADE_OUT||this.fadeInOut.stage===yr.FADE_IN||this.fadeIn.stage===Oa.FADE_IN||this.fadeInOutHeight.stage!==yh.FINISHED||this.renderingStage===Ei.FADING_TEXTURE_CHANNELS}};var Oa,yr,yh;(function(i){i[i.FINISHED=0]="FINISHED",i[i.CHANGE_ANCHOR=1]="CHANGE_ANCHOR",i[i.FADE_IN=2]="FADE_IN"})(Oa||(Oa={})),function(i){i[i.FINISHED=0]="FINISHED",i[i.FADE_OUT=1]="FADE_OUT",i[i.SWITCH=2]="SWITCH",i[i.FADE_IN=3]="FADE_IN"}(yr||(yr={})),function(i){i[i.FINISHED=0]="FINISHED",i[i.HEIGHT_FADE=1]="HEIGHT_FADE"}(yh||(yh={}));let $2=class{constructor(){this.anchorPointClouds=T(),this.cloudsHeight=1e5,this.radiusCurvatureCorrectionFactor=0,this.transform=ce()}},Sz=class extends Ch{constructor(e,t){super(e,"samplerCube",fv.Pass,(r,s,a)=>r.bindTexture(e,t(s,a)))}};function zM(i){const e=i.fragment;e.uniforms.add([new ir("rotationMatrixClouds",(t,r)=>r.cloudsFade.parallax.transform),new ir("rotationMatrixCloudsCrossFade",(t,r)=>r.cloudsFade.parallaxNew.transform),new si("anchorPosition",(t,r)=>r.cloudsFade.parallax.anchorPointClouds),new si("anchorPositionCrossFade",(t,r)=>r.cloudsFade.parallaxNew.anchorPointClouds),new ue("cloudsHeight",(t,r)=>r.cloudsFade.parallax.cloudsHeight),new ue("radiusCurvatureCorrectionFactor",(t,r)=>r.cloudsFade.parallax.radiusCurvatureCorrectionFactor),new ue("totalFadeInOut",(t,r)=>r.cloudsFade.fadeInOut.stage===yr.FINISHED?r.cloudsFade.fadeInOutHeight.factor+1-r.cloudsFade.fadeIn.factor:r.cloudsFade.fadeInOutHeight.factor+1-r.cloudsFade.fadeInOut.factor),new ue("crossFadeAnchorFactor",(t,r)=>ee(r.cloudsFade.crossFade.factor,0,1)),new Sz("cubeMap",(t,r)=>g(r.cloudsFade.data)&&g(r.cloudsFade.data.cubeMap)?r.cloudsFade.data.cubeMap.colorTexture:null),new ih("crossFade",(t,r)=>r.cloudsFade.crossFade.enabled),new ih("readChannelsRG",(t,r)=>r.cloudsFade.readChannels===Id.RG),new ih("fadeTextureChannels",(t,r)=>r.cloudsFade.renderingStage===Ei.FADING_TEXTURE_CHANNELS)]),e.constants.add("planetRadius","float",Ys.radius),e.code.add(_`vec3 intersectWithCloudLayer(vec3 dir, vec3 cameraPosition, vec3 spherePos)
{
float radiusClouds = planetRadius + cloudsHeight;
float B = 2.0 * dot(cameraPosition, dir);
float C = dot(cameraPosition, cameraPosition) - radiusClouds * radiusClouds;
float det = B * B - 4.0 * C;
float pointIntDist = max(0.0, 0.5 *(-B + sqrt(det)));
vec3 intersectionPont = cameraPosition + dir * pointIntDist;
intersectionPont =  intersectionPont - spherePos;
return intersectionPont;
}`),e.code.add(_`vec3 correctForPlanetCurvature(vec3 dir)
{
dir.z = dir.z*(1.-radiusCurvatureCorrectionFactor) + radiusCurvatureCorrectionFactor;
return dir;
}`),e.code.add(_`vec3 rotateDirectionToAnchorPoint(mat4 rotMat, vec3 inVec)
{
return (rotMat * vec4(inVec, 0.0)).xyz;
}`),tm(e),im(e),e.code.add(_`const float SUNSET_TRANSITION_FACTOR = 0.3;
const vec3 RIM_COLOR = vec3(0.28, 0.175, 0.035);
const float RIM_SCATTERING_FACTOR = 140.0;
const float BACKLIGHT_FACTOR = 0.2;
const float BACKLIGHT_SCATTERING_FACTOR = 10.0;
const float BACKLIGHT_TRANSITION_FACTOR = 0.3;
vec3 calculateCloudColor(vec3 cameraPosition, vec3 worldSpaceRay, vec4 clouds)
{
float upDotLight = dot(normalize(cameraPosition), normalize(mainLightDirection));
float dirDotLight = max(dot(normalize(-worldSpaceRay), normalize(mainLightDirection)), 0.0);
float sunsetTransition = clamp(pow(max(upDotLight, 0.0), SUNSET_TRANSITION_FACTOR), 0.0, 1.0);
vec3 ambientLight = calculateAmbientIrradiance(normalize(cameraPosition),  0.0);
vec3 mainLight = evaluateMainLighting(normalize(cameraPosition),  0.0);
vec3 combinedLight = clamp((mainLightIntensity + ambientLight )/PI, vec3(0.0), vec3(1.0));
vec3 baseCloudColor = pow(combinedLight * pow(clouds.xyz, vec3(GAMMA)), vec3(INV_GAMMA));
float scatteringMod = max(clouds.a < 0.5 ? clouds.a / 0.5 : - clouds.a / 0.5 + 2.0, 0.0);
float rimLightIntensity = 0.5 + 0.5 *pow(max(upDotLight, 0.0), 0.35);
vec3 directSunScattering = RIM_COLOR * rimLightIntensity * (pow(dirDotLight, RIM_SCATTERING_FACTOR)) * scatteringMod;
float additionalLight = BACKLIGHT_FACTOR * pow(dirDotLight, BACKLIGHT_SCATTERING_FACTOR) * (1. - pow(sunsetTransition, BACKLIGHT_TRANSITION_FACTOR)) ;
return vec3(baseCloudColor * (1. + additionalLight) + directSunScattering);
}`),e.code.add(_`vec4 getCloudData(vec3 rayDir, bool readOtherChannel)
{
vec4 cloudData = textureCube(cubeMap, rayDir);
float mu = dot(rayDir, vec3(0, 0, 1));
bool readChannels = readChannelsRG ^^ readOtherChannel;
if (readChannels) {
cloudData = vec4(vec3(cloudData.r), cloudData.g);
} else {
cloudData = vec4(vec3(cloudData.b), cloudData.a);
}
if (length(cloudData) == 0.0) {
return vec4(cloudData.rgb, 1.0);
}
return cloudData;
}`),e.code.add(_`vec4 renderCloudsNoFade(vec3 worldRay, vec3 cameraPosition)
{
vec3 intersectionPoint = intersectWithCloudLayer(normalize(worldRay), cameraPosition, anchorPosition);
vec3 worldRayRotated = rotateDirectionToAnchorPoint(rotationMatrixClouds, normalize(intersectionPoint));
vec3 worldRayRotatedCorrected = correctForPlanetCurvature(worldRayRotated);
vec4 cloudData = getCloudData(worldRayRotatedCorrected, false);
float totalTransmittance = clamp(cloudData.a * (1.0 - totalFadeInOut) + totalFadeInOut, 0.0 , 1.0);
if (length(cloudData.rgb) == 0.0) {
totalTransmittance = 1.0;
}
return vec4(calculateCloudColor(cameraPosition, normalize(-worldRay), cloudData), totalTransmittance);
}`),e.code.add(_`vec4 renderCloudsCrossFade(vec3 worldRay, vec3 cameraPosition)
{
vec3 intersectionPoint = intersectWithCloudLayer(normalize(worldRay), cameraPosition, anchorPosition);
vec3 worldRayRotated = rotateDirectionToAnchorPoint(rotationMatrixClouds, normalize(intersectionPoint));
vec3 worldRayRotatedCorrected = correctForPlanetCurvature(worldRayRotated);
vec4 cloudData = getCloudData(worldRayRotatedCorrected, false);
vec4 cloudColor = vec4(calculateCloudColor(cameraPosition, normalize(-worldRay), cloudData), cloudData.a);
intersectionPoint = intersectWithCloudLayer(normalize(worldRay), cameraPosition, anchorPositionCrossFade);
worldRayRotated = rotateDirectionToAnchorPoint(rotationMatrixCloudsCrossFade, normalize(intersectionPoint));
worldRayRotatedCorrected = correctForPlanetCurvature(worldRayRotated);
cloudData = getCloudData(worldRayRotatedCorrected, fadeTextureChannels);
vec4 cloudColorCrossFade = vec4(calculateCloudColor(cameraPosition, normalize(-worldRay), cloudData), cloudData.a);
cloudColor = mix(cloudColor, cloudColorCrossFade, crossFadeAnchorFactor);
float totalTransmittance = clamp(cloudColor.a * (1.0 - totalFadeInOut) + totalFadeInOut, 0.0 , 1.0);
if (length(cloudColor.rgb) == 0.0) {
totalTransmittance = 1.0;
}
return vec4(cloudColor.rgb, totalTransmittance);
}`),e.code.add(_`vec4 renderClouds(vec3 worldRay, vec3 cameraPosition)
{
return crossFade ? renderCloudsCrossFade(worldRay, cameraPosition) : renderCloudsNoFade(worldRay, cameraPosition);
}`)}function Pz(){const i=new $t;i.attributes.add(w.POSITION,"vec2"),i.varyings.add("worldRay","vec3");const{vertex:e,fragment:t}=i;return e.uniforms.add([new ir("inverseProjectionMatrix",(r,s)=>s.camera.inverseProjectionMatrix),new ir("inverseViewMatrix",(r,s)=>Vf(Oz,s.camera.viewMatrix))]),e.code.add(_`void main(void) {
vec3 posViewNear = (inverseProjectionMatrix * vec4(position, -1.0, 1.0)).xyz;
worldRay = (inverseViewMatrix * vec4(posViewNear, 0.0)).xyz;
gl_Position = vec4(position, 1.0, 1.0);
}`),t.include(rc),t.include(To),i.include(T3,{pbrMode:Wt.Disabled,lightingSphericalHarmonicsOrder:2}),i.include(C3),i.include(Ov),i.include(S3,{useLegacyTerrainShading:!1}),i.include(zM,{instancedDoublePrecision:!1,useLegacyTerrainShading:!1}),t.uniforms.add([new si("cameraPosition",(r,s)=>s.camera.eye)]),t.code.add(_`void main() {
vec4 cloudsColor = renderClouds(normalize(worldRay), cameraPosition);
gl_FragColor = vec4((1.0 - totalFadeInOut) * cloudsColor.rgb, cloudsColor.a);
}`),i}const Oz=ce(),Rz=Object.freeze(Object.defineProperty({__proto__:null,build:Pz},Symbol.toStringTag,{value:"Module"}));let UM=class VM extends Mt{constructor(e){super(e,new ua,()=>this.destroy())}initializeProgram(e){return new Rt(e.rctx,VM.shader.get().build(),Lt)}initializePipeline(){return qe({blending:Ar(ae.ONE,ae.ZERO,ae.SRC_ALPHA,ae.ONE),depthTest:{func:Fa.LEQUAL},colorWrite:at})}};UM.shader=new Dt(Rz,()=>_e(()=>import("./CloudsComposition.glsl-e5d36e2b.js"),["assets/CloudsComposition.glsl-e5d36e2b.js","assets/calcite-8912bd40.js","assets/index-00759e4a.js","assets/index-5026a37a.css","assets/calcite-96fa36fd.css","assets/mat4f64-abdda1bb.js","assets/objectResourceUtils-782953c3.js","assets/devEnvironmentUtils-5002a058.js","assets/mat3f64-50f3b9f6.js","assets/BufferView-379a78a4.js","assets/vec33-69c9e93b.js","assets/DefaultMaterial_COLOR_GAMMA-6ed76d86.js","assets/types-e1c0a5bf.js","assets/enums-e2e92c86.js","assets/Version-aa0a1d91.js","assets/quat-7b70e9a8.js","assets/quatf64-f8f1c132.js","assets/resourceUtils-527631ac.js","assets/basicInterfaces-7449a8bf.js","assets/Indices-d8bff7b2.js","assets/NestedMap-1b5db22e.js","assets/requestImageUtils-d1ba3b36.js","assets/symbolColorUtils-c9d24716.js","assets/Util-6d3f024a.js","assets/sphere-d0e5285d.js","assets/VertexAttribute-15d1866a.js","assets/doublePrecisionUtils-e3c3d0d8.js","assets/OrderIndependentTransparency-5f7257d7.js","assets/Texture-563cf5e5.js","assets/FramebufferObject-8b18fc0c.js","assets/VertexElementDescriptor-2925c6af.js","assets/InterleavedLayout-d57c91d0.js","assets/vec3f32-01c06d8d.js","assets/plane-5e2b046c.js","assets/spatialReferenceEllipsoidUtils-afb35af9.js","assets/scaleUtils-d13015f2.js","assets/ElevationSamplerData-e3118b17.js","assets/Octree-499541ed.js","assets/edgeProcessing-20e12367.js","assets/deduplicate-769a6f51.js","assets/MeshComponent-788e605a.js","assets/earcut-61f7b102.js","assets/imageUtils-c2d0d1ae.js","assets/projection-5969b753.js","assets/ZoomMomentumEstimator-ef57e6a4.js","assets/floatRGBA-ca2b39ca.js","assets/dehydratedFeatures-3a140d03.js","assets/quantizationUtils-b3b2ae2a.js","assets/labelFormatUtils-71e1f841.js","assets/orientedBoundingBox-a14b97b5.js","assets/quatf32-51a323b8.js","assets/SnappingCandidate-970faec6.js","assets/callExpressionWithFeature-df1a8f01.js","assets/DefaultVertexAttributeLayouts-5f20d8dd.js","assets/geometryServiceUtils-a536bb19.js","assets/project-909a4219.js","assets/LercDecoder-65586d50.js","assets/VectorTile-d41a1f0f.js","assets/enums-fb086c25.js","assets/config-1337d16e.js","assets/TiledDisplayObject-419c008b.js","assets/DisplayObject-87c37b69.js","assets/rasterUtils-7694cc98.js","assets/resources-7587d8f4.js","assets/workerHelper-6131d203.js","assets/webgl-debug-7f880832.js","assets/RenderingContext-0f21aa0e.js","assets/ProgramCache-f29c900e.js","assets/Program-77209250.js","assets/MediaLayer-4c42fc2f.js","assets/MediaElementView-06baa4d4.js","assets/normalizeUtilsSync-3ea564a9.js","assets/resourceExtension-f31d9f10.js","assets/BoundsStore-00da37da.js","assets/PooledRBush-5a11bc7e.js","assets/prism-line-numbers-eff41b13.js","assets/label2-a2f37e65.js","assets/interactive-1de2e238.js","assets/loadable-6afd516d.js","assets/t9n-81df3a71.js","assets/observers-c89705b8.js","assets/icon-8e47fbec.js","assets/loader-c773e800.js","assets/guid-51402ee7.js","assets/prism-line-numbers-7c5d72ff.css"]));let rd=class extends Ie{constructor(e){super(e),this._technique=new UM(e),this._vao=pa(e.rctx)}destroy(){this._technique=er(this._technique),this._vao=De(this._vao)}render(e){const t=e.bindParameters.cloudsFade;if(P(this._vao)||P(t.data))return;if(!this._technique.compiled)return void this.requestRender();const r=e.rctx.bindTechnique(this._technique,Ez,e.bindParameters);e.rctx.bindVAO(this._vao),r.assertCompatibleVertexAttributeLocations(this._vao),e.rctx.drawArrays(Ut.TRIANGLE_STRIP,0,4)}};d([v({constructOnly:!0})],rd.prototype,"rctx",void 0),d([v({constructOnly:!0})],rd.prototype,"viewingMode",void 0),d([v({constructOnly:!0})],rd.prototype,"planetRadius",void 0),d([v({constructOnly:!0})],rd.prototype,"requestRender",void 0),rd=d([Y("esri.views.3d.environment.CloudsComposition")],rd);const Ez=new Gi;var sa;(function(i){i[i.SIXTEEN=0]="SIXTEEN",i[i.HUNDRED=1]="HUNDRED",i[i.TWOHUNDRED=2]="TWOHUNDRED",i[i.COUNT=3]="COUNT"})(sa||(sa={}));let N0=class extends ua{constructor(){super(...arguments),this.steps=sa.SIXTEEN,this.writeTextureChannels=Id.RG}};d([D({count:sa.COUNT})],N0.prototype,"steps",void 0),d([D({constValue:vi("esri-mobile")?1024:2048})],N0.prototype,"cubeMapSize",void 0),d([D()],N0.prototype,"writeTextureChannels",void 0);let rg=class{constructor(e,t,r,s,a,n,o,l,c=.5){this.coverage=e,this.density=t,this.absorption=r,this.cloudSize=s,this.detailSize=a,this.smoothness=n,this.cloudHeight=o,this.raymarchingSteps=l,this.median=c}};const N2=new rg([0,.6],[.03,.03],[0,0],[.9,.9],[.8,.8],[.7,.7],[.05,.05],sa.SIXTEEN),os={sunny:N2,cloudy:new rg([.3,.65],[.2,.4],[0,0],[.85,.85],[.75,.75],[.3,.4],[1,1],sa.TWOHUNDRED,.6),rainy:new rg([.6,.8],[.5,.8],[.1,.5],[.9,.9],[.75,.75],[.5,.5],[1,1],sa.TWOHUNDRED,.4),snowy:new rg([.25,.75],[.3,.3],[0,0],[.95,.95],[.7,.7],[.69,.75],[.3,1],sa.HUNDRED,.65),foggy:new rg([.8,.8],[.5,.5],[0,0],[.95,.95],[.9,.9],[.55,.55],[.3,.3],sa.SIXTEEN),default:N2},Cn=vi("esri-mobile")?64:128,Az=Cn/128,Jn=Math.ceil(Math.sqrt(Cn)),so=(Cn+2)*Jn,Mz=1e5,E1=128,Dz=so/1560;let GM=class extends Gi{constructor(){super(...arguments),this.cloudRadius=0,this.cloudSize=0,this.detailSize=0,this.absorption=0,this.density=0,this.smoothness=0,this.cloudHeight=0,this.coverage=0,this.raymarchingSteps=os.default.raymarchingSteps,this.weatherTile=$e()}},BM=class extends Gi{constructor(){super(...arguments),this.viewMatrix=ys()}};function Iz(i){const e=new $t;e.include(sc,!1);const t=e.fragment;return t.uniforms.add([new ue("cloudRadius",r=>r.cloudRadius),new ue("power",r=>st(35,120,r.absorption)),new ue("sigmaE",r=>1+r.absorption),new ue("density",r=>st(0,.3,r.density)),new ue("cloudSize",r=>st(0,.02,Math.max(.01,1-r.cloudSize))),new ue("detailSize",r=>st(0,.2,Math.max(.01,1-r.detailSize))),new ue("smoothness",r=>st(0,.5,1-r.smoothness)),new ue("cloudHeight",r=>st(0,1500,r.cloudHeight)),new ue("coverage",r=>r.coverage),new Rx("view",r=>r.viewMatrix),new lt("cloudShapeTexture",r=>g(r.noiseTexture)?r.noiseTexture.textureAtlas:null),new pi("cloudVariables",r=>zt(Lz,r.coverage,r.absorption))]),t.constants.add("halfCubeMapSize","float",.5*i.cubeMapSize),t.code.add(_`
    const int STEPS = ${i.steps===sa.SIXTEEN?_`16`:i.steps===sa.HUNDRED?_`100`:_`200`};
    const int STEPS_LIGHT = 6;
    const float stepL = 300.0 / float(STEPS_LIGHT);
    const float cloudStart = 1500.0;

    vec3 rayDirection(vec2 fragCoord) {
      vec2 xy = fragCoord - halfCubeMapSize;
      return normalize(vec3(-xy, -halfCubeMapSize));
    }

    float remap(float x, float low1, float high1, float low2, float high2) {
      return low2 + (x - low1) * (high2 - low2) / (high1 - low1);
    }

    float saturate(float x) {
      return clamp(x, 0.0, 1.0);
    }`),t.code.add(_`
    float getCloudShape(vec3 pos, float pOffset) {
      const float textureWidth = ${_.float(so)};
      const float dataWidth = ${_.float(so)};
      const float tileRows = ${_.float(Jn)};
      const vec3 atlasDimensions = vec3(${_.float(Cn)}, ${_.float(Cn)}, tileRows * tileRows);

      //Change from Y being height to Z being height
      vec3 p = float(${_.float(Az)}) * pos.xzy;

      //Pixel coordinates of point in the 3D data
      vec3 coord = vec3(mod(p - pOffset * atlasDimensions, atlasDimensions));
      float f = fract(coord.z);
      float level = floor(coord.z);
      float tileY = floor(level / tileRows);
      float tileX = level - tileY * tileRows;

      //The data coordinates are offset by the x and y tile, the two boundary cells between each tile pair and the initial boundary cell on the first row/column
      vec2 offset = atlasDimensions.x * vec2(tileX, tileY) + 2.0 * vec2(tileX, tileY) + 1.0;
      vec2 pixel = coord.xy + offset;
      vec2 data = texture2D(cloudShapeTexture, mod(pixel, dataWidth) / textureWidth).xy;

      return 1.0 - mix(data.x, data.y, f);
    }

    float getCloudMap(vec2 p){
      // Non-power-of-two textures can't be tiled using WebGL1
      // Get fractional part of uv to tile
      // Shift the texture center to origin to avoid seam artifacts
      vec2 uv = fract((${_.float(Dz)} * p) / ${_.float(so)} + 0.5);

      return texture2D(cloudShapeTexture, uv).a;
    }
    `),t.code.add(_`float clouds(vec3 p) {
float cloud = saturate(0.5 * mix(0.0, 1.0, min(2.0 * coverage, 1.0)));
if (cloud <= 0.0) {
return 0.0;
}
float cloudMap = getCloudMap(cloudSize * p.xy);
cloud = mix(cloud, min(2.0 * (coverage), 1.0) * cloudMap, min(2.0 * (1.0 - coverage), 1.0));
if (cloud <= 0.0) {
return 0.0;
}
float shape = getCloudShape(8.0 * cloudSize * p, 0.0);
cloud = saturate(remap(cloud, smoothness * shape, 1.0, 0.0, 1.0));
if (cloud <= 0.0) {
return 0.0;
}
float heightFraction = saturate((length(p) - cloudRadius - cloudStart) / cloudHeight);
cloud *= saturate(remap(heightFraction, 0.0, 0.25, 0.0, 1.0)) * smoothstep(1.0, 0.25, heightFraction);
if (cloud <= 0.0) {
return 0.0;
}
return density * saturate(remap(cloud, 0.35 * smoothness * getCloudShape(detailSize * p, 0.0), 1.0, 0.0, 1.0));
}`),t.code.add(_`vec2 sphereIntersections(vec3 start, vec3 dir, float radius) {
float a = dot(dir, dir);
float b = 2.0 * dot(dir, start);
float c = dot(start, start) - (radius * radius);
float d = (b * b) - 4.0 * a * c;
if (d < 0.0) {
return vec2(1e5, -1e5);
}
return vec2((-b - sqrt(d)) / (2.0 * a), (-b + sqrt(d)) / (2.0 * a));
}
float HenyeyGreenstein(float g, float costh) {
return (1.0 / (4.0 * 3.1415))  * ((1.0 - g * g) / pow(1.0 + g * g - 2.0 * g * costh, 1.5));
}`),t.code.add(`
    float multipleOctaves(float extinction, float mu, float stepL) {
      float attenuation = 1.0;
      float contribution = 1.0;
      float phaseAttenuation = 1.0;
      float luminance = 0.0;

      for (int i = 0; i < 4; i++) {
        float phase = mix(HenyeyGreenstein(0.0, mu), HenyeyGreenstein(0.3 * phaseAttenuation, mu), 0.7);
        luminance += contribution * phase * exp(-stepL * extinction * sigmaE * attenuation);
        attenuation *= 0.2;
        contribution *= 0.6;
        phaseAttenuation *= 0.5;
      }

      return luminance;
    }`),t.code.add(_`float lightRay(vec3 org, vec3 p, float phaseFunction, float mu, vec3 sunDirection) {
float lightRayDensity = clouds(p);
lightRayDensity += clouds(p + sunDirection * 1.0 * stepL);
lightRayDensity += clouds(p + sunDirection * 2.0 * stepL);
lightRayDensity += clouds(p + sunDirection * 3.0 * stepL);
lightRayDensity += clouds(p + sunDirection * 4.0 * stepL);
lightRayDensity += clouds(p + sunDirection * 5.0 * stepL);
float beersLaw = multipleOctaves(lightRayDensity, mu, stepL);
return mix(beersLaw * 2.0 * (1.0 - (exp(-stepL * lightRayDensity * 2.0 * sigmaE ))), beersLaw, 0.5 + 0.5 * mu);
}`),t.code.add(_`float mainRay(vec3 org, vec3 dir, vec3 sunDirection, float distToStart, float totalDistance, out float totalTransmittance) {
if (dir.z < 0.0) {
return 0.0;
}
totalTransmittance = 1.0;
float stepS = totalDistance / float(STEPS);
float cameraHeight = length(org);
float mu = 0.5 + 0.5 * dot(sunDirection, dir);
float phaseFunction = mix(HenyeyGreenstein(-0.3, mu), HenyeyGreenstein(0.3, mu), 0.7);
vec3 p = org + distToStart  * dir;
float dist = distToStart;
float shading = 0.0;
for (int i = 0; i < STEPS; i++) {
float sampleDensity = clouds(p);
float sampleSigmaE = sampleDensity * sigmaE;
if (sampleDensity > 0.0 ) {
float ambient = mix((1.2), (1.6), saturate((length(p) - cloudRadius - cloudStart) / cloudHeight));
float luminance = sampleDensity * (ambient + power * phaseFunction * lightRay(org, p, phaseFunction, mu, sunDirection));
float transmittance = exp(-sampleSigmaE * stepS);
shading += totalTransmittance * (luminance - luminance * transmittance) / sampleSigmaE;
totalTransmittance *= transmittance;
if (totalTransmittance <= 0.001) {
totalTransmittance = 0.0;
break;
}
}
dist += stepS;
p = org + dir * dist;
}
return shading;
}`),t.code.add(_`void main() {
if (coverage ==  0.0) {
gl_FragColor = vec4(0.0, 1.0, 0.0, 1.0);
return;
}
vec3 rayDir = rayDirection(gl_FragCoord.xy);
rayDir = normalize(view * rayDir);
vec3 viewPos = vec3(0, 0, cloudRadius + 1.0);
bool hitsPlanet = rayDir.z < 0.0;
float hazeFactor = smoothstep(-0.01, mix(0.0, 0.075, cloudVariables.x), abs(dot(rayDir, vec3(0, 0, 1))));
float totalTransmittance = 1.0;
float shading = 0.0;
if (hitsPlanet) {
shading = clamp(1.0 - cloudVariables.y, 0.6, 1.0) * (1.0 - hazeFactor);
totalTransmittance = hazeFactor;
gl_FragColor = vec4(shading, totalTransmittance, shading, totalTransmittance);
return;
}
vec2 rayStartIntersect = sphereIntersections(viewPos, rayDir, cloudRadius + cloudStart);
vec2 rayEndIntersect = sphereIntersections(viewPos, rayDir, cloudRadius + cloudStart + cloudHeight);
float distToStart = rayStartIntersect.y;
float totalDistance = rayEndIntersect.y - distToStart;
vec3 sunDirection = normalize(vec3(0, 0, 1));
shading = 0.5 * mainRay(viewPos, rayDir, sunDirection, distToStart, totalDistance, totalTransmittance);
shading = mix(clamp(1.0 - cloudVariables.y, 0.6, 1.0), shading, hazeFactor);
totalTransmittance = mix(0.0, totalTransmittance, hazeFactor);
gl_FragColor = vec4(shading, totalTransmittance, shading, totalTransmittance);
}`),e}const Lz=$e(),$z=Object.freeze(Object.defineProperty({__proto__:null,CloudsDrawParameters:BM,CloudsPassParameters:GM,build:Iz},Symbol.toStringTag,{value:"Module"}));let HM=class kM extends Mt{constructor(e,t){super(e,t,()=>this.destroy())}initializeProgram(e){return new Rt(e.rctx,kM.shader.get().build(this.configuration),Lt)}initializePipeline(){return qe({blending:oc(ae.CONSTANT_COLOR,ae.ONE_MINUS_CONSTANT_COLOR,eM.ADD,this.configuration.writeTextureChannels===Id.RG?[1,1,0,0]:[0,0,1,1]),depthTest:{func:Fa.LEQUAL},colorWrite:at})}};HM.shader=new Dt($z,()=>_e(()=>import("./Clouds.glsl-eba51ba5.js"),["assets/Clouds.glsl-eba51ba5.js","assets/calcite-8912bd40.js","assets/index-00759e4a.js","assets/index-5026a37a.css","assets/calcite-96fa36fd.css","assets/mat3f64-50f3b9f6.js","assets/OrderIndependentTransparency-5f7257d7.js","assets/enums-e2e92c86.js","assets/basicInterfaces-7449a8bf.js","assets/VertexAttribute-15d1866a.js","assets/objectResourceUtils-782953c3.js","assets/devEnvironmentUtils-5002a058.js","assets/mat4f64-abdda1bb.js","assets/BufferView-379a78a4.js","assets/vec33-69c9e93b.js","assets/DefaultMaterial_COLOR_GAMMA-6ed76d86.js","assets/types-e1c0a5bf.js","assets/Version-aa0a1d91.js","assets/quat-7b70e9a8.js","assets/quatf64-f8f1c132.js","assets/resourceUtils-527631ac.js","assets/Indices-d8bff7b2.js","assets/NestedMap-1b5db22e.js","assets/requestImageUtils-d1ba3b36.js","assets/symbolColorUtils-c9d24716.js","assets/Util-6d3f024a.js","assets/sphere-d0e5285d.js","assets/doublePrecisionUtils-e3c3d0d8.js","assets/Texture-563cf5e5.js","assets/FramebufferObject-8b18fc0c.js","assets/VertexElementDescriptor-2925c6af.js","assets/InterleavedLayout-d57c91d0.js","assets/vec3f32-01c06d8d.js","assets/plane-5e2b046c.js","assets/spatialReferenceEllipsoidUtils-afb35af9.js","assets/scaleUtils-d13015f2.js","assets/ElevationSamplerData-e3118b17.js","assets/Octree-499541ed.js","assets/edgeProcessing-20e12367.js","assets/deduplicate-769a6f51.js","assets/MeshComponent-788e605a.js","assets/earcut-61f7b102.js","assets/imageUtils-c2d0d1ae.js","assets/projection-5969b753.js","assets/ZoomMomentumEstimator-ef57e6a4.js","assets/floatRGBA-ca2b39ca.js","assets/dehydratedFeatures-3a140d03.js","assets/quantizationUtils-b3b2ae2a.js","assets/labelFormatUtils-71e1f841.js","assets/orientedBoundingBox-a14b97b5.js","assets/quatf32-51a323b8.js","assets/SnappingCandidate-970faec6.js","assets/callExpressionWithFeature-df1a8f01.js","assets/DefaultVertexAttributeLayouts-5f20d8dd.js","assets/geometryServiceUtils-a536bb19.js","assets/project-909a4219.js","assets/LercDecoder-65586d50.js","assets/VectorTile-d41a1f0f.js","assets/enums-fb086c25.js","assets/config-1337d16e.js","assets/TiledDisplayObject-419c008b.js","assets/DisplayObject-87c37b69.js","assets/rasterUtils-7694cc98.js","assets/resources-7587d8f4.js","assets/workerHelper-6131d203.js","assets/webgl-debug-7f880832.js","assets/RenderingContext-0f21aa0e.js","assets/ProgramCache-f29c900e.js","assets/Program-77209250.js","assets/MediaLayer-4c42fc2f.js","assets/MediaElementView-06baa4d4.js","assets/normalizeUtilsSync-3ea564a9.js","assets/resourceExtension-f31d9f10.js","assets/BoundsStore-00da37da.js","assets/PooledRBush-5a11bc7e.js","assets/prism-line-numbers-eff41b13.js","assets/label2-a2f37e65.js","assets/interactive-1de2e238.js","assets/loadable-6afd516d.js","assets/t9n-81df3a71.js","assets/observers-c89705b8.js","assets/icon-8e47fbec.js","assets/loader-c773e800.js","assets/guid-51402ee7.js","assets/prism-line-numbers-7c5d72ff.css"]));var an;(function(i){i[i.Full=0]="Full",i[i.WeatherMap=1]="WeatherMap",i[i.COUNT=2]="COUNT"})(an||(an={}));let Xx=class extends ua{constructor(){super(...arguments),this.mode=an.Full}};d([D({count:an.COUNT})],Xx.prototype,"mode",void 0);let jM=class extends Gi{constructor(){super(...arguments),this.weatherTile=It(0,0)}};function Nz(i){const e=new $t;return e.include(sc,!1),e.fragment.code.add(_`float remap(float x, float low1, float high1, float low2, float high2) {
return low2 + (x - low1) * (high2 - low2) / (high1 - low1);
}`),i.mode===an.Full&&e.fragment.code.add(_`
    float saturate(float x) {
      return clamp(x, 0.0, 1.0);
    }

    // Safer modulo for positive and negative values
    vec3 modulo(vec3 m, float n){
      return mod(mod(m, n) + n, n);
    }

    vec3 hash(vec3 p3, float frequency){
      p3 = modulo(p3, frequency);
      p3 = fract(p3 * vec3(0.1031, 0.1030, 0.0973));
      p3 += dot(p3, p3.yxz + 33.33);
      return -1.0 + 2.0 * fract((p3.xxy + p3.yxx) * p3.zyx);
    }

    // 5th order polynomial interpolation
    vec3 fade(vec3 t){
      return (t * t * t) * (t * (t * 6.0 - 15.0) + 10.0);
    }

    float gradientNoise(vec3 p, float frequency){
      // Cell point is in
      vec3 i = floor(p);

      // Position in the cell in [0, 1]
      vec3 f = fract(p);

      // Interpolation value for gradient mixing
      vec3 u = fade(f);

      // Trilinear interpolation of gradients at cube vertices around point
      return mix( mix( mix( dot( hash( i + vec3(0.0,0.0,0.0), frequency), f - vec3(0.0,0.0,0.0) ),
                            dot( hash( i + vec3(1.0,0.0,0.0), frequency), f - vec3(1.0,0.0,0.0) ), u.x),
                       mix( dot( hash( i + vec3(0.0,1.0,0.0), frequency), f - vec3(0.0,1.0,0.0) ),
                            dot( hash( i + vec3(1.0,1.0,0.0), frequency), f - vec3(1.0,1.0,0.0) ), u.x), u.y),
                  mix( mix( dot( hash( i + vec3(0.0,0.0,1.0), frequency), f - vec3(0.0,0.0,1.0) ),
                            dot( hash( i + vec3(1.0,0.0,1.0), frequency), f - vec3(1.0,0.0,1.0) ), u.x),
                       mix( dot( hash( i + vec3(0.0,1.0,1.0), frequency), f - vec3(0.0,1.0,1.0) ),
                            dot( hash( i + vec3(1.0,1.0,1.0), frequency), f - vec3(1.0,1.0,1.0) ), u.x), u.y), u.z );
    }

    float getPerlinNoise(vec3 pos, float frequency) {
      float octaveFrequencyFactor = 2.0;
      float sum = 0.0;
      float weightSum = 0.0;
      float weight = 1.0;

      for (int oct = 0; oct < 3; oct++) {
        vec3 p = pos * frequency;
        float val = 0.5 + 0.5 * gradientNoise(p, frequency);
        sum += val * weight;
        weightSum += weight;
        weight *= 0.5;
        frequency *= octaveFrequencyFactor;
      }

      float noise = (sum / weightSum);
      noise = saturate(noise);
      return noise;
    }

    float worley(vec3 pos, float numCells) {
      vec3 p = pos * numCells;
      float d = 1.0e10;

      for (int x = -1; x <= 1; x++) {
        for (int y = -1; y <= 1; y++) {
          for (int z = -1; z <= 1; z++) {
            vec3 tp = floor(p) + vec3(x, y, z);
            tp = p - tp - (hash(tp, numCells) * 0.5 + 0.5);
            d = min(d, dot(tp, tp));
          }
        }
      }

      return 1.0 - clamp(d, 0.0, 1.0);
    }

    vec3 get3Dfrom2D(vec2 uv) {
      vec2 tile = floor(uv);
      float z = floor(${_.float(Jn)} * tile.y + tile.x);
      return vec3(fract(uv), z);
    }

    float getTextureForPointPerlinWorley(vec3 p) {
      float perlinNoise = getPerlinNoise(p, ${_.float(8)});

      float worley0 = worley(p, ${_.float(2)} * 2.0);
      float worley1 = worley(p, ${_.float(2)} * 8.0);
      float worley2 = worley(p, ${_.float(2)} * 14.0);

      float worleyFBM = worley0 * 0.625 + worley1 * 0.25 + worley2 * 0.125;
      return remap(perlinNoise, 0.0, 1.0, worleyFBM, 1.0);
    }

    float getTextureForPointWorley(vec3 p) {
      float worley0 = worley(p, ${_.float(2)});
      float worley1 = worley(p, ${_.float(2)} * 2.0);
      float worley2 = worley(p, ${_.float(2)} * 4.0);
      float worley3 = worley(p, ${_.float(2)} * 8.0);

      float FBM0 = worley0 * 0.625 + worley1 * 0.25 + worley2 * 0.125;
      float FBM1 = worley1 * 0.625 + worley2 * 0.25 + worley3 * 0.125;
      float FBM2 = worley2 * 0.75 + worley3 * 0.25;

      return FBM0 * 0.625 + FBM1 * 0.25 + FBM2 * 0.125;
    }
  `),e.fragment.uniforms.add(new pi("weatherTile",t=>t.weatherTile)),e.fragment.code.add(_`
    vec2 modulo(vec2 m, float n){
      return mod(mod(m, n) + n, n);
    }

    vec2 hash(vec2 p){
      // Get position of p in weather tile
      p = modulo(p, ${_.float(E1)});

      // Get global coordinates of p
      p += weatherTile * ${_.float(E1)};

      // Limit position to avoid numerical instability
      p = modulo(p, ${_.float(Mz)});

      vec3 p3 = fract(vec3(p.xyx) * vec3(0.1031, 0.1030, 0.0973));
      p3 += dot(p3, p3.yzx + 33.33);
      return 2.0 * fract((p3.xx + p3.yz) * p3.zy) - 1.0;
    }

    vec2 fade(vec2 t){
      return (t * t * t) * (t * (t * 6.0 - 15.0) + 10.0);
    }

    float gradientNoise(vec2 p){
      vec2 i = floor( p );
      vec2 f = fract( p );

      vec2 u = fade(f);

      // Bilinear interpolation of gradients at cell vertices around point
      return  mix(
                mix(dot( hash( i + vec2(0.0,0.0) ), f - vec2(0.0,0.0) ),
                    dot( hash( i + vec2(1.0,0.0) ), f - vec2(1.0,0.0) ), u.x),
                mix(dot( hash( i + vec2(0.0,1.0) ), f - vec2(0.0,1.0) ),
                    dot( hash( i + vec2(1.0,1.0) ), f - vec2(1.0,1.0) ), u.x),
                u.y);
    }

    float worley(vec2 p){
      float d = 1.0e10;
      for (int x = -1; x <= 1; x++){
        for (int y = -1; y <= 1; y++){
                vec2 tp = floor(p) + vec2(x, y);
                tp = p - tp - (0.5 + 0.5 * hash(tp));
                d = min(d, dot(tp, tp));
            }
        }
      return 1.0 - clamp(d, 0.0, 1.0);
    }
  `),e.fragment.code.add(_`void main() {`),i.mode===an.Full&&e.fragment.code.add(_`
        float padWidth = 1.0;
        float paddedSize = ${_.float(Cn)} + 2.0 * padWidth;
        float tileCount = ${_.float(Jn)} * ${_.float(Jn)};
        vec2 tile = floor((gl_FragCoord.xy - 0.5) / paddedSize);

        bool padCell = false;
        if (mod(gl_FragCoord.x, paddedSize) == 0.5 || mod(gl_FragCoord.x, paddedSize) == paddedSize - 0.5) {
          padCell = true;
        }

        if (mod(gl_FragCoord.y, paddedSize) == 0.5 || mod(gl_FragCoord.y, paddedSize) == paddedSize - 0.5) {
          padCell = true;
        }

        bool startPadX = false;
        bool startPadY = false;
        bool endPadX = false;
        bool endPadY = false;

        if (gl_FragCoord.x == tile.x * paddedSize + 0.5) {
          startPadX = true;
        }

        if (gl_FragCoord.y == tile.y * paddedSize + 0.5) {
          startPadY = true;
        }

        if (gl_FragCoord.x == (tile.x + 1.0) * paddedSize - 0.5) {
          endPadX = true;
        }

        if (gl_FragCoord.y == (tile.y + 1.0) * paddedSize - 0.5) {
          endPadY = true;
        }

        vec2 padding = vec2(2.0 * padWidth) * tile;
        vec2 uv;

        if (padCell) {
          vec2 pixel = gl_FragCoord.xy - padWidth - padding;

          if (startPadX) {
            pixel.x += ${_.float(Cn)};
          }

          if (startPadY) {
            pixel.y += ${_.float(Cn)};
          }

          if (endPadX) {
            pixel.x -= ${_.float(Cn)};
          }

          if (endPadY) {
            pixel.y -= ${_.float(Cn)};
          }

          uv = vec2(pixel.xy / ${_.float(Cn)});
        } else {
          vec2 pixel = gl_FragCoord.xy - padWidth - padding;
          uv = vec2(pixel.xy / ${_.float(Cn)});
        }

        vec3 p_ = get3Dfrom2D(uv);
        vec3 p = p_;
        p.z /= (${_.float(Jn)} * ${_.float(Jn)});

        float worleyPerlinNoise = getTextureForPointPerlinWorley(p);
        float worleyNoise = getTextureForPointWorley(p);

        gl_FragColor.r = saturate(remap(worleyPerlinNoise, worleyNoise, 1.0, 0.0, 1.0));

        p_ = mod(p_ + 1.0, ${_.float(Jn)} * ${_.float(Jn)});
        p = p_;
        p.z /= (${_.float(Jn)} * ${_.float(Jn)});

        worleyPerlinNoise = getTextureForPointPerlinWorley(p);
        worleyNoise = getTextureForPointWorley(p);

        gl_FragColor.g = saturate(remap(worleyPerlinNoise, worleyNoise, 1.0, 0.0, 1.0));
      `),e.fragment.code.add(_`
      vec2 mapUV = ${_.float(E1)} * (gl_FragCoord.xy / ${_.float(so)});
      float map = abs(gradientNoise(mapUV));
      map = remap(map, 0.25 * (1.0 - worley(8.0 * mapUV)), 1.0, 0.0, 1.0);

      ${i.mode===an.Full?_`gl_FragColor.ba = vec2(0.0, map);`:_`gl_FragColor = vec4(map);`};
    }
  `),e}const Fz=Object.freeze(Object.defineProperty({__proto__:null,NoiseTextureAtlasPassParameters:jM,build:Nz},Symbol.toStringTag,{value:"Module"}));let Qx=class qM extends Mt{initializeProgram(e){return new Rt(e.rctx,qM.shader.get().build(this.configuration),Lt)}initializePipeline(){return qe({blending:this.configuration.mode===an.Full?oc(ae.ONE,ae.ZERO):Ar(ae.ZERO,ae.ONE,ae.ONE,ae.ZERO),depthTest:{func:Fa.ALWAYS},colorWrite:at})}};Qx.shader=new Dt(Fz,()=>_e(()=>import("./NoiseTextureAtlas.glsl-c19a065f.js"),["assets/NoiseTextureAtlas.glsl-c19a065f.js","assets/calcite-8912bd40.js","assets/index-00759e4a.js","assets/index-5026a37a.css","assets/calcite-96fa36fd.css","assets/OrderIndependentTransparency-5f7257d7.js","assets/enums-e2e92c86.js","assets/basicInterfaces-7449a8bf.js","assets/VertexAttribute-15d1866a.js","assets/objectResourceUtils-782953c3.js","assets/devEnvironmentUtils-5002a058.js","assets/mat3f64-50f3b9f6.js","assets/mat4f64-abdda1bb.js","assets/BufferView-379a78a4.js","assets/vec33-69c9e93b.js","assets/DefaultMaterial_COLOR_GAMMA-6ed76d86.js","assets/types-e1c0a5bf.js","assets/Version-aa0a1d91.js","assets/quat-7b70e9a8.js","assets/quatf64-f8f1c132.js","assets/resourceUtils-527631ac.js","assets/Indices-d8bff7b2.js","assets/NestedMap-1b5db22e.js","assets/requestImageUtils-d1ba3b36.js","assets/symbolColorUtils-c9d24716.js","assets/Util-6d3f024a.js","assets/sphere-d0e5285d.js","assets/doublePrecisionUtils-e3c3d0d8.js","assets/Texture-563cf5e5.js","assets/FramebufferObject-8b18fc0c.js","assets/VertexElementDescriptor-2925c6af.js","assets/InterleavedLayout-d57c91d0.js","assets/vec3f32-01c06d8d.js","assets/plane-5e2b046c.js","assets/spatialReferenceEllipsoidUtils-afb35af9.js","assets/scaleUtils-d13015f2.js","assets/ElevationSamplerData-e3118b17.js","assets/Octree-499541ed.js","assets/edgeProcessing-20e12367.js","assets/deduplicate-769a6f51.js","assets/MeshComponent-788e605a.js","assets/earcut-61f7b102.js","assets/imageUtils-c2d0d1ae.js","assets/projection-5969b753.js","assets/ZoomMomentumEstimator-ef57e6a4.js","assets/floatRGBA-ca2b39ca.js","assets/dehydratedFeatures-3a140d03.js","assets/quantizationUtils-b3b2ae2a.js","assets/labelFormatUtils-71e1f841.js","assets/orientedBoundingBox-a14b97b5.js","assets/quatf32-51a323b8.js","assets/SnappingCandidate-970faec6.js","assets/callExpressionWithFeature-df1a8f01.js","assets/DefaultVertexAttributeLayouts-5f20d8dd.js","assets/geometryServiceUtils-a536bb19.js","assets/project-909a4219.js","assets/LercDecoder-65586d50.js","assets/VectorTile-d41a1f0f.js","assets/enums-fb086c25.js","assets/config-1337d16e.js","assets/TiledDisplayObject-419c008b.js","assets/DisplayObject-87c37b69.js","assets/rasterUtils-7694cc98.js","assets/resources-7587d8f4.js","assets/workerHelper-6131d203.js","assets/webgl-debug-7f880832.js","assets/RenderingContext-0f21aa0e.js","assets/ProgramCache-f29c900e.js","assets/Program-77209250.js","assets/MediaLayer-4c42fc2f.js","assets/MediaElementView-06baa4d4.js","assets/normalizeUtilsSync-3ea564a9.js","assets/resourceExtension-f31d9f10.js","assets/BoundsStore-00da37da.js","assets/PooledRBush-5a11bc7e.js","assets/prism-line-numbers-eff41b13.js","assets/label2-a2f37e65.js","assets/interactive-1de2e238.js","assets/loadable-6afd516d.js","assets/t9n-81df3a71.js","assets/observers-c89705b8.js","assets/icon-8e47fbec.js","assets/loader-c773e800.js","assets/guid-51402ee7.js","assets/prism-line-numbers-7c5d72ff.css"]));let sg=class extends Ie{constructor(e){super(e),this._needsRender=!0,this._passParameters=new jM,this._frameBuffer=new Rs(e.context.renderContext.rctx,{colorTarget:la.TEXTURE,width:so,height:so},{target:tr.TEXTURE_2D,pixelFormat:St.RGBA,dataType:Zt.UNSIGNED_BYTE,wrapMode:kt.CLAMP_TO_EDGE,samplingMode:Qt.LINEAR,hasMipmap:!1,width:so,height:so}),this._vao=pa(e.context.renderContext.rctx)}get _techniqueRepository(){return this.context.techniqueRepository}get textureAtlas(){return g(this._texture)?g(this._weatherMapTechnique)&&this._weatherMapTechnique.compiled&&this._needsRender&&(this._texture=this._render(an.WeatherMap)):g(this._fullTechnique)&&this._fullTechnique.compiled&&(this._texture=this._render(an.Full)),this._texture}_setDirty(){this._needsRender=!0}updateWeatherMap(e){this._passParameters.weatherTile[0]===e[0]&&this._passParameters.weatherTile[1]===e[1]||(fs(this._passParameters.weatherTile,e),this._setDirty())}destroy(){this._fullTechniqueCached=er(this._fullTechniqueCached),this._weatherMapTechniqueCached=er(this._weatherMapTechniqueCached),this._frameBuffer=De(this._frameBuffer),this._vao=De(this._vao)}get _fullTechnique(){if(P(this._fullTechniqueCached)){const e=new Xx;e.mode=an.Full,this._fullTechniqueCached=this._techniqueRepository.acquire(Qx,e)}return this._fullTechniqueCached}get _weatherMapTechnique(){if(P(this._weatherMapTechniqueCached)){const e=new Xx;e.mode=an.WeatherMap,this._weatherMapTechniqueCached=this._techniqueRepository.acquire(Qx,e)}return this._weatherMapTechniqueCached}_render(e){if(P(this._vao)||P(this._frameBuffer))return null;const t=e===an.Full?this._fullTechnique:this._weatherMapTechnique,r=this.context.renderContext.rctx,s=r.getViewport();r.setViewport(0,0,so,so),r.bindFramebuffer(this._frameBuffer);const a=r.bindTechnique(t,this._passParameters,null);return r.bindVAO(this._vao),a.assertCompatibleVertexAttributeLocations(this._vao),r.gl.drawArrays(r.gl.TRIANGLE_STRIP,0,4),r.setViewport(s.x,s.y,s.width,s.height),this._needsRender=!1,this._frameBuffer.colorTexture}};d([v({constructOnly:!0})],sg.prototype,"context",void 0),d([v({readOnly:!0})],sg.prototype,"_techniqueRepository",null),sg=d([Y("esri.views.3d.environment.NoiseTextureAtlas")],sg);function WM(i){i.include(ml),i.uniforms.add([new lt("geometryDepthTexture",(e,t)=>t.multipassGeometry.linearDepthTexture),new pi("nearFar",(e,t)=>t.camera.nearFar)]),i.code.add(_`bool geometryDepthTest(vec2 pos, float elementDepth) {
float geometryDepth = linearDepthFromTexture(geometryDepthTexture, pos, nearFar);
return (elementDepth < (geometryDepth - 1.0));
}`)}let zz=class{constructor(){this.enabled=!1}};function Uz(i,e){const t=i.fragment;t.include(ml),t.uniforms.add(new pi("nearFar",(r,s)=>s.camera.nearFar)),t.uniforms.add(new lt("depthMap",(r,s)=>s.linearDepthTexture)),t.uniforms.add(new ir("proj",(r,s)=>s.ssr.camera.projectionMatrix)),t.uniforms.add(new ue("invResolutionHeight",(r,s)=>1/s.ssr.camera.height)),t.uniforms.add(new ir("reprojectionMatrix",(r,s)=>s.ssr.reprojectionMatrix)),t.code.add(_`
  vec2 reprojectionCoordinate(vec3 projectionCoordinate)
  {
    vec4 zw = proj * vec4(0.0, 0.0, -projectionCoordinate.z, 1.0);
    vec4 reprojectedCoord = reprojectionMatrix * vec4(zw.w * (projectionCoordinate.xy * 2.0 - 1.0), zw.z, zw.w);
    reprojectedCoord.xy /= reprojectedCoord.w;
    return reprojectedCoord.xy * 0.5 + 0.5;
  }

  const int maxSteps = ${e.highStepCount?"150":"75"};

  vec4 applyProjectionMat(mat4 projectionMat, vec3 x)
  {
    vec4 projectedCoord =  projectionMat * vec4(x, 1.0);
    projectedCoord.xy /= projectedCoord.w;
    projectedCoord.xy = projectedCoord.xy*0.5 + 0.5;
    return projectedCoord;
  }

  vec3 screenSpaceIntersection(vec3 dir, vec3 startPosition, vec3 viewDir, vec3 normal)
  {
    vec3 viewPos = startPosition;
    vec3 viewPosEnd = startPosition;

    // Project the start position to the screen
    vec4 projectedCoordStart = applyProjectionMat(proj, viewPos);
    vec3  Q0 = viewPos / projectedCoordStart.w; // homogeneous camera space
    float k0 = 1.0/ projectedCoordStart.w;

    // advance the position in the direction of the reflection
    viewPos += dir;

    vec4 projectedCoordVanishingPoint = applyProjectionMat(proj, dir);

    // Project the advanced position to the screen
    vec4 projectedCoordEnd = applyProjectionMat(proj, viewPos);
    vec3  Q1 = viewPos / projectedCoordEnd.w; // homogeneous camera space
    float k1 = 1.0/ projectedCoordEnd.w;

    // calculate the reflection direction in the screen space
    vec2 projectedCoordDir = (projectedCoordEnd.xy - projectedCoordStart.xy);
    vec2 projectedCoordDistVanishingPoint = (projectedCoordVanishingPoint.xy - projectedCoordStart.xy);

    float yMod = min(abs(projectedCoordDistVanishingPoint.y), 1.0);

    float projectedCoordDirLength = length(projectedCoordDir);
    float maxSt = float(maxSteps);

    // normalize the projection direction depending on maximum steps
    // this determines how blocky the reflection looks
    vec2 dP = yMod * (projectedCoordDir)/(maxSt * projectedCoordDirLength);

    // Normalize the homogeneous camera space coordinates
    vec3  dQ = yMod * (Q1 - Q0)/(maxSt * projectedCoordDirLength);
    float dk = yMod * (k1 - k0)/(maxSt * projectedCoordDirLength);

    // initialize the variables for ray marching
    vec2 P = projectedCoordStart.xy;
    vec3 Q = Q0;
    float k = k0;
    float rayStartZ = -startPosition.z; // estimated ray start depth value
    float rayEndZ = -startPosition.z;   // estimated ray end depth value
    float prevEstimateZ = -startPosition.z;
    float rayDiffZ = 0.0;
    float dDepth;
    float depth;
    float rayDiffZOld = 0.0;

    // early outs
    if (dot(normal, dir) < 0.0 || dot(-viewDir, normal) < 0.0)
      return vec3(P, 0.0);

    for(int i = 0; i < maxSteps-1; i++)
    {
      depth = -linearDepthFromTexture(depthMap, P, nearFar); // get linear depth from the depth buffer

      // estimate depth of the marching ray
      rayStartZ = prevEstimateZ;
      dDepth = -rayStartZ - depth;
      rayEndZ = (dQ.z * 0.5 + Q.z)/ ((dk * 0.5 + k));
      rayDiffZ = rayEndZ- rayStartZ;
      prevEstimateZ = rayEndZ;

      if(-rayEndZ > nearFar[1] || -rayEndZ < nearFar[0] || P.y < 0.0  || P.y > 1.0 )
      {
        return vec3(P, 0.);
      }

      // If we detect a hit - return the intersection point, two conditions:
      //  - dDepth > 0.0 - sampled point depth is in front of estimated depth
      //  - if difference between dDepth and rayDiffZOld is not too large
      //  - if difference between dDepth and 0.025/abs(k) is not too large
      //  - if the sampled depth is not behind far plane or in front of near plane

      if((dDepth) < 0.025/abs(k) + abs(rayDiffZ) && dDepth > 0.0 && depth > nearFar[0] && depth < nearFar[1] && abs(P.y - projectedCoordStart.y) > invResolutionHeight)
      {
        return vec3(P, depth);
      }

      // continue with ray marching
      P += dP;
      Q.z += dQ.z;
      k += dk;
      rayDiffZOld = rayDiffZ;
    }
    return vec3(P, 0.0);
  }
  `)}let Vz=class{constructor(){this.enabled=!1,this.fadeFactor=1,this.reprojectionMatrix=ce()}};function Gz(i,e,t){return 2*Math.atan(Math.sqrt(e*e+t*t)*Math.tan(.5*i)/e)}function Bz(i,e,t){return 2*Math.atan(Math.sqrt(e*e+t*t)*Math.tan(.5*i)/t)}function Hz(i,e,t){return 2*Math.atan(e*Math.tan(.5*i)/Math.sqrt(e*e+t*t))}function kz(i,e,t){return 2*Math.atan(t*Math.tan(.5*i)/Math.sqrt(e*e+t*t))}var Zx;let Fe=Zx=class extends Ie{constructor(i={}){super(i),this._center=T(),this._up=T(),this._viewUp=T(),this._viewForward=T(),this._viewRight=T(),this._ray=Aa(),this._viewport=hi(0,0,1,1),this._padding=hi(0,0,0,0),this._fov=55/180*Math.PI,this._nearFar=It(1,1e3),this._viewDirty=!0,this._viewMatrix=ce(),this._viewProjectionDirty=!0,this._viewProjectionMatrix=ce(),this._viewInverseTransposeMatrixDirty=!0,this._viewInverseTransposeMatrix=ce(),this._frustumDirty=!0,this._frustum=tf(),this._fullViewport=Pt(),this._pixelRatio=1,this.relativeElevation=0}get pixelRatio(){return this._pixelRatio}set pixelRatio(i){this._pixelRatio=i>0?i:1}get eye(){return this._ray.origin}set eye(i){this._compareAndSetView(i,this._ray.origin)}get center(){return this._center}set center(i){this._compareAndSetView(i,this._center,"_center")}get ray(){return Q(this._ray.direction,this.center,this.eye),this._ray}get up(){return this._up}set up(i){this._compareAndSetView(i,this._up,"_up")}get viewMatrix(){return this._ensureViewClean(),this._viewMatrix}set viewMatrix(i){Kr(this._viewMatrix,i),this._viewDirty=!1,this._viewInverseTransposeMatrixDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}get viewForward(){return this._ensureViewClean(),this._viewForward}get viewUp(){return this._ensureViewClean(),this._viewUp}get viewRight(){return this._ensureViewClean(),this._viewRight}get nearFar(){return this._nearFar}get near(){return this._nearFar[0]}set near(i){this._nearFar[0]!==i&&(this._nearFar[0]=i,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_nearFar"))}get far(){return this._nearFar[1]}set far(i){this._nearFar[1]!==i&&(this._nearFar[1]=i,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_nearFar"))}get viewport(){return this._viewport}set viewport(i){this.x=i[0],this.y=i[1],this.width=i[2],this.height=i[3]}get screenViewport(){if(this.pixelRatio===1)return this._viewport;const i=sv(Pt(),this._viewport,1/this.pixelRatio),e=this._get("screenViewport");return e&&T4(i,e)?e:i}get x(){return this._viewport[0]}set x(i){i+=this._padding[rt.LEFT],this._viewport[0]!==i&&(this._viewport[0]=i,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_viewport"))}get y(){return this._viewport[1]}set y(i){i+=this._padding[rt.BOTTOM],this._viewport[1]!==i&&(this._viewport[1]=i,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_viewport"))}get width(){return this._viewport[2]}set width(i){this._viewport[2]!==i&&(this._viewport[2]=i,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_viewport"))}get height(){return this._viewport[3]}set height(i){this._viewport[3]!==i&&(this._viewport[3]=i,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_viewport"))}get fullWidth(){return this._viewport[2]+this._padding[rt.RIGHT]+this._padding[rt.LEFT]}set fullWidth(i){this.width=i-(this._padding[rt.RIGHT]+this._padding[rt.LEFT])}get fullHeight(){return this._viewport[3]+this._padding[rt.TOP]+this._padding[rt.BOTTOM]}set fullHeight(i){this.height=i-(this._padding[rt.TOP]+this._padding[rt.BOTTOM])}get fullViewport(){return this._fullViewport[0]=this._viewport[0]-this._padding[rt.LEFT],this._fullViewport[1]=this._viewport[1]-this._padding[rt.BOTTOM],this._fullViewport[2]=this.fullWidth,this._fullViewport[3]=this.fullHeight,this._fullViewport}get _aspect(){return this.width/this.height}get padding(){return this._padding}set padding(i){E0(this._padding,i)||(this._viewport[0]+=i[rt.LEFT]-this._padding[rt.LEFT],this._viewport[1]+=i[rt.BOTTOM]-this._padding[rt.BOTTOM],this._viewport[2]-=i[rt.RIGHT]+i[rt.LEFT]-(this._padding[rt.RIGHT]+this._padding[rt.LEFT]),this._viewport[3]-=i[rt.TOP]+i[rt.BOTTOM]-(this._padding[rt.TOP]+this._padding[rt.BOTTOM]),Zc(this._padding,i),this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_padding"),this.notifyChange("_viewport"))}get viewProjectionMatrix(){return this._viewProjectionDirty&&(pr(this._viewProjectionMatrix,this.projectionMatrix,this.viewMatrix),this._viewProjectionDirty=!1),this._viewProjectionMatrix}get projectionMatrix(){const i=this.width,e=this.height,t=this.near*Math.tan(this.fovY/2),r=t*this._aspect,s=C4(ce(),-r*(1+2*this._padding[rt.LEFT]/i),r*(1+2*this._padding[rt.RIGHT]/i),-t*(1+2*this._padding[rt.BOTTOM]/e),t*(1+2*this._padding[rt.TOP]/e),this.near,this.far),a=this._get("projectionMatrix");return a&&DA(a,s)?a:s}get inverseProjectionMatrix(){return $a(ce(),this.projectionMatrix)||this._get("inverseProjectionMatrix")||ce()}get fov(){return this._fov}set fov(i){this._fov=i,this._viewProjectionDirty=!0,this._frustumDirty=!0}get fovX(){return Hz(this._fov,this.width,this.height)}set fovX(i){this._fov=Gz(i,this.width,this.height),this._viewProjectionDirty=!0,this._frustumDirty=!0}get fovY(){return kz(this._fov,this.width,this.height)}set fovY(i){this._fov=Bz(i,this.width,this.height),this._viewProjectionDirty=!0,this._frustumDirty=!0}get distance(){return yi(this.center,this.eye)}get frustum(){return this._recomputeFrustum(),this._frustum}get viewInverseTransposeMatrix(){return(this._viewInverseTransposeMatrixDirty||this._viewDirty)&&($a(this._viewInverseTransposeMatrix,this.viewMatrix),iT(this._viewInverseTransposeMatrix,this._viewInverseTransposeMatrix),this._viewInverseTransposeMatrixDirty=!1),this._viewInverseTransposeMatrix}depthNDCToWorld(i){const e=2*i-1;return 2*this.near*this.far/(this.far+this.near-e*(this.far-this.near))}get perRenderPixelRatio(){return Math.tan(this.fovX/2)/(this.width/2)}get perScreenPixelRatio(){return this.perRenderPixelRatio*this.pixelRatio}get aboveGround(){return this.relativeElevation!=null&&this.relativeElevation>=0}copyFrom(i){H(this._ray.origin,i.eye),this.center=i.center,this.up=i.up,Zc(this._viewport,i.viewport),this.notifyChange("_viewport"),Zc(this._padding,i.padding),this.notifyChange("_padding"),fs(this._nearFar,i.nearFar),this.notifyChange("_nearFar"),this._fov=i.fov,this.relativeElevation=i.relativeElevation;const e=i;return this._viewDirty=e._viewDirty,this._viewDirty||(Kr(this._viewMatrix,i.viewMatrix),H(this._viewRight,i.viewRight),H(this._viewUp,i.viewUp),H(this._viewForward,i.viewForward)),this._viewProjectionDirty=!0,this._frustumDirty=e._frustumDirty,this._frustumDirty||(gy(this._frustum,i.frustum),this._frustumDirty=!1),e._viewInverseTransposeMatrixDirty?this._viewInverseTransposeMatrixDirty=!0:(Kr(this._viewInverseTransposeMatrix,i.viewInverseTransposeMatrix),this._viewInverseTransposeMatrixDirty=!1),Zc(this._fullViewport,i.fullViewport),this.pixelRatio=i.pixelRatio,this}copyViewFrom(i){this.eye=i.eye,this.center=i.center,this.up=i.up}clone(){return new Zx().copyFrom(this)}equals(i){return An(this.eye,i.eye)&&An(this.center,i.center)&&An(this.up,i.up)&&E0(this._viewport,i.viewport)&&E0(this._padding,i.padding)&&S4(this.nearFar,i.nearFar)&&this._fov===i.fov&&this.pixelRatio===i.pixelRatio&&this.relativeElevation===i.relativeElevation}almostEquals(i){if(Math.abs(i.fov-this._fov)>=.001||$S(i.padding,this._padding)>=.5||$S(this.screenViewport,i.screenViewport)>=.5)return!1;Xr(rs,i.eye,i.center),Xr(A1,this.eye,this.center);const e=J(rs,A1),t=NS(rs),r=NS(A1),s=5e-4;return e*e>=(1-1e-10)*t*r&&IA(i.eye,this.eye)<Math.max(t,r)*s*s}computeRenderPixelSizeAt(i){return this.computeRenderPixelSizeAtDist(this._viewDirectionDistance(i))}computeRenderPixelSizeAtDist(i){return i*this.perRenderPixelRatio}computeScreenPixelSizeAt(i){return this.computeScreenPixelSizeAtDist(this._viewDirectionDistance(i))}_viewDirectionDistance(i){return Math.abs(wg(this.viewForward,Q(rs,i,this.eye)))}computeScreenPixelSizeAtDist(i){return i*this.perScreenPixelRatio}computeDistanceFromRadius(i,e){return i/Math.tan(Math.min(this.fovX,this.fovY)/(2*(e||1)))}getScreenCenter(i=Pi()){return i[0]=(this.padding[rt.LEFT]+this.width/2)/this.pixelRatio,i[1]=(this.padding[rt.TOP]+this.height/2)/this.pixelRatio,i}getRenderCenter(i,e=.5,t=.5){return i[0]=this.padding[rt.LEFT]+this.width*e,i[1]=this.padding[rt.BOTTOM]+this.height*t,i[2]=.5,i}setGLViewport(i){const e=this.viewport,t=this.padding;i.setViewport(e[0]-t[3],e[1]-t[2],e[2]+t[1]+t[3],e[3]+t[0]+t[2])}applyProjection(i,e){i!==it&&H(it,i),it[3]=1,Ul(it,it,this.projectionMatrix);const t=Math.abs(it[3]);B(it,it,1/t);const r=this.fullViewport;e[0]=st(0,r[0]+r[2],.5+.5*it[0]),e[1]=st(0,r[1]+r[3],.5+.5*it[1]),e[2]=.5*(it[2]+1),e[3]=t}unapplyProjection(i,e){const t=this.fullViewport;it[0]=(i[0]/(t[0]+t[2])*2-1)*i[3],it[1]=(i[1]/(t[1]+t[3])*2-1)*i[3],it[2]=(2*i[2]-1)*i[3],it[3]=i[3],this.inverseProjectionMatrix!=null&&(Ul(it,it,this.inverseProjectionMatrix),e[0]=it[0],e[1]=it[1],e[2]=it[2])}projectToScreen(i,e){return this.projectToRenderScreen(i,M1),this.renderToScreen(M1,e),e}projectToRenderScreen(i,e){if(it[0]=i[0],it[1]=i[1],it[2]=i[2],it[3]=1,Ul(it,it,this.viewProjectionMatrix),it[3]===0)return null;B(it,it,1/Math.abs(it[3]));const t=this.fullViewport;return"x"in e?(e.x=st(0,t[0]+t[2],.5+.5*it[0]),e.y=st(0,t[1]+t[3],.5+.5*it[1])):(e[0]=st(0,t[0]+t[2],.5+.5*it[0]),e[1]=st(0,t[1]+t[3],.5+.5*it[1]),e.length>2&&(e[2]=.5*(it[2]+1))),e}unprojectFromScreen(i,e){return this.unprojectFromRenderScreen(this.screenToRender(i,M1),e)}unprojectFromRenderScreen(i,e){if(pr(l_,this.projectionMatrix,this.viewMatrix),!$a(l_,l_))return null;const t=this.fullViewport;return it[0]=2*(i[0]-t[0])/t[2]-1,it[1]=2*(i[1]-t[1])/t[3]-1,it[2]=2*i[2]-1,it[3]=1,Ul(it,it,l_),it[3]===0?null:(e[0]=it[0]/it[3],e[1]=it[1]/it[3],e[2]=it[2]/it[3],e)}constrainWindowSize(i,e,t,r){const s=i*this.pixelRatio,a=e*this.pixelRatio,n=Math.max(s-t/2,0),o=Math.max(this.fullHeight-a-r/2,0),l=-Math.min(s-t/2,0),c=-Math.min(this.fullHeight-a-r/2,0);return[n,o,t-l- -Math.min(this.fullWidth-s-t/2,0),r-c- -Math.min(a-r/2,0)]}computeUp(i){i===ve.Global?this._computeUpGlobal():this._computeUpLocal()}screenToRender(i,e){const t=i[0]*this.pixelRatio,r=this.fullHeight-i[1]*this.pixelRatio;return e[0]=t,e[1]=r,e}renderToScreen(i,e){const t=i[0]/this.pixelRatio,r=(this.fullHeight-i[1])/this.pixelRatio;e[0]=t,e[1]=r}_computeUpGlobal(){Q(rs,this.center,this.eye);const i=pe(this.center);i<1?(j(this._up,0,0,1),this._markViewDirty(),this.notifyChange("_up")):Math.abs(J(rs,this.center))>.9999*pe(rs)*i||(Be(this._up,rs,this.center),Be(this._up,this._up,rs),W(this._up,this._up),this.notifyChange("_up"),this._markViewDirty())}_computeUpLocal(){Bd(rs,this.eye,this.center),Math.abs(rs[2])<=.9999&&(B(rs,rs,rs[2]),j(this._up,-rs[0],-rs[1],1-rs[2]),W(this._up,this._up),this.notifyChange("_up"),this._markViewDirty())}_compareAndSetView(i,e,t=""){typeof i[0]=="number"&&isFinite(i[0])&&typeof i[1]=="number"&&isFinite(i[1])&&typeof i[2]=="number"&&isFinite(i[2])?An(i,e)||(H(e,i),this._markViewDirty(),t.length&&this.notifyChange(t)):Pe.getLogger("esri.views.3d.webgl-engine.lib.Camera").warn("Camera vector contains invalid number, ignoring value")}_markViewDirty(){this._viewDirty=!0,this._frustumDirty=!0,this._viewProjectionDirty=!0}_recomputeFrustum(){this._frustumDirty&&(rM(this.viewMatrix,this.projectionMatrix,this._frustum),this._frustumDirty=!1)}_ensureViewClean(){this._viewDirty&&(sT(this._viewMatrix,this.eye,this.center,this.up),j(this._viewForward,-this._viewMatrix[2],-this._viewMatrix[6],-this._viewMatrix[10]),j(this._viewUp,this._viewMatrix[1],this._viewMatrix[5],this._viewMatrix[9]),j(this._viewRight,this._viewMatrix[0],this._viewMatrix[4],this._viewMatrix[8]),this._viewDirty=!1,this._viewInverseTransposeMatrixDirty=!0)}};d([v()],Fe.prototype,"_center",void 0),d([v()],Fe.prototype,"_up",void 0),d([v()],Fe.prototype,"_viewport",void 0),d([v()],Fe.prototype,"_padding",void 0),d([v()],Fe.prototype,"_fov",void 0),d([v()],Fe.prototype,"_nearFar",void 0),d([v()],Fe.prototype,"_pixelRatio",void 0),d([v()],Fe.prototype,"pixelRatio",null),d([v()],Fe.prototype,"eye",null),d([v()],Fe.prototype,"center",null),d([v()],Fe.prototype,"up",null),d([v({readOnly:!0})],Fe.prototype,"nearFar",null),d([v()],Fe.prototype,"near",null),d([v()],Fe.prototype,"far",null),d([v()],Fe.prototype,"viewport",null),d([v({readOnly:!0})],Fe.prototype,"screenViewport",null),d([v()],Fe.prototype,"x",null),d([v()],Fe.prototype,"y",null),d([v()],Fe.prototype,"width",null),d([v()],Fe.prototype,"height",null),d([v()],Fe.prototype,"fullWidth",null),d([v()],Fe.prototype,"fullHeight",null),d([v({readOnly:!0})],Fe.prototype,"_aspect",null),d([v()],Fe.prototype,"padding",null),d([v({readOnly:!0})],Fe.prototype,"projectionMatrix",null),d([v({readOnly:!0})],Fe.prototype,"inverseProjectionMatrix",null),d([v()],Fe.prototype,"fov",null),d([v()],Fe.prototype,"fovX",null),d([v()],Fe.prototype,"fovY",null),Fe=Zx=d([Y("esri.views.3d.webgl-engine.lib.Camera")],Fe);const it=Pt(),l_=ce(),rs=T(),A1=T(),M1=Zr();var rt;(function(i){i[i.TOP=0]="TOP",i[i.RIGHT=1]="RIGHT",i[i.BOTTOM=2]="BOTTOM",i[i.LEFT=3]="LEFT"})(rt||(rt={}));let Rv=class{constructor(e,t,r){this.shadowMap=e,this.ssaoHelper=t,this.slicePlane=r,this.slot=K.OPAQUE_MATERIAL,this.hasOccludees=!1,this.enableFillLights=!0,this.transparencyPassType=We.NONE,this._camera=new Fe,this._inverseViewport=$e(),this.oldLighting=new m1,this.newLighting=new m1,this._fadedLighting=new m1,this._lighting=this.newLighting,this.ssr=new Vz,this.multipassTerrain=new hF,this.multipassGeometry=new zz,this.overlays=[],this.cloudsFade=new Cz}get camera(){return this._camera}set camera(e){this._camera=this.ssr.camera=e,this._inverseViewport[0]=1/e.fullViewport[2],this._inverseViewport[1]=1/e.fullViewport[3]}get inverseViewport(){return this._inverseViewport}get lighting(){return this._lighting}get weatherFading(){return this._lighting===this._fadedLighting}fadeLighting(e){const{oldLighting:t,newLighting:r}=this;e>=1?this._lighting=r:(this._fadedLighting.lerpLighting(t,r,e),this._lighting=this._fadedLighting)}},Vs=class extends Ie{constructor(e){super(e),this._handles=new Vi,this._techniques=new Array,this._techniqueConfiguration=new N0,this._bindParameters=new Rv(null,null,null),this._passParameters=new GM,this._drawParameters=new BM,this._weatherTile=$e(),this._weatherTileCount=128,this._faceIndex=0,this._tileIndex=0,this.coverage=st(os.default.coverage[0],os.default.coverage[1],.5),this.density=st(os.default.density[0],os.default.density[1],.5),this.absorption=st(os.default.absorption[0],os.default.absorption[1],.5),this.cloudSize=st(os.default.cloudSize[0],os.default.cloudSize[1],.5),this.detailSize=st(os.default.detailSize[0],os.default.detailSize[1],.5),this.smoothness=st(os.default.smoothness[0],os.default.smoothness[1],.5),this.cloudHeight=st(os.default.cloudHeight[0],os.default.cloudHeight[1],.5),this.raymarchingSteps=os.default.raymarchingSteps,this._viewMatrix=ce(),this._dirty=!1,this.running=!1}_getTechnique(e){const t=1-this.context.renderContext.bindParameters.cloudsFade.readChannels,r=t===Id.RG?2*e:2*e+1;return this._techniques[r]||(this._techniqueConfiguration.writeTextureChannels=t,this._techniqueConfiguration.steps=e,this._techniques[r]=new HM({rctx:this.context.renderContext.rctx,viewingMode:this.view.state.viewingMode},this._techniqueConfiguration),this._techniques[r])}updateWeatherTile(){const e=this.view.camera.position.latitude,t=this.view.camera.position.longitude;if(e==null||t==null)return;zt(this._weatherTile,(e+90)/180,(t+180)/360);const r=Math.floor(this._weatherTileCount*Math.abs(2*this._weatherTile[0]-1));this._weatherTile[0]=Math.floor(2*this._weatherTileCount*this._weatherTile[0]),this._weatherTile[1]=Math.floor(4*(this._weatherTileCount-r)*this._weatherTile[1]);let s=0,a=0;if(g(this.view.environment)&&this.view.environment.lighting.type!=="virtual"&&g(this.view.environment.lighting.date)){const n=new Date(this.view.environment.lighting.date);n.setUTCHours(this.view.environment.lighting.date.getUTCHours()+(this.view.environment.lighting.displayUTCOffset??0)),s=31*n.getUTCMonth()+n.getUTCDate(),a=n.getUTCFullYear()}this._weatherTile[0]=(this._weatherTile[0]+s)%(2*this._weatherTileCount),this._weatherTile[1]=(this._weatherTile[1]+a%100)%(4*this._weatherTileCount),P4(this._passParameters.weatherTile,this._weatherTile)||this.setDirty()}initialize(){this._vao=pa(this.context.renderContext.rctx);const e=Et(this.view.spatialReference);this._passParameters.cloudRadius=.5*e.radius,this.setDirty(),this.updateWeatherTile(),this._handles.add([this.view.resourceController.scheduler.registerTask(Zi.CLOUDS_GENERATOR,this),te(()=>[this.coverage,this.density,this.absorption,this.cloudSize,this.detailSize,this.smoothness,this.cloudHeight,this.raymarchingSteps],()=>this.setDirty(),Ji)])}destroy(){this._handles.destroy(),this._techniques.forEach(e=>er(e)),this._frameBufferCube=De(this._frameBufferCube),this._techniques.length=0,this._vao=De(this._vao),this._passParameters.noiseTexture=Te(this._passParameters.noiseTexture)}get _tilesPerFace(){switch(this._techniqueConfiguration.steps){case sa.SIXTEEN:return 1;case sa.HUNDRED:return 4;case sa.COUNT:case sa.TWOHUNDRED:return 8}}_ensureNoiseTexture(){if(g(this._passParameters.noiseTexture))this._passParameters.noiseTexture.updateWeatherMap(this._passParameters.weatherTile);else{const e=this.context;this._passParameters.noiseTexture=new sg({context:e}),this._passParameters.noiseTexture.updateWeatherMap(this._passParameters.weatherTile)}return g(this._passParameters.noiseTexture.textureAtlas)}_ensureFrameBufferCube(e){if(P(this._frameBufferCube)){const t={target:tr.TEXTURE_CUBE_MAP,pixelFormat:St.RGBA,dataType:Zt.UNSIGNED_BYTE,wrapMode:kt.CLAMP_TO_EDGE,samplingMode:Qt.LINEAR,hasMipmap:!1,width:e,height:e};this._frameBufferCube=new Rs(this.context.renderContext.rctx,{colorTarget:la.CUBEMAP,width:e,height:e},t)}return this._frameBufferCube}get cubeMap(){return this._frameBufferCube}destroyFrameBufferCube(){this._frameBufferCube=De(this._frameBufferCube)}applyPreset(e,t){const r=e.median,s=a=>{const n=st(a[0],a[1],r);return t<.5?st(a[0],n,2*t):st(n,a[1],2*(t-.5))};this.coverage=s(e.coverage),this.density=s(e.density),this.absorption=s(e.absorption),this.cloudSize=s(e.cloudSize),this.detailSize=s(e.detailSize),this.smoothness=s(e.smoothness),this.cloudHeight=s(e.cloudHeight),this.raymarchingSteps=e.raymarchingSteps}setDirty(){this._dirty=this.running=!0}runTask(e){if(P(this._vao))return this._dirty=this.running=!1,this.context.renderContext.bindParameters.cloudsFade.renderingStage=Ei.FINISHED_RENDERING,void e.madeProgress();this._faceIndex===0&&this._tileIndex===0&&(this._passParameters.raymarchingSteps=this.raymarchingSteps,this.updateWeatherTile(),fs(this._passParameters.weatherTile,this._weatherTile));const t=this._getTechnique(this._passParameters.raymarchingSteps);if(!t.compiled)return na.YIELD;if(!this.context.renderContext.bindParameters.cloudsFade.isCameraPositionFinal||this.context.renderContext.bindParameters.cloudsFade.isFading||!this._ensureNoiseTexture())return na.YIELD;this._faceIndex===0&&this._tileIndex===0&&(this.context.renderContext.bindParameters.cloudsFade.renderingStage=Ei.RENDERING,this._passParameters.absorption=this.absorption,this._passParameters.density=this.density,this._passParameters.cloudSize=this.cloudSize,this._passParameters.detailSize=this.detailSize,this._passParameters.smoothness=this.smoothness,this._passParameters.cloudHeight=this.cloudHeight,this._passParameters.coverage=this.coverage,this._dirty=!1);const r=this.context.renderContext.rctx,s=r.bindTechnique(t,this._passParameters,this._bindParameters);r.bindVAO(this._vao),s.assertCompatibleVertexAttributeLocations(this._vao);const a=r.getViewport(),n=t.configuration.cubeMapSize,o=n/this._tilesPerFace,l=this._tileIndex*o;r.setViewport(0,l,n,o);const c=this._ensureFrameBufferCube(n);r.bindFramebuffer(c);const h=jz[this._faceIndex],u=qz[this._faceIndex];O4(this._viewMatrix,Wz,h,u),Xl(this._drawParameters.viewMatrix,this._viewMatrix);const p=tr.TEXTURE_CUBE_MAP_POSITIVE_X+this._faceIndex;return c.setColorTextureTarget(p),s.bindDraw(this._drawParameters,this._bindParameters,this._passParameters),r.gl.drawArrays(r.gl.TRIANGLE_STRIP,0,4),r.gl.flush(),r.setViewport(a.x,a.y,a.width,a.height),this.requestRender(),++this._tileIndex,this._faceIndex===4&&this._tileIndex===this._tilesPerFace?(this.running=this._dirty,this._faceIndex=0,this._tileIndex=0,this.context.renderContext.bindParameters.cloudsFade.renderingStage=Ei.FINISHED_RENDERING):this._tileIndex===this._tilesPerFace&&(++this._faceIndex,this._tileIndex=0),e.madeProgress(),na.YIELD}};d([v({constructOnly:!0})],Vs.prototype,"context",void 0),d([v({constructOnly:!0})],Vs.prototype,"view",void 0),d([v({constructOnly:!0})],Vs.prototype,"requestRender",void 0),d([v()],Vs.prototype,"coverage",void 0),d([v()],Vs.prototype,"density",void 0),d([v()],Vs.prototype,"absorption",void 0),d([v()],Vs.prototype,"cloudSize",void 0),d([v()],Vs.prototype,"detailSize",void 0),d([v()],Vs.prototype,"smoothness",void 0),d([v()],Vs.prototype,"cloudHeight",void 0),d([v()],Vs.prototype,"raymarchingSteps",void 0),d([v()],Vs.prototype,"running",void 0),Vs=d([Y("esri.views.3d.environment.CloudsGenerator")],Vs);const jz=[qt(1,0,0),qt(-1,0,0),qt(0,1,0),qt(0,-1,0),qt(0,0,1)],qz=[qt(0,1,0),qt(0,1,0),qt(0,0,-1),qt(0,0,1),qt(0,1,0)],Wz=o6();let iC=class extends Gi{constructor(){super(...arguments),this.fogColor=T(),this.hazeColor=T(),this.fogStrength=4e-6,this.hazeStrength=4e-6,this.atmosphereC=1,this.fogAmount=0,this.hazeAmount=0}};function Xz(i){const e=new $t;e.attributes.add(w.POSITION,"vec2"),e.include(gv,{textureCoordinateType:mh.Default}),e.varyings.add("worldRay","vec3"),e.varyings.add("eyeDir","vec3");const{vertex:t,fragment:r}=e;return t.uniforms.add([new ir("inverseProjectionMatrix",(s,a)=>a.camera.inverseProjectionMatrix),new ir("inverseViewMatrix",(s,a)=>Vf(Qz,a.camera.viewMatrix))]),t.code.add(_`void main(void) {
vec3 posViewNear = (inverseProjectionMatrix * vec4(position, -1, 1)).xyz;
eyeDir = posViewNear;
worldRay = (inverseViewMatrix * vec4(posViewNear, 0)).xyz;
forwardTextureCoordinates();
gl_Position = vec4(position, 1, 1);
}`),r.uniforms.add(new ue("atmosphereC",s=>s.atmosphereC)),r.uniforms.add(new si("cameraPosition",(s,a)=>a.camera.eye)),r.uniforms.add(new pi("nearFar",(s,a)=>a.camera.nearFar)),r.uniforms.add(new lt("depthTex",s=>s.depthTexture)),r.uniforms.add(new ue("fogStrength",s=>i.haze?s.hazeStrength:s.fogStrength)),r.uniforms.add(new ue("fogAmount",s=>i.haze?s.hazeAmount:s.fogAmount)),r.uniforms.add(new si("fogColor",s=>i.haze?s.hazeColor:s.fogColor)),e.include(Ov),r.include(ml),r.code.add(_`vec2 sphereIntersect(vec3 start, vec3 dir) {
float a = dot(dir, dir);
float b = 2.0 * dot(dir, start);
float d = (b * b) - 4.0 * a * atmosphereC;
if (d < 0.0) {
return vec2(1e5, -1e5);
}
return vec2((-b - sqrt(d)) / (2.0 * a), (-b + sqrt(d)) / (2.0 * a));
}`),r.code.add(_`vec4 applyFog(float dist, vec3 rayDir){
if(dist == -1.0){
vec2 rayAtmosphereIntersect = sphereIntersect(cameraPosition, rayDir);
dist = 0.055 * rayAtmosphereIntersect.y;
}
float fogAmount = fogAmount * (1.0 - exp(-dist * fogStrength));
return vec4(fogAmount * fogColor, fogAmount);
}`),r.code.add(_`
    vec3 tonemapACES(vec3 x) {
      return clamp((x * (2.51 * x + 0.03)) / (x * (2.43 * x + 0.59) + 0.14), 0.0, 1.0);
    }

    void main() {
      vec3 rayDir = normalize(worldRay);
      float terrainDepth = -1.0;

      float depthSample = texture2D(depthTex, vuv0).r;
      float zNorm = 2.0 * depthSample - 1.0;
      float linDepth = 2.0 * nearFar[0] * nearFar[1] / (nearFar[1] + nearFar[0] - zNorm * (nearFar[1] - nearFar[0]));
      if(depthSample < 1.0 && depthSample > 0.0){
        vec3 cameraSpaceRay = normalize(eyeDir);
        cameraSpaceRay /= cameraSpaceRay.z;
        cameraSpaceRay *= linDepth;
        terrainDepth = max(0.0, length(cameraSpaceRay));
      }

      ${i.haze?_`
          if(terrainDepth == -1.0){
            gl_FragColor = vec4(0);
            return;
          }`:""}

      vec4 fog = applyFog(terrainDepth, rayDir);

      gl_FragColor = delinearizeGamma(vec4(tonemapACES(fog.rgb), fog.a));
    }
  `),e}const Qz=ce(),XM=Object.freeze(Object.defineProperty({__proto__:null,FogHazePassParameters:iC,build:Xz},Symbol.toStringTag,{value:"Module"}));let QM=class ZM extends Mt{initializeProgram(e){return new Rt(e.rctx,ZM.shader.get().build(this.configuration),Lt)}initializePipeline(){return this.configuration.haze?qe({blending:Ar(ae.ONE,ae.ZERO,ae.ONE_MINUS_SRC_COLOR,ae.ONE),colorWrite:at}):qe({blending:Ar(ae.SRC_ALPHA,ae.ZERO,ae.ONE_MINUS_SRC_ALPHA,ae.ONE),colorWrite:at})}};QM.shader=new Dt(XM,()=>_e(()=>import("./FogHaze.glsl-cd2648d0.js"),["assets/FogHaze.glsl-cd2648d0.js","assets/calcite-8912bd40.js","assets/index-00759e4a.js","assets/index-5026a37a.css","assets/calcite-96fa36fd.css","assets/mat4f64-abdda1bb.js","assets/objectResourceUtils-782953c3.js","assets/devEnvironmentUtils-5002a058.js","assets/mat3f64-50f3b9f6.js","assets/BufferView-379a78a4.js","assets/vec33-69c9e93b.js","assets/DefaultMaterial_COLOR_GAMMA-6ed76d86.js","assets/types-e1c0a5bf.js","assets/enums-e2e92c86.js","assets/Version-aa0a1d91.js","assets/quat-7b70e9a8.js","assets/quatf64-f8f1c132.js","assets/resourceUtils-527631ac.js","assets/basicInterfaces-7449a8bf.js","assets/Indices-d8bff7b2.js","assets/NestedMap-1b5db22e.js","assets/requestImageUtils-d1ba3b36.js","assets/symbolColorUtils-c9d24716.js","assets/Util-6d3f024a.js","assets/sphere-d0e5285d.js","assets/VertexAttribute-15d1866a.js","assets/doublePrecisionUtils-e3c3d0d8.js","assets/OrderIndependentTransparency-5f7257d7.js","assets/Texture-563cf5e5.js","assets/FramebufferObject-8b18fc0c.js","assets/VertexElementDescriptor-2925c6af.js","assets/InterleavedLayout-d57c91d0.js","assets/vec3f32-01c06d8d.js","assets/plane-5e2b046c.js","assets/spatialReferenceEllipsoidUtils-afb35af9.js","assets/scaleUtils-d13015f2.js","assets/ElevationSamplerData-e3118b17.js","assets/Octree-499541ed.js","assets/edgeProcessing-20e12367.js","assets/deduplicate-769a6f51.js","assets/MeshComponent-788e605a.js","assets/earcut-61f7b102.js","assets/imageUtils-c2d0d1ae.js","assets/projection-5969b753.js","assets/ZoomMomentumEstimator-ef57e6a4.js","assets/floatRGBA-ca2b39ca.js","assets/dehydratedFeatures-3a140d03.js","assets/quantizationUtils-b3b2ae2a.js","assets/labelFormatUtils-71e1f841.js","assets/orientedBoundingBox-a14b97b5.js","assets/quatf32-51a323b8.js","assets/SnappingCandidate-970faec6.js","assets/callExpressionWithFeature-df1a8f01.js","assets/DefaultVertexAttributeLayouts-5f20d8dd.js","assets/geometryServiceUtils-a536bb19.js","assets/project-909a4219.js","assets/LercDecoder-65586d50.js","assets/VectorTile-d41a1f0f.js","assets/enums-fb086c25.js","assets/config-1337d16e.js","assets/TiledDisplayObject-419c008b.js","assets/DisplayObject-87c37b69.js","assets/rasterUtils-7694cc98.js","assets/resources-7587d8f4.js","assets/workerHelper-6131d203.js","assets/webgl-debug-7f880832.js","assets/RenderingContext-0f21aa0e.js","assets/ProgramCache-f29c900e.js","assets/Program-77209250.js","assets/MediaLayer-4c42fc2f.js","assets/MediaElementView-06baa4d4.js","assets/normalizeUtilsSync-3ea564a9.js","assets/resourceExtension-f31d9f10.js","assets/BoundsStore-00da37da.js","assets/PooledRBush-5a11bc7e.js","assets/prism-line-numbers-eff41b13.js","assets/label2-a2f37e65.js","assets/interactive-1de2e238.js","assets/loadable-6afd516d.js","assets/t9n-81df3a71.js","assets/observers-c89705b8.js","assets/icon-8e47fbec.js","assets/loader-c773e800.js","assets/guid-51402ee7.js","assets/prism-line-numbers-7c5d72ff.css"]));let rC=class extends ua{constructor(){super(...arguments),this.haze=!1}};d([D()],rC.prototype,"haze",void 0);const Zz=.95,Yz=1;let ag=class extends Ie{constructor(e){super(e),this._passParameters=new iC;const t=e.context.renderContext.rctx;this._vao=pa(t,Gf),this._technique=e.context.techniqueRepository.acquire(QM,new rC);const r=Et(e.view.spatialReference);this._planetRadius=r.radius,this._atmosphereRadius=r.radius+uf}destroy(){this._technique.release(),this._vao.dispose()}set strength(e){this._passParameters.fogStrength=e}get strength(){return this._passParameters.fogStrength}render(e,t){if(this._update(e,t),this._passParameters.fogAmount<=0)return;const r=this._technique;if(!r.compiled)return void this.context.requestRender();const s=e.offscreenRenderingHelper;s.renderDepthDetached(()=>{this._passParameters.depthTexture=s.depthTexture;const a=e.rctx.bindTechnique(r,this._passParameters,e.bindParameters);this._renderFog(a,e)})}_renderFog(e,t){const r=t.rctx;r.bindVAO(this._vao),e.assertCompatibleVertexAttributeLocations(this._vao),r.drawArrays(Ut.TRIANGLE_STRIP,0,4)}_update(e,t){const r=e.bindParameters.camera;W(F2,r.eye);const s=Math.max(0,J(F2,e.bindParameters.lighting.mainLight.direction)),a=t.color;B(z2,a,.1),Gr(this._passParameters.fogColor,z2,a,s);const n=pe(r.eye),o=n*n;this._passParameters.atmosphereC=o-this._atmosphereRadius*this._atmosphereRadius,this._passParameters.fogAmount=(1-Lp(Zz*Tn,Yz*Tn,Math.abs(n-this._planetRadius)))*t.amount,this._passParameters.fogStrength=t.strength}static isSupported(e){return e.capabilities.depthTexture}};d([v({constructOnly:!0})],ag.prototype,"context",void 0),d([v({constructOnly:!0})],ag.prototype,"view",void 0),ag=d([Y("esri.views.3d.environment.Fog")],ag);let Kz=class{constructor(){this.color=T(),this.strength=0,this.amount=0}};const F2=T(),z2=T();var gl;(function(i){i[i.Cone=0]="Cone",i[i.Cylinder=1]="Cylinder",i[i.Underground=2]="Underground",i[i.COUNT=3]="COUNT"})(gl||(gl={}));let sC=class extends Vn{constructor(){super(...arguments),this.geometry=gl.Cone}};d([D({count:gl.COUNT})],sC.prototype,"geometry",void 0);let aC=class extends Gi{constructor(){super(...arguments),this.texV=$e(),this.altitudeFade=0,this.innerScale=0,this.undergroundFadeAlpha=0,this.silhouette=new YM}},YM=class{constructor(){this.center=T(),this.v1=T(),this.v2=T()}};function Jz(i){const e=new $t,{vertex:t,fragment:r}=e;if(tm(t),i.geometry===gl.Underground)e.attributes.add(w.POSITION,"vec2"),e.varyings.add("color","vec4"),t.uniforms.add([new si("cameraPosition",(s,a)=>a.camera.eye),new ue("undergroundFadeAlpha",s=>s.undergroundFadeAlpha)]),t.code.add(_`void main(void) {
float ndotl = dot(normalize(cameraPosition), mainLightDirection);
float lighting = max(0.0, smoothstep(-1.0, 0.8, 2.0 * ndotl));
color = vec4(vec3(lighting), undergroundFadeAlpha);
gl_Position = vec4(position.xy, 1.0, 1.0);
}`),r.code.add(_`void main() {
gl_FragColor = color;
}`);else{e.include(il,i),e.attributes.add(w.POSITION,"vec3"),e.varyings.add("vtc","vec2"),e.varyings.add("falloff","float");const s=i.geometry===gl.Cylinder;t.uniforms.add([new ir("proj",(o,l)=>l.camera.projectionMatrix),new ir("view",(o,l)=>l.camera.viewMatrix)]),s||(e.varyings.add("innerFactor","float"),t.uniforms.add(new si("silCircleCenter",o=>o.silhouette.center)),t.uniforms.add(new si("silCircleV1",o=>o.silhouette.v1)),t.uniforms.add(new si("silCircleV2",o=>o.silhouette.v2)),t.uniforms.add(new pi("texV",o=>o.texV)),t.uniforms.add(new ue("innerScale",o=>o.innerScale)));const a=6.2831853,n=1/128;t.code.add(_`
		void main(void) {
      ${s?_`
      vec3 pos = position;
      float ndotl = mainLightDirection.z;
      vtc = vec2(0.0, position.z + 0.05);`:_`
      innerFactor = clamp(-position.z, 0.0, 1.0);
      float scale = position.y * (1.0 + innerFactor * innerScale);
      float phi = position.x * ${_.float(a*n)} + 1.0;
      vec3 pos =  (silCircleCenter + sin(phi) * silCircleV1 + cos(phi) * silCircleV2) * scale;
      float ndotl = dot(normalize(position.y > 0.0 ? pos: silCircleCenter), mainLightDirection);
      vtc.x = position.x  * ${_.float(n)};
      vtc.y = texV.x * (1.0 - position.z) + texV.y * position.z;
      `}
      falloff = max(0.0, smoothstep(-1.0, 0.8, 2.0 * ndotl));

		  gl_Position = transformPosition(proj, view, pos);
		  gl_Position.z = gl_Position.w; // project atmosphere onto the far plane
    }
	  `),r.uniforms.add(new lt("tex",o=>o.texture)),s||r.uniforms.add(new ue("altitudeFade",o=>o.altitudeFade)),r.code.add(_`
		void main() {
			vec4 atmosphereColor = texture2D(tex, vtc) * falloff;
      ${s?_`gl_FragColor = atmosphereColor;`:_`
			vec4 innerColor = vec4(atmosphereColor.rgb, 1.0 - altitudeFade);
			gl_FragColor = mix(atmosphereColor, innerColor, smoothstep(0.0, 1.0, innerFactor));
      `}
    }`)}return e}const e7=Object.freeze(Object.defineProperty({__proto__:null,SilhouetteCircle:YM,SimpleAtmospherePassParameters:aC,build:Jz},Symbol.toStringTag,{value:"Module"}));let xy=class KM extends Mt{initializeProgram(e){return new Rt(e.rctx,KM.shader.get().build(this.configuration),Lt)}initializePipeline(){return this.configuration.geometry===gl.Cylinder?qe({blending:Ar(ae.SRC_ALPHA,ae.ONE,ae.ONE_MINUS_SRC_ALPHA,ae.ONE_MINUS_SRC_ALPHA),culling:J3,depthTest:{func:Fa.LEQUAL},colorWrite:at}):qe({blending:Ar(ae.SRC_ALPHA,ae.ONE,ae.ONE_MINUS_SRC_ALPHA,ae.ONE_MINUS_SRC_ALPHA),depthTest:{func:Fa.LEQUAL},colorWrite:at})}};xy.shader=new Dt(e7,()=>_e(()=>import("./SimpleAtmosphere.glsl-9cab09e1.js"),["assets/SimpleAtmosphere.glsl-9cab09e1.js","assets/calcite-8912bd40.js","assets/index-00759e4a.js","assets/index-5026a37a.css","assets/calcite-96fa36fd.css","assets/objectResourceUtils-782953c3.js","assets/devEnvironmentUtils-5002a058.js","assets/mat3f64-50f3b9f6.js","assets/mat4f64-abdda1bb.js","assets/BufferView-379a78a4.js","assets/vec33-69c9e93b.js","assets/DefaultMaterial_COLOR_GAMMA-6ed76d86.js","assets/types-e1c0a5bf.js","assets/enums-e2e92c86.js","assets/Version-aa0a1d91.js","assets/quat-7b70e9a8.js","assets/quatf64-f8f1c132.js","assets/resourceUtils-527631ac.js","assets/basicInterfaces-7449a8bf.js","assets/Indices-d8bff7b2.js","assets/NestedMap-1b5db22e.js","assets/requestImageUtils-d1ba3b36.js","assets/symbolColorUtils-c9d24716.js","assets/Util-6d3f024a.js","assets/sphere-d0e5285d.js","assets/VertexAttribute-15d1866a.js","assets/doublePrecisionUtils-e3c3d0d8.js","assets/OrderIndependentTransparency-5f7257d7.js","assets/Texture-563cf5e5.js","assets/FramebufferObject-8b18fc0c.js","assets/VertexElementDescriptor-2925c6af.js","assets/InterleavedLayout-d57c91d0.js","assets/vec3f32-01c06d8d.js","assets/plane-5e2b046c.js","assets/spatialReferenceEllipsoidUtils-afb35af9.js","assets/scaleUtils-d13015f2.js","assets/ElevationSamplerData-e3118b17.js","assets/Octree-499541ed.js","assets/edgeProcessing-20e12367.js","assets/deduplicate-769a6f51.js","assets/MeshComponent-788e605a.js","assets/earcut-61f7b102.js","assets/imageUtils-c2d0d1ae.js","assets/projection-5969b753.js","assets/ZoomMomentumEstimator-ef57e6a4.js","assets/floatRGBA-ca2b39ca.js","assets/dehydratedFeatures-3a140d03.js","assets/quantizationUtils-b3b2ae2a.js","assets/labelFormatUtils-71e1f841.js","assets/orientedBoundingBox-a14b97b5.js","assets/quatf32-51a323b8.js","assets/SnappingCandidate-970faec6.js","assets/callExpressionWithFeature-df1a8f01.js","assets/DefaultVertexAttributeLayouts-5f20d8dd.js","assets/geometryServiceUtils-a536bb19.js","assets/project-909a4219.js","assets/LercDecoder-65586d50.js","assets/VectorTile-d41a1f0f.js","assets/enums-fb086c25.js","assets/config-1337d16e.js","assets/TiledDisplayObject-419c008b.js","assets/DisplayObject-87c37b69.js","assets/rasterUtils-7694cc98.js","assets/resources-7587d8f4.js","assets/workerHelper-6131d203.js","assets/webgl-debug-7f880832.js","assets/RenderingContext-0f21aa0e.js","assets/ProgramCache-f29c900e.js","assets/Program-77209250.js","assets/MediaLayer-4c42fc2f.js","assets/MediaElementView-06baa4d4.js","assets/normalizeUtilsSync-3ea564a9.js","assets/resourceExtension-f31d9f10.js","assets/BoundsStore-00da37da.js","assets/PooledRBush-5a11bc7e.js","assets/prism-line-numbers-eff41b13.js","assets/label2-a2f37e65.js","assets/interactive-1de2e238.js","assets/loadable-6afd516d.js","assets/t9n-81df3a71.js","assets/observers-c89705b8.js","assets/icon-8e47fbec.js","assets/loader-c773e800.js","assets/guid-51402ee7.js","assets/prism-line-numbers-7c5d72ff.css"]));const JM=new Uint8ClampedArray([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,3,0,0,0,3,0,0,0,3,0,0,0,3,0,0,0,3,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,6,0,0,0,6,0,0,0,6,0,0,0,6,0,0,0,6,0,0,0,7,0,0,0,7,0,0,0,7,0,0,0,7,0,0,0,7,0,0,0,8,0,0,0,8,0,0,0,8,0,0,0,8,0,0,0,8,0,0,0,9,0,0,0,9,0,0,0,9,0,0,0,9,0,0,0,9,0,0,0,10,0,0,0,10,0,0,0,10,0,0,0,10,0,0,0,11,0,0,0,11,0,0,0,11,0,0,0,11,0,0,0,11,0,0,0,12,0,0,0,12,0,0,0,12,0,0,0,12,0,0,0,13,0,0,0,13,0,0,0,13,0,0,0,13,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,15,0,0,0,15,0,0,0,15,0,0,0,15,0,0,0,15,16,0,0,16,16,0,0,16,16,0,0,16,16,0,0,16,15,0,0,17,15,0,0,17,15,0,0,17,15,0,0,17,14,0,0,18,14,0,0,18,14,0,0,18,13,0,0,19,13,0,0,19,13,0,0,19,13,0,0,19,13,0,0,20,13,0,0,20,13,0,0,20,13,0,0,20,12,0,0,21,12,0,0,21,12,0,0,21,12,0,0,21,12,0,0,22,12,0,0,22,12,0,0,22,12,0,0,22,11,0,0,23,11,0,0,23,11,0,0,23,11,0,0,24,11,0,0,24,11,0,0,24,11,0,0,24,10,0,0,25,10,0,0,25,10,0,0,25,10,0,0,26,10,0,0,26,10,0,0,26,10,0,0,26,9,0,0,27,9,0,0,27,9,0,0,27,18,0,0,28,18,0,0,28,18,0,0,28,18,0,0,28,18,0,0,29,18,0,0,29,18,0,0,29,17,0,0,30,17,0,0,30,17,0,0,30,17,0,0,30,16,0,0,31,16,0,0,31,16,0,0,31,16,0,0,32,16,0,0,32,16,0,0,32,15,0,0,33,15,0,0,33,15,0,0,33,15,0,0,34,15,8,0,34,15,8,0,34,15,8,0,34,15,7,0,35,15,7,0,35,15,7,0,35,21,7,0,36,21,7,0,36,21,7,0,36,21,7,0,37,21,7,0,37,21,7,0,37,20,7,0,38,20,7,0,38,20,7,0,38,20,7,0,39,20,7,0,39,20,7,0,39,20,7,0,39,19,6,0,40,19,6,0,40,19,6,0,40,19,6,0,41,19,6,0,41,19,6,0,41,18,6,0,42,18,6,0,42,18,6,0,42,24,6,0,43,24,6,0,43,24,6,0,43,23,6,0,44,23,6,0,44,23,6,0,44,23,6,0,45,23,6,0,45,23,6,0,45,22,6,0,46,22,6,0,46,22,6,0,46,22,5,0,47,22,5,0,47,22,5,0,47,21,5,0,48,21,5,0,48,21,5,0,48,21,5,0,49,21,5,0,49,26,5,0,49,25,5,0,50,25,5,0,50,25,5,0,50,25,5,0,51,25,5,0,51,25,5,0,51,25,5,0,52,25,5,0,52,25,5,0,52,24,5,0,53,24,5,0,53,24,5,0,53,24,9,0,54,28,9,0,54,28,9,0,54,28,9,0,55,28,9,0,55,27,9,0,56,27,9,0,56,27,9,0,56,27,9,4,57,27,9,4,57,27,9,4,57,26,9,4,58,26,9,4,58,26,9,4,58,26,9,4,59,26,9,4,59,26,9,4,59,26,8,4,60,30,8,4,60,30,8,4,60,29,8,4,61,29,8,4,61,29,8,4,62,29,8,4,62,29,8,4,62,28,8,4,63,28,8,4,63,28,8,4,63,28,12,4,64,28,12,4,64,28,12,4,64,27,12,4,65,27,12,8,65,27,12,8,65,31,12,8,66,31,12,8,66,30,11,8,67,30,11,8,67,30,11,8,67,30,11,8,68,30,11,8,68,30,11,8,68,30,15,7,69,30,15,7,69,30,15,7,69,33,15,11,70,33,15,11,70,32,14,11,71,32,14,11,71,32,14,11,71,32,18,14,72,32,18,14,72,32,18,14,72,31,17,14,73,35,17,14,73,34,17,17,74,34,21,17,74,34,21,17,74,34,20,17,75,34,20,20,75,34,20,20,75,34,23,20,76,34,23,20,76,36,23,23,77,36,23,23,77,36,23,23,77,36,23,23,78,36,26,26,78,36,26,26,78,36,26,26,79,36,26,29,79,38,26,29,80,38,29,29,80,38,29,29,80,38,28,31,81,38,28,31,81,38,31,31,81,37,31,34,82,37,31,34,82,37,31,37,83,40,34,37,83,40,34,37,83,39,33,39,84,39,33,39,84,39,36,42,84,39,36,42,85,39,36,42,85,39,36,42,85,39,39,44,86,39,39,44,86,41,38,47,87,41,41,47,87,41,41,50,87,41,41,49,88,41,41,52,88,40,43,52,89,43,43,52,89,43,43,54,89,42,45,54,90,42,45,57,90,42,45,57,90,42,45,59,91,42,48,59,91,44,47,61,92,44,47,61,92,44,50,61,92,44,49,63,93,44,49,63,93,44,52,66,93,43,52,65,94,46,54,68,94,46,54,70,95,46,54,70,95,46,54,70,95,45,56,72,96,45,56,72,96,45,58,74,97,47,58,76,97,47,58,76,97,47,60,78,98,47,60,78,98,47,60,81,98,49,62,80,99,49,62,82,99,48,61,84,100,48,64,84,100,48,64,84,100,50,63,86,101,50,66,86,101,50,66,88,101,50,65,90,102,52,67,89,103,51,69,91,104,51,68,92,105,52,69,93,107,52,71,94,108,54,70,96,109,53,71,96,111,52,73,98,112,54,72,98,114,53,73,100,115,54,72,100,117,54,73,102,118,55,74,104,120,55,76,105,121,56,77,106,123,56,76,107,124,57,79,107,126,58,78,110,128,57,79,111,129,56,80,113,131,58,79,112,132,57,82,114,134,58,81,116,136,60,82,117,137,59,83,117,139,60,83,119,141,59,84,120,142,60,85,122,144,59,86,122,146,60,86,126,148,62,87,127,149,61,88,127,151,62,88,128,153,63,89,130,155,62,90,131,156,63,90,132,158,64,91,134,160,65,91,135,162,64,92,136,163,63,93,138,165,66,95,139,167,65,95,140,169,66,95,142,171,67,96,142,172,66,97,144,174,67,99,145,176,67,97,148,178,67,99,147,180,68,100,149,181,68,100,150,183,69,101,152,185,70,102,153,187,71,103,155,188,70,103,156,190,70,104,157,192,71,105,158,194,71,106,160,195,72,106,161,197,72,108,161,199,73,108,163,200,73,109,164,202,74,109,165,204,74,110,167,206,75,111,168,207,74,112,170,209,75,112,170,210,76,113,171,212,76,114,173,214,77,115,174,215,78,115,175,217,78,116,175,218,78,117,177,220,78,118,178,221,79,118,180,223,80,120,180,224,81,120,181,226,81,120,182,227,82,121,184,229,82,122,185,230,84,123,186,232,83,123,187,233,84,124,189,234,84,125,188,235,85,126,189,237,86,126,190,238,86,127,191,239,87,127,192,240,87,129,193,242,88,129,194,243,89,130,195,244,90,131,196,245,90,132,197,246,91,132,197,247,92,133,198,248,92,134,199,249,93,135,200,250,94,136,201,251,95,137,202,252,96,138,203,253,97,140,204,254,98,141,205,254,99,142,206,255,101,143,207,255,102,144,208,255,103,146,209,255,104,147,209,255,106,148,210,255,107,149,211,255,108,151,212,255,110,152,213,255,111,153,213,255,112,154,214,255,114,156,215,255,115,157,215,255,117,158,216,255,118,160,217,255,120,161,217,255,121,162,218,255,123,164,218,255,124,165,219,255,125,166,219,255,127,167,220,255,129,169,220,255,130,170,221,255,132,171,221,255,133,173,222,255,134,174,222,255,136,175,223,255,139,178,224,255,142,180,224,255,144,182,225,255,147,185,226,255,150,187,226,255,153,189,227,255,155,191,228,255,158,194,228,255,160,196,229,255,163,198,229,255,165,200,230,255,168,202,231,255,170,203,231,255,172,205,232,255,174,207,232,255,176,209,233,255,178,210,234,255,180,212,234,255,182,214,235,255,184,215,236,255,186,217,237,255,188,219,238,255,190,220,238,255,192,221,239,255,193,222,240,255,194,224,240,255,196,225,241,255,197,226,241,255,198,226,242,255,199,227,242,255,200,228,242,255,201,228,243,255,202,229,243,255,203,230,243,255,204,230,244,255,205,231,244,255,207,232,244,255,208,233,245,255,209,233,245,255,211,234,246,255,213,235,246,255,217,238,247,255,222,240,248,255,226,242,249,255,231,245,250,255,236,247,251,255,241,249,252,255,245,251,253,255,249,252,254,255,255,255,255,255]);var Yx;(function(i){function e(n,o){const l=n[o],c=n[o+1],h=n[o+2];return Math.sqrt(l*l+c*c+h*h)}function t(n,o){const l=n[o],c=n[o+1],h=n[o+2],u=1/Math.sqrt(l*l+c*c+h*h);n[o]*=u,n[o+1]*=u,n[o+2]*=u}function r(n,o,l){n[o]*=l,n[o+1]*=l,n[o+2]*=l}function s(n,o,l,c,h,u=o){(h=h||n)[u]=n[o]+l[c],h[u+1]=n[o+1]+l[c+1],h[u+2]=n[o+2]+l[c+2]}function a(n,o,l,c,h,u=o){(h=h||n)[u]=n[o]-l[c],h[u+1]=n[o+1]-l[c+1],h[u+2]=n[o+2]-l[c+2]}i.length=e,i.normalize=t,i.scale=r,i.add=s,i.subtract=a})(Yx||(Yx={}));function zi(i,e=!1){return i<=LA?e?new Array(i).fill(0):new Array(i):new Float32Array(i)}function U2(i){return length<=LA?Array.from(i):new Float32Array(i)}function V2(i,e,t){return Array.isArray(i)?i.slice(e,e+t):i.subarray(e,e+t)}const mu=Yx,D1=[[-.5,-.5,.5],[.5,-.5,.5],[.5,.5,.5],[-.5,.5,.5],[-.5,-.5,-.5],[.5,-.5,-.5],[.5,.5,-.5],[-.5,.5,-.5]],t7=[0,0,1,-1,0,0,1,0,0,0,-1,0,0,1,0,0,0,-1],i7=[0,0,1,0,1,1,0,1],r7=[0,1,2,2,3,0,4,0,3,3,7,4,1,5,6,6,2,1,1,0,4,4,5,1,3,2,6,6,7,3,5,4,7,7,6,5],eD=new Array(36);for(let i=0;i<6;i++)for(let e=0;e<6;e++)eD[6*i+e]=i;const sd=new Array(36);for(let i=0;i<6;i++)sd[6*i+0]=0,sd[6*i+1]=1,sd[6*i+2]=2,sd[6*i+3]=2,sd[6*i+4]=3,sd[6*i+5]=0;function s7(i,e){Array.isArray(e)||(e=[e,e,e]);const t=new Array(24);for(let r=0;r<8;r++)t[3*r]=D1[r][0]*e[0],t[3*r+1]=D1[r][1]*e[1],t[3*r+2]=D1[r][2]*e[2];return new Cr(i,[[w.POSITION,new be(t,3,!0)],[w.NORMAL,new be(t7,3)],[w.UV0,new be(i7,2)]],[[w.POSITION,r7],[w.NORMAL,eD],[w.UV0,sd]])}const I1=[[-.5,0,-.5],[.5,0,-.5],[.5,0,.5],[-.5,0,.5],[0,-.5,0],[0,.5,0]],a7=[0,1,-1,1,1,0,0,1,1,-1,1,0,0,-1,-1,1,-1,0,0,-1,1,-1,-1,0],n7=[5,1,0,5,2,1,5,3,2,5,0,3,4,0,1,4,1,2,4,2,3,4,3,0],o7=[0,0,0,1,1,1,2,2,2,3,3,3,4,4,4,5,5,5,6,6,6,7,7,7];function l7(i,e){Array.isArray(e)||(e=[e,e,e]);const t=new Array(18);for(let r=0;r<6;r++)t[3*r]=I1[r][0]*e[0],t[3*r+1]=I1[r][1]*e[1],t[3*r+2]=I1[r][2]*e[2];return new Cr(i,[[w.POSITION,new be(t,3,!0)],[w.NORMAL,new be(a7,3)]],[[w.POSITION,n7],[w.NORMAL,o7]])}const F0=qt(-.5,0,-.5),z0=qt(.5,0,-.5),U0=qt(0,0,.5),V0=qt(0,.5,0),gu=Li(),fu=Li(),Sp=Li(),Pp=Li(),Op=Li();Q(gu,F0,V0),Q(fu,F0,z0),Be(Sp,gu,fu),W(Sp,Sp),Q(gu,z0,V0),Q(fu,z0,U0),Be(Pp,gu,fu),W(Pp,Pp),Q(gu,U0,V0),Q(fu,U0,F0),Be(Op,gu,fu),W(Op,Op);const L1=[F0,z0,U0,V0],c7=[0,-1,0,Sp[0],Sp[1],Sp[2],Pp[0],Pp[1],Pp[2],Op[0],Op[1],Op[2]],h7=[0,1,2,3,1,0,3,2,1,3,0,2],d7=[0,0,0,1,1,1,2,2,2,3,3,3];function u7(i,e){Array.isArray(e)||(e=[e,e,e]);const t=new Array(12);for(let r=0;r<4;r++)t[3*r]=L1[r][0]*e[0],t[3*r+1]=L1[r][1]*e[1],t[3*r+2]=L1[r][2]*e[2];return new Cr(i,[[w.POSITION,new be(t,3,!0)],[w.NORMAL,new be(c7,3)]],[[w.POSITION,h7],[w.NORMAL,d7]])}function Ese(i,e,t,r,s={uv:!0}){const a=-Math.PI,n=2*Math.PI,o=-Math.PI/2,l=Math.PI,c=Math.max(3,Math.floor(t)),h=Math.max(2,Math.floor(r)),u=(c+1)*(h+1),p=zi(3*u),m=zi(3*u),f=zi(2*u),y=[];let b=0;for(let O=0;O<=h;O++){const R=[],E=O/h,$=o+E*l,M=Math.cos($);for(let L=0;L<=c;L++){const F=L/c,N=a+F*n,G=Math.cos(N)*M,q=Math.sin($),se=-Math.sin(N)*M;p[3*b]=G*e,p[3*b+1]=q*e,p[3*b+2]=se*e,m[3*b]=G,m[3*b+1]=q,m[3*b+2]=se,f[2*b]=F,f[2*b+1]=E,R.push(b),++b}y.push(R)}const x=new Array;for(let O=0;O<h;O++)for(let R=0;R<c;R++){const E=y[O][R],$=y[O][R+1],M=y[O+1][R+1],L=y[O+1][R];O===0?(x.push(E),x.push(M),x.push(L)):O===h-1?(x.push(E),x.push($),x.push(M)):(x.push(E),x.push($),x.push(M),x.push(M),x.push(L),x.push(E))}const S=[[w.POSITION,x],[w.NORMAL,x]],C=[[w.POSITION,new be(p,3,!0)],[w.NORMAL,new be(m,3,!0)]];return s.uv&&(C.push([w.UV0,new be(f,2,!0)]),S.push([w.UV0,x])),s.offset&&(S[0][0]=w.OFFSET,C[0][0]=w.OFFSET,S.push([w.POSITION,new Array(x.length).fill(0)]),C.push([w.POSITION,new be(Float64Array.from(s.offset),3,!0)])),new Cr(i,C,S)}function p7(i,e,t,r){const{vertexAttributes:s,indices:a}=tD(e,t,r);return new Cr(i,s,a)}function tD(i,e,t){const r=i;let s,a;if(t)s=[0,-1,0,1,0,0,0,0,1,-1,0,0,0,0,-1,0,1,0],a=[0,1,2,0,2,3,0,3,4,0,4,1,1,5,2,2,5,3,3,5,4,4,5,1];else{const h=r*(1+Math.sqrt(5))/2;s=[-r,h,0,r,h,0,-r,-h,0,r,-h,0,0,-r,h,0,r,h,0,-r,-h,0,r,-h,h,0,-r,h,0,r,-h,0,-r,-h,0,r],a=[0,11,5,0,5,1,0,1,7,0,7,10,0,10,11,1,5,9,5,11,4,11,10,2,10,7,6,7,1,8,3,9,4,3,4,2,3,2,6,3,6,8,3,8,9,4,9,5,2,4,11,6,2,10,8,6,7,9,8,1]}for(let h=0;h<s.length;h+=3)mu.scale(s,h,i/mu.length(s,h));let n={};function o(h,u){h>u&&([h,u]=[u,h]);const p=h.toString()+"."+u.toString();if(n[p])return n[p];let m=s.length;return s.length+=3,mu.add(s,3*h,s,3*u,s,m),mu.scale(s,m,i/mu.length(s,m)),m/=3,n[p]=m,m}for(let h=0;h<e;h++){const u=a.length,p=new Array(4*u);for(let m=0;m<u;m+=3){const f=a[m],y=a[m+1],b=a[m+2],x=o(f,y),S=o(y,b),C=o(b,f),O=4*m;p[O]=f,p[O+1]=x,p[O+2]=C,p[O+3]=y,p[O+4]=S,p[O+5]=x,p[O+6]=b,p[O+7]=C,p[O+8]=S,p[O+9]=x,p[O+10]=S,p[O+11]=C}a=p,n={}}const l=U2(s);for(let h=0;h<l.length;h+=3)mu.normalize(l,h);const c=[[w.POSITION,a],[w.NORMAL,a]];return{vertexAttributes:[[w.POSITION,new be(U2(s),3,!0)],[w.NORMAL,new be(l,3,!0)]],indices:c}}function Kx(i,e,t,r,s,a,n,o,l=null){const c=t?[t[0],t[1],t[2]]:[0,0,0],h=e?[e[0],e[1],e[2]]:[0,0,1];n=n||[0,0];const u=r?[255*r[0],255*r[1],255*r[2],r.length>3?255*r[3]:255]:[255,255,255,255],p=g(s)&&s.length===2?s:[1,1],m=[[w.POSITION,new be(c,3,!0)],[w.NORMAL,new be(h,3,!0)],[w.UV0,new be(n,n.length)],[w.COLOR,new be(u,4,!0)],[w.SIZE,new be(p,2)]];if(a!=null){const f=[a[0],a[1],a[2],a[3]];m.push([w.AUXPOS1,new be(f,4)])}if(o!=null){const f=[o[0],o[1],o[2],o[3]];m.push([w.AUXPOS2,new be(f,4)])}return new Cr(i,m,null,null,ps.Point,l)}const m7=[[-1,-1,0],[1,-1,0],[1,1,0],[-1,1,0]];function Ase(i,e=m7){const t=new Array(12);for(let h=0;h<4;h++)for(let u=0;u<3;u++)t[3*h+u]=e[h][u];const r=[0,1,2,2,3,0],s=[0,0,1],a=[0,0,0,0,0,0],n=[0,0,1,0,1,1,0,1],o=[255,255,255,255],l=[[w.POSITION,r],[w.NORMAL,a],[w.UV0,r],[w.COLOR,a]],c=[[w.POSITION,new be(t,3,!0)],[w.NORMAL,new be(s,3,!0)],[w.UV0,new be(n,2,!0)],[w.COLOR,new be(o,4,!0)]];return new Cr(i,c,l)}function G2(i,e,t,r,s,a=!0,n=!0){let o=0;const l=t,c=e;let h=qt(0,o,0),u=qt(0,o+c,0),p=qt(0,-1,0),m=qt(0,1,0);s&&(o=c,u=qt(0,0,0),h=qt(0,o,0),p=qt(0,1,0),m=qt(0,-1,0));const f=[u,h],y=[p,m],b=r+2,x=Math.sqrt(c*c+l*l);if(s)for(let M=r-1;M>=0;M--){const L=M*(2*Math.PI/r),F=qt(Math.cos(L)*l,o,Math.sin(L)*l);f.push(F);const N=qt(c*Math.cos(L)/x,-l/x,c*Math.sin(L)/x);y.push(N)}else for(let M=0;M<r;M++){const L=M*(2*Math.PI/r),F=qt(Math.cos(L)*l,o,Math.sin(L)*l);f.push(F);const N=qt(c*Math.cos(L)/x,l/x,c*Math.sin(L)/x);y.push(N)}const S=new Array,C=new Array;if(a){for(let M=3;M<f.length;M++)S.push(1),S.push(M-1),S.push(M),C.push(0),C.push(0),C.push(0);S.push(f.length-1),S.push(2),S.push(1),C.push(0),C.push(0),C.push(0)}if(n){for(let M=3;M<f.length;M++)S.push(M),S.push(M-1),S.push(0),C.push(M),C.push(M-1),C.push(1);S.push(0),S.push(2),S.push(f.length-1),C.push(1),C.push(2),C.push(y.length-1)}const O=zi(3*b);for(let M=0;M<b;M++)O[3*M]=f[M][0],O[3*M+1]=f[M][1],O[3*M+2]=f[M][2];const R=zi(3*b);for(let M=0;M<b;M++)R[3*M]=y[M][0],R[3*M+1]=y[M][1],R[3*M+2]=y[M][2];const E=[[w.POSITION,S],[w.NORMAL,C]],$=[[w.POSITION,new be(O,3,!0)],[w.NORMAL,new be(R,3,!0)]];return new Cr(i,$,E)}function g7(i,e,t,r,s,a,n){const o=s?p2(s):qt(1,0,0),l=a?p2(a):qt(0,0,0);n=n??!0;const c=Li();W(c,o);const h=Li();B(h,c,Math.abs(e));const u=Li();B(u,h,-.5),X(u,u,l);const p=qt(0,1,0);Math.abs(1-J(c,p))<.2&&j(p,0,0,1);const m=Li();Be(m,c,p),W(m,m),Be(p,m,c);const f=2*r+(n?2:0),y=r+(n?2:0),b=zi(3*f),x=zi(3*y),S=zi(2*f),C=new Array(3*r*(n?4:2)),O=new Array(3*r*(n?4:2));n&&(b[3*(f-2)+0]=u[0],b[3*(f-2)+1]=u[1],b[3*(f-2)+2]=u[2],S[2*(f-2)]=0,S[2*(f-2)+1]=0,b[3*(f-1)+0]=b[3*(f-2)+0]+h[0],b[3*(f-1)+1]=b[3*(f-2)+1]+h[1],b[3*(f-1)+2]=b[3*(f-2)+2]+h[2],S[2*(f-1)]=1,S[2*(f-1)+1]=1,x[3*(y-2)+0]=-c[0],x[3*(y-2)+1]=-c[1],x[3*(y-2)+2]=-c[2],x[3*(y-1)+0]=c[0],x[3*(y-1)+1]=c[1],x[3*(y-1)+2]=c[2]);const R=(N,G,q)=>{C[N]=G,O[N]=q};let E=0;const $=Li(),M=Li();for(let N=0;N<r;N++){const G=N*(2*Math.PI/r);B($,p,Math.sin(G)),B(M,m,Math.cos(G)),X($,$,M),x[3*N+0]=$[0],x[3*N+1]=$[1],x[3*N+2]=$[2],B($,$,t),X($,$,u),b[3*N+0]=$[0],b[3*N+1]=$[1],b[3*N+2]=$[2],S[2*N+0]=N/r,S[2*N+1]=0,b[3*(N+r)+0]=b[3*N+0]+h[0],b[3*(N+r)+1]=b[3*N+1]+h[1],b[3*(N+r)+2]=b[3*N+2]+h[2],S[2*(N+r)+0]=N/r,S[2*N+1]=1;const q=(N+1)%r;R(E++,N,N),R(E++,N+r,N),R(E++,q,q),R(E++,q,q),R(E++,N+r,N),R(E++,q+r,q)}if(n){for(let N=0;N<r;N++){const G=(N+1)%r;R(E++,f-2,y-2),R(E++,N,y-2),R(E++,G,y-2)}for(let N=0;N<r;N++){const G=(N+1)%r;R(E++,N+r,y-1),R(E++,f-1,y-1),R(E++,G+r,y-1)}}const L=[[w.POSITION,C],[w.NORMAL,O],[w.UV0,C]],F=[[w.POSITION,new be(b,3,!0)],[w.NORMAL,new be(x,3,!0)],[w.UV0,new be(S,2,!0)]];return new Cr(i,F,L)}function Mse(i,e,t,r,s,a,n=qt(0,0,0)){const o=e.length,l=zi(t.length*o*3+(6*r.length||0)),c=zi(t.length*o*3+(r?6:0)),h=new Array,u=new Array;let p=0,m=0;const f=Li(),y=Li(),b=Li(),x=Li(),S=Li(),C=Li(),O=Li(),R=T(),E=Li(),$=Li(),M=Li(),L=Li(),F=Li(),N=Ui();j(E,0,1,0),Q(y,t[1],t[0]),W(y,y),a?(X(R,t[0],n),W(b,R)):j(b,0,0,1),wy(y,b,E,E,S,b,B2),H(x,b),H(L,S);for(let z=0;z<r.length;z++)B(C,S,r[z][0]),B(R,b,r[z][2]),X(C,C,R),X(C,C,t[0]),l[p++]=C[0],l[p++]=C[1],l[p++]=C[2];c[m++]=-y[0],c[m++]=-y[1],c[m++]=-y[2];for(let z=0;z<s.length;z++)h.push(s[z][0]>0?s[z][0]:-s[z][0]-1+r.length),h.push(s[z][1]>0?s[z][1]:-s[z][1]-1+r.length),h.push(s[z][2]>0?s[z][2]:-s[z][2]-1+r.length),u.push(0),u.push(0),u.push(0);let G=r.length;const q=r.length-1;for(let z=0;z<t.length;z++){let ie=!1;z>0&&(H(f,y),z<t.length-1?(Q(y,t[z+1],t[z]),W(y,y)):ie=!0,X($,f,y),W($,$),X(M,t[z-1],x),mv(t[z],$,N),kd(N,xo(M,f),R)?(Q(R,R,t[z]),W(b,R),Be(S,$,b),W(S,S)):wy($,x,L,E,S,b,B2),H(x,b),H(L,S)),a&&(X(R,t[z],n),W(F,R));for(let re=0;re<o;re++)if(B(C,S,e[re][0]),B(R,b,e[re][1]),X(C,C,R),W(O,C),c[m++]=O[0],c[m++]=O[1],c[m++]=O[2],X(C,C,t[z]),l[p++]=C[0],l[p++]=C[1],l[p++]=C[2],!ie){const he=(re+1)%o;h.push(G+re),h.push(G+o+re),h.push(G+he),h.push(G+he),h.push(G+o+re),h.push(G+o+he);for(let oe=0;oe<6;oe++){const Re=h.length-6;u.push(h[Re+oe]-q)}}G+=o}const se=t[t.length-1];for(let z=0;z<r.length;z++)B(C,S,r[z][0]),B(R,b,r[z][1]),X(C,C,R),X(C,C,se),l[p++]=C[0],l[p++]=C[1],l[p++]=C[2];const k=m/3;c[m++]=y[0],c[m++]=y[1],c[m++]=y[2];const I=G-o;for(let z=0;z<s.length;z++)h.push(s[z][0]>=0?G+s[z][0]:-s[z][0]-1+I),h.push(s[z][2]>=0?G+s[z][2]:-s[z][2]-1+I),h.push(s[z][1]>=0?G+s[z][1]:-s[z][1]-1+I),u.push(k),u.push(k),u.push(k);const U=[[w.POSITION,h],[w.NORMAL,u]],V=[[w.POSITION,new be(l,3,!0)],[w.NORMAL,new be(c,3,!0)]];return new Cr(i,V,U)}function Dse(i,e,t,r){dt(e.length>1,"createPolylineGeometry(): polyline needs at least 2 points"),dt(e[0].length===3,"createPolylineGeometry(): malformed vertex"),dt(t==null||t.length===e.length,"createPolylineGeometry: need same number of points and normals"),dt(t==null||t[0].length===3,"createPolylineGeometry(): malformed normal");const s=Fn(3*e.length),a=new Array(2*(e.length-1));let n=0,o=0;for(let h=0;h<e.length;h++){for(let u=0;u<3;u++)s[n++]=e[h][u];h>0&&(a[o++]=h-1,a[o++]=h)}const l=[],c=[];if(l.push([w.POSITION,a]),c.push([w.POSITION,new be(s,3,!0)]),t){const h=zi(3*t.length);let u=0;for(let p=0;p<e.length;p++)for(let m=0;m<3;m++)h[u++]=t[p][m];l.push([w.NORMAL,a]),c.push([w.NORMAL,new be(h,3,!0)])}return r&&(c.push([w.COLOR,new be(r,4)]),l.push([w.COLOR,kT(r.length/4)])),new Cr(i,c,l,null,ps.Line)}function f7(i,e=i){const t=i.vertexAttributes,r=t.get(w.POSITION).data,s=t.get(w.NORMAL).data;if(s){const a=e.getMutableAttribute(w.NORMAL).data;for(let n=0;n<s.length;n+=3){const o=s[n+1];a[n+1]=-s[n+2],a[n+2]=o}}if(r){const a=e.getMutableAttribute(w.POSITION).data;for(let n=0;n<r.length;n+=3){const o=r[n+1];a[n+1]=-r[n+2],a[n+2]=o}}}function $1(i,e,t,r,s){return!(Math.abs(J(e,i))>s)&&(Be(t,i,e),W(t,t),Be(r,t,i),W(r,r),!0)}function wy(i,e,t,r,s,a,n){return $1(i,e,s,a,n)||$1(i,t,s,a,n)||$1(i,r,s,a,n)}const B2=.99619469809;let _7=class{constructor(e,t){this.type=fr.Panoramic,this._configuration=new sC,this._passParameters=new aC,this._configuration.geometry=gl.Cylinder,this._technique=t.techniqueRepository.acquire(xy,this._configuration);const r=t.renderContext.rctx;this._vao=this._createVertexArrayObject(r),this._vaoCount=Os(this._vao,"geometry"),this._passParameters.texture=new Ai(r,{pixelFormat:St.RGBA,dataType:Zt.UNSIGNED_BYTE,wrapMode:kt.CLAMP_TO_EDGE,samplingMode:Qt.LINEAR,flipped:!0,width:1,height:512},JM)}destroy(){this._passParameters.texture=De(this._passParameters.texture),this._vao.dispose(),this._technique.release()}render(e){const t=e.rctx,r=t.bindTechnique(this._technique,this._passParameters,e.bindParameters);y7(H2,e.bindParameters.camera.viewMatrix),r.setUniformMatrix4fv("view",H2),t.bindVAO(this._vao),r.assertCompatibleVertexAttributeLocations(this._vao),t.drawArrays(Ut.TRIANGLES,0,this._vaoCount)}renderHaze(){return!1}_createVertexArrayObject(e){const t=tD(1,2,!1),r=t.indices[0][1],s=t.vertexAttributes[0][1];for(let l=0;l<r.length;l+=3){const c=r[l];r[l]=r[l+2],r[l+2]=c}const a=s.data,n=k2.createBuffer(r.length),o=n.position;for(let l=0;l<r.length;++l){const c=3*r[l];o.set(l,0,a[c]),o.set(l,1,a[c+1]),o.set(l,2,a[c+2])}return new ac(e,Lt,{geometry:Co(k2)},{geometry:gs.createVertex(e,ca.STATIC_DRAW,n.buffer)})}};function y7(i,e){Kr(i,e),i[12]=0,i[13]=0,i[14]=0,i[15]=1}const H2=ce(),k2=mr().vec3f(w.POSITION);var ec;(function(i){i[i.Rain=0]="Rain",i[i.Snow=1]="Snow",i[i.COUNT=2]="COUNT"})(ec||(ec={}));let Jx=class extends ua{constructor(){super(...arguments),this.type=ec.Rain}};d([D({count:ec.COUNT})],Jx.prototype,"type",void 0);function v7(i){const e=new $t;return e.attributes.add(w.POSITION,"vec3"),e.attributes.add(w.INSTANCEFEATUREATTRIBUTE,"float"),e.vertex.uniforms.add(new si("cameraPosition",(t,r)=>r.camera.eye)),e.vertex.uniforms.add(new si("offset",(t,r)=>b7(t,r))),e.vertex.uniforms.add(new ue("width",t=>t.width)),e.vertex.uniforms.add(new ir("proj",(t,r)=>r.camera.projectionMatrix)),e.vertex.uniforms.add(new ir("view",(t,r)=>r.camera.viewMatrix)),e.vertex.uniforms.add(new ue("time",t=>t.time)),e.varyings.add("vUv","vec2"),e.vertex.code.add(_`
    vec3 hash31(float p){
      vec3 p3 = fract(vec3(p) * vec3(0.1031, 0.1030, 0.0973));
      p3 += dot(p3, p3.yzx + 33.33);
      return fract((p3.xxy + p3.yzz) * p3.zyx);
    }

    float hash11(float p){
      p = fract(p * 0.1031);
      p *= p + 33.33;
      p *= p + p;
      return fract(p);
    }

    //https://www.geeks3d.com/20141201/how-to-rotate-a-vertex-by-a-quaternion-in-glsl/
    vec3 rotateVectorByQuaternion(vec3 v, vec4 q){
      return 2.0 * cross(q.xyz, v * q.w + cross(q.xyz, v)) + v;
    }

    void main(void) {

      vUv = position.xz;

      vec3 rand = hash31(instanceFeatureAttribute);

      // Set random position for all particles
      // The hash function space is not high resolution so offset particles by an additional random value
      // This creates grids of 1000 particles which are shifted by random hundreths of the tile width
      // overlaying multiple identical but offset grids
      vec3 randomPosition = 2.0 * (rand + (0.01 + 0.01 * rand) * floor(0.001 * instanceFeatureAttribute)) - 1.0;

      // Random orientation of rain drops
      float angle = 3.1415 * hash11(instanceFeatureAttribute);

      vec3 up = vec3(0, 0, 1);

      // Gravity and wind direction
      vec3 direction = normalize(cameraPosition);

      vec3 tangent = normalize(cross(direction, up));

      // Gravity
      vec3 animatedPos = randomPosition + direction * -time;

      // Rain particles fall straight down and are randomly oriented
      // Snow particles have random sinusoid trajectories and are rotated to face the camera
      ${i.type===ec.Rain?_`
            // Random rotation for particle
            vec3 rotationAxis = up;
            vec4 quat = vec4(rotationAxis * sin(angle), cos(angle));
            vec3 transformedPos = rotateVectorByQuaternion(vec3(0.2, 0.2, 4.0) * (position - vec3(0.5, 0.0, 0.5)), quat);

            // Rotate particle to planetary position
            rotationAxis = tangent;
            angle = 0.5 * -acos(dot(direction, up));
            quat = vec4(rotationAxis * sin(angle), cos(angle));
            transformedPos = rotateVectorByQuaternion(transformedPos, quat);

            vec4 pos = mat4(mat3(view)) * vec4(transformedPos + (mod(width * animatedPos - offset, width) - 0.5 * width), 1.0);
            gl_Position = proj * pos;
      `:_`
            vec3 rotationAxis = direction;
            vec4 quat = vec4(rotationAxis * sin(angle), cos(angle));

            tangent = rotateVectorByQuaternion(tangent, quat);
            // Random sinusoid from friction
            animatedPos += tangent * 0.25 * sin(dot(animatedPos, direction));
            vec4 pos = mat4(mat3(view)) * vec4((mod(width * animatedPos - offset, width) - 0.5 * width), 1.0);
            gl_Position = proj * (0.5 * vec4(position.xzy, 0.0) + pos);
      `}
    }
  `),e.fragment.uniforms.add([new ue("opacity",t=>t.opacity),new si("particleColor",(t,r)=>x7(r,i))]),e.fragment.code.add(_`
    void main() {

      // Cut off corners of the triangle
      if(vUv.x < 0.0 || vUv.y < 0.0){
        discard;
      }

      float d = length(vUv - vec2(0.5));

      ${i.type===ec.Rain?_`d = 0.35 * smoothstep(0.5, 0.0, d);`:_`d = smoothstep(0.5, 0.1, d);`}
      gl_FragColor = opacity * vec4(particleColor * d, d);
    }
  `),e}function b7(i,e){const t=e.camera.eye,r=.5*i.width,s=1/i.width,a=R4(ew,j(ew,(t[0]+r)*s,(t[1]+r)*s,(t[2]+r)*s));return Xr(a,t,B(a,a,i.width))}function x7(i,e){const t=e.type===ec.Rain?T7:w7,r=B(ew,t,C7),s=i.camera.eye;W(j2,s);const a=Math.max(0,J(j2,i.lighting.mainLight.direction));return Gr(r,r,t,a)}const ew=T(),j2=T(),w7=Ge(1,1,1),T7=Ge(.85,.85,.85),C7=.7,S7=Object.freeze(Object.defineProperty({__proto__:null,build:v7},Symbol.toStringTag,{value:"Module"}));let P7=class extends Gi{constructor(){super(...arguments),this.time=0,this.radius=1,this.width=500,this.opacity=1}},tw=class iD extends Mt{initializeProgram(e){return new Rt(e.rctx,iD.shader.get().build(this.configuration),G0)}initializePipeline(){return qe({blending:Ar(ae.ONE,ae.ONE,ae.ONE_MINUS_SRC_ALPHA,ae.ONE_MINUS_SRC_ALPHA),depthTest:{func:Fa.LEQUAL},colorWrite:at})}};tw.shader=new Dt(S7,()=>_e(()=>import("./Precipitation.glsl-2c4fe5f0.js"),["assets/Precipitation.glsl-2c4fe5f0.js","assets/calcite-8912bd40.js","assets/index-00759e4a.js","assets/index-5026a37a.css","assets/calcite-96fa36fd.css","assets/objectResourceUtils-782953c3.js","assets/devEnvironmentUtils-5002a058.js","assets/mat3f64-50f3b9f6.js","assets/mat4f64-abdda1bb.js","assets/BufferView-379a78a4.js","assets/vec33-69c9e93b.js","assets/DefaultMaterial_COLOR_GAMMA-6ed76d86.js","assets/types-e1c0a5bf.js","assets/enums-e2e92c86.js","assets/Version-aa0a1d91.js","assets/quat-7b70e9a8.js","assets/quatf64-f8f1c132.js","assets/resourceUtils-527631ac.js","assets/basicInterfaces-7449a8bf.js","assets/Indices-d8bff7b2.js","assets/NestedMap-1b5db22e.js","assets/requestImageUtils-d1ba3b36.js","assets/symbolColorUtils-c9d24716.js","assets/Util-6d3f024a.js","assets/sphere-d0e5285d.js","assets/VertexAttribute-15d1866a.js","assets/doublePrecisionUtils-e3c3d0d8.js","assets/OrderIndependentTransparency-5f7257d7.js","assets/Texture-563cf5e5.js","assets/FramebufferObject-8b18fc0c.js","assets/VertexElementDescriptor-2925c6af.js","assets/InterleavedLayout-d57c91d0.js","assets/vec3f32-01c06d8d.js","assets/plane-5e2b046c.js","assets/spatialReferenceEllipsoidUtils-afb35af9.js","assets/scaleUtils-d13015f2.js","assets/ElevationSamplerData-e3118b17.js","assets/Octree-499541ed.js","assets/edgeProcessing-20e12367.js","assets/deduplicate-769a6f51.js","assets/MeshComponent-788e605a.js","assets/earcut-61f7b102.js","assets/imageUtils-c2d0d1ae.js","assets/projection-5969b753.js","assets/ZoomMomentumEstimator-ef57e6a4.js","assets/floatRGBA-ca2b39ca.js","assets/dehydratedFeatures-3a140d03.js","assets/quantizationUtils-b3b2ae2a.js","assets/labelFormatUtils-71e1f841.js","assets/orientedBoundingBox-a14b97b5.js","assets/quatf32-51a323b8.js","assets/SnappingCandidate-970faec6.js","assets/callExpressionWithFeature-df1a8f01.js","assets/DefaultVertexAttributeLayouts-5f20d8dd.js","assets/geometryServiceUtils-a536bb19.js","assets/project-909a4219.js","assets/LercDecoder-65586d50.js","assets/VectorTile-d41a1f0f.js","assets/enums-fb086c25.js","assets/config-1337d16e.js","assets/TiledDisplayObject-419c008b.js","assets/DisplayObject-87c37b69.js","assets/rasterUtils-7694cc98.js","assets/resources-7587d8f4.js","assets/workerHelper-6131d203.js","assets/webgl-debug-7f880832.js","assets/RenderingContext-0f21aa0e.js","assets/ProgramCache-f29c900e.js","assets/Program-77209250.js","assets/MediaLayer-4c42fc2f.js","assets/MediaElementView-06baa4d4.js","assets/normalizeUtilsSync-3ea564a9.js","assets/resourceExtension-f31d9f10.js","assets/BoundsStore-00da37da.js","assets/PooledRBush-5a11bc7e.js","assets/prism-line-numbers-eff41b13.js","assets/label2-a2f37e65.js","assets/interactive-1de2e238.js","assets/loadable-6afd516d.js","assets/t9n-81df3a71.js","assets/observers-c89705b8.js","assets/icon-8e47fbec.js","assets/loader-c773e800.js","assets/guid-51402ee7.js","assets/prism-line-numbers-7c5d72ff.css"]));const G0=new Map([[w.POSITION,0],[w.INSTANCEFEATUREATTRIBUTE,1]]);let ad=class extends Ie{constructor(e){super(e),this._numParticles=25e4,this._rainSpeed=.1,this._snowSpeed=.01,this._passParameters=new P7,this._animation=new P3,this._updatingTracking=new av,this._passParameters.time=0,this._passParameters.radius=Et(e.view.spatialReference).radius,this._techniqueRepository=e.context.techniqueRepository}destroy(){this._updatingTracking.destroy(),this._numParticles=0,this._snowTechniqueCached=er(this._snowTechniqueCached),this._rainTechniqueCached=er(this._rainTechniqueCached),this._vao=De(this._vao),this._instanceIdBuffer=De(this._instanceIdBuffer)}get updating(){return this._updatingTracking.updating}get _rainTechnique(){if(P(this._rainTechniqueCached)){const e=new Jx;e.type=ec.Rain,this._rainTechniqueCached=this._techniqueRepository.acquire(tw,e)}return this._rainTechniqueCached}get _snowTechnique(){if(P(this._snowTechniqueCached)){const e=new Jx;e.type=ec.Snow,this._snowTechniqueCached=this._techniqueRepository.acquire(tw,e)}return this._snowTechniqueCached}update(e){return this._animation.advance(e)}render(e,t,r){var l;const s=r==="rainy"?this._rainTechnique:this._snowTechnique;if(!s.compiled)return void this.context.requestRender();const a=e.rctx;if(this._ensureResources(a),P(s)||P(this._vao)||P(this._instanceIdBuffer)||(g(e.bindParameters.cloudsFade.data)&&(this._passParameters.opacity=1-e.bindParameters.cloudsFade.fadeInOutHeight.factor),this._passParameters.opacity<=0))return;const n=.35;t=t<.5?st(0,n,2*t):st(n,1,2*(t-.5)),this._passParameters.time=(r==="rainy"?this._rainSpeed:this._snowSpeed)*aT(this._animation.time)%1e5;const o=a.bindTechnique(s,this._passParameters,e.bindParameters);a.bindVAO(this._vao),o.assertCompatibleVertexAttributeLocations(this._vao),tM(a,G0,this._instanceIdBuffer,q2,0),(l=a.capabilities.instancing)==null||l.drawArraysInstanced(Ut.TRIANGLES,0,3,this._numParticles*t),iM(a,G0,this._instanceIdBuffer,q2)}_ensureResources(e){P(this._vao)&&(this._vao=this._createVertexArrayObject(e)),P(this._instanceIdBuffer)&&(this._instanceIdBuffer=this._createInstanceIndices(e))}_createInstanceIndices(e){const t=[];for(let r=0;r<this._numParticles;r++)t.push(r);return gs.createVertex(e,ca.STATIC_DRAW,new Float32Array(t))}_createVertexArrayObject(e){const t=new Float32Array([-1,0,1,1,0,-1,1,0,1]);return new ac(e,G0,{geometry:Co(O7)},{geometry:gs.createVertex(e,ca.STATIC_DRAW,t)})}};d([v({constructOnly:!0})],ad.prototype,"context",void 0),d([v({constructOnly:!0})],ad.prototype,"view",void 0),d([v({readOnly:!0})],ad.prototype,"updating",null),d([v()],ad.prototype,"_updatingTracking",void 0),ad=d([Y("esri.views.3d.environment.Precipitation")],ad);const O7=mr().vec3f(w.POSITION),q2=Co(mr().f32(w.INSTANCEFEATUREATTRIBUTE),1),R7=new Uint8ClampedArray([0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,3,0,0,0,3,0,0,0,3,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,6,0,0,0,6,0,0,0,7,0,0,0,7,0,0,0,7,0,0,0,8,0,0,0,8,0,0,0,8,0,0,0,9,0,0,0,9,0,0,0,9,0,0,0,10,0,0,0,10,0,0,0,11,0,0,0,11,0,0,0,11,0,0,0,12,0,0,0,12,0,0,0,12,0,0,0,13,0,0,0,13,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,15,0,0,0,15,0,0,0,16,0,0,0,16,0,0,0,16,0,0,0,17,0,0,0,17,0,0,0,18,0,0,0,18,0,0,0,19,0,0,0,19,0,0,0,19,0,0,0,20,0,0,0,20,0,0,0,21,0,0,0,21,0,0,0,22,0,0,0,22,11,0,0,23,11,0,0,23,11,0,0,23,11,0,0,23,11,0,0,24,11,0,0,24,11,0,0,24,10,0,0,25,10,0,0,25,10,0,0,26,10,0,0,26,9,0,0,27,9,0,0,27,9,0,0,28,9,0,0,28,9,0,0,29,9,0,0,29,8,0,0,30,8,0,0,30,8,0,0,31,8,0,0,31,8,0,0,32,8,0,0,32,8,0,0,32,8,0,0,32,8,0,0,33,8,0,0,33,8,0,0,34,7,0,0,35,7,0,0,35,7,0,0,36,7,0,0,36,7,7,0,37,7,7,0,37,7,7,0,38,7,7,0,38,13,7,0,39,13,7,0,39,13,6,0,40,13,6,0,40,12,6,0,41,12,6,0,41,12,6,0,41,12,6,0,42,12,6,0,42,12,6,0,43,12,6,0,43,12,6,0,44,12,6,0,44,11,6,0,45,11,6,6,45,11,6,6,46,11,5,5,47,11,5,5,47,11,5,5,48,11,5,5,48,10,5,5,49,10,5,5,49,10,5,5,50,15,5,5,51,15,5,5,51,15,5,5,51,15,5,5,51,15,5,5,52,15,5,5,52,14,5,5,53,14,5,5,54,14,5,5,54,14,5,5,55,14,5,5,55,14,5,5,56,13,4,4,57,13,4,4,57,13,4,4,58,13,4,4,58,13,4,4,59,13,4,4,59,17,4,4,60,17,4,4,60,17,4,4,60,17,4,4,61,17,4,4,61,16,4,4,62,16,4,4,63,16,4,4,63,16,8,4,64,16,8,4,64,16,8,4,65,15,8,4,66,15,8,4,66,15,8,4,67,19,8,4,68,19,8,4,68,18,7,4,69,18,7,4,69,18,7,4,69,18,7,4,70,18,7,4,70,18,7,4,71,18,7,4,71,18,7,4,72,17,7,3,73,17,7,3,73,21,7,3,74,21,7,3,74,20,7,3,75,20,7,3,76,20,7,3,76,20,7,3,77,20,7,3,77,20,7,3,78,20,7,3,78,20,7,7,78,19,6,6,79,19,10,6,80,19,10,6,80,22,9,6,81,22,9,6,81,22,9,6,82,22,9,6,83,22,9,6,83,21,9,6,84,21,9,6,84,21,9,6,85,21,9,6,86,21,9,6,86,23,9,6,87,23,9,6,87,23,9,6,87,23,9,6,88,23,9,6,88,23,9,6,89,23,8,6,90,23,8,6,90,22,8,6,91,22,8,6,91,25,8,6,92,25,8,5,93,25,8,5,93,24,8,5,94,24,8,5,94,24,11,5,95,24,11,5,96,24,11,5,96,26,11,5,97,26,11,5,97,26,11,5,97,26,10,5,98,26,10,5,98,26,10,5,99,25,10,5,100,25,10,5,100,25,10,5,101,25,10,5,101,25,10,5,102,27,10,5,103,27,10,5,103,27,10,5,104,27,10,5,104,27,12,5,105,26,12,5,106,26,12,5,106,29,12,5,106,29,12,5,106,29,12,7,107,28,12,7,108,28,12,7,108,28,12,7,109,28,12,7,109,30,12,7,110,30,11,7,111,30,11,7,111,30,11,7,112,30,11,7,112,29,11,7,113,29,11,7,114,29,11,7,114,31,11,7,115,31,11,7,115,31,11,7,115,31,11,7,116,31,11,7,116,33,13,7,117,33,13,9,117,32,13,9,118,32,13,9,118,32,13,9,119,34,15,8,120,34,15,8,120,34,15,8,121,36,15,8,121,36,15,8,122,36,15,8,122,35,15,8,123,37,14,8,124,37,14,8,124,37,14,8,124,37,14,8,124,39,14,8,125,39,16,8,125,38,16,8,126,38,16,8,127,38,16,8,127,40,16,10,128,40,16,10,128,40,16,10,129,42,18,10,129,41,18,10,130,41,18,10,130,43,18,10,131,43,18,10,131,42,17,10,132,42,17,12,132,42,17,12,133,44,17,12,133,44,17,12,133,46,17,11,134,46,17,11,134,45,19,11,135,45,19,11,135,47,19,11,136,47,19,11,136,47,19,11,137,47,19,11,137,48,20,11,138,48,20,11,138,50,20,13,139,50,20,13,139,49,20,13,140,49,22,13,140,51,22,13,141,51,22,13,141,50,22,13,142,52,22,13,142,52,21,12,143,53,21,12,143,53,21,12,143,53,21,12,143,53,21,14,144,53,23,14,144,55,23,14,145,55,23,14,145,56,23,14,146,56,23,14,146,57,24,14,147,57,24,14,147,59,24,16,148,59,24,16,148,58,24,15,149,58,26,15,149,58,26,15,149,60,26,15,150,60,26,15,150,61,25,15,151,61,25,15,151,62,25,17,152,62,25,17,152,64,25,17,152,64,27,17,152,63,27,17,153,63,27,17,153,65,27,17,153,66,28,17,154,66,28,17,154,67,28,16,155,67,28,16,155,67,30,16,155,69,29,18,156,69,29,18,156,68,29,18,157,70,29,18,157,70,29,18,157,71,31,18,158,71,31,18,158,72,30,19,159,72,30,19,159,74,30,19,159,73,30,19,160,73,32,19,160,74,32,19,161,74,32,21,161,76,32,21,161,78,33,21,161,78,33,21,161,79,35,20,162,78,34,20,163,79,34,22,164,81,36,22,164,82,36,22,165,81,35,22,166,82,37,21,167,84,37,21,167,85,36,21,168,86,38,23,169,88,38,23,169,88,38,23,170,88,39,23,170,89,39,24,171,91,40,24,171,92,40,24,172,93,40,24,173,94,41,25,173,95,41,25,174,96,42,25,175,98,42,25,175,99,43,26,176,99,43,26,177,101,45,26,177,102,44,26,178,103,46,27,179,104,46,27,179,105,46,27,179,106,45,28,180,108,47,28,180,108,46,28,181,109,48,28,182,111,48,29,182,111,49,29,183,114,49,29,184,114,50,30,184,114,50,30,185,116,51,30,185,117,51,30,186,119,52,31,187,119,53,31,187,121,53,31,188,122,54,33,188,123,54,32,189,124,55,32,189,125,55,32,189,126,56,34,190,128,56,34,190,128,57,33,191,130,57,33,191,131,58,35,192,131,58,35,192,133,59,34,193,134,60,35,194,135,60,35,194,136,61,37,195,139,61,37,195,139,62,36,196,141,62,36,196,141,63,38,197,142,63,38,197,143,64,39,198,144,64,39,198,146,66,39,198,146,67,39,198,147,67,38,199,147,68,40,199,149,68,40,200,150,69,40,200,152,70,41,201,154,71,41,201,154,71,42,202,155,72,42,202,156,73,41,203,157,73,43,203,158,74,42,204,160,75,44,204,161,76,44,204,162,77,44,205,164,77,45,205,165,78,45,206,166,79,45,206,168,80,46,207,169,81,46,207,170,83,47,207,171,83,47,207,172,83,47,207,174,85,48,208,175,85,48,208,177,85,48,209,178,87,49,209,180,87,49,210,181,87,49,210,182,89,50,210,182,89,50,211,185,91,50,211,186,91,51,212,186,93,51,212,189,94,52,212,190,95,51,213,192,96,51,213,193,96,53,213,194,97,52,214,195,98,54,214,197,98,55,215,198,100,55,215,199,101,55,215,200,102,55,216,202,103,55,216,203,104,55,216,204,105,57,216,205,106,57,216,207,107,58,216,208,108,58,217,209,109,59,217,210,110,60,217,211,111,60,218,212,112,61,218,213,113,61,218,214,114,62,219,217,115,63,219,217,116,64,219,218,118,64,220,219,119,65,220,220,121,66,220,222,121,67,221,222,122,67,221,222,123,68,221,223,124,69,222,224,125,70,222,225,127,71,222,226,128,72,223,228,129,73,223,228,130,74,223,229,132,75,223,230,135,79,224,231,138,81,224,233,141,84,224,233,144,87,225,235,147,91,225,236,150,94,225,237,154,97,225,238,158,102,225,239,161,107,225,239,165,110,225,240,168,114,226,241,172,118,226,241,176,122,226,241,181,126,226,242,183,130,227,243,186,135,227,243,190,139,227,244,194,143,227,244,197,147,228,244,200,150,228,245,204,154,228,245,207,157,228,245,210,161,229,246,212,164,229,246,215,167,229,246,217,169,229,246,220,172,230,247,221,174,230]),c_=128,W2=-qx,X2=0,N1=50,E7=()=>1-511/512,A7=I0([[50,.1015625],[500,.21875],[5e3,1-250/512],[5e4,.4140625]]);let M7=class{constructor(e,t){this.view=e,this.type=fr.Simple,this._passParameters=new aC,this._vaoCount=0,this._texV1=1,this._isMars=Ff(e.spatialReference);const r=Et(e.spatialReference);this._planetRadius=r.radius,this._outerRimWidth=r.outerAtmosphereRimWidth,this._innerRimFactor=(this._planetRadius+W2)/this._planetRadius,this._middleRimFactor=(this._planetRadius+X2)/this._planetRadius,this._outerRimFactor=(this._planetRadius+this._outerRimWidth)/this._planetRadius,this._texV0=X2/this._outerRimWidth,this._texVScale=this._texV1-this._texV0,this._techniqueRepository=t.techniqueRepository;const s=t.renderContext.rctx;this._cameraChangeHandle=te(()=>{var o;return(o=this.view.state)==null?void 0:o.camera},()=>t.requestRender(),Qi),this._vao=this._createRibbon(s),this._vaoCount=Os(this._vao,"geometry"),this._fadeVao=pa(s),this._fadeVaoCount=Os(this._fadeVao,"geometry");const a=this._isMars?R7:JM;this._passParameters.texture=new Ai(s,{pixelFormat:St.RGBA,dataType:Zt.UNSIGNED_BYTE,wrapMode:kt.CLAMP_TO_EDGE,samplingMode:Qt.LINEAR,flipped:!0,width:1,height:512},a);const n=new sC;n.geometry=gl.Cone,this._coneTechnique=this._techniqueRepository.acquire(xy,n),n.geometry=gl.Underground,this._undergroundTechnique=this._techniqueRepository.acquire(xy,n)}destroy(){this._coneTechnique.release(),this._undergroundTechnique.release(),this._cameraChangeHandle.remove(),this._passParameters.texture=De(this._passParameters.texture),this._fadeVao.dispose(),this._vao.dispose()}render(e){const t=e.bindParameters.camera;this._update(t);const r=e.rctx;this._passParameters.undergroundFadeAlpha<1&&(r.bindTechnique(this._coneTechnique,this._passParameters,e.bindParameters),r.bindVAO(this._vao),r.drawArrays(Ut.TRIANGLES,0,this._vaoCount)),this._passParameters.undergroundFadeAlpha>0&&(r.bindTechnique(this._undergroundTechnique,this._passParameters,e.bindParameters),r.bindVAO(this._fadeVao),r.drawArrays(Ut.TRIANGLE_STRIP,0,this._fadeVaoCount))}renderHaze(){}_update(e){const t=T(),r=this._planetRadius,s=pe(e.eye),a=s-r;if(a<0){const m=Math.min(-a/5e3,1);this._passParameters.undergroundFadeAlpha=m}else this._passParameters.undergroundFadeAlpha=0;const n=Math.max(N1,a),o=r+W2;this._passParameters.innerScale=D7(r+n,r,o)-1,this._passParameters.altitudeFade=eC(a),B(t,e.eye,(r+N1)/s),Q2(t,e.center,e.up,r,this._passParameters.silhouette);const l=this._computeScreenRimWidth(e,t,e.up,this._passParameters.silhouette),c=E7(),h=A7(a);let u=this._texV0+c*this._texVScale,p=this._texV0+l*h*this._texVScale;if(a>N1){Q2(e.eye,e.center,e.up,r,this._passParameters.silhouette);const m=this._computeScreenRimWidth(e,e.eye,e.up,this._passParameters.silhouette),f=ee((m-1.5)/(l-1.5),0,1);u=this._texV0+f*c*this._texVScale,p=this._texV0+st(this._texV1,l*h,f)*this._texVScale}zt(this._passParameters.texV,u,p)}_createRibbon(e){const t=zi(3+3*c_*3),r=new Uint32Array(3*c_*5);t[0]=0,t[1]=0,t[2]=-1;for(let n=0;n<c_;n++){const o=9*n+3;t[o+0]=n,t[o+1]=this._innerRimFactor,t[o+2]=-1,t[o+3]=n,t[o+4]=this._middleRimFactor,t[o+5]=0,t[o+6]=n,t[o+7]=this._outerRimFactor,t[o+8]=1;const l=3*n+1,c=n===c_-1?1:l+3,h=15*n;r[h+0]=l,r[h+1]=l+1,r[h+2]=c+1,r[h+3]=c+1,r[h+4]=c,r[h+5]=l,r[h+6]=l+1,r[h+7]=l+2,r[h+8]=c+2,r[h+9]=c+2,r[h+10]=c+1,r[h+11]=l+1,r[h+12]=l,r[h+13]=c,r[h+14]=0}const s=Z2.createBuffer(r.length),a=s.position;for(let n=0;n<r.length;++n){const o=3*r[n];a.set(n,0,t[o]),a.set(n,1,t[o+1]),a.set(n,2,t[o+2])}return new ac(e,Lt,{geometry:Co(Z2)},{geometry:gs.createVertex(e,ca.STATIC_DRAW,s.buffer)})}_computeScreenRimWidth(e,t,r,s){return X(_u,s.center,s.v2),B(h_,_u,this._outerRimFactor),sT(F1,t,_u,r),r2(_u,F1,e.projectionMatrix,e.viewport,_u),r2(h_,F1,e.projectionMatrix,e.viewport,h_),yi(_u,h_)/e.height}};function Q2(i,e,t,r,s){const a=pe(i),n=r*Math.sqrt(a*a-r*r)/a,o=Math.sqrt(r*r-n*n),l=s.v1,c=s.v2;return B(s.center,i,o/a),Be(l,i,e),sn(l)<1&&Be(l,i,t),B(l,l,n/pe(l)),Be(c,l,i),B(c,c,n/pe(c)),n}const F1=ce(),_u=T(),h_=T();function D7(i,e,t){return i*i/(Math.sqrt(i*i-e*e)*Math.sqrt(i*i-t*t)+e*t)}const Z2=mr().vec3f(w.POSITION);let rD=class sD extends Mt{initializeProgram(e){return new Rt(e.rctx,sD.shader.get().build(this.configuration),Lt)}initializePipeline(){return qe({blending:Ar(ae.ONE,ae.ZERO,ae.ONE_MINUS_SRC_COLOR,ae.ONE),colorWrite:at})}};rD.shader=new Dt(XM,()=>_e(()=>import("./FogHaze.glsl-cd2648d0.js"),["assets/FogHaze.glsl-cd2648d0.js","assets/calcite-8912bd40.js","assets/index-00759e4a.js","assets/index-5026a37a.css","assets/calcite-96fa36fd.css","assets/mat4f64-abdda1bb.js","assets/objectResourceUtils-782953c3.js","assets/devEnvironmentUtils-5002a058.js","assets/mat3f64-50f3b9f6.js","assets/BufferView-379a78a4.js","assets/vec33-69c9e93b.js","assets/DefaultMaterial_COLOR_GAMMA-6ed76d86.js","assets/types-e1c0a5bf.js","assets/enums-e2e92c86.js","assets/Version-aa0a1d91.js","assets/quat-7b70e9a8.js","assets/quatf64-f8f1c132.js","assets/resourceUtils-527631ac.js","assets/basicInterfaces-7449a8bf.js","assets/Indices-d8bff7b2.js","assets/NestedMap-1b5db22e.js","assets/requestImageUtils-d1ba3b36.js","assets/symbolColorUtils-c9d24716.js","assets/Util-6d3f024a.js","assets/sphere-d0e5285d.js","assets/VertexAttribute-15d1866a.js","assets/doublePrecisionUtils-e3c3d0d8.js","assets/OrderIndependentTransparency-5f7257d7.js","assets/Texture-563cf5e5.js","assets/FramebufferObject-8b18fc0c.js","assets/VertexElementDescriptor-2925c6af.js","assets/InterleavedLayout-d57c91d0.js","assets/vec3f32-01c06d8d.js","assets/plane-5e2b046c.js","assets/spatialReferenceEllipsoidUtils-afb35af9.js","assets/scaleUtils-d13015f2.js","assets/ElevationSamplerData-e3118b17.js","assets/Octree-499541ed.js","assets/edgeProcessing-20e12367.js","assets/deduplicate-769a6f51.js","assets/MeshComponent-788e605a.js","assets/earcut-61f7b102.js","assets/imageUtils-c2d0d1ae.js","assets/projection-5969b753.js","assets/ZoomMomentumEstimator-ef57e6a4.js","assets/floatRGBA-ca2b39ca.js","assets/dehydratedFeatures-3a140d03.js","assets/quantizationUtils-b3b2ae2a.js","assets/labelFormatUtils-71e1f841.js","assets/orientedBoundingBox-a14b97b5.js","assets/quatf32-51a323b8.js","assets/SnappingCandidate-970faec6.js","assets/callExpressionWithFeature-df1a8f01.js","assets/DefaultVertexAttributeLayouts-5f20d8dd.js","assets/geometryServiceUtils-a536bb19.js","assets/project-909a4219.js","assets/LercDecoder-65586d50.js","assets/VectorTile-d41a1f0f.js","assets/enums-fb086c25.js","assets/config-1337d16e.js","assets/TiledDisplayObject-419c008b.js","assets/DisplayObject-87c37b69.js","assets/rasterUtils-7694cc98.js","assets/resources-7587d8f4.js","assets/workerHelper-6131d203.js","assets/webgl-debug-7f880832.js","assets/RenderingContext-0f21aa0e.js","assets/ProgramCache-f29c900e.js","assets/Program-77209250.js","assets/MediaLayer-4c42fc2f.js","assets/MediaElementView-06baa4d4.js","assets/normalizeUtilsSync-3ea564a9.js","assets/resourceExtension-f31d9f10.js","assets/BoundsStore-00da37da.js","assets/PooledRBush-5a11bc7e.js","assets/prism-line-numbers-eff41b13.js","assets/label2-a2f37e65.js","assets/interactive-1de2e238.js","assets/loadable-6afd516d.js","assets/t9n-81df3a71.js","assets/observers-c89705b8.js","assets/icon-8e47fbec.js","assets/loader-c773e800.js","assets/guid-51402ee7.js","assets/prism-line-numbers-7c5d72ff.css"]));const I7=.7,L7=1;let ng=class extends Ie{constructor(e){super(e),this._passParameters=new iC;const t=e.context.renderContext.rctx;this._vao=pa(t,Gf);const r=Et(e.view.spatialReference);this._planetRadius=r.radius,this._atmosphereRadius=r.radius+uf;const s=new rC;s.haze=!0,this._hazeTechnique=e.context.techniqueRepository.acquire(rD,s)}destroy(){this._hazeTechnique.release(),this._vao.dispose()}set strength(e){this._passParameters.hazeStrength=e}get strength(){return this._passParameters.hazeStrength}render(e,t){if(this.view.basemapTerrain.baseOpacity===0||(this._update(e,t),this._passParameters.hazeAmount<=0))return;const r=this._hazeTechnique;if(!r.compiled)return void this.context.requestRender();const s=e.offscreenRenderingHelper;s.renderDepthDetached(()=>{this._passParameters.depthTexture=s.depthTexture;const a=e.rctx.bindTechnique(r,this._passParameters,e.bindParameters);this._renderSimpleHaze(a,e)})}_renderSimpleHaze(e,t){const r=t.rctx;r.bindVAO(this._vao),e.assertCompatibleVertexAttributeLocations(this._vao),r.drawArrays(Ut.TRIANGLE_STRIP,0,4)}_update(e,t){const r=e.bindParameters.camera;W(Y2,r.eye);const s=Math.max(0,J(Y2,e.bindParameters.lighting.mainLight.direction)),a=N7;B(K2,a,0),Gr(this._passParameters.hazeColor,K2,a,s);const n=pe(r.eye),o=n*n;this._passParameters.atmosphereC=o-this._atmosphereRadius*this._atmosphereRadius,this._passParameters.hazeAmount=(1-Lp(I7*Tn,L7*Tn,Math.abs(n-this._planetRadius)))*t.amount,this._passParameters.fogStrength=t.strength}static isSupported(e){return e.capabilities.depthTexture}};d([v({constructOnly:!0})],ng.prototype,"context",void 0),d([v({constructOnly:!0})],ng.prototype,"view",void 0),ng=d([Y("esri.views.3d.environment.SimpleHaze")],ng);let $7=class{constructor(){this.strength=0,this.amount=0}};const N7=Ge(.24,.44,.8),Y2=T(),K2=T();function nC(i){const e=_`vec4 alignToPixelCenter(vec4 clipCoord, vec2 widthHeight) {
vec2 xy = vec2(0.500123) + 0.5 * clipCoord.xy / clipCoord.w;
vec2 pixelSz = vec2(1.0) / widthHeight;
vec2 ij = (floor(xy * widthHeight) + vec2(0.5)) * pixelSz;
vec2 result = (ij * 2.0 - vec2(1.0)) * clipCoord.w;
return vec4(result, clipCoord.zw);
}`,t=_`vec4 alignToPixelOrigin(vec4 clipCoord, vec2 widthHeight) {
vec2 xy = vec2(0.5) + 0.5 * clipCoord.xy / clipCoord.w;
vec2 pixelSz = vec2(1.0) / widthHeight;
vec2 ij = floor((xy + 0.5 * pixelSz) * widthHeight) * pixelSz;
vec2 result = (ij * 2.0 - vec2(1.0)) * clipCoord.w;
return vec4(result, clipCoord.zw);
}`;i.vertex.code.add(e),i.vertex.code.add(t),i.fragment.code.add(e),i.fragment.code.add(t)}function F7(){const i=new $t;return i.attributes.add(w.POSITION,"vec3"),i.attributes.add(w.COLOR,"vec4"),i.attributes.add(w.SIZE,"float"),i.varyings.add("vcolor","vec4"),i.varyings.add("vsize","float"),i.vertex.uniforms.add([new ir("transform",(e,t)=>z7(e,t)),new ai("viewport",(e,t)=>t.camera.fullViewport),new ue("pixelRatio",(e,t)=>t.camera.pixelRatio)]),i.include(nC),i.vertex.code.add(_`void main(void) {
vec4 posProj = transform * vec4(position, 0);
gl_Position = alignToPixelCenter(posProj, viewport.zw);
vcolor = color / 1.2;
vsize = size * 5.0 * pixelRatio;
gl_PointSize = vsize;
}`),i.fragment.code.add(_`void main() {
float cap = 0.7;
float scale = 1.0 / cap;
float helper = clamp(length(abs(gl_PointCoord - vec2(0.5))), 0.0, cap);
float alpha = clamp((cap - helper) * scale, 0.0, 1.0);
float intensity = alpha * alpha * alpha;
if (vsize < 3.0) {
intensity *= 0.5;
}
gl_FragColor = vec4(vcolor.xyz, intensity);
}`),i}function z7(i,e){return Kr(mc,e.camera.projectionMatrix),mc[10]=24e-8-1,mc[11]=-1,mc[14]=(24e-8-2)*e.camera.near,pr(mc,mc,e.camera.viewMatrix),pr(mc,mc,i.modelMatrix)}const mc=ce(),U7=Object.freeze(Object.defineProperty({__proto__:null,build:F7},Symbol.toStringTag,{value:"Module"}));let V7=class extends Gi{constructor(){super(...arguments),this.modelMatrix=ce()}},aD=class nD extends Mt{constructor(e){super(e,new ua,()=>this.destroy())}initializeProgram(e){return new Rt(e.rctx,nD.shader.get().build(),Lt)}initializePipeline(){return qe({blending:Ar(ae.SRC_ALPHA,ae.ONE,ae.ONE_MINUS_SRC_ALPHA,ae.ONE_MINUS_SRC_ALPHA),depthTest:{func:Fa.LEQUAL},colorWrite:at})}};aD.shader=new Dt(U7,()=>_e(()=>import("./Stars.glsl-aff07608.js"),["assets/Stars.glsl-aff07608.js","assets/calcite-8912bd40.js","assets/index-00759e4a.js","assets/index-5026a37a.css","assets/calcite-96fa36fd.css","assets/mat4f64-abdda1bb.js","assets/OrderIndependentTransparency-5f7257d7.js","assets/enums-e2e92c86.js","assets/basicInterfaces-7449a8bf.js","assets/objectResourceUtils-782953c3.js","assets/devEnvironmentUtils-5002a058.js","assets/mat3f64-50f3b9f6.js","assets/BufferView-379a78a4.js","assets/vec33-69c9e93b.js","assets/DefaultMaterial_COLOR_GAMMA-6ed76d86.js","assets/types-e1c0a5bf.js","assets/Version-aa0a1d91.js","assets/quat-7b70e9a8.js","assets/quatf64-f8f1c132.js","assets/resourceUtils-527631ac.js","assets/Indices-d8bff7b2.js","assets/NestedMap-1b5db22e.js","assets/requestImageUtils-d1ba3b36.js","assets/symbolColorUtils-c9d24716.js","assets/Util-6d3f024a.js","assets/sphere-d0e5285d.js","assets/VertexAttribute-15d1866a.js","assets/doublePrecisionUtils-e3c3d0d8.js","assets/Texture-563cf5e5.js","assets/FramebufferObject-8b18fc0c.js","assets/VertexElementDescriptor-2925c6af.js","assets/InterleavedLayout-d57c91d0.js","assets/vec3f32-01c06d8d.js","assets/plane-5e2b046c.js","assets/spatialReferenceEllipsoidUtils-afb35af9.js","assets/scaleUtils-d13015f2.js","assets/ElevationSamplerData-e3118b17.js","assets/Octree-499541ed.js","assets/edgeProcessing-20e12367.js","assets/deduplicate-769a6f51.js","assets/MeshComponent-788e605a.js","assets/earcut-61f7b102.js","assets/imageUtils-c2d0d1ae.js","assets/projection-5969b753.js","assets/ZoomMomentumEstimator-ef57e6a4.js","assets/floatRGBA-ca2b39ca.js","assets/dehydratedFeatures-3a140d03.js","assets/quantizationUtils-b3b2ae2a.js","assets/labelFormatUtils-71e1f841.js","assets/orientedBoundingBox-a14b97b5.js","assets/quatf32-51a323b8.js","assets/SnappingCandidate-970faec6.js","assets/callExpressionWithFeature-df1a8f01.js","assets/DefaultVertexAttributeLayouts-5f20d8dd.js","assets/geometryServiceUtils-a536bb19.js","assets/project-909a4219.js","assets/LercDecoder-65586d50.js","assets/VectorTile-d41a1f0f.js","assets/enums-fb086c25.js","assets/config-1337d16e.js","assets/TiledDisplayObject-419c008b.js","assets/DisplayObject-87c37b69.js","assets/rasterUtils-7694cc98.js","assets/resources-7587d8f4.js","assets/workerHelper-6131d203.js","assets/webgl-debug-7f880832.js","assets/RenderingContext-0f21aa0e.js","assets/ProgramCache-f29c900e.js","assets/Program-77209250.js","assets/MediaLayer-4c42fc2f.js","assets/MediaElementView-06baa4d4.js","assets/normalizeUtilsSync-3ea564a9.js","assets/resourceExtension-f31d9f10.js","assets/BoundsStore-00da37da.js","assets/PooledRBush-5a11bc7e.js","assets/prism-line-numbers-eff41b13.js","assets/label2-a2f37e65.js","assets/interactive-1de2e238.js","assets/loadable-6afd516d.js","assets/t9n-81df3a71.js","assets/observers-c89705b8.js","assets/icon-8e47fbec.js","assets/loader-c773e800.js","assets/guid-51402ee7.js","assets/prism-line-numbers-7c5d72ff.css"]));let Uc=class extends Ie{get updating(){return this._updatingTracking.updating||this.loading}get loading(){return g(this._loadDataTask)&&!this._loadDataTask.finished}constructor(e){super(e),this._loadDataTask=null,this._numPoints=0,this._renderParameter=new V7,this._updatingTracking=new av}initialize(){this._loadDataTask=this._createLoadDataTask()}destroy(){this._loadDataTask=Th(this._loadDataTask),this._updatingTracking.destroy(),this._numPoints=0,this._technique=er(this._technique),this._vao=De(this._vao)}render(e){const{rctx:t}=e;if(this._ensureResources(t),P(this._technique)||P(this._vao))return;if(!this._technique.compiled)return void this.requestRender();const r=t.bindTechnique(this._technique,this._renderParameter,e.bindParameters);t.bindVAO(this._vao),r.assertCompatibleVertexAttributeLocations(this._vao),t.drawArrays(Ut.POINTS,0,this._numPoints)}_ensureResources(e){if(g(this._technique)||P(yu))return;this._technique=new aD({rctx:e,viewingMode:this.view.state.viewingMode}),this._numPoints=yu.byteLength/J2;const t=new Float32Array(yu,0,2*this._numPoints),r=new Uint8Array(yu,2*this._numPoints*4,this._numPoints);this._vao=this._createVertexArrayObject(e,t,r,this._numPoints),this._updatingTracking.add(()=>this.view.environment.lighting.type!=="virtual"?this.view.environment.lighting.date:null,s=>this._update(s),Ji)}_computeDayDuration(e){const t=e,r=new Date(e.getFullYear(),0,1,11,58,56);return(+t-+r)/(+new Date(e.getFullYear()+1,0,1,11,58,55)-+r)}_update(e){if(!e)return;const t=(e.getHours()/12+e.getMinutes()/60*(2/24)+e.getSeconds()/60*(2/1440)-.9972222)%2,r=2*this._computeDayDuration(e),s=Kr(this._renderParameter.modelMatrix,H7);Bg(s,s,-r*Math.PI),pr(s,B7,s),Bg(s,s,-t*Math.PI),this.requestRender()}_hexToRGB(e){return[parseInt(e.substring(0,2),16),parseInt(e.substring(2,4),16),parseInt(e.substring(4,6),16)]}_unpackUint8Attributes(e){return e>=192?[2.9,e-192]:e>=160?[2.5,e-160]:e>=128?[2,e-128]:e>=96?[1.5,e-96]:e>=64?[1,e-64]:e>=32?[.7,e-32]:[.4,e]}_createVertexArrayObject(e,t,r,s){const a=eP.createBuffer(s),n=a.position,o=a.color,l=a.size;for(let c=0;c<s;c++){const h=t[2*c+0],u=t[2*c+1];n.set(c,0,-Math.cos(h)*Math.sin(u)),n.set(c,1,-Math.sin(h)*Math.sin(u)),n.set(c,2,-Math.cos(u));const p=this._unpackUint8Attributes(r[c]),m=this._hexToRGB(G7[p[1]]);o.set(c,0,255*m[0]),o.set(c,1,255*m[1]),o.set(c,2,255*m[2]),o.set(c,3,255),l.set(c,p[0])}return new ac(e,Lt,{geometry:Co(eP)},{geometry:gs.createVertex(e,ca.STATIC_DRAW,a.buffer)})}_createLoadDataTask(){if(g(yu))return null;const e=rT(async t=>{const{data:r}=await E4("esri/views/3d/environment/resources/stars.wsv",{responseType:"array-buffer",signal:t});this._verifyStarData(r),yu=r});return e.promise.catch(t=>{yo(t)||Pe.getLogger(this.declaredClass).error(t)}).then(()=>{this.destroyed||(this.requestRender(),this.notifyChange("updating"))}),e}_verifyStarData(e){if(!e)throw new bt("stars:no-data-received","Failed to create stars because star catalogue is missing");const t=e.byteLength/J2;if(t%1!=0||t>5e4||t<5e3)throw new bt("stars:invalid-data","Failed to create stars because star catalogue data is invalid")}};d([v({constructOnly:!0})],Uc.prototype,"view",void 0),d([v({constructOnly:!0})],Uc.prototype,"requestRender",void 0),d([v({readOnly:!0})],Uc.prototype,"updating",null),d([v()],Uc.prototype,"_loadDataTask",void 0),d([v()],Uc.prototype,"_updatingTracking",void 0),Uc=d([Y("esri.views.3d.environment.Stars")],Uc);const G7=["9bb2ff","9eb5ff","aabfff","bbccff","ccd8ff ","dae2ff","e4e9ff","eeefff","f8f6ff","fff9fb","fff5ef","fff1e5","ffeddb","ffe9d2","ffe6ca","ffe3c3","ffe0bb","ffddb4","ffdaad","ffd6a5","ffd29c","ffcc8f","ffc178","ffa94b","ff7b00"],B7=_3(1,0,0,0,0,.9174771405229186,.39778850739794974,0,0,-.39778850739794974,.9174771405229186,0,0,0,0,1),H7=_3(1,0,0,0,0,.9174771405229186,-.39778850739794974,0,0,.39778850739794974,.9174771405229186,0,0,0,0,1),J2=9,eP=mr().vec3f(w.POSITION).vec4u8(w.COLOR).f32(w.SIZE);let yu=null;function k7(i,e,t){const r=i.parallax.anchorPointClouds;i.fadeIn.stage===Oa.FINISHED&&(i.fadeIn.factor=0,H(r,Ko),i.fadeIn.stage=Oa.CHANGE_ANCHOR,i.crossFade.enabled=!1,i.fadeInOut.stage=yr.FINISHED),i.fadeIn.stage===Oa.CHANGE_ANCHOR&&i.isCameraPositionFinal&&(tC(i.data)&&i.renderingStage!==Ei.RENDERING||i.renderingStage===Ei.FADING_TEXTURE_CHANNELS)&&(H(r,Ko),i.fadeIn.stage=Oa.FADE_IN,i.startTime=e,i.renderingStage===Ei.FADING_TEXTURE_CHANNELS&&(i.renderingStage=Ei.SWITCH_CHANNELS)),i.fadeIn.factor<1&&i.fadeIn.stage===Oa.FADE_IN?i.fadeIn.factor=t?ee((e-i.startTime)/(oD*t),0,1):1:i.fadeIn.factor>=1&&i.fadeIn.stage===Oa.FADE_IN&&(i.fadeIn.stage=Oa.FINISHED,i.fadeIn.factor=1)}function j7(i,e,t){const{fadeInOut:r,crossFade:s}=i;r.stage===yr.FINISHED&&(i.startTime=e,r.factor=1,r.stage=yr.FADE_OUT),r.factor>0&&r.stage===yr.FADE_OUT?r.factor=t?1-ee((e-i.startTime)/(Z7*t),0,1):0:(r.factor<=0&&r.stage===yr.FADE_OUT&&(r.factor=0,H(i.parallax.anchorPointClouds,Ko)),r.factor<=0&&r.stage===yr.FADE_OUT&&i.isCameraPositionFinal&&(r.factor=0,r.stage=yr.SWITCH,i.crossFade.enabled=!1,s.factor=1),r.stage===yr.SWITCH&&(tC(i.data)&&i.renderingStage!==Ei.RENDERING||i.renderingStage===Ei.FADING_TEXTURE_CHANNELS)&&(i.startTime=e,r.factor=0,r.stage=yr.FADE_IN,H(i.parallax.anchorPointClouds,Ko),i.crossFade.enabled=!1,s.factor=1,i.renderingStage===Ei.FADING_TEXTURE_CHANNELS&&(i.renderingStage=Ei.SWITCH_CHANNELS)),r.factor<1&&r.stage===yr.FADE_IN?r.factor=t?ee((e-i.startTime)/(oD*t),0,1):1:r.factor>=1&&r.stage===yr.FADE_IN&&(r.stage=yr.FINISHED,r.factor=1))}function q7(i,e,t,r){const{crossFade:s}=i,a=i.parallax.anchorPointClouds;i.crossFade.enabled&&!r||(H(i.parallaxNew.anchorPointClouds,Ko),i.startTime=e,s.factor=0,i.crossFade.enabled=!0),s.factor<1&&i.crossFade.enabled?s.factor=t?ee((e-i.startTime)/(Y7*t),0,1):1:s.factor>=1&&i.crossFade.enabled&&(i.crossFade.enabled=!1,s.factor=1,H(a,i.parallaxNew.anchorPointClouds),i.renderingStage===Ei.FADING_TEXTURE_CHANNELS&&(i.renderingStage=Ei.SWITCH_CHANNELS))}function tP(i,e,t,r){const s=i.fadeInOutHeight,a=s.stage===yh.FINISHED?t:i.startTimeHeightFade;if(r!==0){const n=(t-a)/(K7*r);s.factor+=e?-n:n}else s.factor=e?0:1;i.startTimeHeightFade=t,s.factor=ee(s.factor,0,1),s.stage=yh.HEIGHT_FADE}function W7(i,e,t,r,s){i.renderingStage===Ei.FINISHED_RENDERING&&(i.renderingStage=Ei.FADING_TEXTURE_CHANNELS);const a=pe(e.eye);i.fadeInOutHeight.factor<0&&(i.fadeInOutHeight.factor=a-Ys.radius>Tn?1:0),i.isCameraPositionFinal=Ed(i.cameraPositionLastFrame,e.eye),W(Ko,e.eye),B(Ko,Ko,Ys.radius);const n=i.parallax;n.anchorPointClouds[0]===0&&n.anchorPointClouds[1]===0&&n.anchorPointClouds[2]===0&&H(n.anchorPointClouds,Ko);const o=pe(Q(Q7,n.anchorPointClouds,Ko));let l=!0;o>i.fadeIn.distanceThresholdFactor*n.cloudsHeight||i.fadeIn.stage!==Oa.FINISHED?k7(i,r,s):o>i.fadeInOut.distanceThresholdFactor*n.cloudsHeight||i.fadeInOut.stage!==yr.FINISHED?j7(i,r,s):o>i.crossFade.distanceThresholdFactor*n.cloudsHeight||i.crossFade.enabled||i.renderingStage===Ei.FADING_TEXTURE_CHANNELS?q7(i,r,s,(t!==ii.IDLE||!tC(i.data))&&i.renderingStage!==Ei.FADING_TEXTURE_CHANNELS):l=!1;const c=a-Ys.radius;if((c>1.7*Tn||c<-Tn)&&i.fadeInOutHeight.factor<1?i.fadeInOutHeight.factor=1:(c>Tn||c<-.35*Tn)&&i.fadeInOutHeight.factor<1?tP(i,!1,r,s):c<Tn&&c>-.35*Tn&&i.fadeInOutHeight.factor>0?tP(i,!0,r,s):i.fadeInOutHeight.stage=yh.FINISHED,i.renderingStage===Ei.SWITCH_CHANNELS&&(i.readChannels=1-i.readChannels,i.renderingStage=Ei.FINISHED),n.radiusCurvatureCorrectionFactor=.84*Math.sqrt(Math.max(a*a-Ys.radius*Ys.radius,0))/a,g2(iP,n.anchorPointClouds,vu),Mn(n.transform,ph,vu[3],f2(vu)),l){const{parallaxNew:h}=i;g2(iP,h.anchorPointClouds,vu),Mn(h.transform,ph,vu[3],f2(vu))}H(i.cameraPositionLastFrame,e.eye)}function X7(i){return i.crossFade.enabled||i.fadeInOut.stage!==yr.FINISHED||i.fadeIn.stage!==Oa.FINISHED||i.fadeInOutHeight.stage!==yh.FINISHED||i.renderingStage!==Ei.FINISHED}const iP=Ge(0,0,1),vu=P6(),Ko=T(),Q7=T(),oD=1,Z7=.5,Y7=1.3,K7=1;var Ii;function rP(i=vi("enable-feature:high-quality-idle")){const e=new Tv;return i&&(e.set(ii.INTERACTING,Ii.Antialiasing,!0),e.set(ii.IDLE,Ii.Antialiasing,!0),e.set(ii.INTERACTING,Ii.HighQualityTransparency,!0),e.set(ii.IDLE,Ii.HighQualityTransparency,!0),e.set(ii.INTERACTING,Ii.RealisticAtmosphere,!0),e.set(ii.IDLE,Ii.RealisticAtmosphere,!0),e.set(ii.IDLE,Ii.SSAO,!0),e.set(ii.IDLE,Ii.WaterReflection,!0),e.set(ii.IDLE,Ii.PhysicalPixelRendering,!0)),e.set(ii.ANIMATING,Ii.ShadowMapUpdate,!0),e.set(ii.INTERACTING,Ii.ShadowMapUpdate,!0),e.set(ii.IDLE,Ii.ShadowMapUpdate,!0),e.set(ii.IDLE,Ii.HighQualityVoxel,!0),e}(function(i){i[i.Antialiasing=0]="Antialiasing",i[i.HighQualityTransparency=1]="HighQualityTransparency",i[i.HighQualityVoxel=2]="HighQualityVoxel",i[i.RealisticAtmosphere=3]="RealisticAtmosphere",i[i.SSAO=4]="SSAO",i[i.WaterReflection=5]="WaterReflection",i[i.ShadowMapUpdate=6]="ShadowMapUpdate",i[i.PhysicalPixelRendering=7]="PhysicalPixelRendering"})(Ii||(Ii={}));var Rp;(function(i){i[i.Immediate=0]="Immediate",i[i.Faded=1]="Faded"})(Rp||(Rp={}));var og;const J7=[K.POSTPROCESSING_ENVIRONMENT_OPAQUE,K.POSTPROCESSING_ENVIRONMENT_TRANSPARENT];let Sr=og=class extends Ie{constructor(i){super(i),this._context=null,this._atmosphere=null,this._hqAtmosphere=null,this._oldWeatherParameters=new z1,this._newWeatherParameters=new z1,this._fadedWeatherParameters=new z1,this._weatherParameters=this._newWeatherParameters}initialize(){this.view._stage.addRenderPlugin(J7,this)}destroy(){var i;this.removeHandles(),((i=this.view)==null?void 0:i._stage)!=null&&this.view._stage.removeRenderPlugin(this),this._set("view",null)}get atmosphere(){return g(this._hqAtmosphere)&&this.view._stage.renderer.isFeatureEnabled(Ii.RealisticAtmosphere)?this._hqAtmosphere:this._atmosphere}get _atmosphereType(){return g(this.atmosphere)?this.atmosphere.type:fr.None}get canRender(){var i;return!!((i=this.view.basemapTerrain)!=null&&i.renderer.canRender)||this.view.viewingMode!=="global"}get needsLinearDepth(){return this._atmosphereType===fr.Realistic}updateAnimation(i){return!!g(this._precipitation)&&this._precipitation.update(i)}get updating(){return g(this._stars)&&this._stars.updating||g(this._clouds)&&this._clouds.running}get weatherVisible(){return pe(this.view.state.camera.eye)-Et(this.view.spatialReference).radius<=Tn}get _stars(){var r;const i=this.view,e=((r=i.environment)==null?void 0:r.starsEnabled)??!1,t=this._get("_stars");return!e||P(this._context)?(Te(t),null):g(t)?t:new Uc({view:i,requestRender:()=>this._setNeedsRender()})}get _precipitation(){const i=this._get("_precipitation");if(!this._precipitationEnabled||P(this._context))return Te(i),null;const e=this.view,t=this._context;return g(i)&&i.context===t?i:(Te(i),new ad({context:t,view:e}))}get _clouds(){const i=this._get("_clouds");if(!this.weatherEnabled||P(this._context))return Te(i),null;if(g(i))return i;const e=this.view,t=this._context;return Te(i),new Vs({context:t,view:e,requestRender:()=>this._setNeedsRender()})}get _cloudsComposition(){const i=this._get("_cloudsComposition");if(!this.weatherEnabled||P(this._context))return Te(i),null;const e=this.view.state.viewingMode,t=this._context.renderContext.rctx,r=Et(this.view.spatialReference).radius;return g(i)&&i.viewingMode===e&&i.planetRadius===r?i:(Te(i),new rd({rctx:t,viewingMode:e,planetRadius:r,requestRender:()=>this._setNeedsRender()}))}get _fog(){const i=this._get("_fog");if(!this.weatherEnabled||P(this._context))return Te(i),null;if(g(i))return i;const e=this.view,t=this._context;return new ag({context:t,view:e})}get _simpleHaze(){const i=this._get("_simpleHaze");if(!this.weatherEnabled||P(this._context))return Te(i),null;if(g(i))return i;const e=this.view,t=this._context;return new ng({context:t,view:e})}get weatherEnabled(){var i,e;return!!((e=(i=this.view)==null?void 0:i.environmentManager)!=null&&e.weatherEnabled)}get _precipitationEnabled(){return this.weatherEnabled&&(this.view.environment.weather.type==="rainy"||this.view.environment.weather.type==="snowy")}initializeRenderContext(i=null){this._context=i;const e=()=>this._setNeedsRender();this.addHandles([Rd(()=>{var t;return(t=this.view)==null?void 0:t.basemapTerrain},()=>this._updateBasemapTerrain(),Qi),te(()=>({viewingMode:this.view.state.viewingMode,enabled:this.view.environment.atmosphereEnabled,quality:this.view.environment.atmosphere.quality}),t=>this._updateAtmosphere(t),Qi),te(()=>this._stars,e),te(()=>this._precipitation,e),te(()=>this._clouds,()=>this._updateWeather(),Ji),te(()=>this._fog,()=>this._updateFogHaze(),Ji),te(()=>this._simpleHaze,()=>this._updateFogHaze(),Ji),te(()=>this.view.state.mode,()=>{this._setNeedsRender()},Bt),te(()=>this._atmosphereType,()=>this._updateBasemapTerrain(),Qi),te(()=>this._weatherUpdateParameters,()=>{this._updateWeather(),this._updateFogHaze()},Qi)])}uninitializeRenderContext(){this._context=null,this._atmosphere=Te(this._atmosphere),this._hqAtmosphere=Te(this._hqAtmosphere),this._set("_stars",Te(this._stars)),this._set("_precipitation",Te(this._precipitation)),this._set("_clouds",Te(this._clouds)),this._set("_cloudsComposition",Te(this._cloudsComposition)),this._set("_fog",Te(this._fog)),this._set("_simpleHaze",Te(this._simpleHaze))}prepareRender(i){i.bindParameters.cloudsFade.data=Tz(this._clouds)?this._clouds:null,this.view.viewingMode!=="local"&&(W7(i.bindParameters.cloudsFade,i.bindParameters.camera,this.view.state.mode,i.time,this.view.qualitySettings.fadeDuration),this._updateWeatherFading(i.bindParameters),i.bindParameters.cloudsFade.renderingStage===Ei.FINISHED&&g(this._clouds)&&this._clouds.coverage===0&&this._clouds.running===!1&&(this._clouds.destroyFrameBufferCube(),i.bindParameters.cloudsFade.data=null))}render(i){if(i.output===A.Color)switch(i.bindParameters.slot){case K.POSTPROCESSING_ENVIRONMENT_OPAQUE:g(this._stars)&&this._stars.render(i),g(this.atmosphere)&&(this.atmosphere.render(i),g(this._cloudsComposition)&&g(i.bindParameters.cloudsFade.data)&&(this.weatherVisible&&g(this._clouds)&&this._clouds.updateWeatherTile(),this._cloudsComposition.render(i)),X7(i.bindParameters.cloudsFade)&&g(this._context)&&this._context.requestRender());break;case K.POSTPROCESSING_ENVIRONMENT_TRANSPARENT:if(g(this.atmosphere)&&(this.atmosphere.renderHaze(i,this._weatherParameters.haze.amount),this._weatherParameters.haze.amount>0&&this._atmosphereType!==fr.Realistic&&g(this._simpleHaze)&&this._simpleHaze.render(i,this._weatherParameters.haze),this._weatherParameters.fog.amount>0&&g(this._fog)&&this._fog.render(i,this._weatherParameters.fog),g(this._precipitation))){const e=this.view.environment.weather;e.type!=="rainy"&&e.type!=="snowy"||this._precipitation.render(i,e.precipitation,e.type)}}}updateLightSources(i,e,t,r){if(g(this._context)){const s=this._context.renderContext;s.bindParameters.oldLighting.copyFrom(s.bindParameters.lighting),s.bindParameters.newLighting.noonFactor=e,s.bindParameters.newLighting.globalFactor=t,s.bindParameters.newLighting.set(i),r===Rp.Faded||s.bindParameters.weatherFading?s.bindParameters.fadeLighting(0):s.bindParameters.fadeLighting(1),this._context.requestRender()}}get _weatherUpdateParameters(){const i=this.weatherEnabled?this.view.environment.weather:null;return P(i)?null:i.type==="rainy"||i.type==="snowy"?{type:i.type,weatherAdjustment:i.cloudCover,effect:i.precipitation}:{type:i.type,weatherAdjustment:i.type==="foggy"?i.fogStrength:i.cloudCover}}_updateWeatherFading(i){if(!i.weatherFading)return;const e=i.cloudsFade;return e.fadeIn.stage===Oa.FADE_IN?(i.fadeLighting(e.fadeIn.factor),void this._fadeWeather(e.fadeIn.factor)):e.fadeInOut.stage===yr.FADE_IN?(i.fadeLighting(e.fadeInOut.factor),void this._fadeWeather(e.fadeInOut.factor)):e.crossFade.enabled?(i.fadeLighting(e.crossFade.factor),void this._fadeWeather(e.crossFade.factor)):(i.fadeLighting(0),void this._fadeWeather(0))}_fadeWeather(i){const{_newWeatherParameters:e,_oldWeatherParameters:t}=this;i>=1?this._weatherParameters=e:(this._fadedWeatherParameters.lerp(t,e,i),this._weatherParameters=this._fadedWeatherParameters)}_updateWeather(){const i=this._weatherUpdateParameters;P(i)||P(this._clouds)||(this._clouds.applyPreset(os[i.type],i.weatherAdjustment),this._setNeedsRender())}_setNeedsRender(){g(this._context)&&this._context.requestRender()}_updateFogHaze(){const i=this._weatherUpdateParameters;if(P(this._fog)||P(this._simpleHaze)||P(i)||P(this._context))return;const e=this._context.renderContext.bindParameters;switch(this._oldWeatherParameters.copyFrom(this._weatherParameters),i.type){case"foggy":this._newWeatherParameters.fog.strength=st(3e-5,.005,i.weatherAdjustment**3),H(this._newWeatherParameters.fog.color,sP),this._newWeatherParameters.fog.amount=1,this._newWeatherParameters.haze.strength=0,this._newWeatherParameters.haze.amount=this._atmosphereType===fr.Realistic?1:0,this._setNeedsRender();break;case"rainy":this._newWeatherParameters.fog.strength=st(4e-6,2e-4,(i.effect??0)**3),H(this._newWeatherParameters.fog.color,eU),this._newWeatherParameters.fog.amount=1,this._newWeatherParameters.haze.strength=0,this._newWeatherParameters.haze.amount=0,this._setNeedsRender();break;case"snowy":this._newWeatherParameters.fog.strength=st(4e-6,2e-4,(i.effect??0)**3),H(this._newWeatherParameters.fog.color,sP),this._newWeatherParameters.fog.amount=1,this._newWeatherParameters.haze.strength=0,this._newWeatherParameters.haze.amount=this._atmosphereType===fr.Realistic?1:0,this._setNeedsRender();break;default:this._newWeatherParameters.fog.strength=0,this._newWeatherParameters.fog.amount=0,this._newWeatherParameters.haze.strength=4e-6,this._newWeatherParameters.haze.amount=1,this._setNeedsRender()}e.weatherFading?this._fadeWeather(0):this._fadeWeather(1)}_updateAtmosphere(i){const e=this._selectAtmosphereType(i);if(g(this._atmosphere)?this._atmosphere.type===e:e===fr.None)return;this._atmosphere=Te(this._atmosphere),this._hqAtmosphere=Te(this._hqAtmosphere);const t=this._getAtmosphereClass(e);t&&g(this._context)&&(this._atmosphere=new t(this.view,this._context),e===fr.Simple&&(this._hqAtmosphere=new R1(this.view,this._context))),this._setNeedsRender(),this._updateBasemapTerrain()}_getAtmosphereClass(i){switch(i){case fr.Realistic:return R1;case fr.Panoramic:return _7;case fr.Simple:return M7;default:case fr.None:return null}}_selectAtmosphereType(i){const{enabled:e,quality:t,viewingMode:r}=i;return!e||zf(this.view.spatialReference)?fr.None:r===ve.Local?fr.Panoramic:g(this._context)&&t==="high"&&R1.isSupported(this._context)&&ny(this.view.spatialReference)?fr.Realistic:fr.Simple}_updateBasemapTerrain(){this.view.basemapTerrain&&(this.view.basemapTerrain.velvetOverground=this._atmosphereType===fr.Simple)}get test(){return{atmosphere:this._atmosphere,clouds:this._clouds,selectAtmosphereType:()=>this._selectAtmosphereType({viewingMode:this.view.state.viewingMode,enabled:this.view.environment.atmosphereEnabled,quality:this.view.environment.atmosphere.quality}),stubGetAtmosphereClass:i=>{aP=og.prototype._getAtmosphereClass,og.prototype._getAtmosphereClass=i},restoreGetAtmosphereClass:()=>{og.prototype._getAtmosphereClass=aP}}}};d([v({constructOnly:!0})],Sr.prototype,"view",void 0),d([v({readOnly:!0})],Sr.prototype,"atmosphere",null),d([v({readOnly:!0})],Sr.prototype,"_atmosphereType",null),d([v({type:Boolean,readOnly:!0})],Sr.prototype,"updating",null),d([v({readOnly:!0})],Sr.prototype,"weatherVisible",null),d([v()],Sr.prototype,"_context",void 0),d([v()],Sr.prototype,"_atmosphere",void 0),d([v()],Sr.prototype,"_hqAtmosphere",void 0),d([v({readOnly:!0})],Sr.prototype,"_stars",null),d([v({readOnly:!0})],Sr.prototype,"_precipitation",null),d([v({readOnly:!0})],Sr.prototype,"_clouds",null),d([v({readOnly:!0})],Sr.prototype,"_cloudsComposition",null),d([v({readOnly:!0})],Sr.prototype,"_fog",null),d([v({readOnly:!0})],Sr.prototype,"_simpleHaze",null),d([v({readOnly:!0})],Sr.prototype,"weatherEnabled",null),d([v({readOnly:!0})],Sr.prototype,"_precipitationEnabled",null),d([v({readOnly:!0})],Sr.prototype,"_weatherUpdateParameters",null),Sr=og=d([Y("esri.views.3d.environment.EnvironmentRenderer")],Sr);let z1=class{constructor(){this.fog=new Kz,this.haze=new $7}copyFrom(e){this.fog.amount=e.fog.amount,this.haze.amount=e.haze.amount,this.fog.strength=e.fog.strength,this.haze.strength=e.haze.strength,H(this.fog.color,e.fog.color)}lerp(e,t,r){this.fog.amount=st(e.fog.amount,t.fog.amount,r),this.haze.amount=st(e.haze.amount,t.haze.amount,r),this.fog.strength=st(e.fog.strength,t.fog.strength,r),this.haze.strength=st(e.haze.strength,t.haze.strength,r),Gr(this.fog.color,e.fog.color,t.fog.color,r)}};const eU=Ge(.5,.5,.5),sP=Ge(1.5,1.5,1.5);let aP;function nP(i,e,t){if(P(e.longitude)||P(e.latitude)||P(t.longitude)||P(t.latitude))throw new Error("Invalid points: no lon/lat");return tU(i,e.longitude,e.latitude,t.longitude,t.latitude)}function tU(i,e,t,r,s){const a=ut(t),n=ut(s),o=a-n,l=ut(e)-ut(r),c=Math.sin(o/2),h=Math.sin(l/2),u=2*ul(Math.sqrt(c*c+Math.cos(a)*Math.cos(n)*h*h))*i;return Math.round(1e4*u)/1e4}function iU(i,e,t){const r=e.spatialReference,s=Et(r),a=new Ht(e.x,i.y,r),n=new Ht(t.x,i.y,r),o=new Ht(i.x,e.y,r),l=new Ht(i.x,t.y,r);return{lon:nP(s.radius,a,n),lat:nP(s.radius,o,l)}}function rU(i,e,t){const r=e/t,s=ut(i),a=Math.sin(r/2),n=Math.cos(s),o=2*ul(Math.sqrt(a*a/(n*n)));return ln(o)}function sU(i,e){let t=i/15;return e||(t=Math.round(t)),t}function oP(i,e){const t=i==null?void 0:i[0];if(t==null)return null;e||(e={hours:0,minutes:0,seconds:0}),e.hours=sU(t,!0);const r=e.hours%1;e.hours-=r,e.minutes=60*r;const s=e.minutes%1;return e.minutes-=s,e.seconds=Math.round(60*s),e}var lP,cP,hP,iw={},aU={get exports(){return iw},set exports(i){iw=i}};lP=aU,cP=function(){var i=Math.PI,e=Math.sin,t=Math.cos,r=Math.tan,s=Math.asin,a=Math.atan2,n=Math.acos,o=i/180,l=864e5,c=2440588,h=2451545,u={dec:0,ra:0};function p(U){return U.valueOf()/l-.5+c}function m(U){return new Date((U+.5-c)*l)}function f(U){return p(U)-h}var y=23.4397*o;function b(U,V){return a(e(U)*t(y)-r(V)*e(y),t(U))}function x(U,V){return s(e(V)*t(y)+t(V)*e(y)*e(U))}function S(U,V,z){return a(e(U),t(U)*e(V)-r(z)*t(V))}function C(U,V,z){return s(e(V)*e(z)+t(V)*t(z)*t(U))}function O(U,V){return o*(280.16+360.9856235*U)-V}function R(U){return o*(357.5291+.98560028*U)}function E(U){return o*(1.9148*e(U)+.02*e(2*U)+3e-4*e(3*U))}function $(U,V){return U+V+102.9372*o+i}function M(U,V){var z=R(U),ie=$(z,E(z));return V||(V={dec:0,ra:0}),V.dec=x(ie,0),V.ra=b(ie,0),V}var L={PolarException:{NORMAL:0,MIDNIGHT_SUN:1,POLAR_NIGHT:2},getPosition:function(U,V,z,ie){var re=o*-z,he=o*V,oe=f(U),Re=M(oe,u),ne=O(oe,re)-Re.ra;return ie||(ie={azimuth:0,altitude:0}),ie.azimuth=S(ne,he,Re.dec),ie.altitude=C(ne,he,Re.dec),ie}},F=[[-.83,"sunrise","sunset"]];L.addTime=function(U,V,z){F.push([U,V,z])};var N=9e-4;function G(U,V){return Math.round(U-N-V/(2*i))}function q(U,V,z){return N+(U+V)/(2*i)+z}function se(U,V,z){return h+U+.0053*e(V)-.0069*e(2*z)}function k(U,V,z){return n((e(U)-e(V)*e(z))/(t(V)*t(z)))}function I(U){var V=o*(134.963+13.064993*U),z=o*(93.272+13.22935*U),ie=o*(218.316+13.176396*U)+6.289*o*e(V),re=5.128*o*e(z),he=385001-20905*t(V);return{ra:b(ie,re),dec:x(ie,re),dist:he}}return L.getTimes=function(U,V,z){var ie=o*-z,re=o*V,he=G(f(U),ie),oe=q(0,ie,he),Re=R(oe),ne=E(Re),me=$(Re,ne),ge=x(me,0),Ue=se(oe,Re,me);function Ee(tt){return se(q(k(tt,re,ge),ie,he),Re,me)}function Ae(tt){var Ke=(e(tt)-e(re)*e(ge))/(t(re)*t(ge));return Ke<-1?L.PolarException.MIDNIGHT_SUN:Ke>1?L.PolarException.POLAR_NIGHT:L.PolarException.NORMAL}var Ze,de,Ne,ye,He,Ye={solarNoon:m(Ue),nadir:m(Ue-.5),polarException:L.PolarException.NORMAL};for(Ze=0,de=F.length;Ze<de;Ze+=1)He=Ue-((ye=Ee((Ne=F[Ze])[0]*o))-Ue),Ye[Ne[1]]=m(He),Ye[Ne[2]]=m(ye);return Ye.polarException=Ae(F[0][0]*o),Ye},L.getMoonPosition=function(U,V,z){var ie=o*-z,re=o*V,he=f(U),oe=I(he),Re=O(he,ie)-oe.ra,ne=C(Re,re,oe.dec);return ne+=.017*o/r(ne+10.26*o/(ne+5.1*o)),{azimuth:S(Re,re,oe.dec),altitude:ne,distance:oe.dist}},L.getMoonFraction=function(U){var V=f(U),z=M(V),ie=I(V),re=149598e3,he=n(e(z.dec)*e(ie.dec)+t(z.dec)*t(ie.dec)*t(z.ra-ie.ra)),oe=a(re*e(he),ie.dist-re*t(he));return(1+t(oe))/2},L},(hP=cP())!==void 0&&(lP.exports=hP);const Ld=iw,Wo={local:{altitude:1500,ambientAtNight:.1,ambientAtNoon:.45,ambientAtTwilight:.2,directAtNoon:.65,directAtTwilight:.7},global:{altitude:8e5,ambient:.015,direct:.75},planarDirection:{localAltitude:1e4,globalAltitude:1e6,globalAngles:{azimuth:1.3*Math.PI,altitude:.6*Math.PI}}};function nU(i,e,t,r,s,a){j(a.ambient.color,1,1,1),a.ambient.intensity=Wo.global.ambient,j(a.direct.color,1,1,1),a.direct.intensity=Wo.global.direct;const n=e[2],o=ee((Math.abs(n)-Wo.local.altitude)/(Wo.global.altitude-Wo.local.altitude),0,1);let l;if(a.globalFactor=o,g(i)&&(l=Ld.getTimes(i,e[1],e[0])),o<1){let c;if(g(i))c=pU(i,l,r);else{const h=hD(r);c={direct:{intensity:Wo.local.directAtNoon*h.direct,color:Ge(1,1,1)},ambient:{intensity:Wo.local.ambientAtNoon*h.ambient,color:Ge(1,1,1)},timeOfDay:"early afternoon"}}Gr(a.ambient.color,c.ambient.color,a.ambient.color,o),a.ambient.intensity=st(c.ambient.intensity,a.ambient.intensity,o),Gr(a.direct.color,c.direct.color,a.direct.color,o),a.direct.intensity=st(c.direct.intensity,a.direct.intensity,o),a.specularStrength=r==="rainy"||r==="snowy"||r==="foggy"?0:1,a.environmentStrength=r==="rainy"?.7:r==="snowy"||r==="foggy"?.75:1}a.noonFactor=g(i)?uU(i,l):1,g(i)?oU(i,e,t,a.direct.directionToLightSource):lD(s,t,a.direct.directionToLightSource)}function lD(i,e,t){e===ve.Global?W(U1,i.eye):j(U1,0,0,1),B(V1,i.viewForward,-1);const r=D0(V1,U1),s=Math.max(r-2*G1,0),a=.85*s/(s+1),n=Math.max(G1,r-G1-a);go(uP,-n,i.viewRight),xe(t,V1,uP),X(t,t,B(mU,i.viewRight,gU)),W(t,t)}function oU(i,e,t,r){const s=dU,a=Ad(hU);if(t===ve.Global)Ld.getPosition(i,0,0,s),j(r,0,0,-1),Hg(a,a,-s.azimuth),nT(a,a,-s.altitude),xe(r,r,a);else{const n=Wo.planarDirection,o=n.globalAngles,l=e[2];let c=(Math.abs(l)-n.localAltitude)/(n.globalAltitude-n.localAltitude);c=ee(c,0,1),c<1?(Ld.getPosition(i,e[1],e[0],s),s.azimuth=(1-c)*s.azimuth+c*o.azimuth,s.altitude=(1-c)*s.altitude+c*o.altitude):(s.azimuth=o.azimuth,s.altitude=o.altitude),j(r,0,-1,0),Bg(a,a,-s.azimuth),Hg(a,a,-s.altitude),xe(r,r,a)}}function lU(i,e){if(e===ve.Global)return!0;const t=Wo.planarDirection;return Math.abs(i)<t.localAltitude}const cU=Ge(.5773502691896258,-.5773502691896258,.5773502691896258);let cD=class{constructor(){this.ambient={color:Ge(1,1,1),intensity:.55},this.direct={color:Ge(1,1,1),intensity:.55,directionToLightSource:aa(cU)},this.noonFactor=.5,this.globalFactor=0,this.specularStrength=1,this.environmentStrength=1}};const hU=ce(),dU={azimuth:0,altitude:0};function uU(i,e){const t=i.valueOf();let r,s;e.polarException===Ld.PolarException.MIDNIGHT_SUN?(r=t-60*(i.getHours()+48)*60*1e3-60*i.getMinutes()*1e3,s=r+432e6):e.polarException===Ld.PolarException.POLAR_NIGHT?(r=t-2,s=t-1):(r=e.sunrise.valueOf(),s=e.sunset.valueOf());const a=r+(s-r)/2;return 1-ee(Math.abs(t-a)/432e5,0,1)}function hD(i){switch(i){case"disabled":case"sunny":case"cloudy":return{direct:1,ambient:1};case"rainy":return{direct:.4,ambient:1.2};case"snowy":return{direct:.5,ambient:1.3};case"foggy":return{direct:.2,ambient:1.6}}}function dP(i,e){const t=(i[0]+i[1]+i[2])/3;for(let r=0;r<3;r++)i[r]=i[r]+(t-i[r])*e;return i}function pU(i,e,t){const r=i.valueOf();let s,a;e.polarException===Ld.PolarException.MIDNIGHT_SUN?(s=r-60*(i.getHours()+48)*60*1e3-60*i.getMinutes()*1e3,a=s+432e6):e.polarException===Ld.PolarException.POLAR_NIGHT?(s=r-2,a=r-1):(s=e.sunrise.valueOf(),a=e.sunset.valueOf());const n=a-s,o=s+n/2,l=n/4,c=o-l,h=o+l,u=.06*n,p=s-u/2,m=s+u/2,f=a-u/2,y=a+u/2,b=Wo.local,x=[.01,b.ambientAtNight],S=[.8,.8,1],C=[.01,.01,.01],O=[b.directAtTwilight,b.ambientAtTwilight],R=[1,.6,.5],E=[.8,.8,1],$=[.9*b.directAtNoon,b.ambientAtNoon],M=[1,.98,.98],L=[.98,.98,1],F=[b.directAtNoon,b.ambientAtNoon],N=[1,1,1],G=[1,1,1],q=$,se=M,k=L,I=O,U=R,V=E;let z,ie,re=[0,0],he=[0,0,0],oe=[0,0,0];r<p||r>y?(re=x,he=C,oe=S,ie="night"):r<m?(z=m-p,re=kr(r-p,z,x,O),he=kr(r-p,z,C,R),oe=kr(r-p,z,S,E),ie="sun rising"):r<c?(z=c-m,re=kr(r-m,z,O,$),he=kr(r-m,z,R,M),oe=kr(r-m,z,E,L),ie="early morning"):r<o?(z=o-c,re=kr(r-c,z,$,F),he=kr(r-c,z,M,N),oe=kr(r-c,z,L,G),ie="late morning"):r<h?(z=h-o,re=kr(r-o,z,F,q),he=kr(r-o,z,N,se),oe=kr(r-o,z,G,k),ie="early afternoon"):r<f?(z=f-h,re=kr(r-h,z,q,I),he=kr(r-h,z,se,U),oe=kr(r-h,z,k,V),ie="late afternoon"):r<y&&(z=y-f,re=kr(r-f,z,I,x),he=kr(r-f,z,U,C),oe=kr(r-f,z,V,S),ie="sun setting");let Re=0;switch(t){case"rainy":case"foggy":case"snowy":Re=.5}Re>0&&(he=dP(he,Re),oe=dP(oe,Re));const ne=Ge(he[0],he[1],he[2]),me=Ge(oe[0],oe[1],oe[2]),ge=hD(t);return{direct:{intensity:re[0]*ge.direct,color:ne},ambient:{intensity:re[1]*ge.ambient,color:me},timeOfDay:ie}}function kr(i,e,t,r){const s=[];for(let a=0;a<t.length;a++)s[a]=(r[a]-t[a])*i/e+t[a];return s}const uP=ce(),U1=T(),V1=T(),mU=T(),G1=.25,gU=.2;let Xn=class extends Ms.EventedAccessor{constructor(){super(),this._referencePointUpdateDelay=200,this._referencePointUpdateInterval=3e3,this._referencePointUpdateDistThreshold=1e6,this._referencePosUpdateQuery=null,this._referencePosMapCoordsRequested=null,this._viewHandles=new Vi,this._preserveAbsoluteDateTime=!1,this._trackingEnabled=!1,this._referencePosResetPreserveAbsoluteTime=!1,this._referencePosUpdateTimer=null,this._referencePosMapCoords=null,this._mainLight=new dF,this._ambientLight=new O3,this._moonLight=new uF,this.disableQueries=!1,this._disableWeather=!1,this._renderer=null,this._referencePosWGS84Comparable=null,this._resetReferencePosition()}destroy(){this.disconnectView(),this._viewHandles.destroy()}get _view(){var e;return(e=this._renderer)==null?void 0:e.view}get updating(){var e;return!((this.disableQueries||!this._referencePosUpdateQuery&&!this._referencePosMapCoordsRequested)&&!((e=this._renderer)!=null&&e.updating))}get weatherEnabled(){var e,t,r;return((e=this._view)==null?void 0:e.environment.atmosphereEnabled)&&!this._disableWeather&&((r=(t=this._view)==null?void 0:t.state)==null?void 0:r.viewingMode)===ve.Global&&ny(this._view.spatialReference)}get weatherVisible(){var e;return this.weatherEnabled&&((e=this._renderer)==null?void 0:e.weatherVisible)}get referencePositionWGS84Comparable(){return this._referencePosWGS84Comparable}connectView(e){if(this._renderer)return;this._renderer=new Sr({view:e});const t=()=>this._updateRenderParameters(),r=()=>this._cameraHandler();this._viewHandles.add([te(()=>e.environment.lighting,s=>this._updateLightingHandler(s),Bt),te(()=>e.environment.lighting.type!=="virtual"?e.environment.lighting.date:null,s=>this._lightingDateHandler(s),Bt),te(()=>e.stationary,()=>this._interactingStationaryHandler()),te(()=>e.environment.lighting.directShadowsEnabled,t,Bt),te(()=>e.environment.lighting.ambientOcclusionEnabled,t,Bt),te(()=>e.environment.lighting.waterReflectionEnabled,t,Bt),te(()=>{var s;return(s=e.environment.background)==null?void 0:s.color},t,Bt),te(()=>e.spatialReference,()=>this._resetReferencePosition(!0),Bt),te(()=>e.environment.weather.type,()=>this._updateLighting(null,Rp.Faded),Bt),te(()=>this.weatherEnabled,()=>this._updateLighting(null,Rp.Faded),Bt),te(()=>e.viewingMode,()=>this._resetReferencePosition(!0),Qi),te(()=>e.environment.lighting.type!=="virtual"&&e.environment.lighting.cameraTrackingEnabled,s=>this._updateCameraTracking(s),Qi),te(()=>e.state.camera,r,Qi),te(()=>this.disableQueries,r)]),this._updateRenderParameters(),this._updateLighting(),this._cameraHandler(),this.notifyChange("updating")}disconnectView(){this._viewHandles.removeAll(),this._resetReferencePosition(),this._renderer=Te(this._renderer)}_updateLightingHandler(e){this._updateCameraTracking(e.type!=="virtual"&&e.cameraTrackingEnabled),this._lightingDateHandler(e.type!=="virtual"?e.date:null),this._updateRenderParameters()}_updateCameraTracking(e){if(this._trackingEnabled=e,e)this._cameraHandler();else{const t=this._view.environment.lighting;(t==null?void 0:t.type)!=="virtual"&&(t.positionTimezoneInfo.autoUpdated=!1)}}_lightingDateHandler(e){const t=this._view.environment.lighting;if((t==null?void 0:t.type)!=="virtual"){if(e){if(!t.positionTimezoneInfo.autoUpdated){this._preserveAbsoluteDateTime=!0;const r=this._view.spatialReference;if(!Pd(r)){const s=this._view.camera.position;if(!this._referencePosMapCoords||!this._referencePosMapCoords.equals(s))return void this._requestReferencePositionUpdate(s)}if(this._preupdateTracking(e),g(this._referencePosWGS84Comparable)){const s=oP(this._referencePosWGS84Comparable,pP);g(s)&&(t.autoUpdate(null,s),this._trackingEnabled&&(t.positionTimezoneInfo.autoUpdated=!0))}}this._updateLighting(e)}}else this._updateLighting()}_preupdateTracking(e){!this._trackingEnabled&&this._view.environment.lighting.type!=="virtual"&&this._view.environment.lighting.cameraTrackingEnabled&&this._cameraHandler(e)}_cameraHandler(e=null){const t=this._view;if(!t.ready)return;const r=t.stateManager.camera;r&&(this._cameraHandlerClientSide(r,e)||this._cameraHandlerServerSide(r))}_cameraHandlerClientSide(e,t){const r=ny(this._view.spatialReference);if(r&&!Pd(this._view.spatialReference))return this._view.environment.lighting.type==="virtual"&&this._updateLighting(),!1;const s=e.position;return P(this._referencePosWGS84Comparable)&&(this._referencePosWGS84Comparable=T()),r?A4(s,this._referencePosWGS84Comparable):j(this._referencePosWGS84Comparable,s.longitude??0,s.latitude??0,s.z??0),this.notifyChange("referencePositionWGS84Comparable"),this._autoUpdateTimezone(this._referencePosWGS84Comparable,t)||this._updateLighting(t),!0}_cameraHandlerServerSide(e){const t=e.position;(!this._referencePosMapCoords||this._referencePosMapCoordsRequested||this._exceedsReferencePosDistThreshold(t))&&this._requestReferencePositionUpdate(t,!0),this._view.mapCoordsHelper&&this._referencePosWGS84Comparable&&(this._referencePosWGS84Comparable[2]=(t.z??0)*this._view.mapCoordsHelper.unitInMeters,this._referencePosChanged())}_interactingStationaryHandler(){this._view.stationary&&this._executePendingReferencePositionUpdate()}_updateLighting(e,t=Rp.Immediate){const r=this._view;e=e||(r.environment.lighting.type==="virtual"?null:r.environment.lighting.date);const s=this._referencePosWGS84Comparable,a=g(s)?fU:_U,n=this.weatherVisible?r.environment.weather.type:"disabled";g(s)?nU(e,s,r.state.viewingMode,n,r.state.camera,a):r.environment.lighting.type==="virtual"&&lD(r.state.camera,r.state.viewingMode,a.direct.directionToLightSource);const o=this._mainLight,l=a.direct;B(o.intensity,l.color,l.intensity*Math.PI),H(o.direction,l.directionToLightSource),o.specularStrength=a.specularStrength,o.environmentStrength=a.environmentStrength;const c=this._ambientLight;B(c.intensity,a.ambient.color,a.ambient.intensity);const h=this._moonLight;Gr(h.intensity,vU,bU,a.globalFactor);const u=(1-.5*a.globalFactor)*(1-.4*a.noonFactor*(1-a.globalFactor));B(h.intensity,h.intensity,u),H(h.direction,l.directionToLightSource),this._renderer.updateLightSources([o,c,h],a.noonFactor,a.globalFactor,t),this._updateRenderParameters()}_autoUpdateTimezone(e,t=null){if(this._view.environment.lighting.type==="virtual"||!this._view.environment.lighting.cameraTrackingEnabled||P(e))return!1;const r=yU;r.setTime((t||this._view.environment.lighting.date).getTime());const s=oP(e,pP);if(P(s))return!1;let a=this._view.environment.lighting.positionTimezoneInfo;if(a.autoUpdated){if(a.hours===s.hours&&a.minutes===s.minutes&&a.seconds===s.seconds)return!1}else a=s;const n=r.getUTCHours()-(s.hours-a.hours),o=r.getUTCMinutes()-(s.minutes-a.minutes),l=r.getUTCSeconds()-(s.seconds-a.seconds);return r.setUTCHours(n),r.setUTCMinutes(o),r.setUTCSeconds(l),!t&&this._view.environment.lighting.autoUpdate(r,s)}_updateRenderParameters(){const e=this._view._stage;if(!e)return;const t=Vc(this._referencePosWGS84Comparable,!0,a=>lU(a[2],this._view.state.viewingMode)),r=this._view.environment.background,s=r instanceof IM?{type:"color",color:M4(ui.toUnitRGBA(r.color))}:{type:"color",color:hi(0,0,0,1)};e.renderer.setParameters({shadowMap:this._view.environment.lighting.directShadowsEnabled&&t,background:s,environment:this._view.environment,weatherVisible:this._view.environmentManager.weatherVisible})}_resetReferencePosition(e=!1){this._cancelReferencePosUpdates(),this._referencePosMapCoords=null,this._referencePosMapCoordsRequested=null,this._referencePosResetPreserveAbsoluteTime=null,this._referencePosWGS84Comparable=null,this.notifyChange("updating"),e&&this._cameraHandler()}_requestReferencePositionUpdate(e,t=!1){if(!this.disableQueries&&(this._referencePosMapCoordsRequested?this._referencePosMapCoordsRequested.copy(e):this._referencePosMapCoordsRequested=e.clone(),this._referencePosResetPreserveAbsoluteTime=!!t,!this._referencePosUpdateQuery&&!this._referencePosUpdateTimer&&this._view.stationary)){const r=this._referencePosUpdateQuery=FS(this._referencePointUpdateDelay).then(()=>{if(this._referencePosUpdateQuery===r){const a=()=>this._referencePosUpdateQuery!==r;return this._doReferencePositionUpdateQuery(a)}}).catch(a=>{a.name==="mapcoordshelper:missing-geometry-service"&&(this.disableQueries=!0)}).then(()=>{this._referencePosUpdateQuery===r&&(this._referencePosUpdateQuery=null,this._referencePosUpdateTimer||this._executePendingReferencePositionUpdate(),this.notifyChange("updating"))}),s=this._referencePosUpdateTimer=FS(this._referencePointUpdateInterval).then(()=>{this._referencePosUpdateTimer===s&&(this._referencePosUpdateTimer=null,this._referencePosUpdateQuery||this._executePendingReferencePositionUpdate())});this.notifyChange("updating")}}async _doReferencePositionUpdateQuery(e){this._referencePosResetPreserveAbsoluteTime&&(this._preserveAbsoluteDateTime=!1),this._referencePosMapCoords?this._referencePosMapCoords.copy(this._referencePosMapCoordsRequested):this._referencePosMapCoords=this._referencePosMapCoordsRequested.clone(),this._referencePosResetPreserveAbsoluteTime=null,this._referencePosMapCoordsRequested=null;const t=await this._view.mapCoordsHelper.toGeographic(this._referencePosMapCoords);if(!e()&&!isNaN(t[0])&&!isNaN(t[1])){const r=(this._referencePosMapCoords.z??0)*this._view.mapCoordsHelper.unitInMeters;this._referencePosWGS84Comparable?(this._referencePosWGS84Comparable[0]=t[0],this._referencePosWGS84Comparable[1]=t[1],this._referencePosWGS84Comparable[2]=r):this._referencePosWGS84Comparable=[t[0],t[1],r],this._referencePosChanged()}}_executePendingReferencePositionUpdate(){const e=this._referencePosMapCoordsRequested;e&&this._requestReferencePositionUpdate(e,this._referencePosResetPreserveAbsoluteTime)}_referencePosChanged(){this._preserveAbsoluteDateTime?this._updateLighting():this._autoUpdateTimezone(this._referencePosWGS84Comparable)||this._updateLighting(),this.notifyChange("referencePositionWGS84Comparable")}_exceedsReferencePosDistThreshold(e){if(this._referencePosMapCoords){let t=this._referencePosMapCoords.distance(e);return this._view.mapCoordsHelper&&(t*=this._view.mapCoordsHelper.unitInMeters),t>this._referencePointUpdateDistThreshold}return!0}_cancelReferencePosUpdates(){const e=!!this._referencePosUpdateQuery;return this._referencePosUpdateQuery=null,this._referencePosUpdateTimer=null,e}get test(){const e=this;return{get renderer(){return e._renderer},set referencePointUpdateInterval(t){e._referencePointUpdateInterval=t},set referencePointUpdateDistThreshold(t){e._referencePointUpdateDistThreshold=t},set referencePosUpdateTimer(t){e._referencePosUpdateTimer=t},set referencePointUpdateDelay(t){e._referencePointUpdateDelay=t},set disableWeather(t){e._disableWeather=t}}}};d([v({type:Boolean,readOnly:!0})],Xn.prototype,"updating",null),d([v()],Xn.prototype,"disableQueries",void 0),d([v()],Xn.prototype,"_disableWeather",void 0),d([v()],Xn.prototype,"weatherEnabled",null),d([v()],Xn.prototype,"weatherVisible",null),d([v()],Xn.prototype,"referencePositionWGS84Comparable",null),d([v()],Xn.prototype,"_renderer",void 0),d([v()],Xn.prototype,"_referencePosWGS84Comparable",void 0),Xn=d([Y("esri.views.3d.environment.SceneViewEnvironmentManager")],Xn);const fU=new cD,_U=new cD,yU=new Date,pP={hours:0,minutes:0,seconds:0},vU=Ge(.22,.22,.33),bU=Ge(.22,.22,.22);var Xt;(function(i){i[i.NONE=0]="NONE",i[i.TILT=1]="TILT",i[i.ALTITUDE=2]="ALTITUDE",i[i.DISTANCE=4]="DISTANCE",i[i.COLLISION=8]="COLLISION",i[i.ALL=15]="ALL",i[i.ALL_EXCEPT_COLLISION=7]="ALL_EXCEPT_COLLISION"})(Xt||(Xt={}));var et;(function(i){i[i.NONE=0]="NONE",i[i.ZOOM=1]="ZOOM",i[i.TUMBLE=2]="TUMBLE",i[i.LOOK_AROUND=3]="LOOK_AROUND",i[i.PAN=4]="PAN",i[i.ASCEND=5]="ASCEND"})(et||(et={}));var Er;(function(i){i[i.TUMBLE=0]="TUMBLE",i[i.LOOK_AROUND=1]="LOOK_AROUND"})(Er||(Er={}));function pf(i,e){return(i&e)!=0}function Ty(i,e,t,r,s,a){i!==0&&(t?(a.min=Math.min(a.min,e),a.max=Math.max(a.max,e)):r!=null?(a.min-=Math.max(0,(e-a.min)*(1-r)),a.max+=Math.max(0,(e-a.max)*(1-r))):s&&(a.min-=Math.max(0,e-a.min-s),a.max+=Math.max(0,e-a.max-s)))}const vh={selection:Xt.NONE,interactionType:et.NONE,interactionFactor:0,interactionStartCamera:null,interactionDirection:null,tiltMode:Er.TUMBLE};function dD(i,e,t,r){return e=e||i.viewForward,H(r,e),B(r,r,Math.sign(J(e,t))),r}function xU(i,e,t,r){return PU(i,e,t,CU(r,e,t,!0))}function wU(i,e,t,r){const s=J(t,Q(i,r,e));return X(i,e,B(i,t,s))}const TU={dir:T(),len:0,clip:$e()};function CU(i,e,t,r){const s=TU;return i?(t&&r&&(s.len=yi(e,t)),H(s.dir,i)):r?(s.len=yi(e,t),Q(s.dir,t,e),B(s.dir,s.dir,1/s.len)):(Q(s.dir,t,e),W(s.dir,s.dir)),s}function SU(i,e,t){const r=J(As(i),t.dir),s=-Ri(i,e);if(s<0&&r>=0)return!1;if(r>-1e-6&&r<1e-6)return s>0;if((s<0||r<0)&&!(s<0&&r<0))return!0;const a=s/r;return r>0?a<t.clip[1]&&(t.clip[1]=a):a>t.clip[0]&&(t.clip[0]=a),t.clip[0]<=t.clip[1]}function PU(i,e,t,r){r.clip[0]=0,r.clip[1]=t?r.len:Number.MAX_VALUE;for(let s=0;s<i.length;s++)if(!SU(i[s],e,r))return!1;return!0}function OU(i,e,t=vh){const r=oC(i,e,t);if(r===0)return!1;const s=i.renderCoordsHelper,a=s.getAltitude(e.eye)+r,n=dD(e,t.interactionDirection,AU(i,e,Math.sign(r),LU),IU),o=H($U,e.viewForward),l=s.intersectInfiniteManifold(xo(e.eye,n),a,B1);return e.eye=g(l)?l:s.setAltitude(B1,a,e.eye),e.center=wU(B1,e.eye,o,e.center),!0}function oC(i,e,t=vh){if(!RU(i,t)||!i.state.constraints.altitude)return 0;const r=MU(i.state.constraints.altitude,DU);EU(i,t,r);const s=i.renderCoordsHelper.getAltitude(e.eye),a=ee(s,r.min,r.max)-s;return Math.abs(a)<=1e-6?0:a}function RU(i,e){const t=i.state.constraints.altitude;return!(!i.state.isGlobal||!t)&&(e.interactionType!==et.TUMBLE||!pf(e.selection,Xt.TILT))}function EU(i,e,t){const r=e.interactionType;if(r===et.NONE)return;const{min:s,max:a}=t,{interactionStartCamera:n,interactionFactor:o}=e;if(!n)return;const l=r===et.TUMBLE||r===et.ZOOM,c=oC(i,n),h=c===0?0:i.renderCoordsHelper.getAltitude(n.eye);t.min=s,t.max=a,Ty(c,h,l,o,.05*h,t)}function AU(i,e,t,r){return i.renderCoordsHelper.worldUpAtPosition(e.eye,r),B(r,r,t),r}function MU(i,e){return e.min=i.min,e.max=i.max,e}const DU={min:0,max:0},IU=T(),LU=T(),$U=T(),B1=T();function lC(i,e,t=vh){if(!i.state.isLocal)return 0;const r=i.state.constraints.distance;if(!i.pointsOfInterest.surfaceOrigin.renderLocation||r===1/0)return 0;d_.min=0,d_.max=r,FU(i,t,d_);const s=cC(i,e),a=d_.max-s;return a>=-1e-6?0:a}function NU(i,e,t=vh){const r=lC(i,e,t);if(r===0)return!1;const s=i.pointsOfInterest.surfaceOrigin;if(!s.renderLocation)return!1;const a=cC(i,e)+r,n=H(UU,e.eye),o=dD(e,t.interactionDirection,zU(e,s.renderLocation,BU),GU);if(!uv(H9(s.renderLocation,a),xo(e.eye,o),u_))return!1;e.eye=u_;const l=Q(VU,e.eye,n);e.center=X(u_,e.center,l);const c=i.renderCoordsHelper.getAltitude(e.center),h=i.renderCoordsHelper.intersectInfiniteManifold(e.ray,c,u_);return g(h)&&(e.center=h),!0}function FU(i,e,t){const r=e.interactionType;if(r===et.NONE)return;const{min:s,max:a}=t,{interactionStartCamera:n,interactionFactor:o}=e;if(!n)return;const l=r===et.ZOOM||r===et.PAN,c=lC(i,n),h=c===0?0:cC(i,n);t.min=s,t.max=a,Ty(c,h,l,o,.05*h,t)}function cC(i,e){const t=i.pointsOfInterest.surfaceOrigin;return t.renderLocation?yi(e.eye,t.renderLocation):0}function zU(i,e,t){return Bd(t,i.eye,e)}const d_={min:0,max:0},UU=T(),VU=T(),GU=T(),BU=T(),u_=T();var ci,Vr;(function(i){i[i.OBJECT=0]="OBJECT",i[i.HUD=1]="HUD",i[i.TERRAIN=2]="TERRAIN",i[i.OVERLAY=3]="OVERLAY",i[i.I3S=4]="I3S",i[i.PCL=5]="PCL",i[i.LOD=6]="LOD",i[i.VOXEL=7]="VOXEL"})(ci||(ci={}));let HU=class{constructor(){this.verticalOffset=0,this.selectionMode=!1,this.hud=!0,this.selectOpaqueTerrainOnly=!0,this.invisibleTerrain=!1,this.backfacesTerrain=!0,this.isFiltered=!1,this.filteredLayerUids=[],this.store=Vr.ALL}};(function(i){i[i.MIN=0]="MIN",i[i.MINMAX=1]="MINMAX",i[i.ALL=2]="ALL"})(Vr||(Vr={}));let kU=class{constructor(e,t,r){this.object=e,this.geometryId=t,this.triangleNr=r}},jU=class extends kU{constructor(e,t,r,s){super(e,t,r),this.center=g(s)?aa(s):null}},uD=class{constructor(e){this.layerUid=e}},Ev=class extends uD{constructor(e,t){super(e),this.graphicUid=t}};function So(i){return g(i)&&g(i.dist)}function mP(i){return(e,t,r)=>(Gr(gP,e,t,r),!QT(i,gP))}function Av(i){return So(i)&&i.intersector===ci.OBJECT&&!!i.target}function Mv(i){return So(i)&&i.intersector===ci.HUD&&!!i.target&&"center"in i.target&&g(i.target.center)}const gP=T(),kp=1e-5;let qU=class{constructor(e){this.options=new HU,this._results=new WU,this.transform=new pF,this.tolerance=kp,this.verticalOffset=null,this._ray=Aa(),this._rayEnd=T(),this._rayBeginTransformed=T(),this._rayEndTransformed=T(),this.viewingMode=e??ve.Global}get results(){return this._results}get ray(){return this._ray}get rayBegin(){return this._ray.origin}get rayEnd(){return this._rayEnd}reset(e,t,r){this.resetWithRay(k9(e,t,this._ray),r)}resetWithRay(e,t){this.camera=t,e!==this._ray&&Sx(e,this._ray),this.options.verticalOffset!==0?this.viewingMode===ve.Local?this._ray.origin[2]-=this.options.verticalOffset:this.verticalOffset=this.options.verticalOffset:this.verticalOffset=null,X(this._rayEnd,this._ray.origin,this._ray.direction),this._results.init(this._ray)}intersect(e=null,t,r,s,a){this.point=t,this.filterPredicate=s,this.tolerance=r??kp;const n=a2(this.verticalOffset);if(g(e)&&e.length>0){const o=a?l=>{a(l)&&this.intersectObject(l)}:l=>{this.intersectObject(l)};for(const l of e){const c=l.getSpatialQueryAccelerator&&l.getSpatialQueryAccelerator();g(c)?(g(n)?c.forEachAlongRayWithVerticalOffset(this._ray.origin,this._ray.direction,o,n):c.forEachAlongRay(this._ray.origin,this._ray.direction,o),this.options.selectionMode&&this.options.hud&&c.forEachDegenerateObject(o)):l.objects.forAll(h=>o(h))}}this.sortResults()}intersectObject(e){const t=e.geometries;if(!t)return;const r=e.transformation,s=a2(this.verticalOffset);for(const a of t){if(!a.visible)continue;const{material:n,id:o}=a;this.transform.setAndInvalidateLazyTransforms(r,a.shaderTransformation),xe(this._rayBeginTransformed,this.rayBegin,this.transform.inverse),xe(this._rayEndTransformed,this.rayEnd,this.transform.inverse);const l=this.transform.transform;g(s)&&(s.objectTransform=this.transform),n.intersect(a,this.transform.transform,this,this._rayBeginTransformed,this._rayEndTransformed,(c,h,u,p,m,f)=>{if(c>=0){if(g(this.filterPredicate)&&!this.filterPredicate(this._ray.origin,this._rayEnd,c))return;const y=p?this._results.hud:this._results,b=p?x=>{const S=new jU(e,o,u,f);x.set(ci.HUD,S,c,h,ph,m)}:x=>x.set(ci.OBJECT,{object:e,geometryId:o,triangleNr:u},c,h,l,m);if((y.min.drapedLayerOrder==null||m>=y.min.drapedLayerOrder)&&(y.min.dist==null||c<y.min.dist)&&b(y.min),this.options.store!==Vr.MIN&&(y.max.drapedLayerOrder==null||m<y.max.drapedLayerOrder)&&(y.max.dist==null||c>y.max.dist)&&b(y.max),this.options.store===Vr.ALL)if(p){const x=new rw(this._ray);b(x),this._results.hud.all.push(x)}else{const x=new Ep(this._ray);b(x),this._results.all.push(x)}}})}}sortResults(e=this._results.all){e.sort((t,r)=>t.dist!==r.dist?je(t.dist,0)-je(r.dist,0):t.drapedLayerOrder!==r.drapedLayerOrder?je(t.drapedLayerOrder,Number.MAX_VALUE)-je(r.drapedLayerOrder,Number.MAX_VALUE):je(r.drapedLayerGraphicOrder,Number.MIN_VALUE)-je(t.drapedLayerGraphicOrder,Number.MIN_VALUE))}};function zn(i){return new qU(i)}let WU=class{constructor(){this.min=new Ep(Aa()),this.max=new Ep(Aa()),this.hud={min:new rw(Aa()),max:new rw(Aa()),all:new Array},this.ground=new Ep(Aa()),this.all=[]}init(e){this.min.init(e),this.max.init(e),this.ground.init(e),this.all.length=0,this.hud.min.init(e),this.hud.max.init(e),this.hud.all.length=0}},Ep=class{get ray(){return this._ray}get distanceInRenderSpace(){return g(this.dist)?(B(p_,this.ray.direction,this.dist),pe(p_)):null}getIntersectionPoint(e){return!!So(this)&&(B(p_,this.ray.direction,this.dist),X(e,this.ray.origin,p_),!0)}getTransformedNormal(e){return H(vm,this.normal),vm[3]=0,Ul(vm,vm,this.transformation),H(e,vm),W(e,e)}constructor(e){this.intersector=ci.OBJECT,this.normal=T(),this.transformation=ce(),this._ray=Aa(),this.init(e)}init(e){this.dist=null,this.target=null,this.drapedLayerOrder=null,this.drapedLayerGraphicOrder=null,this.intersector=ci.OBJECT,Sx(e,this._ray)}set(e,t,r,s,a,n,o){this.intersector=e,this.dist=r,H(this.normal,je(s,D4)),Kr(this.transformation,je(a,ph)),this.target=t,this.drapedLayerOrder=n,this.drapedLayerGraphicOrder=o}copy(e){Sx(e.ray,this._ray),this.intersector=e.intersector,this.dist=e.dist,this.target=e.target,this.drapedLayerOrder=e.drapedLayerOrder,this.drapedLayerGraphicOrder=e.drapedLayerGraphicOrder,H(this.normal,e.normal),Kr(this.transformation,e.transformation)}},rw=class extends Ep{constructor(){super(...arguments),this.intersector=ci.HUD}};function hC(i){return new Ep(i)}const p_=T(),vm=Pt();function pD(i,e,t,r){return g(i.renderCoordsHelper.fromRenderCoords(e.eye,Cy,r))&&$A(t,Cy)}function Dv(i,e){return i.elevationProvider?je(i.elevationProvider.getElevation(e[0],e[1],e[2],i.renderCoordsHelper.spatialReference,"ground"),0):0}function Zd(i,e,t,r){const s=i.state.camera.clone();e&&t&&r&&(s.eye=e,s.center=t,s.up=r),XU(i,s.ray,gc)||H(gc,s.center);const a=i.state.constraints,n=a.minimumPoiDistance;if(ol(s.eye,gc)<n){const o=a.collision.enabled;H(Eh,s.viewForward),B(Eh,Eh,n),o?s.eye=Q(Cy,gc,Eh):X(gc,s.eye,Eh);const l=i.renderCoordsHelper,c=l.getAltitude(s.eye),h=a.collision.elevationMargin;o&&c<h&&(Q(Eh,gc,s.eye),s.eye=l.setAltitude(Cy,h,s.eye),X(gc,s.eye,Eh))}return s.center=gc,s}function fP(i,e,t){if(!i.state.isGlobal||!i.stateManager.constraintsManager)return!1;const r=Dv(i,e),s=i.stateManager.constraintsManager.nearFarHeuristic,{far:a}=s.compute(e,t,i.renderDataExtent,r,ZU),n=a*a;return ol(e,t)>n}function XU(i,e,t){let r=_P[i.viewingMode];r||(r=zn(i.state.viewingMode),r.options.backfacesTerrain=!i.state.isGlobal,r.options.invisibleTerrain=!0,_P[i.viewingMode]=r);const{isGlobal:s}=i.state;return!(!i.sceneIntersectionHelper.intersectRay(e,r,t)||fP(i,e.origin,t))||!(!i.renderCoordsHelper.intersectManifold(e,0,t)||fP(i,e.origin,t))||!!s&&QU(e,t,Et(i.spatialReference).radius)}function QU(i,e,t){const r=J(i.origin,i.origin)-t*t,s=r>0?Math.sqrt(r)/3:1;return B(e,i.direction,s/pe(i.direction)),X(e,e,i.origin),!0}const _P={},Cy=T(),gc=T(),Eh=T(),ZU={near:0,far:0};function am(i,e,t=Dn.EYE){const r=i.state.constraints;if(!r.collision.enabled)return!1;const s=Dv(i,e.eye),a=i.renderCoordsHelper.getAltitude(e.eye),n=s+r.collision.elevationMargin;if(a>=n)return!1;const o=pe(e.eye);if(Q(m_,e.center,e.eye),e.eye=i.renderCoordsHelper.setAltitude(YU,n,e.eye),t===Dn.EYE_AND_CENTER)e.center=X(m_,e.eye,m_);else if(t===Dn.EYE_AND_CENTER_SCALE){const l=(o-a+n)/o;e.center=B(m_,e.center,l)}return!0}var Dn;(function(i){i[i.EYE=0]="EYE",i[i.EYE_AND_CENTER=1]="EYE_AND_CENTER",i[i.EYE_AND_CENTER_SCALE=2]="EYE_AND_CENTER_SCALE"})(Dn||(Dn={}));const m_=T(),YU=T();function bh(i,e,t){i.worldUpAtPosition(e,yP),Q(H1,t,e);const r=pe(H1);return r===0?0:es(J(H1,yP)/r)}const yP=T(),H1=T();function mD(i,e,t=vh,r=!0){bm.eyeCenterDistance=0,bm.requiresTwoSteps=!1;const s=dC(i,e,t,void 0,bm);if(s===0)return!1;switch(go(g_,-s,e.viewRight),t.tiltMode){case Er.LOOK_AROUND:xe(fc,e.viewForward,g_),B(fc,fc,bm.eyeCenterDistance),e.center=X(qc,e.eye,fc);break;case Er.TUMBLE:Q(fc,e.center,e.eye),xe(fc,fc,g_),e.eye=Q(qc,e.center,fc);break;default:_o(t.tiltMode)}return e.up=xe(qc,e.up,g_),!bm.requiresTwoSteps||!r||mD(i,e,t,!1)}function dC(i,e,t=vh,r=vh,s){if(!i.state.constraints.tilt)return 0;const a=e.distance,n=i.state.constraints.tilt(a,oV);return nV(i,t,n),r.interactionType===et.TUMBLE&&pf(r.selection,Xt.ALTITUDE)&&gD(i,r.interactionStartCamera,n),t.tiltMode===Er.LOOK_AROUND||r.tiltMode===Er.LOOK_AROUND?JU(i,e,n,s):KU(i,e,n)}function KU(i,e,t){const r=bh(i.renderCoordsHelper,e.center,e.eye),s=r-ee(r,t.min,t.max);return mf(s)?s:0}function JU(i,e,t,r){switch(r&&(r.requiresTwoSteps=!1),i.viewingMode){case"global":return tV(i,e,t,r);case"local":return eV(i,e,t,r)}}function eV(i,e,t,r){const s=bh(i.renderCoordsHelper,e.center,e.eye),a=ee(s,t.min,t.max),n=s-a;if(!mf(n))return 0;if(r){const o=i.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,l=i.renderCoordsHelper.getAltitude(e.eye)-o,c=Math.cos(a);Math.abs(c)>1e-4?r.eyeCenterDistance=l/c:r.eyeCenterDistance=e.distance}return n}function tV(i,e,t,r){const s=iV(i,e,lV),a=ee(s.tiltAtCenter,t.min,t.max);if(!mf(s.tiltAtCenter-a))return 0;let n,o;return s.centerIsOnSurface?(n=rV(s),o=sV(s,n)):(n=s.constraints.clampTilt(s.eyeCenterDistance,s.tiltAtCenter),r&&n<Math.PI/2&&(r.requiresTwoSteps=!0,n=Math.PI/2-1e-5),o=aV(s,n)),r&&(r.eyeCenterDistance=sw(s,n)),o}function iV(i,e,t){const r=i.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,s=r+Et(i.spatialReference).radius,a=i.renderCoordsHelper.intersectManifold(e.ray,r,qc);return t.eyeCenterDistance=e.distance,t.centerIsOnSurface=!1,g(a)?(t.eyeCenterDistance=yi(e.eye,a),t.tiltAtCenter=bh(i.renderCoordsHelper,a,e.eye),t.centerIsOnSurface=!0):i.state.isLocal?t.tiltAtCenter=bh(i.renderCoordsHelper,e.center,e.eye):(pv(ST(PT,s),e.ray,qc),t.eyeCenterDistance=yi(e.eye,qc),t.tiltAtCenter=es(-J(e.viewForward,W(qc,qc)))),t.radius=s,t.eyeRadius=pe(e.eye),t.constraints=i.state.constraints,t}function mf(i){return Math.abs(i)>1e-9}function rV(i){const{constraints:e,eyeCenterDistance:t,tiltAtCenter:r}=i;let s=r,a=e.clampTilt(t,r);const n=sw(i,a);if(e.clampTilt(n,r)===a)return a;let o=0;for(;o<10&&mf(a-s);){const l=(s+a)/2,c=sw(i,l);mf(e.clampTilt(c,l)-l)?s=l:a=l,o++}return a}function sw(i,e){if(!i.centerIsOnSurface)return i.eyeCenterDistance;const t=Math.PI-ee(e,0,Math.PI),r=ul(i.radius/i.eyeRadius*Math.sin(t)),s=Math.PI-t-r,a=Math.sin(s)/Math.sin(t);if(i.eyeRadius<i.radius&&a>1){const n=Math.PI-r,o=Math.PI-t-n;return Math.sin(o)/Math.sin(t)*i.eyeRadius}return a*i.eyeRadius}function sV(i,e){const t=ul(i.radius/i.eyeRadius*Math.sin(i.tiltAtCenter)),r=ul(i.radius/i.eyeRadius*Math.sin(e));return i.eyeRadius>i.radius?t-r:r-t}function aV(i,e){return i.tiltAtCenter-Math.PI/2-(e-Math.PI/2)}function nV(i,e,t){if(e.interactionType===et.NONE)return;const{interactionStartCamera:r,interactionFactor:s}=e;if(!r)return;const{min:a,max:n}=t,o=dC(i,r,vh,e),l=o===0?0:bh(i.renderCoordsHelper,r.center,r.eye);t.min=a,t.max=n,e.interactionType===et.TUMBLE?(pf(e.selection,Xt.ALTITUDE)&&gD(i,r,t),Ty(o,l,!0,s,vP,t)):Ty(o,l,!1,s,vP,t)}function gD(i,e,t){const r=i.state.constraints;if(i.state.isLocal||!r.altitude||!e)return;const s=sn(e.center),a=Math.sqrt(s),n=e.distance,o=Et(i.spatialReference).radius,l=r.altitude.min+o,c=r.altitude.max+o,h=(l*l-n*n-s)/(-2*a*n),u=(c*c-n*n-s)/(-2*a*n);t.min=Math.max(t.min,Math.min(Math.PI-es(u),t.max)),t.max=Math.min(t.max,Math.PI-es(h))}const fc=T(),g_=ce(),qc=T(),vP=ut(5),oV={min:0,max:0},lV={constraints:null,radius:0,eyeRadius:0,centerIsOnSurface:!0,eyeCenterDistance:0,tiltAtCenter:0},bm={eyeCenterDistance:0,requiresTwoSteps:!1};function cV(i){return i}const Iv=i=>i*i,uC=i=>1-Iv(1-i),hV=i=>i<.5?Iv(2*i)/2:(uC(2*(i-.5))+1)/2,pC=i=>i*i*i,fD=i=>1-pC(1-i),_D=i=>i<.5?pC(2*i)/2:(fD(2*(i-.5))+1)/2,mC=i=>i*i*i*i,yD=i=>1-mC(1-i),dV=i=>i<.5?mC(2*i)/2:(yD(2*(i-.5))+1)/2,gC=i=>i*i*i*i*i,vD=i=>1-gC(1-i),uV=i=>i<.5?gC(2*i)/2:(vD(2*(i-.5))+1)/2,fC=i=>1-Math.cos(i*Math.PI/2),bD=i=>1-fC(1-i),pV=i=>i<.5?fC(2*i)/2:(bD(2*(i-.5))+1)/2,_C=i=>2**(10*(i-1)),qf=i=>1-_C(1-i),mV=i=>i<.5?_C(2*i)/2:(qf(2*(i-.5))+1)/2,yC=i=>-(Math.sqrt(1-i*i)-1),xD=i=>1-yC(1-i),gV=i=>i<.5?yC(2*i)/2:(xD(2*(i-.5))+1)/2;function Gn(i){const e=2*(i-Math.sqrt((i-1)*i)),t=e/2/i;return r=>r<t?i*r*r:e*r-e+1}function Bn(i,e){return(t,r)=>t<e?e*i(t/e,r):1-i((1-t)/(1-e),r)*(1-e)}const fV=Bn(Gn(1),1),_V=Bn(Gn(1),0),wD=Bn(Gn(1),.5),yV=Bn(Gn(2),1),vV=Bn(Gn(2),0),bV=Bn(Gn(2),.5),xV=Bn(Gn(3),1),wV=Bn(Gn(3),0),TV=Bn(Gn(3),.5),CV=Bn(Gn(4),1),SV=Bn(Gn(4),0),PV=Bn(Gn(4),.5),OV={linear:cV,"in-quad":Iv,"out-quad":uC,"in-out-quad":hV,"in-coast-quad":fV,"out-coast-quad":_V,"in-out-coast-quad":wD,"in-cubic":pC,"out-cubic":fD,"in-out-cubic":_D,"in-coast-cubic":yV,"out-coast-cubic":vV,"in-out-coast-cubic":bV,"in-quart":mC,"out-quart":yD,"in-out-quart":dV,"in-coast-quart":xV,"out-coast-quart":wV,"in-out-coast-quart":TV,"in-quint":gC,"out-quint":vD,"in-out-quint":uV,"in-coast-quint":CV,"out-coast-quint":SV,"in-out-coast-quint":PV,"in-sine":fC,"out-sine":bD,"in-out-sine":pV,"in-expo":_C,"out-expo":qf,"in-out-expo":mV,"in-circ":yC,"out-circ":xD,"in-out-circ":gV};function Fi(i,e,t=MV,r=e){r!==e&&r.copyFrom(e),r.computeUp(i.state.viewingMode);let s=!1;for(let o=0;o<DV;o++){let l=0;for(const c of AV)if(pf(t.selection,c.type)){const h=Math.abs(c.error(i,r,t));c.apply(i,r,t)&&(s=!0,l+=h)}if(l===0)break}const a=pf(t.selection,Xt.COLLISION),n=RV(t.interactionType,i);return a&&am(i,r,n)&&(s=!0),s&&r.computeUp(i.state.viewingMode),s}function RV(i,e){switch(i){case et.PAN:return Dn.EYE_AND_CENTER;case et.ASCEND:return e.state.isGlobal?Dn.EYE_AND_CENTER_SCALE:Dn.EYE_AND_CENTER;default:return Dn.EYE}}function ao(i){const e=Math.min(1,i/150);return _D(e)}function EV(i,e,t){return dC(i,e,t)*e.distance}const AV=[{type:Xt.TILT,error:EV,apply:mD},{type:Xt.ALTITUDE,error:oC,apply:OU},{type:Xt.DISTANCE,error:lC,apply:NU}],MV={selection:Xt.ALL,interactionType:et.NONE,interactionFactor:0,interactionStartCamera:null,interactionDirection:null,tiltMode:Er.TUMBLE},DV=5,Ua=T(),ga=T(),_c=T(),ss=T(),Ah=T(),IV=T(),Va={upward:Ge(0,0,1),forward:Ge(0,1,0),sideway:Ge(1,0,0)},bP=ys();let xP=class{constructor(e=ve.Global){this.viewingMode=e,this.center=T(),this.pitch=0,this.yaw=0,this.distance=0,this.lookAtDirection=aa(Va.forward)}pixelsPerPanAtZoom(e){return this.size/2/(this._zoomToPanScale*e)}zoomAtPixelsPerPan(e){return this.size/2/(this._zoomToPanScale*e)}pixelsPerRotateAtZoom(){const e=Math.max(Math.cos(Math.abs(this.pitch)),.5);return this.size/2/e}compareTo(e,t){if(t||(t={pan:0,rotate:0,sourceZoom:0,targetZoom:0}),this.viewingMode===ve.Global){const a=(pe(this.center)+pe(e.center))/2;t.pan=D0(this.center,e.center)*a}else t.pan=yi(this.center,e.center);let r=Math.abs(e.yaw-this.yaw);r>=Math.PI&&(r=2*Math.PI-r);const s=Math.abs(e.pitch-this.pitch);return t.rotate=Math.max(r,s),t.sourceZoom=this.distance,t.targetZoom=e.distance,t}interpolate(e,t,r){this.viewingMode===ve.Global?y8(e.center,t.center,r.pan,this.center):Gr(this.center,e.center,t.center,r.pan),this.distance=isFinite(t.distance)?st(e.distance,t.distance,r.zoom):e.distance,this.pitch=st(e.pitch,t.pitch,r.rotate);let s=e.yaw;const a=t.yaw;Math.abs(a-s)>=Math.PI&&(s+=2*(s<a?1:-1)*Math.PI),this.yaw=st(s,a,r.rotate)}copyFrom(e){H(this.center,e.center),this.pitch=e.pitch,this.yaw=e.yaw,this.distance=e.distance,H(this.lookAtDirection,e.lookAtDirection),this.size=e.size,this.copyFromCommon(e),this.viewingMode=e.viewingMode}copyFromRenderCamera(e){const t=this._lookAtOrientation(e.center,bP);H(this.center,e.center),Q(ss,e.center,e.eye),el(ss,ss,t),el(Ah,e.up,t),this.distance=pe(ss),this.distance!==0&&(ss[0]/=this.distance,ss[1]/=this.distance,ss[2]/=this.distance),this.pitch=this._eyeUpToPitch(ss),this.yaw=this._eyeUpToYaw(ss,Ah),this.size=Math.sqrt(e.width*e.width+e.height*e.height),this.copyFromCommon(e)}copyFromCommon(e){this.fov=e.fov,this._zoomToPanScale=Math.atan(.5*this.fov)}copyToRenderCamera(e){const t=this._lookAtOrientation(this.center,bP);ic(t,t),this._axisAngleVec3(Va.sideway,this.pitch-Math.PI/2,Va.forward,ss),this._axisAngleVec3(Va.upward,this.yaw,ss),this._axisAngleVec3(Va.sideway,this.pitch-Math.PI/2,Va.upward,Ah),this._axisAngleVec3(Va.upward,this.yaw,Ah),B(ss,ss,this.distance),el(ss,ss,t),el(Ah,Ah,t),e.center=this.center,e.eye=Q(ss,this.center,ss),e.up=Ah}_axisAngleVec3(e,t,r,s=r){const a=Math.cos(t),n=Math.sin(t);return B(Ua,r,a),Be(ga,e,r),B(ga,ga,n),B(_c,e,(1-a)*J(e,r)),X(s,X(s,Ua,ga),_c)}_lookAtOrientation(e,t=ys()){return this._upAtLookAt(e,_c),Be(Ua,this.lookAtDirection,_c),W(Ua,Ua),Ua[0]===0&&Ua[1]===0&&Ua[2]===0&&H(Ua,Va.sideway),Be(ga,_c,Ua),W(ga,ga),t[0]=Ua[0],t[1]=ga[0],t[2]=_c[0],t[3]=Ua[1],t[4]=ga[1],t[5]=_c[1],t[6]=Ua[2],t[7]=ga[2],t[8]=_c[2],t}_upAtLookAt(e,t){return this.viewingMode===ve.Local?H(t,Va.upward):W(t,e)}_eyeUpToPitch(e){return Math.PI-D0(Va.upward,e)}_eyeUpToYaw(e,t){const r=IV;return Math.abs(t[2])<.5?(H(r,t),e[2]>0&&B(r,r,-1)):H(r,e),Be(ga,r,Va.upward),W(ga,ga),D0(Va.sideway,ga,Va.upward)}};const Sy={desiredScreenFlow:2,minDuration:Je(500),maxDuration:Je(8e3)};let LV=class TD{constructor(e){this._createCamera=e,this.compared={sourceZoom:0,targetZoom:0,pan:0,rotate:0},this.settings={desiredScreenFlow:Sy.desiredScreenFlow},this.source=e(),this.target=e()}clone(){const e=new TD(this._createCamera);return e.copyFrom(this),e}copyFrom(e){this.update(e.source,e.target,e.settings)}update(e,t,r){this.source!==e&&this.source.copyFrom(e),this.target!==t&&this.target.copyFrom(t),this.compared=this.source.compareTo(this.target,this.compared),this.settings.desiredScreenFlow=r.desiredScreenFlow!=null?r.desiredScreenFlow:Sy.desiredScreenFlow,this.desiredPixelFlow=this.settings.desiredScreenFlow*this.target.size,this.halfWindowSize=this.target.size/2}halfWindowPanAtZoom(e){const t=this.target.pixelsPerPanAtZoom(e);return this.halfWindowSize/t}get hasZoom(){return Math.abs(this.compared.sourceZoom-this.compared.targetZoom)>1e-5}get hasPan(){return this.compared.pan>1e-9}get hasRotate(){return this.compared.rotate>1e-9}},$V=class{constructor(){this.segments=[]}get time(){return this.segments.reduce((e,t)=>to(e+t.time),to(0))}interpolateComponentsAt(e,t){e=Math.min(Math.max(e,0),1),e*=this.time;let r=0,s=0;const a=this.definition;for(let n=0;n<this.segments.length;n++){const o=this.segments[n],l=o.definition;if(e<=o.time||n===this.segments.length-1){if(t=this.segmentInterpolateComponentsAt(o,o.time===0?0:e/o.time,t),a.hasPan&&!isNaN(t.pan)&&isFinite(a.compared.pan)?t.pan=(r+l.compared.pan*t.pan)/a.compared.pan:t.pan=1,a.hasRotate&&!isNaN(t.rotate)&&isFinite(a.compared.rotate)?t.rotate=(s+l.compared.rotate*t.rotate)/a.compared.rotate:t.rotate=1,a.hasZoom&&!isNaN(t.zoom)&&isFinite(l.compared.targetZoom)){const c=t.zoom*(l.compared.targetZoom-l.compared.sourceZoom)+l.compared.sourceZoom,h=this.segments[0].definition.compared.sourceZoom,u=this.segments[this.segments.length-1].definition.compared.targetZoom;t.zoom=(c-h)/(u-h)}else t.zoom=1;return t}e-=o.time,r+=l.compared.pan,s+=l.compared.rotate}}segmentInterpolateComponentsAt(e,t,r){return e.interpolateComponentsAt(t,r)}},k1=class{get time(){return this._time}constructor(e){e&&this.update(e)}update(e){e&&(this.definition?this.definition.copyFrom(e):this.definition=e.clone()),this._updatePrecomputedVariables(),this._updatePixelFlow()}_updatePrecomputedVariables(){const e=this.definition,t=e.compared,r=t.sourceZoom,s=t.targetZoom;this._zoomSign=r>s?1:-1,this._panPixelsAtSource=t.pan*e.source.pixelsPerPanAtZoom(r);const a=(e.source.pixelsPerRotateAtZoom(r)+e.target.pixelsPerRotateAtZoom(s))/2;this._rotatePixels=t.rotate*a}_updatePixelFlow(){const e=this.definition.compared.sourceZoom,t=this.definition.compared.targetZoom,{hasZoom:r,hasPan:s,hasRotate:a}=this.definition;let n=0,o=0;r&&(s&&(n=(t/e-1)/(-1/(this._zoomSign*this.definition.halfWindowSize)*Math.LN2*this._panPixelsAtSource)),a&&(o=this._zoomSign*(Math.log(e/t)/Math.LN2)*this.definition.halfWindowSize/this._rotatePixels)),this._zoomPixelFlow=0,this._panPixelFlow=0,this._rotatePixelFlow=0;const l=this.definition.desiredPixelFlow;if(r&&s&&a){const c=n+o+n*o;this._zoomPixelFlow=n*o/c*l,this._panPixelFlow=o/c*l,this._rotatePixelFlow=n/c*l}else if(r&&s){const c=1+n;this._zoomPixelFlow=n/c*l,this._panPixelFlow=1/c*l}else if(r&&a){const c=1+o;this._zoomPixelFlow=o/c*l,this._rotatePixelFlow=1/c*l}else if(s&&a){const c=this._panPixelsAtSource/this._rotatePixels,h=1+c;this._panPixelFlow=c/h*l,this._rotatePixelFlow=1/h*l}else s?this._panPixelFlow=l:r?this._zoomPixelFlow=l:a&&(this._rotatePixelFlow=l);this._time=a?this.rotateTime:r?this.zoomTime:s?this.panTime:to(0)}get rotateTime(){return this.definition.hasRotate?to(this._rotatePixels/this._rotatePixelFlow):to(0)}get zoomTime(){return this.definition.hasZoom?to(this._zoomSign*(Math.log(this.definition.compared.sourceZoom/this.definition.compared.targetZoom)/Math.LN2)*this.definition.halfWindowSize/this._zoomPixelFlow):to(0)}get panTime(){if(this.definition.hasPan){if(this.definition.hasZoom){const e=-1/(this._zoomSign*this.definition.halfWindowSize)*Math.LN2,t=e*this._panPixelsAtSource;return to(Math.log(t*(this._zoomPixelFlow/this._panPixelFlow)+1)/(e*this._zoomPixelFlow))}return to(this._panPixelsAtSource/this._panPixelFlow)}return to(0)}_interpolateComponentsZoom(e){if(e===0||e===1)return e;if(this.definition.hasZoom){const t=this.definition.compared.sourceZoom,r=this.definition.compared.targetZoom;return(t*(t/r)**-e-t)/(r-t)}return e}_interpolateComponentsPan(e){if(e===0||e===1)return e;if(this.definition.hasPan&&this.definition.hasZoom){const t=-1/(this._zoomSign*this.definition.halfWindowSize)*this._zoomPixelFlow;return 1/this._panPixelsAtSource*(this._panPixelFlow*(2**(t*e*this._time)-1))/(t*Math.LN2)}return e}_interpolateComponentsRotate(e){return e}interpolateComponentsAt(e,t){e=Math.min(Math.max(e,0),1);const r=this._interpolateComponentsZoom(e),s=this._interpolateComponentsPan(e),a=this._interpolateComponentsRotate(e);return t?(t.zoom=r,t.pan=s,t.rotate=a):t={zoom:r,pan:s,rotate:a},t}};function NV(i,e,t){const r=e-i.compared.sourceZoom,s=i.halfWindowPanAtZoom(r);return-i.halfWindowSize*(t.ascensionFactor*Math.LN2*i.compared.pan+s)*Math.log(i.compared.sourceZoom/e)/(i.desiredPixelFlow*Math.LN2*s)}function FV(i,e,t){const r=1/e,s=Math.log(i.compared.sourceZoom*r),a=1/i.desiredPixelFlow,n=1/Math.LN2,o=e-i.compared.sourceZoom,l=1/o,c=(t.ascensionFactor*Math.LN2*i.compared.pan+i.halfWindowPanAtZoom(o))/i.halfWindowPanAtZoom(1);return i.halfWindowSize*r*a*n*l*c-i.halfWindowSize*s*a*n*l+i.halfWindowSize*s*a*n*c/(o*o)}function zV(i,e,t){const r=e-i.compared.sourceZoom,s=1/r,a=1/e,n=Math.log(i.compared.sourceZoom*a),o=(t.ascensionFactor*Math.LN2*i.compared.pan+i.halfWindowPanAtZoom(r))/i.halfWindowPanAtZoom(1);return i.halfWindowSize*s*(-2*s*a*o+2*s*n+2*a-2*n*o/(r*r)-o/(e*e))/(i.desiredPixelFlow*Math.LN2)}function UV(i,e){return-i.halfWindowSize*Math.log(i.compared.sourceZoom/e)/(i.desiredPixelFlow*Math.LN2)}function VV(i,e){return i.halfWindowSize/(e*i.desiredPixelFlow*Math.LN2)}function GV(i,e){return-i.halfWindowSize/(e*e*i.desiredPixelFlow*Math.LN2)}function BV(i,e,t){return-i.compared.pan*i.halfWindowSize*(t.ascensionFactor+t.descensionFactor-1)/(i.desiredPixelFlow*i.halfWindowPanAtZoom(e))}function HV(i,e,t){return i.compared.pan*i.halfWindowSize*(t.ascensionFactor+t.descensionFactor-1)/(i.desiredPixelFlow*i.halfWindowPanAtZoom(e*e))}function kV(i,e,t){return-2*i.compared.pan*i.halfWindowSize*(t.ascensionFactor+t.descensionFactor-1)/(i.desiredPixelFlow*i.halfWindowPanAtZoom(e*e*e))}function jV(i,e,t){return i.halfWindowSize*(-i.halfWindowPanAtZoom(e)-t.descensionFactor*Math.LN2*i.compared.pan+i.halfWindowPanAtZoom(i.compared.targetZoom))*Math.log(e/i.compared.targetZoom)/(i.desiredPixelFlow*Math.LN2*i.halfWindowPanAtZoom(-e+i.compared.targetZoom))}function qV(i,e,t){const r=Math.log(e/i.compared.targetZoom),s=1/i.desiredPixelFlow,a=1/Math.LN2,n=-e+i.compared.targetZoom,o=1/n,l=(-i.halfWindowPanAtZoom(e)-t.descensionFactor*Math.LN2*i.compared.pan+i.halfWindowPanAtZoom(i.compared.targetZoom))/i.halfWindowPanAtZoom(1);return-i.halfWindowSize*r*s*a*o+i.halfWindowSize*r*s*a*l/(n*n)+i.halfWindowSize*s*a*o*l/e}function WV(i,e,t){const r=e-i.compared.targetZoom,s=1/r,a=1/e,n=Math.log(e/i.compared.targetZoom),o=(i.halfWindowPanAtZoom(e)+t.descensionFactor*Math.LN2*i.compared.pan-i.halfWindowPanAtZoom(i.compared.targetZoom))/i.halfWindowPanAtZoom(1);return i.halfWindowSize*s*(-2*s*a*o-2*s*n+2*a+2*n*o/(r*r)-o/(e*e))/(i.desiredPixelFlow*Math.LN2)}function XV(i,e){return i.halfWindowSize*Math.log(e/i.compared.targetZoom)/(i.desiredPixelFlow*Math.LN2)}function QV(i,e){return i.halfWindowSize/(e*i.desiredPixelFlow*Math.LN2)}function ZV(i,e){return-i.halfWindowSize/(e*e*i.desiredPixelFlow*Math.LN2)}function YV(i){const e=Math.LN2*i.compared.pan,t=i.compared.sourceZoom-i.compared.targetZoom,r=i.halfWindowPanAtZoom(t),s=i.halfWindowSize*Math.log(i.compared.sourceZoom/i.compared.targetZoom)/(i.desiredPixelFlow*Math.LN2*r);return i.compared.sourceZoom<=i.compared.targetZoom?s*(e-r):s*(e+r)}function KV(i,e){let t=JV(i,e);const r={ascensionFactor:e.ascensionFactor!=null?e.ascensionFactor:.5,descensionFactor:e.descensionFactor!=null?e.descensionFactor:.5},s=r.ascensionFactor===0,a=r.descensionFactor===0,n=s?UV:NV,o=s?VV:FV,l=s?GV:zV,c=a?XV:jV,h=a?QV:qV,u=a?ZV:WV,p=O=>n(i,O,r)+BV(i,O,r)+c(i,O,r),m=O=>o(i,O,r)+HV(i,O,r)+h(i,O,r),f=O=>l(i,O,r)+kV(i,O,r)+u(i,O,r);let y=p(t);const b=YV(i);let x;const S=e.maximumIterations||20,C=e.maximumDistance!=null?e.maximumDistance:1/0;for(x=0;x<S;x++){const R=(m(t)+1e-6)/f(t);if(isNaN(R)||t>=C&&R<0){if(!isFinite(C))return null;t=C,y=p(t);break}if(t-=R,t<i.compared.sourceZoom||t<i.compared.targetZoom)return null;const E=p(t);if(Math.abs(E-y)/y<=.005)break;y=E}return y>b*(1-.3)||t<i.compared.sourceZoom||t<i.compared.targetZoom?null:t}function JV(i,e){const t=Math.max(i.compared.sourceZoom,i.compared.targetZoom),r=i.source.zoomAtPixelsPerPan(i.desiredPixelFlow/i.compared.pan)/2;return r<t?e.maximumDistance!=null?t+(e.maximumDistance-t)/2:1.5*t:e.maximumDistance?Math.min(e.maximumDistance,r):r}let eG=class extends $V{constructor(e,t){super(),this._preallocSegments=[new k1,new k1,new k1],this._ascensionSegment=null,this._descensionSegment=null,this.update(e,t)}update(e,t){if(!e)return;this.definition?this.definition.copyFrom(e):this.definition=e.clone();let r=null;t&&t.apex&&(r=KV(e,t.apex)),this.segments.length=0,this._ascensionSegment=null,this._descensionSegment=null,r==null?this._updateWithoutApex():this._updateWithApex(r,t==null?void 0:t.apex)}segmentInterpolateComponentsAt(e,t,r){return r=e.interpolateComponentsAt(t,r),e===this._ascensionSegment?r.zoom=uC(r.zoom):e===this._descensionSegment&&(r.zoom=Iv(r.zoom)),r}_updateWithApex(e,t){const[r,s,a]=this._preallocSegments,n=(t==null?void 0:t.ascensionFactor)??.5,o=Math.min(1-n,(t==null?void 0:t.ascensionFactor)!=null&&t.descensionFactor!=null?t.descensionFactor:.5),l=1-n-o;r.definition?r.definition.copyFrom(this.definition):r.definition=this.definition.clone(),r.definition.compared.targetZoom=e,r.definition.compared.pan=this.definition.compared.pan*n,r.definition.compared.rotate=this.definition.compared.rotate*n,r.update(),this._ascensionSegment=r,this.segments.push(r),l>0&&(s.definition?s.definition.copyFrom(this.definition):s.definition=this.definition.clone(),s.definition.copyFrom(this.definition),s.definition.compared.sourceZoom=e,s.definition.compared.targetZoom=e,s.definition.compared.pan=this.definition.compared.pan*l,s.definition.compared.rotate=this.definition.compared.rotate*l,s.update(),this.segments.push(s)),a.definition?a.definition.copyFrom(this.definition):a.definition=this.definition.clone(),a.definition.compared.sourceZoom=e,a.definition.compared.pan=this.definition.compared.pan*o,a.definition.compared.rotate=this.definition.compared.rotate*o,a.update(),this._descensionSegment=a,this.segments.push(a)}_updateWithoutApex(){const[e]=this._preallocSegments;e.update(this.definition),this.segments.push(e)}};const tG={zoom:0,pan:0,rotate:0};let iG=class{get time(){return this._time}constructor(e){this._createCamera=e,this._time=Je(0),this.definition=new LV(e),this.path=new eG}update(e,t,r){this.definition.update(e,t,r),this.path.update(this.definition,r),this._time=this._applyTimeSettings(NA(isFinite(this.path.time)?this.path.time:to(0)),r),this._easing=r.easing?r.easing:this._time>=1e3?wD:qf}cameraAt(e,t){t=t||this._createCamera(),e=Math.min(Math.max(0,e),1),e=this._normalizedEasing(e);const r=this.path.interpolateComponentsAt(e,tG);return t.interpolate(this.definition.source,this.definition.target,r),t}_normalizedEasing(e){const t=this._easing(0,this._time),r=this._easing(1,this._time);return(this._easing(e,this._time)-t)/(r-t)}_applyTimeSettings(e,t){const r=t.speedFactor!=null?t.speedFactor:1;t.duration!=null?e=t.duration:t.speedFactor!=null&&(e=Je(e/r));const s=t.minDuration!=null?t.minDuration:Sy.minDuration/r,a=t.maxDuration!=null?t.maxDuration:Sy.maxDuration/r;return Je(Math.min(Math.max(s,e),a))}};const rG=T();let sG=class{get finished(){return this.currentTime>=this._animation.time}get time(){return this._animation.time}constructor(e){this.currentTime=Je(0),this._animation=new iG(()=>new xP(e)),this._current=new xP(e)}update(e,t,r){const s=this._animation.definition.source,a=this._animation.definition.target,n=Q(rG,t.center,e.center),o=pe(n);o>=1e-5?(n[0]/=o,n[1]/=o,n[2]/=o):(n[0]=0,n[1]=1,n[0]=0),H(s.lookAtDirection,n),H(a.lookAtDirection,n),s.copyFromRenderCamera(e),a.copyFromRenderCamera(t),this._current.copyFrom(s),this._animation.update(s,a,r),this.currentTime=Je(0),e.almostEquals(t)&&(this.currentTime=this._animation.time)}cameraAt(e,t){return this._animation.cameraAt(e,this._current),t=t||new Fe,this._current.copyToRenderCamera(t),t}step(e,t){return this.finished||(this.currentTime=Je(this.currentTime+NA(e)),this.currentTime>=this.time&&(this.currentTime=this.time)),this.cameraAt(this.currentTime/this.time,t)}};var _i;(function(i){i.Ready="ready",i.Rejected="rejected",i.Running="running",i.Stopped="stopped",i.Finished="finished"})(_i||(_i={}));let zl=class extends Ie{constructor(e){super(e),this.state=_i.Ready}get active(){return this.state===_i.Running}get isInteractive(){return!1}get canStop(){return!1}stopController(){return!!this.canStop&&(this.state=_i.Stopped,!0)}finishController(){this.state=_i.Finished}get steppingFinished(){return!1}};d([v({constructOnly:!0})],zl.prototype,"view",void 0),d([v({readOnly:!0})],zl.prototype,"active",null),d([v()],zl.prototype,"state",void 0),d([v({readOnly:!0})],zl.prototype,"isInteractive",null),zl=d([Y("esri.views.3d.state.controllers.CameraController")],zl);let gf=class extends zl{constructor(){super(...arguments),this._asyncResult=null}get canStop(){return!0}set asyncResult(e){this._asyncResult&&(this._asyncResult.reject(ea()),this._asyncResult=null),this.state===_i.Finished||this.state===_i.Stopped?(I4(e),this.state===_i.Finished?e.resolve():e.reject(ea())):this._asyncResult=e}get asyncResult(){return this._asyncResult}onControllerStart(){this.state=_i.Running,g(this.viewAnimation)&&this.viewAnimation.when(()=>this.updateStateFromViewAnimation(),()=>this.updateStateFromViewAnimation())}updateStateFromViewAnimation(){!g(this.viewAnimation)||this.state!==_i.Ready&&this.state!==_i.Running||(this.viewAnimation.state===$p.State.FINISHED?this.finish():this.viewAnimation.state===$p.State.STOPPED&&(this.state=_i.Stopped))}onControllerEnd(){g(this.viewAnimation)&&!this.viewAnimation.done&&(this.state===_i.Finished?this.viewAnimation.finish():this.state===_i.Stopped&&this.viewAnimation.stop()),this._asyncResult&&(this.state===_i.Finished?this._asyncResult.resolve():this._asyncResult.reject(ea()))}finish(){this.finishController()}};gf=d([Y("esri.views.3d.state.controllers.AnimationController")],gf);let Vl=class extends gf{get intersectionHelper(){return this.view.sceneIntersectionHelper}constructor(e){super(e),this.mode="interaction",this._hasTarget=!1}initialize(){this.animation=new sG(this.view.state.viewingMode),this.viewAnimation=this.mode==="interaction"?null:new $p}get isInteractive(){return this.mode==="interaction"}begin(e,t){this._hasTarget=!0;const r=this.animationSettings(t);f_.copyFrom(this.view.state.camera);const s=zn(this.view.state.viewingMode);this.intersectionHelper.intersectRay(f_.ray,s,wP)&&(f_.center=wP),this.animation.update(f_,e,r),this.animation.finished&&this.finish()}finish(){this.animation.currentTime=this.animation.time,super.finish()}get steppingFinished(){return this._hasTarget&&this.animation.finished}stepController(e,t){this._hasTarget&&this.animation.step(e,t)}onControllerEnd(e){this._hasTarget&&(this.animation.cameraAt(this.animation.currentTime/this.animation.time,e),this.animation.currentTime=this.animation.time),super.onControllerEnd(e)}animationSettings(e={}){return{apex:{maximumDistance:this.view.state.constraints.clampAltitude(1/0)/6,ascensionFactor:void 0,descensionFactor:void 0},...e,easing:typeof e.easing=="string"?OV[e.easing]:e.easing}}};d([v({constructOnly:!0})],Vl.prototype,"mode",void 0),d([v({readOnly:!0})],Vl.prototype,"isInteractive",null),Vl=d([Y("esri.views.3d.state.controllers.PointToPointAnimationController")],Vl);const f_=new Fe,wP=T();function Lv(i=nG){return[i[0],i[1],i[2],i[3]]}function ff(i,e){return aG(i[0],i[1],i[2],e,j9.get())}function aG(i,e,t,r,s=Lv()){return s[0]=i,s[1]=e,s[2]=t,s[3]=r,s}function vC(i,e,t){return Be(t,i,e),W(t,t),t[3]=m3(i,e),t}const nG=[0,0,1,0];function CD(i,e,t){return oG(i,i.screenToRender(e,Np(Ve.get())),t)}function oG(i,e,t){const r=Np(fs(Ve.get(),e));if(r[2]=0,!i.unprojectFromRenderScreen(r,t.origin))return null;const s=Np(fs(Ve.get(),e));s[2]=1;const a=i.unprojectFromRenderScreen(s,Ve.get());return P(a)?null:(Q(t.direction,a,t.origin),t)}function nm(i,e,t){return bC(i,i.screenToRender(e,Np(Ve.get())),t)}function bC(i,e,t){H(t.origin,i.eye);const r=j(Ve.get(),e[0],e[1],1),s=i.unprojectFromRenderScreen(r,Ve.get());return P(s)?null:(Q(t.direction,s,t.origin),t)}function xC(i,e,t,r){const s=nm(e,t,lG);return uv(i,s,r)}const lG=Aa();var jp;(function(i){i[i.Ellipsoid=0]="Ellipsoid",i[i.Silhouette=1]="Silhouette"})(jp||(jp={}));const SD=30,Py=[1,3e8],$v=80,PD=8,OD=200,RD=1508e5,ED=5,AD=50,cG=5,hG=10,j1=90,Yd={exclude:new Set([jc])};function Td(i,e,t){return t[0]=e[0]/(i.fullWidth/i.pixelRatio),t[1]=e[1]/(i.fullHeight/i.pixelRatio),t}function aw(i){for(;i>Math.PI;)i-=2*Math.PI;for(;i<-Math.PI;)i+=2*Math.PI;return i}function xh(i,e,t){const r=go(q9.get(),t[3],t);P(r)||L4(r,ph)||(Q(Ft,i.eye,e),xe(Ft,Ft,r),i.eye=X(Ft,Ft,e),Q(Ft,i.center,e),xe(Ft,Ft,r),i.center=X(Ft,Ft,e),i.up=xe(Ft,i.up,r))}function dG(i,e,t,r){return kd(i,CD(e,t,CC),r)}function nw(i,e,t,r){return kd(i,nm(e,t,CC),r)}function wC(i,e,t,r){const s=Ve.get();let a=1-t;Q(s,e,i.eye);const n=pe(s);let o=n*(1-a);a>=0&&o<r&&(o=r,a=-(o-n)/n),Math.abs(n-o)<1e-6||(B(s,s,a),i.eye=X(Ft,i.eye,s),i.center=Gr(Ft,i.center,e,a))}function MD(i,e,t){e.getScreenCenter(TP),xC(i,e,TP,Ft)&&(e.center=Ft);const r=e.distance,s=r*t;if(Math.abs(r-s)<1e-6)return;const a=B(Ve.get(),e.viewForward,s);e.eye=Q(Ft,e.center,a)}const TP=Pi();function q1(i,e){j(e,0,0,0);for(const t of i)X(e,e,t);B(e,e,1/i.length)}function B0(i,e,t,r){return Math.sin(i/pe(e))*(t+r.radius)}function CP(i,e,t,r){return B0(Math.PI/2,e,t,r)+(i-Math.PI/2)}var Rr;(function(i){i[i.Vertical=0]="Vertical",i[i.Horizontal=1]="Horizontal"})(Rr||(Rr={}));const SP={Elevation:3e4,Angle:ut(16)},__={Pole:.95,Angle:ut(18),Tilt:45},DD=ut(80);function ID(i,e,t,r,s,a){const n=T(),o=Nn();let l=!0,c=!0;return i.intersectScreen(t,n,a)?o[3]=pe(n):(c=!1,e.aboveGround&&s!==jp.Ellipsoid?o[3]=Math.max(pe(e.center),.9*r.radius):o[3]=pe(e.eye)-e.relativeElevation,s===jp.Silhouette?_f(o,e,t,n):l=xC(o,e,t,n)),{sphere:o,scenePickPoint:l?n:null,hasGeometryIntersection:c}}function Nv(i,e,t){return pe(i.eye)-t.radius>SP.Elevation?Rr.Horizontal:(nm(i,e,IP),-Math.sign(i.relativeElevation)*(.5*Math.PI+m3(i.eye,IP.direction))<SP.Angle?Rr.Vertical:Rr.Horizontal)}function LD(i,e,t){Q(W1,t,e),i.eye=Q(Ft,i.eye,W1),i.center=Q(Ft,i.center,W1)}const W1=T();function _f(i,e,t,r){const s=nm(e,t,CC);return!P(s)&&(pv(i,s,y_),uv(i,s,r)?!(ol(y_,s.origin)<ol(r,s.origin))||(H(r,y_),!1):(Q(bu,e.eye,e.center),W(bu,bu),w3(bu,-J(W(bu,bu),y_),PP),kd(PP,s,r),!1))}const y_=T(),bu=T(),PP=Ui();function $D(i,e,t,r,s,a){let n=0;if(Be(Ey,i,e),Q(w_,i,e),pe(i)<=s||!r.aboveGround){Be(t,w_,r.eye);const o=J(i,e)/(pe(i)*pe(e));if(o<.9999)n=es(o);else{const c=pe(Be(T(),i,e))/(pe(i)*pe(e));n=ul(c)}const l=Math.cos(ee(lh.normalize(ut(a)),0,DD));n=-n-Math.max(0,pe(e)-s)/(l*s)}else Q(OP,r.eye,r.center),Be(t,w_,OP),n=-pe(w_)/s;return W(t,t),B(t,t,pe(Ey)),n}const OP=T();function RP(i,e,t,r){let s,a;const n=Math.cos(ee(lh.normalize(ut(r)),0,DD));return s=e>t?-(e-t)/(n*t):e<-t?Math.PI-(e+t)/(n*t):es(e/t),a=i>t?-(i-t)/(n*t):i<-t?Math.PI-(i+t)/(n*t):es(i/t),(a-s)*t}function uG(i,e,t,r,s,a,n,o,l,c){const h=RP(i[2],e[2],a[3],o),u=l?RP(i[0],e[0],a[3],180):e[0]-i[0],p=Math.sin(n)*u-Math.cos(n)*h,m=Math.cos(n)*u+Math.sin(n)*h;W(Ft,s);const f=l?p/Math.sqrt(Math.abs(a[3]**2-J(t,Ft)**2)):p/a[3],y=m/Math.sqrt(Math.abs(a[3]**2-J(t,r)**2));zt(c,f,y)}function ND(i,e,t,r,s,a,n,o,l,c){Be(Ey,i,e),Dx(a.up,a.eye,v_,b_,x_),Dx([0,0,1],a.eye,Hl,sh,VD),H(t,sh),H(r,Hl),W(t,t),B(t,t,pe(Ey)),P2(i,W(b_,b_),W(x_,x_),W(v_,v_),EP),P2(e,b_,x_,v_,AP),uG(EP,AP,i,Hl,sh,n,o,l,c,s)}function pG(i,e,t,r,s,a,n){go(Oy,s,r),go(Ry,n,a),pr(mp,Oy,Ry),Q(e,i,t),xe(e,e,mp),X(e,e,t)}function FD(i,e,t,r,s,a){go(Oy,r,t),go(Ry,a,s),pr(mp,Oy,Ry),Q(Ft,i.eye,e),xe(Ft,Ft,mp),i.eye=X(Ft,Ft,e),Q(Ft,i.center,e),xe(Ft,Ft,mp),i.center=X(Ft,Ft,e),Q(Ft,i.up,e),xe(Ft,Ft,mp),i.up=X(Ft,Ft,e)}function TC(i,e,t,r,s,a){return(Math.abs(r)>Math.PI-__.Angle||Math.abs(r)<__.Angle)&&(Math.abs(i[2])<t*__.Pole||Math.abs(e)>t)&&a.aboveGround&&s<__.Tilt}function zD(i,e,t,r,s,a){if(a)vC(t,r,MP),xh(e,i,MP);else{const n=$D(t,r,DP,e,i[3],s);xh(e,i,ff(DP,n))}}function UD(i,e,t,r,s,a,n){const o=n?20:1,l=1e-12;let c,h;H(Mh,r),T_.copyFrom(e);for(let u=0;u<o&&ol(t,Mh)>l&&(c=ol(t,Mh),ND(t,Mh,sh,Hl,xm,T_,i,s,a,n),FD(T_,i,Hl,xm[1],sh,xm[0]),pG(Mh,Mh,i,Hl,xm[1],sh,xm[0]),h=ol(t,Mh),h<c||u===0);u++)e.copyFrom(T_)}function mG(i,e,t,r,s,a,n){TC(t,J(e.up,t),i[3],-lh.normalize(ut(s)),a,e)?UD(i,e,t,r,-lh.normalize(ut(s)),a,n):zD(i,e,t,r,a,n)}function gG(i,e,t,r,s,a){const{eye:n}=i;Dx([0,0,1],n,Hl,sh,VD);const o=e.translation[0]*t.pan,l=s.mode==="zoom"?0:e.translation[1]*t.pan,c=Math.max(Math.sqrt(Math.abs(1-J(i.center,Hl)**2/pe(i.center)**2)),.5),h=(Math.sin(a)*l+Math.cos(a)*o)/c,u=-Math.cos(a)*l+Math.sin(a)*o;switch(Mn(r.pan.matrix,r.pan.matrix,h,Hl),r.pan.enabled=!0,s.mode){case"pan":Mn(r.pan.matrix,r.pan.matrix,u,sh),r.pan.enabled=!0;break;case"zoom":r.zoom=-e.translation[1]*t.zoom}}function fG(i,e,t,r,s){const{eye:a,viewRight:n}=i,o=Be(Ve.get(),n,a),l=e.translation[0]*t.pan;switch(l!==0&&(Mn(r.pan.matrix,r.pan.matrix,-l,o),r.pan.enabled=!0),s.mode){case"pan":{const c=e.translation[1]*t.pan;c!==0&&(Mn(r.pan.matrix,r.pan.matrix,c,n),r.pan.enabled=!0);break}case"zoom":r.zoom=-e.translation[1]*t.zoom}}function _G(i,e,t,r,s,a,n,o,l){TC(i.center,J(i.up,i.center),pe(i.center),-lh.normalize(ut(a)),n,e)?gG(e,t,r,o,l,-lh.normalize(ut(s))):fG(e,t,r,o,l)}const Hl=T(),sh=T(),VD=T(),v_=T(),b_=T(),x_=T(),EP=T(),AP=T(),xm=$e(),MP=Lv(),Oy=ce(),Ry=ce(),mp=ce(),Mh=T(),Ft=T(),w_=T(),T_=new Fe,Ey=T(),DP=T(),CC={origin:T(),direction:T()},IP={origin:T(),direction:T()},LP=.6,X1=4,yG=60;let Ay=class extends Vl{constructor(){super(...arguments),this._zoomLocation=T(),this._tmpCamera=new Fe,this._tmpViewDir=T(),this._tmpRayDir={origin:T(),direction:T()},this._targetOnSphere=T(),this._tmpCenter=T(),this._constraintOptions={selection:Xt.ALL_EXCEPT_COLLISION,interactionType:et.ZOOM,interactionFactor:null,interactionStartCamera:new Fe,interactionDirection:null,tiltMode:Er.TUMBLE},this._sphere=Nn()}initialize(){this._intersector=zn(this.view.state.viewingMode)}zoomStep(e,t){if(!this.active)return;const r=this.view.state,{interactionStartCamera:s}=this._constraintOptions;s&&(this.animation.finished?s.copyFrom(r.camera):this.animation.cameraAt(1,s));let a=!1,n=!1;this.intersectionHelper.intersectScreen(t,this._zoomLocation,this.view.map.ground.opacity===0?Yd:{})&&(a=e>0,n=!0),this._tmpCamera.copyFrom(r.camera),a?this.intersectionHelper.intersectRay(this._tmpCamera.ray,this._intersector,this._tmpCenter)&&(this._tmpCamera.center=this._tmpCenter):this.intersectionHelper.intersectRay(this._tmpCamera.ray,this._intersector,this._zoomLocation)?this._tmpCamera.center=this._zoomLocation:H(this._zoomLocation,this._tmpCamera.center),this._updateCamera(this._tmpCamera,e,this._zoomLocation,t,n),this.begin(this._tmpCamera)}animationSettings(){return{duration:Je(600),easing:qf}}_updateCamera(e,t,r,s,a){const n=Et(this.view.spatialReference),o=Nv(e,s,n),l=Math.abs(this.view.camera.position.z);W(S_,e.eye),B(S_,S_,-1),nm(e,s,this._tmpRayDir),W(this._tmpRayDir.direction,this._tmpRayDir.direction);const c=ee(Math.min(PD,1/Math.abs(J(S_,this._tmpRayDir.direction)))*l,OD,RD);if(o===Rr.Horizontal){let h=LP**t;this._sphere[3]=pe(r),Q(this._tmpViewDir,e.center,e.eye);const u=Math.min(pe(this._tmpViewDir),c);let p=u*h;if(h<=1&&p<X1&&(p=X1,h=p/u),Math.abs(u-p)<1e-6)return;const m=pe(e.center);if(this._sphere[3]!==m){const f=this._sphere[3]+h*(m-this._sphere[3]);e.center=B(C_,e.center,f/m)}B(this._tmpViewDir,this._tmpViewDir,-h),e.eye=X(C_,e.center,this._tmpViewDir),Fi(this.view,e,this._constraintOptions),ol(r,e.center)>1e-12&&xC(this._sphere,e,s,this._targetOnSphere)&&mG(this._sphere,e,r,this._targetOnSphere,this.view.camera.heading,this.view.camera.tilt,!0)}else{let h=LP**Math.abs(t);const u=t>0?1:-1;Q(this._tmpViewDir,r,e.eye);const p=pe(this._tmpViewDir),m=this.view._stage.renderView.getMinimalDepthForArea(null,s[0],s[1],this.view.state.camera,yG);let f=g(m)?m:c;f=a&&t>0?Math.min(f,p):f,B(this._tmpRayDir.direction,this._tmpRayDir.direction,f),X(r,this._tmpRayDir.origin,this._tmpRayDir.direction);let y=f*h;const b=Math.max(X1,1.01*e.nearFar[0]);if(t>0&&y<b&&(y=b,h=y/f),Math.abs(f-y)<1e-6)return;B(this._tmpRayDir.direction,this._tmpRayDir.direction,u*(1-h)),e.eye=X(C_,e.eye,this._tmpRayDir.direction),e.center=X(C_,e.center,this._tmpRayDir.direction)}am(this.view,e)}};Ay=d([Y("esri.views.3d.state.controllers.global.ZoomStepController")],Ay);const C_=T(),S_=T(),vG=.6,bG=4,xG=60;let My=class extends Vl{constructor(){super(...arguments),this._zoomLocation=T(),this._tmpCamera=new Fe,this._tmpRayDir=T(),this._tmpCenter=T(),this._constraintOptions={selection:Xt.ALL,interactionType:et.ZOOM,interactionFactor:null,interactionStartCamera:new Fe,interactionDirection:null,tiltMode:Er.TUMBLE}}zoomStep(e,t){if(!this.active)return;const r=this.view.state,{interactionStartCamera:s}=this._constraintOptions;s&&(this.animation.finished?s.copyFrom(r.camera):this.animation.cameraAt(1,s)),this._tmpCamera.copyFrom(r.camera);const a=zn(this.view.state.viewingMode);let n=!1;e>0?(n=this.intersectionHelper.intersectScreenFreePointFallback(t,this._zoomLocation,this.view.map.ground.opacity===0?Yd:{}),this.intersectionHelper.intersectRay(this._tmpCamera.ray,a,this._tmpCenter)&&(this._tmpCamera.center=this._tmpCenter)):this.intersectionHelper.intersectRay(this._tmpCamera.ray,a,this._zoomLocation)?this._tmpCamera.center=this._zoomLocation:H(this._zoomLocation,this._tmpCamera.center);const o=vG**e;let l=this.view._stage.renderView.getMinimalDepthForArea(this.view.voxelWasm,t[0],t[1],this.view.state.camera,xG);Q(P_,this._tmpCamera.eye,this._zoomLocation),W(P_,P_);const c=ee(Math.min(PD,1/Math.abs(J(wG,P_)))*Math.abs(this.view.camera.position.z),OD,RD);if(l=g(l)?l:c,l){const h=T();Q(h,this._zoomLocation,this._tmpCamera.eye),(l<pe(h)||!n)&&(W(h,h),X(this._zoomLocation,this._tmpCamera.eye,B(h,h,l)))}this._updateCamera(this._tmpCamera,o,this._zoomLocation),this.begin(this._tmpCamera)}animationSettings(){return{duration:Je(600),easing:qf}}_updateCamera(e,t,r){Q(this._tmpRayDir,r,e.eye);const s=pe(this._tmpRayDir);let a=s*t;const n=t<=1,o=Math.max(bG,1.01*e.nearFar[0]);a!==0&&(n&&a<o&&(a=o,t=a/s),Math.abs(s-a)<1e-6||(B(this._tmpRayDir,this._tmpRayDir,t),e.eye=Q($P,r,this._tmpRayDir),e.center=Gr($P,e.center,r,1-t),Fi(this.view,e,this._constraintOptions)))}};My=d([Y("esri.views.3d.state.controllers.local.ZoomStepController")],My);const $P=T(),wG=Ge(0,0,1),P_=T();let TG=class extends wo{constructor(e,t){super(!0),this._view=e,this.registerIncoming("double-click",t,r=>this._handleDoubleClick(r))}_handleDoubleClick(e){const t=e.data;if($4(t,"primary")){const r=this._view.state.isGlobal?new Ay({view:this._view,mode:"animation"}):new My({view:this._view,mode:"animation"});this._view.state.switchCameraController(r),r.zoomStep(Math.log(.5)/Math.log(.6),Pi(t.x,t.y)),e.stopPropagation()}}};function CG(i,e,t){return i===ve.Global?new PG(t):new SG(e,t)}let SG=class{constructor(e,t){this._elevationProvider=e,this._referenceEllipsoid=Et(t),this._unitInMeters=Hd(t,this._referenceEllipsoid.metersPerDegree)}compute(e,t,r,s,a){var C;a||(a={near:0,far:0});let n=e[2]*this._unitInMeters;const o=n,l=n-s,c=(C=this._elevationProvider)==null?void 0:C.visibleElevationBounds;c&&(n=l>=0?o-this._unitInMeters*c.min:this._unitInMeters*c.max-o);const h={x:(r=g(r)?r:new ds({xmin:0,ymin:0,zmin:0,xmax:0,ymax:0,zmax:0})).xmax-r.xmin,y:r.ymax-r.ymin,z:4*Math.max(r.xmax-r.xmin,r.ymax-r.ymin)},u=Math.max(h.x,h.y,h.z);Q(Dh,t,e),xu[0]=Dh[0]>0?r.xmax:r.xmin,xu[1]=Dh[1]>0?r.ymax:r.ymin,xu[2]=Dh[2]>0?u/2:-u/2,Q(xu,xu,e),W(Dh,Dh);const p=1.1*J(xu,Dh)*this._unitInMeters,m=Math.sqrt(n*(n+2*this._referenceEllipsoid.radius)),f=Math.max(r.xmax-r.xmin,r.ymax-r.ymin),y=f*EG*this._unitInMeters,b=f*AG*this._unitInMeters,x=ee((n-b)/(y-b),0,1)**3,S=Math.min(st(m,p,x),m)*Math.max(Math.log(Math.abs(l)),1);return GD(Math.min(S,Math.max(34064e4,u))/this._unitInMeters,OG,this._unitInMeters,a)}},PG=class{constructor(e){this._referenceEllipsoid=Et(e)}compute(e,t,r,s,a){a||(a={near:0,far:0});const n=pe(e),o=n-this._referenceEllipsoid.radius,l=this._referenceEllipsoid.radius+Math.min(0,s),c=Math.abs(o-s),h=Math.max(c,Math.abs(o)),u=Math.sqrt(h*(h+2*l)),p=n+this._referenceEllipsoid.radius;return GD(1.2*st(u,p,eC(h)),ee(2e4-(Math.log(h)-7.983)/9.011*19e3,1e3,2e4),1,a)}};function GD(i,e,t,r){const s=RG/t;return i/e>s?(r.far=i,r.near=r.far/e):(r.near=s,r.far=r.near*e),r}const OG=2e4,RG=2,EG=.001,AG=1e-4,xu=T(),Dh=T();let H0=class extends Ie{constructor(e){super(e)}initialize(){this.addHandles(this.view.basemapTerrain.on("elevation-change",e=>this._handleElevationChangeEvent(e)))}_handleElevationChangeEvent(e){if(this.view.state.cameraController)return;const t=this.view.state.camera;g(e.spatialReference)&&pD(this.view,t,e.extent,e.spatialReference)&&this._applyToCurrentCamera()}_applyToCurrentCamera(){this.view.state.updateCamera(e=>am(this.view,e,Dn.EYE_AND_CENTER))}};d([v({constructOnly:!0})],H0.prototype,"view",void 0),H0=d([Y("esri.views.3d.state.ElevationCollisionConstraint")],H0);let lg=class extends Ie{constructor(e){super(e),this.nearFarHeuristic=CG(e.view.state.viewingMode,e.view.basemapTerrain,e.view.renderCoordsHelper.spatialReference)}initialize(){this.addHandles([te(()=>{var e,t,r,s;return[(t=(e=this.view.constraints)==null?void 0:e.clipDistance)==null?void 0:t.near,(s=(r=this.view.constraints)==null?void 0:r.clipDistance)==null?void 0:s.far]},()=>this._clipDistanceNearFarChanged()),te(()=>{var e,t;return(t=(e=this.view.constraints)==null?void 0:e.clipDistance)==null?void 0:t.mode},()=>this._updateNearFar()),this.view.state.events.on("before-camera-change",e=>this._updateCameraNearFar(e)),te(()=>this.view.renderDataExtent,()=>this._updateNearFar(),Bt),te(()=>{var e,t,r,s;return[(t=(e=this.view.constraints)==null?void 0:e.altitude)==null?void 0:t.min,(s=(r=this.view.constraints)==null?void 0:r.altitude)==null?void 0:s.max]},()=>this._updateAltitude(),Bt),te(()=>{var e,t;return(t=(e=this.view.constraints)==null?void 0:e.tilt)==null?void 0:t.max},()=>this._updateTiltMax(),Bt),te(()=>{var e,t;return(t=(e=this.view.constraints)==null?void 0:e.tilt)==null?void 0:t.mode},()=>this._updateTilt(),Bt),te(()=>{var e;return(e=this.view.state)==null?void 0:e.camera},()=>this._updateTiltAutoMax(),Bt),te(()=>{var e,t,r,s,a,n;return[(r=(t=(e=this.view.map)==null?void 0:e.ground)==null?void 0:t.navigationConstraint)==null?void 0:r.type,(n=(a=(s=this.view.state)==null?void 0:s.constraints)==null?void 0:a.collision)==null?void 0:n.enabled]},()=>this._updateCollision(),Bt)]),this.view.state.isLocal&&this.addHandles(te(()=>this.view.renderDataExtent,e=>this._updateLocalSurfaceDistance(e),Ji)),this._updateNearFar(),this.view.state.viewingMode!==ve.Local&&this._updateAltitude(),this._updateTilt(),this._updateCollision(),this._set("surfaceCollisionConstraint",new H0({view:this.view}))}destroy(){this.surfaceCollisionConstraint&&(this.surfaceCollisionConstraint.destroy(),this._set("surfaceCollisionConstraint",null))}_clipDistanceNearFarChanged(){var t;const e=(t=this.view.constraints)==null?void 0:t.clipDistance;e&&e.mode!=="auto"&&this.view.state.updateCamera(r=>this._updateCameraNearFarManual(r,e))}_updateNearFar(){this.view.state.updateCamera(e=>this._updateCameraNearFar(e))}_updateCameraNearFar(e){const t=this.view.constraints&&this.view.constraints.clipDistance;(t?t.mode:"auto")==="manual"?this._updateCameraNearFarManual(e,t):this._updateCameraNearFarAuto(e,t)}_updateCameraNearFarAuto(e,t){this.nearFarHeuristic.compute(e.eye,e.center,this.view.renderDataExtent,Dv(this.view,e.eye),e),t&&t.autoUpdate(e.near,e.far)}_updateCameraNearFarManual(e,t){t&&(e.near=t.near,e.far=t.far)}_updateCollision(){var s,a,n;const e=(n=(a=(s=this.view.map)==null?void 0:s.ground)==null?void 0:a.navigationConstraint)==null?void 0:n.type,t=!e||e==="stay-above",r=this.view.state.constraints.collision;if(t!==r.enabled){r.enabled=t,t&&this._reapplyConstraints(Xt.COLLISION);const o=this.view.constraints&&this.view.constraints.tilt;o&&o.mode!=="auto"||this._updateTiltAuto()}}_updateAltitude(){const e=this.view.constraints&&this.view.constraints.altitude;e&&this.view.state.viewingMode!==ve.Local?this.view.state.constraints.altitude={min:e.min,max:e.max}:this.view.state.constraints.altitude=null,this._reapplyConstraints()}_updateTiltMax(){const e=this.view.constraints&&this.view.constraints.tilt;e&&e.mode!=="auto"&&(this._updateTiltManual(e),this._reapplyConstraints())}_updateTilt(){const e=this.view.constraints&&this.view.constraints.tilt;(e?e.mode:"auto")==="manual"?this._updateTiltManual(e):this._updateTiltAuto(),this._reapplyConstraints()}_updateTiltManual(e){const t=this.view.state.constraints;t.tilt=t.createConstantMaxTilt(ut(e.max))}_updateTiltAuto(){const e=this.view.state.constraints;e.tilt=e.createDefaultTilt(),this._updateTiltAutoMax()}_updateTiltAutoMax(){const e=this.view.constraints&&this.view.constraints.tilt;if(!e||e.mode!=="auto")return;const t=this.view.state.constraints;if(t.tilt){const r=t.tilt(this.view.state.camera.distance).max;e.autoUpdate(ln(r))}}_updateLocalSurfaceDistance(e){if(P(e))return;let t=Math.max(e.width,e.height);if(t<=0)return;e.zmax!=null&&e.zmin!=null&&(t=Math.max(t,e.zmax-e.zmin));const r=this.view.state,s=3*t/Math.atan(r.camera.fov/2);s!==r.constraints.distance&&(r.constraints.distance=s)}_reapplyConstraints(e=Xt.ALL){this.view.state.updateCamera(t=>Fi(this.view,t,{selection:e,interactionType:et.NONE,interactionFactor:null,interactionStartCamera:null,interactionDirection:null,tiltMode:Er.TUMBLE}))}};d([v({constructOnly:!0})],lg.prototype,"view",void 0),d([v({readOnly:!0})],lg.prototype,"surfaceCollisionConstraint",void 0),lg=d([Y("esri.views.3d.state.ConstraintsManager")],lg);let Wc=class{get planes(){return this.frustum}get points(){return this._points}get mutablePoints(){return this._points}get direction(){return this._direction}constructor(e){this.renderCoordsHelper=e,this.frustum=tf(),this._points=h6(),this.lines=new Array(12),this._origin=T(),this._direction=T(),this._altitude=null;for(let t=0;t<12;t++)this.lines[t]={origin:null,direction:T(),endpoint:null}}update(e){rM(e.viewMatrix,e.projectionMatrix,this.frustum,this._points),H(this._origin,e.eye),H(this._direction,e.viewForward),this._altitude=this.renderCoordsHelper.getAltitude(this._origin),this._updateLines()}updatePoints(e){for(let t=0;t<this._points.length;t++)H(this._points[t],e[t]);d6(this.frustum,this._points),this._updateLines()}get altitude(){return this._altitude}intersectsSphere(e){return xv(this.frustum,e)}intersectsRay(e){return u6(this.frustum,e)}intersectsLineSegment(e,t){return p6(this.frustum,e,t)}intersectsPoint(e){return sM(this.frustum,e)}_updateLines(){const e=this._points;for(let t=0;t<4;t++){const r=t+4;Q1(this.lines[t],e[t],e[r]),Q1(this.lines[t+4],e[t],t===3?e[0]:e[t+1]),Q1(this.lines[t+8],e[r],t===3?e[4]:e[r+1])}}};function Q1(i,e,t){i.origin=e,i.endpoint=t,Bd(i.direction,e,t)}Wc.planePointIndices=m6,Wc.nearFarLineIndices=[[ei.NEAR_BOTTOM_LEFT,ei.FAR_BOTTOM_LEFT],[ei.NEAR_BOTTOM_RIGHT,ei.FAR_BOTTOM_RIGHT],[ei.NEAR_TOP_RIGHT,ei.FAR_TOP_RIGHT],[ei.NEAR_TOP_LEFT,ei.FAR_TOP_LEFT]];let Pg=class extends zl{set desiredCamera(e){this._set("desiredCamera",e.clone())}constructor(e){super(e),this._handles=new Vi}get canStop(){return!0}get constraintEnabled(){return this.view.state.constraints.collision.enabled}onControllerStart(){this.state=_i.Running,this._handles.add(this.view.basemapTerrain.on("elevation-change",e=>this._handleElevationChangeEvent(e))),this._applyCorrection()}onControllerEnd(){this._handles.removeAll()}stepController(){}_handleElevationChangeEvent(e){g(e.spatialReference)&&!pD(this.view,this.desiredCamera,e.extent,e.spatialReference)||this._applyCorrection()}_applyCorrection(){this.view.state.updateCamera(e=>{e.copyViewFrom(this.desiredCamera),am(this.view,e,Dn.EYE_AND_CENTER)||this.constraintEnabled||(this.state=_i.Stopped)})}};d([v({constructOnly:!0})],Pg.prototype,"desiredCamera",null),Pg=d([Y("esri.views.3d.state.controllers.SurfaceCollisionCorrectionController")],Pg);const MG=T(),O_=T();function SC(){return{direction:T(),up:T()}}function BD(i,e,t,r,s){let a=W(MG,i),n=J(a,r);const o=n>0;n=Math.abs(n),n>.99&&(n=Math.abs(J(e,r)),n<.99?(H(a,e),o&&B(a,a,-1)):a=null);let l=0;if(a){B(O_,r,J(r,a)),Q(a,a,O_);const h=J(a,s)/(pe(a)*pe(s));Be(O_,a,s),l=(J(O_,r)>0?1:-1)*ln(es(h))}const c=ln(es(-J(r,i)/pe(i)));return t?(t.heading=l,t.tilt=c,t):{heading:l,tilt:c}}const HD=Ge(0,1,0),kD=Ge(0,0,1),wm=ce(),xl=T(),wl=T();function jD(i,e,t,r=SC()){const{direction:s,up:a}=r;return N4(wm,-ut(e)),Hg(wm,wm,ut(t)),xe(s,kD,wm),B(s,s,-1),xe(a,HD,wm),r}function DG(i,e,t,r){return BD(e,t,r,kD,HD)}function IG(i,e,t,r){const s=jD(i,t,r),a=T();return B(a,s.direction,-e),X(a,a,i),{up:s.up,eye:a,heading:t,tilt:r}}function LG(i){return ln(i)}function $G(i){return ut(i)}function qD(i,e,t,r,s){const a=i.renderSpatialReference,n=i.map&&i.spatialReference||e.spatialReference;return ts(e,xl,a),ts(e,wl,a),xl[0]-=t/2,wl[0]+=t/2,xl[1]-=r/2,wl[1]+=r/2,Jr(xl,a,xl,n),Jr(wl,a,wl,n),s?(s.xmin=xl[0],s.ymin=xl[1],s.xmax=wl[0],s.ymax=wl[1],s.spatialReference=n):s=new ds(xl[0],xl[1],wl[0],wl[1],n),s}const NG=Object.freeze(Object.defineProperty({__proto__:null,directionToHeadingTilt:DG,eyeForCenterWithHeadingTilt:IG,eyeTiltToLookAtTilt:$G,headingTiltToDirectionUp:jD,lookAtTiltToEyeTilt:LG,toExtent:qD},Symbol.toStringTag,{value:"Module"})),WD=Ge(0,0,1),XD=W(T(),Ge(1,1,1)),FG=new kg(-180,180),Tm=ce(),Gc=T(),wu=T();function QD(i,e,t,r=SC()){Be(Gc,i,WD),J(Gc,Gc)===0&&Be(Gc,i,XD),go(Tm,-ut(e),i),Mn(Tm,Tm,-ut(t),Gc);const{up:s,direction:a}=r;return Be(s,Gc,i),W(s,s),xe(s,s,Tm),W(a,i),oa(a,a),xe(a,a,Tm),r}function zG(i,e,t,r){const s=Gc,a=wu;return W(s,i),Be(wu,s,WD),J(wu,wu)===0&&Be(wu,s,XD),Be(a,wu,s),BD(e,t,r,s,a)}function UG(i,e,t,r){const s={eye:T(),up:null,tilt:r,heading:t},a=Gc;a[0]=i[0],a[1]=i[2],a[2]=-i[1];const n=e,o=ut(t),l=ut(r),c=Math.sin(o),h=Math.cos(o),u=Math.sin(l),p=Math.cos(l),m=pe(a);let f;if(Math.abs(l)<1e-8)f=n+m;else{const I=m/u,U=ul(n/I),V=Math.PI-l-U;f=I*Math.sin(V)}const y=p*n,b=n*n*(u*u),x=h*h*b,S=f-y,C=S*S,O=x*(x+C-a[1]*a[1]);if(O<0)return B(s.eye,a,f/m),s.tilt=0,R_(s,i);const R=Math.sqrt(O),E=a[1]*S,$=x+C;let M;if(M=h>0?-R+E:R+E,Math.abs($)<1e-8)return m<1e-8?(s.eye[0]=0,s.eye[1]=0,s.eye[2]=n):B(s.eye,a,f/m),s.tilt=0,Z1(s.eye),R_(s,i);s.eye[1]=M/$;const L=c*c*b,F=u*n,N=h*F*s.eye[1],G=s.eye[1]*s.eye[1],q=1-G,se=Math.sqrt(q),k=x*G+L-2*N*se*S+q*C;return Math.abs(k)<1e-8?(B(s.eye,a,f/m),s.tilt=0,Z1(s.eye),R_(s,i)):(s.eye[0]=(q*(f*a[0]-y*a[0])-F*se*(a[0]*s.eye[1]*h+a[2]*c))/k,s.eye[2]=(q*(f*a[2]-y*a[2])-F*se*(a[2]*s.eye[1]*h-a[0]*c))/k,B(s.eye,s.eye,f),Z1(s.eye),R_(s,i))}function Z1(i){const e=i[1];i[1]=-i[2],i[2]=e}function R_(i,e){const t=QD(e,i.heading,i.tilt);return i.up=t.up,i}function VG(i,e,t){const r=pe(e),s=Math.sqrt(t*t+r*r-2*t*r*Math.cos(Math.PI-i)),a=ul(t/(s/Math.sin(i)));return ln(i-a)}function GG(i,e,t){const r=ut(i),s=pe(e);return ul(t/(s/Math.sin(r)))+r}function ZD(i,e,t,r,s){let a,n,o,l;const c=e.latitude,h=Et(i.spatialReference).radius,u=e.longitude,p=rU(c,t,h)/2;a=u-p,n=u+p;const m=ut(c),f=(1+Math.sin(m))/(1-Math.sin(m)),y=(f+1)*Math.tan(r/h/2),b=y*y;function x(C){const O=Math.PI/2;return(C=z4.normalize(C,-O))>O&&(C=Math.PI-C),C}if(o=1.5*Math.PI-2*Math.atan(.5*(y+Math.sqrt(4*f+b))),l=o+r/h,o=x(o),l=x(l),l<o){const C=l;l=o,o=C}if(o=Math.max(ln(o),-90),l=Math.min(ln(l),90),n=FG.monotonic(a,n),n-a>180){const C=(n-a-180)/2;a+=C,n-=C}const S=i.spatialReference&&i.spatialReference.isGeographic?i.spatialReference:li.WGS84;return s?(s.xmin=a,s.ymin=o,s.xmax=n,s.ymax=l,s.spatialReference=S):s=new ds(a,o,n,l,S),i.spatialReference&&i.spatialReference.isWebMercator&&F4(s,!1,s),s}const BG=Object.freeze(Object.defineProperty({__proto__:null,directionToHeadingTilt:zG,eyeForCenterWithHeadingTilt:UG,eyeTiltToLookAtTilt:GG,headingTiltToDirectionUp:QD,lookAtTiltToEyeTilt:VG,toExtent:ZD},Symbol.toStringTag,{value:"Module"}));function Dy(i){return i.type==="point"}let YD=class{constructor(e,t=null,r=0){this.array=e,this.spatialReference=t,this.offset=r}};function KD(i){return"array"in i}function rl(i,e,t="ground"){if(Dy(e))return i.getElevation(e.x,e.y,e.z||0,e.spatialReference,t);if(KD(e)){let r=e.offset;return i.getElevation(e.array[r++],e.array[r++],e.array[r]||0,je(e.spatialReference,i.spatialReference),t)}return i.getElevation(e[0],e[1],e[2]||0,i.spatialReference,t)}function Iy(i,e){return i!=null&&(e==null||(e===ve.Local?!i.isGeographic||i.isWGS84||i.wkid===gm.CGCS2000:i.isWebMercator||i.isWGS84||i.wkid===gm.CGCS2000||i.wkid===gm.GCSMARS2000||i.wkid===gm.GCSMARS2000_SPHERE||i.wkid===gm.GCSMOON2000))}const JD=Pe.getLogger("esri.views.3d.support.cameraUtils"),eI=39.37,tI=96,ow=1,HG=8,kG=5,iI=1,NP=T(),jG={heading:0,tilt:0},Xc=new Ht,qG=new kg(-20037508342788905e-9,20037508342788905e-9),WG=new kg(-180,180);var Yr;function Wf(i){return i.spatialReference||li.WGS84}function om(i){return i.viewingMode==="global"?BG:NG}function XG(i,e,t,r,s){return om(i).headingTiltToDirectionUp(e,t,r,s)}function Nl(i,e){if(P(e))return null;const t=i.renderSpatialReference,r=om(i).headingTiltToDirectionUp,s=T();if(!ts(e.position,s,t))return null;const a=r(s,e.heading,e.tilt);B(a.direction,a.direction,i.state.camera.distance),X(a.direction,a.direction,s);const n=Zd(i,s,a.direction,a.up);return n.fov=ut(e.fov),n}(function(i){i[i.LOCKED=0]="LOCKED",i[i.ADJUST=1]="ADJUST"})(Yr||(Yr={}));const Tu=T();function qp(i,e,t){const r=i.renderSpatialReference,s=Fv(i,e.eye,e.viewForward,e.up,jG);let a=Wf(i);return Jr(e.eye,r,Tu,a)||(a=li.WGS84,Jr(e.eye,r,Tu,a)),P(t)?new vo(new Ht(Tu,a),s.heading,s.tilt,ln(e.fov)):(t.position.x=Tu[0],t.position.y=Tu[1],t.position.z=Tu[2],t.position.spatialReference=a,t.heading=s.heading,t.tilt=s.tilt,t.fov=ln(e.fov),t)}function PC(i,e,t){const r=i.state.camera,s=r.width/2/r.pixelRatio;return i.renderCoordsHelper.viewingMode===ve.Global&&t!=null&&(e*=Math.cos(ut(t))),e/=i.renderCoordsHelper.unitInMeters,s/(tI*eI/e)/Math.tan(r.fovX/2)}function $d(i,e,t){const r=i.state.camera,s=e*Math.tan(r.fovX/2),a=r.width/2/r.pixelRatio;let n=tI*eI/(a/s);return i.renderCoordsHelper.viewingMode===ve.Global&&t!=null&&(n/=Math.cos(ut(t))),n*=i.renderCoordsHelper.unitInMeters,n}function rI(i,e,t,r,s,a){return sI(i,e,PC(i,t,e.latitude),r,s,a)}function sI(i,e,t,r,s,a){if(Cd(a)){const o=new lm(a.signal);return yf(i,r.heading,r.tilt,e,t,s,o),void o.resolver.promise.then(l=>{const c=$y(i,l,r.fov);if(!P(c))return a.resolver.resolve(c);a.resolver.reject()},l=>a.resolver.reject(l))}const n=yf(i,r.heading,r.tilt,e,t,s);return $y(i,n,r.fov,a)}function Fv(i,e,t,r,s){return om(i).directionToHeadingTilt(e,t,r,s)}function QG(i,e){return!!(i.basemapTerrain&&i.renderCoordsHelper.fromRenderCoords(e,Xc,i.spatialReference)&&i.elevationProvider&&je(rl(i.elevationProvider,Xc),0)>(Xc.z??0)-iI)}async function ZG(i,e,t){if(!i.renderCoordsHelper.fromRenderCoords(e,Xc,i.spatialReference)||!i.elevationProvider)return!1;const r=Xc.z??0,s=await i.elevationProvider.queryElevation(Xc.x,Xc.y,r,Xc.spatialReference,"ground",t);return je(s,0)>r-iI}async function YG(i,e,t){const r=T();if(e)if(e instanceof Ht){if(ts(e,r,i.renderSpatialReference),e.z==null&&i.basemapTerrain!=null&&i.elevationProvider!=null){const s=await i.elevationProvider.queryElevation(e.x,e.y,e.z??0,e.spatialReference,"ground",t);return g(s)&&i.renderCoordsHelper.setAltitude(r,s),r}}else H(r,e);else H(r,i.state.camera.center);return r}function KG(i,e){const t=T();if(e&&e instanceof Ht){if(ts(e,t,i.renderSpatialReference),e.z==null&&i.basemapTerrain!=null&&i.elevationProvider!=null){const r=rl(i.elevationProvider,e);g(r)&&i.renderCoordsHelper.setAltitude(t,r)}}else H(t,e||i.state.camera.center);return t}function yf(i,e,t,r,s,a,n){const o=r&&r instanceof Ht?r:null;if(Cd(n))return YG(i,r,n.signal).then(c=>{lw(i,e,t,o,c,s,a,n)},c=>n.resolver.reject(c)),null;const l=KG(i,r);return lw(i,e,t,o,l,s,a,n)}function lw(i,e,t,r,s,a,n,o){if(P(r)){const u=i.renderSpatialReference;if(r=ch(s,u,Wf(i)),P(r))return null}a=Math.max(a,i.state.constraints.minimumPoiDistance);const l=tB(i,e,t,s,a,n),c=(0,om(i).eyeForCenterWithHeadingTilt)(s,a,l.heading,l.tilt);if(n===Yr.ADJUST&&i.viewingMode==="global"&&t>0){const u=()=>{const m=aI(i,s,a,rB(i,a,t,s));return n=t-m<1?Yr.LOCKED:Yr.ADJUST,lw(i,e,m,r,s,a,n,o)},p=i.map.ground.navigationConstraint;if(!p||p.type==="stay-above"){if(QG(i,c.eye))return u();if(Cd(o))return ZG(i,c.eye,o.signal).then(m=>m?u():(o.resolver.resolve({eye:c.eye,up:c.up,center:aa(s),heading:c.heading,tilt:c.tilt}),null)),null}}const h=!o||Cd(o)?{center:T(),eye:T(),up:T(),tilt:0,heading:0}:o;return h.eye=c.eye,h.up=c.up,h.center=aa(s),h.heading=c.heading,h.tilt=c.tilt,Cd(o)&&o.resolver.resolve(h),h}function Og(i,e,t,r,s,a=null){let n,o,l;if(i.state.isGlobal){if(!Iy(e.spatialReference,ve.Global))return Cd(a)&&a.resolver.reject(),null;const b=new Ht(e.xmin,e.ymin,e.spatialReference),x=new Ht(e.xmax,e.ymax,e.spatialReference),S=e.spatialReference.isGeographic?WG:qG;n=new Ht({x:S.center(b.x,x.x),y:(x.y+b.y)/2,z:e.zmax!=null&&e.zmin!=null?(e.zmax+e.zmin)/2:void 0,spatialReference:e.spatialReference});const C=Et(e.spatialReference),O=iU(n,b,x);o=O.lon,l=O.lat,S.diff(b.x,x.x)>S.range/2&&(o+=C.halfCircumference),o=Math.min(o,C.halfCircumference),l=Math.min(l,C.halfCircumference)}else{const b=je(i.renderSpatialReference,e.spatialReference);b.equals(e.spatialReference)||(e=oT(e,b)),o=e.xmax-e.xmin,l=e.ymax-e.ymin;const x=e.zmax!=null&&e.zmin!=null?(e.zmax+e.zmin)/2:void 0;n=new Ht({x:e.xmin+.5*o,y:e.ymin+.5*l,z:x,spatialReference:b})}const c=e.zmax!=null&&e.zmin!=null?e.zmax-e.zmin:0,h=i.state.camera,u=1/Math.tan(h.fovX/2),p=1/Math.tan(h.fovY/2),m=1/Math.tan(h.fov/2),f=Math.max(.5*o*u,.5*l*p,.5*c*m)/ow;if(Cd(a)){const b=new lm(a.signal);return yf(i,t,r,n,f,s,b),void b.resolver.promise.then(x=>{const S=$y(i,x,i.camera.fov);if(!P(S))return a.resolver.resolve(S);a.resolver.reject()},x=>a.resolver.reject(x))}const y=yf(i,t,r,n,f,s);return $y(i,y,i.camera.fov,a)}function JG(i,e,t){const r=i.renderSpatialReference,s=ch(t,r,Wf(i));if(P(s))return null;const a=Math.tan(e.fovX/2),n=Math.tan(e.fovY/2),o=lT(e.eye,t),l=2*o*a*ow,c=2*o*n*ow;return i.viewingMode==="global"?ZD(i,s,l,c):qD(i,s,l,c)}function eB(i,e,t){const r=i.pointsOfInterest.centerOnSurfaceFrequent.distance;if(Math.log(t/r)/Math.LN2>HG)return!0;const s=i.renderSpatialReference,a=Wf(i),n=ch(e,s,a),o=ch(i.pointsOfInterest.centerOnSurfaceFrequent.renderLocation,s,a);if(P(n)||P(o))return!1;const l=Math.tan(.5*i.state.camera.fov)*r;return o.distance(n)/l>kG}function tB(i,e,t,r,s,a){let n=0;return a===Yr.ADJUST&&eB(i,r,s)?(e=0,n=iB(i,s,t,r)):n=OC(i,r,s,t),n=i.state.constraints.clampTilt(s,n),{heading:e,tilt:t=aI(i,r,s,n)}}const Ly=.7;function iB(i,e,t,r){const s=OC(i,r,e,t);if(!i.state.constraints.tilt)return s;const a=i.state.constraints.tilt(e);a.max=Math.min(a.max,.5*Math.PI);const n=a.min*(1-Ly)+a.max*Ly;return Math.min(s,n)}function rB(i,e,t,r){let s=OC(i,r,e,t);if(!i.state.constraints.tilt)return s;const a=i.state.constraints.tilt(e);return s=Math.min(s,.5*Math.PI),a.min*(1-Ly)+s*Ly}function aI(i,e,t,r){return om(i).lookAtTiltToEyeTilt(r,e,t)}function OC(i,e,t,r){return om(i).eyeTiltToLookAtTilt(r,e,t)}function $y(i,e,t,r){if(P(e))return null;const s=i.renderSpatialReference,a=ch(e.eye,s,Wf(i));return P(a)?null:g(r)?(r.position=a,r.heading=e.heading,r.tilt=e.tilt,r.fov=t,r):new vo(a,e.heading,e.tilt,t)}function sB(i,e){var r;const t=(r=i.basemapTerrain)==null?void 0:r.tilingScheme;if(t)return t.levelAtScale(e);JD.error("#scaleToZoom()","Cannot compute zoom from scale without a tiling scheme")}function nI(i,e){var r;const t=(r=i.basemapTerrain)==null?void 0:r.tilingScheme;if(t)return t.scaleAtLevel(e);JD.error("#zoomToScale()","Cannot compute scale from zoom without a tiling scheme")}function oI(i,e){return Jr(e.center,i.renderSpatialReference,NP,li.WGS84),$d(i,e.distance,NP[1])}let lm=class{constructor(e){this.signal=e,this.resolver=Uf()}};function Cd(i){return i&&"resolver"in i}const aB=.66;function lI(i){return 360-zA.normalize(i)}function zv(i){return zA.normalize(360-i)}function Cm(i){return g(i)&&i.resolver&&i.resolver.reject(),null}function nB(i,e){return g(i)&&i.resolver&&i.resolver.resolve(e),e}function cI(i,e,t,r=null){if(!e)return Cm(r);const s=i.spatialReference||li.WGS84;if(g(e.camera)){const c=FA(e.camera.position,s);if(P(c))return Cm(r);const h=e.camera.clone();return h.position=c,nB(r,h)}if(P(e.targetGeometry))return Cm(r);const a=e.get("targetGeometry.spatialReference");if(a&&!oy(a,s))return Cm(r);const n=qp(i,i.state.camera);let o=Yr.ADJUST;if(e.rotation!=null&&(n.heading=lI(e.rotation),o=Yr.LOCKED),t!=null&&(n.tilt=t),e.targetGeometry.type==="point"){const c=e.targetGeometry;let h;const u=e.targetGeometry.clone();return h=e.scale!=null?PC(i,e.scale,c.latitude):i.state.camera.distance,sI(i,u,h,n,o,r)}const l=e.targetGeometry.extent;return l?Og(i,l,n.heading,n.tilt,o,r):Cm(r)}function oB(i,e,t=null){return P(t)&&(t=new Ql),AC(i,null,e.clone(),t)}async function lB(i,e,t){const r=yB(i,e);if(!r)throw new bt("viewpointutils-create:no-target","Missing target for creating viewpoint");const s=new vo({fov:i.camera.fov}),a=new Ql({camera:s});if(r.target instanceof Ql)return Ih(await dB(i,r.target,r,t,a));if(r.target instanceof vo)return Ih(dI(i,r.target,a));const n=r.scale!=null||r.zoom!=null;if(r.target instanceof ds){const c=r.target.xmin===r.target.xmax||r.target.ymin===r.target.ymax;return Ih(n||c?await cw(i,r,r.target.center,s,t,a):await gB(i,r,r.target,s,t,a))}const o={boundingBox:di(),hasZ:!1,screenSpaceObjects:[]},l=n?cB(i,r):void 0;if(await hI(i,r.target,l,o),isFinite(o.boundingBox[0])){let c;if(oo(o.boundingBox,Ni),Ka.x=Ni[0],Ka.y=Ni[1],Ka.z=Ni[2],Ka.spatialReference=i.spatialReference,isFinite(Ka.z)&&o.hasZ?c=cT(o.boundingBox):(Ka.z=void 0,c=U4(hT(o.boundingBox,bB))),n||c)return Ih(await cw(i,r,Ka,s,t,a));const h=vB(i,o.screenSpaceObjects);return Ih(await _B(i,r,Ka,o.boundingBox,h,s,t,a))}return r.position?Ih(pB(i,r,s,a)):Ih(await mB(i,r,s,t,a))}function RC(i,e){return e.scale==null&&e.zoom!=null?nI(i,e.zoom):e.scale}function cB(i,e){const t=RC(i,e);return t?nF(t):void 0}function EC(i,e){let t=!1;return e.heading!=null?(i.heading=e.heading,t=!0):e.rotation!=null&&(i.heading=lI(e.rotation),t=!0),e.tilt!=null&&(i.tilt=e.tilt,t=!0),e.fov!=null&&(i.fov=e.fov),t}function AC(i,e,t,r){const s=i.spatialReference||li.WGS84;return e=g(e)?e:Nl(i,t),P(e)||(r.targetGeometry=ch(e.center,i.renderSpatialReference,s),r.scale=oI(i,e),r.rotation=zv(t.heading),r.camera=t),r}function Ny(i,e,t){var o,l;const r=()=>new bt("viewpointutils:invalid-geometry","The target is missing a valid geometry");if(!e)throw r();if(!oy(e.spatialReference,i.spatialReference))throw new bt("viewpointutils:incompatible-spatialreference",`Spatial reference (${e.spatialReference?e.spatialReference.wkid:"unknown"}) is incompatible with the view (${(o=i.spatialReference)==null?void 0:o.wkid})`,{geometry:e});const s=[];if(!e.hasZ&&i.basemapTerrain){let c;switch(e.type){case"point":c=e;break;case"multipoint":case"polyline":c=(l=e.extent)==null?void 0:l.center;break;case"mesh":c=e.origin;break;case"extent":c=e.center;break;case"polygon":c=e.centroid}c&&g(i.basemapTerrain.spatialReference)&&oy(c,i.basemapTerrain.spatialReference)&&i.elevationProvider?Ni[2]=je(rl(i.elevationProvider,c),0):Ni[2]=0}(0,xB[e.type])(e,c=>{s.push(c[0],c[1],c[2])},Ni);const a=s.length/3;if(a===0)throw r();const n=new Array(s.length);if(ha(s,e.spatialReference,0,n,i.spatialReference,0,a)){e.hasZ&&(t.hasZ=!0);for(let c=0;c<n.length;c+=3)e.hasZ?(Ni[0]=n[c+0],Ni[1]=n[c+1],Ni[2]=n[c+2]):(Ni[0]=n[c+0],Ni[1]=n[c+1]),Fp(t.boundingBox,Ni)}}async function hB(i,e,t,r){const s=await ly(i.whenViewForGraphic(e));if(s.ok===!1||P(s.value)||!("whenGraphicBounds"in s.value))return void Ny(i,e.geometry,r);const a=s.value,n=await ly(a.whenGraphicBounds(e,{minDemResolution:t}));if(n.ok===!1)return void Ny(i,e.geometry,r);const{screenSpaceObjects:o,boundingBox:l}=n.value;zp(r.boundingBox,l),o&&o.forEach(c=>{r.screenSpaceObjects.push(c)}),isFinite(l[2])&&(r.hasZ=!0)}async function hI(i,e,t,r){var s;if(Array.isArray(e)&&e.length===2){const a=e[0],n=e[1];if(typeof a=="number"&&typeof n=="number")return Ka.x=a,Ka.y=n,Ka.z=void 0,Ka.spatialReference=(s=i.spatialReference)!=null&&s.isGeographic?i.spatialReference:li.WGS84,void Ny(i,Ka,r)}e&&typeof e.map=="function"?await V4(e.map(a=>hI(i,a,t,r))):e instanceof G4?Ny(i,e,r):e instanceof nv&&await hB(i,e,t,r)}async function dB(i,e,t,r,s){if(g(e.camera))return dI(i,e.camera,s);s.scale=e.scale,s.rotation=e.rotation,s.targetGeometry=g(e.targetGeometry)?e.targetGeometry.clone():null,s.camera=null,t.heading!=null?s.rotation=zv(t.heading):t.rotation!=null&&(s.rotation=t.rotation);const a=RC(i,t);a!=null&&(s.scale=a);const n=new lm(r);return cI(i,s,t.tilt,n),s.camera=await n.resolver.promise,s}function dI(i,e,t){const r=i.spatialReference,s=FA(e.position,r);return P(s)?null:((e=e.clone()).fov=i.camera.fov,e.position=s,AC(i,null,e,t))}function uB(i,e,t,r,s,a){const n=i.renderSpatialReference;return ts(t,A_,n),ts(e,Y1,n),a.targetGeometry=new Ht(e),s.position=new Ht(t),Q(Fy,Y1,A_),Fv(i,A_,Fy,r.up,s),a.scale=$d(i,yi(A_,Y1),a.targetGeometry.latitude),a.rotation=zv(s.heading),a.camera=s,a}async function cw(i,e,t,r,s,a){if(P(t))throw new bt("createfromcenter","invalid point");a.targetGeometry=t.clone();const n=Zd(i);if(e.position)return uB(i,a.targetGeometry,e.position,n,r,a);if(e.zoomFactor){const l=n.distance/e.zoomFactor,c=B(Ni,n.viewForward,-l);n.eye=X(Ni,n.center,c),a.scale=$d(i,l,t.latitude)}qp(i,n,r);const o=EC(r,e)?Yr.LOCKED:Yr.ADJUST;if(!e.zoomFactor){const l=RC(i,e);l==null?(ts(t,Ni,i.renderSpatialReference),sM(n.frustum,Ni)?a.scale=$d(i,yi(n.eye,Ni),t.latitude):a.scale=oI(i,n)):a.scale=l;const c=new lm(s);rI(i,a.targetGeometry,a.scale,r,o,c),a.camera=await c.resolver.promise}return a}function pB(i,e,t,r){const s=Zd(i);return H(Fy,s.viewForward),Fv(i,s.eye,Fy,s.up,K1),t.position=new Ht(e.position),t.heading=e.heading!=null?e.heading:K1.heading,t.tilt=e.tilt!=null?e.tilt:K1.tilt,AC(i,null,t,r)}async function mB(i,e,t,r,s){const a=Zd(i);return cw(i,e,ch(a.center,i.renderSpatialReference,i.spatialReference),t,r,s)}async function gB(i,e,t,r,s,a){a.targetGeometry=t.clone();const n=Zd(i);qp(i,n,r);const o=EC(r,e)?Yr.LOCKED:Yr.ADJUST,l=new lm(s);return Og(i,t,r.heading,r.tilt,o,l),a.camera=await l.resolver.promise,a}function fB(i,e,t,r,s){let a=0;t.z!=null?a=t.z:i.basemapTerrain&&i.elevationProvider&&(a=Si(rl(i.elevationProvider,t))),j(Ni,t.x,t.y,a),Zl(i.spatialReference,Ni,FP,i.renderSpatialReference),Xl(E_,FP),ic(E_,E_),di(Sm);const n=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]];for(let f=0;f<n.length;f++){const y=n[f];let b=r[y[2]];isFinite(b)||(b=a),j(Ni,r[y[0]],r[y[1]],b),Jr(Ni,i.spatialReference,Ni,i.renderSpatialReference),Fp(Sm,el(Ni,Ni,E_))}const o=UA(Sm),l=dT(Sm),c=VA(Sm),h=1/Math.tan(e.fovX/2),u=1/Math.tan(e.fovY/2),p=.5*Math.sqrt(o*o+c*c)*Math.max(u,h)+.5*l,m=.5*l*u+.5*Math.max(o,c);return Math.max(p,m)/s}async function _B(i,e,t,r,s,a,n,o){o.targetGeometry=t.clone();const l=Zd(i),c=fB(i,l,t,r,s);qp(i,l,a);const h=EC(a,e)?Yr.LOCKED:Yr.ADJUST;o.scale=$d(i,c,o.targetGeometry.latitude);const u=new lm(n);return rI(i,o.targetGeometry,o.scale,a,h,u),o.camera=await u.resolver.promise,o}function yB(i,e){if(!e||!i.spatialReference)return null;const t={target:void 0};if("declaredClass"in e||Array.isArray(e))t.target=e;else{for(const r in e)t[r]=e[r];e.center&&!t.target&&(t.target=e.center)}return t}function Ih(i){return i&&g(i.camera)&&(i.rotation=zv(i.camera.heading)),i}function vB(i,e){const t=aB;if(!e.length)return t;let r=Number.NEGATIVE_INFINITY;for(let s=0;s<e.length;s++){const a=e[s].screenSpaceBoundingRect;r=Math.max(r,Math.abs(a[0]),Math.abs(a[1]),Math.abs(a[2]),Math.abs(a[3]))}return t-r/Math.min(i.width,i.height)*2}const Ni=T(),FP=ce(),E_=ys(),Sm=_s(),bB=yt(),Fy=T(),A_=T(),Y1=T(),K1={heading:0,tilt:0},Ka=new Ht,xB={point(i,e,t){t[0]=i.x,t[1]=i.y,i.z!=null&&(t[2]=i.z),e(t)},polygon(i,e,t){const r=i.hasZ;for(let s=0;s<i.rings.length;s++){const a=i.rings[s];for(let n=0;n<a.length;n++)t[0]=a[n][0],t[1]=a[n][1],r&&(t[2]=a[n][2]),e(t)}},polyline(i,e,t){const r=i.hasZ;for(let s=0;s<i.paths.length;s++){const a=i.paths[s];for(let n=0;n<a.length;n++)t[0]=a[n][0],t[1]=a[n][1],r&&(t[2]=a[n][2]),e(t)}},multipoint(i,e,t){const r=i.points,s=i.hasZ;for(let a=0;a<r.length;a++)t[0]=r[a][0],t[1]=r[a][1],s&&(t[2]=r[a][2]),e(t)},extent(i,e,t){i.zmin!=null&&i.zmax!=null?(e(j(t,i.xmin,i.ymin,i.zmin)),e(j(t,i.xmax,i.ymin,i.zmin)),e(j(t,i.xmin,i.ymax,i.zmin)),e(j(t,i.xmax,i.ymax,i.zmin)),e(j(t,i.xmin,i.ymin,i.zmax)),e(j(t,i.xmax,i.ymin,i.zmax)),e(j(t,i.xmin,i.ymax,i.zmax)),e(j(t,i.xmax,i.ymax,i.zmax))):(e(j(t,i.xmin,i.ymin,t[2])),e(j(t,i.xmax,i.ymin,t[2])),e(j(t,i.xmin,i.ymax,t[2])),e(j(t,i.xmax,i.ymax,t[2])))},mesh(i,e,t){const r=i.vertexAttributes&&i.vertexAttributes.position;if(r)for(let s=0;s<r.length;s+=3)e(j(t,r[s+0],r[s+1],r[s+2]))}};let wB=class{constructor(e,t,r){this.target=e,this.options=t,this.view=r,this.state="pending",this._animationController=null,this._promise=new Promise((s,a)=>{this._resolveCallback=s,this._rejectCallback=a;const n=new AbortController;g(this.options.signal)&&jg(this.options.signal,()=>{this.abort()}),this._abortController=n,this.waitForReady()})}then(e,t){return this._promise.then(e,t)}catch(e){return this._promise.catch(e)}resolve(e){if(this.state!=="finished")return this.state="finished",this._resolveCallback(e)}reject(e){if(this.state!=="finished")return this.state="finished",this._rejectCallback(e)}abort(e=!1){this._abortController.abort(),this.state==="wait-for-animation-finish"&&!e&&g(this._animationController)&&this.view.state.cameraController===this._animationController&&this._animationController.active&&this._animationController.stopController(),this.reject(ea())}async waitForReady(){if(this.state="wait-for-ready",!this.view.ready)try{await _x(()=>this.view.ready,this._abortController.signal)}catch(e){return this.reject(e)}this.createViewPoint()}createViewPoint(){this.state!=="finished"&&(this.state="wait-for-viewpoint",this._animationController=this.options.animate?this._getAnimationController():null,lB(this.view,this.target,this._abortController.signal).then(e=>{if(this.state==="finished")return;const t=e?this._getCameraFromViewpoint(e):null;if(!P(t))if(this.options.animate){if(P(this._animationController))return;this.startAnimation(t,this._animationController)}else this.view.stateManager.setStateCamera(t.camera,{applyConstraints:!t.isFullySpecified,positionAndOrientationOnly:!0,doNotCancelGoToOperation:!0}),this.resolve()},e=>{this.reject(e)}))}_getCameraFromViewpoint(e){var a;const t=!!(this.target instanceof Ql&&this.target.camera||this.target instanceof vo),r=e.camera;if(P(r))return null;if(!this.view.stateManager.isCompatible(r)){const n=r.position,o=n&&n.spatialReference,l=o?o.wkid:"none",c=(a=this.view.spatialReference)==null?void 0:a.wkid;return this.reject(new bt("GotoAnimation:incompatible-spatialreference",`Resulting camera has an incompatible spatial reference (camera: ${l}, view: ${c})`,{camera:r})),null}const s=Nl(this.view,r);return P(s)?(this.reject(new bt("GotoAnimation:invalid-camera","Resulting camera is invalid")),null):{viewpoint:e,camera:s,isFullySpecified:t}}startAnimation(e,t){this.state="wait-for-animation-finish";const r=t.viewAnimation;if(P(r))return void this.reject(new bt("GotoAnimation:missing-animation","Unreachable code in view.stateManager"));if(r.update(e.viewpoint,"running"),!t.active||P(t.viewAnimation)||t.viewAnimation.target!==e.viewpoint||this.view.state.cameraController!==t)return this.abort();let s;e.isFullySpecified?(s=new Pg({view:this.view,desiredCamera:e.camera}),am(this.view,e.camera,Dn.EYE_AND_CENTER)):Fi(this.view,e.camera),t.begin(e.camera,this.options);const a=()=>{const o=this.view.state.cameraController;s&&(o&&o.active?o instanceof Vl&&g(o.viewAnimation)&&o.viewAnimation.target===e.viewpoint&&(this.view.state.cameraController=s):g(t.viewAnimation)&&t.viewAnimation.target===e.viewpoint&&t.state==="finished"&&(this.view.state.cameraController=s))},n=o=>{if(!P(this.view.state))switch(t.state){case _i.Finished:switch(this.state){case"pending":case"wait-for-ready":case"wait-for-viewpoint":case"wait-for-animation-finish":this.resolve()}break;case _i.Ready:case _i.Rejected:case _i.Running:case _i.Stopped:switch(this.state){case"pending":case"wait-for-ready":case"wait-for-viewpoint":case"wait-for-animation-finish":this.reject(o)}}};r.when(a,o=>n(o)),t.asyncResult={resolve:()=>n(),reject:o=>n(o)}}_getAnimationController(){let e=null,t=null;const r=this.view.state.cameraController;return r instanceof Vl&&(r.updateStateFromViewAnimation(),r.active&&(e=r,t=e.viewAnimation)),e!=null||(e=new Vl({view:this.view,mode:"animation"}),t=e.viewAnimation,this.view.state.switchCameraController(e))?e:(g(t)&&t.stop(),this.reject(new bt("GotoAnimation:goto-cannot-interrupt","Cannot start an animation while interacting")),null)}},rr=class extends Ie{get camera(){const e=this._get("camera");if(!this.ready)return e;const t=qp(this.view,this.view.state.camera,J1);return t&&e&&t.equals(e)?e:t.clone()}set camera(e){var t,r;this._updatePropertyBeforeReady("camera",e)||((t=this.view.elevationProvider)==null||t.enableElevationCache(!0),this.setStateCamera(Nl(this.view,e),{applyConstraints:!1})||Pe.getLogger(this.declaredClass).error("#camera=","Invalid camera",e),(r=this.view.elevationProvider)==null||r.enableElevationCache(!1))}get contentCamera(){const e=this._get("contentCamera");if(!this.ready)return e;const t=qp(this.view,this.view.state.contentCamera,J1);return t&&e&&t.equals(e)?e:t.clone()}set contentCamera(e){if(this._updatePropertyBeforeReady("contentCamera",e))return;const t=Nl(this.view,e);P(t)?this.view.state.contentCamera=null:(this._updateElevation(t),this.view.state.contentCamera=t)}installContentCameraReset(e){if(this.removeHandles(eb),this.test.contentCameraResetState.clear(),!this.view.state.fixedContentCamera)return!1;const t=this.zoom,r=this.view.state.camera.distance**2,s=wn(this.view.state.camera.center),a=e.sticky?this.contentCamera.clone():null;return this.addHandles([te(()=>this.contentCamera,()=>{e.sticky||(this.removeHandles(eb),this.test.contentCameraResetState.clear())}),te(()=>this.zoom,n=>{n!==void 0&&t!==void 0&&(this.test.contentCameraResetState.set("view.zoom",Math.abs(n-t)/2),Math.abs(n-t)>2?this.contentCamera=null:this.view.state.fixedContentCamera||(this.contentCamera=a))}),te(()=>this.view.state.camera,n=>{const o=ol(s,n.center);this.test.contentCameraResetState.set("camera.center",o/r),o>r?this.contentCamera=null:this.view.state.fixedContentCamera||(this.contentCamera=a)})],eb),!0}get center(){return this.ready?this.view.pointsOfInterest.centerOnContent.location:this._get("center")}set center(e){var t;this._updatePropertyBeforeReady("center",e)||(e?this.isCompatible(e)?this.setStateCamera(this._centerToCamera(e),{applyConstraints:!0})?this.view.pointsOfInterest.centerOnContent.runTask():Pe.getLogger(this.declaredClass).error("#center=","Invalid center",e):Pe.getLogger(this.declaredClass).error("#center=","Center has an incompatible spatial reference (center: "+(e.spatialReference?e.spatialReference.wkid:"none")+", view: "+((t=this.view.spatialReference)==null?void 0:t.wkid)+")",e):Pe.getLogger(this.declaredClass).error("#center=","Center may not be null or undefined"))}get extent(){if(!this.ready)return this._get("extent");const e=this.view,t=JG(e,e.state.camera,e.pointsOfInterest.centerOnContent.renderLocation);return g(t)?t:this._get("extent")}set extent(e){var t;this._updatePropertyBeforeReady("extent",e)||(e?this.isCompatible(e)?this.setStateCamera(this._extentToCamera(e),{applyConstraints:!0})||Pe.getLogger(this.declaredClass).error("#extent=","Invalid extent",e):Pe.getLogger(this.declaredClass).error("#extent=","Extent has an incompatible spatial reference (extent: "+(e.spatialReference?e.spatialReference.wkid:"none")+", view: "+((t=this.view.spatialReference)==null?void 0:t.wkid)+")",e):Pe.getLogger(this.declaredClass).error("#extent=","Extent may not be null or undefined"))}get frustum(){const e=this._propertiesPool.get("frustum");return e.renderCoordsHelper=this.view.renderCoordsHelper,e.update(this.view.state.camera),e}get hasInitialView(){return!!this.view.get("map.initialViewProperties.viewpoint")}get scale(){if(this.ready){const e=this.view.pointsOfInterest.centerOnContent;return $d(this.view,e.distance,e.location.latitude)}return this._get("scale")}set scale(e){this._updatePropertyBeforeReady("scale",e)||this.setStateCamera(this._scaleToCamera(e),{applyConstraints:!0})||Pe.getLogger(this.declaredClass).error("#scale=","Invalid scale",e)}get padding(){if(!this.ready)return this._get("padding");const e=this.view.state.camera,t=e.padding,r=e.pixelRatio,s=this._get("padding"),a=Math.round(t[rt.TOP]/r),n=Math.round(t[rt.RIGHT]/r),o=Math.round(t[rt.BOTTOM]/r),l=Math.round(t[rt.LEFT]/r);return s!=null&&s.top===a&&s.right===n&&s.bottom===o&&s.left===l?s:{top:a,right:n,bottom:o,left:l}}set padding(e){this._updatePropertyBeforeReady("padding",e)||(this._paddingToArray(e,this.view.state.camera.pixelRatio,M_),this.view.state.updateCamera(t=>t.padding=M_))}_paddingToArray(e,t,r){e?Br(r,e.top||0,e.right||0,e.bottom||0,e.left||0):Br(r,0,0,0,0);for(let s=0;s<4;s++)r[s]=Math.round(r[s]*t)}get screenCenter(){const e=this.padding;return GA((this.view.width-(e.left+e.right))/2+e.left,(this.view.height-(e.top+e.bottom))/2+e.top)}get viewpoint(){return this.ready?oB(this.view,this.camera):this._get("viewpoint")}set viewpoint(e){var t;if(!this._updatePropertyBeforeReady("viewpoint",e))if(e)if(this.isCompatible(e))this.setStateCamera(this._viewpointToCamera(e),{applyConstraints:!e.camera})||Pe.getLogger(this.declaredClass).error("#viewpoint=","Invalid viewpoint",e);else{const r=g(e.camera)?e.camera.position:e.targetGeometry,s=g(r)&&r.spatialReference;Pe.getLogger(this.declaredClass).error("#viewpoint=","Viewpoint has an incompatible spatial reference (viewpoint: "+(s?s.wkid:"none")+", view: "+((t=this.view.spatialReference)==null?void 0:t.wkid)+")",e)}else Pe.getLogger(this.declaredClass).error("#viewpoint=","Viewpoint may not be null or undefined")}get zoom(){return this.ready?sB(this.view,this.scale):this._get("zoom")}set zoom(e){this._updatePropertyBeforeReady("zoom",e)||e===void 0||this.setStateCamera(this._zoomToCamera(e),{applyConstraints:!0})||Pe.getLogger(this.declaredClass).error("#zoom=","Invalid zoom",e)}get _pixelRatio(){var e;return g(this._devicePixelRatioOverride)?this._devicePixelRatioOverride:this._usePhysicalPixelRendering?this._windowDevicePixelRatio:Math.min(this._windowDevicePixelRatio,(e=this.view)==null?void 0:e.qualitySettings.maximumPixelRatio)}get _rasterPixelRatio(){return g(this._devicePixelRatioOverride)?this._devicePixelRatioOverride:this._usePhysicalPixelRenderingAny?this._windowDevicePixelRatio:Math.min(this._windowDevicePixelRatio,this.view.qualitySettings.maximumPixelRatio)}get _usePhysicalPixelRendering(){var e,t;return((t=(e=this.view)==null?void 0:e._stage)==null?void 0:t.renderer.isFeatureEnabled(Ii.PhysicalPixelRendering))??!1}get _usePhysicalPixelRenderingAny(){var t,r;const e=(r=(t=this.view)==null?void 0:t._stage)==null?void 0:r.renderer;return e&&(e.isFeatureEnabled(Ii.PhysicalPixelRendering,ii.IDLE)||e.isFeatureEnabled(Ii.PhysicalPixelRendering,ii.INTERACTING)||e.isFeatureEnabled(Ii.PhysicalPixelRendering,ii.ANIMATING))}constructor(e){super(e),this._propertiesPool=new hh({frustum:Wc},this),this._cameraSetByUser=!1,this._gotoOperation=null,this.constraintsManager=null,this.ready=!1,this._windowDevicePixelRatio=1,this._devicePixelRatioOverride=null,this._cameraChangeTime=0,this._updatingIgnoreRenderState=!1,this.test={viewStateManager:this,contentCameraResetState:new Map,setDevicePixelRatio:t=>this._devicePixelRatioOverride=t,renderState:null,get maximumPixelRatio(){return this.viewStateManager.view.qualitySettings.maximumPixelRatio},set updatingIgnoreRenderState(t){this.viewStateManager._updatingIgnoreRenderState=t},get updatingIgnoreRenderState(){return this.viewStateManager._updatingIgnoreRenderState||g(this.renderState)}}}initialize(){this._cameraChangeTime=performance.now(),this.addHandles([ll(()=>this.view.state.events,"before-camera-change",e=>e&&this._updateElevation(e)),te(()=>{var e;return(e=this.view.state)==null?void 0:e.camera},(e,t)=>this._cameraChangedHandler(e,t),Bt)]),Rd(()=>{var e;return(e=this.view.state)==null?void 0:e.camera},e=>this._updateElevation(e),{once:!0,sync:!0}),this.addHandles([uT({prepare:()=>this._prepareFrame()}),te(()=>this.view.state.cameraController,()=>{this._cameraSetByUser=!0,this.removeHandles(D_)}),ll(()=>this.view.state.events,"camera-projection-changed",()=>this.notifyChange("scale"))])}destroy(){this.exit(),this._propertiesPool=Te(this._propertiesPool)}init(){this.constraintsManager=new lg({view:this.view}),this._prepareFrame();const e=this._getInitialProperties();this._cameraSetByUser=!1,this._set("ready",!0);for(const t of e)this.set(t.name,t.value);if(!this._cameraSetByUser){const t=this.view.get("map.initialViewProperties.viewpoint")||this.view.initialExtent;t&&this.isCompatible(t)?this._setInitialView(t):this.view.state.viewingMode===ve.Local&&this.addHandles(Rd(()=>this.view.basemapTerrain.ready,()=>{this.removeHandles(D_),this._setInitialView(this.view.dataExtent)},{once:!0,initial:!0}),D_)}}exit(){this._cancelGoToOperation(),this.ready&&(this._override("padding",this.padding),this._set("ready",!1),this._clearOverride("hasInitialView"),this._cameraSetByUser=!1,this.removeHandles(D_),this.constraintsManager=Te(this.constraintsManager))}async goTo(e,t){const r={animate:!0,...t};return g(this._gotoOperation)&&this._gotoOperation.abort(r.animate),this._gotoOperation=new wB(e,r,this.view),this.view.resourceController.scheduler.stopFrame(),this._gotoOperation}debugSetCameraOnContent(){this.setStateCamera(Zd(this.view),{applyConstraints:!1})}step(e){const t=this.view.state,r=t==null?void 0:t.cameraController;r&&(t.updateCamera(s=>r.stepController(e,s)),r.steppingFinished&&r.finishController())}_cancelGoToOperation(){g(this._gotoOperation)&&(this._gotoOperation.abort(),this._gotoOperation=null)}_getInitialProperties(){const e=new Set,t=[];for(const{propertyName:r,overrides:s}of CB){const a=e.has(r),n=this._isOverridden(r);!a&&n&&t.push({name:r,value:this._get(r)}),this._clearOverride(r),(a||n)&&s.forEach(o=>e.add(o))}return t}_setInitialView(e){if(P(e)||this._cameraSetByUser)return;if(e instanceof vo)return void this.setStateCamera(Nl(this.view,e),{applyConstraints:!1});if(e instanceof Ql){if(e.targetGeometry instanceof ds){const a=Og(this.view,e.targetGeometry,0,.5,Yr.LOCKED);return void(g(a)&&this.setStateCamera(Nl(this.view,a),{applyConstraints:!0}))}const r={applyConstraints:!e.camera},s=this._viewpointToCamera(e);return void this.setStateCamera(s,r)}const t=Og(this.view,e,0,.5,Yr.LOCKED);g(t)&&this.setStateCamera(Nl(this.view,t),{applyConstraints:!0})}_updatePropertyBeforeReady(e,t){return!this.ready&&(this._override(e,t),t&&TB.includes(e)&&this._override("hasInitialView",!0),!0)}isCompatible(e){return!P(e)&&(e instanceof Ql?e.camera?this.isCompatible(e.camera):this.isCompatible(e.targetGeometry):e instanceof vo?this.isCompatible(e.position):e.spatialReference&&oy(e.spatialReference,this.view.spatialReference))}_getPreservingHeadingTilt(e=SB){return this._cameraSetByUser?(e.heading=this.camera.heading,e.tilt=this.camera.tilt):(e.heading=0,e.tilt=.5),e}_centerPointAtDistanceToCamera(e,t,r=yc){const{heading:s,tilt:a}=this._getPreservingHeadingTilt(),n=yf(this.view,s,a,e,t,Yr.ADJUST);return P(n)?null:(r.copyFrom(this.view.state.camera),r.eye=n.eye,r.center=n.center,r.up=n.up,r)}_centerToCamera(e){const t=this.view.pointsOfInterest.centerOnContent;t.runTask();const r=t.distance;return this._centerPointAtDistanceToCamera(e,r)}_extentToCamera(e){const{heading:t,tilt:r}=this._getPreservingHeadingTilt(),s=Og(this.view,e,t,r,Yr.ADJUST,J1);return s?Nl(this.view,s):null}_scaleToCamera(e){if(e==null)return null;const t=this.view.pointsOfInterest.centerOnContent;t.runTask();const r=t.renderLocation,s=t.location.latitude;if(s==null)return null;const a=PC(this.view,e,s);return this._centerPointAtDistanceToCamera(r,a)}_zoomToCamera(e){return this._scaleToCamera(nI(this.view,e))}_viewpointToCamera(e){return Nl(this.view,cI(this.view,e))}setStateCamera(e,t){return!(P(e)||!this.view.state.stopActiveCameraController())&&(this._cameraSetByUser=!0,t.doNotCancelGoToOperation||this._cancelGoToOperation(),this.view.state.updateCamera(r=>{t.positionAndOrientationOnly?(r.eye=e.eye,r.center=e.center,r.up=e.up):r.copyFrom(e),t.applyConstraints&&Fi(this.view,r)}),t.applyConstraints||(this.view.state.cameraController=new Pg({view:this.view,desiredCamera:e})),!0)}_prepareFrame(){const{surface:e,canvas:t}=this.view;if(!e||!t)return;this._windowDevicePixelRatio=window.devicePixelRatio;const r=this._pixelRatio,s=Math.round(e.clientWidth*r),a=Math.round(e.clientHeight*r);if(s!==0&&a!==0&&(t.width===s&&t.height===a||(t.width=s,t.height=a),this.view.state)){const n=this.view.state.camera;n.fullWidth===s&&n.fullHeight===a&&n.pixelRatio===r||(yc.copyFrom(n),yc.pixelRatio!==r&&(this._paddingToArray(this.padding,r,M_),yc.padding=M_),yc.fullWidth=s,yc.fullHeight=a,yc.pixelRatio=r,this.view.state.camera=yc),this._updateViewState()}}_updateElevation(e){var a;const t=this.view.basemapTerrain&&this.view.basemapTerrain.spatialReference,r=((a=this.view.renderCoordsHelper)==null?void 0:a.getAltitude(e.eye))??0,s=t?Dv(this.view,e.eye):0;e.relativeElevation=r-s}_updateViewState(){g(this.test.renderState)?this.view.state.mode=this.test.renderState:this.view.animation?this.view.state.mode=ii.ANIMATING:this.view.interacting?this.view.state.mode=ii.INTERACTING:(this.view.state.mode===ii.ANIMATING&&(this._cameraChangeTime=0),performance.now()-this._cameraChangeTime<=PB?this.view.state.mode=ii.INTERACTING:this.view.state.mode=ii.IDLE),this.view.state.rasterPixelRatio=this._rasterPixelRatio,this.view.state.contentPixelRatio=Math.min(this._pixelRatio,this.view.qualitySettings.maximumPixelRatio)}_cameraChangedHandler(e,t){e&&t&&e.almostEquals(t)||(this._cameraChangeTime=performance.now(),this._updateViewState())}};d([v({type:vo,dependsOn:["view.state.camera","ready"]})],rr.prototype,"camera",null),d([v({type:vo,dependsOn:["view.state.contentCamera","ready"]})],rr.prototype,"contentCamera",null),d([v({type:Ht})],rr.prototype,"center",null),d([v({type:ds})],rr.prototype,"extent",null),d([v({readOnly:!0})],rr.prototype,"frustum",null),d([v({readOnly:!0})],rr.prototype,"hasInitialView",null),d([v({readOnly:!0,type:Boolean})],rr.prototype,"ready",void 0),d([v({type:Number})],rr.prototype,"scale",null),d([v()],rr.prototype,"padding",null),d([v({readOnly:!0})],rr.prototype,"screenCenter",null),d([v({constructOnly:!0})],rr.prototype,"view",void 0),d([v({type:Ql})],rr.prototype,"viewpoint",null),d([v({type:Number})],rr.prototype,"zoom",null),d([v({readOnly:!0})],rr.prototype,"_pixelRatio",null),d([v({readOnly:!0})],rr.prototype,"_rasterPixelRatio",null),d([v({readOnly:!0})],rr.prototype,"_usePhysicalPixelRendering",null),d([v({readOnly:!0})],rr.prototype,"_usePhysicalPixelRenderingAny",null),d([v()],rr.prototype,"_windowDevicePixelRatio",void 0),d([v()],rr.prototype,"_devicePixelRatioOverride",void 0),rr=d([Y("esri.views.3d.state.ViewStateManager")],rr);const TB=["camera","viewpoint","extent","scale","center","zoom"],CB=[{propertyName:"camera",overrides:["viewpoint"]},{propertyName:"viewpoint",overrides:["extent"]},{propertyName:"extent",overrides:["center","scale"]},{propertyName:"center",overrides:[]},{propertyName:"scale",overrides:["zoom"]},{propertyName:"zoom",overrides:[]},{propertyName:"padding",overrides:[]}],SB={heading:0,tilt:0},J1=new vo,yc=new Fe,M_=Pt(),D_="pending-initial-view",eb="content-camera-reset",PB=300,zP=100;let sl=class extends zl{constructor(){super(...arguments),this.startCamera=new Fe,this.currentCamera=new Fe,this._lastInteraction=0}get isInteractive(){return performance.now()-this._lastInteraction<zP}stepController(e,t){t.copyViewFrom(this.currentCamera),this.currentCamera.copyFrom(t)}onControllerStart(e){this.state=_i.Running,this.startCamera.copyFrom(e),this.currentCamera.copyFrom(e)}onControllerEnd(e){e.copyViewFrom(this.currentCamera)}commitCamera(){this._lastInteraction=performance.now(),setTimeout(()=>this.notifyChange("isInteractive"),zP),this.view.state.updateCamera(e=>this.stepController(0,e)),this.steppingFinished&&this.finishController()}};d([v({readOnly:!0})],sl.prototype,"isInteractive",null),d([v()],sl.prototype,"_lastInteraction",void 0),sl=d([Y("esri.views.3d.state.controllers.InteractiveController")],sl);var Pa;(function(i){i[i.CENTER=0]="CENTER",i[i.EYE=1]="EYE"})(Pa||(Pa={}));let Rg=class extends sl{get _intersectionHelper(){return this.view.sceneIntersectionHelper}constructor(e){super(e),this.pivot=Pa.CENTER,this._rotScale=0,this._lastPoint=$e(),this._tmpWorldUp=T(),this._tmpViewDir=T(),this._tmpRotCurPoint=$e(),this._tmpTransf=ce(),this._tmpAxis=T(),this._tmpPivotPoint=T(),this._pivotPos=T(),this._constraintOptions={selection:Xt.ALL,interactionType:et.TUMBLE,interactionFactor:0,interactionStartCamera:null,interactionDirection:null,tiltMode:Er.TUMBLE}}initialize(){this._rotScale=this.pivot===Pa.CENTER?3:1.5}begin(e){if(this.active){switch(this.pivot){case Pa.EYE:H(this._pivotPos,this.startCamera.eye),this._constraintOptions.interactionType=et.LOOK_AROUND,this._constraintOptions.tiltMode=Er.LOOK_AROUND,this._constraintOptions.selection=Xt.NONE;break;case Pa.CENTER:{const t=this._intersectionHelper.intersectRayFreePointFallback(this.startCamera.ray,this._pivotPos,this.view.map.ground.opacity===0?Yd:{});t||H(this._pivotPos,this.startCamera.center),this._constrainPivotPoint(e,t),this.startCamera.center=this._pivotPos,this._constraintOptions.interactionType=et.TUMBLE,this._constraintOptions.tiltMode=Er.TUMBLE,this._constraintOptions.selection=Xt.ALL&~Xt.DISTANCE;break}}this._constraintOptions.interactionStartCamera=this.startCamera,Td(this.startCamera,e,this._lastPoint)}}_constrainPivotPoint(e,t){const r=this.startCamera,s=T();Q(s,this._pivotPos,r.eye);const a=pe(s),n=Math.abs(this.view.camera.position.z);this.view.renderCoordsHelper.worldUpAtPosition(r.eye,UP);let o=Math.max(Math.min(cG,1/Math.abs(J(UP,r.viewForward)))*n,hG);t&&(o=Math.min(a,o));const l=Et(this.view.spatialReference),c=Pi(r.width/r.pixelRatio*.5,r.height/r.pixelRatio*.5),h=Nv(this.startCamera,c,l);let u=this.view._stage.renderView.getMinimalDepthForArea(this.view.voxelWasm,r.fullWidth/r.pixelRatio*.5,r.fullHeight/r.pixelRatio*.5,r,2.5*j1,j1),p=this.view._stage.renderView.getMinimalDepthForArea(this.view.voxelWasm,e[0],e[1],r,j1);(g(u)||g(p))&&(u=je(u,p),p=P(p)||h===Rr.Horizontal?u:p,o=u>p?p:u,o=t?Math.min(o,a):o),W(s,s),H(this._pivotPos,X(this._tmpPivotPoint,r.eye,B(this._tmpPivotPoint,s,o)))}update(e){if(this.active){switch(this.pivot){case Pa.EYE:this.currentCamera.center=this._applyRotation(this.currentCamera,e,this.currentCamera.center,this._pivotPos);break;case Pa.CENTER:this.currentCamera.center=this._pivotPos,this.currentCamera.eye=this._applyRotation(this.currentCamera,e,this.currentCamera.eye,this._pivotPos)}Fi(this.view,this.currentCamera,this._constraintOptions),this.commitCamera()}}end(){this.active&&this.finishController()}_applyRotation(e,t,r,s){this.view.renderCoordsHelper.worldUpAtPosition(s,this._tmpWorldUp),Td(e,t,this._tmpRotCurPoint);let a=(this._lastPoint[1]-this._tmpRotCurPoint[1])*this._rotScale,n=(this._tmpRotCurPoint[0]-this._lastPoint[0])*this._rotScale;Q(this._tmpViewDir,r,s);const o=pe(this._tmpViewDir),l=es(J(this._tmpViewDir,this._tmpWorldUp)/o);if(this.pivot===Pa.EYE){a*=-.5;const c=.5*Math.PI-l,h=.5*Math.PI*.99;a=c-Math.max(-h,Math.min(h,c+a))}return a=ee(a+l,Wr.min,Wr.max)-l,Be(this._tmpAxis,e.up,this._tmpViewDir),this.pivot===Pa.CENTER&&(n=-n),go(this._tmpTransf,n,this._tmpWorldUp),Mn(this._tmpTransf,this._tmpTransf,a,this._tmpAxis),xe(this._tmpViewDir,this._tmpViewDir,this._tmpTransf),e.up=xe(tb,e.up,this._tmpTransf),X(tb,s,this._tmpViewDir),fs(this._lastPoint,this._tmpRotCurPoint),tb}};d([v()],Rg.prototype,"pivot",void 0),Rg=d([Y("esri.views.3d.state.controllers.RotateController")],Rg);const tb=T(),UP=T();let ib=class extends wo{constructor(e,t,r,s){super(!0),this._view=e,this.pointerAction=t,this._pivot=r,this.registerIncoming("drag",s,a=>this._handleDrag(a))}_handleDrag(e){const t=e.data;if(t.pointers.size>1||!pT(e.data,this.pointerAction))return;const r=Pi(t.center.x,t.center.y);switch(t.action){case"start":this._cameraController&&(this._cameraController.end(),this._cameraController=null),this._cameraController=new Rg({view:this._view,pivot:this._pivot}),this._view.state.switchCameraController(this._cameraController),this._cameraController.begin(r);break;case"update":this._cameraController&&this._cameraController.update(r);break;case"end":this._cameraController&&(this._cameraController.end(),this._cameraController=null)}e.stopPropagation()}},hw=class extends sl{constructor(){super(...arguments),this._pickPoint=T(),this._tmpP0=$e(),this._panAxisAngle=Lv(),this._tmpRayDir=T(),this._tmpRayDirPick=T(),this._targetOnSphere=T(),this._navMode=Rr.Horizontal,this._tmpRay={origin:T(),direction:T()},this.dragBeginPoint=Pi(),this._normalizedAnchorPoint=$e(),this._constraintOptions={selection:Xt.ALL_EXCEPT_COLLISION,interactionType:et.ZOOM,interactionFactor:0,interactionStartCamera:null,interactionDirection:null,tiltMode:Er.TUMBLE},this._sphere=Nn(),this._hasPickPoint=!1}get _intersectionHelper(){return this.view.sceneIntersectionHelper}begin(e){if(!this.active)return;fs(this.dragBeginPoint,e),Td(this.startCamera,e,this._normalizedAnchorPoint);const t=Et(this.view.spatialReference),r=ID(this._intersectionHelper,this.startCamera,e,t,jp.Ellipsoid,this.view.map.ground.opacity===0?Yd:{});if(this._navMode=Nv(this.startCamera,e,t),this._navMode===Rr.Horizontal)this._hasPickPoint=!!r.scenePickPoint,this._pickPoint=je(r.scenePickPoint,this._pickPoint),this._sphere=r.sphere;else{let s;nm(this.startCamera,e,this._tmpRay),W(this._tmpRay.direction,this._tmpRay.direction),g(r.scenePickPoint)&&(Q(this._tmpRayDirPick,this.startCamera.eye,r.scenePickPoint),s=pe(this._tmpRayDirPick));const a=Math.abs(this.view.camera.position.z);this.view.renderCoordsHelper.worldUpAtPosition(this.startCamera.eye,VP);let n=ee(Math.min(SD,1/Math.abs(J(VP,this._tmpRay.direction)))*a,Py[0],Py[1]);const o=this.view._stage.renderView.getMinimalDepthForArea(null,e[0],e[1],this.view.state.camera,$v);n=g(o)?o:n,n=s!=null?Math.min(n,s):n,this._hasPickPoint=!0,B(this._tmpRay.direction,this._tmpRay.direction,n),X(this._pickPoint,this._tmpRay.origin,this._tmpRay.direction)}this._constraintOptions.interactionStartCamera=this.startCamera}update(e){if(this.active){if(this.currentCamera.eye=this.startCamera.eye,this.currentCamera.center=this.startCamera.center,this.currentCamera.up=this.startCamera.up,this._navMode===Rr.Horizontal){Q(this._tmpRayDir,this.currentCamera.center,this.currentCamera.eye);const t=pe(this._tmpRayDir);Td(this.currentCamera,e,this._tmpP0);const r=12*(this._normalizedAnchorPoint[1]-this._tmpP0[1]);let s=t*2**r;const a=this.view.state.constraints.minimumPoiDistance;if(r<0&&s<a&&(s=a),Math.abs(t-s)<1e-6)return;if(this._hasPickPoint&&s<t){const n=1-(1-s/t)*(1-this._sphere[3]/pe(this.currentCamera.center));this.currentCamera.center=B(I_,this.currentCamera.center,n)}B(this._tmpRayDir,this._tmpRayDir,-s/t),this.currentCamera.eye=X(I_,this.currentCamera.center,this._tmpRayDir),this._constraintOptions.interactionFactor=ao(qg(this.dragBeginPoint,e)),Fi(this.view,this.currentCamera,this._constraintOptions),this._hasPickPoint&&(_f(this._sphere,this.currentCamera,this.dragBeginPoint,this._targetOnSphere),vC(this._pickPoint,this._targetOnSphere,this._panAxisAngle),xh(this.currentCamera,this._sphere,this._panAxisAngle))}else{const t=pe(this._tmpRay.direction);Td(this.currentCamera,e,this._tmpP0);const r=12*(this._normalizedAnchorPoint[1]-this._tmpP0[1]);let s=t*2**r;const a=this.view.state.constraints.minimumPoiDistance;if(r<0&&s<a&&(s=a),Math.abs(t-s)<1e-6)return;B(this._tmpRayDir,this._tmpRay.direction,1-s/t),this.currentCamera.eye=X(I_,this.currentCamera.eye,this._tmpRayDir),this.currentCamera.center=X(I_,this.currentCamera.center,this._tmpRayDir)}am(this.view,this.currentCamera),this.commitCamera()}}end(){this.active&&this.finishController()}};hw=d([Y("esri.views.3d.state.controllers.global.ZoomController")],hw);const I_=T(),VP=T();let dw=class extends sl{constructor(){super(...arguments),this._tmpP=T(),this._tmpDir=T(),this._tmpN=T(),this._tmpP0=$e(),this._tmpPoi=T(),this._tmpRayDir=T(),this.dragBeginPoint=Pi(),this._normalizedAnchorPoint=$e(),this._constraintOptions={selection:Xt.ALL,interactionType:et.ZOOM,interactionFactor:0,interactionStartCamera:null,interactionDirection:T(),tiltMode:Er.TUMBLE},this._plane=Ui()}get _intersectionHelper(){return this.view.sceneIntersectionHelper}begin(e){if(!this.active)return;fs(this.dragBeginPoint,e),Td(this.startCamera,e,this._normalizedAnchorPoint);const t=this._intersectionHelper.intersectScreenFreePointFallback(e,this._tmpP,this.view.map.ground.opacity===0?Yd:{});Q(this._tmpDir,this._tmpP,this.startCamera.eye);const r=pe(this._tmpDir);W(this._tmpDir,this._tmpDir);const s=Math.abs(this.view.camera.position.z);let a=ee(Math.min(SD,1/Math.abs(J(OB,this._tmpDir)))*s,Py[0],Py[1]);const n=this.view._stage.renderView.getMinimalDepthForArea(this.view.voxelWasm,e[0],e[1],this.view.state.camera,$v);a=g(n)?n:a,a=t?Math.min(a,r):a,B(this._tmpDir,this._tmpDir,a),X(this._tmpP,this.startCamera.eye,this._tmpDir),Q(this._tmpN,this.startCamera.eye,this.startCamera.center),W(this._tmpN,this._tmpN),this._tmpN[1]<0&&oa(this._tmpN,this._tmpN),mv(this._tmpP,this._tmpN,this._plane),this._constraintOptions.interactionStartCamera=this.startCamera}update(e){if(!this.active)return;dG(this._plane,this.currentCamera,this.dragBeginPoint,this._tmpPoi)||H(this._tmpPoi,this.currentCamera.center),Td(this.currentCamera,e,this._tmpP0);let t=4*(this._tmpP0[1]-this._normalizedAnchorPoint[1]);fs(this._normalizedAnchorPoint,this._tmpP0),Q(this._tmpRayDir,this._tmpPoi,this.currentCamera.eye);const r=pe(this._tmpRayDir);let s=r*(1-t);this._constraintOptions.interactionDirection&&(H(this._constraintOptions.interactionDirection,this._tmpRayDir),B(this._constraintOptions.interactionDirection,this._constraintOptions.interactionDirection,Math.sign(t)/r));const a=this.view.state.constraints.minimumPoiDistance;t>=0&&s<a&&(s=a,t=-(s-r)/r),Math.abs(r-s)<1e-6||(B(this._tmpRayDir,this._tmpRayDir,t),this.currentCamera.eye=X(Lh,this.currentCamera.eye,this._tmpRayDir),Gr(Lh,this.currentCamera.center,this._tmpPoi,t),this._tmpPoi[2]>this.startCamera.center[2]?Lh[2]=Math.max(this.startCamera.center[2],Lh[2]):Lh[2]=Math.min(this.startCamera.center[2],Lh[2]),this.currentCamera.center=Lh,this._constraintOptions.interactionFactor=ao(qg(this.dragBeginPoint,e)),Fi(this.view,this.currentCamera,this._constraintOptions),this.commitCamera())}end(){this.active&&this.finishController()}};dw=d([Y("esri.views.3d.state.controllers.local.ZoomController")],dw);const Lh=T(),OB=Ge(0,0,1);let RB=class extends wo{constructor(e,t,r){super(!0),this._view=e,this.pointerAction=t,this.registerIncoming("drag",r,s=>this._handleDrag(s))}_handleDrag(e){const t=e.data;if(t.pointers.size>1||!pT(e.data,this.pointerAction))return;const r=Pi(t.center.x,t.center.y);switch(t.action){case"start":this._cameraController&&(this._cameraController.end(),this._cameraController=null),this._view.state.isGlobal?this._cameraController=new hw({view:this._view}):this._cameraController=new dw({view:this._view}),this._view.state.switchCameraController(this._cameraController),this._cameraController.begin(r);break;case"update":this._cameraController&&this._cameraController.update(r);break;case"end":this._cameraController&&(this._cameraController.end(),this._cameraController=null)}e.stopPropagation()}},yd=class extends sl{constructor(e){super(e),this._filteredSurfaceElevation=0,this._transformation={translation:[0,0,0],heading:0,tilt:0,zoom:0},this._keysButtonState=[0,0,0,0,0,0,0,0,0,0,0,0],this._tmpCamera=new Fe,this._headingStart=0,this._constraintOptions={selection:Xt.ALL,interactionType:et.NONE,interactionStartCamera:new Fe,interactionFactor:0,interactionDirection:null,tiltMode:Er.LOOK_AROUND}}handleEventGamepad(e){const t=zS(e,this.view.navigation.gamepad,this._transformation);(e.action==="end"||n1(t))&&this.finishController()}activateDirection(e){this._keysButtonState[e]=1,US(this._keysButtonState,this._transformation)}deactivateDirection(e){this._keysButtonState[e]=0;const t=US(this._keysButtonState,this._transformation);n1(t)&&this.finishController()}onControllerStart(e){this._filteredSurfaceElevation=this.view.pointsOfInterest.cameraOnSurface.location.z,this._headingStart=this.view.camera.heading,super.onControllerStart(e)}_updateFilteredSurfaceElevation(e){const t=this.view.pointsOfInterest.cameraOnSurface.location.z,r=1;this._filteredSurfaceElevation+=r*(t-this._filteredSurfaceElevation)*e}stepController(e,t){var r;this._updateStartHeading(),this._updateFilteredSurfaceElevation(e),this.currentCamera.copyViewFrom(t),this._updateCameraCenter(),(r=this._constraintOptions.interactionStartCamera)==null||r.copyFrom(this.currentCamera),this._calculateControlTransformation(e,this.currentCamera,$h),this._applyDisabledMovementTypes($h),this._applyPan($h.pan),this._applyRotate($h.rotate),this._applyZoom($h.zoom),this._applyAscend($h.ascend),this._constraintOptions.interactionType=et.NONE,this._constraintOptions.selection=Xt.COLLISION,Fi(this.view,this.currentCamera,this._constraintOptions),super.stepController(e,t)}_updateStartHeading(){this._transformation.heading!==0&&(this._headingStart=this.view.camera.heading)}_applyRotate(e){if(!e.enabled)return;const t=this.currentCamera;Q(Ds,t.center,t.eye),xe(Ds,Ds,e.matrix),t.center=X(Ds,Ds,t.eye),t.up=xe(Ds,t.up,e.matrix),this._constraintOptions.interactionType=et.LOOK_AROUND,this._constraintOptions.selection=Xt.ALL_EXCEPT_COLLISION,Fi(this.view,t,this._constraintOptions)}_applyPan(e,t=this.currentCamera){e.enabled&&(t.eye=xe(Ds,t.eye,e.matrix),t.center=xe(Ds,t.center,e.matrix),this.view.state.isGlobal&&(t.up=xe(Ds,t.up,e.matrix)),this._constraintOptions.interactionType=et.PAN,this._constraintOptions.selection=Xt.ALL,Fi(this.view,t,this._constraintOptions))}_applyZoom(e){if(!e)return;const t=this.currentCamera.viewForward;this.currentCamera.eye=X(Ds,this.currentCamera.eye,B(Ve.get(),t,e)),H(Pm,t),oa(Pm,Pm),this._constraintOptions.interactionDirection=Pm,this._constraintOptions.interactionType=et.ZOOM,this._constraintOptions.selection=Xt.ALL_EXCEPT_COLLISION,Fi(this.view,this.currentCamera,this._constraintOptions),this._constraintOptions.interactionDirection=null}_applyAscend(e){if(!e)return;const t=this.view.renderCoordsHelper.worldUpAtPosition(this.currentCamera.eye,Ve.get());if(this._constraintOptions.interactionDirection=H(Pm,t),this.view.state.isGlobal){const r=pe(this.currentCamera.eye),s=(r+e)/r;this.currentCamera.eye=B(Ds,this.currentCamera.eye,s),this.currentCamera.center=B(Ds,this.currentCamera.center,s)}else{const r=B(Ve.get(),t,e);this.currentCamera.eye=X(Ds,this.currentCamera.eye,r),this.currentCamera.center=X(Ds,this.currentCamera.center,r)}this._updateCameraCenter(),this._constraintOptions.interactionType=et.ASCEND,this._constraintOptions.selection=Xt.COLLISION,Fi(this.view,this.currentCamera,this._constraintOptions)&&this._updateCameraCenter(),this._constraintOptions.selection=Xt.ALL_EXCEPT_COLLISION,Fi(this.view,this.currentCamera,this._constraintOptions),this._constraintOptions.interactionDirection=null}_calculateControlTransformation(e,t,r){$B(r);const s=this._computeVelocities(e);this.view.state.isLocal?this._calculateControlTransformationLocal(s,t,r):this._calculateControlTransformationGlobal(s,t,r)}_updateCameraCenter(){const e=this.view.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,t=this.view.renderCoordsHelper,r=this.currentCamera.ray;this.currentCamera.center=t.intersectManifoldClosestSilhouette(r,e,Ds)}_calculateControlTransformationLocal(e,t,r){const{viewRight:s,viewForward:a}=t,n=this._transformation,o=this.view.navigation.gamepad,l=j(Ve.get(),a[0],a[1],0);W(l,l);const c=n.translation[0]*e.pan;if(c!==0){const y=B(Ve.get(),s,c);pl(r.pan.matrix,r.pan.matrix,y),r.pan.enabled=!0}switch(o.mode){case"pan":{const y=-n.translation[1]*e.pan;if(y!==0){const b=B(Ve.get(),l,y);pl(r.pan.matrix,r.pan.matrix,b),r.pan.enabled=!0}r.zoom=n.zoom*e.zoom;break}case"zoom":r.zoom=(-n.translation[1]+n.zoom)*e.zoom;break;default:_o(o.mode)}const h=n.translation[2]*e.ascend;r.ascend=h;const u=-n.heading*e.rotate;u!==0&&(Mn(r.rotate.matrix,r.rotate.matrix,u,this.view.renderCoordsHelper.worldUpAtPosition(t.eye,Ve.get())),r.rotate.enabled=!0);const p=n.tilt*e.rotate,m=bh(this.view.renderCoordsHelper,t.center,t.eye),f=ee(m+p,Wr.min,Wr.max)-m;f&&(Mn(r.rotate.matrix,r.rotate.matrix,f,s),r.rotate.enabled=!0)}_calculateControlTransformationGlobal(e,t,r){const{eye:s,viewRight:a}=t,n=this._transformation,o=this.view.navigation.gamepad,l=Be(Ve.get(),a,s);W(l,l),oa(l,l),_G(this.startCamera,t,n,e,this.view.camera.heading,this._headingStart,this.view.camera.tilt,r,o),this._tmpCamera.copyFrom(this.currentCamera),this._applyPan($h.pan,this._tmpCamera);const c=this.view.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,h=n.translation[2]*e.ascend;r.ascend=h;const u=-n.heading*e.rotate;u!==0&&(Mn(r.rotate.matrix,r.rotate.matrix,u,this._tmpCamera.eye),r.rotate.enabled=!0);const p=n.tilt*e.rotate,m=this._clampTiltDeltaGlobalToValidRange(p,t.ray,c);m!==0&&(Mn(r.rotate.matrix,r.rotate.matrix,m,this._tmpCamera.viewRight),r.rotate.enabled=!0),r.zoom+=n.zoom*e.zoom}_clampTiltDeltaGlobalToValidRange(e,t,r){const s=Et(this.view.spatialReference),a=B0(Wr.min,t.origin,r,s);let n=0,o=0;const l=Ve.get();if(this.view.renderCoordsHelper.intersectManifold(t,r,l)){const c=bh(this.view.renderCoordsHelper,l,t.origin);n=B0(c,t.origin,r,s),o=B0(Wr.max,t.origin,r,s)}else{pv(ST(PT,r+s.radius),t,l);const c=es(-J(t.direction,W(l,l)));n=CP(c,t.origin,r,s),o=CP(Wr.max,t.origin,r,s)}return ee(n+e,a,o)-n}_getPointAbsoluteSurfaceElevation(e,t,r){const{renderCoordsHelper:s}=this.view,a=s.getAltitude(e),n=t+Math.abs(a-t);return s.setAltitude(r,n,e),n}_clampedDistanceToSurface(e,t){const{renderCoordsHelper:r}=this.view,{camera:s}=this.view.state,{direction:a}=XG(this.view,t,0,uI,LB),n=r.intersectManifoldClosestSilhouette(xo(t,a),e,Ve.get()),o=yi(t,n),l=r.intersectManifoldClosestSilhouette(xo(t,Bd(Ve.get(),t,s.center)),e,Ve.get()),c=yi(t,l);return Math.min(o,c)}_computeHeadingRotateRadius(e){const{renderCoordsHelper:t,state:r}=this.view,{camera:s,isGlobal:a}=r,n=t.intersectManifoldClosestSilhouette(s.ray,this._filteredSurfaceElevation,Ve.get());if(a){const o=Q(Ve.get(),e,n),l=pe(o);B(o,o,1/l);const c=W(Ve.get(),e),h=es(J(c,o));return l*Math.sin(Math.min(AB,h))}{const o=H(Ve.get(),e);return t.setAltitude(o,this._filteredSurfaceElevation),yi(n,o)}}_minimumAscendVelocity(){return this.view.state.constraints.collision.enabled?0:MB}_computeVelocities(e){const t=this._filteredSurfaceElevation,r=t+Et(this.view.spatialReference).radius,{camera:s,isGlobal:a}=this.view.state,n=Ve.get(),o=this._getPointAbsoluteSurfaceElevation(s.eye,t,n),l=this._clampedDistanceToSurface(t,n),c=s.width/2,h=GP*s.width,u=GP*s.width,p=l*Math.tan(.5*s.fovX)/c,m=p/r,f=p/this._computeHeadingRotateRadius(n),y=o-t;return{pan:(a?m:p)*h*e,ascend:Math.max(this._minimumAscendVelocity()*e,2**(h*e/c)*y-y),zoom:2**(h*e/c)*l-l,rotate:ee(f*u,DB,IB)*e}}_applyDisabledMovementTypes(e){!g(this.disableMovements)||this.disableMovements.mode!==void 0&&this.view.state.viewingMode!==this.disableMovements.mode||(e.zoom=this.disableMovements.zoom?0:e.zoom,e.ascend=this.disableMovements.ascend?0:e.ascend,e.pan.enabled=!this.disableMovements.pan,this.disableMovements.pan&&Ad(e.pan.matrix),e.rotate.enabled=!this.disableMovements.rotate,this.disableMovements.rotate&&Ad(e.rotate.matrix))}static activatesFor(e,t){const r=zS(t,e.navigation.gamepad,EB);return!(t.action==="end"||n1(r))}};d([v({constructOnly:!0})],yd.prototype,"gamepadDevice",void 0),d([v({constructOnly:!0})],yd.prototype,"disableMovements",void 0),yd=d([Y("esri.views.3d.state.controllers.GamepadKeyboardController")],yd);const EB={translation:[0,0,0],heading:0,tilt:0,zoom:0},uI=80,AB=ut(uI),GP=.75,MB=5,DB=ut(30),IB=ut(80),$h={zoom:0,ascend:0,pan:{enabled:!1,matrix:ce()},rotate:{enabled:!1,matrix:ce()}},Ds=T(),Pm=T(),LB=SC();function $B(i){i.zoom=0,i.ascend=0,i.pan.enabled=!1,Ad(i.pan.matrix),i.rotate.enabled=!1,Ad(i.rotate.matrix)}let NB=class extends wo{constructor(e){super(!0),this._view=e,this._watchHandles=new Vi,this._handle=this.registerIncoming("gamepad",t=>this._handleEventGamepad(t)),this._handle.pause()}onInstall(e){super.onInstall(e),this._watchHandles.add([te(()=>this._view.navigation.gamepad.enabled,t=>{t?this._handle.resume():(this._handle.pause(),this._cameraControllerGamepad&&(this._cameraControllerGamepad.finishController(),this._cameraControllerGamepad=null))},Ji),te(()=>this._view.navigation.gamepad.device,t=>{this._cameraControllerGamepad&&t&&this._cameraControllerGamepad.gamepadDevice!==t&&(this._cameraControllerGamepad.finishController(),this._cameraControllerGamepad=null)})])}onUninstall(){this._watchHandles.removeAll(),super.onUninstall()}_handleEventGamepad(e){const t=this._view.navigation.gamepad.device;if(t&&e.data.device!==t)return;const r=this._cameraControllerGamepad&&this._cameraControllerGamepad.active;if(r||yd.activatesFor(this._view,e.data)){if(!r){const s=new yd({view:this._view,gamepadDevice:e.data.device});this._view.state.switchCameraController(s)&&(this._cameraControllerGamepad=s)}this._cameraControllerGamepad&&this._cameraControllerGamepad.active&&this._cameraControllerGamepad.gamepadDevice===e.data.device&&this._cameraControllerGamepad.handleEventGamepad(e.data)}}};var Ta;(function(i){i[i.LEFT=0]="LEFT",i[i.RIGHT=1]="RIGHT",i[i.FORWARD=2]="FORWARD",i[i.BACKWARD=3]="BACKWARD",i[i.UP=4]="UP",i[i.DOWN=5]="DOWN",i[i.HEADINGLEFT=6]="HEADINGLEFT",i[i.HEADINGRIGHT=7]="HEADINGRIGHT",i[i.TILTUP=8]="TILTUP",i[i.TILTDOWN=9]="TILTDOWN",i[i.ZOOMIN=10]="ZOOMIN",i[i.ZOOMOUT=11]="ZOOMOUT"})(Ta||(Ta={}));let FB=class extends wo{constructor(e,t){super(!0),this._view=e,this._disableMovements={pan:!0,zoom:!1,ascend:!0,rotate:!1,mode:ve.Local},this._keyToNumber={[t.left]:Ta.LEFT,[t.right]:Ta.RIGHT,[t.forward]:Ta.FORWARD,[t.backward]:Ta.BACKWARD,[t.up]:Ta.UP,[t.down]:Ta.DOWN,[t.headingLeft]:Ta.HEADINGLEFT,[t.headingRight]:Ta.HEADINGRIGHT,[t.tiltUp]:Ta.TILTUP,[t.tiltDown]:Ta.TILTDOWN,[t.zoomIn]:Ta.ZOOMIN,[t.zoomOut]:Ta.ZOOMOUT},this.registerIncoming("key-down",null,r=>this._handleKeyDown(r)),this.registerIncoming("key-up",null,r=>this._handleKeyUp(r)),this.registerIncoming("blur",null,()=>this._handleBlur())}_handleKeyDown(e){if(e.data.native.ctrlKey||e.data.native.metaKey)return;const t=this._keyToNumber[e.data.key];t!=null&&(this._cameraControllerKeyboard&&this._cameraControllerKeyboard.active||(this._cameraControllerKeyboard=new yd({view:this._view,disableMovements:this._disableMovements}),this._view.state.switchCameraController(this._cameraControllerKeyboard)),this._cameraControllerKeyboard.active&&(this._cameraControllerKeyboard.activateDirection(t),e.stopPropagation()))}_handleBlur(){this._cameraControllerKeyboard&&this._cameraControllerKeyboard.active&&(this._cameraControllerKeyboard.finishController(),this._cameraControllerKeyboard=null)}_handleKeyUp(e){if(e.data.native.ctrlKey||e.data.native.metaKey)return;const t=this._keyToNumber[e.data.key];t!=null&&this._cameraControllerKeyboard&&this._cameraControllerKeyboard.active&&(this._cameraControllerKeyboard.deactivateDirection(t),e.stopPropagation())}},zB=class extends wo{constructor(e,t){super(!0),this._view=e,this.registerIncoming("mouse-wheel",t,r=>this._handleMouseWheel(r))}_handleMouseWheel(e){if(!this._view.navigation.mouseWheelZoomEnabled)return;const t=e.data;this._cameraController&&this._cameraController.active||(this._cameraController=this._view.state.isGlobal?new Ay({view:this._view,mode:"interaction"}):new My({view:this._view,mode:"interaction"}),this._view.state.switchCameraController(this._cameraController)),this._cameraController.zoomStep(-1/60*t.deltaY,Pi(t.x,t.y)),e.preventDefault(),e.stopPropagation()}},zy=class{constructor(e){this._gain=e}reset(e){this._value=e}set gain(e){this._gain=e}get value(){return this._value===void 0?0:this._value}update(e){this._value===void 0?this._value=e:this._value=this._gain*e+(1-this._gain)*this._value}},Nd=class extends gf{constructor(){super(...arguments),this._beginCamera=new Fe,this._elapsedTimeSec=0,this.constraintOptions={selection:Xt.ALL,interactionType:et.PAN,interactionFactor:0,interactionStartCamera:new Fe,interactionDirection:null,tiltMode:Er.TUMBLE}}initialize(){this.constraintOptions.interactionType=this.interactionType,this.viewAnimation=new $p}get steppingFinished(){return this.momentum.isFinished(this._elapsedTimeSec)}onControllerStart(e){this._beginCamera.copyFrom(e),this.constraintOptions.interactionStartCamera=this._beginCamera,super.onControllerStart(e)}stepController(e,t){t.copyViewFrom(this._beginCamera),this._elapsedTimeSec+=e,this.momentumStep(this._elapsedTimeSec,t),Fi(this.view,t,this.constraintOptions)}};Nd=d([Y("esri.views.3d.state.controllers.momentum.MomentumController")],Nd);let Eg=class extends Nd{constructor(e){super(e),this.interactionType=et.PAN,this._tmpPan=T()}momentumStep(e,t){const r=this.momentum.value(e);B(this._tmpPan,this.momentum.direction,r),t.eye=Q(BP,t.eye,this._tmpPan),t.center=Q(BP,t.center,this._tmpPan),this.constraintOptions.interactionDirection=this._tmpPan}};d([v({constructOnly:!0})],Eg.prototype,"momentum",void 0),Eg=d([Y("esri.views.3d.state.controllers.momentum.PanPlanarMomentumController")],Eg);const BP=T(),UB=T(),L_=T();let k0=class extends Nd{constructor(e){super(e),this.interactionType=et.PAN}momentumStep(e,t){const r=this.momentum.value1(e),s=this.momentum.value2(e);H(L_,t.eye),W(L_,L_),Be(this.momentum.axis2,L_,this.momentum.axis1),FD(t,UB,this.momentum.axis1,r,this.momentum.axis2,s)}};d([v({constructOnly:!0})],k0.prototype,"momentum",void 0),k0=d([Y("esri.views.3d.state.controllers.momentum.PanSphericalMomentumController")],k0);let pd=class extends Nd{set center(e){this._set("center",aa(e))}set axis(e){this._set("axis",aa(e))}constructor(e){super(e),this.interactionType=et.TUMBLE}momentumStep(e,t){const r=this.momentum.value(e);xh(t,this.center,ff(this.axis,r))}};d([v({constructOnly:!0})],pd.prototype,"momentum",void 0),d([v({constructOnly:!0})],pd.prototype,"center",null),d([v({constructOnly:!0})],pd.prototype,"axis",null),pd=d([Y("esri.views.3d.state.controllers.momentum.MomentumController")],pd);let gp=class extends Nd{set zoomCenter(e){this._set("zoomCenter",aa(e))}constructor(e){super(e),this.interactionType=et.ZOOM,this.constraintOptions.interactionDirection=T()}momentumStep(e,t){const{interactionDirection:r}=this.constraintOptions;if(!r)return;H(r,t.eye);const s=this.momentum.valueDelta(0,e);wC(t,this.zoomCenter,s,this.view.state.constraints.minimumPoiDistance),Bd(r,t.eye,r)}};d([v({constructOnly:!0})],gp.prototype,"momentum",void 0),d([v({constructOnly:!0})],gp.prototype,"zoomCenter",null),gp=d([Y("esri.views.3d.state.controllers.momentum.ZoomPlanarMomentumController")],gp);let nd=class extends Nd{set screenCenter(e){this._set("screenCenter",Pi(e[0],e[1]))}set sceneCenter(e){this._set("sceneCenter",aa(e))}constructor(e){super(e),this.interactionType=et.ZOOM,this.radius=0,this._tmpSceneCenter=T(),this._tmpZoomAxisAngle=Lv(),this._sphere=Nn()}initialize(){this._sphere[3]=this.radius}momentumStep(e,t){const r=this.momentum.valueDelta(0,e);MD(this._sphere,t,r),this.constraintOptions.interactionType=et.ZOOM,Fi(this.view,t,this.constraintOptions),_f(this._sphere,t,this.screenCenter,this._tmpSceneCenter),vC(this.sceneCenter,this._tmpSceneCenter,this._tmpZoomAxisAngle),xh(t,this._sphere,this._tmpZoomAxisAngle),this.constraintOptions.interactionType=et.PAN}};d([v({constructOnly:!0})],nd.prototype,"momentum",void 0),d([v({constructOnly:!0})],nd.prototype,"screenCenter",null),d([v({constructOnly:!0})],nd.prototype,"sceneCenter",null),d([v({constructOnly:!0})],nd.prototype,"radius",void 0),nd=d([Y("esri.views.3d.state.controllers.momentum.ZoomSphericalMomentumController")],nd);let HP=class{constructor(e){this._gain=e}update(e){this.filteredValue!==void 0?this.filteredValue=(1-this._gain)*this.filteredValue+this._gain*e:this.filteredValue=e}reset(){this.filteredValue=void 0}get hasFilteredValue(){return this.filteredValue!==void 0}};const kP=1e-5;let VB=class extends L6{constructor(e,t,r,s,a,n=0,o){super(e,t,r),this._angularVelocity1=s,this.axis1=a,this.angularVelocity2=n,this.axis2=o}value1(e){return super.valueFromInitialVelocity(this._angularVelocity1,e)}value2(e){return super.valueFromInitialVelocity(this.angularVelocity2,e)}},GB=class{constructor(e=300,t=12,r=.84){this._minimumInitialVelocity=e,this._stopVelocity=t,this._friction=r,this.enabled=!0,this._tmpAxis1=T(),this._tmpAxis2=T(),this._tmpAngles=$e(),this._time=new _1(.3),this._screen=[new _1(.4),new _1(.4)],this._angle1=new HP(.6),this._angle2=new HP(.6),this._axis1=T(),this._axis2=T(),this._lastScene=T()}addMomentumDirectRotation(e,t,r,s,a,n){if(this.enabled){if(this._time.hasLastValue()){if(this._time.computeDelta(r)<.01)return;let o=$D(this._lastScene,t,this._tmpAxis2,s,a,n);this._angle2.update(0),sn(this._tmpAxis2)<kP?o=0:W(this._axis1,this._tmpAxis2),this._angle1.update(o),H(this._lastScene,t)}this._screen[0].update(e[0]),this._screen[1].update(e[1]),this._time.update(r)}}addMomentumPreserveHeading(e,t,r,s,a,n,o){if(this.enabled){if(this._time.hasLastValue()){if(this._time.computeDelta(r)<.01)return;ND(this._lastScene,t,this._tmpAxis2,this._tmpAxis1,this._tmpAngles,s,a,n,o,!1),sn(this._tmpAxis2)<kP?(this._angle1.update(0),this._angle2.update(0)):(this._angle1.update(this._tmpAngles[1]),this._angle2.update(this._tmpAngles[0]),W(this._axis1,this._tmpAxis1),W(this._axis2,this._tmpAxis2)),H(this._lastScene,t)}this._screen[0].update(e[0]),this._screen[1].update(e[1]),this._time.update(r)}}reset(){this._screen[0].reset(),this._screen[1].reset(),this._angle1.reset(),this._angle2.reset(),this._time.reset()}evaluateMomentum(){if(!this.enabled||!this._screen[0].hasFilteredDelta())return null;const e=this._screen[0].filteredDelta,t=this._screen[1].filteredDelta,r=e==null||t==null?null:Math.sqrt(e*e+t*t),s=this._time.filteredDelta,a=r==null||s==null?0:r/s;return Math.abs(a)<this._minimumInitialVelocity?null:this.createMomentum(a,this._stopVelocity,this._friction)}createMomentum(e,t,r){const s=this._time.filteredDelta,a=this._angle1.filteredValue,n=this._angle2.filteredValue,o=s==null||n==null?0:n/s;return new VB(e,t,r,s==null||a==null?0:a/s,this._axis1,o,this._axis2)}},uw=class extends sl{constructor(){super(...arguments),this._smoothRotation=new zy(.05),this._rotationAxis=T(),this._beginAngle=0,this._beginHeading=0,this._panningPlane=Ui(),this._beginRadius=0,this._smoothScaling=new zy(.05),this._zoomCenterScreen=Pi(),this._zoomMomentumEstimator=new oM,this._rotationMomentumEstimator=new lM,this._panSphericalMomentumEstimator=new GB,this._panPlanarMomentumEstimator=new cM,this._adjustedSphere=Nn(),this._tmp3d=T(),this._tmpScreenPointArray=Pi(),this._beginScreenPoint=Pi(),this._beginScenePoint=T(),this._screenPickPoint=Pi(),this._scenePickPoint=T(),this._mode=Rr.Horizontal,this._sphere=Nn(),this._pointerCount=0,this._tmpInteractionDirection=T(),this._constraintOptions={selection:Xt.ALL,interactionType:et.NONE,interactionFactor:0,interactionStartCamera:new Fe,interactionDirection:null,tiltMode:Er.TUMBLE}}get _intersectionHelper(){return this.view.sceneIntersectionHelper}begin(e){var a;if(!this.active)return;const t=this.view.navigation.momentumEnabled;this._zoomMomentumEstimator.enabled=t,this._rotationMomentumEstimator.enabled=t,this._panPlanarMomentumEstimator.enabled=t,this._panSphericalMomentumEstimator.enabled=t,this._beginHeading=-lh.normalize(ut(this.view.camera.heading)),this._beginRadius=e.radius,this._pointerCount=e.pointers.size,this._beginAngle=e.angle,this._smoothRotation.reset(),Zo(e.center,this._screenPickPoint),fs(this._beginScreenPoint,this._screenPickPoint);const r=Et(this.view.spatialReference),s=ID(this._intersectionHelper,this.startCamera,this._screenPickPoint,r,jp.Silhouette,this.view.map.ground.opacity===0?Yd:{});P(s.scenePickPoint)||(this._scenePickPoint=s.scenePickPoint,this._sphere=s.sphere,H(this._beginScenePoint,this._scenePickPoint),this._mode=Nv(this.startCamera,this._screenPickPoint,r),this._mode===Rr.Vertical&&this._preparePlanarPanMode(e,s.hasGeometryIntersection),(a=this._constraintOptions.interactionStartCamera)==null||a.copyFrom(this.startCamera))}update(e){if(!this.active)return;this.currentCamera.copyFrom(this.startCamera);const t=e.pointers.size>1;this._mode===Rr.Horizontal?(t&&this._zoomSpherical(e),this._panningSpherical(e),t&&this._rotateSpherical(e)):(t&&this._zoomPlanar(e),this._panningPlanar(e),t&&this._rotatePlanar(e)),this.commitCamera()}end(e){e.pointers.size===this._pointerCount&&this.update(e),this.finishController();const t=this._zoomMomentumEstimator.evaluateMomentum();if(t)return this._mode===Rr.Horizontal?new nd({view:this.view,momentum:t,screenCenter:this._zoomCenterScreen,sceneCenter:this._beginScenePoint,radius:this._sphere[3]}):new gp({view:this.view,momentum:t,zoomCenter:this._beginScenePoint});const r=this._rotationMomentumEstimator.evaluateMomentum();if(r)return new pd({view:this.view,momentum:r,center:this._sphere,axis:this._rotationAxis});if(this._mode===Rr.Horizontal){const s=this._panSphericalMomentumEstimator.evaluateMomentum();if(s)return new k0({view:this.view,momentum:s})}else{const s=this._panPlanarMomentumEstimator.evaluateMomentum();if(s)return new Eg({view:this.view,momentum:s})}return null}_preparePlanarPanMode(e,t){const r=oa(this._tmp3d,this.startCamera.viewForward);mv(this._scenePickPoint,r,this._panningPlane);const s=Pi(this._screenPickPoint[0],0),a=T(),n=pe(this.startCamera.eye);this._adjustedSphere[3]=n<this._sphere[3]?n-100:this._sphere[3],_f(this._adjustedSphere,this.startCamera,s,a);const o=Zr();this.startCamera.projectToRenderScreen(a,o);const l=T(),c=T(),h=T();Q(l,this._scenePickPoint,this.currentCamera.eye);const u=pe(l);W(l,l);const p=ED*Math.max(Math.abs(this.view.camera.position.z),AD),m=this.view._stage.renderView.getMinimalDepthForArea(null,this._screenPickPoint[0],this._screenPickPoint[1],this.view.state.camera,$v);let f=g(m)?m:p;f=t?Math.min(f,u):f,H(h,X(c,this.currentCamera.eye,B(c,l,f))),this._panningPlane[3]=-J(As(this._panningPlane),h),this.startCamera.center=X(c,this.startCamera.eye,B(c,this.startCamera.viewForward,f));const y=Zo(e.center,this._tmpScreenPointArray);nw(this._panningPlane,this.startCamera,y,this._beginScenePoint)}_zoomSpherical(e){const t=this._beginRadius/e.radius,r=.001875*Math.min(Math.max(e.radius,40),120);this._smoothScaling.gain=r,this._smoothScaling.update(t),MD(this._sphere,this.currentCamera,this._smoothScaling.value),Zo(e.center,this._zoomCenterScreen),this._zoomMomentumEstimator.add(this._smoothScaling.value,.001*e.timestamp),this._constraintOptions.interactionType=et.ZOOM,this._constraintOptions.interactionFactor=ao(e.radius-this._beginRadius),Fi(this.view,this.currentCamera,this._constraintOptions)}_panningSpherical(e){const t=Zo(e.center,this._tmpScreenPointArray);_f(this._sphere,this.currentCamera,t,this._tmp3d),TC(this._beginScenePoint,J(this.currentCamera.up,this._beginScenePoint),this._sphere[3],this._beginHeading,this.view.camera.tilt,this.startCamera)?(UD(this._sphere,this.currentCamera,this._beginScenePoint,this._tmp3d,this._beginHeading,this.view.camera.tilt,!1),this._panSphericalMomentumEstimator.addMomentumPreserveHeading(t,this._tmp3d,.001*e.timestamp,this.startCamera,this._sphere,this._beginHeading,this.view.camera.tilt)):(zD(this._sphere,this.currentCamera,this._beginScenePoint,this._tmp3d,this.view.camera.tilt,!1),this._panSphericalMomentumEstimator.addMomentumDirectRotation(t,this._tmp3d,.001*e.timestamp,this.startCamera,this._sphere[3],this.view.camera.tilt)),this._constraintOptions.interactionType=et.PAN,this._constraintOptions.interactionFactor=ao(qg(this._screenPickPoint,t)),Fi(this.view,this.currentCamera,this._constraintOptions)}_rotateSpherical(e){W(this._rotationAxis,this._scenePickPoint),this.currentCamera.aboveGround||oa(this._rotationAxis,this._rotationAxis);const t=this._smoothRotation.value,r=t+aw(e.angle-t),s=.00125*Math.min(Math.max(e.radius,40),120);this._smoothRotation.gain=s,this._smoothRotation.update(r);const a=this._smoothRotation.value-this._beginAngle;this._rotationMomentumEstimator.add(a,.001*e.timestamp),xh(this.currentCamera,this._sphere,ff(this._rotationAxis,a)),this._constraintOptions.interactionType=et.TUMBLE,this._constraintOptions.interactionFactor=ao(e.radius*r),Fi(this.view,this.currentCamera,this._constraintOptions)}_panningPlanar(e){const t=Zo(e.center,this._tmpScreenPointArray);nw(this._panningPlane,this.currentCamera,t,this._tmp3d)&&(LD(this.currentCamera,this._beginScenePoint,this._tmp3d),this._panPlanarMomentumEstimator.add(t,this._tmp3d,.001*e.timestamp),this._constraintOptions.interactionType=et.PAN,this._constraintOptions.interactionFactor=ao(qg(this._beginScreenPoint,t)),this._constraintOptions.interactionDirection=this.view.renderCoordsHelper.worldUpAtPosition(this.currentCamera.eye,this._tmpInteractionDirection),Fi(this.view,this.currentCamera,this._constraintOptions),this._constraintOptions.interactionDirection=null)}_zoomPlanar(e){const t=this._beginRadius/e.radius,r=.001875*Math.min(Math.max(e.radius,40),120);this._smoothScaling.gain=r,this._smoothScaling.update(t),this._zoomMomentumEstimator.add(this._smoothScaling.value,.001*e.timestamp),wC(this.currentCamera,this._beginScenePoint,this._smoothScaling.value,this.view.state.constraints.minimumPoiDistance),this._constraintOptions.interactionType=et.ZOOM,this._constraintOptions.interactionFactor=ao(e.radius-this._beginRadius),Fi(this.view,this.currentCamera,this._constraintOptions)}_rotatePlanar(e){H(this._rotationAxis,this._beginScenePoint),this.currentCamera.aboveGround||oa(this._rotationAxis,this._rotationAxis);const t=this._smoothRotation.value;let r=e.angle-t;r=aw(r);const s=t+r,a=.00125*Math.min(Math.max(e.radius,40),120);this._smoothRotation.gain=a,this._smoothRotation.update(s);const n=this._smoothRotation.value-this._beginAngle;this._rotationMomentumEstimator.add(n,.001*e.timestamp),xh(this.currentCamera,this._sphere,ff(this._rotationAxis,n)),this._constraintOptions.interactionType=et.TUMBLE,this._constraintOptions.interactionFactor=ao(e.radius*n),Fi(this.view,this.currentCamera,this._constraintOptions)}};uw=d([Y("esri.views.3d.state.controllers.global.PinchAndPanController")],uw);const jP=Ge(0,0,1),BB={ELEVATION_THRESHOLD:3e4,ANGLE_THRESHOLD:16/180*Math.PI};let pw=class extends sl{constructor(){super(...arguments),this._rotationValueSmooth=new zy(.05),this._scalingValueSmooth=new zy(.05),this._planeHorizontal=Ui(),this._planeVertical=Ui(),this._rotationMomentumEstimator=new lM,this._panMomentumEstimator=new cM(300,12,.9),this._zoomMomentumEstimator=new oM,this._beginRadius=0,this._beginCenter=T(),this._beginAngle=0,this._tmpPoints=[],this._panMode=Rr.Horizontal,this._beginCenterScreen=Pi(),this._tmpCentroid3d=T(),this._tmpCentroid2d=Pi(),this._tmp2d=Pi(),this._pointerCount=0,this._constraintOptions={selection:Xt.ALL,interactionType:et.NONE,interactionFactor:0,interactionStartCamera:new Fe,interactionDirection:null,tiltMode:Er.TUMBLE}}begin(e){var f;if(!this.active)return;const t=this.view.navigation.momentumEnabled;this._zoomMomentumEstimator.enabled=t,this._rotationMomentumEstimator.enabled=t,this._panMomentumEstimator.enabled=t,this._beginRadius=e.radius,this._pointerCount=e.pointers.size,this._beginAngle=e.angle,this._rotationValueSmooth.reset(),this._scalingValueSmooth.reset(),Zo(e.center,this._beginCenterScreen),w3(jP,0,this._planeHorizontal);const r=T(),s=this._intersectionHelper.intersectScreenFreePointFallback(this._beginCenterScreen,r,this.view.map.ground.opacity===0?Yd:{}),a=T();oa(a,this.startCamera.viewForward);const n=T();H(n,jP);const o=J(a,n),l=ul(o<0?-o:o);this._panMode=l>=BB.ANGLE_THRESHOLD?Rr.Horizontal:Rr.Vertical;const c=Math.min(ED,1/Math.abs(J(n,this.startCamera.viewForward)))*Math.max(Math.abs(this.view.camera.position.z),AD);Px(this._planeHorizontal,this._planeHorizontal,r),this.startCamera.aboveGround||Ox(this._planeHorizontal,this._planeHorizontal);const h=T(),u=T(),p=T();Q(h,r,this.currentCamera.eye);const m=pe(h);if(W(h,h),this._panMode===Rr.Vertical){B(n,n,o),Q(this._planeVertical,a,n),W(this._planeVertical,this._planeVertical),Px(this._planeVertical,this._planeVertical,r);const y=this.view._stage.renderView.getMinimalDepthForArea(this.view.voxelWasm,this._beginCenterScreen[0],this._beginCenterScreen[1],this.view.state.camera,$v);let b=g(y)?y:c;b=s?Math.min(b,m):b,H(p,X(u,this.currentCamera.eye,B(u,h,b))),this._planeVertical[3]=-J(this._planeVertical,p),this._computePlanePoints(e.pointers,this._planeVertical,this.startCamera,this._tmpPoints),q1(this._tmpPoints,this._beginCenter)}else{const y=s?m:c;H(p,X(u,this.currentCamera.eye,B(u,h,y))),this._planeHorizontal[3]=-J(As(this._planeHorizontal),p),this._computePlanePoints(e.pointers,this._planeHorizontal,this.startCamera,this._tmpPoints),q1(this._tmpPoints,this._beginCenter)}(f=this._constraintOptions.interactionStartCamera)==null||f.copyFrom(this.startCamera)}update(e){if(!this.active)return;this.currentCamera.copyFrom(this.startCamera);const t=e.pointers.size>1,r=this._panMode===Rr.Horizontal?this._planeHorizontal:this._planeVertical,s=this._beginCenter;if(t){const a=this._beginRadius/e.radius,n=.001875*Math.min(Math.max(e.radius,40),120);this._scalingValueSmooth.gain=n,this._scalingValueSmooth.update(a),wC(this.currentCamera,s,this._scalingValueSmooth.value,this.view.state.constraints.minimumPoiDistance),this._zoomMomentumEstimator.add(this._scalingValueSmooth.value,.001*e.timestamp),this._constraintOptions.interactionType=et.ZOOM,this._constraintOptions.interactionFactor=ao(Math.abs(e.radius-this._beginRadius)),Fi(this.view,this.currentCamera,this._constraintOptions)}if(this._computePlanePoints(e.pointers,r,this.currentCamera,this._tmpPoints),q1(this._tmpPoints,this._tmpCentroid3d),Zo(e.center,this._tmpCentroid2d),LD(this.currentCamera,s,this._tmpCentroid3d),this._panMomentumEstimator.add(this._tmpCentroid2d,this._tmpCentroid3d,.001*e.timestamp),this._constraintOptions.interactionType=et.PAN,this._constraintOptions.interactionFactor=ao(qg(this._beginCenterScreen,this._tmpCentroid2d)),Fi(this.view,this.currentCamera,this._constraintOptions),t){const a=this._planeHorizontal,n=s,o=this._rotationValueSmooth.value,l=o+aw(e.angle-o),c=.00125*Math.min(Math.max(e.radius,40),120);this._rotationValueSmooth.gain=c,this._rotationValueSmooth.update(l);const h=this._rotationValueSmooth.value-this._beginAngle;this._rotationMomentumEstimator.add(h,.001*e.timestamp),xh(this.currentCamera,n,ff(a,h)),this._constraintOptions.interactionType=et.TUMBLE,this._constraintOptions.interactionFactor=ao(Math.abs(e.radius*h)),Fi(this.view,this.currentCamera,this._constraintOptions)}this.commitCamera()}end(e){e.pointers.size===this._pointerCount&&this.update(e),this.finishController();const t=this._zoomMomentumEstimator.evaluateMomentum();if(t)return new gp({view:this.view,momentum:t,zoomCenter:this._beginCenter});const r=this._rotationMomentumEstimator.evaluateMomentum();if(r)return new pd({view:this.view,momentum:r,center:this._beginCenter,axis:As(this._planeHorizontal)});const s=this._panMomentumEstimator.evaluateMomentum();return s?new Eg({view:this.view,momentum:s}):null}_computePlanePoints(e,t,r,s){s.length=e.size;const a=this._tmp2d;let n=0;return e.forEach(o=>{a[0]=o.x,a[1]=o.y,s[n]===void 0&&(s[n]=T()),nw(t,r,a,s[n]),n+=1}),s}get _intersectionHelper(){return this.view.sceneIntersectionHelper}};pw=d([Y("esri.views.3d.state.controllers.local.PinchAndPanController")],pw);let qP=class extends wo{constructor(e,t,r){super(!0),this._view=e,this.pointerAction=t,this._lastEndTimestamp=0,this._lastTimestamp=0,this.registerIncoming("drag",r,s=>this._handleDrag(s))}_handleDrag(e){if(e.data.pointerType==="mouse"&&!pT(e.data,this.pointerAction))return;const t=e.timestamp-this._lastEndTimestamp,r=40,s=this._momentum&&this._momentum.active&&t<r;switch(e.data.action){case"start":case"update":if(s)break;this._controller&&this._controller.active?e.data.timestamp-this._lastTimestamp>2&&(this._controller.update(e.data),this._lastTimestamp=e.timestamp):this._startController(e);break;case"end":case"removed":this._endController(e,!0);break;case"added":this._endController(e,!1),this._startController(e)}e.stopPropagation()}_endController(e,t){if(this._controller&&this._controller.active){this._lastEndTimestamp=e.timestamp;const r=this._controller.end(e.data);t&&r&&(this._momentum=r,this._view.state.switchCameraController(this._momentum))}this._controller=null}_startController(e){this._controller=this._createController(),this._view.state.switchCameraController(this._controller),this._controller.begin(e.data),this._lastTimestamp=e.timestamp}_createController(){return this._view.state.isGlobal?new uw({view:this._view}):new pw({view:this._view})}},HB=class extends wo{constructor(e,t){super(!0),this.view=e,this.registerIncoming("pointer-down",t,()=>this.view.state.stopActiveCameraController())}},pI=class extends wo{constructor(e,t){super(!0),this.key=e,this.registerIncoming("key-down",t,r=>this._handleKeyDown(r))}_handleKeyDown(e){e.data.key===this.key&&(this.activate(),e.stopPropagation())}},kB=class extends pI{constructor(e,t,r){super(t,r),this.view=e}activate(){this.view.goTo({heading:0}).catch(()=>{})}},jB=class extends pI{constructor(e,t,r){super(t,r),this.view=e}activate(){this.view.goTo({tilt:0}).catch(()=>{})}},qB=class extends wo{constructor(e,t=!1){super(!0),this._view=e,this._invert=t,this.registerIncoming("vertical-two-finger-drag",r=>this._handleTwoFinger(r))}_handleTwoFinger(e){var s,a,n;const t=this._invert?-1:1,r=Pi(0,e.data.delta*t);switch(e.data.action){case"begin":(s=this._cameraController)==null||s.end(),this._cameraController=new Rg({view:this._view,pivot:Pa.CENTER}),this._view.state.switchCameraController(this._cameraController),this._cameraController.begin(r);break;case"update":(a=this._cameraController)==null||a.update(r);break;case"end":(n=this._cameraController)==null||n.end(),this._cameraController=null}}},WB=class extends wo{constructor(e=20,t=40){super(!1),this._threshold=e,this._maxDelta=t,this._state="ready",this._emittedArtificalEnd2=!1,this._vertical=this.registerOutgoing("vertical-two-finger-drag"),this._artificalDrag=this.registerOutgoing("drag"),this._dragEventSeparator=new B4({start:(r,s)=>this._observeStart(r,s),update:(r,s,a)=>this._observeUpdate(r,s,a),end:(r,s)=>this._observeEnd(s)}),this.registerIncoming("drag",r=>this._dragEventSeparator.handle(r))}get failed(){return this._state==="failed"}_observeStart(e,t){e===1&&this._emittedArtificalEnd2&&(this._emittedArtificalEnd2=!1,this._artificalDrag.emit({action:"start",button:t.data.button,buttons:t.data.buttons,pointerType:t.data.pointerType,timestamp:t.data.timestamp,pointers:t.data.pointers,pointer:t.data.pointer,angle:t.data.angle,radius:t.data.radius,center:t.data.center}),t.stopPropagation()),this._state=e===2?"ready":"failed"}_observeUpdate(e,t,r){if(this._state!=="failed"&&e===2)return this._state==="active"?(this._vertical.emit({delta:t.data.center.y-this._thresholdReachedCenter.y,action:"update"}),void t.stopPropagation()):void(this._checkMovementWithinLimits(t.data,r.data)?this._checkVerticalThresholdReached(t.data,r.data)&&(this._state="active",this._emittedArtificalEnd2=!0,this._thresholdReachedCenter=t.data.center,this._artificalDrag.emit({action:"end",button:t.data.button,buttons:t.data.buttons,pointerType:t.data.pointerType,timestamp:t.data.timestamp,pointers:t.data.pointers,pointer:t.data.pointer,angle:t.data.angle,radius:t.data.radius,center:t.data.center}),this._vertical.emit({delta:t.data.center.y-this._thresholdReachedCenter.y,action:"begin"}),t.stopPropagation()):this._state="failed")}_observeEnd(e){this._state==="active"&&(this._vertical.emit({delta:e.data.center.y-this._thresholdReachedCenter.y,action:"end"}),this._state="ready",e.stopPropagation())}_checkMovementWithinLimits(e,t){let r=-1/0,s=1/0,a=-1/0,n=1/0;for(const{x:y,y:b}of t.pointers.values())r=Math.max(r,y),s=Math.min(s,y),a=Math.max(a,b),n=Math.min(n,b);let o=-1/0,l=1/0,c=-1/0,h=1/0;for(const{x:y,y:b}of e.pointers.values())o=Math.max(o,y),l=Math.min(l,y),c=Math.max(c,b),h=Math.min(h,b);const u=r-s,p=a-n,m=o-l,f=c-h;return Math.abs(e.center.x-t.center.x)<this._threshold&&Math.abs(m-u)<=this._maxDelta&&Math.abs(f-p)<=this._maxDelta}_checkVerticalThresholdReached(e,t){let r=Math.abs(e.center.y-t.center.y);return e.pointers.forEach((s,a)=>{const n=t.pointers.get(a);r=Math.min(r,Math.abs(s.y-n.y))}),r>=this._threshold}},Qn=class extends Ie{constructor(){super(...arguments),this._handles=new Vi}destroy(){this._handles=Te(this._handles),this.disconnect()}get primaryDragAction(){return this._get("primaryDragAction")}set primaryDragAction(e){e!=="pan"&&e!=="rotate"||e===this._get("primaryDragAction")||(this._set("primaryDragAction",e),this._updateMode())}get mode(){return this._get("mode")}set mode(e){e!=="default"&&e!=="pro"||e===this._get("mode")||(this._set("mode",e),this._updateMode())}get hasPendingInputs(){var e;return!!((e=this._inputManager)!=null&&e.hasPendingInputs)}get latestPointerType(){var e;return(e=this._inputManager)==null?void 0:e.latestPointerType}get latestPointerLocation(){var e;return(e=this._inputManager)==null?void 0:e.latestPointerLocation}get multiTouchActive(){var e;return((e=this._inputManager)==null?void 0:e.multiTouchActive)??!1}disconnect(){this.view.viewEvents.disconnect(),this._inputManager=Te(this._inputManager)}connect(){const e=this.view;this._source=new H4(this.view.surface,e.input);const t=[new k4,new j4,new q4,new W4(this.view.navigation),new WB],r=new X4({eventSource:this._source,recognizers:t});this._inputManager=r,r.installHandlers("prevent-context-menu",[new Q4],VS.INTERNAL),this._modeDragPan=new qP(e,"primary"),this._modeDragRotate=new ib(e,"secondary",Pa.CENTER),this._modeDragZoom=new RB(e,"tertiary");const s={lookAround:"b",pan:{left:"ArrowLeft",right:"ArrowRight",forward:"ArrowUp",backward:"ArrowDown",up:"u",down:"j",headingLeft:"a",headingRight:"d",tiltUp:"w",tiltDown:"s",zoomIn:"+",zoomOut:"-"},resetHeading:"n",resetTilt:"p"};r.installHandlers("navigation",[new HB(e),new TG(e),new NB(e),new FB(e,s.pan),new zB(e),new jB(e,s.resetTilt),new kB(e,s.resetHeading),new ib(e,"primary",Pa.EYE,[s.lookAround]),new ib(e,"secondary",Pa.CENTER,[s.lookAround]),new qP(e,"tertiary",[s.lookAround]),this._modeDragRotate,this._modeDragZoom,this._modeDragPan,new qB(e)],VS.INTERNAL),this.view.viewEvents.connect(r),this._updateMode(),this._handles.add(te(()=>{var a;return(a=this.view.navigation)==null?void 0:a.browserTouchPanEnabled},a=>{this._source.browserTouchPanningEnabled=!a},Ji))}_updateMode(){var s;const e=this.mode,t=this.primaryDragAction,r=(s=mw.get(e))==null?void 0:s.get(t);r&&(this._modeDragPan&&(this._modeDragPan.pointerAction=r.pan),this._modeDragRotate&&(this._modeDragRotate.pointerAction=r.rotate),this._modeDragZoom&&(this._modeDragZoom.pointerAction=r.zoom))}get test(){return{inputManager:this._inputManager,modeDragPan:this._modeDragPan,modeDragRotate:this._modeDragRotate,modeDragZoom:this._modeDragZoom}}};d([v()],Qn.prototype,"view",void 0),d([v({value:"pan"})],Qn.prototype,"primaryDragAction",null),d([v({value:"default"})],Qn.prototype,"mode",null),d([v({readOnly:!0})],Qn.prototype,"hasPendingInputs",null),d([v()],Qn.prototype,"latestPointerType",null),d([v()],Qn.prototype,"latestPointerLocation",null),d([v()],Qn.prototype,"multiTouchActive",null),d([v()],Qn.prototype,"_inputManager",void 0),Qn=d([Y("esri.views.3d.input.SceneInputManager")],Qn);const mw=new Map,rb=new Map,sb=new Map;rb.set("pan",{pan:"primary",rotate:"secondary",zoom:"tertiary"}),rb.set("rotate",{pan:"secondary",rotate:"primary",zoom:"tertiary"}),sb.set("pan",{pan:"primary",rotate:"tertiary",zoom:"secondary"}),sb.set("rotate",{pan:"tertiary",rotate:"primary",zoom:"secondary"}),mw.set("default",rb),mw.set("pro",sb);const XB=Qn;let Ja,Ap,gw=!1,fw=!1,_w=!1,yw=!1,Ag=null;function QB(i,e){if(!fw||!Ap)return;mI();const t=Ap;let r=0;for(let s=0;s<i.accBinsNumX;s++)for(let a=0;a<i.accBinsNumY;a++){const n=i.accBins[s][i.accBinsNumY-1-a];r+=n.length;const o=s*i.accBinsSizeX,l=(s+1)*i.accBinsSizeX,c=a*i.accBinsSizeY,h=(a+1)*i.accBinsSizeY;t.fillText(n.length.toFixed(),o+5,c+15),gI(o,l,c,h,"blue")}t.fillText("total totalShownLabels: "+r,70,40),t.fillText("total visible labels: "+e.size,70,50),t.fillText("total numTests: "+i.accNumTests,70,30)}function ZB(i){_w=Ot.DECONFLICTOR_SHOW_VISIBLE,yw=Ot.DECONFLICTOR_SHOW_INVISIBLE,gw=_w||yw,fw=Ot.DECONFLICTOR_SHOW_GRID,Ag=null,gw||fw?Ag=()=>YB(i):Ja&&(Ja.parentElement.removeChild(Ja),Ja=null)}function mI(){Ag&&(Ag(),Ag=null)}function YB(i){Ja==null&&(Ja=document.createElement("canvas"),Ja.setAttribute("id","canvas2d"),i.surface.parentElement.style.position="relative",i.surface.parentElement.appendChild(Ja));const{state:e}=i,{camera:t,pixelRatio:r}=e,{width:s,height:a}=t,n=s*r,o=a*r;Ja.setAttribute("width",`${n}px`),Ja.setAttribute("height",`${o}px`),Ja.setAttribute("style",`position:absolute;left:0px;top:0px;display:block;pointer-events:none;width:${s}px;height:${a}px`),Ap=Ja.getContext("2d"),Ap.clearRect(0,0,s,a),Ap.font="12px Arial"}function gI(i,e,t,r,s){mI();const a=Ja.height,n=Ap;n.beginPath(),n.lineWidth=1,n.strokeStyle=s,n.moveTo(i,a-t),n.lineTo(e,a-t),n.stroke(),n.lineTo(e,a-r),n.stroke(),n.lineTo(e,a-t),n.stroke(),n.lineTo(i,a-t),n.stroke(),n.lineTo(i,a-t),n.stroke(),n.closePath()}function KB(i,e){gw&&(e&&_w||!e&&yw)&&gI(i.aabr[0],i.aabr[2],i.aabr[1],i.aabr[3],e?"green":"red")}var Fr,Ma;(function(i){i[i.GRAPHIC=0]="GRAPHIC",i[i.LABEL=1]="LABEL",i[i._COUNT=2]="_COUNT"})(Fr||(Fr={})),function(i){i[i.USER_SETTING=0]="USER_SETTING",i[i.SCALE_RANGE=1]="SCALE_RANGE",i[i.FILTER=2]="FILTER",i[i.DECONFLICTION=3]="DECONFLICTION",i[i._COUNT=4]="_COUNT"}(Ma||(Ma={}));function JB(i){return i instanceof Float32Array&&i.length>=16}function eH(i){return Array.isArray(i)&&i.length>=16}function tH(i){return JB(i)||eH(i)}var Ya;(function(i){i[i.Occluded=0]="Occluded",i[i.NotOccluded=1]="NotOccluded",i[i.Both=2]="Both",i[i.COUNT=3]="COUNT"})(Ya||(Ya={}));var Js;function fI(i,e){i.include(R3),i.attributes.add(w.POSITION,"vec3"),i.attributes.add(w.NORMAL,"vec3"),i.attributes.add(w.AUXPOS1,"vec4");const t=i.vertex;nc(t,e),rm(t,e),t.uniforms.add([new ai("viewport",(r,s)=>s.camera.fullViewport),new ue("polygonOffset",r=>r.shaderPolygonOffset),new ue("cameraGroundRelative",(r,s)=>s.camera.aboveGround?1:-1),new ue("renderTransparentlyOccludedHUD",(r,s)=>s.renderTransparentlyOccludedHUD===Ya.Occluded?1:s.renderTransparentlyOccludedHUD===Ya.NotOccluded?0:.75),new lt("hudVisibilityTexture",(r,s)=>s.hudVisibilityTexture)]),e.hasVerticalOffset&&mF(t),t.constants.add("smallOffsetAngle","float",.984807753012208),t.code.add(_`struct ProjectHUDAux {
vec3 posModel;
vec3 posView;
vec3 vnormal;
float distanceToCamera;
float absCosAngle;
};`),t.code.add(_`float applyHUDViewDependentPolygonOffset(float pointGroundDistance, float absCosAngle, inout vec3 posView) {
float pointGroundSign = sign(pointGroundDistance);
if (pointGroundSign == 0.0) {
pointGroundSign = cameraGroundRelative;
}
float groundRelative = cameraGroundRelative * pointGroundSign;
if (polygonOffset > .0) {
float cosAlpha = clamp(absCosAngle, 0.01, 1.0);
float tanAlpha = sqrt(1.0 - cosAlpha * cosAlpha) / cosAlpha;
float factor = (1.0 - tanAlpha / viewport[2]);
if (groundRelative > 0.0) {
posView *= factor;
}
else {
posView /= factor;
}
}
return groundRelative;
}`),e.isDraped&&!e.hasVerticalOffset||Zg(t),e.isDraped||(t.uniforms.add(new ue("perDistancePixelRatio",(r,s)=>Math.tan(s.camera.fovY/2)/(s.camera.fullViewport[2]/2))),t.code.add(_`void applyHUDVerticalGroundOffset(vec3 normalModel, inout vec3 posModel, inout vec3 posView) {
float distanceToCamera = length(posView);
float pixelOffset = distanceToCamera * perDistancePixelRatio * 0.5;
vec3 modelOffset = normalModel * cameraGroundRelative * pixelOffset;
vec3 viewOffset = (viewNormal * vec4(modelOffset, 1.0)).xyz;
posModel += modelOffset;
posView += viewOffset;
}`)),e.screenCenterOffsetUnitsEnabled===Js.Screen&&t.uniforms.add(new ue("pixelRatio",(r,s)=>s.camera.pixelRatio)),e.hasScreenSizePerspective&&ET(t),t.code.add(_`
    vec4 projectPositionHUD(out ProjectHUDAux aux) {
      // centerOffset is in view space and is used to implement world size offsetting
      // of labels with respect to objects. It also pulls the label towards the viewer
      // so that the label is visible in front of the object.
      vec3 centerOffset = auxpos1.xyz;

      // The pointGroundDistance is the distance of the geometry to the ground and is
      // negative if the point is below the ground, or positive if the point is above
      // ground.
      float pointGroundDistance = auxpos1.w;

      aux.posModel = position;
      aux.posView = (view * vec4(aux.posModel, 1.0)).xyz;
      aux.vnormal = normal;
      ${e.isDraped?"":"applyHUDVerticalGroundOffset(aux.vnormal, aux.posModel, aux.posView);"}

      // Screen sized offset in world space, used for example for line callouts
      // Note: keep this implementation in sync with the CPU implementation, see
      //   - MaterialUtil.verticalOffsetAtDistance
      //   - HUDMaterial.applyVerticalOffsetTransformation

      aux.distanceToCamera = length(aux.posView);

      vec3 viewDirObjSpace = normalize(cameraPosition - aux.posModel);
      float cosAngle = dot(aux.vnormal, viewDirObjSpace);

      aux.absCosAngle = abs(cosAngle);

      ${e.hasScreenSizePerspective&&(e.hasVerticalOffset||e.screenCenterOffsetUnitsEnabled===Js.Screen)?"vec4 perspectiveFactor = screenSizePerspectiveScaleFactor(aux.absCosAngle, aux.distanceToCamera, screenSizePerspectiveAlignment);":""}

      ${e.hasVerticalOffset?e.hasScreenSizePerspective?"float verticalOffsetScreenHeight = applyScreenSizePerspectiveScaleFactorFloat(verticalOffset.x, perspectiveFactor);":"float verticalOffsetScreenHeight = verticalOffset.x;":""}

      ${e.hasVerticalOffset?_`
            float worldOffset = clamp(verticalOffsetScreenHeight * verticalOffset.y * aux.distanceToCamera, verticalOffset.z, verticalOffset.w);
            vec3 modelOffset = aux.vnormal * worldOffset;
            aux.posModel += modelOffset;
            vec3 viewOffset = (viewNormal * vec4(modelOffset, 1.0)).xyz;
            aux.posView += viewOffset;
            // Since we elevate the object, we need to take that into account
            // in the distance to ground
            pointGroundDistance += worldOffset;`:""}

      float groundRelative = applyHUDViewDependentPolygonOffset(pointGroundDistance, aux.absCosAngle, aux.posView);

      ${e.screenCenterOffsetUnitsEnabled!==Js.Screen?_`
            // Apply x/y in view space, but z in screen space (i.e. along posView direction)
            aux.posView += vec3(centerOffset.x, centerOffset.y, 0.0);

            // Same material all have same z != 0.0 condition so should not lead to
            // branch fragmentation and will save a normalization if it's not needed
            if (centerOffset.z != 0.0) {
              aux.posView -= normalize(aux.posView) * centerOffset.z;
            }
          `:""}

      vec4 posProj = proj * vec4(aux.posView, 1.0);

      ${e.screenCenterOffsetUnitsEnabled===Js.Screen?e.hasScreenSizePerspective?"float centerOffsetY = applyScreenSizePerspectiveScaleFactorFloat(centerOffset.y, perspectiveFactor);":"float centerOffsetY = centerOffset.y;":""}

      ${e.screenCenterOffsetUnitsEnabled===Js.Screen?"posProj.xy += vec2(centerOffset.x, centerOffsetY) * pixelRatio * 2.0 / viewport.zw * posProj.w;":""}

      // constant part of polygon offset emulation
      posProj.z -= groundRelative * polygonOffset * posProj.w;
      return posProj;
    }
  `),t.code.add(_`bool testVisibilityHUD(vec4 posProj) {
vec4 posProjCenter = alignToPixelCenter(posProj, viewport.zw);
vec4 occlusionPixel = texture2D(hudVisibilityTexture, .5 + .5 * posProjCenter.xy / posProjCenter.w);
if (renderTransparentlyOccludedHUD > 0.5) {
return occlusionPixel.r * occlusionPixel.g > 0.0 && occlusionPixel.g * renderTransparentlyOccludedHUD < 1.0;
}
return occlusionPixel.r * occlusionPixel.g > 0.0 && occlusionPixel.g == 1.0;
}`)}(function(i){i[i.World=0]="World",i[i.Screen=1]="Screen",i[i.COUNT=2]="COUNT"})(Js||(Js={}));let _I=class{constructor(){this.factor=new WP,this.factorAlignment=new WP}},WP=class{constructor(){this.scale=0,this.factor=0,this.minPixelSize=0,this.paddingPixels=0}};const vf=128,MC=.5;function yI(i,e=vf,t=e*MC,r=0){const s=iH(i,e,t,r);return new Bf(s,{mipmap:!1,wrap:{s:kt.CLAMP_TO_EDGE,t:kt.CLAMP_TO_EDGE},width:e,height:e,components:4,noUnpackFlip:!0})}function iH(i,e=vf,t=e*MC,r=0){switch(i){case"circle":default:return rH(e,t);case"square":return sH(e,t);case"cross":return nH(e,t,r);case"x":return oH(e,t,r);case"kite":return aH(e,t);case"triangle":return lH(e,t);case"arrow":return cH(e,t)}}function rH(i,e){const t=i/2-.5;return Xf(i,xI(t,t,e/2))}function sH(i,e){return vI(i,e,!1)}function aH(i,e){return vI(i,e,!0)}function nH(i,e,t=0){return bI(i,e,!1,t)}function oH(i,e,t=0){return bI(i,e,!0,t)}function lH(i,e){return Xf(i,wI(i/2,e,e/2))}function cH(i,e){const t=e,r=e/2,s=i/2,a=.8*t,n=xI(s,(i-e)/2-a,Math.sqrt(a*a+r*r)),o=wI(s,t,r);return Xf(i,(l,c)=>Math.max(o(l,c),-n(l,c)))}function vI(i,e,t){return t&&(e/=Math.SQRT2),Xf(i,(r,s)=>{let a=r-.5*i+.25,n=.5*i-s-.75;if(t){const o=(a+n)/Math.SQRT2;n=(n-a)/Math.SQRT2,a=o}return Math.max(Math.abs(a),Math.abs(n))-.5*e})}function bI(i,e,t,r=0){e-=r,t&&(e*=Math.SQRT2);const s=.5*e;return Xf(i,(a,n)=>{let o,l=a-.5*i,c=.5*i-n-1;if(t){const h=(l+c)/Math.SQRT2;c=(c-l)/Math.SQRT2,l=h}return l=Math.abs(l),c=Math.abs(c),o=l>c?l>s?Math.sqrt((l-s)*(l-s)+c*c):c:c>s?Math.sqrt(l*l+(c-s)*(c-s)):l,o-=r/2,o})}function xI(i,e,t){return(r,s)=>{const a=r-i,n=s-e;return Math.sqrt(a*a+n*n)-t}}function wI(i,e,t){const r=Math.sqrt(e*e+t*t);return(s,a)=>{const n=Math.abs(s-i)-t,o=a-i+e/2+.75,l=(e*n+t*o)/r,c=-o;return Math.max(l,c)}}function Xf(i,e){const t=new Uint8Array(4*i*i);for(let r=0;r<i;r++)for(let s=0;s<i;s++){const a=s+i*r;let n=e(s,r);n=n/i+.5,af(n,t,4*a)}return t}function hH(i,e){const{vertex:t,fragment:r}=i;e.hasMultipassGeometry&&t.include(WM),e.hasMultipassTerrain&&i.varyings.add("depth","float"),t.code.add(_`
  void main(void) {
    vec4 posProjCenter;
    if (dot(position, position) > 0.0) {
      // Render single point to center of the pixel to avoid subpixel
      // filtering to affect the marker color
      ProjectHUDAux projectAux;
      vec4 posProj = projectPositionHUD(projectAux);
      posProjCenter = alignToPixelCenter(posProj, viewport.zw);

      ${e.hasMultipassGeometry?_`
        // Don't draw vertices behind geometry
        if(geometryDepthTest(.5 + .5 * posProjCenter.xy / posProjCenter.w, projectAux.posView.z)){
          posProjCenter = vec4(1e038, 1e038, 1e038, 1.0);
        }`:""}

      ${e.hasMultipassTerrain?"depth = projectAux.posView.z;":""}
      vec3 vpos = projectAux.posModel;
      if (rejectBySlice(vpos)) {
        // Project out of clip space
        posProjCenter = vec4(1e038, 1e038, 1e038, 1.0);
      }

    } else {
      // Project out of clip space
      posProjCenter = vec4(1e038, 1e038, 1e038, 1.0);
    }

    gl_Position = posProjCenter;
    gl_PointSize = 1.0;
  }
  `),e.hasMultipassTerrain&&r.include(ml),e.hasMultipassTerrain&&r.uniforms.add([..._v("terrainDepthTexture",(s,a)=>a.multipassTerrain.linearDepthTexture,e.hasWebGL2Context?ms.None:ms.InvSize),new pi("nearFar",(s,a)=>a.camera.nearFar)]),r.include(To),r.code.add(_`
  void main() {
    gl_FragColor = vec4(1, 1, 1, 1);
    ${e.hasMultipassTerrain?_`
          vec2 uv = gl_FragCoord.xy;

          // Read the rgba data from the texture linear depth
          vec4 terrainDepthData = ${ia(e,"terrainDepthTexture","uv")};

          float terrainDepth = linearDepthFromFloat(rgba2float(terrainDepthData), nearFar);

          // If HUD vertex is behind terrain and the terrain depth is not the initialize value (e.g. we are not looking at the sky)
          // Mark the HUD vertex as occluded by transparent terrain
          if(depth < terrainDepth && terrainDepthData != vec4(0,0,0,1)){
            gl_FragColor.g = 0.5;
          }`:""}
  }
  `)}function dH(i){const e=new $t,t=i.signedDistanceFieldEnabled;if(e.include(nC),e.include(fI,i),e.include(Qr,i),i.occlusionPass)return e.include(hH,i),e;const{vertex:r,fragment:s}=e;e.include(R3),s.include(To),s.include(rc),e.include(gF,i),e.include(AT,i),e.varyings.add("vcolor","vec4"),e.varyings.add("vtc","vec2"),e.varyings.add("vsize","vec2"),i.binaryHighlightOcclusionEnabled&&e.varyings.add("voccluded","float"),r.uniforms.add([new ai("viewport",(c,h)=>h.camera.fullViewport),new pi("screenOffset",(c,h)=>zt(TI,2*c.screenOffset[0]*h.camera.pixelRatio,2*c.screenOffset[1]*h.camera.pixelRatio)),new pi("anchorPosition",c=>Uy(c)),new ai("materialColor",c=>c.color),new ue("pixelRatio",(c,h)=>h.camera.pixelRatio)]),t&&(r.uniforms.add(new ai("outlineColor",c=>c.outlineColor)),s.uniforms.add([new ai("outlineColor",c=>XP(c)?c.outlineColor:Bl),new ue("outlineSize",c=>XP(c)?c.outlineSize:0)])),i.hasScreenSizePerspective&&(fF(r),ET(r)),(i.debugDrawLabelBorder||i.binaryHighlightOcclusionEnabled)&&e.varyings.add("debugBorderCoords","vec4"),e.attributes.add(w.UV0,"vec2"),e.attributes.add(w.COLOR,"vec4"),e.attributes.add(w.SIZE,"vec2"),e.attributes.add(w.AUXPOS2,"vec4"),r.code.add(_`
    void main(void) {
      ProjectHUDAux projectAux;
      vec4 posProj = projectPositionHUD(projectAux);
      forwardObjectAndLayerIdColor();

      if (rejectBySlice(projectAux.posModel)) {
        // Project outside of clip plane
        gl_Position = vec4(1e038, 1e038, 1e038, 1.0);
        return;
      }
      vec2 inputSize;
      ${i.hasScreenSizePerspective?_`
      inputSize = screenSizePerspectiveScaleVec2(size, projectAux.absCosAngle, projectAux.distanceToCamera, screenSizePerspective);
      vec2 screenOffsetScaled = screenSizePerspectiveScaleVec2(screenOffset, projectAux.absCosAngle, projectAux.distanceToCamera, screenSizePerspectiveAlignment);
         `:_`
      inputSize = size;
      vec2 screenOffsetScaled = screenOffset;`}

      ${i.vvSize?"inputSize *= vvScale(auxpos2).xx;":""}

      vec2 combinedSize = inputSize * pixelRatio;
      vec4 quadOffset = vec4(0.0);

      ${i.occlusionTestEnabled||i.binaryHighlightOcclusionEnabled?"bool visible = testVisibilityHUD(posProj);":""}

      ${i.binaryHighlightOcclusionEnabled?"voccluded = visible ? 0.0 : 1.0;":""}
    `);const a=_`vec2 uv01 = floor(uv0);
vec2 uv = uv0 - uv01;
quadOffset.xy = ((uv01 - anchorPosition) * 2.0 * combinedSize + screenOffsetScaled) / viewport.zw * posProj.w;`,n=i.pixelSnappingEnabled?t?_`posProj = alignToPixelOrigin(posProj, viewport.zw) + quadOffset;`:_`posProj += quadOffset;
if (inputSize.x == size.x) {
posProj = alignToPixelOrigin(posProj, viewport.zw);
}`:_`posProj += quadOffset;`;i.vvColor&&r.uniforms.add([new MT("vvColorColors",c=>c.vvColorColors,rh),new Ps("vvColorValues",c=>c.vvColorValues,rh)]),r.uniforms.add(new pi("textureCoordinateScaleFactor",c=>g(c.texture)&&g(c.texture.descriptor.textureCoordinateScaleFactor)?c.texture.descriptor.textureCoordinateScaleFactor:Z4)),r.code.add(_`
    ${i.occlusionTestEnabled?"if (visible) {":""}
    ${a}
    ${i.vvColor?"vcolor = vvGetColor(auxpos2, vvColorValues, vvColorColors) * materialColor;":"vcolor = color / 255.0 * materialColor;"}

    ${i.output===A.ObjectAndLayerIdColor?_`vcolor.a = 1.0;`:""}

    bool alphaDiscard = vcolor.a < ${_.float(ra)};
    ${t?`alphaDiscard = alphaDiscard && outlineColor.a < ${_.float(ra)};`:""}
    if (alphaDiscard) {
      // "early discard" if both symbol color (= fill) and outline color (if applicable) are transparent
      gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
      return;
    } else {
      ${n}
      gl_Position = posProj;
    }

    vtc = uv * textureCoordinateScaleFactor;

    ${i.debugDrawLabelBorder?"debugBorderCoords = vec4(uv01, 1.5 / combinedSize);":""}
    vsize = inputSize;
    ${i.occlusionTestEnabled?_`} else { vtc = vec2(0.0);
      ${i.debugDrawLabelBorder?"debugBorderCoords = vec4(0.5, 0.5, 1.5 / combinedSize);}":"}"}`:""}
  }
  `),s.uniforms.add(new lt("tex",c=>c.texture));const o=i.debugDrawLabelBorder?_`(isBorder > 0.0 ? 0.0 : ${_.float(Ex)})`:_.float(Ex),l=_`
    ${i.debugDrawLabelBorder?_`
      float isBorder = float(any(lessThan(debugBorderCoords.xy, debugBorderCoords.zw)) || any(greaterThan(debugBorderCoords.xy, 1.0 - debugBorderCoords.zw)));`:""}

    ${t?_`
      vec4 fillPixelColor = vcolor;

      // Attempt to sample texel centers to avoid that thin cross outlines
      // disappear with large symbol sizes.
      // see: https://devtopia.esri.com/WebGIS/arcgis-js-api/issues/7058#issuecomment-603041
      const float txSize = ${_.float(vf)};
      const float texelSize = 1.0 / txSize;
      // Calculate how much we have to add/subtract to/from each texel to reach the size of an onscreen pixel
      vec2 scaleFactor = (vsize - txSize) * texelSize;
      vec2 samplePos = vtc + (vec2(1.0, -1.0) * texelSize) * scaleFactor;

      // Get distance and map it into [-0.5, 0.5]
      float d = rgba2float(texture2D(tex, samplePos)) - 0.5;

      // Distance in output units (i.e. pixels)
      float dist = d * vsize.x;

      // Create smooth transition from the icon into its outline
      float fillAlphaFactor = clamp(0.5 - dist, 0.0, 1.0);
      fillPixelColor.a *= fillAlphaFactor;

      if (outlineSize > 0.25) {
        vec4 outlinePixelColor = outlineColor;
        float clampedOutlineSize = min(outlineSize, 0.5*vsize.x);

        // Create smooth transition around outline
        float outlineAlphaFactor = clamp(0.5 - (abs(dist) - 0.5*clampedOutlineSize), 0.0, 1.0);
        outlinePixelColor.a *= outlineAlphaFactor;

        if (
          outlineAlphaFactor + fillAlphaFactor < ${o} ||
          fillPixelColor.a + outlinePixelColor.a < ${_.float(ra)}
        ) {
          discard;
        }

        // perform un-premultiplied over operator (see https://en.wikipedia.org/wiki/Alpha_compositing#Description)
        float compositeAlpha = outlinePixelColor.a + fillPixelColor.a * (1.0 - outlinePixelColor.a);
        vec3 compositeColor = vec3(outlinePixelColor) * outlinePixelColor.a +
          vec3(fillPixelColor) * fillPixelColor.a * (1.0 - outlinePixelColor.a);

        gl_FragColor = vec4(compositeColor, compositeAlpha);
      } else {
        if (fillAlphaFactor < ${o}) {
          discard;
        }

        gl_FragColor = premultiplyAlpha(fillPixelColor);
      }

      // visualize SDF:
      // gl_FragColor = vec4(clamp(-dist/vsize.x*2.0, 0.0, 1.0), clamp(dist/vsize.x*2.0, 0.0, 1.0), 0.0, 1.0);
      `:_`
          vec4 texColor = texture2D(tex, vtc, -0.5);
          if (texColor.a < ${o}) {
            discard;
          }
          gl_FragColor = texColor * premultiplyAlpha(vcolor);
          `}

    // Draw debug border with transparency, so that original texels along border are still partially visible
    ${i.debugDrawLabelBorder?_`gl_FragColor = mix(gl_FragColor, vec4(1.0, 0.0, 1.0, 1.0), isBorder * 0.5);`:""}
  `;return i.output===A.Alpha&&s.code.add(_`
      void main() {
        ${l}
        gl_FragColor = vec4(gl_FragColor.a);
      }
      `),i.output===A.ObjectAndLayerIdColor&&s.code.add(_`
      void main() {
        ${l}
        outputObjectAndLayerIdColor();
      }
      `),i.output===A.Color&&s.code.add(_`
    void main() {
      ${l}
      ${i.transparencyPassType===We.FrontFace?"gl_FragColor.rgb /= gl_FragColor.a;":""}
    }
    `),i.output===A.Highlight&&(e.include(Sh,i),s.code.add(_`
    void main() {
      ${l}
      ${i.binaryHighlightOcclusionEnabled?_`
          if (voccluded == 1.0) {
            gl_FragColor = vec4(1.0, 1.0, 0.0, 1.0);
          } else {
            gl_FragColor = vec4(1.0, 0.0, 1.0, 1.0);
          }`:"outputHighlight();"}
    }
    `)),e}function XP(i){return i.outlineColor[3]>0&&i.outlineSize>0}function Uy(i,e=TI){return i.textureIsSignedDistanceField?uH(i.anchorPosition,i.distanceFieldBoundingBox,e):fs(e,i.anchorPosition),e}function uH(i,e,t){g(e)?zt(t,i[0]*(e[2]-e[0])+e[0],i[1]*(e[3]-e[1])+e[1]):zt(t,0,0)}const TI=$e(),pH=Object.freeze(Object.defineProperty({__proto__:null,build:dH,calculateAnchorPosForRendering:Uy},Symbol.toStringTag,{value:"Module"}));let CI=class SI extends Mt{initializeConfiguration(e,t){t.hasWebGL2Context=e.rctx.type===da.WEBGL2,t.spherical=e.viewingMode===ve.Global}initializeProgram(e){return new Rt(e.rctx,SI.shader.get().build(this.configuration),Lt)}_setPipelineState(e){const t=this.configuration,r=e===We.NONE,s=e===We.FrontFace,a=this.configuration.hasPolygonOffset?mH:null,n=(r||s)&&t.output!==A.Highlight&&(t.depthEnabled||t.occlusionPass)?cn:null;return qe({blending:t.output===A.Color||t.output===A.Alpha||t.output===A.Highlight?r?gH:Ph(e):null,depthTest:{func:Fa.LEQUAL},depthWrite:n,colorWrite:at,polygonOffset:a})}initializePipeline(){return this._setPipelineState(this.configuration.transparencyPassType)}get primitiveType(){return this.configuration.occlusionPass?Ut.POINTS:Ut.TRIANGLES}};CI.shader=new Dt(pH,()=>_e(()=>import("./HUDMaterial.glsl-7e0f5284.js"),["assets/HUDMaterial.glsl-7e0f5284.js","assets/calcite-8912bd40.js","assets/index-00759e4a.js","assets/index-5026a37a.css","assets/calcite-96fa36fd.css","assets/floatRGBA-ca2b39ca.js","assets/objectResourceUtils-782953c3.js","assets/devEnvironmentUtils-5002a058.js","assets/mat3f64-50f3b9f6.js","assets/mat4f64-abdda1bb.js","assets/BufferView-379a78a4.js","assets/vec33-69c9e93b.js","assets/DefaultMaterial_COLOR_GAMMA-6ed76d86.js","assets/types-e1c0a5bf.js","assets/enums-e2e92c86.js","assets/Version-aa0a1d91.js","assets/quat-7b70e9a8.js","assets/quatf64-f8f1c132.js","assets/resourceUtils-527631ac.js","assets/basicInterfaces-7449a8bf.js","assets/Indices-d8bff7b2.js","assets/NestedMap-1b5db22e.js","assets/requestImageUtils-d1ba3b36.js","assets/symbolColorUtils-c9d24716.js","assets/Util-6d3f024a.js","assets/sphere-d0e5285d.js","assets/VertexAttribute-15d1866a.js","assets/doublePrecisionUtils-e3c3d0d8.js","assets/OrderIndependentTransparency-5f7257d7.js","assets/Texture-563cf5e5.js","assets/FramebufferObject-8b18fc0c.js","assets/VertexElementDescriptor-2925c6af.js","assets/InterleavedLayout-d57c91d0.js","assets/vec3f32-01c06d8d.js","assets/plane-5e2b046c.js","assets/spatialReferenceEllipsoidUtils-afb35af9.js","assets/scaleUtils-d13015f2.js","assets/ElevationSamplerData-e3118b17.js","assets/Octree-499541ed.js","assets/edgeProcessing-20e12367.js","assets/deduplicate-769a6f51.js","assets/MeshComponent-788e605a.js","assets/earcut-61f7b102.js","assets/imageUtils-c2d0d1ae.js","assets/projection-5969b753.js","assets/ZoomMomentumEstimator-ef57e6a4.js","assets/dehydratedFeatures-3a140d03.js","assets/quantizationUtils-b3b2ae2a.js","assets/labelFormatUtils-71e1f841.js","assets/orientedBoundingBox-a14b97b5.js","assets/quatf32-51a323b8.js","assets/SnappingCandidate-970faec6.js","assets/callExpressionWithFeature-df1a8f01.js","assets/DefaultVertexAttributeLayouts-5f20d8dd.js","assets/geometryServiceUtils-a536bb19.js","assets/project-909a4219.js","assets/LercDecoder-65586d50.js","assets/VectorTile-d41a1f0f.js","assets/enums-fb086c25.js","assets/config-1337d16e.js","assets/TiledDisplayObject-419c008b.js","assets/DisplayObject-87c37b69.js","assets/rasterUtils-7694cc98.js","assets/resources-7587d8f4.js","assets/workerHelper-6131d203.js","assets/webgl-debug-7f880832.js","assets/RenderingContext-0f21aa0e.js","assets/ProgramCache-f29c900e.js","assets/Program-77209250.js","assets/MediaLayer-4c42fc2f.js","assets/MediaElementView-06baa4d4.js","assets/normalizeUtilsSync-3ea564a9.js","assets/resourceExtension-f31d9f10.js","assets/BoundsStore-00da37da.js","assets/PooledRBush-5a11bc7e.js","assets/prism-line-numbers-eff41b13.js","assets/label2-a2f37e65.js","assets/interactive-1de2e238.js","assets/loadable-6afd516d.js","assets/t9n-81df3a71.js","assets/observers-c89705b8.js","assets/icon-8e47fbec.js","assets/loader-c773e800.js","assets/guid-51402ee7.js","assets/prism-line-numbers-7c5d72ff.css"]));const mH={factor:0,units:-4},gH=oc(ae.ONE,ae.ONE_MINUS_SRC_ALPHA);let Di=class extends Vn{constructor(){super(...arguments),this.output=A.Color,this.screenCenterOffsetUnitsEnabled=Js.World,this.transparencyPassType=We.NONE,this.spherical=!1,this.occlusionTestEnabled=!0,this.signedDistanceFieldEnabled=!1,this.vvSize=!1,this.vvColor=!1,this.hasVerticalOffset=!1,this.hasScreenSizePerspective=!1,this.debugDrawLabelBorder=!1,this.binaryHighlightOcclusionEnabled=!0,this.hasSlicePlane=!1,this.hasPolygonOffset=!1,this.depthEnabled=!0,this.pixelSnappingEnabled=!0,this.isDraped=!1,this.hasMultipassGeometry=!1,this.hasMultipassTerrain=!1,this.cullAboveGround=!1,this.occlusionPass=!1,this.objectAndLayerIdColorInstanced=!1}};d([D({count:A.COUNT})],Di.prototype,"output",void 0),d([D({count:Js.COUNT})],Di.prototype,"screenCenterOffsetUnitsEnabled",void 0),d([D({count:We.COUNT})],Di.prototype,"transparencyPassType",void 0),d([D()],Di.prototype,"spherical",void 0),d([D()],Di.prototype,"occlusionTestEnabled",void 0),d([D()],Di.prototype,"signedDistanceFieldEnabled",void 0),d([D()],Di.prototype,"vvSize",void 0),d([D()],Di.prototype,"vvColor",void 0),d([D()],Di.prototype,"hasVerticalOffset",void 0),d([D()],Di.prototype,"hasScreenSizePerspective",void 0),d([D()],Di.prototype,"debugDrawLabelBorder",void 0),d([D()],Di.prototype,"binaryHighlightOcclusionEnabled",void 0),d([D()],Di.prototype,"hasSlicePlane",void 0),d([D()],Di.prototype,"hasPolygonOffset",void 0),d([D()],Di.prototype,"depthEnabled",void 0),d([D()],Di.prototype,"pixelSnappingEnabled",void 0),d([D()],Di.prototype,"isDraped",void 0),d([D()],Di.prototype,"hasMultipassGeometry",void 0),d([D()],Di.prototype,"hasMultipassTerrain",void 0),d([D()],Di.prototype,"cullAboveGround",void 0),d([D()],Di.prototype,"occlusionPass",void 0),d([D()],Di.prototype,"objectAndLayerIdColorInstanced",void 0),d([D({constValue:!0})],Di.prototype,"hasSliceInVertexProgram",void 0),d([D({constValue:!1})],Di.prototype,"hasVvInstancing",void 0);let Wp=class extends jd{constructor(e){super(e,new SH),this._configuration=new Di}getConfiguration(e,t){return this._configuration.output=e,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.hasVerticalOffset=!!this.parameters.verticalOffset,this._configuration.hasScreenSizePerspective=!!this.parameters.screenSizePerspective,this._configuration.screenCenterOffsetUnitsEnabled=this.parameters.centerOffsetUnits==="screen"?Js.Screen:Js.World,this._configuration.hasPolygonOffset=this.parameters.polygonOffset,this._configuration.isDraped=this.parameters.isDraped,this._configuration.occlusionTestEnabled=this.parameters.occlusionTest,this._configuration.pixelSnappingEnabled=this.parameters.pixelSnappingEnabled,this._configuration.signedDistanceFieldEnabled=this.parameters.textureIsSignedDistanceField,this._configuration.vvSize=!!this.parameters.vvSizeEnabled,this._configuration.vvColor=!!this.parameters.vvColorEnabled,this._configuration.occlusionPass=t.slot===K.OCCLUSION_PIXELS&&this.parameters.occlusionTest&&(e===A.Color||e===A.Alpha),e===A.Color&&(this._configuration.debugDrawLabelBorder=!!Ot.LABELS_SHOW_BORDER),e===A.Highlight&&(this._configuration.binaryHighlightOcclusionEnabled=this.parameters.binaryHighlightOcclusion),this._configuration.depthEnabled=this.parameters.depthEnabled,this._configuration.transparencyPassType=t.transparencyPassType,this._configuration.hasMultipassGeometry=t.multipassGeometry.enabled,this._configuration.hasMultipassTerrain=t.multipassTerrain.enabled,this._configuration.cullAboveGround=t.multipassTerrain.cullAboveGround,this._configuration}intersect(e,t,r,s,a,n){if(!r.options.selectionMode||!r.options.hud||!e.visible)return;const o=this.parameters;let l=1,c=1;if(Xl(nb,t),g(e.shaderTransformer)){const S=e.shaderTransformer(YP);l=S[0],c=S[5],yH(nb)}const h=e.vertexAttributes.get(w.POSITION),u=e.vertexAttributes.get(w.SIZE),p=e.vertexAttributes.get(w.NORMAL),m=e.vertexAttributes.get(w.AUXPOS1);dt(h.size>=3);const f=r.point,y=r.camera,b=Uy(o);l*=y.pixelRatio,c*=y.pixelRatio;const x=this.parameters.centerOffsetUnits==="screen";for(let S=0;S<h.data.length/h.size;S++){const C=S*h.size;j(as,h.data[C],h.data[C+1],h.data[C+2]),xe(as,as,t);const O=S*u.size;vc[0]=u.data[O]*l,vc[1]=u.data[O+1]*c,xe(as,as,y.viewMatrix);const R=S*m.size;if(j(Ga,m.data[R+0],m.data[R+1],m.data[R+2]),!x&&(as[0]+=Ga[0],as[1]+=Ga[1],Ga[2]!==0)){const $=Ga[2];W(Ga,as),Q(as,as,B(Ga,Ga,$))}const E=S*p.size;if(j(Om,p.data[E],p.data[E+1],p.data[E+2]),this._normalAndViewAngle(Om,nb,y,ob),this._applyVerticalOffsetTransformationView(as,ob,y,ab),y.applyProjection(as,xs),xs[0]>-1){xs[0]=Math.floor(xs[0]),xs[1]=Math.floor(xs[1]),x&&(Ga[0]||Ga[1])&&(xs[0]+=Ga[0],Ga[1]!==0&&(xs[1]+=_F(Ga[1],ab.factorAlignment)),y.unapplyProjection(xs,as)),xs[0]+=this.parameters.screenOffset[0],xs[1]+=this.parameters.screenOffset[1],E3(vc,ab.factor,vc);const $=wH*y.pixelRatio;let M=0;if(o.textureIsSignedDistanceField&&(M=o.outlineSize*y.pixelRatio/2),f&&QP(f,xs[0],xs[1],vc,$,M,o,b)){const L=r.ray;if(xe(ZP,as,$a(xH,y.viewMatrix)),xs[0]=f[0],xs[1]=f[1],y.unprojectFromRenderScreen(xs,as)){const F=T();H(F,L.direction);const N=1/pe(F);B(F,F,N),n(yi(L.origin,as)*N,F,-1,!0,1,ZP)}}}}}intersectDraped(e,t,r,s,a,n){const o=e.vertexAttributes.get(w.POSITION),l=e.vertexAttributes.get(w.SIZE),c=this.parameters,h=Uy(c);let u=1,p=1;if(g(e.shaderTransformer)){const f=e.shaderTransformer(YP);u=f[0],p=f[5]}u*=e.screenToWorldRatio,p*=e.screenToWorldRatio;const m=TH*e.screenToWorldRatio;for(let f=0;f<o.data.length/o.size;f++){const y=f*o.size,b=o.data[y],x=o.data[y+1],S=f*l.size;vc[0]=l.data[S]*u,vc[1]=l.data[S+1]*p;let C=0;c.textureIsSignedDistanceField&&(C=c.outlineSize*e.screenToWorldRatio/2),QP(s,b,x,vc,m,C,c,h)&&a(n.dist,n.normal,-1,!1)}}createBufferWriter(){return new OH(this)}_normalAndViewAngle(e,t,r,s){return tH(t)&&(t=Xl(bH,t)),el(s.normal,e,t),xe(s.normal,s.normal,r.viewInverseTransposeMatrix),s.cosAngle=J(PI,CH),s}_updateScaleInfo(e,t,r){const s=this.parameters;g(s.screenSizePerspective)?n2(r,t,s.screenSizePerspective,e.factor):(e.factor.scale=1,e.factor.factor=0,e.factor.minPixelSize=0,e.factor.paddingPixels=0),g(s.screenSizePerspectiveAlignment)?n2(r,t,s.screenSizePerspectiveAlignment,e.factorAlignment):(e.factorAlignment.factor=e.factor.factor,e.factorAlignment.scale=e.factor.scale,e.factorAlignment.minPixelSize=e.factor.minPixelSize,e.factorAlignment.paddingPixels=e.factor.paddingPixels)}applyShaderOffsetsView(e,t,r,s,a,n,o){const l=this._normalAndViewAngle(t,r,a,ob);return this._applyVerticalGroundOffsetView(e,l,a,o),this._applyVerticalOffsetTransformationView(o,l,a,n),this._applyPolygonOffsetView(o,l,s[3],a,o),this._applyCenterOffsetView(o,s,o),o}applyShaderOffsetsNDC(e,t,r,s,a){return this._applyCenterOffsetNDC(e,t,r,s),g(a)&&H(a,s),this._applyPolygonOffsetNDC(s,t,r,s),s}_applyPolygonOffsetView(e,t,r,s,a){const n=s.aboveGround?1:-1;let o=Math.sign(r);o===0&&(o=n);const l=n*o;if(this.parameters.shaderPolygonOffset<=0)return H(a,e);const c=ee(Math.abs(t.cosAngle),.01,1),h=1-Math.sqrt(1-c*c)/c/s.viewport[2];return B(a,e,l>0?h:1/h),a}_applyVerticalGroundOffsetView(e,t,r,s){const a=pe(e),n=r.aboveGround?1:-1,o=.5*r.computeRenderPixelSizeAtDist(a),l=B(as,t.normal,n*o);return X(s,e,l),s}_applyVerticalOffsetTransformationView(e,t,r,s){const a=this.parameters;if(!a.verticalOffset||!a.verticalOffset.screenLength){if(a.screenSizePerspective||a.screenSizePerspectiveAlignment){const c=pe(e);this._updateScaleInfo(s,c,t.cosAngle)}else s.factor.scale=1,s.factorAlignment.scale=1;return e}const n=pe(e),o=je(a.screenSizePerspectiveAlignment,a.screenSizePerspective),l=yF(r,n,a.verticalOffset,t.cosAngle,o);return this._updateScaleInfo(s,n,t.cosAngle),B(t.normal,t.normal,l),X(e,e,t.normal)}_applyCenterOffsetView(e,t,r){const s=this.parameters.centerOffsetUnits!=="screen";return r!==e&&H(r,e),s&&(r[0]+=t[0],r[1]+=t[1],t[2]&&(W(Om,r),X(r,r,B(Om,Om,t[2])))),r}_applyCenterOffsetNDC(e,t,r,s){const a=this.parameters.centerOffsetUnits!=="screen";return s!==e&&H(s,e),a||(s[0]+=t[0]/r.fullWidth*2,s[1]+=t[1]/r.fullHeight*2),s}_applyPolygonOffsetNDC(e,t,r,s){const a=this.parameters.shaderPolygonOffset;if(e!==s&&H(s,e),a){const n=r.aboveGround?1:-1,o=n*Math.sign(t[3]);s[2]-=(o||n)*a}return s}requiresSlot(e,t){if(t===A.Color||t===A.Alpha||t===A.Highlight||t===A.ObjectAndLayerIdColor){if(e===K.DRAPED_MATERIAL)return!0;const{drawInSecondSlot:r,occlusionTest:s}=this.parameters;return e===(r?K.LABEL_MATERIAL:K.HUD_MATERIAL)||s&&e===K.OCCLUSION_PIXELS}return!1}createGLMaterial(e){return new fH(e)}calculateRelativeScreenBounds(e,t,r=yt()){return _H(this.parameters,e,t,r),r[2]=r[0]+e[0],r[3]=r[1]+e[1],r}},fH=class extends A3{constructor(e){super({...e,...e.material.parameters})}selectProgram(e){return this.ensureTechnique(CI,e)}beginSlot(e){return this.updateTexture(this._material.parameters.textureId),this._material.setParameters(this.textureBindParameters),this.selectProgram(e)}};function _H(i,e,t,r=vH){return fs(r,i.anchorPosition),r[0]*=-e[0],r[1]*=-e[1],r[0]+=i.screenOffset[0]*t,r[1]+=i.screenOffset[1]*t,r}function yH(i){const e=i[0],t=i[1],r=i[2],s=i[3],a=i[4],n=i[5],o=i[6],l=i[7],c=i[8],h=1/Math.sqrt(e*e+t*t+r*r),u=1/Math.sqrt(s*s+a*a+n*n),p=1/Math.sqrt(o*o+l*l+c*c);return i[0]=e*h,i[1]=t*h,i[2]=r*h,i[3]=s*u,i[4]=a*u,i[5]=n*u,i[6]=o*p,i[7]=l*p,i[8]=c*p,i}function QP(i,e,t,r,s,a,n,o){let l=e-s-(o[0]>0?r[0]*o[0]:0),c=l+r[0]+2*s,h=t-s-(o[1]>0?r[1]*o[1]:0),u=h+r[1]+2*s;const p=n.distanceFieldBoundingBox;return n.textureIsSignedDistanceField&&g(p)&&(l+=r[0]*p[0],h+=r[1]*p[1],c-=r[0]*(1-p[2]),u-=r[1]*(1-p[3]),l-=a,c+=a,h-=a,u+=a),i[0]>l&&i[0]<c&&i[1]>h&&i[1]<u}const ab=new _I,vH=$e(),as=T(),Om=T(),xs=Pt(),PI=T(),ZP=T(),nb=ys(),bH=ys(),xH=ce(),Ga=T(),ob={normal:PI,cosAngle:0},YP=ce(),wH=1,TH=2,vc=[0,0],CH=Ge(0,0,1);let SH=class extends vF{constructor(){super(...arguments),this.renderOccluded=qi.Occlude,this.color=hi(1,1,1,1),this.texCoordScale=[1,1],this.polygonOffset=!1,this.anchorPosition=It(.5,.5),this.screenOffset=[0,0],this.shaderPolygonOffset=1e-5,this.textureIsSignedDistanceField=!1,this.outlineColor=hi(1,1,1,1),this.outlineSize=0,this.vvSizeEnabled=!1,this.vvSizeMinSize=[1,1,1],this.vvSizeMaxSize=[100,100,100],this.vvSizeOffset=[0,0,0],this.vvSizeFactor=[1,1,1],this.vvColorEnabled=!1,this.vvColorValues=[0,0,0,0,0,0,0,0],this.vvColorColors=[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],this.hasSlicePlane=!1,this.pixelSnappingEnabled=!0,this.occlusionTest=!0,this.binaryHighlightOcclusion=!0,this.centerOffsetUnits="world",this.drawInSecondSlot=!1,this.depthEnabled=!0,this.isDraped=!1}};const OI=mr().vec3f(w.POSITION).vec3f(w.NORMAL).vec2f(w.UV0).vec4u8(w.COLOR).vec2f(w.SIZE).vec4f(w.AUXPOS1).vec4f(w.AUXPOS2),PH=OI.clone().vec4u8(w.OBJECTANDLAYERIDCOLOR);let OH=class{constructor(e){this._material=e,this.vertexBufferLayout=vi("enable-feature:objectAndLayerId-rendering")?PH:OI}allocate(e){return this.vertexBufferLayout.createBuffer(e)}elementCount(e){return 6*e.indices.get(w.POSITION).length}write(e,t,r,s,a){DT(r.indices.get(w.POSITION),r.vertexAttributes.get(w.POSITION).data,e,s.position,a,6),M3(r.indices.get(w.NORMAL),r.vertexAttributes.get(w.NORMAL).data,t,s.normal,a,6);const n=r.vertexAttributes.get(w.UV0).data;let o,l,c,h;if(n==null||n.length<4){const x=this._material.parameters;o=0,l=0,c=x.texCoordScale[0],h=x.texCoordScale[1]}else o=n[0],l=n[1],c=n[2],h=n[3];c=Math.min(1.99999,c+1),h=Math.min(1.99999,h+1);let u=r.indices.get(w.POSITION).length,p=a;const m=s.uv0;for(let x=0;x<u;++x)m.set(p,0,o),m.set(p,1,l),p+=1,m.set(p,0,c),m.set(p,1,l),p+=1,m.set(p,0,c),m.set(p,1,h),p+=1,m.set(p,0,c),m.set(p,1,h),p+=1,m.set(p,0,o),m.set(p,1,h),p+=1,m.set(p,0,o),m.set(p,1,l),p+=1;D3(r.indices.get(w.COLOR),r.vertexAttributes.get(w.COLOR).data,4,s.color,a,6);const f=r.indices.get(w.SIZE),y=r.vertexAttributes.get(w.SIZE).data;u=f.length;const b=s.size;p=a;for(let x=0;x<u;++x){const S=y[2*f[x]],C=y[2*f[x]+1];for(let O=0;O<6;++O)b.set(p,0,S),b.set(p,1,C),p+=1}if(r.indices.get(w.AUXPOS1)&&r.vertexAttributes.get(w.AUXPOS1)?uy(r.indices.get(w.AUXPOS1),r.vertexAttributes.get(w.AUXPOS1).data,s.auxpos1,a,6):o2(s.auxpos1,a,6*u),r.indices.get(w.AUXPOS2)&&r.vertexAttributes.get(w.AUXPOS2)?uy(r.indices.get(w.AUXPOS2),r.vertexAttributes.get(w.AUXPOS2).data,s.auxpos2,a,6):o2(s.auxpos2,a,6*u),g(r.objectAndLayerIdColor)&&r.indices.get(w.POSITION)){const x=r.indices.get(w.POSITION).length,S=s.getField(w.OBJECTANDLAYERIDCOLOR,fh);bF(r.objectAndLayerIdColor,S,x,a,6)}}};const Eo=T(),Cu=Pt(),Rm=Pt(),lb=T(),RH=ce(),EH=Nn(),cb=Aa(),AH=T(),MH=yt();class DH{constructor(){this.aabr=yt(),this.distance=0,this.culled=!1,this.visible=!1}}class IH{constructor(e,t){this.graphics3DGraphic=e,this.slicePlaneEnabled=t,this.info={}}}var Sa;(function(i){i[i.Idle=0]="Idle",i[i.Process=1]="Process",i[i.Sort=2]="Sort",i[i.Deconflict=3]="Deconflict",i[i.NumStates=4]="NumStates"})(Sa||(Sa={}));class RI{constructor(){this.camera=new Fe,this.slicePlane=cc(),this.slicePlaneEnabled=!1}copyFrom(e){this.camera.copyFrom(e.camera),Qd(e.slicePlane,this.slicePlane),this.slicePlaneEnabled=e.slicePlaneEnabled}}let fp=class extends Ie{get dirty(){return this._dirty}get state(){return this._state}constructor(i){super(i),this._dirty=!1,this._runningViewState=new RI,this._state=Sa.Idle,this._active=new Map,this._visible=new Map,this._iterators=new FH,this._accBinsNumX=15,this._accBinsNumY=20,this._accBinsSizeX=0,this._accBinsSizeY=0,this._accBins=null,this.accNumTests=0}destroy(){this._active.clear(),this._visible.clear(),this._iterators=null}setDirty(){!this._dirty&&this._active.size>0&&(this._dirty=!0,this.notifyChange("updating"))}get updating(){return this._state!==Sa.Idle||this._dirty}get updatingProgress(){if(!this.updating)return 1;const i=this._state/Sa.NumStates;return this._dirty?.5*i:i}get running(){return this.view.ready&&this.view.state!=null&&this.updating}runTask(i){switch(this._state){case Sa.Idle:this._startUpdate(),i.madeProgress();case Sa.Process:if(this._state=Sa.Process,!this._processActiveGraphics(i))return;case Sa.Sort:if(this._state=Sa.Sort,!this._sortVisibleGraphics(i))return;case Sa.Deconflict:if(this._state=Sa.Deconflict,!this._deconflictVisibleGraphics(i))return;default:QB(this,this._visible),this._state=Sa.Idle,this.notifyChange("updating")}}modifyGraphics(i,e){e?i.forEach(t=>this.addToActiveGraphics(t)):i.forEach(t=>this.removeFromActiveGraphics(t)),this.setDirty()}layerSupportsDeconfliction(i){if(P(i)||i.type!=="object3d")return!1;const e=i.stageObject;if((e?e.geometries.length:0)!==1)return!1;const t=e==null?void 0:e.geometries[0];return(t==null?void 0:t.material)instanceof Wp}_startUpdate(){ZB(this.view),this._dirty=!1,this._runningViewState.copyFrom(this.viewState);const{fullWidth:i,fullHeight:e}=this._runningViewState.camera;this._initBins(i,e),this._resetIterators()}addToActiveGraphics(i){i.info[this.visibilityGroup]=new DH,this._active.set(i.graphics3DGraphic.graphic.uid,i),this.setDirty()}removeFromActiveGraphics(i){this._visible.delete(i.graphics3DGraphic.graphic.uid),LH(i,this.visibilityGroup),delete i.info[this.visibilityGroup],this._active.delete(i.graphics3DGraphic.graphic.uid),this.setDirty()}_processActiveGraphics(i){const e=this._ensureActiveGraphicsIterator(),t=Vf(RH,this._runningViewState.camera.projectionMatrix),r=this.view.viewingMode==="global"&&this.view.map.ground.opacity===1&&this._runningViewState.camera.relativeElevation>0?EH:null;let s=0;for(g(r)&&(xe(r,on,this._runningViewState.camera.viewMatrix),r[3]=Et(this.view.spatialReference).radius,s=W9(r,on));!i.done;){i.madeProgress();const a=e.next();if(a.done===!0)return this._resetActiveGraphicsIterator(),!0;const n=a.value,o=n&&n.info[this.visibilityGroup];o&&(this._collectGraphics3DGraphics(n,t,r,s),o.culled?this._visible.delete(n.graphics3DGraphic.graphic.uid):this._visible.set(n.graphics3DGraphic.graphic.uid,n))}return!1}_sortVisibleGraphics(i){const e=this._ensureSortGraphicsIterator();for(;!i.done;){const t=e.next();if(i.madeProgress(),t.done===!0)return this._resetSortGraphicsIterator(),!0}return!1}_deconflictVisibleGraphics(i){const e=this._ensureVisibleGraphicsIterator(),t=this.visibilityGroup===Fr.LABEL;for(;!i.done;){i.madeProgress();const r=e.next();if(r.done===!0)return this._resetVisibleGraphicsIterator(),!0;const s=r.value,a=s.info[this.visibilityGroup];if(!a||a.culled)continue;const n=s.graphics3DGraphic,o=(!t||n.isVisible())&&!this._isConflicted(s);o&&this._addToBins(s),a.visible=o,this._setGraphicVisibility(s,o),KB(a,o)}return!1}_resetIterators(){this._iterators.active=null,this._iterators.visible=null,this._iterators.sort=null}_ensureActiveGraphicsIterator(){return this._iterators.active||(this._iterators.active=KP(this._active)),this._iterators.active}_resetActiveGraphicsIterator(){this._iterators.active=null}_ensureVisibleGraphicsIterator(){return this._iterators.visible||(this._iterators.visible=KP(this._visible)),this._iterators.visible}_resetVisibleGraphicsIterator(){this._iterators.visible=null}_ensureSortGraphicsIterator(){return this._iterators.sort||(this._iterators.sort=$H(this._visible,this._iterators.sortArray,this.visibilityGroup)),this._iterators.sort}_resetSortGraphicsIterator(){this._iterators.sort=null}_collectGraphics3DGraphics(i,e,t,r){const s=i.graphics3DGraphic;if(s.destroyed)return;const a=i.info[this.visibilityGroup];if(!s.isVisible(Fr.GRAPHIC,Ma.DECONFLICTION))return void(a.culled=!0);const n=this.getGraphicsLayers(s);bo(a.aabr);let o=null;for(const l of n){if(!this.layerSupportsDeconfliction(l))continue;const c=l.stageObject.geometries[0].material;if(P(o)){if(o=VH,this._getProjectionInfo(l,e,o),o.isOutsideScreen||this._isCulledBySlice(i,Eo)||g(t)&&this._isCulledByHorizon(o,t,r))return void(a.culled=!0);!Ot.TESTS_DISABLE_OPTIMIZATIONS&&a.visible&&(o.distance*=.7)}this._expandBoundingRect(a,l,c,o)}P(o)?a.culled=!0:(a.distance=o.distance,a.culled=!1)}_getProjectionInfo(i,e,t){const r=this._runningViewState.camera,s=i.stageObject,a=s.geometries[0],n=a.material,o=OT(s.boundingVolumeWorldSpace.bounds);xe(Eo,o,r.viewMatrix);const l=a.vertexAttributes,c=l.get(w.NORMAL).data,h=l.get(w.AUXPOS1).data;n.applyShaderOffsetsView(Eo,c,s.transformation,h,r,t.scaleInfo,Eo),Br(Cu,Eo[0],Eo[1],Eo[2],1),Ul(Rm,Cu,r.projectionMatrix),B(t.positionNDC,Rm,1/Rm[3]),n.applyShaderOffsetsNDC(t.positionNDC,h,r,t.positionNDC,lb),t.distanceWithoutPolygonOffset=r.depthNDCToWorld(lb[2]),t.distance=lb[2]===t.positionNDC[2]?t.distanceWithoutPolygonOffset:r.depthNDCToWorld(t.positionNDC[2]),Br(Rm,t.positionNDC[0],t.positionNDC[1],t.positionNDC[2],1),Ul(Cu,Rm,e),sv(Cu,Cu,1/Cu[3]),j(t.positionView,Eo[0],Eo[1],Eo[2])}_isCulledByHorizon(i,e,t){return H(cb.direction,i.positionView),j(cb.origin,0,0,0),!!uv(e,cb,AH)&&i.distanceWithoutPolygonOffset>t}_isCulledBySlice(i,e){return i.slicePlaneEnabled&&this._runningViewState.slicePlaneEnabled&&QT(this._runningViewState.slicePlane,e)}_expandBoundingRect(i,e,t,{positionNDC:r,scaleInfo:s}){const a=this._runningViewState.camera,n=e.getScreenSize(zH);E3(n,s.factor,n),n[0]*=a.pixelRatio,n[1]*=a.pixelRatio;const o=cy(t.calculateRelativeScreenBounds(n,s.factorAlignment.scale,MH),st(0,a.fullWidth,.5+.5*r[0]),st(0,a.fullHeight,.5+.5*r[1])),l=this.iconMarginFactor;if(l!==0){const c=l*Math.min(Yo(o),dh(o));o[0]-=c,o[1]-=c,o[2]+=c,o[3]+=c}eh(i.aabr,o,i.aabr)}_isConflicted(i){const e=i.graphics3DGraphic.graphic.uid,t=i.info[this.visibilityGroup];for(let r=Math.floor(t.aabr[0]/this._accBinsSizeX);r<=Math.floor(t.aabr[2]/this._accBinsSizeX);r++)if(!(r<0||r>=this._accBinsNumX))for(let s=Math.floor(t.aabr[1]/this._accBinsSizeY);s<=Math.floor(t.aabr[3]/this._accBinsSizeY);s++){if(s<0||s>=this._accBinsNumY)continue;const a=this._accBins[r][s];for(let n=0;n<a.length;n++){const o=a.data[n],l=o.info[this.visibilityGroup];if(l&&l.visible&&o.graphics3DGraphic.graphic.uid!==e&&(this.accNumTests++,ov(l.aabr,t.aabr)))return!0}}return!1}_initBins(i,e){if(this._accBins==null){this._accBins=[];for(let t=0;t<this._accBinsNumX;t++){this._accBins.push([]);const r=this._accBins[this._accBins.length-1];for(let s=0;s<this._accBinsNumY;s++)r.push(new At)}}else for(let t=0;t<this._accBinsNumX;t++)for(let r=0;r<this._accBinsNumY;r++)this._accBins[t][r].clear();this._accBinsSizeX=i/this._accBinsNumX,this._accBinsSizeY=e/this._accBinsNumY,this.accNumTests=0}_addToBins(i){const e=i.info[this.visibilityGroup],t=Math.floor(e.aabr[0]/this._accBinsSizeX),r=Math.floor(e.aabr[2]/this._accBinsSizeX),s=Math.floor(e.aabr[1]/this._accBinsSizeY),a=Math.floor(e.aabr[3]/this._accBinsSizeY);for(let n=t;n<=r;n++)if(!(n<0||n>=this._accBinsNumX))for(let o=s;o<=a;o++)o<0||o>=this._accBinsNumY||this._accBins[n][o].push(i)}_setGraphicVisibility(i,e){const t=i.graphics3DGraphic;t.destroyed||(t.setVisibilityFlag(Ma.DECONFLICTION,e,this.visibilityGroup),this.visibilityGroup===Fr.LABEL&&this.view.labeler.setLabelGraphicVisibility(t,e))}};function LH(i,e){const t=i.graphics3DGraphic;t.destroyed||t.clearVisibilityFlag(Ma.DECONFLICTION,e)}function*KP(i){if(Map.prototype.entries){const e=i.entries();for(let t=e.next();!t.done;t=e.next())yield t.value[1]}else yield*i.values()}function*$H(i,e,t){e.clear(),i.forEach((s,a)=>{const n=e.pushNew();n.id=a,n.visible=s.graphics3DGraphic.hasVisibilityFlag(Ma.DECONFLICTION,t),n.prio=s.info?s.info[t].distance:Number.MAX_VALUE}),yield;const r=e.iterableSort((s,a)=>s.visible!==a.visible?s.visible?-1:1:s.prio!==a.prio?s.prio-a.prio:s.id-a.id);for(let s=r.next();!s.done;s=r.next())yield;e.forAll(s=>{const a=i.get(s.id);a&&(i.delete(s.id),i.set(s.id,a))}),e.clear()}d([v({constructOnly:!0})],fp.prototype,"view",void 0),d([v({type:Boolean,readOnly:!0})],fp.prototype,"updating",null),fp=d([Y("esri.views.3d.layers.graphics.Deconflictor")],fp);class NH{}class FH{constructor(e=null,t=null,r=null){this.active=e,this.visible=t,this.sort=r,this.sortArray=new At({allocator:s=>s||new NH})}}const zH=$e();class UH{constructor(){this.positionView=T(),this.positionNDC=T(),this.distance=0,this.distanceWithoutPolygonOffset=0,this.scaleInfo=new _I}get isOutsideScreen(){const e=this.positionNDC;return e[0]<-1||e[1]<-1||e[2]<-1||e[0]>=1||e[1]>=1}}const VH=new UH,GH=2e3;let j0=class extends fp{constructor(e){super(e),this.visibilityGroup=Fr.LABEL,this.iconMarginFactor=0,this._lastDeconfliction=0}get viewState(){return this.parent.viewState}runTask(e){if(this.parent.running)return na.YIELD;const t=performance.now();if(e.state!==ii.IDLE&&t-this._lastDeconfliction<GH)return na.YIELD;super.runTask(e),this.state===Sa.Idle&&(this._lastDeconfliction=t)}enabledChanged(e,t){this.modifyGraphics(t,e.labelsEnabled)}getGraphicsLayers(e){return e.labelLayers}};d([v({constructOnly:!0})],j0.prototype,"parent",void 0),j0=d([Y("esri.views.3d.layers.graphics.LabelDeconflictor")],j0);let vw=class extends fp{constructor(){super(...arguments),this._handles=new Vi,this._contexts=new Map,this._viewState=new RI,this.visibilityGroup=Fr.GRAPHIC,this._iconMarginFactor=-.1}get labels(){return this._labels}get viewState(){return this._viewState}initialize(){this._handles.add([te(()=>{var e,t;return(t=(e=this.view)==null?void 0:e.state)==null?void 0:t.camera},()=>{this._updateViewState(),this.setDirty()}),te(()=>{var e,t,r;return(r=(t=(e=this.view)==null?void 0:e.map)==null?void 0:t.ground)==null?void 0:r.opacity},(e,t)=>{e!==1&&t!==1||this.setDirty()}),te(()=>{var e;return(e=this.view)==null?void 0:e.slicePlane},()=>{this._updateSlicePlane(),this._slicePlaneChanged()},Ji)]),this._frameTask=this.view.resourceController.scheduler.registerTask(Zi.GRAPHICS_DECONFLICTOR,this),this._labels=new j0({view:this.view,parent:this})}destroy(){this._labels.destroy(),this._labels=null,this._handles.destroy(),this._handles=null,this._frameTask&&(this._frameTask.remove(),this._frameTask=null)}get iconMarginFactor(){return this._iconMarginFactor}set iconMarginFactor(e){this._iconMarginFactor=e,this.setDirty()}setDirty(){this._contexts.size>0&&(super.setDirty(),this._labels.setDirty())}runTask(e){super.runTask(e),this.running||this._labels.setDirty()}setInitialIconVisibilityFlag(e,t){const r=!(this._graphicSupportsDeconfliction(t)&&hb(e));t.setVisibilityFlag(Ma.DECONFLICTION,r,Fr.GRAPHIC)}_updateViewState(){this.view&&this.view.state&&(this._viewState.camera.copyFrom(this.view.state.camera),this._updateSlicePlane())}_updateSlicePlane(){const e=this.view?this.view.slicePlane:null;g(e)&&wM(e,this._viewState.camera.viewMatrix,this._viewState.slicePlane),this._viewState.slicePlaneEnabled=g(e)}_slicePlaneChanged(){Ks(this._contexts,(e,t)=>t.symbolCreationContext.slicePlaneEnabled)&&this.setDirty()}addGraphicsOwner(e){const t=this._getGraphicsContext(e);return{addGraphic:r=>this._addGraphic(e,t,r),removeGraphic:r=>this._removeGraphic(t,r),labelingInfoChange:()=>this._labels.enabledChanged(e,t),featureReductionChange:()=>this.enabledChanged(e,t),slicePlaneEnabledChange:()=>this._slicePlaneEnabledChanged(e,t),clear:()=>t.forEach(r=>this._removeGraphic(t,r.graphics3DGraphic))}}removeGraphicsOwner(e){const t=this._contexts.get(e);t&&(t.forEach(r=>this._removeGraphic(t,r.graphics3DGraphic)),this._contexts.delete(e),this.setDirty())}_addGraphic(e,t,r){const s=r.graphic.uid,a=new IH(r,e.symbolCreationContext.slicePlaneEnabled);t.set(s,a),hb(e)&&this.addToActiveGraphics(a),e.labelsEnabled&&this._labels.addToActiveGraphics(a)}_removeGraphic(e,t){const r=t.graphic.uid,s=e.get(r);s&&(this.removeFromActiveGraphics(s),this._labels.removeFromActiveGraphics(s),e.delete(r),this.setDirty())}enabledChanged(e,t){const r=hb(e);r||BH(e),this.modifyGraphics(t,r)}_slicePlaneEnabledChanged(e,t){const r=e.symbolCreationContext.slicePlaneEnabled;t.forEach(s=>s.slicePlaneEnabled=r),this.setDirty()}getGraphicsLayers(e){return e.layers}_graphicSupportsDeconfliction(e){if(e.isDraped)return!1;const t=e.layers;if(!t||!t.length)return!1;for(const r of t)if(this.layerSupportsDeconfliction(r))return!0;return!1}_getGraphicsContext(e){const t=this._contexts.get(e);if(t)return t;const r=new Map;return this._contexts.set(e,r),this.setDirty(),r}};function hb(i){const e=i.layer;return!(!e||!e.featureReduction||e.featureReduction.type!=="selection")}function BH(i){const e=i.graphics3DGraphics;e&&e.forEach(t=>t.clearVisibilityFlag(Ma.DECONFLICTION))}vw=d([Y("esri.views.3d.layers.graphics.GraphicsDeconflictor")],vw);function EI(i){return"declaredClass"in i}function JP(i){return"declaredClass"in i}function HH(i){return"declaredClass"in i}function kH(i,e){return i?HH(i)?i:new nv({layer:e,sourceLayer:e,visible:i.visible,symbol:Gl(i.symbol),attributes:Gl(i.attributes),geometry:AI(i.geometry)}):null}function AI(i){return P(i)?null:EI(i)?i:Y4(jH(i))}function jH(i){const{wkid:e,wkt:t,latestWkid:r}=i.spatialReference,s={wkid:e,wkt:t,latestWkid:r};switch(i.type){case"point":{const{x:a,y:n,z:o,m:l}=i;return{x:a,y:n,z:o,m:l,spatialReference:s}}case"polygon":{const{rings:a,hasZ:n,hasM:o}=i;return{rings:eO(a),hasZ:n,hasM:o,spatialReference:s}}case"polyline":{const{paths:a,hasZ:n,hasM:o}=i;return{paths:eO(a),hasZ:n,hasM:o,spatialReference:s}}case"extent":{const{xmin:a,xmax:n,ymin:o,ymax:l,zmin:c,zmax:h,mmin:u,mmax:p,hasZ:m,hasM:f}=i;return{xmin:a,xmax:n,ymin:o,ymax:l,zmin:c,zmax:h,mmin:u,mmax:p,hasZ:m,hasM:f,spatialReference:s}}case"multipoint":{const{points:a,hasZ:n,hasM:o}=i;return{points:DI(a)?MI(a):a,hasZ:n,hasM:o,spatialReference:s}}default:return}}function eO(i){return qH(i)?i.map(e=>MI(e)):i}function MI(i){return i.map(e=>Array.from(e))}function qH(i){for(const e of i)if(e.length!==0)return DI(e);return!1}function DI(i){return i.length>0&&(BA(i[0])||HA(i[0]))}function WH(i,e){if(!i)return null;let t;if(JP(i)){if(e==null)return i.clone();if(JP(e))return e.copy(i)}return e!=null?(t=e,t.x=i.x,t.y=i.y,t.spatialReference=i.spatialReference,i.hasZ?(t.z=i.z,t.hasZ=i.hasZ):(t.z=void 0,t.hasZ=!1),i.hasM?(t.m=i.m,t.hasM=!0):(t.m=void 0,t.hasM=!1)):(t=lc(i.x,i.y,i.z,i.spatialReference),i.hasM&&(t.m=i.m,t.hasM=!0)),t}function one(i){const{wkid:e,wkt:t,latestWkid:r}=i,s={wkid:e,wkt:t,latestWkid:r};return li.fromJSON(s)}let II=class{constructor(e=null,t="center",r="center",s=null,a=[0,0,0],n=0,o=[0,0,0,1],l=[0,0],c="world",h=0,u=0){this.verticalOffset=e,this.horizontalPlacement=t,this.verticalPlacement=r,this.text=s,this.translation=a,this.elevationOffset=n,this.centerOffset=o,this.screenOffset=l,this.centerOffsetUnits=c,this.displayWidth=h,this.displayHeight=u}};function DC(i,e){if(i.type==="point")return bc(i,e,!1);if(EI(i))switch(i.type){case"extent":return bc(i.center,e,!1);case"polygon":return bc(i.centroid,e,!1);case"polyline":return bc(tO(i),e,!0);case"mesh":return bc(i.origin,e,!1)}else switch(i.type){case"extent":return bc(XH(i),e,!0);case"polygon":return bc(QH(i),e,!0);case"polyline":return bc(tO(i),e,!0)}}function tO(i){const e=i.paths[0];if(!e||e.length===0)return null;const t=kA(e,jA(e)/2);return lc(t[0],t[1],t[2],i.spatialReference)}function XH(i){return lc(.5*(i.xmax+i.xmin),.5*(i.ymax+i.ymin),i.zmin!=null&&i.zmax!=null&&isFinite(i.zmin)&&isFinite(i.zmax)?.5*(i.zmax+i.zmin):void 0,i.spatialReference)}function QH(i){const e=i.rings[0];if(!e||e.length===0)return null;const t=K4(i.rings,!!i.hasZ);return lc(t[0],t[1],t[2],i.spatialReference)}function bc(i,e,t){const r=t?i:WH(i);return e&&i?J4(i,r,e)?r:null:r}function cne(i,e,t,r=0){if(i){e||(e=yt());const s=i;let a=.5*s.width*(t-1),n=.5*s.height*(t-1);return s.width<1e-7*s.height?a+=n/20:s.height<1e-7*s.width&&(n+=a/20),Br(e,s.xmin-a-r,s.ymin-n-r,s.xmax+a+r,s.ymax+n+r),e}return null}function LI(i,e){for(let t=0;t<i.geometries.length;++t){const r=i.geometries[t].getMutableAttribute(w.AUXPOS1);r&&r.data[3]!==e&&(r.data[3]=e,i.geometryVertexAttrsUpdated(i.geometries[t]))}}function Mg(i,e){const t=lv(no);return g(i)&&(t[0]=i[0],t[1]=i[1],t[2]=i[2]),g(e)?t[3]=e:g(i)&&i.length>3&&(t[3]=i[3]),t}function hne(i,e,t,r,s,a=[0,0,0,0]){for(let n=0;n<3;++n)g(i)&&i[n]!=null?a[n]=i[n]:g(t)&&t[n]!=null?a[n]=t[n]:a[n]=s[n];return g(e)?a[3]=e:g(r)?a[3]=r:a[3]=s[3],a}function iO(i=Yc,e,t,r=1){const s=new Array(3);if(P(e)||P(t))s[0]=1,s[1]=1,s[2]=1;else{let a,n=0;for(let o=2;o>=0;o--){const l=i[o];let c;const h=l!=null,u=o===0&&!a&&!h,p=t[o];l==="symbol-value"||u?c=p!==0?e[o]/p:1:h&&l!=="proportional"&&isFinite(l)&&(c=p!==0?l/p:1),c!=null&&(s[o]=c,a=c,n=Math.max(n,Math.abs(c)))}for(let o=2;o>=0;o--)s[o]==null?s[o]=a:s[o]===0&&(s[o]=.001*n)}for(let a=2;a>=0;a--)s[a]/=r;return wn(s)}function ZH(i){return i.isPrimitive!=null}function Uv(i){return Vy(ZH(i)?[i.width,i.depth,i.height]:i)?null:"Symbol sizes may not be negative values"}function Vy(i){if(Array.isArray(i)){for(const e of i)if(!Vy(e))return!1;return!0}return i==null||i>=0}function YH(i,e,t,r=ce()){const s=i||0,a=e||0,n=t||0;return s!==0&&Bg(r,r,-s/180*Math.PI),a!==0&&Hg(r,r,a/180*Math.PI),n!==0&&nT(r,r,n/180*Math.PI),r}function IC(i,e,t){if(t.minDemResolution!=null)return t.minDemResolution;const r=Hd(e),s=UA(i)*r,a=VA(i)*r,n=dT(i)*(e.isGeographic?1:r);return s===0&&a===0&&n===0?t.minDemResolutionForPoints:.01*Math.max(s,a,n)}function $I(i,e,t,r,s,a,n,o,l,c,h){const u=ak[h.mode];let p,m,f=0;if(ha(i,e,t,r,l.spatialReference,s,o))return u.requiresAlignment(h)?(f=u.applyElevationAlignmentBuffer(r,s,a,n,o,l,c,h),p=a,m=n):(p=r,m=s),ha(p,l.spatialReference,m,a,c.spatialReference,n,o)?f:void 0}function cm(i,e,t,r,s){const a=(Dy(i)?i.z:KD(i)?i.array[i.offset+2]:i[2])||0;switch(t.mode){case"on-the-ground":{const n=je(rl(e,i,"ground"),0);return s.verticalDistanceToGround=0,s.sampledElevation=n,void(s.z=n)}case"relative-to-ground":{const n=je(rl(e,i,"ground"),0),o=t.geometryZWithOffset(a,r);return s.verticalDistanceToGround=o,s.sampledElevation=n,void(s.z=o+n)}case"relative-to-scene":{const n=je(rl(e,i,"scene"),0),o=t.geometryZWithOffset(a,r);return s.verticalDistanceToGround=o,s.sampledElevation=n,void(s.z=o+n)}case"absolute-height":{const n=t.geometryZWithOffset(a,r),o=je(rl(e,i,"ground"),0);return s.verticalDistanceToGround=n-o,s.sampledElevation=o,void(s.z=n)}default:return void(s.z=0)}}function KH(i,e,t,r){return cm(i,e,t,r,_p),_p.z}function Qf(i,e,t){return e==null||t==null?i.definedChanged:e==="on-the-ground"&&t==="on-the-ground"?i.staysOnTheGround:e===t||e!=="on-the-ground"&&t!=="on-the-ground"?Oi.UPDATE:i.onTheGroundChanged}function Un(i){return i==="relative-to-ground"||i==="relative-to-scene"}function wh(i){return i!=="absolute-height"}function JH(i,e,t,r,s){cm(e,t,s,r,_p),LI(i,_p.verticalDistanceToGround);const a=_p.sampledElevation,n=Kr(nk,i.transformation);return $_[0]=e.x,$_[1]=e.y,$_[2]=_p.z,Zl(e.spatialReference,$_,n,r.spatialReference)?i.transformation=n:console.warn("Could not locate symbol object properly, it might be misplaced"),a}function ek(i,e,t,r,s,a){let n=0;const o=a.spatialReference;e*=3,r*=3;for(let l=0;l<s;++l){const c=i[e+0],h=i[e+1],u=i[e+2],p=je(a.getElevation(c,h,u,o,"ground"),0);n+=p,t[r+0]=c,t[r+1]=h,t[r+2]=p,e+=3,r+=3}return n/s}function tk(i,e,t,r,s,a,n,o){let l=0;const c=o.calculateOffsetRenderUnits(n),h=o.featureExpressionInfoContext,u=a.spatialReference;e*=3,r*=3;for(let p=0;p<s;++p){const m=i[e+0],f=i[e+1],y=i[e+2],b=je(a.getElevation(m,f,y,u,"ground"),0);l+=b,t[r+0]=m,t[r+1]=f,t[r+2]=h==null?y+b+c:b+c,e+=3,r+=3}return l/s}function ik(i,e,t,r,s,a,n,o){let l=0;const c=o.calculateOffsetRenderUnits(n),h=o.featureExpressionInfoContext,u=a.spatialReference;e*=3,r*=3;for(let p=0;p<s;++p){const m=i[e+0],f=i[e+1],y=i[e+2],b=je(a.getElevation(m,f,y,u,"scene"),0);l+=b,t[r+0]=m,t[r+1]=f,t[r+2]=h==null?y+b+c:b+c,e+=3,r+=3}return l/s}function rk(i){const e=i.meterUnitOffset,t=i.featureExpressionInfoContext;return e!==0||t!=null}function sk(i,e,t,r,s,a,n,o){const l=o.calculateOffsetRenderUnits(n),c=o.featureExpressionInfoContext;e*=3,r*=3;for(let h=0;h<s;++h){const u=i[e+0],p=i[e+1],m=i[e+2];t[r+0]=u,t[r+1]=p,t[r+2]=c==null?m+l:l,e+=3,r+=3}return 0}let Zf=class{constructor(){this.verticalDistanceToGround=0,this.sampledElevation=0,this.z=0}};var Oi;(function(i){i[i.NONE=0]="NONE",i[i.UPDATE=1]="UPDATE",i[i.RECREATE=2]="RECREATE"})(Oi||(Oi={}));const ak={"absolute-height":{applyElevationAlignmentBuffer:sk,requiresAlignment:rk},"on-the-ground":{applyElevationAlignmentBuffer:ek,requiresAlignment:()=>!0},"relative-to-ground":{applyElevationAlignmentBuffer:tk,requiresAlignment:()=>!0},"relative-to-scene":{applyElevationAlignmentBuffer:ik,requiresAlignment:()=>!0}},nk=ce(),_p=new Zf,$_=T();function LC(i){return g(i.mapPositions)}function NI(i,e,t,r,s){const a=i.stageObject,n=a.geometries;let o=0;for(const l of n){if(!LC(l))continue;const{update:c,averageGeometrySampledElevation:h}=zI(l,e,t,r,s);o+=h,c&&a.geometryVertexAttrsUpdated(l)}return o/n.length}function bf(i,e,t,r,s){var u;const a=i.stageObject,n=e.centerPointInElevationSR;let o=0;(u=a.metadata)!=null&&u.usesVerticalDistanceToGround?(r(n,Zs),LI(a,Zs.verticalDistanceToGround),o=Zs.sampledElevation):(r(n,Zs),e.mode!=="absolute-height"&&(o=Zs.sampledElevation));const l=Kr(ok,a.transformation),c=j(FI,l[12],l[13],l[14]);Ot.TESTS_DISABLE_OPTIMIZATIONS?(Qs[0]=n.x,Qs[1]=n.y,Qs[2]=Zs.z,Zl(n.spatialReference,Qs,l,s.spatialReference)&&(a.transformation=l)):s.setAltitudeOfTransformation(Zs.z,l);const h=$C/s.unitInMeters;return(Math.abs(l[12]-c[0])>=h||Math.abs(l[13]-c[1])>=h||Math.abs(l[14]-c[2])>=h)&&(a.transformation=l),o}const ok=ce();function lk(i,e,t,r,s){const a=i.graphics3DSymbolLayer.lodRenderer;if(P(a))return 0;const n=e.centerPointInElevationSR;r(n,Zs);const o=e.mode!=="absolute-height"?Zs.sampledElevation:0,l=a.instanceData,c=i.instanceIndex,h=hk;l.getGlobalTransform(c,h);const u=j(FI,h[12],h[13],h[14]);Ot.TESTS_DISABLE_OPTIMIZATIONS?(Qs[0]=n.x,Qs[1]=n.y,Qs[2]=Zs.z,Zl(n.spatialReference,Qs,h,s.spatialReference)&&l.setGlobalTransform(c,h)):s.setAltitudeOfTransformation(Zs.z,h);const p=$C/s.unitInMeters;return(Ot.TESTS_DISABLE_OPTIMIZATIONS||Math.abs(h[12]-u[0])>=p||Math.abs(h[13]-u[1])>=p||Math.abs(h[14]-u[2])>=p)&&l.setGlobalTransform(c,h),o}function ck(i,e,t,r,s){const a=i.stageObject,n=a.geometries;if(n.length===0)return 0;let o=0,l=null,c=0,h=!1;for(const u of n){if(!LC(u))continue;const p=u.vertexAttributes.get(w.POSITION);if(p!==l){const{update:m,averageGeometrySampledElevation:f}=zI(u,e,t,r,s);c=f,l=p,h=m}h&&a.geometryVertexAttrsUpdated(u),o+=c}return o/n.length}const $C=.01,Qs=T(),hn=T(),Su=T(),hk=ce(),FI=T(),Zs=new Zf;function zI(i,e,t,r,s){let a=!1;const n=i.shaderTransformation,o=e.requiresSampledElevationInfo;hn[0]=n[12],hn[1]=n[13],hn[2]=n[14],i.invalidateBoundingInfo();const l=i.getMutableAttribute(w.POSITION),c=l.data,h=l.size,u=c.length/h,p=new YD(i.mapPositions,t);let m=0,f=0;for(let y=0;y<u;y++){if(Su[0]=c[m],Su[1]=c[m+1],Su[2]=c[m+2],r(p,Zs),o&&(f+=Zs.sampledElevation),Ot.TESTS_DISABLE_OPTIMIZATIONS)c[m]=p.array[p.offset],c[m+1]=p.array[p.offset+1],c[m+2]=Zs.z,ha(c,t,m,c,s.spatialReference,m,1),c[m]-=hn[0],c[m+1]-=hn[1],c[m+2]-=hn[2],a=!0;else{Qs[0]=c[m]+hn[0],Qs[1]=c[m+1]+hn[1],Qs[2]=c[m+2]+hn[2],s.setAltitude(Qs,Zs.z),c[m]=Qs[0]-hn[0],c[m+1]=Qs[1]-hn[1],c[m+2]=Qs[2]-hn[2];const b=$C/s.unitInMeters;(Math.abs(Su[0]-c[m])>=b||Math.abs(Su[1]-c[m+1])>=b||Math.abs(Su[2]-c[m+2])>=b)&&(a=!0)}m+=h,p.offset+=3}return f/=u,{update:a,averageGeometrySampledElevation:f}}const dk=Pe.getLogger("esri.views.3d.layers.graphics.featureExpressionInfoUtils");function uk(i){return{cachedResult:i.cachedResult,arcade:i.arcade?{func:i.arcade.func,context:i.arcade.modules.arcadeUtils.createExecContext(null,{sr:i.arcade.context.spatialReference}),modules:i.arcade.modules}:null}}function une(i){const e=i&&i.expression;if(typeof e=="string"){const t=GI(e);if(t!=null)return{cachedResult:t}}return null}async function pne(i,e,t,r){const s=i&&i.expression;if(typeof s!="string")return null;const a=GI(s);if(a!=null)return{cachedResult:a};const n=await eN();lr(t);const o=n.arcadeUtils,l=o.createSyntaxTree(s);return o.dependsOnView(l)?(r!=null&&r.error("Expressions containing '$view' are not supported on ElevationInfo"),{cachedResult:0}):{arcade:{func:o.createFunction(l),context:o.createExecContext(null,{sr:e}),modules:n}}}function UI(i,e,t){return i.arcadeUtils.createFeature(e.attributes,e.geometry,t)}function NC(i,e){if(i!=null&&!VI(i)){if(!e||!i.arcade)return void dk.errorOncePerTick("Arcade support required but not provided");const t=e;t._geometry&&(t._geometry=AI(t._geometry)),i.arcade.modules.arcadeUtils.updateExecContext(i.arcade.context,e)}}function pk(i){if(i!=null){if(VI(i))return i.cachedResult;const e=i.arcade;let t=e==null?void 0:e.modules.arcadeUtils.executeFunction(e.func,e.context);return typeof t!="number"&&(i.cachedResult=0,t=0),t}return 0}function mne(i,e=!1){let t=i&&i.featureExpressionInfo;const r=t&&t.expression;return e||r==="0"||(t=null),t??null}const mk={cachedResult:0};function VI(i){return i.cachedResult!=null}function GI(i){return i==="0"?0:null}let Po=class BI{constructor(){this._meterUnitOffset=0,this._renderUnitOffset=0,this._unit="meters",this._metersPerElevationInfoUnit=1,this._featureExpressionInfoContext=null,this.centerPointInElevationSR=null,this.mode=null}get featureExpressionInfoContext(){return this._featureExpressionInfoContext}get meterUnitOffset(){return this._meterUnitOffset}get unit(){return this._unit}set unit(e){this._unit=e,this._metersPerElevationInfoUnit=tN(e)}get requiresSampledElevationInfo(){return this.mode!=="absolute-height"}reset(){this.mode=null,this._meterUnitOffset=0,this._renderUnitOffset=0,this._featureExpressionInfoContext=null,this.unit="meters"}set offsetMeters(e){this._meterUnitOffset=e,this._renderUnitOffset=0}set offsetElevationInfoUnits(e){this._meterUnitOffset=e*this._metersPerElevationInfoUnit,this._renderUnitOffset=0}addOffsetRenderUnits(e){this._renderUnitOffset+=e}geometryZWithOffset(e,t){const r=this.calculateOffsetRenderUnits(t);return this.featureExpressionInfoContext!=null?r:e+r}calculateOffsetRenderUnits(e){let t=this._meterUnitOffset;const r=this.featureExpressionInfoContext;return r!=null&&(t+=pk(r)*this._metersPerElevationInfoUnit),t/e.unitInMeters+this._renderUnitOffset}setFromElevationInfo(e){this.mode=e.mode,this.unit=iN(e.unit)?e.unit:"meters",this.offsetElevationInfoUnits=je(e.offset,0)}updateFeatureExpressionInfoContext(e,t,r){if(P(e))return void(this._featureExpressionInfoContext=null);const s=e&&e.arcade;s&&g(t)&&g(r)?(this._featureExpressionInfoContext=uk(e),NC(this._featureExpressionInfoContext,UI(s.modules,t,r))):this._featureExpressionInfoContext=e}static fromElevationInfo(e){const t=new BI;return g(e)&&t.setFromElevationInfo(e),t}},gk=class{constructor(e,t,r){this.graphic=e,this.renderingInfo=t,this.layer=r}},fk=class{constructor(e,t,r){this.baseMaterial=e,this.edgeMaterials=t,this.properties=r}},fl=class{get isElevationSource(){return!(!this.stageObject.metadata||!this.stageObject.metadata.isElevationSource)}constructor(e,t,r,s,a,n,o,l=null){this.graphics3DSymbolLayer=e,this.stageObject=t,this._uniqueGeometries=r,this._uniqueMaterials=s,this._sharedResource=a,this.elevationAligner=n,this.elevationContext=o,this._edgeState=l,this.type="object3d",this._stageLayer=null,this._stage=null,this._visible=!1,this._addedToStage=!1,this.alignedSampledElevation=0,this.needsElevationUpdates=!1,this.useObjectOriginAsAttachmentOrigin=!1}initialize(e,t){this._stageLayer=t,this._stage=e,e.addMany(this._uniqueMaterials),e.addMany(this._uniqueGeometries),e.add(this.stageObject)}destroy(){const e=this._stage;this._stageLayer&&(e.removeMany(this._uniqueMaterials),e.removeMany(this._uniqueGeometries)),e.remove(this.stageObject),this._addedToStage&&(this._stageLayer.remove(this.stageObject),this._addedToStage=!1);const t=this._stage.renderer.ensureEdgeView();t.hasObject(this.stageObject)&&t.removeObject(this.stageObject),this.stageObject.dispose(),g(this._sharedResource)&&this._sharedResource.release(),this._visible=!1,this._stageLayer=null,this._stage=null}layerOpacityChanged(e,t){if(P(this._edgeState))return;const r=rO(this._edgeState.baseMaterial);let s=!1;for(const a of this._edgeState.edgeMaterials)a.objectTransparency!==r&&(a.objectTransparency=r,s=!0);s&&this._resetEdgeObject(t),this._stage.renderer.ensureEdgeView().updateAllComponentOpacities(this.stageObject,[e])}slicePlaneEnabledChanged(e,t){P(this._edgeState)||(this._stage.renderer.ensureEdgeView().updateAllComponentMaterials(this.stageObject,this._edgeState.edgeMaterials,{hasSlicePlane:e},!t),this._edgeState.properties.hasSlicePlane=e)}setVisibility(e){if(this._stage!=null&&this._visible!==e&&(this._visible=e,this.stageObject.visible=e,this._visible&&!this._addedToStage&&(this._stageLayer.add(this.stageObject),this._addedToStage=!0),g(this._edgeState))){const t=this._stage.renderer.ensureEdgeView();t.hasObject(this.stageObject)?t.updateObjectVisibility(this.stageObject,e):e&&this._addOrUpdateEdgeObject(t,!1)}}get visible(){return this._visible}alignWithElevation(e,t,r,s){if(this.elevationAligner==null)return;g(r)&&NC(this.elevationContext.featureExpressionInfoContext,r);const a=(n,o)=>cm(n,e,this.elevationContext,t,o);this.alignedSampledElevation=this.elevationAligner(this,this.elevationContext,Si(e.spatialReference),a,t),this._resetEdgeObject(s)}alignWithAbsoluteElevation(e,t,r){const s=(a,n)=>{n.sampledElevation=e,n.verticalDistanceToGround=0,n.z=e};this.alignedSampledElevation=this.elevationAligner(this,this.elevationContext,null,s,t),this._resetEdgeObject(r)}getCenterObjectSpace(e=T()){return H(e,OT(this.stageObject.boundingVolumeObjectSpace.bounds))}getBoundingBoxObjectSpace(e=_s()){const t=this.stageObject.boundingVolumeObjectSpace;return rN(e,t.min),sN(e,t.max),e}computeAttachmentOrigin(e){if(this.useObjectOriginAsAttachmentOrigin){const t=this.stageObject.transformation;e.render.origin[0]+=t[12],e.render.origin[1]+=t[13],e.render.origin[2]+=t[14],e.render.num++}else for(const t of this.stageObject.geometries)t.computeAttachmentOrigin(Tl)&&(xe(Tl,Tl,this.stageObject.transformation),X(e.render.origin,e.render.origin,Tl),e.render.num++)}async getProjectedBoundingBox(e,t,r,s,a){const n=this.getBoundingBoxObjectSpace(a),o=_k,l=cT(n)?1:o.length;for(let h=0;h<l;h++){const u=o[h];xc[0]=n[u[0]],xc[1]=n[u[1]],xc[2]=n[u[2]],xe(xc,xc,this.stageObject.transformation),Nh[3*h+0]=xc[0],Nh[3*h+1]=xc[1],Nh[3*h+2]=xc[2]}if(!e(Nh,0,l))return null;di(n);let c=null;this.calculateRelativeScreenBounds&&(c=this.calculateRelativeScreenBounds());for(let h=0;h<3*l;h+=3){for(let u=0;u<3;u++)n[u]=Math.min(n[u],Nh[h+u]),n[u+3]=Math.max(n[u+3],Nh[h+u]);c&&r.push({location:Nh.slice(h,h+3),screenSpaceBoundingRect:c})}if(t&&t.service&&this.elevationContext.mode!=="absolute-height"){oo(n,Tl);const h=this.elevationContext.mode==="relative-to-scene"?"scene":"ground";let u=0;if(t.useViewElevation)u=je(t.service.getElevation(Tl[0],Tl[1],h),0);else try{const p=IC(n,t.service.spatialReference,t);u=je(await t.service.queryElevation(Tl[0],Tl[1],s,p,h),0)}catch{}qA(n,0,0,-this.alignedSampledElevation+u)}return n}addObjectState(e,t){e===Hp.Highlight&&t.addObject(this.stageObject,this.stageObject.highlight()),e===Hp.MaskOccludee&&t.addObject(this.stageObject,this.stageObject.maskOccludee())}removeObjectState(e){e.removeObject(this.stageObject)}_resetEdgeObject(e){if(P(this._edgeState))return;const t=this._stage.renderer.ensureEdgeView();this._visible?this._addOrUpdateEdgeObject(t,e):t.removeObject(this.stageObject)}_addOrUpdateEdgeObject(e,t){const r=this._edgeState;if(P(r))return;const s=rO(r.baseMaterial);for(const a of r.edgeMaterials)a.objectTransparency=s;e.addOrUpdateObject3D(this.stageObject,r.edgeMaterials,r.properties,!t).then(()=>{var a;return(a=this._stageLayer)==null?void 0:a.sync()})}};function rO(i){return i.isVisible()?i.parameters.transparent?ht.TRANSPARENT:ht.OPAQUE:ht.INVISIBLE}const Nh=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],xc=T(),Tl=T(),_k=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]];let HI=class{constructor(e,t=null){this.labelText=t,this.elevationOffset=je(e,0)}};var dr;(function(i){i[i.Recreate_Symbol=0]="Recreate_Symbol",i[i.Recreate_Graphics=1]="Recreate_Graphics",i[i.Fast_Update=2]="Fast_Update"})(dr||(dr={}));let FC=class{constructor(e){this.schedule=e,this._abortController=null,this._loadStatus=tn.LOADING,this._loadError=null,this._loader=null,this.logger=null}destroy(){this.abortLoad()}get loadStatus(){return this._loadStatus}load(e,t){return this._loadStatus===tn.LOADED?(e&&e(),je(this._loader,Promise.resolve())):this._loadStatus===tn.FAILED?(t&&t(this._loadError),je(this._loader,Promise.resolve())):(P(this._loader)&&(this._abortController=new AbortController,this._loader=this.doLoad(this._abortController.signal).then(()=>{this._abortController=null,this._loadStatus=tn.LOADED},r=>{throw this._loadError=r,this._abortController=null,this._loadStatus=tn.FAILED,!yo(r)&&this.logger&&r.message&&this.logger.warn(r.message),r})),this._loader.then(e,t).catch(()=>{}),this._loader)}abortLoad(){g(this._abortController)?this._abortController=Th(this._abortController):this._loadStatus===tn.LOADING&&(this._loadStatus=tn.FAILED),this._loader=null}};var tn;(function(i){i[i.LOADING=0]="LOADING",i[i.LOADED=1]="LOADED",i[i.FAILED=2]="FAILED"})(tn||(tn={}));const kI=3,bw=3,jI=10;let qI=class{constructor(e,t=null){this.geometry=e,this.textures=t}};function N_(i){const e=[];return i.levels.forEach(t=>t.components.forEach(r=>e.push(r.geometry.material))),cv(e)}function sO(i){const e=new Array;return i.levels.forEach(t=>{t.components.forEach(r=>{g(r.textures)&&e.push(...r.textures)})}),cv(e)}function WI(i){const e=i.components.map(t=>t.geometry);return cv(e)}function aO(i){const e=[];return i.levels.forEach(t=>{t.components.forEach(r=>{e.push(r.geometry)})}),cv(e)}function yk(i){switch(i){case"sphere":case"cube":case"diamond":case"cylinder":case"cone":case"inverted-cone":case"tetrahedron":return!0}return!1}function XI(i,e){const t=(r,s,a=!1)=>({levels:r.map(n=>{const o=s(n.tesselation);return a&&f7(o),{components:[new qI(o)],faceCount:o.indexCount/3,minScreenSpaceRadius:n.minScreenSpaceRadius}})});switch(i){case"sphere":return t([{tesselation:0,minScreenSpaceRadius:0},{tesselation:1,minScreenSpaceRadius:8},{tesselation:2,minScreenSpaceRadius:16},{tesselation:3,minScreenSpaceRadius:50},{tesselation:4,minScreenSpaceRadius:250}],r=>p7(e,.5,r,!0));case"cube":return t([{tesselation:0,minScreenSpaceRadius:0}],()=>s7(e,1));case"cone":return t(db,r=>G2(e,1,.5,r,!1),!0);case"inverted-cone":return t(db,r=>G2(e,1,.5,r,!0),!0);case"cylinder":return t(db,r=>g7(e,1,.5,r,[0,0,1],[0,0,.5]));case"tetrahedron":return t([{tesselation:0,minScreenSpaceRadius:0}],()=>u7(e,1),!0);case"diamond":return t([{tesselation:0,minScreenSpaceRadius:0}],()=>l7(e,1),!0);default:return}}const db=[{tesselation:6,minScreenSpaceRadius:0},{tesselation:18,minScreenSpaceRadius:7},{tesselation:64,minScreenSpaceRadius:65}],zC={primitivesPerFeature:0,primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!0,memory:{bytesPerFeature:0,bytesPerCoordinate:0,bytesPerFeatureLabel:0,resourceBytes:0,draped:{bytesPerFeature:0,bytesPerFeatureLabel:0,bytesPerCoordinate:0}}};function xne(i){return i.type==="web-style"?zC:UC(i.symbolLayers.toArray().map(e=>QI(i,e)))}function UC(i){let e=0,t=0,r=0,s=!1,a=0;const n={bytesPerFeature:0,bytesPerFeatureLabel:0,bytesPerCoordinate:0,resourceBytes:0,draped:{bytesPerFeature:0,bytesPerFeatureLabel:0,bytesPerCoordinate:0}};for(const o of i)P(o)||(e+=o.primitivesPerFeature,t+=o.primitivesPerCoordinate,r+=o.drawCallsPerFeature,n.bytesPerFeature+=o.memory.bytesPerFeature,n.bytesPerFeatureLabel+=o.memory.bytesPerFeatureLabel,n.bytesPerCoordinate+=o.memory.bytesPerCoordinate,n.resourceBytes+=o.memory.resourceBytes,n.draped.bytesPerFeature+=o.memory.bytesPerFeature,n.draped.bytesPerFeatureLabel+=o.memory.bytesPerFeatureLabel,n.draped.bytesPerCoordinate+=o.memory.bytesPerCoordinate,s=s||o.estimated,++a);return{primitivesPerFeature:e,primitivesPerCoordinate:t,drawCallsPerFeature:r,estimated:s,memory:n,numComplexities:a}}function wne(i){const e=UC(i);return e.numComplexities>0&&(e.primitivesPerFeature/=e.numComplexities,e.primitivesPerCoordinate/=e.numComplexities,e.drawCallsPerFeature/=e.numComplexities,e.memory.bytesPerFeature/=e.numComplexities,e.memory.bytesPerFeatureLabel/=e.numComplexities,e.memory.bytesPerCoordinate/=e.numComplexities,e.memory.resourceBytes/=e.numComplexities,e.memory.draped.bytesPerFeature/=e.numComplexities,e.memory.draped.bytesPerFeatureLabel/=e.numComplexities,e.memory.draped.bytesPerCoordinate/=e.numComplexities),e}const nO={};function QI(i,e){const t=ZI(i,e),r=V6(e)?2:0;switch(e.type){case"extrude":return{primitivesPerFeature:-4,primitivesPerCoordinate:4,drawCallsPerFeature:r,estimated:!1,memory:t};case"fill":return i.type==="mesh-3d"?{primitivesPerFeature:0,primitivesPerCoordinate:0,drawCallsPerFeature:r,estimated:!1,memory:t}:g(e.outline)&&e.outline.size>0?{primitivesPerFeature:-4,primitivesPerCoordinate:3,drawCallsPerFeature:0,estimated:!1,memory:t}:{primitivesPerFeature:-2,primitivesPerCoordinate:1,drawCallsPerFeature:0,estimated:!1,memory:t};case"water":return{primitivesPerFeature:-2,primitivesPerCoordinate:1,drawCallsPerFeature:0,estimated:!1,memory:t};case"line":return{primitivesPerFeature:-2,primitivesPerCoordinate:2,drawCallsPerFeature:0,estimated:!1,memory:t};case"object":return e.resource&&e.resource.href?{primitivesPerFeature:16,primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!0,memory:t}:{...vk(e.resource&&e.resource.primitive||WA),memory:t};case"path":{let s=0,a=0;switch(e.profile){case"circle":s=jI;break;case"quad":s=4;break;default:return void _o(e.profile)}switch(e.join??"simple"){case"round":a=kI;break;case"miter":case"bevel":a=1;break;default:return}const n=2*s,o=s*a*2;let l=-2*o-n;switch(e.cap){case"none":break;case"butt":case"square":l+=2*(s-1);break;case"round":l+=2*(s*(bw-1)*2+s);break;default:return}return{primitivesPerFeature:l,primitivesPerCoordinate:o+n,drawCallsPerFeature:0,estimated:!1,memory:t}}case"text":case"icon":return{primitivesPerFeature:2,primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!1,memory:t};default:return}}function ZI(i,e){const t=i.type==="point-3d";switch(e.type){case"extrude":return e.edges&&e.edges.size>0?Is.EXTRUDE_EDGES:Is.EXTRUDE;case"fill":return g(e.outline)&&e.outline.size>0?Is.FILL_OUTLINE:Is.FILL;case"water":return Is.FILL;case"line":return e.join==="round"?Is.LINE_ROUND:Is.LINE_MITER;case"path":switch(e.join){case"round":switch(e.profile){case"circle":return Is.PATH_ROUND_CIRCLE;case"quad":return Is.PATH_ROUND_QUAD;default:return void _o(e.profile)}case"miter":case"bevel":switch(e.profile){case"circle":return Is.PATH_MITER_CIRCLE;case"quad":return Is.PATH_MITER_QUAD;default:return void _o(e.profile)}default:return}case"object":return t?Is.OBJECT_POINT:Is.OBJECT_POLYGON;case"icon":case"text":return t?Is.ICON_POINT:Is.ICON_POLYGON;default:return}}function vk(i){let e=nO[i];if(e)return e;const t=XI(i,null);return e={primitivesPerFeature:WI(t.levels[0]).reduce((r,s)=>r+s.indices.get(w.POSITION).length/3,0),primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!1},nO[i]=e,e}const Is={ICON_POINT:{bytesPerFeature:3293.7707557538765,bytesPerFeatureLabel:1020.2764,bytesPerCoordinate:0,resourceBytes:0,draped:{bytesPerFeature:2213.51585392203,bytesPerFeatureLabel:1008.84664,bytesPerCoordinate:0}},ICON_POLYGON:{bytesPerFeature:4745.397589234022,bytesPerFeatureLabel:1006.5440666666666,bytesPerCoordinate:3.8971910718981526,resourceBytes:0,draped:{bytesPerFeature:3711.9299672493826,bytesPerFeatureLabel:991.1003999999999,bytesPerCoordinate:3.916858016273668}},OBJECT_POINT:{bytesPerFeature:1751.6405617660876,bytesPerFeatureLabel:1024.7827699999998,bytesPerCoordinate:0,resourceBytes:0,draped:{bytesPerFeature:1751.6405617660876,bytesPerFeatureLabel:1024.7827699999998,bytesPerCoordinate:0}},OBJECT_POLYGON:{bytesPerFeature:3265.877223973855,bytesPerFeatureLabel:1002.3207366666666,bytesPerCoordinate:4.003101524580855,resourceBytes:0,draped:{bytesPerFeature:3265.877223973855,bytesPerFeatureLabel:1002.3207366666666,bytesPerCoordinate:4.003101524580855}},LINE_MITER:{bytesPerFeature:5757.019675077085,bytesPerFeatureLabel:998.6150266666667,bytesPerCoordinate:24.456810187064043,resourceBytes:0,draped:{bytesPerFeature:4101.480288021862,bytesPerFeatureLabel:1007.7540599999999,bytesPerCoordinate:18.25629912730874}},LINE_ROUND:{bytesPerFeature:5770.95297166408,bytesPerFeatureLabel:1017.77396,bytesPerCoordinate:24.60919037084966,resourceBytes:0,draped:{bytesPerFeature:4089.5796612121826,bytesPerFeatureLabel:987.8320266666666,bytesPerCoordinate:18.43599029126731}},PATH_MITER_CIRCLE:{bytesPerFeature:36120.81813311945,bytesPerFeatureLabel:977.3815,bytesPerCoordinate:2713.2216607858863,resourceBytes:0,draped:{bytesPerFeature:36120.81813311945,bytesPerFeatureLabel:977.3815,bytesPerCoordinate:2713.2216607858863}},PATH_ROUND_CIRCLE:{bytesPerFeature:23268.96777866874,bytesPerFeatureLabel:985.2637,bytesPerCoordinate:5284.873051323177,resourceBytes:0,draped:{bytesPerFeature:23268.96777866874,bytesPerFeatureLabel:985.2637,bytesPerCoordinate:5284.873051323177}},PATH_MITER_QUAD:{bytesPerFeature:24548.629753007182,bytesPerFeatureLabel:964.6924,bytesPerCoordinate:2114.107276663994,resourceBytes:0,draped:{bytesPerFeature:24548.629753007182,bytesPerFeatureLabel:964.6924,bytesPerCoordinate:2114.107276663994}},PATH_ROUND_QUAD:{bytesPerFeature:34316.219663191616,bytesPerFeatureLabel:975.7985,bytesPerCoordinate:3331.3952550120293,resourceBytes:0,draped:{bytesPerFeature:34316.219663191616,bytesPerFeatureLabel:975.7985,bytesPerCoordinate:3331.3952550120293}},FILL:{bytesPerFeature:6141.501452970723,bytesPerFeatureLabel:1008.2056066666665,bytesPerCoordinate:9.669541106191478,resourceBytes:0,draped:{bytesPerFeature:4615.812654782311,bytesPerFeatureLabel:1004.2114200000001,bytesPerCoordinate:7.378043214430644}},FILL_OUTLINE:{bytesPerFeature:9038.575581319641,bytesPerFeatureLabel:1017.9996066666668,bytesPerCoordinate:14.96569682175086,resourceBytes:0,draped:{bytesPerFeature:6369.386021594582,bytesPerFeatureLabel:1008.9863733333334,bytesPerCoordinate:10.25287774000214}},EXTRUDE:{bytesPerFeature:20071.2337049912,bytesPerFeatureLabel:1019.49468,bytesPerCoordinate:49.39369614206849,resourceBytes:0,draped:{bytesPerFeature:20071.2337049912,bytesPerFeatureLabel:1019.49468,bytesPerCoordinate:49.39369614206849}},EXTRUDE_EDGES:{bytesPerFeature:22300.21739345088,bytesPerFeatureLabel:1017.4348466666665,bytesPerCoordinate:49.40242281963031,resourceBytes:0,draped:{bytesPerFeature:22300.21739345088,bytesPerFeatureLabel:1017.4348466666665,bytesPerCoordinate:49.40242281963031}}},Pu=Pe.getLogger("esri.views.3d.layers.graphics.Graphics3DSymbolLayer");let _l=class extends FC{constructor(e,t,r,s){super(r.schedule),this.symbol=e,this.symbolLayer=t,this._context=r,this._elevationInfoOverride=null,this._ignoreDrivers=!1,this._drivenProperties={color:!1,opacity:!1,opacityAlwaysOpaque:!0,size:!1},this.complexity=null,this.logger=Pu,this._elevationOptions={supportsOffsetAdjustment:!1,supportsOnTheGround:!0},this._renderPriority=s.renderPriority,this._renderPriorityStep=s.renderPriorityStep,this._elevationContext=new Po,this.complexity=this.computeComplexity(),this._ignoreDrivers=s.ignoreDrivers,this._ignoreDrivers||(this._drivenProperties=oO(this._context.renderer)),this._updateElevationContext()}getCachedSize(){return null}get extentPadding(){return 0}_drivenPropertiesChanged(e){if(this._ignoreDrivers)return!1;const t=this._drivenProperties,r=oO(e);return r.color!==t.color||r.opacity!==t.opacity||r.opacityAlwaysOpaque!==t.opacityAlwaysOpaque||r.size!==t.size}get needsDrivenTransparentPass(){return this._drivenProperties.opacity&&!this._drivenProperties.opacityAlwaysOpaque}_logGeometryCreationWarnings(e,t,r,s){const a=e.projectionSuccess,n="polygons"in e?e.polygons:null,o=`${s} geometry failed to be created`;let l=null;a?!this._logGeometryValidationWarnings(t,r,s)&&n&&n.length===0&&r==="rings"&&t.length>0&&t[0].length>2&&(l=`${o} (filled rings should use clockwise winding - try reversing the order of vertices)`):l=`${o} (failed to project geometry to view spatial reference)`,l&&Pu.warnOncePerTick(l)}_logGeometryValidationWarnings(e,t,r){const s=`${r} geometry failed to be created`;return!e.length||e.length===1&&!e[0].length?(Pu.warnOncePerTick(`${s} (no ${t} were defined)`),!0):(!Array.isArray(e)||!Array.isArray(e[0]))&&(Pu.warnOncePerTick(`${s} (${t} should be defined as a 2D array)`),!0)}_validateGeometry(e,t=null,r=null){if(g(t)&&!t.includes(e.type))return this.logger.warn("unsupported geometry type for "+r+` symbol: ${e.type}`),!1;if(e.type==="point"){const s=e;if(!isFinite(s.x)||!isFinite(s.y))return Pu.warn("point coordinate is not a valid number, graphic skipped"),!1}return!0}_defaultElevationInfoNoZ(){return bk}_defaultElevationInfoZ(){return xk}_updateElevationContext(){g(this._elevationInfoOverride)?(this._elevationContext.setFromElevationInfo(this._elevationInfoOverride),this._elevationContext.updateFeatureExpressionInfoContext(null)):this._context.layer.elevationInfo?(this._elevationContext.setFromElevationInfo(this._context.layer.elevationInfo),this._elevationContext.updateFeatureExpressionInfoContext(this._context.featureExpressionInfoContext)):this._elevationContext.reset()}getDefaultElevationInfo(e){return e.hasZ?this._defaultElevationInfoZ():this._defaultElevationInfoNoZ()}getGeometryElevationMode(e,t=this.getDefaultElevationInfo(e)){return this._elevationContext.mode||t.mode}setElevationInfoOverride(e){this._elevationInfoOverride=e,this._updateElevationContext()}setGraphicElevationContext(e,t){const r=Si(e.geometry),s=this.getDefaultElevationInfo(r);t.unit=this._elevationContext.unit!=null?this._elevationContext.unit:s.unit,t.mode=this.getGeometryElevationMode(r,s),t.offsetMeters=je(this._elevationContext.meterUnitOffset,je(s.offset,0));const a=!this._elevationOptions.supportsOnTheGround&&t.mode==="on-the-ground";a&&(t.mode="relative-to-ground",t.offsetMeters=0);const n=a?mk:this._elevationContext.featureExpressionInfoContext;return t.updateFeatureExpressionInfoContext(n,e,this._context.layer),t}prepareSymbolLayerPatch(e){}updateGeometry(e,t){return!1}onRemoveGraphic(e){}_getLayerOpacity(){return this._context.graphicsCoreOwner&&"fullOpacity"in this._context.graphicsCoreOwner?this._context.graphicsCoreOwner.fullOpacity??0:this._context.layer.opacity??1}_getCombinedOpacity(e,t=lO){let r=1;return this.draped||(r*=this._getLayerOpacity()),this._drivenProperties.opacity||(g(e)?r*=e.a:t.hasIntrinsicColor||(r=0)),r}_getCombinedOpacityAndColor(e,t=lO){const r=this._getCombinedOpacity(e,t);if(this._drivenProperties.color)return Mg(null,r);const s=g(e)?ui.toUnitRGB(e):Yc;return Mg(s,r)}_getVertexOpacityAndColor(e,t=null){const r=this._drivenProperties.color?e.color:null,s=this._drivenProperties.opacity?e.opacity:null,a=Mg(r,s);return g(t)&&(a[0]*=t,a[1]*=t,a[2]*=t,a[3]*=t),a}isFastUpdatesEnabled(){return this._fastUpdates&&this._fastUpdates.enabled}computeComplexity(){return QI(this.symbol,this.symbolLayer)}globalPropertyChanged(e,t,r){switch(e){case"opacity":return this.layerOpacityChanged(t,r),!0;case"elevationInfo":{const s=this._elevationContext.mode;return this._updateElevationContext(),this.layerElevationInfoChanged(t,r,s)!==Oi.RECREATE}case"slicePlaneEnabled":return this.slicePlaneEnabledChanged(t,r);case"physicalBasedRenderingEnabled":return this.physicalBasedRenderingChanged();case"pixelRatio":return this.pixelRatioChanged();case"skipHighSymbolLods":return this.skipHighSymbolLodsChanged();default:return!1}}updateGraphics3DGraphicElevationInfo(e,t,r){let s=Oi.UPDATE;return e.forEach(a=>{const n=t(a);if(g(n)){const o=a.graphic;this.setGraphicElevationContext(o,n.elevationContext),n.needsElevationUpdates=r(n.elevationContext.mode)}else s=Oi.RECREATE}),s}applyRendererDiff(e,t){return dr.Recreate_Symbol}getFastUpdateAttrValues(e){if(!this._fastUpdates.enabled)return null;const t=this._fastUpdates.visualVariables,r=t.size?kl(t.size.field,e):0,s=t.color?kl(t.color.field,e):0,a=t.opacity?kl(t.opacity.field,e):0;return hi(r,s,a,0)}get draped(){return this._draped}ensureDrapedStatus(e){return this._draped==null?(this._draped=e,!0):(e!==this.draped&&Pu.warnOnce("A symbol can only produce either draped or non-draped visualizations. Use two separate symbol instances for draped and non-draped graphics if necessary."),!1)}test(){const e=()=>{var t,r,s,a,n,o,l,c,h,u,p,m;return{size:((s=(r=(t=this._fastUpdates)==null?void 0:t.visualVariables)==null?void 0:r.size)==null?void 0:s.field)??null,color:((o=(n=(a=this._fastUpdates)==null?void 0:a.visualVariables)==null?void 0:n.color)==null?void 0:o.field)??null,opacity:((h=(c=(l=this._fastUpdates)==null?void 0:l.visualVariables)==null?void 0:c.opacity)==null?void 0:h.field)??null,rotation:((m=(p=(u=this._fastUpdates)==null?void 0:u.visualVariables)==null?void 0:p.rotation)==null?void 0:m.field)??null}};return{drivenProperties:this._drivenProperties,getVisVarFields:e}}};function kl(i,e){const t=i!=null?e.attributes[i]:0;return t!=null&&isFinite(t)?t:0}function oO(i){const e={color:!1,opacity:!1,opacityAlwaysOpaque:!0,size:!1};return i&&"visualVariables"in i&&i.visualVariables&&i.visualVariables.forEach(t=>{switch(t.type){case"color":if(e.color=!0,t.stops)for(let r=0;r<t.stops.length;r++){const s=t.stops[r].color;s&&(e.opacity=!0,s.a<1&&(e.opacityAlwaysOpaque=!1))}break;case"opacity":e.opacity=!0,e.opacityAlwaysOpaque=!1;break;case"size":e.size=!0}}),e}const bk={mode:"on-the-ground",offset:0,unit:"meters"},xk={mode:"absolute-height",offset:0,unit:"meters"},lO={hasIntrinsicColor:!1};let hc=class extends I3{get geometries(){return this._geometries}get transformation(){return this._transformation}set transformation(e){Kr(this._transformation,e),this._invalidateBoundingVolume(),this._emit("objectTransformation",this)}constructor(e={}){super(),this.type=ps.Object,this._geometries=new Array,this._transformation=ce(),this._bvObjectSpace=new cO,this._bvWorldSpace=new cO,this._bvDirty=!0,this._hasVolatileTransformation=!1,this._visible=!0,this.castShadow=e.castShadow==null||e.castShadow,this.metadata=e.metadata,this.metadata&&this.metadata.isElevationSource&&(this.metadata.lastValidElevationBB=new YI);const t=e.geometries;g(t)&&(this._geometries=Array.from(t))}dispose(){this._geometries.length=0}get parentLayer(){return this._parentLayer}set parentLayer(e){dt(this._parentLayer==null||e==null,"Object3D can only be added to a single Layer"),this._parentLayer=e}addGeometry(e){e.visible=this._visible,this._geometries.push(e),this._hasVolatileTransformation=this._hasVolatileTransformation||e.hasVolatileTransformation,this._emit("objectGeometryAdded",{object:this,geometry:e}),this._invalidateBoundingVolume()}removeGeometry(e){const t=this._geometries.splice(e,1)[0];t&&(this._emit("objectGeometryRemoved",{object:this,geometry:t}),this._invalidateBoundingVolume())}removeAllGeometries(){for(;this._geometries.length>0;)this.removeGeometry(0)}geometryVertexAttrsUpdated(e){this._emit("objectGeometryUpdated",{object:this,geometry:e}),this._invalidateBoundingVolume()}get visible(){return this._visible}set visible(e){if(this._visible!==e){this._visible=e;for(const t of this._geometries)t.visible=this._visible;this._emit("visibilityChanged",this)}}maskOccludee(){const e=new Ax(Hp.MaskOccludee);for(const t of this._geometries)t.occludees=l2(t.occludees,e);return this._emit("occlusionChanged",this),e}removeOcclude(e){for(const t of this._geometries)t.occludees=c2(t.occludees,e);this._emit("occlusionChanged",this)}highlight(){const e=new Ax(Hp.Highlight);for(const t of this._geometries)t.highlights=l2(t.highlights,e);return this._emit("highlightChanged",this),e}removeHighlight(e){for(const t of this._geometries)t.highlights=c2(t.highlights,e);this._emit("highlightChanged",this)}getCombinedStaticTransformation(e,t){return pr(t,this.transformation,e.transformation)}_getCombinedShaderTransformation(e){return pr(ce(),this.transformation,e.shaderTransformation)}hasVolativeTransformation(){return this._hasVolatileTransformation}get boundingVolumeWorldSpace(){return this._validateBoundingVolume(),this._bvWorldSpace}get boundingVolumeObjectSpace(){return this._validateBoundingVolume(),this._bvObjectSpace}_validateBoundingVolume(){if(!this._bvDirty&&!this._hasVolatileTransformation)return;this._bvObjectSpace.init(),this._bvWorldSpace.init();for(const s of this._geometries){const a=s.boundingInfo;g(a)&&(hO(a,this._bvObjectSpace,s.shaderTransformation),hO(a,this._bvWorldSpace,this._getCombinedShaderTransformation(s)))}Gr(this._bvObjectSpace.bounds,this._bvObjectSpace.min,this._bvObjectSpace.max,.5),Gr(this._bvWorldSpace.bounds,this._bvWorldSpace.min,this._bvWorldSpace.max,.5);const e=T(),t=T(),r=Dd(this.transformation);for(const s of this._geometries){const a=s.boundingInfo;if(P(a))continue;const n=s.shaderTransformation,o=Dd(n);xe(e,a.center,n);const l=yi(e,this._bvObjectSpace.bounds),c=a.radius*o;this._bvObjectSpace.bounds[3]=Math.max(this._bvObjectSpace.bounds[3],l+c),xe(t,e,this.transformation);const h=yi(t,this._bvWorldSpace.bounds),u=c*r;this._bvWorldSpace.bounds[3]=Math.max(this._bvWorldSpace.bounds[3],h+u)}this._bvDirty=!1}_invalidateBoundingVolume(){this._bvDirty=!0,g(this._parentLayer)&&this._parentLayer.notifyObjectBBChanged(this,this._bvWorldSpace.bounds)}_emit(e,t){g(this._parentLayer)&&this._parentLayer.events.emit(e,t)}get test(){const e=this;return{hasGeometry:t=>e._geometries.includes(t),getGeometryIndex:t=>e._geometries.indexOf(t)}}},YI=class{constructor(){this.min=Ge(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this.max=Ge(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE)}isEmpty(){return this.max[0]<this.min[0]&&this.max[1]<this.min[1]&&this.max[2]<this.min[2]}},cO=class extends YI{constructor(){super(...arguments),this.bounds=Nn()}init(){j(this.min,Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),j(this.max,-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),X9(this.bounds)}};function hO(i,e,t){const r=i.bbMin,s=i.bbMax;if(aN(t)){const a=j(wk,t[12],t[13],t[14]);X(Ba,r,a),X(Hn,s,a);for(let n=0;n<3;++n)e.min[n]=Math.min(e.min[n],Ba[n]),e.max[n]=Math.max(e.max[n],Hn[n])}else if(xe(Ba,r,t),An(r,s))for(let a=0;a<3;++a)e.min[a]=Math.min(e.min[a],Ba[a]),e.max[a]=Math.max(e.max[a],Ba[a]);else{xe(Hn,s,t);for(let a=0;a<3;++a)e.min[a]=Math.min(e.min[a],Ba[a],Hn[a]),e.max[a]=Math.max(e.max[a],Ba[a],Hn[a]);for(let a=0;a<3;++a){H(Ba,r),H(Hn,s),Ba[a]=s[a],Hn[a]=r[a],xe(Ba,Ba,t),xe(Hn,Hn,t);for(let n=0;n<3;++n)e.min[n]=Math.min(e.min[n],Ba[n],Hn[n]),e.max[n]=Math.max(e.max[n],Ba[n],Hn[n])}}}const wk=T(),Ba=T(),Hn=T();function VC(i,e,t,r,s,a){const n=i.clippingExtent;if(ts(e,Jc,i.elevationProvider.spatialReference),g(n)&&!mT(n,Jc))return null;ts(e,Jc,i.renderCoordsHelper.spatialReference);const o=i.localOriginFactory.getOrigin(Jc),l=new hc({castShadow:!1,metadata:{layerUid:i.layer.uid,graphicUid:s,usesVerticalDistanceToGround:!0}});return t.shaderTransformer=a,t.localOrigin=o,l.addGeometry(t),{object:l,sampledElevation:JH(l,e,i.elevationProvider,i.renderCoordsHelper,r)}}function xf(i,e,t){const r=i.elevationContext,s=t.spatialReference;ts(e,Jc,s),r.centerPointInElevationSR=lc(Jc[0],Jc[1],e.hasZ?Jc[2]:0,g(s)?s:null)}function wf(i){switch(i.type){case"point":return i;case"polygon":case"extent":return DC(i);case"polyline":{const e=i.paths[0];if(!e||e.length===0)return null;const t=kA(e,jA(e)/2);return lc(t[0],t[1],t[2],i.spatialReference)}case"mesh":return i.origin}return null}const Jc=T();function Tk(i){const e=new $t;e.include(nC),e.include(fI,i),e.include(Qr,i),e.attributes.add(w.UV0,"vec2");const{vertex:t,fragment:r}=e;return t.uniforms.add([new ai("viewport",(s,a)=>a.camera.fullViewport),new ue("lineSize",(s,a)=>Math.ceil(s.size)*a.camera.pixelRatio),new pi("pixelToNDC",(s,a)=>zt(uO,2/a.camera.fullViewport[2],2/a.camera.fullViewport[3])),new ue("borderSize",(s,a)=>g(s.borderColor)?a.camera.pixelRatio:0),new pi("screenOffset",(s,a)=>zt(uO,s.screenOffset[0]*a.camera.pixelRatio,s.screenOffset[1]*a.camera.pixelRatio))]),e.varyings.add("coverageSampling","vec4"),e.varyings.add("lineSizes","vec2"),i.hasMultipassGeometry&&e.varyings.add("depth","float"),i.hasScreenSizePerspective&&ET(t),t.code.add(_`
    void main(void) {
      ProjectHUDAux projectAux;
      vec4 endPoint = projectPositionHUD(projectAux);

      vec3 vpos = projectAux.posModel;
      if (rejectBySlice(vpos)) {
        gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
        return;
      }
    ${i.occlusionTestEnabled?_`
      if (!testVisibilityHUD(endPoint)) {
        gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
        return;
      }`:""}

    ${i.hasScreenSizePerspective?_`
      vec4 perspectiveFactor = screenSizePerspectiveScaleFactor(projectAux.absCosAngle, projectAux.distanceToCamera, screenSizePerspectiveAlignment);
      vec2 screenOffsetScaled = applyScreenSizePerspectiveScaleFactorVec2(screenOffset, perspectiveFactor);
        `:_`
      vec2 screenOffsetScaled = screenOffset;
        `}
      // Add view dependent polygon offset to get exact same original starting point. This is mostly
      // used to get the correct depth value
      vec3 posView = (view * vec4(position, 1.0)).xyz;
      ${i.hasMultipassGeometry?"depth = posView.z;":""}

      applyHUDViewDependentPolygonOffset(auxpos1.w, projectAux.absCosAngle, posView);
      vec4 startPoint = proj * vec4(posView, 1.0);
      // Apply screen offset to both start and end point
      vec2 screenOffsetNorm = screenOffsetScaled * 2.0 / viewport.zw;
      startPoint.xy += screenOffsetNorm * startPoint.w;
      endPoint.xy += screenOffsetNorm * endPoint.w;
      // Align start and end to pixel origin
      vec4 startAligned = alignToPixelOrigin(startPoint, viewport.zw);
      vec4 endAligned = alignToPixelOrigin(endPoint, viewport.zw);
    ${i.depthHudEnabled?i.depthHudAlignStartEnabled?_`endAligned = vec4(endAligned.xy / endAligned.w * startAligned.w, startAligned.zw);`:_`startAligned = vec4(startAligned.xy / startAligned.w * endAligned.w, endAligned.zw);`:""}
      vec4 projectedPosition = mix(startAligned, endAligned, uv0.y);
      // The direction of the line in screen space
      vec2 screenSpaceDirection = normalize(endAligned.xy / endAligned.w - startAligned.xy / startAligned.w);
      vec2 perpendicularScreenSpaceDirection = vec2(screenSpaceDirection.y, -screenSpaceDirection.x);
    ${i.hasScreenSizePerspective?_`
      float lineSizeScaled = applyScreenSizePerspectiveScaleFactorFloat(lineSize, perspectiveFactor);
      float borderSizeScaled = applyScreenSizePerspectiveScaleFactorFloat(borderSize, perspectiveFactor);
        `:_`
      float lineSizeScaled = lineSize;
      float borderSizeScaled = borderSize;
        `}
      float halfPixelSize = lineSizeScaled * 0.5;
      // Calculate a pixel offset from the edge of the pixel, s.t. we keep the line aligned
      // to pixels if it has a full pixel size. Since pixel aligned biases to the bottom-left,
      // we bias the size to the right (for odd sizes) to balance out the bias. Grow sub-pixel
      // sizes towards the left or right s.t. there is a smooth transition (e.g. from 2 to 3 px).
      float halfWholePixelSize = floor(lineSizeScaled) * 0.5;
      float halfPixelSizeInt = floor(halfWholePixelSize);

      // Sub-pixel offset if we need to grow sub-pixels to the left
      float subpixelOffset = -fract(lineSizeScaled) * float(halfWholePixelSize > 0.0);

      // Pixel offset aligning to whole pixels and adding subpixel offset if needed
      float pixelOffset = -halfPixelSizeInt + subpixelOffset;

      // Compute full ndc offset, adding 1px padding for doing anti-aliasing and the border size
      float padding = 1.0 + borderSizeScaled;
      vec2 ndcOffset = (pixelOffset - padding + uv0.x * (lineSizeScaled + padding + padding)) * pixelToNDC;

      // Offset x/y from the center of the line in screen space
      projectedPosition.xy += perpendicularScreenSpaceDirection * ndcOffset * projectedPosition.w;

      // Compute a coverage varying which we can use in the fragment shader to determine
      // how much a pixel is actually covered by the line (i.e. to anti alias the line).
      // This works by computing two coordinates that can be linearly interpolated and then
      // subtracted to find out how far away from the line edge we are.
      float edgeDirection = (uv0.x * 2.0 - 1.0);

      float halfBorderSize = 0.5 * borderSizeScaled;
      float halfPixelSizeAndBorder = halfPixelSize + halfBorderSize;
      float outerEdgeCoverageSampler = edgeDirection * (halfPixelSizeAndBorder + halfBorderSize + 1.0);

      float isOneSided = float(lineSizeScaled < 2.0 && borderSize < 2.0);

      coverageSampling = vec4(
        // Edge coordinate
        outerEdgeCoverageSampler,

        // Border edge coordinate
        outerEdgeCoverageSampler - halfPixelSizeAndBorder * isOneSided,

        // Line offset
        halfPixelSize - 0.5,

        // Border offset
        halfBorderSize - 0.5 + halfPixelSizeAndBorder * (1.0 - isOneSided)
      );

      lineSizes = vec2(lineSizeScaled, borderSizeScaled);

      gl_Position = projectedPosition;
    }
  `),r.uniforms.add([new ai("uColor",s=>dO(s.color)),new ai("borderColor",s=>dO(s.borderColor))]),i.hasMultipassGeometry&&(r.include(WM,i),r.uniforms.add(new pi("inverseViewport",(s,a)=>a.inverseViewport))),r.code.add(_`
    void main() {
      ${i.hasMultipassGeometry?"if( geometryDepthTest(gl_FragCoord.xy * inverseViewport, depth) ){ discard; }":""}

      // Mix between line and border coverage offsets depending on whether we need
      // a border (based on the sidedness).
      vec2 coverage = min(1.0 - clamp(abs(coverageSampling.xy) - coverageSampling.zw, 0.0, 1.0), lineSizes);

      // Mix between border and line color based on the line coverage (conceptually the line
      // blends on top of the border background).
      //
      // Anti-alias by blending final result using the full (including optional border) coverage
      // and the color alpha
      float borderAlpha = uColor.a * borderColor.a * coverage.y;
      float colorAlpha = uColor.a * coverage.x;

      float finalAlpha = mix(borderAlpha, 1.0, colorAlpha);

    ${i.depthHudEnabled?_`
      if (finalAlpha < 0.01) {
        discard;
      }
      `:_`
      vec3 finalRgb = mix(borderColor.rgb * borderAlpha, uColor.rgb, colorAlpha);
      gl_FragColor = vec4(finalRgb, finalAlpha);
      `}
  }
  `),e}function dO(i){return g(i)?i:Bl}const uO=$e(),Ck=Object.freeze(Object.defineProperty({__proto__:null,build:Tk},Symbol.toStringTag,{value:"Module"}));let KI=class JI extends Mt{initializeConfiguration(e,t){t.spherical=e.viewingMode===ve.Global}initializeProgram(e){return new Rt(e.rctx,JI.shader.get().build(this.configuration),Lt)}setPipelineState(e){const t=e?Fa.ALWAYS:Fa.LESS;return this.configuration.depthHudEnabled?qe({depthTest:{func:t},depthWrite:cn}):qe({blending:Ar(ae.ONE,ae.SRC_ALPHA,ae.ONE_MINUS_SRC_ALPHA,ae.ONE_MINUS_SRC_ALPHA),depthTest:{func:t},colorWrite:at})}initializePipeline(){return this.setPipelineState(this.configuration.hasMultipassGeometry)}};KI.shader=new Dt(Ck,()=>_e(()=>import("./LineCallout.glsl-70695808.js"),["assets/LineCallout.glsl-70695808.js","assets/calcite-8912bd40.js","assets/index-00759e4a.js","assets/index-5026a37a.css","assets/calcite-96fa36fd.css","assets/mat4f64-abdda1bb.js","assets/objectResourceUtils-782953c3.js","assets/devEnvironmentUtils-5002a058.js","assets/mat3f64-50f3b9f6.js","assets/BufferView-379a78a4.js","assets/vec33-69c9e93b.js","assets/DefaultMaterial_COLOR_GAMMA-6ed76d86.js","assets/types-e1c0a5bf.js","assets/enums-e2e92c86.js","assets/Version-aa0a1d91.js","assets/quat-7b70e9a8.js","assets/quatf64-f8f1c132.js","assets/resourceUtils-527631ac.js","assets/basicInterfaces-7449a8bf.js","assets/Indices-d8bff7b2.js","assets/NestedMap-1b5db22e.js","assets/requestImageUtils-d1ba3b36.js","assets/symbolColorUtils-c9d24716.js","assets/Util-6d3f024a.js","assets/sphere-d0e5285d.js","assets/VertexAttribute-15d1866a.js","assets/doublePrecisionUtils-e3c3d0d8.js","assets/OrderIndependentTransparency-5f7257d7.js","assets/Texture-563cf5e5.js","assets/FramebufferObject-8b18fc0c.js","assets/VertexElementDescriptor-2925c6af.js","assets/InterleavedLayout-d57c91d0.js","assets/vec3f32-01c06d8d.js","assets/plane-5e2b046c.js","assets/spatialReferenceEllipsoidUtils-afb35af9.js","assets/scaleUtils-d13015f2.js","assets/ElevationSamplerData-e3118b17.js","assets/Octree-499541ed.js","assets/edgeProcessing-20e12367.js","assets/deduplicate-769a6f51.js","assets/MeshComponent-788e605a.js","assets/earcut-61f7b102.js","assets/imageUtils-c2d0d1ae.js","assets/projection-5969b753.js","assets/ZoomMomentumEstimator-ef57e6a4.js","assets/floatRGBA-ca2b39ca.js","assets/dehydratedFeatures-3a140d03.js","assets/quantizationUtils-b3b2ae2a.js","assets/labelFormatUtils-71e1f841.js","assets/orientedBoundingBox-a14b97b5.js","assets/quatf32-51a323b8.js","assets/SnappingCandidate-970faec6.js","assets/callExpressionWithFeature-df1a8f01.js","assets/DefaultVertexAttributeLayouts-5f20d8dd.js","assets/geometryServiceUtils-a536bb19.js","assets/project-909a4219.js","assets/LercDecoder-65586d50.js","assets/VectorTile-d41a1f0f.js","assets/enums-fb086c25.js","assets/config-1337d16e.js","assets/TiledDisplayObject-419c008b.js","assets/DisplayObject-87c37b69.js","assets/rasterUtils-7694cc98.js","assets/resources-7587d8f4.js","assets/workerHelper-6131d203.js","assets/webgl-debug-7f880832.js","assets/RenderingContext-0f21aa0e.js","assets/ProgramCache-f29c900e.js","assets/Program-77209250.js","assets/MediaLayer-4c42fc2f.js","assets/MediaElementView-06baa4d4.js","assets/normalizeUtilsSync-3ea564a9.js","assets/resourceExtension-f31d9f10.js","assets/BoundsStore-00da37da.js","assets/PooledRBush-5a11bc7e.js","assets/prism-line-numbers-eff41b13.js","assets/label2-a2f37e65.js","assets/interactive-1de2e238.js","assets/loadable-6afd516d.js","assets/t9n-81df3a71.js","assets/observers-c89705b8.js","assets/icon-8e47fbec.js","assets/loader-c773e800.js","assets/guid-51402ee7.js","assets/prism-line-numbers-7c5d72ff.css"]));let gn=class extends Vn{constructor(){super(...arguments),this.screenCenterOffsetUnitsEnabled=Js.World,this.spherical=!1,this.occlusionTestEnabled=!0,this.hasVerticalOffset=!1,this.hasScreenSizePerspective=!1,this.depthHudEnabled=!1,this.depthHudAlignStartEnabled=!1,this.hasSlicePlane=!1,this.hasMultipassGeometry=!1}};d([D({count:Js.COUNT})],gn.prototype,"screenCenterOffsetUnitsEnabled",void 0),d([D()],gn.prototype,"spherical",void 0),d([D()],gn.prototype,"occlusionTestEnabled",void 0),d([D()],gn.prototype,"hasVerticalOffset",void 0),d([D()],gn.prototype,"hasScreenSizePerspective",void 0),d([D()],gn.prototype,"depthHudEnabled",void 0),d([D()],gn.prototype,"depthHudAlignStartEnabled",void 0),d([D()],gn.prototype,"hasSlicePlane",void 0),d([D()],gn.prototype,"hasMultipassGeometry",void 0),d([D({constValue:!0})],gn.prototype,"hasSliceInVertexProgram",void 0),d([D({constValue:!1})],gn.prototype,"isDraped",void 0);let F_=class xw extends jd{get uniqueMaterialIdentifier(){return this._uniqueMaterialIdentifier}constructor(e){super(e,new eL),this._configuration=new gn,this._uniqueMaterialIdentifier=xw.uniqueMaterialIdentifier(this.parameters)}getPassParameters(){return this.parameters}getConfiguration(e,t){const r=(t==null?void 0:t.slot)!==K.LINE_CALLOUTS;return this._configuration.occlusionTestEnabled=this.parameters.occlusionTest,this._configuration.hasVerticalOffset=g(this.parameters.verticalOffset),this._configuration.hasScreenSizePerspective=g(this.parameters.screenSizePerspective),this._configuration.depthHudEnabled=r,this._configuration.depthHudAlignStartEnabled=!!this.parameters.depthHUDAlignStart,this._configuration.screenCenterOffsetUnitsEnabled=this.parameters.centerOffsetUnits==="screen"?Js.Screen:Js.World,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.hasMultipassGeometry=t.multipassGeometry.enabled,this._configuration}intersect(){}requiresSlot(e,t){if(t===A.Color)switch(e){case K.LINE_CALLOUTS:case K.LINE_CALLOUTS_HUD_DEPTH:return!0}return!1}createGLMaterial(e){return new Sk(e)}createBufferWriter(){return new Ok}validateParameters(e){const t=xw.uniqueMaterialIdentifier(e);t!==this._uniqueMaterialIdentifier&&(this._uniqueMaterialIdentifier=t)}static uniqueMaterialIdentifier(e){return JSON.stringify({screenOffset:e.screenOffset||[0,0],centerOffsetUnits:e.centerOffsetUnits||"world"})}},Sk=class extends qd{beginSlot(e){return this.ensureTechnique(KI,e)}},eL=class extends Hf{constructor(){super(...arguments),this.screenOffset=uh,this.color=[0,0,0,1],this.size=1,this.occlusionTest=!1,this.shaderPolygonOffset=1e-5,this.depthHUDAlignStart=!1,this.centerOffsetUnits="world",this.hasSlicePlane=!1}};const Pk=mr().vec3f(w.POSITION).vec3f(w.NORMAL).vec2f(w.UV0).vec4f(w.AUXPOS1),pO=[cu(0,0),cu(1,0),cu(0,1),cu(1,0),cu(1,1),cu(0,1)];let Ok=class{constructor(){this.vertexBufferLayout=Pk}allocate(e){return this.vertexBufferLayout.createBuffer(e)}elementCount(e){return 6*e.indices.get(w.POSITION).length}write(e,t,r,s,a){DT(r.indices.get(w.POSITION),r.vertexAttributes.get(w.POSITION).data,e,s.position,a,6),M3(r.indices.get(w.NORMAL),r.vertexAttributes.get(w.NORMAL).data,t,s.normal,a,6),uy(r.indices.get(w.AUXPOS1),r.vertexAttributes.get(w.AUXPOS1).data,s.auxpos1,a,6);for(let n=0;n<pO.length;++n)s.uv0.setVec(a+n,pO[n])}},tL=class iL extends _l{constructor(e,t){super(e,null,t,Ak),this._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!1},this.ensureDrapedStatus(!1)}async doLoad(){this._material=new F_(this._materialParameters),this._context.stage.add(this._material)}destroy(){super.destroy(),this._context.stage.remove(this._material),this._material=null}_perInstanceMaterialParameters(e){const t=this._materialParameters;return t.screenOffset=e.screenOffset||uh,t.centerOffsetUnits=e.centerOffsetUnits||"world",t}get _materialParameters(){const e=new eL,t=this.symbol,r=t.callout;if(e.color=g(r.color)?ui.toUnitRGBA(r.color):[0,0,0,0],e.color[3]*=this._getLayerOpacity(),e.size=ta(r.size||0),t.verticalOffset){const{screenLength:n,minWorldLength:o,maxWorldLength:l}=t.verticalOffset;e.verticalOffset={screenLength:ta(n),minWorldLength:o||0,maxWorldLength:g(l)?l:1/0}}e.borderColor=g(r.border)&&g(r.border.color)?ui.toUnitRGBA(r.border.color):null;const s=t.symbolLayers.getItemAt(0).type==="object",a=t.type==="label-3d";return e.occlusionTest=!s,e.shaderPolygonOffset=s?0:void 0,e.depthHUDAlignStart=a,e.hasSlicePlane=this._context.slicePlaneEnabled,e.screenSizePerspective=this._context.screenSizePerspectiveEnabled?this._context.sharedResources.screenSizePerspectiveSettings:null,e}_defaultElevationInfoNoZ(){return Ek}createGraphics3DGraphic(e){const t=e.renderingInfo,r=e.graphic,s=this.setGraphicElevationContext(r,new Po,t.elevationOffset||0),a=t.symbol,n=this._elevationContext.mode==="on-the-ground"&&(a.type==="cim"||!a.symbolLayers.some(l=>l.type==="object"||l.type==="text"));if(a.type!=="label-3d"&&n||a.type==="point-3d"&&a.symbolLayers.every(l=>l.type==="text"&&!XA(l)))return null;const o=DC(r.geometry);return P(o)?null:this._createAs3DShape(o,s,t,r.uid)}layerOpacityChanged(){g(this._material)&&this._material.setParameters(this._materialParameters)}layerElevationInfoChanged(e,t,r){const s=this._elevationContext.mode,a=Qf(iL.elevationModeChangeTypes,r,s);return a!==Oi.UPDATE||e.forEach(n=>{const o=t(n);g(o)&&this.updateGraphicElevationContext(n.graphic,o)}),a}slicePlaneEnabledChanged(){return P(this._material)||this._material.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),!0}physicalBasedRenderingChanged(){return!0}pixelRatioChanged(){return!0}skipHighSymbolLodsChanged(){return!0}setGraphicElevationContext(e,t,r=0){const s=super.setGraphicElevationContext(e,t);return s.addOffsetRenderUnits(r),s}updateGraphicElevationContext(e,t){this.setGraphicElevationContext(e,t.elevationContext,g(t.metadata)?t.metadata.elevationOffset:0),t.needsElevationUpdates=Un(t.elevationContext.mode)}computeComplexity(){return{primitivesPerFeature:2,primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!1,memory:zC.memory}}_createVertexData(e){const{translation:t,centerOffset:r}=e,s=new be(t?[t[0],t[1],t[2]]:[0,0,0],3,!0),a=new be(r?[r[0],r[1],r[2],r[3]]:[0,0,0,1],4,!0);return[[w.POSITION,s],[w.NORMAL,new be([0,0,1],3,!0)],[w.AUXPOS1,a]]}_getOrCreateMaterial(e){const t=this._perInstanceMaterialParameters(e),r=F_.uniqueMaterialIdentifier(t);if(g(this._material)&&r===this._material.uniqueMaterialIdentifier)return{material:this._material,isUnique:!1};if(g(e.materialCollection)){let s=e.materialCollection.get(r);return P(s)&&(s=new F_(t),e.materialCollection.add(r,s)),{material:s,isUnique:!1}}return{material:new F_(t),isUnique:!0}}_createAs3DShape(e,t,r,s){const a=this._context.layer.uid,n=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:s,layerUid:a}),o=this._getOrCreateMaterial(r),l=new Cr(o.material,this._createVertexData(r),Rk,null,ps.Point,n),c=VC(this._context,e,l,t,s);if(P(c))return null;const h=new fl(this,c.object,[l],o.isUnique?[o.material]:null,null,bf,t);return h.metadata=new HI(r.elevationOffset),h.alignedSampledElevation=c.sampledElevation,h.needsElevationUpdates=Un(t.mode),xf(h,e,this._context.elevationProvider),h}};tL.elevationModeChangeTypes={definedChanged:Oi.UPDATE,staysOnTheGround:Oi.UPDATE,onTheGroundChanged:Oi.RECREATE};const ub=[0],Rk=[[w.POSITION,ub],[w.NORMAL,ub],[w.AUXPOS1,ub]],Ek={mode:"relative-to-ground",offset:0},Ak={ignoreDrivers:!0,renderPriority:0,renderPriorityStep:1};let Mk=class{constructor(e,t,r=T(),s=Pt(),a=$e(),n="world",o=0,l=null){this.renderer=e,this.symbol=t,this.translation=r,this.centerOffset=s,this.screenOffset=a,this.centerOffsetUnits=n,this.elevationOffset=o,this.materialCollection=l}},Dk=class extends gk{};const mO=Pe.getLogger("esri.views.3d.layers.graphics.Graphics3DCalloutSymbolLayerFactory");function Ik(i,e){if(!gT(i))return mO.error("Graphics3DCalloutSymbolLayerFactory#make",`symbol of type '${i.type}' does not support callouts`),null;if(!i.callout)return null;const t=Lk[i.callout.type];return t?new t(i,e):(mO.error("Graphics3DCalloutSymbolLayerFactory#make",`unknown or unsupported callout type ${i.callout.type}`),null)}const Lk={line:tL},gO=new lo(Array,i=>fT(i,nN),null,10,5),$k=yt();let Nk=class{get labelLayers(){return this._labelLayers}get extent(){return this._extent}constructor(e,t,r,s,a){this.graphic=e,this.graphics3DSymbol=t,this.layers=r,this._labelLayers=new Array,this._auxiliaryLayers=new Array,this._visibilityFlags=Fk(Fr._COUNT,Ma._COUNT),this._featureExpressionFeature=null,this._optimizedGeometry={geometry:null,hasZ:!1,hasM:!1},this._extent=null,this.isElevationSource=!1,++t.referenced,this._featureExpressionFeature=a?UI(a,e,s):null;for(const n of r)g(n)&&(this.isElevationSource=this.isElevationSource||n.isElevationSource)}initialize(e,t){this._layer=t,this._stage=e,this._forEachSymbolLayerGraphic(r=>{r.initialize(e,t),r.setVisibility(this.isVisible())})}destroy(){this._forEachSymbolLayerGraphic(e=>e.destroy()),this.layers=null,this._auxiliaryLayers=null,--this.graphics3DSymbol.referenced,this.graphics3DSymbol=null}get destroyed(){return this.layers==null}clearLabelGraphics(){this._forEachLabelGraphic(e=>e.destroy()),this._labelLayers.length=0}addLabelGraphic(e,t,r){this._labelLayers.push(e),e.initialize(t,r),e.setVisibility(this.isVisible(Fr.LABEL))}addAuxiliaryGraphic(e){this._auxiliaryLayers.push(e),this._layer&&(e.initialize(this._stage,this._layer),e.setVisibility(this.isVisible()))}get isDraped(){let e=!1;return this._forEachSymbolLayerGraphic(t=>{t.type==="draped"&&(e=!0)}),e}isVisible(e=Fr.GRAPHIC,t){for(let r=0;r<=e;r++){const s=this._visibilityFlags[r];for(let a=0;a<s.length;++a)if(s[a]===!1&&a!==t)return!1}return!0}hasVisibilityFlag(e,t){return this._visibilityFlags[t][e]!=null}setVisibilityFlag(e,t,r){const s=this.isVisible(r);this._visibilityFlags[r][e]=t;const a=this.isVisible(r);if(s===a)return!1;if(r===Fr.LABEL)this._forEachLabelGraphic(n=>n.setVisibility(a));else{this._forEachSymbolLayerGraphic(o=>o.setVisibility(a));const n=this.isVisible(Fr.LABEL);this._forEachLabelGraphic(o=>o.setVisibility(n))}return!0}clearVisibilityFlag(e,t=Fr.GRAPHIC){return this.setVisibilityFlag(e,void 0,t)}computeExtent(e){if(!this._extent){const t=this.graphic.geometry;if(P(t))return!1;this._extent=yt(),F6(t,this._extent);const r=t.spatialReference;if(!QA(r,e)&&!hv(this._extent,r,this._extent,e))return this._extent=null,!1}return!0}getAsOptimizedGeometry(e,t){return g(this._optimizedGeometry.geometry)&&this._optimizedGeometry.hasZ===e&&this._optimizedGeometry.hasM===t||(this._optimizedGeometry.geometry=this._convertGraphicToOptimizedGeometry(this.graphic,e,t),this._optimizedGeometry.hasZ=e,this._optimizedGeometry.hasM=t),this._optimizedGeometry.geometry}_convertGraphicToOptimizedGeometry(e,t,r){let s=e.geometry;return s.type!=="mesh"&&s.type!=="extent"||(s=_T.fromExtent(s.type==="mesh"?s.extent:s)),oN(s,t,r)}get usedMemory(){let e=lN(this.graphic.attributes);return this._forEachSymbolLayerGraphic(t=>{const r=t.graphics3DSymbolLayer.complexity;if(P(r))return;const s=t.type==="draped"?r.memory.draped:r.memory;e+=s.bytesPerFeature,s.bytesPerCoordinate&&(e+=z6(this.graphic.geometry)*s.bytesPerCoordinate)}),e}computeAttachmentOrigin(){const e={render:{origin:T(),num:0},draped:{origin:$e(),num:0}};for(const t of this.layers)P(t)||t.computeAttachmentOrigin(e);return e.render.num>1&&B(e.render.origin,e.render.origin,1/e.render.num),e.draped.num>1&&On(e.draped.origin,e.draped.origin,1/e.draped.num),e}async getProjectedBoundingBox(e,t,r,s,a){return a||(a={boundingBox:null,requiresDrapedElevation:!1,screenSpaceObjects:[]}),a.boundingBox?di(a.boundingBox):a.boundingBox=di(),a.requiresDrapedElevation=!1,await yT(this.layers,async n=>{if(P(n))return;const o=n.type==="draped"?t:e,l=gO.acquire(),c=await n.getProjectedBoundingBox(o,r,a.screenSpaceObjects,s,l);isFinite(c[2])&&isFinite(c[5])||(a.requiresDrapedElevation=!0),c&&zp(a.boundingBox,l),gO.release(l)}),cN(a.boundingBox)||yx(hT(a.boundingBox,$k))?a:null}needsElevationUpdates(){for(const e of this.layers)if(g(e)&&(e.type==="object3d"||e.type==="lod-instance")&&e.needsElevationUpdates)return!0;for(const e of this._labelLayers)if(e&&e.needsElevationUpdates)return!0;return!1}alignWithElevation(e,t,r){this._forEachRenderedGraphic(s=>{s.type!=="object3d"&&s.type!=="lod-instance"||s.alignWithElevation(e,t,this._featureExpressionFeature,r)})}alignWithAbsoluteElevation(e,t,r){this._forEachRenderedGraphic(s=>{s.type==="object3d"&&s.alignWithAbsoluteElevation(e,t,r)})}addObjectStateSet(e,t){this._forEachSymbolLayerGraphic(r=>r.addObjectState(e,t))}removeObjectState(e){this._forEachSymbolLayerGraphic(t=>t.removeObjectState(e))}_forEachGraphicList(e,t){e.forEach(r=>r&&t(r))}_forEachSymbolLayerGraphic(e){this._forEachGraphicList(this.layers,e),this._forEachGraphicList(this._auxiliaryLayers,e)}_forEachLabelGraphic(e){this._forEachGraphicList(this._labelLayers,e)}_forEachRenderedGraphic(e){this._forEachSymbolLayerGraphic(e),this._forEachLabelGraphic(e)}};function Fk(i,e){const t=new Array(i);for(let r=0;r<t.length;r++)t[r]=new Array(e);return t}function Vv(i,e){if(!i||i.symbol)return null;const t=e&&e.renderer;return i&&g(t)&&t.getObservationRenderer?t.getObservationRenderer(i):t}function zk(i,e){if(g(i.symbol))return i.symbol;const t=Vv(i,e);return g(t)&&t.type!=="dot-density"?t.getSymbol(i,e):null}function Lne(i,e){const t=Vv(i,e),r=zk(i,e);if(P(r))return null;const s={renderer:t,symbol:r};if(P(t)||!("visualVariables"in t)||!t.visualVariables)return s;const a=ZA(t,i,e)??[],n=["proportional","proportional","proportional"];for(const{variable:o,value:l}of a)switch(o.type){case"color":s.color=l.toRgba();break;case"size":if(o.target==="outline")s.outlineSize=l;else{const c=o.axis,h=o.useSymbolValue?"symbol-value":l;switch(c){case"width":n[0]=h;break;case"depth":n[1]=h;break;case"height":n[2]=h;break;case"width-and-depth":n[0]=n[1]=h;break;default:n[0]=n[1]=n[2]=h}}break;case"opacity":s.opacity=l;break;case"rotation":switch(o.axis){case"tilt":s.tilt=l;break;case"roll":s.roll=l;break;default:s.heading=l}}return n[0]==="proportional"&&n[1]==="proportional"&&n[2]==="proportional"||(s.size=n),s}async function Uk(i,e){if(g(i.symbol))return i.symbol;const t=Vv(i,e);return g(t)?t.getSymbolAsync(i,e):null}async function $ne(i,e){const t=Vv(i,e),r=await Uk(i,e);if(!r)return null;const s={renderer:t,symbol:r};if(!t||!("visualVariables"in t)||!t.visualVariables)return s;const a=ZA(t,i,e)??[],n=["proportional","proportional","proportional"];for(const{variable:o,value:l}of a)if(o.type==="color")s.color=ui.toUnitRGBA(l);else if(o.type==="size")if(o.target==="outline")s.outlineSize=l;else{const c=o.axis,h=o.useSymbolValue?"symbol-value":l;c==="width"?n[0]=h:c==="depth"?n[1]=h:c==="height"?n[2]=h:n[0]=n[1]=c==="width-and-depth"?h:n[2]=h}else o.type==="opacity"?s.opacity=l:o.type==="rotation"&&o.axis==="tilt"?s.tilt=l:o.type==="rotation"&&o.axis==="roll"?s.roll=l:o.type==="rotation"&&(s.heading=l);return(isFinite(n[0])||isFinite(n[1])||isFinite(n[2]))&&(s.size=n),s}function Vk(i,e=0){const t=i[e];return typeof t=="number"&&isFinite(t)?t:null}function Gk(i){for(let e=0;e<3;e++){const t=i[e];if(typeof t=="number")return isFinite(t)?t:0}return 0}function fO(i){const e=[[w.POSITION,i.indices]],t=[[w.POSITION,new be(i.attributeData.position,3,!0)]];return g(i.attributeData.color)&&(t.push([w.COLOR,new be(i.attributeData.color,4,!0)]),e.push([w.COLOR,new Array(i.indices.length).fill(0)])),g(i.attributeData.uvMapSpace)&&(t.push([w.UVMAPSPACE,new be(i.attributeData.uvMapSpace,4,!0)]),e.push([w.UVMAPSPACE,i.indices])),g(i.attributeData.boundingRect)&&(t.push([w.BOUNDINGRECT,new be(i.attributeData.boundingRect,9,!0)]),e.push([w.BOUNDINGRECT,i.indices])),new Cr(i.material,t,e,i.mapPositions,ps.Mesh,i.attributeData.objectAndLayerIdColor)}function _O(i){const e=[[w.POSITION,i.indices],[w.UV0,i.indices]],t=[[w.POSITION,new be(i.attributeData.position,3,!0)],[w.UV0,new be(i.attributeData.uv0,2,!0)]];return new Cr(i.material,t,e,i.mapPositions)}function Tf(i){switch(i.type){case"extent":if(i instanceof ds)return _T.fromExtent(i);break;case"polygon":return i}return null}let Gv=class{constructor(e,t,r){this.renderData=e,this.layerUid=t,this.graphicUid=r,this.outGeometries=new Array}};var Dg,Gy,ww;(function(i){i[i.RasterImage=0]="RasterImage",i[i.Features=1]="Features"})(Dg||(Dg={})),function(i){i[i.MapLayer=0]="MapLayer",i[i.ViewLayer=1]="ViewLayer",i[i.Outline=2]="Outline",i[i.SnappingHint=3]="SnappingHint"}(Gy||(Gy={})),function(i){i[i.WithRasterImage=0]="WithRasterImage",i[i.WithoutRasterImage=1]="WithoutRasterImage"}(ww||(ww={}));var oi,Sn,ze,Ig,Ci,or,cs;(function(i){i[i.INNER=0]="INNER",i[i.OUTER=1]="OUTER"})(oi||(oi={})),function(i){i[i.REGULAR=0]="REGULAR",i[i.HAS_NORTH_POLE=1]="HAS_NORTH_POLE",i[i.HAS_SOUTH_POLE=2]="HAS_SOUTH_POLE",i[i.HAS_BOTH_POLES=3]="HAS_BOTH_POLES"}(Sn||(Sn={})),function(i){i[i.NORTH=0]="NORTH",i[i.NORTH_EAST=1]="NORTH_EAST",i[i.EAST=2]="EAST",i[i.SOUTH_EAST=3]="SOUTH_EAST",i[i.SOUTH=4]="SOUTH",i[i.SOUTH_WEST=5]="SOUTH_WEST",i[i.WEST=6]="WEST",i[i.NORTH_WEST=7]="NORTH_WEST"}(ze||(ze={})),function(i){i[i.OFF=0]="OFF",i[i.ON=1]="ON"}(Ig||(Ig={})),function(i){i[i.Color=0]="Color",i[i.ColorNoRasterImage=1]="ColorNoRasterImage",i[i.Highlight=2]="Highlight",i[i.Water=3]="Water",i[i.Occluded=4]="Occluded",i[i.ObjectAndLayerIdColor=5]="ObjectAndLayerIdColor"}(Ci||(Ci={})),function(i){i[i.FADING=0]="FADING",i[i.IMMEDIATE=1]="IMMEDIATE",i[i.UNFADED=2]="UNFADED"}(or||(or={})),function(i){i[i.INSIDE=0]="INSIDE",i[i.INTERSECTS=1]="INTERSECTS",i[i.OUTSIDE=2]="OUTSIDE"}(cs||(cs={}));let Bk=class{constructor(e,t){this.vec3=e,this.id=t}};function Lg(i,e,t,r){return new Bk(Ge(i,e,t),r)}var Xs;(function(i){i[i.None=0]="None",i[i.ColorAndWater=1]="ColorAndWater",i[i.Highlight=2]="Highlight",i[i.Occluded=3]="Occluded",i[i.ObjectAndLayerIdColor=4]="ObjectAndLayerIdColor"})(Xs||(Xs={}));let yO=class{get extent(){return this._extent}constructor(e,t){this.index=e,this.renderTargets=t,this._extent=yt(),this.resolution=0,this.renderLocalOrigin=Lg(0,0,0,"O"),this.pixelRatio=1,this.mapUnitsPerPixel=1,this.canvasGeometries=new Hk,this.hasDrapedFeatureSource=!1,this.hasDrapedRasterSource=!1,this.hasTargetWithoutRasterImage=!1,this.index=e,this.validTargets=new Array(t.renderTargets.length).fill(!1)}getValidTexture(e){return this.validTargets[e]?this.renderTargets.getTarget(e).getTexture():null}get _needsColorWithoutRasterImage(){return this.hasDrapedRasterSource&&this.hasDrapedFeatureSource&&this.hasTargetWithoutRasterImage}getColorTexture(e){const t=e===Xs.ColorAndWater?this.renderTargets.getTarget(Ci.Color):e===Xs.Highlight?this.renderTargets.getTarget(Ci.Highlight):e===Xs.ObjectAndLayerIdColor?this.renderTargets.getTarget(Ci.ObjectAndLayerIdColor):this.renderTargets.getTarget(Ci.Occluded);return t?t.getTexture():null}getColorTextureNoRasterImage(){return this._needsColorWithoutRasterImage?this.getValidTexture(Ci.ColorNoRasterImage):this.hasDrapedFeatureSource?this.getValidTexture(Ci.Color):null}getNormalTexture(e){const t=e===Xs.ColorAndWater?this.renderTargets.getTarget(Ci.Water):null;return t?t.getTexture():null}draw(e,t){const r=this.computeRenderTargetValidityBitfield();for(const s of this.renderTargets.renderTargets)s.type!==Ci.ColorNoRasterImage||this._needsColorWithoutRasterImage?this.validTargets[s.type]=e.drawTarget(this,s,t):this.validTargets[s.type]=!1;return r^this.computeRenderTargetValidityBitfield()?yy.CHANGED:yy.UNCHANGED}computeRenderTargetValidityBitfield(){const e=this.validTargets;return+e[Ci.Color]|+e[Ci.ColorNoRasterImage]<<1|+e[Ci.Highlight]<<2|+e[Ci.Water]<<3|+e[Ci.Occluded]<<4}setupGeometryViewsCyclical(e){this.setupGeometryViewsDirect();const t=.001*e.range;if(this._extent[0]-t<=e.min){const r=this.canvasGeometries.extents[this.canvasGeometries.numViews++];cy(this._extent,e.range,0,r)}if(this._extent[2]+t>=e.max){const r=this.canvasGeometries.extents[this.canvasGeometries.numViews++];cy(this._extent,-e.range,0,r)}}setupGeometryViewsDirect(){this.canvasGeometries.numViews=1,Wg(this.canvasGeometries.extents[0],this._extent)}hasSomeSizedView(){for(let e=0;e<this.canvasGeometries.numViews;e++){const t=this.canvasGeometries.extents[e];if(t[0]!==t[2]&&t[1]!==t[3])return!0}return!1}applyViewport(e){e.setViewport(this.index===oi.INNER?0:this.resolution,0,this.resolution,this.resolution)}},Hk=class{constructor(){this.extents=[yt(),yt(),yt()],this.numViews=0}},rL=class{constructor(e,t){this._size=hN(),this._fbo=null,this._fbo=new Rs(e,{colorTarget:la.TEXTURE,depthStencilTarget:La.NONE},{target:tr.TEXTURE_2D,pixelFormat:St.RGBA,dataType:Zt.UNSIGNED_BYTE,wrapMode:kt.CLAMP_TO_EDGE,samplingMode:Qt.LINEAR_MIPMAP_LINEAR,hasMipmap:t,maxAnisotropy:8,width:0,height:0})}dispose(){this._fbo=De(this._fbo)}getTexture(){return this._fbo?this._fbo.colorTexture:null}isValid(){return this._fbo!==null}resize(e,t){this._size[0]=e,this._size[1]=t,this._fbo.resize(this._size[0],this._size[1])}bind(e){e.bindFramebuffer(this._fbo)}generateMipMap(){const e=this._fbo.colorTexture;e.descriptor.hasMipmap&&e.generateMipmap()}disposeRenderTargetMemory(){var e;(e=this._fbo)==null||e.resize(0,0)}get gpuMemoryUsage(){var e;return((e=this._fbo)==null?void 0:e.gpuMemoryUsage)??0}},Ou=class{constructor(e,t,r,s=!0){this.output=t,this.type=r,this.valid=!1,this.lastUsed=1/0,this.fbo=new rL(e,s)}},kk=class{constructor(e){this.renderTargets=[new Ou(e,A.Color,Ci.Color),new Ou(e,A.Color,Ci.ColorNoRasterImage),new Ou(e,A.Highlight,Ci.Highlight,!1),new Ou(e,A.Normal,Ci.Water),new Ou(e,A.Color,Ci.Occluded)],vi("enable-feature:objectAndLayerId-rendering")&&this.renderTargets.push(new Ou(e,A.ObjectAndLayerIdColor,Ci.ObjectAndLayerIdColor))}getTarget(e){return this.renderTargets[e].fbo}dispose(){for(const e of this.renderTargets)e.fbo.dispose()}disposeRenderTargetMemory(){for(const e of this.renderTargets)e.fbo.disposeRenderTargetMemory()}validateUsageForTarget(e,t,r){if(e)t.lastUsed=r;else if(r-t.lastUsed>jk)t.fbo.disposeRenderTargetMemory(),t.lastUsed=1/0;else if(t.lastUsed<1/0)return!0;return!1}get gpuMemoryUsage(){return this.renderTargets.reduce((e,t)=>e+t.fbo.gpuMemoryUsage,0)}};const jk=1e3;let sL=class{constructor(e){this._context=e,this._perConstructorInstances=new Tv,this._frameCounter=0,this._keepAliveFrameCount=vO}get viewingMode(){return this._context.viewingMode}get constructionContext(){return this._context}destroy(){this._perConstructorInstances.forEach(e=>e.forEach(t=>t.technique.destroy())),this._perConstructorInstances.clear()}acquire(e,t=Wk){const r=t.key;let s=this._perConstructorInstances.get(e,r);if(P(s)){const a=new e(this._context,t,()=>this.release(a));s=new qk(a),this._perConstructorInstances.set(e,r,s)}return++s.refCount,s.technique}releaseAndAcquire(e,t,r){if(g(r)){if(t.key===r.key)return r;this.release(r)}return this.acquire(e,t)}release(e){if(P(e)||this._perConstructorInstances.empty)return;const t=this._perConstructorInstances.get(e.constructor,e.key);P(t)||(--t.refCount,t.refCount===0&&(t.refZeroFrame=this._frameCounter))}frameUpdate(){this._frameCounter++,this._keepAliveFrameCount!==vO&&this._perConstructorInstances.forEach((e,t)=>{e.forEach((r,s)=>{r.refCount===0&&r.refZeroFrame+this._keepAliveFrameCount<this._frameCounter&&(r.technique.destroy(),this._perConstructorInstances.delete(t,s))})})}async reloadAll(){const e=new Array;this._perConstructorInstances.forEach((t,r)=>{const s=async(a,n)=>{const o=n.shader;o&&(await o.reload(),a.forEach(l=>l.technique.reload(this._context)))};e.push(s(t,r))}),await Promise.all(e)}},qk=class{constructor(e){this.technique=e,this.refCount=0,this.refZeroFrame=0}};const vO=-1,Wk=new ua;let aL=class{constructor(e,t,r,s){this._textureRepository=e,this._techniqueRepository=t,this.materialChanged=r,this.requestRender=s,this._id2glMaterialRef=new Tv}dispose(){this._textureRepository.destroy()}acquire(e,t,r){if(this._ownMaterial(e),!e.requiresSlot(t,r))return null;let s=this._id2glMaterialRef.get(r,e.id);if(P(s)){const a=e.createGLMaterial({material:e,techniqueRep:this._techniqueRepository,textureRep:this._textureRepository,output:r});s=new Xk(a),this._id2glMaterialRef.set(r,e.id,s)}return s.ref(),s.glMaterial}release(e,t){const r=this._id2glMaterialRef.get(t,e.id);g(r)&&(r.unref(),r.referenced||(De(r.glMaterial),this._id2glMaterialRef.delete(t,e.id)))}_ownMaterial(e){g(e.repository)&&e.repository!==this&&Pe.getLogger("esri.views.3d.webgl-engine.lib.GLMaterialRepository").error("Material is already owned by a different material repository"),e.repository=this}},Xk=class{constructor(e){this.glMaterial=e,this._refCnt=0}ref(){++this._refCnt}unref(){--this._refCnt,dt(this._refCnt>=0)}get referenced(){return this._refCnt>0}};const Qk={orderedRepackingEnabled:!1},Zk={rootOrigin:null},Yk=["layerObjectAdded","layerObjectRemoved","layerObjectsAdded","layerObjectsRemoved","shaderTransformationChanged","objectTransformation","visibilityChanged","occlusionChanged","highlightChanged","objectGeometryAdded","objectGeometryRemoved","objectGeometryUpdated"];var ah;(function(i){i[i.ASYNC=0]="ASYNC",i[i.SYNC=1]="SYNC"})(ah||(ah={}));let nL=class extends I3{get objects(){return this._objects}constructor(e,t=""){super(),this.apiLayerUid=t,this.type=ps.Layer,this.events=new Ms,this.sliceable=!1,this._objects=new At,this._objectsAdded=new At,this._stageHandles=new Vi,this.apiLayerUid=t,this.visible=(e==null?void 0:e.visible)??!0,this.pickable=(e==null?void 0:e.pickable)??!0,this.updatePolicy=(e==null?void 0:e.updatePolicy)??ah.ASYNC,this._disableOctree=(e==null?void 0:e.disableOctree)??!1}destroy(){this.detachStage(),this._stage=null}attachStage(e){this.detachStage(),this._stage=e;for(const t of Yk)this._stageHandles.add(this.events.on(t,r=>e.handleEvent(t,r)))}detachStage(){this._stageHandles.removeAll(),this.invalidateSpatialQueryAccelerator()}add(e){this._objects.push(e),e.parentLayer=this,this.events.emit("layerObjectAdded",{layer:this,object:e}),g(this._octree)&&this._objectsAdded.push(e)}remove(e){this._objects.removeUnordered(e)&&(e.parentLayer=null,this.events.emit("layerObjectRemoved",{layer:this,object:e}),g(this._octree)&&(this._objectsAdded.removeUnordered(e)||this._octree.remove([e])))}addMany(e){this._objects.pushArray(e);for(const t of e)t.parentLayer=this;this.events.emit("layerObjectsAdded",{layer:this,objects:e}),g(this._octree)&&this._objectsAdded.pushArray(e)}removeMany(e){const t=new Array;if(this._objects.removeUnorderedMany(e,e.length,t),t.length!==0){for(const r of t)r.parentLayer=null;if(this.events.emit("layerObjectsRemoved",{layer:this,objects:t}),g(this._octree)){for(let r=0;r<t.length;)this._objectsAdded.removeUnordered(t[r])?(t[r]=t[t.length-1],t.length-=1):++r;this._octree.remove(t)}}}sync(){g(this._stage)&&this.updatePolicy!==ah.SYNC&&this._stage.syncLayer(this.id)}notifyObjectBBChanged(e,t){g(this._octree)&&!this._objectsAdded.includes(e)&&this._octree.update(e,t)}getSpatialQueryAccelerator(){return P(this._octree)&&this._objects.length>50&&!this._disableOctree?(this._octree=new ho(e=>e.boundingVolumeWorldSpace.bounds),this._octree.add(this._objects.data,this._objects.length)):g(this._octree)&&this._objectsAdded.length>0&&(this._octree.add(this._objectsAdded.data,this._objectsAdded.length),this._objectsAdded.clear()),this._octree}shaderTransformationChanged(){this.invalidateSpatialQueryAccelerator(),this.events.emit("shaderTransformationChanged",this)}invalidateSpatialQueryAccelerator(){this._octree=Te(this._octree),this._objectsAdded.clear()}};function By(i){return g(i)&&i.type===ps.Layer}var Ln,Fd;(function(i){i[i.Draped=0]="Draped",i[i.Screen=1]="Screen",i[i.World=2]="World",i[i.COUNT=3]="COUNT"})(Ln||(Ln={})),function(i){i[i.Center=0]="Center",i[i.Tip=1]="Tip",i[i.COUNT=2]="COUNT"}(Fd||(Fd={}));let Ir=class extends Vn{constructor(){super(...arguments),this.output=A.Color,this.transparencyPassType=We.NONE,this.occluder=!1,this.hasSlicePlane=!1,this.writeDepth=!1,this.space=Ln.Screen,this.hideOnShortSegments=!1,this.hasCap=!1,this.anchor=Fd.Center,this.hasTip=!1,this.vvSize=!1,this.vvColor=!1,this.vvOpacity=!1,this.hasOccludees=!1,this.hasMultipassTerrain=!1,this.cullAboveGround=!1}};d([D({count:A.COUNT})],Ir.prototype,"output",void 0),d([D({count:We.COUNT})],Ir.prototype,"transparencyPassType",void 0),d([D()],Ir.prototype,"occluder",void 0),d([D()],Ir.prototype,"hasSlicePlane",void 0),d([D()],Ir.prototype,"writeDepth",void 0),d([D({count:Ln.COUNT})],Ir.prototype,"space",void 0),d([D()],Ir.prototype,"hideOnShortSegments",void 0),d([D()],Ir.prototype,"hasCap",void 0),d([D({count:Fd.COUNT})],Ir.prototype,"anchor",void 0),d([D()],Ir.prototype,"hasTip",void 0),d([D()],Ir.prototype,"vvSize",void 0),d([D()],Ir.prototype,"vvColor",void 0),d([D()],Ir.prototype,"vvOpacity",void 0),d([D()],Ir.prototype,"hasOccludees",void 0),d([D()],Ir.prototype,"hasMultipassTerrain",void 0),d([D()],Ir.prototype,"cullAboveGround",void 0),d([D({constValue:!0})],Ir.prototype,"hasVvInstancing",void 0),d([D({constValue:!0})],Ir.prototype,"hasSliceTranslatedView",void 0);const bO=8;function oL(i,e){const t=i.vertex;t.uniforms.add(new ue("intrinsicWidth",r=>r.width)),e.vvSize?(i.attributes.add(w.SIZEFEATUREATTRIBUTE,"float"),t.uniforms.add(new si("vvSizeMinSize",r=>r.vvSizeMinSize)),t.uniforms.add(new si("vvSizeMaxSize",r=>r.vvSizeMaxSize)),t.uniforms.add(new si("vvSizeOffset",r=>r.vvSizeOffset)),t.uniforms.add(new si("vvSizeFactor",r=>r.vvSizeFactor)),t.code.add(_`float getSize() {
return intrinsicWidth * clamp(vvSizeOffset + sizeFeatureAttribute * vvSizeFactor, vvSizeMinSize, vvSizeMaxSize).x;
}`)):(i.attributes.add(w.SIZE,"float"),t.code.add(_`float getSize(){
return intrinsicWidth * size;
}`)),e.vvOpacity?(i.attributes.add(w.OPACITYFEATUREATTRIBUTE,"float"),t.constants.add("vvOpacityNumber","int",8),t.uniforms.add([new Ps("vvOpacityValues",r=>r.vvOpacityValues,bO),new Ps("vvOpacityOpacities",r=>r.vvOpacityOpacities,bO)]),t.code.add(_`float interpolateOpacity( float value ){
if (value <= vvOpacityValues[0]) {
return vvOpacityOpacities[0];
}
for (int i = 1; i < vvOpacityNumber; ++i) {
if (vvOpacityValues[i] >= value) {
float f = (value - vvOpacityValues[i-1]) / (vvOpacityValues[i] - vvOpacityValues[i-1]);
return mix(vvOpacityOpacities[i-1], vvOpacityOpacities[i], f);
}
}
return vvOpacityOpacities[vvOpacityNumber - 1];
}
vec4 applyOpacity( vec4 color ){
return vec4(color.xyz, interpolateOpacity(opacityFeatureAttribute));
}`)):t.code.add(_`vec4 applyOpacity( vec4 color ){
return color;
}`),e.vvColor?(i.attributes.add(w.COLORFEATUREATTRIBUTE,"float"),t.constants.add("vvColorNumber","int",rh),t.uniforms.add(new Ps("vvColorValues",r=>r.vvColorValues,rh)),t.uniforms.add(new MT("vvColorColors",r=>r.vvColorColors,rh)),t.code.add(_`vec4 interpolateColor( float value ) {
if (value <= vvColorValues[0]) {
return vvColorColors[0];
}
for (int i = 1; i < vvColorNumber; ++i) {
if (vvColorValues[i] >= value) {
float f = (value - vvColorValues[i-1]) / (vvColorValues[i] - vvColorValues[i-1]);
return mix(vvColorColors[i-1], vvColorColors[i], f);
}
}
return vvColorColors[vvColorNumber - 1];
}
vec4 getColor(){
return applyOpacity(interpolateColor(colorFeatureAttribute));
}`)):(i.attributes.add(w.COLOR,"vec4"),t.code.add(_`vec4 getColor(){
return applyOpacity(color);
}`))}let lL=class{constructor(e){this._rctx=e,this._cache=new Map}destroy(){this._cache.forEach(e=>De(e.stippleTexture)),this._cache.clear()}_acquire(e){if(P(e))return null;const t=this._patternId(e),r=this._cache.get(t);if(r)return r.refCount++,r;const{encodedData:s,paddedPixels:a}=Jk(e),n=new Kk(new Ai(this._rctx,{width:a,height:1,internalFormat:St.RGBA,pixelFormat:St.RGBA,dataType:Zt.UNSIGNED_BYTE,wrapMode:kt.CLAMP_TO_EDGE},s));return this._cache.set(t,n),n}release(e){if(P(e))return;const t=this._patternId(e),r=this._cache.get(t);r&&(r.refCount--,r.refCount===0&&(g(r.stippleTexture)&&r.stippleTexture.dispose(),this._cache.delete(t)))}swap(e,t){const r=this._acquire(t);return this.release(e),r}_patternId(e){return`${e.pattern.join(",")}-r${e.pixelRatio}`}},Kk=class extends Gi{constructor(e){super(),this.stippleTexture=e,this.refCount=1}};function Jk(i){const e=GC(i),t=1/i.pixelRatio,r=cL(i),s=hL(i),a=(Math.floor(.5*(s-1))+.5)*t,n=[];let o=1;for(const m of e){for(let f=0;f<m;f++){const y=o*(Math.min(f,m-1-f)+.5)*t/a*.5+.5;n.push(y)}o=-o}const l=Math.round(e[0]/2),c=[...n.slice(l),...n.slice(0,l)],h=r+dL,u=new Uint8Array(4*h);let p=4;for(const m of c)af(m,u,p),p+=4;return u.copyWithin(0,p-4,p),u.copyWithin(p,4,8),{encodedData:u,paddedPixels:h}}function GC(i){return i.pattern.map(e=>Math.round(e*i.pixelRatio))}function cL(i){if(P(i))return 1;const e=GC(i);return Math.floor(e.reduce((t,r)=>t+r))}function hL(i){return GC(i).reduce((e,t)=>Math.max(e,t))}const dL=2;function ej(i){return P(i)?Bl:i.length===4?i:Br(tj,i[0],i[1],i[2],1)}const tj=Pt();function uL(i,e){i.constants.add("stippleAlphaColorDiscard","float",.001),i.constants.add("stippleAlphaHighlightDiscard","float",.5),e.stippleEnabled?ij(i,e):rj(i)}function ij(i,e){const t=!(e.draped&&e.stipplePreferContinuous),{vertex:r,fragment:s}=i;s.include(To),e.draped||(rm(r,e),r.uniforms.add(new ue("worldToScreenPerDistanceRatio",(n,o)=>1/o.camera.perScreenPixelRatio)),r.code.add(_`float computeWorldToScreenRatio(vec3 segmentCenter) {
float segmentDistanceToCamera = length(segmentCenter - cameraPosition);
return worldToScreenPerDistanceRatio / segmentDistanceToCamera;
}`)),i.varyings.add("vStippleDistance","float"),e.stippleRequiresClamp&&i.varyings.add("vStippleDistanceLimits","vec2"),e.stippleRequiresStretchMeasure&&i.varyings.add("vStipplePatternStretch","float"),r.code.add(_`
    float discretizeWorldToScreenRatio(float worldToScreenRatio) {
      float step = ${aj};

      float discreteWorldToScreenRatio = log(worldToScreenRatio);
      discreteWorldToScreenRatio = ceil(discreteWorldToScreenRatio / step) * step;
      discreteWorldToScreenRatio = exp(discreteWorldToScreenRatio);
      return discreteWorldToScreenRatio;
    }
  `),r.code.add(_`vec2 computeStippleDistanceLimits(float startPseudoScreen, float segmentLengthPseudoScreen, float segmentLengthScreen, float patternLength) {`),r.code.add(_`
    if (segmentLengthPseudoScreen >= ${t?"patternLength":"1e4"}) {
  `),r.uniforms.add(new ue("pixelRatio",(n,o)=>o.camera.pixelRatio)),r.code.add(_`
        // Round the screen length to get an integer number of pattern repetitions (minimum 1).
        float repetitions = segmentLengthScreen / (patternLength * pixelRatio);
        float flooredRepetitions = max(1.0, floor(repetitions + 0.5));
        float segmentLengthScreenRounded = flooredRepetitions * patternLength;

        ${e.stippleRequiresStretchMeasure?_`
              float stretch = repetitions / flooredRepetitions;

              // We need to impose a lower bound on the stretch factor to prevent the dots from merging together when there is only 1 repetition.
              // 0.75 is the lowest possible stretch value for flooredRepetitions > 1, so it makes sense as lower bound.
              vStipplePatternStretch = max(0.75, stretch);`:""}

        return vec2(0.0, segmentLengthScreenRounded);
      }
      return vec2(startPseudoScreen, startPseudoScreen + segmentLengthPseudoScreen);
    }
  `),s.constants.add("stippleTexturePadding","float",dL);const a=e.hasWebGL2Context?ms.None:ms.Size;s.uniforms.add(_v("stipplePatternTexture",n=>n.stippleTexture,a)),s.uniforms.add([new ue("stipplePatternSDFNormalizer",n=>sj(n.stipplePattern)),new ue("stipplePatternPixelSizeInv",n=>1/BC(n))]),s.code.add(_`
    float padStippleTexture(float u) {
      float paddedTextureSize = ${sm(e,"stipplePatternTexture")}.x;
      float unpaddedTextureSize = paddedTextureSize - stippleTexturePadding;

      return (u * unpaddedTextureSize + stippleTexturePadding * 0.5) / paddedTextureSize;
    }
  `),s.code.add(_`
    float getStippleSDF(out bool isClamped) {
      ${e.stippleRequiresClamp?_`
          float stippleDistanceClamped = clamp(vStippleDistance, vStippleDistanceLimits.x, vStippleDistanceLimits.y);
          vec2 aaCorrectedLimits = vStippleDistanceLimits + vec2(1.0, -1.0) / gl_FragCoord.w;
          isClamped = vStippleDistance < aaCorrectedLimits.x || vStippleDistance > aaCorrectedLimits.y;`:_`
          float stippleDistanceClamped = vStippleDistance;
          isClamped = false;`}

      float u = stippleDistanceClamped * gl_FragCoord.w * stipplePatternPixelSizeInv;
      ${e.stippleScaleWithLineWidth?_`u *= vLineSizeInv;`:""}
      u = padStippleTexture(fract(u));

      float encodedSDF = rgba2float(texture2D(stipplePatternTexture, vec2(u, 0.5)));
      float sdf = (encodedSDF * 2.0 - 1.0) * stipplePatternSDFNormalizer;

      ${e.stippleRequiresStretchMeasure?_`return (sdf - 0.5) * vStipplePatternStretch + 0.5;`:_`return sdf;`}
    }

    float getStippleSDF() {
      bool ignored;
      return getStippleSDF(ignored);
    }

    float getStippleAlpha() {
      bool isClamped;
      float stippleSDF = getStippleSDF(isClamped);

      float antiAliasedResult = ${e.stippleScaleWithLineWidth?_`clamp(stippleSDF * vLineWidth + 0.5, 0.0, 1.0);`:_`clamp(stippleSDF + 0.5, 0.0, 1.0);`}

      return isClamped ? floor(antiAliasedResult + 0.5) : antiAliasedResult;
    }
  `),e.stippleOffColorEnabled?(s.uniforms.add(new ai("stippleOffColor",n=>ej(n.stippleOffColor))),s.code.add(_`#define discardByStippleAlpha(stippleAlpha, threshold) {}
#define blendStipple(color, stippleAlpha) mix(color, stippleOffColor, stippleAlpha)`)):s.code.add(_`#define discardByStippleAlpha(stippleAlpha, threshold) if (stippleAlpha < threshold) { discard; }
#define blendStipple(color, stippleAlpha) vec4(color.rgb, color.a * stippleAlpha)`)}function rj(i){i.fragment.code.add(_`float getStippleAlpha() { return 1.0; }
#define discardByStippleAlpha(_stippleAlpha_, _threshold_) {}
#define blendStipple(color, _stippleAlpha_) color`)}function sj(i){return g(i)?(Math.floor(.5*(hL(i)-1))+.5)/i.pixelRatio:1}function BC(i){const e=i.stipplePattern;return g(e)?cL(i.stipplePattern)/e.pixelRatio:1}const aj=_.float(.4),Cf=64,HC=Cf/2,pL=HC/5,nj=Cf/pL,oj=.25;function lj(i,e){return i.fromData(`${e}-marker`,()=>yI(e,Cf,HC,pL))}function mL(i,e){const t=i.vertex;i.constants.add("markerSizePerLineWidth","float",nj),t.uniforms.add(new ue("pixelRatio",(r,s)=>s.camera.pixelRatio)),P(t.uniforms.get("markerScale"))&&t.constants.add("markerScale","float",1),t.code.add(_`float getLineWidth() {
return max(getSize(), 1.0) * pixelRatio;
}
float getScreenMarkerSize() {
return markerSizePerLineWidth * markerScale * getLineWidth();
}`),e.space===Ln.World&&(t.constants.add("maxSegmentLengthFraction","float",.45),t.uniforms.add(new ue("perRenderPixelRatio",(r,s)=>s.camera.perRenderPixelRatio)),t.code.add(_`float getWorldMarkerSize(vec4 pos) {
float distanceToCamera = length(pos.xyz);
float screenToWorldRatio = perRenderPixelRatio * distanceToCamera * 0.5;
return getScreenMarkerSize() * screenToWorldRatio;
}
bool areWorldMarkersHidden(vec4 pos, vec4 other) {
vec3 midPoint = mix(pos.xyz, other.xyz, 0.5);
float distanceToCamera = length(midPoint);
float screenToWorldRatio = perRenderPixelRatio * distanceToCamera * 0.5;
float worldMarkerSize = getScreenMarkerSize() * screenToWorldRatio;
float segmentLen = length(pos.xyz - other.xyz);
return worldMarkerSize > maxSegmentLengthFraction * segmentLen;
}`))}var $n;(function(i){i[i.BUTT=0]="BUTT",i[i.SQUARE=1]="SQUARE",i[i.ROUND=2]="ROUND",i[i.COUNT=3]="COUNT"})($n||($n={}));let ni=class extends Vn{constructor(){super(...arguments),this.output=A.Color,this.capType=$n.BUTT,this.transparencyPassType=We.NONE,this.occluder=!1,this.hasSlicePlane=!1,this.hasPolygonOffset=!1,this.writeDepth=!1,this.draped=!1,this.stippleEnabled=!1,this.stippleOffColorEnabled=!1,this.stippleScaleWithLineWidth=!1,this.stipplePreferContinuous=!0,this.roundJoins=!1,this.applyMarkerOffset=!1,this.vvSize=!1,this.vvColor=!1,this.vvOpacity=!1,this.falloffEnabled=!1,this.innerColorEnabled=!1,this.hasOccludees=!1,this.hasMultipassTerrain=!1,this.cullAboveGround=!1,this.wireframe=!1,this.objectAndLayerIdColorInstanced=!1}};d([D({count:A.COUNT})],ni.prototype,"output",void 0),d([D({count:$n.COUNT})],ni.prototype,"capType",void 0),d([D({count:We.COUNT})],ni.prototype,"transparencyPassType",void 0),d([D()],ni.prototype,"occluder",void 0),d([D()],ni.prototype,"hasSlicePlane",void 0),d([D()],ni.prototype,"hasPolygonOffset",void 0),d([D()],ni.prototype,"writeDepth",void 0),d([D()],ni.prototype,"draped",void 0),d([D()],ni.prototype,"stippleEnabled",void 0),d([D()],ni.prototype,"stippleOffColorEnabled",void 0),d([D()],ni.prototype,"stippleScaleWithLineWidth",void 0),d([D()],ni.prototype,"stipplePreferContinuous",void 0),d([D()],ni.prototype,"roundJoins",void 0),d([D()],ni.prototype,"applyMarkerOffset",void 0),d([D()],ni.prototype,"vvSize",void 0),d([D()],ni.prototype,"vvColor",void 0),d([D()],ni.prototype,"vvOpacity",void 0),d([D()],ni.prototype,"falloffEnabled",void 0),d([D()],ni.prototype,"innerColorEnabled",void 0),d([D()],ni.prototype,"hasOccludees",void 0),d([D()],ni.prototype,"hasMultipassTerrain",void 0),d([D()],ni.prototype,"cullAboveGround",void 0),d([D()],ni.prototype,"wireframe",void 0),d([D({constValue:!0})],ni.prototype,"stippleRequiresClamp",void 0),d([D({constValue:!0})],ni.prototype,"stippleRequiresStretchMeasure",void 0),d([D({constValue:!0})],ni.prototype,"hasVvInstancing",void 0),d([D({constValue:!0})],ni.prototype,"hasSliceTranslatedView",void 0),d([D()],ni.prototype,"objectAndLayerIdColorInstanced",void 0);const Hy=1;function cj(i){const e=new $t,{vertex:t,fragment:r}=e,s=i.hasMultipassTerrain&&(i.output===A.Color||i.output===A.Alpha);e.include(C3),e.include(oL,i),e.include(uL,i);const a=i.applyMarkerOffset&&!i.draped;a&&(t.uniforms.add(new ue("markerScale",m=>m.markerScale)),e.include(mL,{space:Ln.World})),i.output===A.Depth&&e.include(gh,i),e.include(AT,i),nc(t,i),t.uniforms.add([new ir("inverseProjectionMatrix",(m,f)=>f.camera.inverseProjectionMatrix),new pi("nearFar",(m,f)=>f.camera.nearFar),new ue("miterLimit",m=>m.join!=="miter"?0:m.miterLimit),new ai("viewport",(m,f)=>f.camera.fullViewport)]),t.constants.add("LARGE_HALF_FLOAT","float",65500),e.attributes.add(w.POSITION,"vec3"),e.attributes.add(w.SUBDIVISIONFACTOR,"float"),e.attributes.add(w.UV0,"vec2"),e.attributes.add(w.AUXPOS1,"vec3"),e.attributes.add(w.AUXPOS2,"vec3"),e.varyings.add("vColor","vec4"),e.varyings.add("vpos","vec3"),Gp(e),s&&e.varyings.add("depth","float");const n=i.capType===$n.ROUND,o=i.stippleEnabled&&i.stippleScaleWithLineWidth||n;o&&e.varyings.add("vLineWidth","float");const l=i.stippleEnabled&&i.stippleScaleWithLineWidth;l&&e.varyings.add("vLineSizeInv","float");const c=i.innerColorEnabled||n;c&&e.varyings.add("vLineDistance","float");const h=i.stippleEnabled&&n,u=i.falloffEnabled||h;u&&e.varyings.add("vLineDistanceNorm","float"),n&&(e.varyings.add("vSegmentSDF","float"),e.varyings.add("vReverseSegmentSDF","float")),t.code.add(_`#define PERPENDICULAR(v) vec2(v.y, -v.x);
float interp(float ncp, vec4 a, vec4 b) {
return (-ncp - a.z) / (b.z - a.z);
}
vec2 rotate(vec2 v, float a) {
float s = sin(a);
float c = cos(a);
mat2 m = mat2(c, -s, s, c);
return m * v;
}`),t.code.add(_`vec4 projectAndScale(vec4 pos) {
vec4 posNdc = proj * pos;
posNdc.xy *= viewport.zw / posNdc.w;
return posNdc;
}`),L3(e),t.code.add(_`
    void clipAndTransform(inout vec4 pos, inout vec4 prev, inout vec4 next, in bool isStartVertex) {
      float vnp = nearFar[0] * 0.99;

      if(pos.z > -nearFar[0]) {
        //current pos behind ncp --> we need to clip
        if (!isStartVertex) {
          if(prev.z < -nearFar[0]) {
            //previous in front of ncp
            pos = mix(prev, pos, interp(vnp, prev, pos));
            next = pos;
          } else {
            pos = vec4(0.0, 0.0, 0.0, 1.0);
          }
        } else {
          if(next.z < -nearFar[0]) {
            //next in front of ncp
            pos = mix(pos, next, interp(vnp, pos, next));
            prev = pos;
          } else {
            pos = vec4(0.0, 0.0, 0.0, 1.0);
          }
        }
      } else {
        //current position visible
        if (prev.z > -nearFar[0]) {
          //previous behind ncp
          prev = mix(pos, prev, interp(vnp, pos, prev));
        }
        if (next.z > -nearFar[0]) {
          //next behind ncp
          next = mix(next, pos, interp(vnp, next, pos));
        }
      }

      ${s?"depth = pos.z;":""}
      linearDepth = calculateLinearDepth(nearFar,pos.z);

      pos = projectAndScale(pos);
      next = projectAndScale(next);
      prev = projectAndScale(prev);
    }
  `),t.uniforms.add(new ue("pixelRatio",(m,f)=>f.camera.pixelRatio)),t.code.add(_`
  void main(void) {
    // unpack values from uv0.y
    bool isStartVertex = abs(abs(uv0.y)-3.0) == 1.0;

    float coverage = 1.0;

    // Check for special value of uv0.y which is used by the Renderer when graphics
    // are removed before the VBO is recompacted. If this is the case, then we just
    // project outside of clip space.
    if (uv0.y == 0.0) {
      // Project out of clip space
      gl_Position = vec4(1e038, 1e038, 1e038, 1.0);
    }
    else {
      bool isJoin = abs(uv0.y) < 3.0;

      float lineSize = getSize();
      float lineWidth = lineSize * pixelRatio;

      ${o?_`vLineWidth = lineWidth;`:""}
      ${l?_`vLineSizeInv = 1.0 / lineSize;`:""}

      // convert sub-pixel coverage to alpha
      if (lineWidth < 1.0) {
        coverage = lineWidth;
        lineWidth = 1.0;
      }else{
        // Ribbon lines cannot properly render non-integer sizes. Round width to integer size if
        // larger than one for better quality. Note that we do render < 1 pixels more or less correctly
        // so we only really care to round anything larger than 1.
        lineWidth = floor(lineWidth + 0.5);
      }

      vec4 pos  = view * vec4(position.xyz, 1.0);
      vec4 prev = view * vec4(auxpos1.xyz, 1.0);
      vec4 next = view * vec4(auxpos2.xyz, 1.0);
  `),a&&t.code.add(_`vec4 other = isStartVertex ? next : prev;
bool markersHidden = areWorldMarkersHidden(pos, other);
if(!isJoin && !markersHidden) {
pos.xyz += normalize(other.xyz - pos.xyz) * getWorldMarkerSize(pos) * 0.5;
}`),t.code.add(_`clipAndTransform(pos, prev, next, isStartVertex);
vec2 left = (pos.xy - prev.xy);
vec2 right = (next.xy - pos.xy);
float leftLen = length(left);
float rightLen = length(right);`),(i.stippleEnabled||n)&&t.code.add(_`
      float isEndVertex = float(!isStartVertex);
      vec2 segmentOrigin = mix(pos.xy, prev.xy, isEndVertex);
      vec2 segment = mix(right, left, isEndVertex);
      ${n?_`vec2 segmentEnd = mix(next.xy, pos.xy, isEndVertex);`:""}
    `),t.code.add(_`left = (leftLen > 0.001) ? left/leftLen : vec2(0.0, 0.0);
right = (rightLen > 0.001) ? right/rightLen : vec2(0.0, 0.0);
vec2 capDisplacementDir = vec2(0, 0);
vec2 joinDisplacementDir = vec2(0, 0);
float displacementLen = lineWidth;
if (isJoin) {
bool isOutside = (left.x * right.y - left.y * right.x) * uv0.y > 0.0;
joinDisplacementDir = normalize(left + right);
joinDisplacementDir = PERPENDICULAR(joinDisplacementDir);
if (leftLen > 0.001 && rightLen > 0.001) {
float nDotSeg = dot(joinDisplacementDir, left);
displacementLen /= length(nDotSeg * left - joinDisplacementDir);
if (!isOutside) {
displacementLen = min(displacementLen, min(leftLen, rightLen)/abs(nDotSeg));
}
}
if (isOutside && (displacementLen > miterLimit * lineWidth)) {`),i.roundJoins?t.code.add(_`
        vec2 startDir = leftLen < 0.001 ? right : left;
        startDir = PERPENDICULAR(startDir);

        vec2 endDir = rightLen < 0.001 ? left : right;
        endDir = PERPENDICULAR(endDir);

        float factor = ${i.stippleEnabled?_`min(1.0, subdivisionFactor * ${_.float((Hy+2)/(Hy+1))})`:_`subdivisionFactor`};

        float rotationAngle = acos(clamp(dot(startDir, endDir), -1.0, 1.0));
        joinDisplacementDir = rotate(startDir, -sign(uv0.y) * factor * rotationAngle);
      `):t.code.add(_`if (leftLen < 0.001) {
joinDisplacementDir = right;
}
else if (rightLen < 0.001) {
joinDisplacementDir = left;
}
else {
joinDisplacementDir = (isStartVertex || subdivisionFactor > 0.0) ? right : left;
}
joinDisplacementDir = PERPENDICULAR(joinDisplacementDir);`);const p=i.capType!==$n.BUTT;return t.code.add(_`
        displacementLen = lineWidth;
      }
    } else {
      // CAP handling ---------------------------------------------------
      joinDisplacementDir = isStartVertex ? right : left;
      joinDisplacementDir = PERPENDICULAR(joinDisplacementDir);

      ${p?_`capDisplacementDir = isStartVertex ? -right : left;`:""}
    }
  `),t.code.add(_`
    // Displacement (in pixels) caused by join/or cap
    vec2 dpos = joinDisplacementDir * sign(uv0.y) * displacementLen + capDisplacementDir * displacementLen;

    ${u||c?_`float lineDistNorm = sign(uv0.y) * pos.w;`:""}

    ${c?_`vLineDistance = lineWidth * lineDistNorm;`:""}
    ${u?_`vLineDistanceNorm = lineDistNorm;`:""}

    pos.xy += dpos;
  `),n&&t.code.add(_`vec2 segmentDir = normalize(segment);
vSegmentSDF = (isJoin && isStartVertex) ? LARGE_HALF_FLOAT : (dot(pos.xy - segmentOrigin, segmentDir) * pos.w) ;
vReverseSegmentSDF = (isJoin && !isStartVertex) ? LARGE_HALF_FLOAT : (dot(pos.xy - segmentEnd, -segmentDir) * pos.w);`),i.stippleEnabled&&(i.draped?t.uniforms.add(new ue("worldToScreenRatio",(m,f)=>1/f.screenToPCSRatio)):t.code.add(_`vec3 segmentCenter = mix((auxpos2 + position) * 0.5, (position + auxpos1) * 0.5, isEndVertex);
float worldToScreenRatio = computeWorldToScreenRatio(segmentCenter);`),t.code.add(_`float segmentLengthScreenDouble = length(segment);
float segmentLengthScreen = segmentLengthScreenDouble * 0.5;
float discreteWorldToScreenRatio = discretizeWorldToScreenRatio(worldToScreenRatio);
float segmentLengthRender = length(mix(auxpos2 - position, position - auxpos1, isEndVertex));
vStipplePatternStretch = worldToScreenRatio / discreteWorldToScreenRatio;`),i.draped?t.code.add(_`float segmentLengthPseudoScreen = segmentLengthScreen / pixelRatio * discreteWorldToScreenRatio / worldToScreenRatio;
float startPseudoScreen = uv0.x * discreteWorldToScreenRatio - mix(0.0, segmentLengthPseudoScreen, isEndVertex);`):t.code.add(_`float startPseudoScreen = mix(uv0.x, uv0.x - segmentLengthRender, isEndVertex) * discreteWorldToScreenRatio;
float segmentLengthPseudoScreen = segmentLengthRender * discreteWorldToScreenRatio;`),t.uniforms.add(new ue("stipplePatternPixelSize",m=>BC(m))),t.code.add(_`
      float patternLength = ${i.stippleScaleWithLineWidth?"lineSize * ":""} stipplePatternPixelSize;

      // Compute the coordinates at both start and end of the line segment, because we need both to clamp to in the fragment shader
      vStippleDistanceLimits = computeStippleDistanceLimits(startPseudoScreen, segmentLengthPseudoScreen, segmentLengthScreen, patternLength);

      vStippleDistance = mix(vStippleDistanceLimits.x, vStippleDistanceLimits.y, isEndVertex);

      // Adjust the coordinate to the displaced position (the pattern is shortened/overextended on the in/outside of joins)
      if (segmentLengthScreenDouble >= 0.001) {
        // Project the actual vertex position onto the line segment. Note that the resulting factor is within [0..1] at the
        // original vertex positions, and slightly outside of that range at the displaced positions
        vec2 stippleDisplacement = pos.xy - segmentOrigin;
        float stippleDisplacementFactor = dot(segment, stippleDisplacement) / (segmentLengthScreenDouble * segmentLengthScreenDouble);

        // Apply this offset to the actual vertex coordinate (can be screen or pseudo-screen space)
        vStippleDistance += (stippleDisplacementFactor - isEndVertex) * (vStippleDistanceLimits.y - vStippleDistanceLimits.x);
      }

      // Cancel out perspective correct interpolation because we want this length the really represent the screen distance
      vStippleDistanceLimits *= pos.w;
      vStippleDistance *= pos.w;

      // Disable stipple distance limits on caps
      vStippleDistanceLimits = isJoin ?
                                 vStippleDistanceLimits :
                                 isStartVertex ?
                                  vec2(-1e038, vStippleDistanceLimits.y) :
                                  vec2(vStippleDistanceLimits.x, 1e038);
    `)),t.code.add(_`
      // Convert back into NDC
      pos.xy = (pos.xy / viewport.zw) * pos.w;

      vColor = getColor();
      vColor.a *= coverage;

      ${i.wireframe&&!i.draped?"pos.z -= 0.001 * pos.w;":""}

      // transform final position to camera space for slicing
      vpos = (inverseProjectionMatrix * pos).xyz;
      gl_Position = pos;
      forwardObjectAndLayerIdColor();
    }
  }
  `),s&&e.include(Yl,i),e.include(Qr,i),r.include(rc),r.code.add(_`
  void main() {
    discardBySlice(vpos);
    ${s?"terrainDepthTest(gl_FragCoord, depth);":""}
  `),i.wireframe?r.code.add(_`vec4 finalColor = vec4(1.0, 0.0, 1.0, 1.0);`):(n&&r.code.add(_`
      float sdf = min(vSegmentSDF, vReverseSegmentSDF);
      vec2 fragmentPosition = vec2(
        min(sdf, 0.0),
        vLineDistance
      ) * gl_FragCoord.w;

      float fragmentRadius = length(fragmentPosition);
      float fragmentCapSDF = (fragmentRadius - vLineWidth) * 0.5; // Divide by 2 to transform from double pixel scale
      float capCoverage = clamp(0.5 - fragmentCapSDF, 0.0, 1.0);

      if (capCoverage < ${_.float(ra)}) {
        discard;
      }
    `),h?r.code.add(_`
      vec2 stipplePosition = vec2(
        min(getStippleSDF() * 2.0 - 1.0, 0.0),
        vLineDistanceNorm * gl_FragCoord.w
      );
      float stippleRadius = length(stipplePosition * vLineWidth);
      float stippleCapSDF = (stippleRadius - vLineWidth) * 0.5; // Divide by 2 to transform from double pixel scale
      float stippleCoverage = clamp(0.5 - stippleCapSDF, 0.0, 1.0);
      float stippleAlpha = step(${_.float(ra)}, stippleCoverage);
      `):r.code.add(_`float stippleAlpha = getStippleAlpha();`),r.uniforms.add(new ai("intrinsicColor",m=>m.color)),i.output!==A.ObjectAndLayerIdColor&&r.code.add(_`discardByStippleAlpha(stippleAlpha, stippleAlphaColorDiscard);`),r.code.add(_`vec4 color = intrinsicColor * vColor;`),i.innerColorEnabled&&(r.uniforms.add(new ai("innerColor",m=>je(m.innerColor,m.color))),r.uniforms.add(new ue("innerWidth",(m,f)=>m.innerWidth*f.camera.pixelRatio)),r.code.add(_`float distToInner = abs(vLineDistance * gl_FragCoord.w) - innerWidth;
float innerAA = clamp(0.5 - distToInner, 0.0, 1.0);
float innerAlpha = innerColor.a + color.a * (1.0 - innerColor.a);
color = mix(color, vec4(innerColor.rgb, innerAlpha), innerAA);`)),r.code.add(_`vec4 finalColor = blendStipple(color, stippleAlpha);`),i.falloffEnabled&&(r.uniforms.add(new ue("falloff",m=>m.falloff)),r.code.add(_`finalColor.a *= pow(max(0.0, 1.0 - abs(vLineDistanceNorm * gl_FragCoord.w)), falloff);`))),r.code.add(_`
    ${i.output===A.ObjectAndLayerIdColor?_`finalColor.a = 1.0;`:""}

    if (finalColor.a < ${_.float(ra)}) {
      discard;
    }

    ${i.output===A.Alpha?_`gl_FragColor = vec4(finalColor.a);`:""}
    ${i.output===A.Color?_`gl_FragColor = highlightSlice(finalColor, vpos);`:""}
    ${i.output===A.Color&&i.transparencyPassType===We.Color?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}
    ${i.output===A.Highlight?_`gl_FragColor = vec4(1.0);`:""}
    ${i.output===A.Depth?_`outputDepth(linearDepth);`:""}
    ${i.output===A.ObjectAndLayerIdColor?_`outputObjectAndLayerIdColor();`:""}
  }
  `),e}const hj=Object.freeze(Object.defineProperty({__proto__:null,RIBBONLINE_NUM_ROUND_JOIN_SUBDIVISIONS:Hy,build:cj},Symbol.toStringTag,{value:"Module"})),gL=new Map([[w.POSITION,0],[w.SUBDIVISIONFACTOR,1],[w.UV0,2],[w.AUXPOS1,3],[w.AUXPOS2,4],[w.COLOR,5],[w.COLORFEATUREATTRIBUTE,5],[w.SIZE,6],[w.SIZEFEATUREATTRIBUTE,6],[w.OPACITYFEATUREATTRIBUTE,7],[w.OBJECTANDLAYERIDCOLOR,8]]);let fL=class _L extends Mt{initializeProgram(e){return new Rt(e.rctx,_L.shader.get().build(this.configuration),gL)}_makePipelineState(e,t){const r=this.configuration,s=e===We.NONE,a=e===We.FrontFace;return qe({blending:r.output===A.Color||r.output===A.Alpha?s?In:Ph(e):null,depthTest:{func:Xd(e)},depthWrite:s?r.writeDepth?cn:null:bv(e),colorWrite:at,stencilWrite:r.hasOccludees?Kl:null,stencilTest:r.hasOccludees?t?Md:Wd:null,polygonOffset:s||a?r.hasPolygonOffset?xO:null:VT})}initializePipeline(){const e=this.configuration;if(e.occluder){const t=e.hasPolygonOffset?xO:null;this._occluderPipelineTransparent=qe({blending:In,polygonOffset:t,depthTest:py,depthWrite:null,colorWrite:at,stencilWrite:null,stencilTest:$3}),this._occluderPipelineOpaque=qe({blending:In,polygonOffset:t,depthTest:py,depthWrite:null,colorWrite:at,stencilWrite:N3,stencilTest:F3}),this._occluderPipelineMaskWrite=qe({blending:null,polygonOffset:t,depthTest:IT,depthWrite:null,colorWrite:null,stencilWrite:Kl,stencilTest:Md})}return this._occludeePipelineState=this._makePipelineState(this.configuration.transparencyPassType,!0),this._makePipelineState(this.configuration.transparencyPassType,!1)}get primitiveType(){return this.configuration.wireframe?Ut.LINES:Ut.TRIANGLE_STRIP}getPipelineState(e,t){return t?this._occludeePipelineState:this.configuration.occluder?e===K.TRANSPARENT_OCCLUDER_MATERIAL?this._occluderPipelineTransparent:e===K.OCCLUDER_MATERIAL?this._occluderPipelineOpaque:this._occluderPipelineMaskWrite:super.getPipelineState(e,t)}};fL.shader=new Dt(hj,()=>_e(()=>import("./RibbonLine.glsl-a6b4fdc9.js"),["assets/RibbonLine.glsl-a6b4fdc9.js","assets/objectResourceUtils-782953c3.js","assets/devEnvironmentUtils-5002a058.js","assets/calcite-8912bd40.js","assets/index-00759e4a.js","assets/index-5026a37a.css","assets/calcite-96fa36fd.css","assets/mat3f64-50f3b9f6.js","assets/mat4f64-abdda1bb.js","assets/BufferView-379a78a4.js","assets/vec33-69c9e93b.js","assets/DefaultMaterial_COLOR_GAMMA-6ed76d86.js","assets/types-e1c0a5bf.js","assets/enums-e2e92c86.js","assets/Version-aa0a1d91.js","assets/quat-7b70e9a8.js","assets/quatf64-f8f1c132.js","assets/resourceUtils-527631ac.js","assets/basicInterfaces-7449a8bf.js","assets/Indices-d8bff7b2.js","assets/NestedMap-1b5db22e.js","assets/requestImageUtils-d1ba3b36.js","assets/symbolColorUtils-c9d24716.js","assets/Util-6d3f024a.js","assets/sphere-d0e5285d.js","assets/VertexAttribute-15d1866a.js","assets/doublePrecisionUtils-e3c3d0d8.js","assets/OrderIndependentTransparency-5f7257d7.js","assets/Texture-563cf5e5.js","assets/FramebufferObject-8b18fc0c.js","assets/VertexElementDescriptor-2925c6af.js","assets/InterleavedLayout-d57c91d0.js","assets/vec3f32-01c06d8d.js","assets/floatRGBA-ca2b39ca.js","assets/plane-5e2b046c.js","assets/spatialReferenceEllipsoidUtils-afb35af9.js","assets/scaleUtils-d13015f2.js","assets/ElevationSamplerData-e3118b17.js","assets/Octree-499541ed.js","assets/edgeProcessing-20e12367.js","assets/deduplicate-769a6f51.js","assets/MeshComponent-788e605a.js","assets/earcut-61f7b102.js","assets/imageUtils-c2d0d1ae.js","assets/projection-5969b753.js","assets/ZoomMomentumEstimator-ef57e6a4.js","assets/dehydratedFeatures-3a140d03.js","assets/quantizationUtils-b3b2ae2a.js","assets/labelFormatUtils-71e1f841.js","assets/orientedBoundingBox-a14b97b5.js","assets/quatf32-51a323b8.js","assets/SnappingCandidate-970faec6.js","assets/callExpressionWithFeature-df1a8f01.js","assets/DefaultVertexAttributeLayouts-5f20d8dd.js","assets/geometryServiceUtils-a536bb19.js","assets/project-909a4219.js","assets/LercDecoder-65586d50.js","assets/VectorTile-d41a1f0f.js","assets/enums-fb086c25.js","assets/config-1337d16e.js","assets/TiledDisplayObject-419c008b.js","assets/DisplayObject-87c37b69.js","assets/rasterUtils-7694cc98.js","assets/resources-7587d8f4.js","assets/workerHelper-6131d203.js","assets/webgl-debug-7f880832.js","assets/RenderingContext-0f21aa0e.js","assets/ProgramCache-f29c900e.js","assets/Program-77209250.js","assets/MediaLayer-4c42fc2f.js","assets/MediaElementView-06baa4d4.js","assets/normalizeUtilsSync-3ea564a9.js","assets/resourceExtension-f31d9f10.js","assets/BoundsStore-00da37da.js","assets/PooledRBush-5a11bc7e.js","assets/prism-line-numbers-eff41b13.js","assets/label2-a2f37e65.js","assets/interactive-1de2e238.js","assets/loadable-6afd516d.js","assets/t9n-81df3a71.js","assets/observers-c89705b8.js","assets/icon-8e47fbec.js","assets/loader-c773e800.js","assets/guid-51402ee7.js","assets/prism-line-numbers-7c5d72ff.css"]));const xO={factor:0,units:-4};var Ca;(function(i){i[i.LEFT_JOIN_START=-2]="LEFT_JOIN_START",i[i.LEFT_JOIN_END=-1]="LEFT_JOIN_END",i[i.LEFT_CAP_START=-4]="LEFT_CAP_START",i[i.LEFT_CAP_END=-5]="LEFT_CAP_END",i[i.RIGHT_JOIN_START=2]="RIGHT_JOIN_START",i[i.RIGHT_JOIN_END=1]="RIGHT_JOIN_END",i[i.RIGHT_CAP_START=4]="RIGHT_CAP_START",i[i.RIGHT_CAP_END=5]="RIGHT_CAP_END"})(Ca||(Ca={}));let yp=class extends jd{constructor(e){super(e,new uj),this._configuration=new ni,this._vertexAttributeLocations=gL,this._layout=this.createLayout()}isClosed(e,t){return vL(this.parameters,e,t)}getConfiguration(e,t){this._configuration.output=e,this._configuration.draped=t.slot===K.DRAPED_MATERIAL;const r=g(this.parameters.stipplePattern)&&e!==A.Highlight;return this._configuration.stippleEnabled=r,this._configuration.stippleOffColorEnabled=r&&g(this.parameters.stippleOffColor),this._configuration.stippleScaleWithLineWidth=r&&this.parameters.stippleScaleWithLineWidth,this._configuration.stipplePreferContinuous=r&&this.parameters.stipplePreferContinuous,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.hasOccludees=this.parameters.hasOccludees,this._configuration.roundJoins=this.parameters.join==="round",this._configuration.capType=this.parameters.cap,this._configuration.applyMarkerOffset=!!g(this.parameters.markerParameters)&&mj(this.parameters.markerParameters),this._configuration.hasPolygonOffset=this.parameters.hasPolygonOffset,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.vvColor=this.parameters.vvColorEnabled,this._configuration.vvOpacity=this.parameters.vvOpacityEnabled,this._configuration.vvSize=this.parameters.vvSizeEnabled,this._configuration.innerColorEnabled=this.parameters.innerWidth>0&&g(this.parameters.innerColor),this._configuration.falloffEnabled=this.parameters.falloff>0,this._configuration.occluder=this.parameters.renderOccluded===qi.OccludeAndTransparentStencil,this._configuration.transparencyPassType=t.transparencyPassType,this._configuration.hasMultipassTerrain=t.multipassTerrain.enabled,this._configuration.cullAboveGround=t.multipassTerrain.cullAboveGround,this._configuration.wireframe=this.parameters.wireframe,this._configuration}intersectDraped(e,t,r,s,a,n){if(!r.options.selectionMode)return;const o=e.vertexAttributes.get(w.POSITION).data,l=e.vertexAttributes.get(w.SIZE);let c=this.parameters.width;if(this.parameters.vvSizeEnabled){const y=e.vertexAttributes.get(w.SIZEFEATUREATTRIBUTE).data[0];c*=ee(this.parameters.vvSizeOffset[0]+y*this.parameters.vvSizeFactor[0],this.parameters.vvSizeMinSize[0],this.parameters.vvSizeMaxSize[0])}else l&&(c*=l.data[0]);const h=s[0],u=s[1],p=(c/2+4)*e.screenToWorldRatio;let m=Number.MAX_VALUE,f=0;for(let y=0;y<o.length-5;y+=3){const b=o[y],x=o[y+1],S=h-b,C=u-x,O=o[y+3]-b,R=o[y+4]-x,E=ee((O*S+R*C)/(O*O+R*R),0,1),$=O*E-S,M=R*E-C,L=$*$+M*M;L<m&&(m=L,f=y/3)}m<p*p&&a(n.dist,n.normal,f,!1)}intersect(e,t,r,s,a,n){if(!r.options.selectionMode||!e.visible)return;if(!y3(t))return void Pe.getLogger("esri.views.3d.webgl-engine.materials.RibbonLineMaterial").error("intersection assumes a translation-only matrix");const o=e.vertexAttributes,l=o.get(w.POSITION).data;let c=this.parameters.width;if(this.parameters.vvSizeEnabled){const S=o.get(w.SIZEFEATUREATTRIBUTE).data[0];c*=ee(this.parameters.vvSizeOffset[0]+S*this.parameters.vvSizeFactor[0],this.parameters.vvSizeMinSize[0],this.parameters.vvSizeMaxSize[0])}else o.has(w.SIZE)&&(c*=o.get(w.SIZE).data[0]);const h=r.camera,u=gj;fs(u,r.point);const p=c*h.pixelRatio/2+4*h.pixelRatio;j(Em[0],u[0]-p,u[1]+p,0),j(Em[1],u[0]+p,u[1]+p,0),j(Em[2],u[0]+p,u[1]-p,0),j(Em[3],u[0]-p,u[1]-p,0);for(let S=0;S<4;S++)if(!h.unprojectFromRenderScreen(Em[S],Cl[S]))return;tl(h.eye,Cl[0],Cl[1],mb),tl(h.eye,Cl[1],Cl[2],gb),tl(h.eye,Cl[2],Cl[3],fb),tl(h.eye,Cl[3],Cl[0],_b);let m=Number.MAX_VALUE,f=0;const y=yL(this.parameters,o,e.indices)?l.length-2:l.length-5;for(let S=0;S<y;S+=3){Ls[0]=l[S]+t[12],Ls[1]=l[S+1]+t[13],Ls[2]=l[S+2]+t[14];const C=(S+3)%l.length;if($s[0]=l[C]+t[12],$s[1]=l[C+1]+t[13],$s[2]=l[C+2]+t[14],Ri(mb,Ls)<0&&Ri(mb,$s)<0||Ri(gb,Ls)<0&&Ri(gb,$s)<0||Ri(fb,Ls)<0&&Ri(fb,$s)<0||Ri(_b,Ls)<0&&Ri(_b,$s)<0)continue;if(h.projectToRenderScreen(Ls,zh),h.projectToRenderScreen($s,Uh),zh[2]<0&&Uh[2]>0){Q(Ao,Ls,$s);const R=h.frustum,E=-Ri(R[$i.NEAR],Ls)/J(Ao,As(R[$i.NEAR]));B(Ao,Ao,E),X(Ls,Ls,Ao),h.projectToRenderScreen(Ls,zh)}else if(zh[2]>0&&Uh[2]<0){Q(Ao,$s,Ls);const R=h.frustum,E=-Ri(R[$i.NEAR],$s)/J(Ao,As(R[$i.NEAR]));B(Ao,Ao,E),X($s,$s,Ao),h.projectToRenderScreen($s,Uh)}else if(zh[2]<0&&Uh[2]<0)continue;zh[2]=0,Uh[2]=0;const O=RT(wd(zh,Uh,CO),u);O<m&&(m=O,H(wO,Ls),H(TO,$s),f=S/3)}const b=r.rayBegin,x=r.rayEnd;if(m<p*p){let S=Number.MAX_VALUE;if(v3(wd(wO,TO,CO),wd(b,x,fj),Fh)){Q(Fh,Fh,b);const C=pe(Fh);B(Fh,Fh,1/C),S=C/yi(b,x)}n(S,Fh,f,!1)}}createLayout(){const e=mr().vec3f(w.POSITION).f32(w.SUBDIVISIONFACTOR).vec2f(w.UV0).vec3f(w.AUXPOS1).vec3f(w.AUXPOS2);return this.parameters.vvSizeEnabled?e.f32(w.SIZEFEATUREATTRIBUTE):e.f32(w.SIZE),this.parameters.vvColorEnabled?e.f32(w.COLORFEATUREATTRIBUTE):e.vec4f(w.COLOR),this.parameters.vvOpacityEnabled&&e.f32(w.OPACITYFEATUREATTRIBUTE),vi("enable-feature:objectAndLayerId-rendering")&&e.vec4u8(w.OBJECTANDLAYERIDCOLOR),e}createBufferWriter(){return new pj(this._layout,this.parameters)}requiresSlot(e,t){return t===A.Color||t===A.Alpha||t===A.Highlight||t===A.Depth||t===A.ObjectAndLayerIdColor?e===K.DRAPED_MATERIAL?!0:this.parameters.renderOccluded===qi.OccludeAndTransparentStencil?e===K.OPAQUE_MATERIAL||e===K.OCCLUDER_MATERIAL||e===K.TRANSPARENT_OCCLUDER_MATERIAL:t===A.Color||t===A.Alpha?e===(this.parameters.writeDepth?K.TRANSPARENT_MATERIAL:K.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL):e===K.OPAQUE_MATERIAL:!1}createGLMaterial(e){return new dj(e)}validateParameters(e){e.join!=="miter"&&(e.miterLimit=0),g(e.markerParameters)&&(e.markerScale=e.markerParameters.width/e.width)}},dj=class extends qd{constructor(){super(...arguments),this._stipplePattern=null}dispose(){super.dispose(),this._stippleTextureRepository.release(this._stipplePattern),this._stipplePattern=null}_updateOccludeeState(e){e.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:e.hasOccludees})}beginSlot(e){this._output!==A.Color&&this._output!==A.Alpha||this._updateOccludeeState(e);const t=this._material.parameters.stipplePattern;return this._stipplePattern!==t&&(this._material.setParameters(this._stippleTextureRepository.swap(this._stipplePattern,t)),this._stipplePattern=t),this.ensureTechnique(fL,e)}},uj=class extends LT{constructor(){super(...arguments),this.width=0,this.color=no,this.join="miter",this.cap=$n.BUTT,this.miterLimit=5,this.writeDepth=!0,this.hasPolygonOffset=!1,this.stippleTexture=null,this.stippleScaleWithLineWidth=!1,this.stipplePreferContinuous=!0,this.markerParameters=null,this.markerScale=1,this.hasSlicePlane=!1,this.vvFastUpdate=!1,this.isClosed=!1,this.falloff=0,this.innerWidth=0,this.hasOccludees=!1,this.wireframe=!1}},pj=class{constructor(e,t){this._parameters=t,this.numJoinSubdivisions=0,this.vertexBufferLayout=e;const r=t.stipplePattern?1:0;switch(this._parameters.join){case"miter":case"bevel":this.numJoinSubdivisions=r;break;case"round":this.numJoinSubdivisions=Hy+r}}_isClosed(e){return yL(this._parameters,e.vertexAttributes,e.indices)}allocate(e){return this.vertexBufferLayout.createBuffer(e)}elementCount(e){const r=e.indices.get(w.POSITION).length/2+1,s=this._isClosed(e);let a=s?2:2*2;return a+=((s?r:r-1)-(s?0:1))*(2*this.numJoinSubdivisions+4),a+=2,this._parameters.wireframe&&(a=2+4*(a-2)),a}write(e,t,r,s,a){var k;const n=_j,o=yj,l=vj,c=r.vertexAttributes.get(w.POSITION).data,h=r.indices&&r.indices.get(w.POSITION),u=(k=r.vertexAttributes.get(w.DISTANCETOSTART))==null?void 0:k.data;h&&h.length!==2*(c.length/3-1)&&console.warn("RibbonLineMaterial does not support indices");let p=1,m=0;this._parameters.vvSizeEnabled?m=r.vertexAttributes.get(w.SIZEFEATUREATTRIBUTE).data[0]:r.vertexAttributes.has(w.SIZE)&&(p=r.vertexAttributes.get(w.SIZE).data[0]);let f=[1,1,1,1],y=0;this._parameters.vvColorEnabled?y=r.vertexAttributes.get(w.COLORFEATUREATTRIBUTE).data[0]:r.vertexAttributes.has(w.COLOR)&&(f=r.vertexAttributes.get(w.COLOR).data);const b=vi("enable-feature:objectAndLayerId-rendering")?r.objectAndLayerIdColor:null;let x=0;this._parameters.vvOpacityEnabled&&(x=r.vertexAttributes.get(w.OPACITYFEATUREATTRIBUTE).data[0]);const S=c.length/3,C=new Float32Array(s.buffer),O=vi("enable-feature:objectAndLayerId-rendering")?new Uint8Array(s.buffer):null,R=this.vertexBufferLayout.stride/4;let E=a*R;const $=E;let M=0;const L=u?(I,U,V)=>M=u[V]:(I,U,V)=>M+=yi(I,U),F=vi("enable-feature:objectAndLayerId-rendering"),N=(I,U,V,z,ie,re,he)=>{if(C[E++]=U[0],C[E++]=U[1],C[E++]=U[2],C[E++]=z,C[E++]=he,C[E++]=ie,C[E++]=I[0],C[E++]=I[1],C[E++]=I[2],C[E++]=V[0],C[E++]=V[1],C[E++]=V[2],this._parameters.vvSizeEnabled?C[E++]=m:C[E++]=p,this._parameters.vvColorEnabled)C[E++]=y;else{const oe=Math.min(4*re,f.length-4);C[E++]=f[oe],C[E++]=f[oe+1],C[E++]=f[oe+2],C[E++]=f[oe+3]}this._parameters.vvOpacityEnabled&&(C[E++]=x),F&&(g(b)&&(O[4*E]=b[0],O[4*E+1]=b[1],O[4*E+2]=b[2],O[4*E+3]=b[3]),E++)};E+=R,j(o,c[0],c[1],c[2]),e&&xe(o,o,e);const G=this._isClosed(r);if(G){const I=c.length-3;j(n,c[I],c[I+1],c[I+2]),e&&xe(n,n,e)}else j(l,c[3],c[4],c[5]),e&&xe(l,l,e),N(o,o,l,1,Ca.LEFT_CAP_START,0,0),N(o,o,l,1,Ca.RIGHT_CAP_START,0,0),H(n,o),H(o,l);const q=G?0:1,se=G?S:S-1;for(let I=q;I<se;I++){const U=(I+1)%S*3;j(l,c[U],c[U+1],c[U+2]),e&&xe(l,l,e),L(n,o,I),N(n,o,l,0,Ca.LEFT_JOIN_END,I,M),N(n,o,l,0,Ca.RIGHT_JOIN_END,I,M);const V=this.numJoinSubdivisions;for(let z=0;z<V;++z){const ie=(z+1)/(V+1);N(n,o,l,ie,Ca.LEFT_JOIN_END,I,M),N(n,o,l,ie,Ca.RIGHT_JOIN_END,I,M)}N(n,o,l,1,Ca.LEFT_JOIN_START,I,M),N(n,o,l,1,Ca.RIGHT_JOIN_START,I,M),H(n,o),H(o,l)}G?(j(l,c[3],c[4],c[5]),e&&xe(l,l,e),M=L(n,o,se),N(n,o,l,0,Ca.LEFT_JOIN_END,q,M),N(n,o,l,0,Ca.RIGHT_JOIN_END,q,M)):(M=L(n,o,se),N(n,o,o,0,Ca.LEFT_CAP_END,se,M),N(n,o,o,0,Ca.RIGHT_CAP_END,se,M)),pb(C,$+R,C,$,R),E=pb(C,E-R,C,E,R),this._parameters.wireframe&&this._addWireframeVertices(s,$,E,R)}_addWireframeVertices(e,t,r,s){const a=new Float32Array(e.buffer,r*Float32Array.BYTES_PER_ELEMENT),n=new Float32Array(e.buffer,t*Float32Array.BYTES_PER_ELEMENT,r-t);let o=0;const l=c=>o=pb(n,c,a,o,s);for(let c=0;c<n.length-1;c+=2*s)l(c),l(c+2*s),l(c+1*s),l(c+2*s),l(c+1*s),l(c+3*s)}};function pb(i,e,t,r,s){for(let a=0;a<s;a++)t[r++]=i[e++];return r}function yL(i,e,t){return vL(i,e.get(w.POSITION).data,t?t.get(w.POSITION):null)}function vL(i,e,t){return!!i.isClosed&&(t?t.length>2:e.length>6)}function mj(i){return i.anchor===Fd.Tip&&i.hideOnShortSegments&&i.placement==="begin-end"&&i.worldSpace}const Ls=T(),$s=T(),Ao=T(),Fh=T(),gj=T(),zh=Zr(),Uh=Zr(),wO=T(),TO=T(),CO=em(),fj=em(),_j=T(),yj=T(),vj=T(),Em=[Zr(),Zr(),Zr(),Zr()],Cl=[T(),T(),T(),T()],mb=Ui(),gb=Ui(),fb=Ui(),_b=Ui();let kC=class{constructor(e){this._originSR=e,this._origins=new Map,this._objects=new Map,this._gridSize=5e5,this._rootOriginId="root/"+Up()}getOrigin(e){const t=this._origins.get(this._rootOriginId);if(t==null){const h=Zk.rootOrigin;if(g(h))return this._origins.set(this._rootOriginId,Lg(h[0],h[1],h[2],this._rootOriginId)),this.getOrigin(e);const u=Lg(e[0]+Math.random()-.5,e[1]+Math.random()-.5,e[2]+Math.random()-.5,this._rootOriginId);return this._origins.set(this._rootOriginId,u),u}const r=this._gridSize,s=Math.round(e[0]/r),a=Math.round(e[1]/r),n=Math.round(e[2]/r),o=`${s}/${a}/${n}`;let l=this._origins.get(o);const c=.5*r;if(Q(Mr,e,t.vec3),Mr[0]=Math.abs(Mr[0]),Mr[1]=Math.abs(Mr[1]),Mr[2]=Math.abs(Mr[2]),Mr[0]<c&&Mr[1]<c&&Mr[2]<c){if(l){const h=Math.max(...Mr);if(Q(Mr,e,l.vec3),Mr[0]=Math.abs(Mr[0]),Mr[1]=Math.abs(Mr[1]),Mr[2]=Math.abs(Mr[2]),Math.max(...Mr)<h)return l}return t}return l||(l=Lg(s*r,a*r,n*r,o),this._origins.set(o,l)),l}_drawOriginBox(e,t=hi(1,1,0,1)){const r=window.view,s=r._stage,a=t.toString();if(!this._objects.has(a)){this._material=new yp({width:2,color:t}),s.add(this._material);const m=new nL({pickable:!1}),f=new hc({castShadow:!1});s.add(f),m.add(f),s.add(m),this._objects.set(a,f)}const n=this._objects.get(a),o=[0,1,5,4,0,2,1,7,6,2,0,1,3,7,5,4,6,2,0],l=o.length,c=new Array(3*l),h=new Array,u=.5*this._gridSize;for(let m=0;m<l;m++)c[3*m+0]=e[0]+(1&o[m]?u:-u),c[3*m+1]=e[1]+(2&o[m]?u:-u),c[3*m+2]=e[2]+(4&o[m]?u:-u),m>0&&h.push(m-1,m);ha(c,this._originSR,0,c,r.renderSpatialReference,0,l);const p=new Cr(this._material,[[w.POSITION,new be(c,3,!0)]],[[w.POSITION,h]],null,ps.Line);s.add(p),n.addGeometry(p)}get test(){const e=this;return{set gridSize(t){e._gridSize=t}}}};const Mr=T();let bL=class{constructor(e,t,r,s=null){this.rctx=e,this.sliceHelper=s,this.lastFrameCamera=new Fe,this.output=A.Color,this.renderOccludedMask=SO,this.bindParameters=new Rv(t,r,g(s)?s.plane:null)}resetRenderOccludedMask(){this.renderOccludedMask=SO}},bj=class extends bL{constructor(e,t,r,s,a){super(e,r,s,a),this.offscreenRenderingHelper=t,this.sliceHelper=a,this.time=Je(0)}};const SO=qi.Occlude|qi.OccludeAndTransparent|qi.OccludeAndTransparentStencil;let cg=class extends Fe{constructor(){super(...arguments),this._projectionMatrix=ce()}get projectionMatrix(){return this._projectionMatrix}};d([v()],cg.prototype,"_projectionMatrix",void 0),d([v({readOnly:!0})],cg.prototype,"projectionMatrix",null),cg=d([Y("esri.views.3d.webgl-engine.lib.CascadeCamera")],cg);var Xp;(function(i){i[i.Highlight=0]="Highlight",i[i.Default=1]="Default"})(Xp||(Xp={}));let z_=class{constructor(){this.camera=new cg,this.lightMat=ce()}},jC=class{get depthTexture(){return this._depthTexture}get textureSize(){return this._textureSize}get numCascades(){return this._numCascades}get cascadeDistances(){return Br(this._usedCascadeDistances,this._cascadeDistances[0],this._numCascades>1?this._cascadeDistances[1]:1/0,this._numCascades>2?this._cascadeDistances[2]:1/0,this._numCascades>3?this._cascadeDistances[3]:1/0)}constructor(e,t){this._rctx=e,this._viewingMode=t,this._enabled=!1,this._snapshots=new Array,this._textureSize=0,this._numCascades=1,this._maxNumCascades=4,this._projectionView=ce(),this._projectionViewInverse=ce(),this._modelViewLight=ce(),this._splitSchemeLambda=0,this._cascadeDistances=[0,0,0,0,0],this._usedCascadeDistances=Pt(),this._cascades=[new z_,new z_,new z_,new z_],this._lastOrigin=null,this._maxTextureSize=Math.min(vi("esri-mobile")?2048:8192,this._rctx.parameters.maxTextureSize)}dispose(){this.enabled=!1,this.disposeOffscreenBuffers()}disposeOffscreenBuffers(){this._discardDepthTexture(),this._discardAllSnapshots()}set maxCascades(e){this._maxNumCascades=ee(Math.floor(e),1,4)}get maxCascades(){return this._maxNumCascades}set enabled(e){this._enabled=e,e||(this._discardDepthTexture(),this._discardAllSnapshots())}get enabled(){return this._enabled}get ready(){return this._enabled&&g(this._depthTexture)}getSnapshot(e){return this.enabled?this._snapshots[e]:null}get cascades(){for(let e=0;e<this._numCascades;++e)vb[e]=this._cascades[e];return vb.length=this._numCascades,vb}start(e,t,r){dt(this.enabled),this._textureSize=this._computeTextureSize(e.fullWidth,e.fullHeight),this._ensureDepthTexture();const{near:s,far:a}=this._clampNearFar(r);this._computeCascadeDistances(a,s),this._setupMatrices(e,t);const{viewMatrix:n,projectionMatrix:o}=e;for(let l=0;l<this._numCascades;++l)this._constructCascade(l,o,n,t);this._lastOrigin=null,this.clear()}finish(e){dt(this.enabled),this._rctx.bindFramebuffer(e)}getShadowMapMatrices(e){if(!this._lastOrigin||!An(e,this._lastOrigin)){this._lastOrigin=this._lastOrigin||T(),H(this._lastOrigin,e);for(let t=0;t<this._numCascades;++t){pl(MO,this._cascades[t].lightMat,e);for(let r=0;r<16;++r)DO[16*t+r]=MO[r]}}return DO}takeCascadeSnapshotTo(e,t){dt(this.enabled);const r=this._ensureSnapshot(t);this._bindFbo();const s=this._rctx,a=s.bindTexture(r,Ai.TEXTURE_UNIT_FOR_UPDATES);s.gl.copyTexSubImage2D(tr.TEXTURE_2D,0,e.camera.viewport[0],e.camera.viewport[1],e.camera.viewport[0],e.camera.viewport[1],e.camera.viewport[2],e.camera.viewport[3]),s.bindTexture(a,Ai.TEXTURE_UNIT_FOR_UPDATES)}clear(){const e=this._rctx;this._bindFbo(),e.setClearColor(1,1,1,1),e.clearSafe(Xi.COLOR_BUFFER_BIT|Xi.DEPTH_BUFFER_BIT)}_computeTextureSize(e,t){const r=.5*Math.log(e*e+t*t)*Math.LOG2E,s=.35,a=2**Math.round(r+s);return Math.min(this._maxTextureSize,2*a)}_ensureDepthTexture(){if(g(this._depthTexture)&&this._depthTexture.descriptor.width===this._textureSize)return;this._discardDepthTexture();const e={target:tr.TEXTURE_2D,pixelFormat:St.RGBA,dataType:Zt.UNSIGNED_BYTE,wrapMode:kt.CLAMP_TO_EDGE,samplingMode:Qt.NEAREST,flipped:!0,width:this._textureSize,height:this._textureSize};this._depthTexture=new Ai(this._rctx,e),this._fbo=new Rs(this._rctx,{colorTarget:la.TEXTURE,depthStencilTarget:La.DEPTH_RENDER_BUFFER,width:this._textureSize,height:this._textureSize},this._depthTexture)}_ensureSnapshot(e){let t=this._snapshots[e];if(g(t)&&t.descriptor.width===this._textureSize)return t;this._discardSnapshot(e);const r={target:tr.TEXTURE_2D,pixelFormat:St.RGBA,dataType:Zt.UNSIGNED_BYTE,wrapMode:kt.CLAMP_TO_EDGE,samplingMode:Qt.NEAREST,flipped:!0,width:this._textureSize,height:this._textureSize};return t=new Ai(this._rctx,r),this._snapshots[e]=t,t}_discardDepthTexture(){this._fbo=De(this._fbo),this._depthTexture=De(this._depthTexture)}_discardSnapshot(e){this._snapshots[e]=De(this._snapshots[e])}_discardAllSnapshots(){for(let e=0;e<this._snapshots.length;++e)this._discardSnapshot(e);this._snapshots.length=0}_bindFbo(){const e=this._rctx;e.unbindTexture(this._depthTexture),e.bindFramebuffer(this._fbo)}_constructCascade(e,t,r,s){const a=this._cascades[e],n=-this._cascadeDistances[e],o=-this._cascadeDistances[e+1],l=(t[10]*n+t[14])/Math.abs(t[11]*n+t[15]),c=(t[10]*o+t[14])/Math.abs(t[11]*o+t[15]);dt(l<c);for(let m=0;m<8;++m){Br(PO,m%4==0||m%4==3?-1:1,m%4==0||m%4==1?-1:1,m<4?l:c,1);const f=bn[m];Ul(f,PO,this._projectionViewInverse),f[0]/=f[3],f[1]/=f[3],f[2]/=f[3]}oa(yb,bn[0]),a.camera.viewMatrix=pl(xj,this._modelViewLight,yb);for(let m=0;m<8;++m)xe(bn[m],bn[m],a.camera.viewMatrix);let h=bn[0][2],u=bn[0][2];for(let m=1;m<8;++m)h=Math.min(h,bn[m][2]),u=Math.max(u,bn[m][2]);h-=200,u+=200,a.camera.near=-u,a.camera.far=-h,Sj(r,s,h,u,a.camera),pr(a.lightMat,a.camera.projectionMatrix,a.camera.viewMatrix);const p=this._textureSize/2;a.camera.viewport=[e%2==0?0:p,Math.floor(e/2)===0?0:p,p,p]}_setupMatrices(e,t){pr(this._projectionView,e.projectionMatrix,e.viewMatrix),$a(this._projectionViewInverse,this._projectionView);const r=this._viewingMode===ve.Global?e.eye:j(yb,0,0,1);sT(this._modelViewLight,[0,0,0],[-t[0],-t[1],-t[2]],r)}_clampNearFar(e){let{near:t,far:r}=e;return t<2&&(t=2),r<2&&(r=2),t>=r&&(t=2,r=4),{near:t,far:r}}_computeCascadeDistances(e,t){this._numCascades=Math.min(1+Math.floor(Y9(e/t,4)),this._maxNumCascades);const r=(e-t)/this._numCascades,s=(e/t)**(1/this._numCascades);let a=t,n=t;for(let o=0;o<this._numCascades+1;++o)this._cascadeDistances[o]=st(a,n,this._splitSchemeLambda),a*=s,n+=r}get gpuMemoryUsage(){var e;return this._snapshots.reduce((t,r)=>t+my(r),((e=this._fbo)==null?void 0:e.gpuMemoryUsage)??0)}get test(){const e=this;return{maxNumCascades:this._maxNumCascades,cascades:this._cascades,textureSize:this._textureSize,set splitSchemeLambda(t){e._splitSchemeLambda=t},get splitSchemeLambda(){return e._splitSchemeLambda}}}};const xj=ce(),PO=Pt(),bn=[];for(let i=0;i<8;++i)bn.push(Pt());const OO=$e(),RO=$e(),wj=$e(),EO=$e(),AO=$e(),yb=T(),vb=[],MO=ce(),DO=new Float32Array(64),Ha=$e(),Ru=$e(),Vh=[$e(),$e(),$e(),$e()],gr=$e(),bb=$e(),wc=$e(),Am=$e(),Eu=$e(),Au=$e(),U_=$e();function Tj(i,e,t,r,s,a,n,o){zt(Ha,0,0);for(let R=0;R<4;++R)qo(Ha,Ha,i[R]);On(Ha,Ha,.25),zt(Ru,0,0);for(let R=4;R<8;++R)qo(Ru,Ru,i[R]);On(Ru,Ru,.25),fm(Vh[0],i[4],i[5],.5),fm(Vh[1],i[5],i[6],.5),fm(Vh[2],i[6],i[7],.5),fm(Vh[3],i[7],i[4],.5);let l=0,c=GS(Vh[0],Ha);for(let R=1;R<4;++R){const E=GS(Vh[R],Ha);E<c&&(c=E,l=R)}kc(gr,Vh[l],i[l+4]);const h=gr[0];let u,p;gr[0]=-gr[1],gr[1]=h,kc(bb,Ru,Ha),_r(bb,gr)<0&&dN(gr,gr),fm(gr,gr,bb,t),hy(gr,gr),u=p=_r(kc(wc,i[0],Ha),gr);for(let R=1;R<8;++R){const E=_r(kc(wc,i[R],Ha),gr);E<u?u=E:E>p&&(p=E)}fs(r,Ha),On(wc,gr,u-e),qo(r,r,wc);let m=-1,f=1,y=0,b=0;for(let R=0;R<8;++R){kc(Am,i[R],r),hy(Am,Am);const E=gr[0]*Am[1]-gr[1]*Am[0];E>0?E>m&&(m=E,y=R):E<f&&(f=E,b=R)}du(m>0,"leftArea"),du(f<0,"rightArea"),On(Eu,gr,u),qo(Eu,Eu,Ha),On(Au,gr,p),qo(Au,Au,Ha),U_[0]=-gr[1],U_[1]=gr[0];const x=s_(r,i[b],Au,qo(wc,Au,U_),1,s),S=s_(r,i[y],Au,wc,1,a),C=s_(r,i[y],Eu,qo(wc,Eu,U_),1,n),O=s_(r,i[b],Eu,wc,1,o);du(x,"rayRay"),du(S,"rayRay"),du(C,"rayRay"),du(O,"rayRay")}function _t(i,e){return 3*e+i}const IO=$e();function fa(i,e){return zt(IO,i[e],i[e+3]),IO}const Ns=$e(),we=ys();function Cj(i,e,t,r,s){kc(Ns,t,r),On(Ns,Ns,.5),we[0]=Ns[0],we[1]=Ns[1],we[2]=0,we[3]=Ns[1],we[4]=-Ns[0],we[5]=0,we[6]=Ns[0]*Ns[0]+Ns[1]*Ns[1],we[7]=Ns[0]*Ns[1]-Ns[1]*Ns[0],we[8]=1,we[_t(0,2)]=-_r(fa(we,0),i),we[_t(1,2)]=-_r(fa(we,1),i);let a=_r(fa(we,0),t)+we[_t(0,2)],n=_r(fa(we,1),t)+we[_t(1,2)],o=_r(fa(we,0),r)+we[_t(0,2)],l=_r(fa(we,1),r)+we[_t(1,2)];a=-(a+o)/(n+l),we[_t(0,0)]+=we[_t(1,0)]*a,we[_t(0,1)]+=we[_t(1,1)]*a,we[_t(0,2)]+=we[_t(1,2)]*a,a=1/(_r(fa(we,0),t)+we[_t(0,2)]),n=1/(_r(fa(we,1),t)+we[_t(1,2)]),we[_t(0,0)]*=a,we[_t(0,1)]*=a,we[_t(0,2)]*=a,we[_t(1,0)]*=n,we[_t(1,1)]*=n,we[_t(1,2)]*=n,we[_t(2,0)]=we[_t(1,0)],we[_t(2,1)]=we[_t(1,1)],we[_t(2,2)]=we[_t(1,2)],we[_t(1,2)]+=1,a=_r(fa(we,1),e)+we[_t(1,2)],n=_r(fa(we,2),e)+we[_t(2,2)],o=_r(fa(we,1),t)+we[_t(1,2)],l=_r(fa(we,2),t)+we[_t(2,2)],a=-.5*(a/n+o/l),we[_t(1,0)]+=we[_t(2,0)]*a,we[_t(1,1)]+=we[_t(2,1)]*a,we[_t(1,2)]+=we[_t(2,2)]*a,a=_r(fa(we,1),e)+we[_t(1,2)],n=_r(fa(we,2),e)+we[_t(2,2)],o=-n/a,we[_t(1,0)]*=o,we[_t(1,1)]*=o,we[_t(1,2)]*=o,s[0]=we[0],s[1]=we[1],s[2]=0,s[3]=we[2],s[4]=we[3],s[5]=we[4],s[6]=0,s[7]=we[5],s[8]=0,s[9]=0,s[10]=1,s[11]=0,s[12]=we[6],s[13]=we[7],s[14]=0,s[15]=we[8]}function Sj(i,e,t,r,s){const a=1/bn[0][3],n=1/bn[4][3];dt(a<n);let o=a+Math.sqrt(a*n);const l=Math.sin(es(i[2]*e[0]+i[6]*e[1]+i[10]*e[2]));o/=l,Tj(bn,o,l,OO,RO,wj,EO,AO),Cj(OO,RO,EO,AO,s.projectionMatrix),s.projectionMatrix[10]=2/(t-r),s.projectionMatrix[14]=-(t+r)/(t-r)}function Pj(i){return So(i)&&i.intersector===ci.TERRAIN&&!!i.target}let Oj=class extends Ev{constructor(e,t,r){super(e,t),this.triangleNr=r}};function xL(i){return So(i)&&i.intersector===ci.OVERLAY&&!!i.target}let Tw=class{constructor(){this.adds=new At,this.removes=new At,this.updates=new At({allocator:e=>e||new Rj,deallocator:e=>(e.renderGeometry=null,e)})}clear(){this.adds.clear(),this.removes.clear(),this.updates.clear()}prune(){this.adds.prune(),this.removes.prune(),this.updates.prune()}get empty(){return this.adds.length===0&&this.removes.length===0&&this.updates.length===0}},Rj=class{},Ej=class{constructor(){this.adds=new Array,this.removes=new Array,this.updates=new Array}};var fi,br;(function(i){i[i.ADD=0]="ADD",i[i.UPDATE=1]="UPDATE",i[i.REMOVE=2]="REMOVE"})(fi||(fi={})),function(i){i[i.NONE=0]="NONE",i[i.VISIBILITY=1]="VISIBILITY",i[i.GEOMETRY=2]="GEOMETRY",i[i.TRANSFORMATION=4]="TRANSFORMATION",i[i.HIGHLIGHT=8]="HIGHLIGHT",i[i.OCCLUDEE=16]="OCCLUDEE"}(br||(br={}));function wL(i){const e=new Map,t=r=>{let s=e.get(r);return s||(s=new Ej,e.set(r,s)),s};return i.removes.forAll(r=>{xb(r)&&t(r.material).removes.push(r)}),i.adds.forAll(r=>{xb(r)&&t(r.material).adds.push(r)}),i.updates.forAll(r=>{xb(r.renderGeometry)&&t(r.renderGeometry.material).updates.push(r)}),e}function xb(i){return i.geometry.indexCount>=1}let Aj=class{constructor(e){this._rctx=e,this._indexBuffer=this._createIndexbuffer(),this._program=this._createProgram()}_createProgram(){const e=`
    void main(void) {
      gl_Position = vec4(0.0, 0.0, float(gl_VertexID)-2.0, 1.0);
    }`,t=`
    void main(void) {
      gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);
    }`;return this._rctx.programCache.acquire(e,t,new Map([]))}_createIndexbuffer(){return gs.createIndex(this._rctx,ca.STATIC_DRAW,new Uint32Array([0]))}resetIndicesType(){this._program.compiled&&this._indexBuffer&&(this._rctx.bindVAO(null),this._rctx.useProgram(this._program),this._rctx.bindBuffer(this._indexBuffer,a6.ELEMENT_ARRAY_BUFFER),this._rctx.drawElements(Ut.POINTS,1,Cp.UNSIGNED_INT,0))}dispose(){this._program.dispose(),this._indexBuffer.dispose()}},TL=class{constructor(e,t){this._material=e,this._repository=t,this._map=new Map}destroy(){this._map.forEach((e,t)=>{g(e)&&this._repository.release(this._material,t)})}load(e,t,r){if(!this._material.requiresSlot(t,r))return null;this._map.has(r)||this._map.set(r,this._repository.acquire(this._material,t,r));const s=this._map.get(r);if(g(s)){if(s.ensureResources(e)===M0.LOADED)return s;this._repository.requestRender()}return null}},Cw=class extends xF{constructor(e=T()){super(),this.origin=e,this.slicePlaneLocalOrigin=this.origin}};const Mj=mr().vec3f(w.POSITION),Dj=mr().vec3f(w.POSITION).vec2f(w.UV0),CL=mr().vec3f(w.POSITION).vec4u8(w.COLOR);mr().vec3f(w.POSITION).vec4u8(w.OBJECTANDLAYERIDCOLOR);mr().vec3f(w.POSITION).vec2f(w.UV0).vec4u8(w.OBJECTANDLAYERIDCOLOR);const Ij=mr().vec3f(w.POSITION).vec4u8(w.COLOR).vec4u8(w.OBJECTANDLAYERIDCOLOR);let qC=class extends jd{intersect(e,t,r,s,a,n){return wF(e,r,s,a,void 0,n)}};function Lj(i){i.fragment.code.add(_`float normals2FoamIntensity(vec3 n, float waveStrength){
float normalizationFactor =  max(0.015, waveStrength);
return max((n.x + n.y)*0.3303545/normalizationFactor + 0.3303545, 0.0);
}`)}function $j(i){i.fragment.code.add(_`vec3 foamIntensity2FoamColor(float foamIntensityExternal, float foamPixelIntensity, vec3 skyZenitColor, float dayMod){
return foamIntensityExternal * (0.075 * skyZenitColor * pow(foamPixelIntensity, 4.) +  50.* pow(foamPixelIntensity, 23.0)) * dayMod;
}`)}function LO(i){i.fragment.uniforms.add(new lt("texWaveNormal",e=>e.waveNormal)),i.fragment.uniforms.add(new lt("texWavePerturbation",e=>e.wavePertubation)),i.fragment.uniforms.add([new ai("waveParams",e=>Br(Nj,e.waveStrength,e.waveTextureRepeat,e.flowStrength,e.flowOffset)),new pi("waveDirection",e=>zt(Fj,e.waveDirection[0]*e.waveVelocity,e.waveDirection[1]*e.waveVelocity))]),i.include(Lj),i.fragment.code.add(_`const vec2  FLOW_JUMP = vec2(6.0/25.0, 5.0/24.0);
vec2 textureDenormalized2D(sampler2D _tex, vec2 _uv) {
return 2.0 * texture2D(_tex, _uv).rg - 1.0;
}
float sampleNoiseTexture(vec2 _uv) {
return texture2D(texWavePerturbation, _uv).b;
}
vec3 textureDenormalized3D(sampler2D _tex, vec2 _uv) {
return 2.0 * texture2D(_tex, _uv).rgb - 1.0;
}
float computeProgress(vec2 uv, float time) {
return fract(time);
}
float computeWeight(vec2 uv, float time) {
float progress = computeProgress(uv, time);
return 1.0 - abs(1.0 - 2.0 * progress);
}
vec3 computeUVPerturbedWeigth(sampler2D texFlow, vec2 uv, float time, float phaseOffset) {
float flowStrength = waveParams[2];
float flowOffset = waveParams[3];
vec2 flowVector = textureDenormalized2D(texFlow, uv) * flowStrength;
float progress = computeProgress(uv, time + phaseOffset);
float weight = computeWeight(uv, time + phaseOffset);
vec2 result = uv;
result -= flowVector * (progress + flowOffset);
result += phaseOffset;
result += (time - progress) * FLOW_JUMP;
return vec3(result, weight);
}
const float TIME_NOISE_TEXTURE_REPEAT = 0.3737;
const float TIME_NOISE_STRENGTH = 7.77;
vec3 getWaveLayer(sampler2D _texNormal, sampler2D _dudv, vec2 _uv, vec2 _waveDir, float time) {
float waveStrength = waveParams[0];
vec2 waveMovement = time * -_waveDir;
float timeNoise = sampleNoiseTexture(_uv * TIME_NOISE_TEXTURE_REPEAT) * TIME_NOISE_STRENGTH;
vec3 uv_A = computeUVPerturbedWeigth(_dudv, _uv + waveMovement, time + timeNoise, 0.0);
vec3 uv_B = computeUVPerturbedWeigth(_dudv, _uv + waveMovement, time + timeNoise, 0.5);
vec3 normal_A = textureDenormalized3D(_texNormal, uv_A.xy) * uv_A.z;
vec3 normal_B = textureDenormalized3D(_texNormal, uv_B.xy) * uv_B.z;
vec3 mixNormal = normalize(normal_A + normal_B);
mixNormal.xy *= waveStrength;
mixNormal.z = sqrt(1.0 - dot(mixNormal.xy, mixNormal.xy));
return mixNormal;
}
vec4 getSurfaceNormalAndFoam(vec2 _uv, float _time) {
float waveTextureRepeat = waveParams[1];
vec3 normal = getWaveLayer(texWaveNormal, texWavePerturbation, _uv * waveTextureRepeat, waveDirection, _time);
float foam  = normals2FoamIntensity(normal, waveParams[0]);
return vec4(normal, foam);
}`)}const Nj=Pt(),Fj=$e();function Sf(i,e){e.spherical?i.vertex.code.add(_`vec3 getLocalUp(in vec3 pos, in vec3 origin) {
return normalize(pos + origin);
}`):i.vertex.code.add(_`vec3 getLocalUp(in vec3 pos, in vec3 origin) {
return vec3(0.0, 0.0, 1.0);
}`),e.spherical?i.vertex.code.add(_`mat3 getTBNMatrix(in vec3 n) {
vec3 t = normalize(cross(vec3(0.0, 0.0, 1.0), n));
vec3 b = normalize(cross(n, t));
return mat3(t, b, n);
}`):i.vertex.code.add(_`mat3 getTBNMatrix(in vec3 n) {
vec3 t = vec3(1.0, 0.0, 0.0);
vec3 b = normalize(cross(n, t));
return mat3(t, b, n);
}`)}function SL(i,e){i.include(TF,e),i.include(Ov),i.include($j),e.hasCloudsReflections&&i.include(zM,e),e.hasScreenSpaceReflections&&i.include(Uz,e);const t=i.fragment;t.constants.add("fresnelSky","vec3",[.02,1,15]).add("fresnelMaterial","vec2",[.02,.1]).add("roughness","float",.015).add("foamIntensityExternal","float",1.7).add("ssrIntensity","float",.65).add("ssrHeightFadeStart","float",3e5).add("ssrHeightFadeEnd","float",5e5).add("waterDiffusion","float",.92).add("waterSeaColorMod","float",.8).add("correctionViewingPowerFactor","float",.4).add("skyZenitColor","vec3",[.52,.68,.9]).add("skyColor","vec3",[.67,.79,.9]).add("cloudFresnelModifier","vec2",[1.2,.01]),t.code.add(_`PBRShadingWater shadingInfo;
vec3 getSkyGradientColor(in float cosTheta, in vec3 horizon, in vec3 zenit) {
float exponent = pow((1.0 - cosTheta), fresnelSky[2]);
return mix(zenit, horizon, exponent);
}`),t.uniforms.add([new ue("lightingSpecularStrength",(r,s)=>s.lighting.mainLight.specularStrength),new ue("lightingEnvironmentStrength",(r,s)=>s.lighting.mainLight.environmentStrength)]),t.code.add(_`vec3 getSeaColor(in vec3 n, in vec3 v, in vec3 l, vec3 color, in vec3 lightIntensity, in vec3 localUp, in float shadow, float foamIntensity, vec3 viewPosition, vec3 position) {
float reflectionHit = 0.0;
float reflectionHitDiffused = 0.0;
vec3 seaWaterColor = linearizeGamma(color);
vec3 h = normalize(l + v);
shadingInfo.NdotL = clamp(dot(n, l), 0.0, 1.0);
shadingInfo.NdotV = clamp(dot(n, v), 0.001, 1.0);
shadingInfo.VdotN = clamp(dot(v, n), 0.001, 1.0);
shadingInfo.NdotH = clamp(dot(n, h), 0.0, 1.0);
shadingInfo.VdotH = clamp(dot(v, h), 0.0, 1.0);
shadingInfo.LdotH = clamp(dot(l, h), 0.0, 1.0);
float upDotV = max(dot(localUp,v), 0.0);
vec3 skyHorizon = linearizeGamma(skyColor);
vec3 skyZenit = linearizeGamma(skyZenitColor);
vec3 skyColor = getSkyGradientColor(upDotV, skyHorizon, skyZenit );
float upDotL = max(dot(localUp,l),0.0);
float daytimeMod = 0.1 + upDotL * 0.9;
skyColor *= daytimeMod;
float shadowModifier = clamp(shadow, 0.8, 1.0);
vec3 fresnelModifier = fresnelReflection(shadingInfo.VdotN, vec3(fresnelSky[0]), fresnelSky[1]);
vec3 reflSky = lightingEnvironmentStrength * fresnelModifier * skyColor * shadowModifier;
vec3 reflSea = seaWaterColor * mix(skyColor, upDotL * lightIntensity * LIGHT_NORMALIZATION, 2.0 / 3.0) * shadowModifier;
vec3 specular = vec3(0.0);
if(upDotV > 0.0 && upDotL > 0.0) {
vec3 specularSun = brdfSpecularWater(shadingInfo, roughness, vec3(fresnelMaterial[0]), fresnelMaterial[1]);
vec3 incidentLight = lightIntensity * LIGHT_NORMALIZATION * shadow;
specular = lightingSpecularStrength * shadingInfo.NdotL * incidentLight * specularSun;
}
vec3 foam = vec3(0.0);
if(upDotV > 0.0) {
foam = foamIntensity2FoamColor(foamIntensityExternal, foamIntensity, skyZenitColor, daytimeMod);
}
float correctionViewingFactor = pow(max(dot(v, localUp), 0.0), correctionViewingPowerFactor);
vec3 normalCorrectedClouds = mix(localUp, n, correctionViewingFactor);
vec3 reflectedWorld = normalize(reflect(-v, normalCorrectedClouds));`),e.hasCloudsReflections&&t.code.add(_`vec4 cloudsColor = renderClouds(reflectedWorld, position);
cloudsColor.a = 1.0 - cloudsColor.a;
cloudsColor = pow(cloudsColor, vec4(GAMMA));
cloudsColor *= clamp(fresnelModifier.y*cloudFresnelModifier[0] - cloudFresnelModifier[1], 0.0, 1.0) * clamp((1.0 - totalFadeInOut), 0.0, 1.0);`),e.hasScreenSpaceReflections?(t.uniforms.add([new ir("view",(r,s)=>s.ssr.camera.viewMatrix),new lt("lastFrameColorTexture",(r,s)=>s.ssr.lastFrameColorTexture),new ue("fadeFactor",(r,s)=>s.ssr.fadeFactor)]),t.code.add(_`vec3 viewDir = normalize(viewPosition);
vec4 viewNormalVectorCoordinate = view *vec4(n, 0.0);
vec3 viewNormal = normalize(viewNormalVectorCoordinate.xyz);
vec4 viewUp = view * vec4(localUp, 0.0);
vec3 viewNormalCorrectedSSR = mix(viewUp.xyz, viewNormal, correctionViewingFactor);
vec3 reflected = normalize(reflect(viewDir, viewNormalCorrectedSSR));
vec3 hitCoordinate = screenSpaceIntersection(reflected, viewPosition, viewDir, viewUp.xyz);
vec3 reflectedColor = vec3(0.0);
if (hitCoordinate.z > 0.0)
{
vec2 reprojectedCoordinate = reprojectionCoordinate(hitCoordinate);
vec2 dCoords = smoothstep(0.3, 0.6, abs(vec2(0.5, 0.5) - hitCoordinate.xy));
float heightMod = smoothstep(ssrHeightFadeEnd, ssrHeightFadeStart, -viewPosition.z);
reflectionHit = clamp(1.0 - (1.3 * dCoords.y), 0.0, 1.0) * heightMod * fadeFactor;
reflectionHitDiffused = waterDiffusion * reflectionHit;
reflectedColor = linearizeGamma(texture2D(lastFrameColorTexture, reprojectedCoordinate).xyz) *
reflectionHitDiffused * fresnelModifier.y * ssrIntensity;
}
float seaColorMod =  mix(waterSeaColorMod, waterSeaColorMod * 0.5, reflectionHitDiffused);
vec3 waterRenderedColor = tonemapACES((1.0 - reflectionHitDiffused) * reflSky + reflectedColor +
reflSea * seaColorMod + specular + foam);`)):t.code.add(_`vec3 waterRenderedColor = tonemapACES(reflSky + reflSea * waterSeaColorMod + specular + foam);`),e.hasCloudsReflections?e.hasScreenSpaceReflections?t.code.add(_`return waterRenderedColor * (1.0 - (1.0 - reflectionHit) * cloudsColor.a) + (1.0 - reflectionHit) * cloudsColor.xyz;
}`):t.code.add(_`return waterRenderedColor * (1.0 - cloudsColor.a) + cloudsColor.xyz;
}`):t.code.add(_`return waterRenderedColor;
}`)}function zj(i){const e=new $t,{vertex:t,fragment:r}=e;nc(t,i),e.include(il,i),e.attributes.add(w.POSITION,"vec3"),e.attributes.add(w.UV0,"vec2");const s=new ai("waterColor",a=>a.color);if(i.output===A.Color&&i.isDraped)return e.varyings.add("vpos","vec3"),t.uniforms.add(s),t.code.add(_`
        void main(void) {
          if (waterColor.a < ${_.float(ra)}) {
            // Discard this vertex
            gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
            return;
          }

          vpos = position;
          gl_Position = transformPosition(proj, view, vpos);
        }
    `),r.uniforms.add(s),r.code.add(_`void main() {
gl_FragColor = waterColor;
}`),e;switch(i.output!==A.Color&&i.output!==A.Alpha||(e.include(Sf,i),e.include(yv,i),e.varyings.add("vuv","vec2"),e.varyings.add("vpos","vec3"),e.varyings.add("vnormal","vec3"),e.varyings.add("vtbnMatrix","mat3"),i.hasMultipassTerrain&&e.varyings.add("depth","float"),t.uniforms.add(s),t.code.add(_`
      void main(void) {
        if (waterColor.a < ${_.float(ra)}) {
          // Discard this vertex
          gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
          return;
        }

        vuv = uv0;
        vpos = position;

        vnormal = getLocalUp(vpos, localOrigin);
        vtbnMatrix = getTBNMatrix(vnormal);

        ${i.hasMultipassTerrain?"depth = (view * vec4(vpos, 1.0)).z;":""}

        gl_Position = transformPosition(proj, view, vpos);
        ${i.output===A.Color?"forwardLinearDepth();":""}
      }
    `)),e.include(Yl,i),i.output){case A.Alpha:e.include(Qr,i),r.uniforms.add(s),r.code.add(_`
        void main() {
          discardBySlice(vpos);
          ${i.hasMultipassTerrain?"terrainDepthTest(gl_FragCoord, depth);":""}

          gl_FragColor = vec4(waterColor.a);
        }
      `);break;case A.Color:e.include(S3,i),e.include(T3,{pbrMode:Wt.Disabled,lightingSphericalHarmonicsOrder:2}),e.include(LO),e.include(Qr,i),e.include(Yg,i),e.include(SL,i),r.uniforms.add([s,new ue("timeElapsed",a=>a.timeElapsed),t.uniforms.get("view"),t.uniforms.get("localOrigin")]),rm(r,i),r.include(rc),tm(r),im(r),r.code.add(_`
      void main() {
        discardBySlice(vpos);
        ${i.hasMultipassTerrain?"terrainDepthTest(gl_FragCoord, depth);":""}
        vec3 localUp = vnormal;
        // the created normal is in tangent space
        vec4 tangentNormalFoam = getSurfaceNormalAndFoam(vuv, timeElapsed);

        // we rotate the normal according to the tangent-bitangent-normal-Matrix
        vec3 n = normalize(vtbnMatrix * tangentNormalFoam.xyz);
        vec3 v = -normalize(vpos - cameraPosition);
        float shadow = ${i.receiveShadows?_`1.0 - readShadowMap(vpos, linearDepth)`:"1.0"};
        vec4 vPosView = view * vec4(vpos, 1.0);
        vec4 final = vec4(getSeaColor(n, v, mainLightDirection, waterColor.rgb, mainLightIntensity, localUp, shadow, tangentNormalFoam.w, vPosView.xyz, vpos + localOrigin), waterColor.w);

        // gamma correction
        gl_FragColor = delinearizeGamma(final);
        gl_FragColor = highlightSlice(gl_FragColor, vpos);
        ${i.transparencyPassType===We.Color?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}
      }
    `);break;case A.Normal:e.include(Sf,i),e.include(LO,i),e.include(Qr,i),e.varyings.add("vpos","vec3"),e.varyings.add("vuv","vec2"),t.uniforms.add(s),t.code.add(_`
        void main(void) {
          if (waterColor.a < ${_.float(ra)}) {
            // Discard this vertex
            gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
            return;
          }

          vuv = uv0;
          vpos = position;

          gl_Position = transformPosition(proj, view, vpos);
        }
    `),r.uniforms.add(new ue("timeElapsed",a=>a.timeElapsed)),r.code.add(_`void main() {
discardBySlice(vpos);
vec4 tangentNormalFoam = getSurfaceNormalAndFoam(vuv, timeElapsed);
tangentNormalFoam.xyz = normalize(tangentNormalFoam.xyz);
gl_FragColor = vec4((tangentNormalFoam.xyz + vec3(1.0)) * 0.5, tangentNormalFoam.w);
}`);break;case A.Highlight:e.include(Sh,i),e.varyings.add("vpos","vec3"),t.uniforms.add(s),t.code.add(_`
      void main(void) {
        if (waterColor.a < ${_.float(ra)}) {
          // Discard this vertex
          gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
          return;
        }

        vpos = position;
        gl_Position = transformPosition(proj, view, vpos);
      }
    `),e.include(Qr,i),r.code.add(_`void main() {
discardBySlice(vpos);
outputHighlight();
}`)}return e}const Uj=Object.freeze(Object.defineProperty({__proto__:null,build:zj},Symbol.toStringTag,{value:"Module"}));let PL=class OL extends Mt{initializeConfiguration(e,t){t.hasWebGL2Context=e.rctx.type===da.WEBGL2,t.spherical=e.viewingMode===ve.Global,t.doublePrecisionRequiresObfuscation=e.rctx.driverTest.doublePrecisionRequiresObfuscation.result}initializeProgram(e){return new Rt(e.rctx,OL.shader.get().build(this.configuration),Lt)}_setPipelineState(e){const t=this.configuration,r=e===We.NONE,s=e===We.FrontFace;return qe({blending:t.output!==A.Normal&&t.output!==A.Highlight&&t.transparent?r?In:Ph(e):null,depthTest:{func:Xd(e)},depthWrite:r?t.writeDepth?cn:null:bv(e),colorWrite:at,polygonOffset:r||s?null:GT(t.enableOffset)})}initializePipeline(){return this._setPipelineState(this.configuration.transparencyPassType)}};PL.shader=new Dt(Uj,()=>_e(()=>import("./WaterSurface.glsl-cb1edd11.js"),["assets/WaterSurface.glsl-cb1edd11.js","assets/objectResourceUtils-782953c3.js","assets/devEnvironmentUtils-5002a058.js","assets/calcite-8912bd40.js","assets/index-00759e4a.js","assets/index-5026a37a.css","assets/calcite-96fa36fd.css","assets/mat3f64-50f3b9f6.js","assets/mat4f64-abdda1bb.js","assets/BufferView-379a78a4.js","assets/vec33-69c9e93b.js","assets/DefaultMaterial_COLOR_GAMMA-6ed76d86.js","assets/types-e1c0a5bf.js","assets/enums-e2e92c86.js","assets/Version-aa0a1d91.js","assets/quat-7b70e9a8.js","assets/quatf64-f8f1c132.js","assets/resourceUtils-527631ac.js","assets/basicInterfaces-7449a8bf.js","assets/Indices-d8bff7b2.js","assets/NestedMap-1b5db22e.js","assets/requestImageUtils-d1ba3b36.js","assets/symbolColorUtils-c9d24716.js","assets/Util-6d3f024a.js","assets/sphere-d0e5285d.js","assets/VertexAttribute-15d1866a.js","assets/doublePrecisionUtils-e3c3d0d8.js","assets/OrderIndependentTransparency-5f7257d7.js","assets/Texture-563cf5e5.js","assets/FramebufferObject-8b18fc0c.js","assets/VertexElementDescriptor-2925c6af.js","assets/InterleavedLayout-d57c91d0.js","assets/vec3f32-01c06d8d.js","assets/plane-5e2b046c.js","assets/spatialReferenceEllipsoidUtils-afb35af9.js","assets/scaleUtils-d13015f2.js","assets/ElevationSamplerData-e3118b17.js","assets/Octree-499541ed.js","assets/edgeProcessing-20e12367.js","assets/deduplicate-769a6f51.js","assets/MeshComponent-788e605a.js","assets/earcut-61f7b102.js","assets/imageUtils-c2d0d1ae.js","assets/projection-5969b753.js","assets/ZoomMomentumEstimator-ef57e6a4.js","assets/floatRGBA-ca2b39ca.js","assets/dehydratedFeatures-3a140d03.js","assets/quantizationUtils-b3b2ae2a.js","assets/labelFormatUtils-71e1f841.js","assets/orientedBoundingBox-a14b97b5.js","assets/quatf32-51a323b8.js","assets/SnappingCandidate-970faec6.js","assets/callExpressionWithFeature-df1a8f01.js","assets/DefaultVertexAttributeLayouts-5f20d8dd.js","assets/geometryServiceUtils-a536bb19.js","assets/project-909a4219.js","assets/LercDecoder-65586d50.js","assets/VectorTile-d41a1f0f.js","assets/enums-fb086c25.js","assets/config-1337d16e.js","assets/TiledDisplayObject-419c008b.js","assets/DisplayObject-87c37b69.js","assets/rasterUtils-7694cc98.js","assets/resources-7587d8f4.js","assets/workerHelper-6131d203.js","assets/webgl-debug-7f880832.js","assets/RenderingContext-0f21aa0e.js","assets/ProgramCache-f29c900e.js","assets/Program-77209250.js","assets/MediaLayer-4c42fc2f.js","assets/MediaElementView-06baa4d4.js","assets/normalizeUtilsSync-3ea564a9.js","assets/resourceExtension-f31d9f10.js","assets/BoundsStore-00da37da.js","assets/PooledRBush-5a11bc7e.js","assets/prism-line-numbers-eff41b13.js","assets/label2-a2f37e65.js","assets/interactive-1de2e238.js","assets/loadable-6afd516d.js","assets/t9n-81df3a71.js","assets/observers-c89705b8.js","assets/icon-8e47fbec.js","assets/loader-c773e800.js","assets/guid-51402ee7.js","assets/prism-line-numbers-7c5d72ff.css"]));let Lr=class extends Vn{constructor(){super(...arguments),this.output=A.Color,this.transparencyPassType=We.NONE,this.spherical=!1,this.receiveShadows=!1,this.hasSlicePlane=!1,this.transparent=!1,this.enableOffset=!0,this.writeDepth=!1,this.hasScreenSpaceReflections=!1,this.doublePrecisionRequiresObfuscation=!1,this.hasCloudsReflections=!1,this.isDraped=!1,this.hasMultipassTerrain=!1,this.cullAboveGround=!1}};d([D({count:A.COUNT})],Lr.prototype,"output",void 0),d([D({count:We.COUNT})],Lr.prototype,"transparencyPassType",void 0),d([D()],Lr.prototype,"spherical",void 0),d([D()],Lr.prototype,"receiveShadows",void 0),d([D()],Lr.prototype,"hasSlicePlane",void 0),d([D()],Lr.prototype,"transparent",void 0),d([D()],Lr.prototype,"enableOffset",void 0),d([D()],Lr.prototype,"writeDepth",void 0),d([D()],Lr.prototype,"hasScreenSpaceReflections",void 0),d([D()],Lr.prototype,"doublePrecisionRequiresObfuscation",void 0),d([D()],Lr.prototype,"hasCloudsReflections",void 0),d([D()],Lr.prototype,"isDraped",void 0),d([D()],Lr.prototype,"hasMultipassTerrain",void 0),d([D()],Lr.prototype,"cullAboveGround",void 0),d([D({constValue:Wt.Water})],Lr.prototype,"pbrMode",void 0),d([D({constValue:!0})],Lr.prototype,"useCustomDTRExponentForWater",void 0),d([D({constValue:!0})],Lr.prototype,"highStepCount",void 0),d([D({constValue:!1})],Lr.prototype,"useFillLights",void 0);let Vj=class extends qd{_updateShadowState(e){e.shadowMap.enabled!==this._material.parameters.receiveShadows&&this._material.setParameters({receiveShadows:e.shadowMap.enabled})}_updateSSRState(e){e.ssr.enabled!==this._material.parameters.hasScreenSpaceReflections&&this._material.setParameters({hasScreenSpaceReflections:e.ssr.enabled})}_updateCloudsReflectionState(e){const t=g(e.cloudsFade.data);t!==this._material.parameters.hasCloudsReflections&&this._material.setParameters({hasCloudsReflections:t})}ensureResources(e){return this._techniqueRepository.constructionContext.waterTextureRepository.ensureResources(e)}beginSlot(e){return this._output===A.Color&&(this._updateShadowState(e),this._updateSSRState(e),this._updateCloudsReflectionState(e)),this._material.setParameters(this._techniqueRepository.constructionContext.waterTextureRepository.passParameters),this.ensureTechnique(PL,e)}},RL=class extends qC{constructor(e){super(e,new EL),this._configuration=new Lr,this.animation=new P3}getConfiguration(e,t){return this._configuration.output=e,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.receiveShadows=this.parameters.receiveShadows,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.transparent=this.parameters.transparent,this._configuration.hasScreenSpaceReflections=this.parameters.hasScreenSpaceReflections,this._configuration.hasCloudsReflections=this.parameters.hasCloudsReflections,this._configuration.isDraped=this.parameters.isDraped,this._configuration.transparencyPassType=t.transparencyPassType,this._configuration.enableOffset=t.camera.relativeElevation<BT,this._configuration.hasMultipassTerrain=t.multipassTerrain.enabled,this._configuration.cullAboveGround=t.multipassTerrain.cullAboveGround,this._configuration}update(e){const t=Math.min(e.camera.relativeElevation,e.camera.distance);this.animation.enabled=Math.sqrt(this.parameters.waveTextureRepeat/this.parameters.waveStrength)*t<Gj;const r=this.animation.advance(e);return this.setParameters({timeElapsed:aT(this.animation.time)*this.parameters.animationSpeed},!1),this.animation.enabled&&r}requiresSlot(e,t){switch(t){case A.Normal:return e===K.DRAPED_WATER;case A.Color:if(this.parameters.isDraped)return e===K.DRAPED_MATERIAL;break;case A.Alpha:break;case A.Highlight:return e===K.OPAQUE_MATERIAL||e===K.DRAPED_MATERIAL;default:return!1}let r=K.OPAQUE_MATERIAL;return this.parameters.transparent&&(r=this.parameters.writeDepth?K.TRANSPARENT_MATERIAL:K.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL),e===r}createGLMaterial(e){return new Vj(e)}createBufferWriter(){return new kf(Dj)}},EL=class extends Hf{constructor(){super(...arguments),this.waveStrength=.06,this.waveTextureRepeat=32,this.waveDirection=It(1,0),this.waveVelocity=.05,this.flowStrength=.015,this.flowOffset=-.5,this.animationSpeed=.35,this.timeElapsed=0,this.color=hi(0,0,0,0),this.transparent=!0,this.writeDepth=!0,this.hasSlicePlane=!1,this.isDraped=!1,this.receiveShadows=!0,this.hasScreenSpaceReflections=!1,this.hasCloudsReflections=!1}};const Gj=35e3;let WC=class{constructor(e=0,t=0){this.from=e,this.to=t}get numElements(){return this.to-this.from}};function $O(i){const e=new Map;i.forAll(r=>e.set(r.from,r));let t=!0;for(;t;)t=!1,i.forEach(r=>{const s=e.get(r.to);s&&(r.to=s.to,e.delete(s.from),i.removeUnordered(s),t=!0)})}let NO=class extends WC{constructor(e,t,r){super(t,r),this.geometry=e}get isVisible(){return this.geometry.visible}get hasHighlights(){return g(this.geometry.highlights)&&this.isVisible}get hasOccludees(){return g(this.geometry.occludees)}},Bj=class{constructor(){this.first=0,this.count=0}},Hj=class{constructor(){this._numElements=0,this._instances=new Map,this.holes=new At({allocator:e=>e||new WC,deallocator:null}),this.hasHiddenInstances=!1,this.hasHighlights=!1,this.hasOccludees=!1,this.drawCommandsDirty=!0,this.drawCommandsDefault=V_(),this.drawCommandsHighlight=V_(),this.drawCommandsOccludees=V_(),this.drawCommandsShadowHighlightRest=V_()}get numElements(){return this._numElements}get instances(){return this._instances}addInstance(e,t){this.deleteInstance(e),this._instances.set(e,t),this._numElements+=t.numElements}deleteInstance(e){const t=this._instances.get(e);t&&(this._numElements-=t.numElements,this._instances.delete(e))}updateInstance(e,t,r){const s=this._instances.get(e);s&&(this._numElements-=s.numElements,s.from=t,s.to=r,this._numElements+=s.numElements)}updateDrawState(e){e.isVisible?(e.hasHighlights&&(this.hasHighlights=!0),e.hasOccludees&&(this.hasOccludees=!0)):this.hasHiddenInstances=!0}updateDrawCommands(e){if(this.drawCommandsDefault.clear(),this.drawCommandsHighlight.clear(),this.drawCommandsOccludees.clear(),this.drawCommandsShadowHighlightRest.clear(),this.drawCommandsDirty=!1,this._instances.size===0)return;if(!this.needsMultipleCommands()){const r=this.drawCommandsDefault.pushNew(),s=this.holes.front();return g(this.vao)&&this.holes.length===1&&s.to===Math.floor(this.vao.size/e)?(r.first=0,void(r.count=s.from)):(r.first=1/0,r.count=0,this._instances.forEach(a=>{r.first=Math.min(r.first,a.from),r.count=Math.max(r.count,a.to)}),void(r.count-=r.first))}const t=Array.from(this._instances.values()).sort((r,s)=>r.from===s.from?r.to-s.to:r.from-s.from);for(const r of t)r.isVisible&&(FO(r.hasOccludees?this.drawCommandsOccludees:this.drawCommandsDefault,r),FO(r.hasHighlights?this.drawCommandsHighlight:this.drawCommandsShadowHighlightRest,r))}needsMultipleCommands(){return this.hasOccludees||this.hasHighlights||this.hasHiddenInstances}};function kj(i){return g(i.vao)}function V_(){return new At({allocator:i=>i||new Bj,deallocator:i=>i})}function FO(i,e){const t=i.back();if(t==null){const r=i.pushNew();return r.first=e.from,void(r.count=e.numElements)}if(jj(t,e)){const r=e.from-t.first+e.numElements;t.count=r}else{const r=i.pushNew();r.first=e.from,r.count=e.numElements}}function jj(i,e){return i.first+i.count>=e.from}let qj=class{constructor(e){this.origin=e,this.buffers=new Array}dispose(){this.buffers.forEach(e=>e.vao.dispose()),this.buffers.length=0}findBuffer(e){return this.buffers.find(t=>t.instances.has(e))}};const Wj=pN+1;let Xj=class{constructor(e,t,r){this._rctx=e,this._locations=t,this._layout=r,this._cache=e.newCache(`VaoCache ${Up()}`,Qj)}dispose(){this._cache.destroy()}newVao(e){const t=e.toString(),r=this._cache.pop(t);if(g(r)){const a=r.pop();return r.length>0&&this._cache.put(t,r,e*r.length,Wj),a}const s=new ac(this._rctx,this._locations,{geometry:this._layout},{geometry:gs.createVertex(this._rctx,ca.STATIC_DRAW)});return s.vertexBuffers.geometry.setSize(e),s}deleteVao(e){if(P(e))return null;const t=e.size,r=t.toString(),s=this._cache.pop(r);return g(s)?(s.push(e),this._cache.put(r,s,t*s.length,-1)):this._cache.put(r,[e],t,-1),null}};function Qj(i,e){if(e===uN.ALL)return void i.forEach(s=>s.dispose());const t=i.pop(),r=i.length*t.size;return t.dispose(),r}let AL=class{constructor(e,t,r){this._rctx=e,this._materialRepository=t,this.material=r,this._dataByOrigin=new Map,this._appleAmdDriverHelper=null,this._hasHighlights=!1,this._hasOccludees=!1,this._glMaterials=new TL(this.material,this._materialRepository),this._bufferWriter=r.createBufferWriter(),this._vaoCache=new Xj(e,r.vertexAttributeLocations,Co(this._bufferWriter.vertexBufferLayout)),this._rctx.driverTest.drawArraysRequiresIndicesTypeReset.result&&(this._appleAmdDriverHelper=new Aj(this._rctx))}dispose(){var e;this._glMaterials.destroy(),this._dataByOrigin.forEach(t=>t.dispose()),this._dataByOrigin.clear(),this._vaoCache.dispose(),(e=this._appleAmdDriverHelper)==null||e.dispose()}get isEmpty(){return this._dataByOrigin.size===0}get hasHighlights(){return this._hasHighlights}get hasOccludees(){return this._hasOccludees}get hasWater(){return!this.isEmpty&&this.material instanceof RL}get rendersOccluded(){return!this.isEmpty&&this.material.renderOccluded!==qi.Occlude}get numGeometries(){let e=0;return this._dataByOrigin.forEach(t=>e+=t.buffers.reduce((r,s)=>r+s.instances.size,0)),e}forEachGeometry(e){this._dataByOrigin.forEach(t=>t.buffers.forEach(r=>r.instances.forEach(s=>e(s.geometry))))}modify(e){this._updateGeometries(e.updates),this._addAndRemoveGeometries(e.adds,e.removes),this._updateDrawCommands()}_updateGeometries(e){var s;const t=this._bufferWriter,r=t.vertexBufferLayout.stride/4;for(const a of e){const n=a.renderGeometry,o=(s=this._dataByOrigin.get(n.localOrigin.id))==null?void 0:s.findBuffer(n.id);if(P(o))return;const l=o.instances.get(n.id);if(a.updateType&(br.GEOMETRY|br.TRANSFORMATION)){const c=k_(t.elementCount(l.geometry.geometry)*r),h=t.vertexBufferLayout.createView(c.buffer);this._writeGeometry(n,h,0),o.vao.vertexBuffers.geometry.setSubData(c,l.from*r,0,l.numElements*r)}a.updateType&(br.HIGHLIGHT|br.OCCLUDEE|br.VISIBILITY)&&(o.drawCommandsDirty=!0)}}_computeDeltas(e,t){var s;const r=new Tv;for(const a of e){const n=a.localOrigin;if(P(n))continue;let o=r.get(n.id,null);P(o)&&(o=new zO(n.vec3),r.set(n.id,null,o)),o.changes.push(a)}for(const a of t){const n=a.localOrigin;if(P(n))continue;const o=(s=this._dataByOrigin.get(n.id))==null?void 0:s.findBuffer(a.id);if(P(o))continue;let l=r.get(n.id,o);P(l)&&(l=new zO(n.vec3),r.set(n.id,o,l)),l.changes.push(a)}return r}_addAndRemoveGeometries(e,t){const{_bufferWriter:r,_dataByOrigin:s}=this,a=r.vertexBufferLayout.stride/4,n=this._computeDeltas(e,t);n.forEach((o,l)=>{const c=o.get(null),h=g(c)?c.changes:[];n.delete(l,null);let u=s.get(l);if(o.forEach((p,m)=>{if(n.delete(l,m),P(m))return void dt(!1,"No VAO for removed geometries");if(m.instances.size===p.changes.length)return this._vaoCache.deleteVao(m.vao),dy(u.buffers,m),void(u.buffers.length===0&&h.length===0&&s.delete(l));const f=m.numElements,y=m.vao.size/4,b=h.reduce((O,R)=>O+r.elementCount(R.geometry),0),x=p.changes.reduce((O,R)=>O+r.elementCount(R.geometry),0),S=Math.min((f+b-x)*a,H_),C=S>y;S>ky&&S<y/2?(p.changes.forEach(({id:O})=>m.deleteInstance(O)),m.instances.forEach(({geometry:O})=>h.push(O)),this._vaoCache.deleteVao(m.vao),dy(u.buffers,m)):C?this._applyAndRebuild(m,h,p):this._applyRemoves(m,p)}),h.length>0)for(P(u)&&(u=new qj(c.origin),s.set(l,u)),u.buffers.forEach(p=>this._applyAdds(p,h));h.length>0;)u.buffers.push(this._applyAndRebuild(new Hj,h,null))})}_updateDrawCommands(){this._hasHighlights=!1,this._hasOccludees=!1,this._dataByOrigin.forEach(e=>{e.buffers.forEach(t=>{t.drawCommandsDirty&&(t.hasHiddenInstances=!1,t.hasHighlights=!1,t.hasOccludees=!1,Ks(t.instances,r=>(t.updateDrawState(r),t.hasHiddenInstances&&t.hasHighlights&&t.hasOccludees)),t.updateDrawCommands(this._bufferWriter.vertexBufferLayout.stride)),this._hasHighlights=this._hasHighlights||t.hasHighlights,this._hasOccludees=this._hasOccludees||t.hasOccludees})})}_applyAndRebuild(e,t,r){if(g(r))for(const f of r.changes)e.deleteInstance(f.id);const s=this._bufferWriter,a=s.vertexBufferLayout.stride,n=a/4,o=Math.floor(H_/n);let l=e.numElements;for(;t.length>0;){const f=t.pop(),y=s.elementCount(f.geometry);if(l+y>o&&l>0){t.push(f);break}l+=y;const b=new NO(f,0,0);dt(e.instances.get(f.id)==null),e.addInstance(f.id,b)}const c=l*n,h=k_(c),u=s.vertexBufferLayout.createView(h.buffer);let p=0;e.hasHiddenInstances=!1,e.hasHighlights=!1,e.hasOccludees=!1,e.instances.forEach((f,y)=>{this._writeGeometry(f.geometry,u,p);const b=p;p+=s.elementCount(f.geometry.geometry),e.updateInstance(y,b,p),e.updateDrawState(f)}),this._vaoCache.deleteVao(e.vao),e.vao=this._vaoCache.newVao(VO(c)),e.vao.vertexBuffers.geometry.setSubData(h,0,0,p*n),e.holes.clear();const m=e.holes.pushNew();return m.from=p,m.to=Math.floor(e.vao.size/a),e.updateDrawCommands(a),e}_applyRemoves(e,t){if(t.changes.length===0)return;for(const o of t.changes){const l=o.id,c=e.instances.get(l);if(!c)continue;e.deleteInstance(l);const h=Mo.back();if(h){if(h.to===c.from){h.to=c.to;continue}if(h.from===c.to){h.from=c.from;continue}}const u=Mo.pushNew();u.from=c.from,u.to=c.to}$O(Mo);const r=this._bufferWriter.vertexBufferLayout.stride/4,s=Mo.reduce((o,l)=>Math.max(o,l.numElements),0)*r,a=k_(s);a.fill(0,0,s);const n=e.vao.vertexBuffers.geometry;Mo.forAll(o=>n.setSubData(a,o.from*r,0,o.numElements*r)),e.holes.pushArray(Mo.data,Mo.length),Mo.forAll((o,l)=>Mo.data[l]=null),Mo.clear(),e.drawCommandsDirty=!0}_applyAdds(e,t){if(t.length===0)return;if(!kj(e))return void this._applyAndRebuild(e,t,null);const r=this._bufferWriter,s=r.vertexBufferLayout.stride/4,a=e.numElements,n=t.reduce((x,S)=>x+r.elementCount(S.geometry),0),o=Math.min((a+n)*s,H_),l=4*o;if(e.vao.size<VO(H_-ky)&&l>e.vao.size)return void this._applyAndRebuild(e,t,null);$O(e.holes);const c=new Array;for(const x of t){const S=r.elementCount(x.geometry),C=Zj(e.holes,S);c.push(C)}const h=e.vao.vertexBuffers.geometry;let u=0,p=0,m=0;const f=k_(o),y=r.vertexBufferLayout.createView(f.buffer);t.forEach((x,S)=>{const C=c[S];if(P(C))return;if(m!==C){const E=m-p;E>0&&h.setSubData(f,p*s,0,E*s),p=C,u=0}const O=r.elementCount(x.geometry);this._writeGeometry(x,y,u),u+=O,m=C+O;const R=new NO(x,C,C+O);dt(e.instances.get(x.id)==null),e.addInstance(x.id,R),e.drawCommandsDirty=!0});const b=m-p;b>0&&h.setSubData(f,p*s,0,b*s),mN(t,(x,S)=>P(c[S]))}_writeGeometry(e,t,r){const s=e.localOrigin.vec3;K9(UO,-s[0],-s[1],-s[2]);const a=pr(Yj,UO,e.transformation);$a(G_,a),iT(G_,G_),this._bufferWriter.write(a,G_,e.geometry,t,r)}updateAnimation(e){return this.material.update(e)}requiresSlot(e,t){return this.material.requiresSlot(e,t)}render(e,t){var c;if(!this.requiresSlot(t.slot,e))return!1;const r=e===A.Highlight||e===A.ShadowHighlight;if(r&&!this._hasHighlights)return!1;const s=e===A.ShadowExcludeHighlight,a=!(r||s),n=this._rctx;let o;const l=()=>{if(g(o))return o;const h=this._glMaterials.load(n,t.slot,e);return P(h)?null:(o=h.beginSlot(t),P(o)?null:(n.bindTechnique(o,this.material.parameters,t),o))};(c=this._appleAmdDriverHelper)==null||c.resetIndicesType();for(const h of this._dataByOrigin.values())for(const u of h.buffers){if(r&&!u.hasHighlights)continue;const p=(r?u.drawCommandsHighlight:s&&u.needsMultipleCommands()?u.drawCommandsShadowHighlightRest:u.drawCommandsDefault)||null,m=a&&u.drawCommandsOccludees||null;if(p!=null&&p.length||m!=null&&m.length){const f=l();if(P(f))return!1;f.program.bindDraw(new Cw(h.origin),t,this.material.parameters),f.ensureAttributeLocations(u.vao),n.bindVAO(u.vao),p!=null&&p.length&&(f.bindPipelineState(n,t.slot,!1),p.forAll(y=>n.drawArrays(f.primitiveType,y.first,y.count))),m!=null&&m.length&&(f.bindPipelineState(n,t.slot,!0),m.forAll(y=>n.drawArrays(f.primitiveType,y.first,y.count)))}}return g(o)}get test(){return{material:this.material,glMaterials:this._glMaterials,dataByOrigin:this._dataByOrigin}}},zO=class{constructor(e){this.origin=e,this.changes=new Array}};function Zj(i,e){let t;if(!i.some(s=>!(s.numElements<e)&&(t=s,!0)))return null;const r=t.from;return t.from+=e,t.from>=t.to&&i.removeUnordered(t),r}const UO=ce(),Yj=ce(),G_=ce(),Mo=new At({allocator:i=>i||new WC,deallocator:null}),ky=65536,B_=4*ky,ML=16777216,H_=ML/4;let wb=new Float32Array(ky);function k_(i){return wb.length<i&&(wb=new Float32Array(i)),wb}function VO(i){const e=4*i;return e<B_?B_:Math.max(Math.min(Math.ceil(1.5*e/B_)*B_,ML),e)}let Qa=class extends Ie{constructor(e){super(e),this._pending=new Kj,this._changes=new Tw,this._materialRenderers=new Map,this._sortedMaterialRenderers=new At,this._geometries=new Map,this._hasHighlights=!1,this._hasWater=!1}destroy(){this._changes.prune(),this._materialRenderers.forEach(e=>e.dispose()),this._materialRenderers.clear(),this._sortedMaterialRenderers.clear(),this._geometries.clear()}get updating(){return!this._pending.empty||this._changes.updates.length>0}get rctx(){return this.rendererContext.rctx}get _materialRepository(){return this.rendererContext.materialRepository}get _localOriginFactory(){return this.rendererContext.localOriginFactory}get hasHighlights(){return this._hasHighlights}get hasWater(){return this._hasWater}get rendersOccluded(){return Ks(this._materialRenderers,e=>e.rendersOccluded)}get isEmpty(){return!this.updating&&this._materialRenderers.size===0&&this._geometries.size===0}commitChanges(){if(!this.updating)return!1;this._processAddsRemoves();const e=wL(this._changes);let t=!1,r=!1,s=!1;return e.forEach((a,n)=>{let o=this._materialRenderers.get(n);if(!o&&a.adds.length>0&&(o=new AL(this.rctx,this._materialRepository,n),this._materialRenderers.set(n,o),t=!0,r=!0,s=!0),!o)return;const l=r||o.hasHighlights,c=s||o.hasWater;o.modify(a),r=r||l!==o.hasHighlights,s=s||c!==o.hasWater,o.isEmpty&&(this._materialRenderers.delete(n),o.dispose(),t=!0)}),this._changes.clear(),t&&this._updateSortedMaterialRenderers(),r&&(this._hasHighlights=Ks(this._materialRenderers,a=>a.hasHighlights)),s&&(this._hasWater=Ks(this._materialRenderers,a=>a.hasWater)),this.notifyChange("updating"),!0}addGeometries(e,t){if(e.length===0)return;const r=this._validateRenderGeometries(e);for(const a of r)this._geometries.set(a.id,a);const s=this._pending.empty;for(const a of r)this._pending.adds.add(a);s&&this.notifyChange("updating"),t===fi.UPDATE&&this._notifyGraphicGeometryChanged(e)}removeGeometries(e,t){const r=this._pending.empty,s=this._pending.adds;for(const a of e)s.has(a)?(this._pending.removed.add(a),s.delete(a)):this._pending.removed.has(a)||this._pending.removes.add(a),this._geometries.delete(Si(a.id));r&&!this._pending.empty&&this.notifyChange("updating"),t===fi.UPDATE&&this._notifyGraphicGeometryChanged(e)}modifyGeometries(e,t){const r=this._changes.updates.length===0;for(const s of e){const a=this._changes.updates.pushNew();a.renderGeometry=this._validateRenderGeometry(s),a.updateType=t}switch(r&&this._changes.updates.length>0&&this.notifyChange("updating"),t){case br.TRANSFORMATION:case br.GEOMETRY:return this._notifyGraphicGeometryChanged(e);case br.VISIBILITY:return this._notifyGraphicVisibilityChanged(e)}}updateAnimation(e){let t=!1;return this._sortedMaterialRenderers.forAll(r=>t=r.updateAnimation(e)||t),t}render(e){this._sortedMaterialRenderers.forAll(t=>{t.material.shouldRender(e)&&t.render(e.output,e.bindParameters)})}intersect(e,t,r,s,a){return this._geometries.forEach(n=>{if(s&&!s(n))return;this._intersectRenderGeometry(n,r,t,0,e,a);const o=this.rendererContext.longitudeCyclical;o&&(n.boundingSphere[0]-n.boundingSphere[3]<o.min&&this._intersectRenderGeometry(n,r,t,o.range,e,a),n.boundingSphere[0]+n.boundingSphere[3]>o.max&&this._intersectRenderGeometry(n,r,t,-o.range,e,a)),a++}),a}_updateSortedMaterialRenderers(){this._sortedMaterialRenderers.clear();let e=0;this._materialRenderers.forEach((t,r)=>{r.insertOrder=e++,this._sortedMaterialRenderers.push(t)}),this._sortedMaterialRenderers.sort((t,r)=>{const s=r.material.renderPriority-t.material.renderPriority;return s!==0?s:t.material.insertOrder-r.material.insertOrder})}_processAddsRemoves(){this._changes.adds.clear(),this._changes.removes.clear(),this._changes.adds.pushArray(Array.from(this._pending.adds)),this._changes.removes.pushArray(Array.from(this._pending.removes));for(let e=0;e<this._changes.updates.length;){const t=this._changes.updates.data[e];this._pending.has(t.renderGeometry)?this._changes.updates.removeUnorderedIndex(e):e++}this._pending.clear()}_intersectRenderGeometry(e,t,r,s,a,n){if(!e.visible)return;let o=0;s+=e.transformation[12],o=e.transformation[13],Tb[0]=r[0]-s,Tb[1]=r[1]-o,e.screenToWorldRatio=this.rendererContext.screenToWorldRatio,e.material.intersectDraped(e,null,a,Tb,(l,c,h)=>{Jj(t,h,e.material.renderPriority,n,a,e.layerUid,e.graphicUid)},t)}_notifyGraphicGeometryChanged(e){if(P(this.drapeSource.notifyGraphicGeometryChanged))return;let t;for(const r of e){const s=r.graphicUid;g(s)&&s!==t&&(this.drapeSource.notifyGraphicGeometryChanged(s),t=s)}}_notifyGraphicVisibilityChanged(e){if(P(this.drapeSource.notifyGraphicVisibilityChanged))return;let t;for(const r of e){const s=r.graphicUid;g(s)&&s!==t&&(this.drapeSource.notifyGraphicVisibilityChanged(s),t=s)}}_validateRenderGeometries(e){for(const t of e)this._validateRenderGeometry(t);return e}_validateRenderGeometry(e){return P(e.localOrigin)&&(e.localOrigin=this._localOriginFactory.getOrigin(e.boundingSphere)),e}get test(){return{sortedMaterialRenderers:this._sortedMaterialRenderers}}};d([v()],Qa.prototype,"drapeSource",void 0),d([v()],Qa.prototype,"updating",null),d([v()],Qa.prototype,"rctx",null),d([v()],Qa.prototype,"rendererContext",void 0),d([v()],Qa.prototype,"_materialRepository",null),d([v()],Qa.prototype,"_localOriginFactory",null),d([v({readOnly:!0})],Qa.prototype,"isEmpty",null),d([v()],Qa.prototype,"_materialRenderers",void 0),d([v()],Qa.prototype,"_geometries",void 0),Qa=d([Y("esri.views.3d.webgl-engine.lib.SortedRenderGeometryRenderer")],Qa);let Kj=class{constructor(){this.adds=new Set,this.removes=new Set,this.removed=new Set}get empty(){return this.adds.size===0&&this.removes.size===0&&this.removed.size===0}has(e){return this.adds.has(e)||this.removes.has(e)||this.removed.has(e)}clear(){this.adds.clear(),this.removes.clear(),this.removed.clear()}};function Jj(i,e,t,r,s,a,n){const o=new Oj(a,n,e),l=c=>{c.set(ci.OVERLAY,o,i.dist,i.normal,i.transformation,t,r)};if((s.results.min.drapedLayerOrder==null||t>=s.results.min.drapedLayerOrder)&&(s.results.min.dist==null||s.results.ground.dist<=s.results.min.dist)&&l(s.results.min),s.options.store!==Vr.MIN&&(s.results.max.drapedLayerOrder==null||t<s.results.max.drapedLayerOrder)&&(s.results.max.dist==null||s.results.ground.dist>s.results.max.dist)&&l(s.results.max),s.options.store===Vr.ALL){const c=hC(s.ray);l(c),s.results.all.push(c)}}const Tb=$e();let XC=class DL extends Mt{initializeProgram(e){return new Rt(e.rctx,DL.shader.get().build(),Lt)}initializePipeline(){return this.configuration.hasAlpha?qe({blending:Ar(ae.SRC_ALPHA,ae.ONE,ae.ONE_MINUS_SRC_ALPHA,ae.ONE_MINUS_SRC_ALPHA),colorWrite:at}):qe({colorWrite:at})}};XC.shader=new Dt(CF,()=>_e(()=>import("./TextureOnly.glsl-66a3c6c1.js"),["assets/TextureOnly.glsl-66a3c6c1.js","assets/calcite-8912bd40.js","assets/index-00759e4a.js","assets/index-5026a37a.css","assets/calcite-96fa36fd.css","assets/OrderIndependentTransparency-5f7257d7.js","assets/enums-e2e92c86.js","assets/basicInterfaces-7449a8bf.js","assets/VertexAttribute-15d1866a.js","assets/objectResourceUtils-782953c3.js","assets/devEnvironmentUtils-5002a058.js","assets/mat3f64-50f3b9f6.js","assets/mat4f64-abdda1bb.js","assets/BufferView-379a78a4.js","assets/vec33-69c9e93b.js","assets/DefaultMaterial_COLOR_GAMMA-6ed76d86.js","assets/types-e1c0a5bf.js","assets/Version-aa0a1d91.js","assets/quat-7b70e9a8.js","assets/quatf64-f8f1c132.js","assets/resourceUtils-527631ac.js","assets/Indices-d8bff7b2.js","assets/NestedMap-1b5db22e.js","assets/requestImageUtils-d1ba3b36.js","assets/symbolColorUtils-c9d24716.js","assets/Util-6d3f024a.js","assets/sphere-d0e5285d.js","assets/doublePrecisionUtils-e3c3d0d8.js","assets/Texture-563cf5e5.js","assets/FramebufferObject-8b18fc0c.js","assets/VertexElementDescriptor-2925c6af.js","assets/InterleavedLayout-d57c91d0.js","assets/vec3f32-01c06d8d.js"]));let QC=class extends ua{constructor(){super(...arguments),this.hasAlpha=!1}};d([D()],QC.prototype,"hasAlpha",void 0);let Zn=class extends Ie{get _bindParameters(){return this._renderContext.bindParameters}get rctx(){return this._rctx}get materialRepository(){return this._materialRepository}get screenToWorldRatio(){return this._screenToWorldRatio}get localOriginFactory(){return this._localOriginFactory}constructor(e){super(e),this._overlays=null,this._overlayRenderTarget=null,this._hasHighlights=!1,this._rendersOccluded=!1,this._hasWater=!1,this._handles=new Vi,this._renderers=new Map,this._sortedDrapeSourceRenderersDirty=!1,this._sortedRenderers=new At,this._passParameters=new SF,this._rctx=null,this._materialRepository=null,this._screenToWorldRatio=1,this._localOriginFactory=null,this._camera=new Fe,this.worldToPCSRatio=1,this.events=new Ms,this.longitudeCyclical=null}initialize(){const e=this.view._stage.renderView;this._rctx=e.renderingContext;const t=e.waterTextureRepository;this._stippleTextureRepository=new lL(e.renderingContext),this._shaderTechniqueRepository=new sL({rctx:this._rctx,viewingMode:ve.Local,stippleTextureRepository:this._stippleTextureRepository,waterTextureRepository:t}),this._renderContext=new bL(this._rctx,new jC(this._rctx,this.view.state.viewingMode),new z3(this.view,this._shaderTechniqueRepository,this._rctx,()=>{})),this._handles.add([te(()=>t.updating,()=>this.events.emit("content-changed"),Qi),te(()=>this.spatialReference,r=>this._localOriginFactory=new kC(r),Qi),ll(()=>this.view.allLayerViews,"after-changes",()=>this._sortedDrapeSourceRenderersDirty=!0)]),this._materialRepository=new aL(e.textureRepository,this._shaderTechniqueRepository,r=>{(r.renderOccluded&jy)>0!==this._rendersOccluded&&this._updateRendersOccluded(),this.events.emit("content-changed"),this.notifyChange("updating"),this.notifyChange("isEmpty")},()=>this.events.emit("content-changed")),this._bindParameters.slot=K.DRAPED_MATERIAL,this._bindParameters.highlightDepthTexture=U3(this._rctx),this._camera.near=1,this._camera.far=1e4,this._camera.relativeElevation=null,this._bindParameters.camera=this._camera,this._bindParameters.transparencyPassType=We.NONE,this._bindParameters.newLighting.noonFactor=0,this._bindParameters.newLighting.globalFactor=0,this._bindParameters.newLighting.set([new O3(Ge(1,1,1))]),this._handles.add(this.view.resourceController.scheduler.registerTask(Zi.STAGE,this))}destroy(){this._handles.destroy(),this._renderers.forEach(e=>e.destroy()),this._renderers.clear(),this._debugTextureTechnique=er(this._debugTextureTechnique),this._passParameters.texture=De(this._passParameters.texture),this._bindParameters.highlightDepthTexture=De(this._bindParameters.highlightDepthTexture),this._shaderTechniqueRepository=Te(this._shaderTechniqueRepository),this._temporaryFBO=De(this._temporaryFBO),this._quadVAO=De(this._quadVAO),this.disposeOverlays()}get updating(){return this._sortedDrapeSourceRenderersDirty||Ks(this._renderers,e=>e.updating)}get hasOverlays(){return g(this._overlays)&&g(this._overlayRenderTarget)}get gpuMemoryUsage(){return g(this._overlayRenderTarget)?this._overlayRenderTarget.gpuMemoryUsage:0}createGeometryDrapeSourceRenderer(e){return this.createDrapeSourceRenderer(e,Qa)}createDrapeSourceRenderer(e,t,r){const s=this._renderers.get(e);g(s)&&s.destroy();const a=new t({...r,rendererContext:this,drapeSource:e});return this._renderers.set(e,a),this._sortedDrapeSourceRenderersDirty=!0,"fullOpacity"in e&&this._handles.add(te(()=>e.fullOpacity,()=>this.events.emit("content-changed")),e),a}removeDrapeSourceRenderer(e){if(P(e))return;const t=this._renderers.get(e);P(t)||(this._sortedDrapeSourceRenderersDirty=!0,this._renderers.delete(e),this._handles.remove(e),t.destroy())}collectUnusedRenderTargetMemory(e){let t=!1;if(g(this._overlayRenderTarget))for(const r of this._overlayRenderTarget.renderTargets){const[s,a]=this.overlays,n=s.validTargets[r.type]||!a.validTargets[r.type];t=this._overlayRenderTarget.validateUsageForTarget(n,r,e)||t}return t}get overlays(){return je(this._overlays,[])}ensureDrapeTargets(e){g(this._overlays)&&this._overlays.forEach(t=>t.hasTargetWithoutRasterImage=o1(e,r=>r.drapeTargetType===ww.WithoutRasterImage))}ensureDrapeSources(e){g(this._overlays)&&this._overlays.forEach(t=>{t.hasDrapedFeatureSource=o1(e,r=>r.drapeSourceType===Dg.Features),t.hasDrapedRasterSource=o1(e,r=>r.drapeSourceType===Dg.RasterImage)})}ensureOverlays(e,t){P(this._overlays)&&(this._overlayRenderTarget=new kk(this._rctx),this._overlays=[new yO(oi.INNER,this._overlayRenderTarget),new yO(oi.OUTER,this._overlayRenderTarget)]),this.ensureDrapeTargets(e),this.ensureDrapeSources(t)}disposeOverlays(){this._overlays=null,this._overlayRenderTarget=De(this._overlayRenderTarget),this.events.emit("textures-disposed")}get running(){return this.updating}runTask(e){this._processDrapeSources(e,()=>!0)}_processDrapeSources(e,t){let r=!1;for(const[s,a]of this._renderers){if(e.done)break;(s.destroyed||t(s))&&a.commitChanges()&&(r=!0,e.madeProgress())}this._sortedDrapeSourceRenderersDirty&&(this._sortedDrapeSourceRenderersDirty=!1,r=!0,this._updateSortedDrapeSourceRenderers()),r&&(g(this._overlays)&&this._renderers.size===0&&this.disposeOverlays(),this.notifyChange("updating"),this.notifyChange("isEmpty"),this.events.emit("content-changed"),this._updateHasHighlights(),this._updateRendersOccluded(),this._updateHasWater())}processSyncDrapeSources(){this._processDrapeSources(Ea,e=>e.updatePolicy===ah.SYNC)}get isEmpty(){return!Ot.OVERLAY_DRAW_DEBUG_TEXTURE&&!Ks(this._renderers,e=>!e.isEmpty)}get hasHighlights(){return this._hasHighlights}get hasWater(){return this._hasWater}get rendersOccluded(){return this._rendersOccluded}updateAnimation(e){let t=!1;return this._renderers.forEach(r=>t=r.updateAnimation(e)||t),t}updateDrapeSourceOrder(){this._sortedDrapeSourceRenderersDirty=!0}drawTarget(e,t,r){const s=e.canvasGeometries;if(s.numViews===0)return!1;this._screenToWorldRatio=r*e.mapUnitsPerPixel;const a=t.output;if(this.isEmpty||a===A.Highlight&&!this.hasHighlights||a===A.Normal&&!this.hasWater||!e.hasSomeSizedView())return!1;const n=t.fbo;if(!n.isValid())return!1;const o=2*e.resolution,l=e.resolution;n.resize(o,l);const c=this._rctx;if(this._camera.pixelRatio=e.pixelRatio*r,this._renderContext.output=a,this._bindParameters.screenToWorldRatio=this._screenToWorldRatio,this._bindParameters.screenToPCSRatio=this._screenToWorldRatio*this.worldToPCSRatio,this._bindParameters.slot=a===A.Normal?K.DRAPED_WATER:K.DRAPED_MATERIAL,e.applyViewport(this._rctx),n.bind(c),e.index===oi.INNER&&(c.setClearColor(0,0,0,0),c.clearSafe(Xi.COLOR_BUFFER_BIT)),t.type===Ci.Occluded&&(this._renderContext.renderOccludedMask=jy),Ot.OVERLAY_DRAW_DEBUG_TEXTURE&&t.type!==Ci.Occluded)for(let h=0;h<s.numViews;h++)this._setViewParameters(s.extents[h],e),this._drawDebugTexture(e.resolution,tq[e.index]);return this._renderers.size>0&&this._sortedRenderers.forAll(({drapeSource:h,renderer:u})=>{if(t.type===Ci.ColorNoRasterImage&&h.drapeSourceType===Dg.RasterImage)return;const{fullOpacity:p}=h,m=g(p)&&p<1&&a===A.Color;m&&(this.bindTemporaryFramebuffer(this._rctx,o,l),c.clearSafe(Xi.COLOR_BUFFER_BIT));for(let f=0;f<s.numViews;f++)this._setViewParameters(s.extents[f],e),u.render(this._renderContext);m&&g(this._temporaryFBO)&&(n.bind(c),this.view._stage.renderView.compositingHelper.compositeOverlay(this._renderContext.bindParameters,this._temporaryFBO.getTexture(),p,e.index))}),c.bindFramebuffer(null),n.generateMipMap(),this._renderContext.resetRenderOccludedMask(),!0}bindTemporaryFramebuffer(e,t,r){P(this._temporaryFBO)&&(this._temporaryFBO=new rL(e,!1)),this._temporaryFBO.resize(t,r),this._temporaryFBO.bind(e)}async reloadShaders(){await this._shaderTechniqueRepository.reloadAll()}notifyContentChanged(){this.events.emit("content-changed")}intersect(e,t,r,s){var n;let a=0;for(const o of this._renderers.values())a=((n=o.intersect)==null?void 0:n.call(o,e,t,r,s,a))??a}_updateSortedDrapeSourceRenderers(){if(this._sortedRenderers.clear(),this._renderers.size===0)return;const e=this.view.map.allLayers;this._renderers.forEach((t,r)=>{const s=e.indexOf(r.layer),a=s>=0,n=this._renderers.size*(r.renderGroup??(a?Gy.MapLayer:Gy.ViewLayer))+(a?s:0);this._sortedRenderers.push(new eq(r,t,n))}),this._sortedRenderers.sort((t,r)=>t.index-r.index)}_setViewParameters(e,t){const r=this._camera;r.viewport=[0,0,t.resolution,t.resolution],gN(r.projectionMatrix,0,e[2]-e[0],0,e[3]-e[1],r.near,r.far),YA(r.viewMatrix,[-e[0],-e[1],0])}_updateHasWater(){const e=Ks(this._renderers,t=>t.hasWater);e!==this._hasWater&&(this._hasWater=e,this.events.emit("has-water",e))}_updateHasHighlights(){const e=Ks(this._renderers,t=>t.hasHighlights);e!==this._hasHighlights&&(this._hasHighlights=e,this.events.emit("has-highlights",e))}_updateRendersOccluded(){const e=Ks(this._renderers,t=>t.rendersOccluded);e!==this._rendersOccluded&&(this._rendersOccluded=e,this.events.emit("renders-occluded",e))}_drawDebugTexture(e,t){this._ensureDebugPatternResources(e,e,t);const r=this._rctx;r.bindTechnique(this._debugTextureTechnique,this._passParameters,null),r.bindVAO(this._quadVAO),r.drawArrays(Ut.TRIANGLE_STRIP,0,Os(this._quadVAO,"geometry"))}_ensureDebugPatternResources(e,t,r){if(j(this._passParameters.color,r[0],r[1],r[2]),this._passParameters.texture)return;const s=new Uint8Array(e*t*4);let a=0;for(let o=0;o<t;o++)for(let l=0;l<e;l++){const c=Math.floor(l/10),h=Math.floor(o/10);c<2||h<2||10*c>e-20||10*h>t-20?(s[a++]=255,s[a++]=255,s[a++]=255,s[a++]=255):(s[a++]=255,s[a++]=255,s[a++]=255,s[a++]=1&c&&1&h?1&l^1&o?0:255:1&c^1&h?0:128)}this._passParameters.texture=new Ai(this._rctx,{target:tr.TEXTURE_2D,pixelFormat:St.RGBA,dataType:Zt.UNSIGNED_BYTE,samplingMode:Qt.NEAREST,width:e,height:t},s);const n=new QC;n.hasAlpha=!0,this._debugTextureTechnique=this._shaderTechniqueRepository.acquire(XC,n),this._quadVAO=pa(this._rctx)}get test(){return{drapedRenderers:Array.from(this._renderers.values()),getDrapeSourceRenderer:e=>this._renderers.get(e)}}};d([v()],Zn.prototype,"_sortedDrapeSourceRenderersDirty",void 0),d([v({autoDestroy:!0})],Zn.prototype,"_shaderTechniqueRepository",void 0),d([v({autoDestroy:!0})],Zn.prototype,"_stippleTextureRepository",void 0),d([v({constructOnly:!0})],Zn.prototype,"view",void 0),d([v()],Zn.prototype,"worldToPCSRatio",void 0),d([v()],Zn.prototype,"spatialReference",void 0),d([v({type:Boolean,readOnly:!0})],Zn.prototype,"updating",null),d([v()],Zn.prototype,"isEmpty",null),Zn=d([Y("esri.views.3d.terrain.OverlayRenderer")],Zn);let eq=class{constructor(e,t,r){this.drapeSource=e,this.renderer=t,this.index=r}};const tq=[[1,.5,.5],[.5,.5,1]],ZC=-2,jy=qi.OccludeAndTransparent;function YC(i,e,t,r){const s=wv(i.rings,!!i.hasZ,Bp.CCW_IS_HOLE),a=Fn(s.position.length),n=$I(s.position,i.spatialReference,0,a,0,s.position,0,s.position.length/3,e,t,r),o=n!=null;return new sq(s.position,a,$L(s.polygons,s.position,a),LL(s.outlines,s.position,a),o,n)}function IL(i,e){const t=wv(i.rings,!1,Bp.CCW_IS_HOLE),r=ha(t.position,i.spatialReference,0,t.position,e,0,t.position.length/3);for(let s=2;s<t.position.length;s+=3)t.position[s]=ZC;return{position:t.position,polygons:$L(t.polygons,t.position),outlines:LL(t.outlines,t.position),projectionSuccess:r}}function LL(i,e,t=null){return i.filter(({count:r})=>r>1).map(({index:r,count:s})=>{const a=3*r,n=3*s;return g(t)?new NL(r,s,mo(e,a,n),mo(t,a,n)):new KC(r,s,mo(e,a,n))})}function $L(i,e,t=null){const r=new Array;for(const{index:s,count:a,holeIndices:n,pathLengths:o}of i){if(a<=1)continue;const l=3*s,c=3*a,h=n.map(p=>p-s),u=g(t)?new iq(s,a,mo(e,3*s,3*a),mo(t,l,c),h,o):new rq(s,a,mo(e,3*s,3*a),h,o);r.push(u)}return r}let KC=class{constructor(e,t,r){this.index=e,this.count=t,this.position=r}},NL=class extends KC{constructor(e,t,r,s){super(e,t,r),this.mapPositions=s}},iq=class extends NL{constructor(e,t,r,s,a,n){super(e,t,r,s),this.holeIndices=a,this.pathLengths=n}},rq=class extends KC{constructor(e,t,r,s,a){super(e,t,r),this.holeIndices=s,this.pathLengths=a}},sq=class{constructor(e,t,r,s,a,n){this.position=e,this.mapPositions=t,this.polygons=r,this.outlines=s,this.projectionSuccess=a,this.sampledElevation=n}};const aq=["polygon","extent"];let nq=class extends _l{constructor(e,t,r,s){super(e,t,r,s),this.ensureDrapedStatus(!1)}async doLoad(){if(!this._drivenProperties.size){const o=Uv(this._getSymbolSize());if(o)throw new bt("graphics3dextrudesymbollayer:invalid-size",o)}const e=Ur(this.symbolLayer,"material","color"),t=this._getCombinedOpacityAndColor(e),r=wn(t),s=t[3],a=s<1||this.needsDrivenTransparentPass,n={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0,diffuse:r,ambient:r,opacity:s,transparent:a,cullFace:a?Tr.None:Tr.Back,hasVertexColors:!0,hasSlicePlane:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows,offsetTransparentBackfaces:!0};this._material=new Kg(n),this._bottomMaterial=new Kg({...n,cullFace:Tr.Back}),this._context.stage.add(this._material),this._context.stage.add(this._bottomMaterial)}destroy(){super.destroy(),this._material&&(this._context.stage.remove(this._material),this._context.stage.remove(this._bottomMaterial))}createGraphics3DGraphic(e){const t=e.graphic;if(!this._validateGeometry(t.geometry,aq,this.symbolLayer.type))return null;const r=this._getVertexOpacityAndColor(e.renderingInfo,255),s=this.setGraphicElevationContext(t,new Po);return this._createAs3DShape(t,e.renderingInfo,r,s,t.uid)}layerOpacityChanged(e,t){const r=Ur(this.symbolLayer,"material","color"),s=this._getCombinedOpacity(r),a=s<1||this.needsDrivenTransparentPass;this._material.setParameters({opacity:s,transparent:a}),this._bottomMaterial.setParameters({opacity:s,transparent:a});const n=this._getLayerOpacity();e.forEach(o=>{const l=t(o);g(l)&&l.layerOpacityChanged(n,this._context.isAsync)})}layerElevationInfoChanged(e,t){return this.updateGraphics3DGraphicElevationInfo(e,t,wh)}slicePlaneEnabledChanged(e,t){return this._material.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),this._bottomMaterial.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),e.forEach(r=>{const s=t(r);g(s)&&s.slicePlaneEnabledChanged(this._context.slicePlaneEnabled,this._context.isAsync)}),!0}physicalBasedRenderingChanged(){return this._material.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}),this._bottomMaterial.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}),!0}pixelRatioChanged(){return!0}skipHighSymbolLodsChanged(){return!0}_getExtrusionSize(e){let t;return t=e.size&&this._drivenProperties.size?Vk(e.size,2)??0:this._getSymbolSize(),t/=this._context.renderCoordsHelper.unitInMeters,t}applyRendererDiff(e,t){return this._drivenPropertiesChanged(t)?dr.Recreate_Symbol:dr.Recreate_Graphics}async queryForSnapping(e,t,r,s){const a=this._getExtrusionSize(r)*this._context.renderCoordsHelper.unitInMeters/fN(t),{objectId:n,target:o}=e,l=Gl(o);switch(l.z=(l.z??0)+a,e.type){case"edge":{const{start:c,end:h}=e,u=Gl(c),p=Gl(h);return u.z=(u.z??0)+a,p.z=(p.z??0)+a,[b2(n,l,1/0,u,p)]}case"vertex":return[j6(n,l,1/0),b2(n,o,1/0,o,l)];default:return[]}}_getSymbolSize(){return this.symbolLayer.size??1}_createAs3DShape(e,t,r,s,a){const n=Tf(e.geometry);if(P(n))return null;if(n.rings.length===0||!n.rings.some(q=>q.length>0))return this._logGeometryValidationWarnings(n.rings,"rings","ExtrudeSymbol3DLayer"),null;const o=YC(n,this._context.elevationProvider,this._context.renderCoordsHelper,s);this._logGeometryCreationWarnings(o,n.rings,"rings","ExtrudeSymbol3DLayer");const l=DC(n);if(P(l))return null;const c=new Array,h=_s(),u=ce(),p=T(),m=this._context.renderCoordsHelper.viewingMode===ve.Global;m||this._context.renderCoordsHelper.worldUpAtPosition(null,p),Zl(n.spatialReference,[l.x,l.y,0],u,this._context.renderCoordsHelper.spatialReference);const f=ce();$a(f,u);const y=ys();_N(y,f);const{polygons:b,mapPositions:x,position:S}=o,C=S.length/3,O=new Float64Array(3*C*6),R=new Float64Array(3*C*6),E=new Float64Array(3*C*6),$=new Float64Array(1*C*6);let M=0;for(let q=0;q<b.length;++q){const se=b[q],k=se.count;if(this._context.clippingExtent&&(di(h),nn(h,se.mapPositions),!co(h,this._context.clippingExtent)))continue;const I=of(se.mapPositions,se.holeIndices,3);if(I.length===0)continue;const U=3*k*2+I.length,V=new Array(U),z=new Array(I.length),ie=6*k,re=3*O.BYTES_PER_ELEMENT,he=new _y(O.buffer,M*re,re,(M+ie)*re),oe=3*R.BYTES_PER_ELEMENT,Re=new _y(R.buffer,M*oe,oe,(M+ie)*oe),ne=new Float64Array(E.buffer,3*M*E.BYTES_PER_ELEMENT,3*ie),me=new Float64Array($.buffer,1*M*$.BYTES_PER_ELEMENT,1*ie),ge=this._getExtrusionSize(t);oq(S,x,I,se,he.typedBuffer,ne,Re.typedBuffer,me,V,z,ge,p,m),uM(he,he,f),vy(Re,Re,y),M+=6*k;const Ue=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:a,layerUid:this._context.layer.uid}),Ee=new uq(he.typedBuffer,ne,Re.typedBuffer,me);c.push(GO(this._material,V,V.length-z.length,Ee,r,Ue)),c.push(GO(this._bottomMaterial,z,0,Ee,r,Ue))}if(c.length===0)return null;const L=new hc({geometries:c,metadata:{layerUid:this._context.layer.uid,graphicUid:a,isElevationSource:!0}});L.transformation=u;const F=dM(this.symbolLayer,{opacity:this._getLayerOpacity()}),N=g(F)?{baseMaterial:this._material,edgeMaterials:[F],properties:{mergeGeometries:!0,hasSlicePlane:this._context.slicePlaneEnabled}}:null,G=new fl(this,L,c,null,null,hq,s,N);return G.alignedSampledElevation=o.sampledElevation,G.needsElevationUpdates=wh(s.mode),G}};function GO(i,e,t,r,s,a){const n=new Array(e.length).fill(0),o=[[w.POSITION,new be(r.positions,3,!0)],[w.NORMAL,new be(r.normals,3,!0)],[w.COLOR,new be(s,4,!0)],[w.SIZE,new be(r.heights,1,!0)]],l=[[w.POSITION,e],[w.NORMAL,e],[w.COLOR,n]];return new Cr(i,o,l,r.elevation,ps.Mesh,a,t)}function oq(i,e,t,r,s,a,n,o,l,c,h,u,p){const m=t.length/3;let f=0,y=2*r.count;lq(i,e,r.index,r.count,t,0,m,s,a,n,o,l,c,y,h,u,p);let b=2*r.count;y=0,BO(s,a,o,n,f,r.pathLengths[0],r.count,b,l,y,h),b+=4*r.pathLengths[0],y+=2*r.pathLengths[0],f+=r.pathLengths[0];for(let x=1;x<r.pathLengths.length;++x)BO(s,a,o,n,f,r.pathLengths[x],r.count,b,l,y,h),b+=4*r.pathLengths[x],y+=2*r.pathLengths[x],f+=r.pathLengths[x]}function lq(i,e,t,r,s,a,n,o,l,c,h,u,p,m,f,y,b){H(Fs,y);const x=f>0?1:-1;let S=3*t,C=0,O=3*C,R=r,E=3*R;for(let L=0;L<r;++L)b&&(Fs[0]=i[S+0],Fs[1]=i[S+1],Fs[2]=i[S+2],W(Fs,Fs)),o[O+0]=i[S+0],o[O+1]=i[S+1],o[O+2]=i[S+2],l[O+0]=e[S+0],l[O+1]=e[S+1],l[O+2]=e[S+2],c[O+0]=-x*Fs[0],c[O+1]=-x*Fs[1],c[O+2]=-x*Fs[2],h[C]=0,o[E+0]=i[S+0]+f*Fs[0],o[E+1]=i[S+1]+f*Fs[1],o[E+2]=i[S+2]+f*Fs[2],l[E+0]=e[S+0],l[E+1]=e[S+1],l[E+2]=e[S+2],c[E+0]=x*Fs[0],c[E+1]=x*Fs[1],c[E+2]=x*Fs[2],h[R]=f,O+=3,E+=3,S+=3,C+=1,R+=1;S=3*a,O=0,E=3*m;const $=f<0?XO:WO,M=f<0?WO:XO;for(let L=0;L<n;++L)p[O+0]=s[S+$[0]],p[O+1]=s[S+$[1]],p[O+2]=s[S+$[2]],u[E+0]=s[S+M[0]]+r,u[E+1]=s[S+M[1]]+r,u[E+2]=s[S+M[2]]+r,O+=3,E+=3,S+=3}function j_(i,e,t,r,s,a,n){r[a]=r[n],n*=3,i[(a*=3)+0]=i[n+0],i[a+1]=i[n+1],i[a+2]=i[n+2],e[a+0]=e[n+0],e[a+1]=e[n+1],e[a+2]=e[n+2],t[a+0]=s[0],t[a+1]=s[1],t[a+2]=s[2]}const Mm=T();function BO(i,e,t,r,s,a,n,o,l,c,h){let u=s,p=s+1,m=s+n,f=s+n+1,y=o,b=o+1,x=o+2*a,S=o+2*a+1;h<0&&(u=s+n+1,f=s),c*=3;for(let C=0;C<a;++C)C===a-1&&(h>0?(p=s,f=s+n):(p=s,u=s+n)),cq(i,u,p,m,Mm),j_(i,e,r,t,Mm,y,u),j_(i,e,r,t,Mm,b,p),j_(i,e,r,t,Mm,x,m),j_(i,e,r,t,Mm,S,f),l[c++]=y,l[c++]=x,l[c++]=S,l[c++]=y,l[c++]=S,l[c++]=b,u++,p++,m++,f++,y+=2,b+=2,x+=2,S+=2}const Cb=T(),HO=T(),kO=T(),jO=T(),qO=T();function cq(i,e,t,r,s){e*=3,t*=3,r*=3,j(Cb,i[e++],i[e++],i[e++]),j(HO,i[t++],i[t++],i[t++]),j(kO,i[r++],i[r++],i[r++]),Q(jO,HO,Cb),Q(qO,kO,Cb),Be(s,qO,jO),W(s,s)}const Mu=T();function hq(i,e,t,r,s){const a=i.stageObject,n=a.geometries,o=n.length,l=e.mode!=="absolute-height";let c=0;const h=a.transformation,u=Vf(ce(),h);for(let p=0;p<o;p+=2){const m=n[p];if(!LC(m))continue;const f=m.getMutableAttribute(w.POSITION).data,y=m.vertexAttributes.get(w.SIZE).data,b=new YD(m.mapPositions),x=f.length/3;let S=0,C=!1,O=0;for(let R=0;R<x;R++){Mu[0]=f[S],Mu[1]=f[S+1],Mu[2]=f[S+2],r(b,q_),l&&(O+=q_.sampledElevation),Ot.TESTS_DISABLE_OPTIMIZATIONS?(j(_a,b.array[b.offset+0],b.array[b.offset+1],q_.z+y[S/3]),g(t)&&s.toRenderCoords(_a,t,_a),xe(_a,_a,u)):(j(_a,f[S+0],f[S+1],f[S+2]),xe(_a,_a,h),s.setAltitude(_a,q_.z+y[S/3]),xe(_a,_a,u)),f[S]=_a[0],f[S+1]=_a[1],f[S+2]=_a[2];const E=dq/s.unitInMeters;(Math.abs(Mu[0]-f[S])>=E||Math.abs(Mu[1]-f[S+1])>=E||Math.abs(Mu[2]-f[S+2])>=E)&&(C=!0),b.offset+=3,S+=3}C&&(m.invalidateBoundingInfo(),a.geometryVertexAttrsUpdated(n[p]),n[p+1].invalidateBoundingInfo(),a.geometryVertexAttrsUpdated(n[p+1])),c+=O/x}return c/o}const _a=T(),Fs=T(),q_=new Zf,WO=[0,2,1],XO=[0,1,2],dq=.01;let uq=class{constructor(e,t,r,s){this.positions=e,this.elevation=t,this.normals=r,this.heights=s}};const Voe=1.2,pq=Bl;let Bv=class{constructor(e,t,r,s){this.graphics3DSymbolLayer=e,this.renderGeometries=t,this.boundingBox=r,this._drapeSourceRenderer=s,this.type="draped",this.stage=null,this._visible=!1,this._addedToStage=!1,this.isElevationSource=!1}initialize(e){this.stage=e}setVisibility(e){if(this.stage!=null&&this._visible!==e){if(this._visible=e,e&&!this._addedToStage)return this._addedToStage=!0,void this._drapeSourceRenderer.addGeometries(this.renderGeometries,fi.ADD);if(e||this._addedToStage){for(const t of this.renderGeometries)t.visible=this._visible;this._drapeSourceRenderer.modifyGeometries(this.renderGeometries,br.VISIBILITY)}}}destroy(){this.stage&&this._addedToStage&&this._drapeSourceRenderer.removeGeometries(this.renderGeometries,fi.REMOVE),this._addedToStage=!1,this._visible=!1,this.stage=null}getCenterObjectSpace(e=T()){return j(e,0,0,0)}getBoundingBoxObjectSpace(e=_s()){return di(e)}addObjectState(e,t){e===Hp.Highlight&&(this.renderGeometries.forEach(r=>{const s=r.geometry.addHighlight();t.addRenderGeometry(r,s,this)}),this._addedToStage&&this._drapeSourceRenderer.modifyGeometries(this.renderGeometries,br.HIGHLIGHT))}removeObjectState(e){this.renderGeometries.forEach(t=>{e.removeRenderGeometry(t)})}removeRenderGeometryObjectState(e,t){e.geometry.removeHighlight(t),this._addedToStage&&this._drapeSourceRenderer.modifyGeometries(this.renderGeometries,br.HIGHLIGHT)}computeAttachmentOrigin(e){for(const t of this.renderGeometries)t.geometry.computeAttachmentOrigin(Du)&&(e.draped.origin[0]+=Du[0],e.draped.origin[1]+=Du[1],e.draped.num++)}async getProjectedBoundingBox(e,t,r,s,a){di(a);for(let n=0;n<this.renderGeometries.length;n++){const o=this.renderGeometries[n];this._getRenderGeometryProjectedBoundingRect(o,e,QO,r),yN(a,QO)}if(t){let n;oo(a,Du);const o=IC(a,t.service.spatialReference,t);try{n=await t.service.queryElevation(Du[0],Du[1],s,o,"ground")}catch{}g(n)&&(a[2]=Math.min(a[2],n),a[5]=Math.max(a[5],n))}return a}_getRenderGeometryProjectedBoundingRect(e,t,r,s){if(this.boundingBox)fT(Do,this.boundingBox);else{const a=e.boundingSphere,n=a[3];Do[0]=a[0]-n,Do[1]=a[1]-n,Do[2]=a[2]-n,Do[3]=a[0]+n,Do[4]=a[1]+n,Do[5]=a[2]+n}return t(Do,0,2),this.calculateRelativeScreenBounds&&s.push({location:oo(Do),screenSpaceBoundingRect:this.calculateRelativeScreenBounds()}),hT(Do,r)}};const QO=yt(),Do=_s(),Du=T();let FL=class{constructor(e,t,r,s=2048){this.text=e,this._alignment=t,this._parameters=r,this._maxSize=s,this._textWidths=[],this._lineWidths=[],this._renderPixelRatio=null,this._metricsCached=null,this.key=`TextRenderer-${this._parameters.key}-${this._alignment}--${e}`,this._lines=e.split(/\r?\n/)}get displayWidth(){return Math.ceil(this._displayWidth+2*this._backgroundHorizontalPadding)}get displayHeight(){const e=this._lineSpacing*(this._lines.length-1),t=this._lineHeight;return Math.ceil(e+t+2*this._haloSize+this._backgroundTopPadding+this._backgroundBottomPadding)}get renderedWidth(){return Math.ceil(this._toRenderUnit(this.displayWidth))}get renderedHeight(){return Math.ceil(this._toRenderUnit(this.displayHeight))}get firstRenderedBaselinePosition(){return this._toRenderUnit(this._firstLineYOffset+this._baselinePosition)}get _firstLineYOffset(){return this._backgroundTopPadding+this._haloSize}get _metrics(){if(P(this._metricsCached)){const e=Sw(ZO,W_,W_).getContext("2d");this._setFontProperties(e,this._fontSize);let t=2*this._haloSize;const r=this._parameters.definition.font;r.style!=="italic"&&r.style!=="oblique"&&r.weight!=="bold"&&r.weight!=="bolder"||(t+=.3*e.measureText("A").width),this._textWidths.length=0,this._lineWidths.length=0;let s,a,n=0,o=0,l=0;this._lines.forEach((f,y)=>{const b=e.measureText(f),x=b.width,S=x+t;this._textWidths.push(x),this._lineWidths.push(S),n=Math.max(n,S),o=Math.max(o,b.actualBoundingBoxAscent),l=Math.max(l,b.actualBoundingBoxDescent),y===0&&(s=b),y===this._lines.length-1&&(a=b)});const c=e.font;let h=KO.get(c);if(!h){const f=e.measureText(gq);h=new _q(f.actualBoundingBoxAscent,f.actualBoundingBoxDescent),KO.set(c,h)}o=Math.max(o,h.actualBoundingBoxAscent),l=Math.max(l,h.actualBoundingBoxDescent);const u=o+l,p=this._hasBackground?s.actualBoundingBoxAscent:o,m=this._hasBackground?a.actualBoundingBoxDescent:l;this._metricsCached=new fq(o-p,l-m,u,n,o)}return this._metricsCached}get _lineSpacing(){return(this._lineHeight+this._linePadding)*this._parameters.definition.lineSpacingFactor}get _lineHeight(){return this._metrics.lineHeight}get _linePadding(){return this._lineHeight*mq}get _baselinePosition(){return this._metrics.baselinePosition}get _renderedFontSize(){return this._toRenderUnit(this._fontSize)}get _fontSize(){return this._parameters.definition.size}get _renderedHaloSize(){return this._toRenderUnit(this._haloSize)}get _haloSize(){return this._parameters.haloSize}get _backgroundHorizontalPadding(){return this._hasBackground?this._parameters.definition.background.padding[0]:0}get _backgroundVerticalPadding(){return this._hasBackground?this._parameters.definition.background.padding[1]:0}get _backgroundTopPadding(){return Math.max(0,this._backgroundVerticalPadding-this._metrics.paddingTop)}get _backgroundBottomPadding(){return Math.max(0,this._backgroundVerticalPadding-this._metrics.paddingBottom)}get _hasBackground(){return!!this._parameters.backgroundStyle}get renderPixelRatio(){if(P(this._renderPixelRatio)){const e=this._parameters.definition.pixelRatio;this._maxSize>0?this._renderPixelRatio=Math.min(e,Math.min(this._maxSize/this.displayWidth,this._maxSize/this.displayHeight)):this._renderPixelRatio=e}return this._renderPixelRatio}_getLineXOffset(e){switch(this._alignment){case nh.Left:return this._backgroundHorizontalPadding;case nh.Center:return(this.displayWidth-this._lineWidths[e])/2;case nh.Right:return this.displayWidth-this._backgroundHorizontalPadding-this._lineWidths[e]}}render(e,t=0,r=0){e.save();const s=t/=this.renderPixelRatio,a=r/=this.renderPixelRatio,n=this._haloSize,o=this._firstLineYOffset;t+=n,r+=o+this._baselinePosition;const l=this._haloSize>0;l&&this._renderHalo(e,s,a,n,o),this._setFontProperties(e,this._renderedFontSize);for(let c=0;c<this._lines.length;++c){const h=this._lines[c],u=this._getLineXOffset(c);l&&(e.globalCompositeOperation="destination-out",e.fillStyle="rgb(0, 0, 0)",this._fillText(e,h,t+u,r),this._renderLineDecoration(e,t+u,r,this._textWidths[c])),e.globalCompositeOperation="source-over",e.fillStyle=this._parameters.textStyle,this._fillText(e,h,t+this._getLineXOffset(c),r),this._renderLineDecoration(e,t+u,r,this._textWidths[c]),r+=this._lineSpacing}if(Ot.TEXT_SHOW_BASELINE){e.strokeStyle=YO,e.setLineDash([2,2]),e.lineWidth=1;let c=a+o;for(let h=0;h<this._lines.length;++h){const u=c+this._baselinePosition;this._drawLine(e,[s,u],[s+this.displayWidth,u]),c+=this._lineSpacing}}if(Ot.TEXT_SHOW_BORDER&&(e.strokeStyle=YO,e.setLineDash([]),e.lineWidth=1,this._drawBox(e,[s,a],[this.displayWidth,this.displayHeight])),this._hasBackground){const c=this._parameters.definition.background.borderRadius*this.renderPixelRatio;this._roundedRect(e,s,a,c),e.globalCompositeOperation="destination-over",e.fillStyle=this._parameters.backgroundStyle,e.fill()}e.restore()}_renderLineDecoration(e,t,r,s,a=!1){if(this._parameters.definition.font.decoration==="none"||s===0)return;const n=1,o=Math.max(this._parameters.definition.size/16,n);switch(this._parameters.definition.font.decoration){case"underline":r+=2*o;break;case"line-through":r-=.33*this._baselinePosition}const l=a?this._haloSize:0;e.strokeStyle=a?this._parameters.haloStyle:this._parameters.textStyle,e.lineWidth=this._toRenderUnit(o+2*l),e.beginPath(),e.moveTo(this._toRenderUnit(t-l),this._toRenderUnit(r)),e.lineTo(this._toRenderUnit(t+s+l),this._toRenderUnit(r)),e.stroke()}_roundedRect(e,t,r,s){t=this._toRenderUnit(t),r=this._toRenderUnit(r);const a=this.renderedWidth,n=this.renderedHeight;s!==0?(s=ee(s,0,Math.floor(n/2)),e.beginPath(),e.moveTo(t,r+s),e.arcTo(t,r,t+s,r,s),e.lineTo(t+a-s,r),e.arcTo(t+a,r,t+a,r+s,s),e.lineTo(t+a,r+n-s),e.arcTo(t+a,r+n,t+a-s,r+n,s),e.lineTo(t+s,r+n),e.arcTo(t,r+n,t,r+n-s,s),e.closePath()):e.rect(t,r,a,n)}_renderHalo(e,t,r,s,a){const n=this.renderedWidth,o=this.renderedHeight,l=Sw(ZO,Math.max(n,W_),Math.max(o,W_)),c=l.getContext("2d");c.clearRect(0,0,n,o),this._setFontProperties(c,this._renderedFontSize),c.fillStyle=this._parameters.haloStyle,c.strokeStyle=this._parameters.haloStyle;const h=this._renderedHaloSize<3;c.lineJoin=h?"miter":"round",h?this._renderHaloEmulated(c,s,a):this._renderHaloNative(c,s,a);let u=a+this._baselinePosition;for(let p=0;p<this._lines.length;++p){const m=this._getLineXOffset(p);this._renderLineDecoration(c,s+m,u,this._textWidths[p],!0),u+=this._lineSpacing}e.globalAlpha=this._parameters.definition.halo.color[3],e.drawImage(l,0,0,n,o,this._toRenderUnit(t),this._toRenderUnit(r),n,o),e.globalAlpha=1}_renderHaloEmulated(e,t,r){r+=this._baselinePosition;for(let s=0;s<this._lines.length;++s){const a=this._lines[s],n=this._getLineXOffset(s);for(const[o,l]of zL)this._fillText(e,a,t+n+this._haloSize*o,r+this._haloSize*l);r+=this._lineSpacing}}_renderHaloNative(e,t,r){const s=2*this._haloSize;r+=this._baselinePosition;for(let a=0;a<this._lines.length;++a){const n=this._lines[a],o=this._getLineXOffset(a),l=5,c=.1;for(let h=0;h<l;h++){const u=1-(l-1)*c+h*c;e.lineWidth=this._toRenderUnit(u*s),this._strokeText(e,n,t+o,r)}r+=this._lineSpacing}}_setFontProperties(e,t){e.font=this._parameters.fontString(t),e.textAlign="left",e.textBaseline="alphabetic"}get _displayWidth(){return this._metrics.displayWidth}_toRenderUnit(e){return e*this.renderPixelRatio}_toRoundedRenderUnit(e){return Math.round(e*this.renderPixelRatio)}_fillText(e,t,r,s){e.fillText(t,this._toRenderUnit(r),this._toRenderUnit(s))}_strokeText(e,t,r,s){e.strokeText(t,this._toRenderUnit(r),this._toRenderUnit(s))}_drawLine(e,t,r){e.beginPath(),e.moveTo(this._toRoundedRenderUnit(t[0])+.5,this._toRoundedRenderUnit(t[1])+.5),e.lineTo(this._toRoundedRenderUnit(r[0])+.5,this._toRoundedRenderUnit(r[1])+.5),e.stroke()}_drawBox(e,t,r){const s=this._toRenderUnit(t[0]),a=this._toRenderUnit(t[1]),n=this._toRenderUnit(r[0]),o=this._toRenderUnit(r[1]),l=Math.floor(s)+.5,c=Math.ceil(s+n)-.5,h=Math.floor(a)+.5,u=Math.ceil(a+o)-.5;e.beginPath(),e.moveTo(l,h),e.lineTo(c,h),e.lineTo(c,u),e.lineTo(l,u),e.lineTo(l,h),e.stroke()}};const zL=[];for(let e=0;e<360;e+=360/16)zL.push([Math.cos(Math.PI*e/180),Math.sin(Math.PI*e/180)]);var nh;function Sw(i,e,t){return i.canvas||(i.canvas=document.createElement("canvas")),i.canvas.width=e,i.canvas.height=t,i.canvas}(function(i){i[i.Left=0]="Left",i[i.Center=1]="Center",i[i.Right=2]="Right"})(nh||(nh={}));const ZO={canvas:null},mq=.2,W_=512,YO="rgb(255, 0, 255, 0.5)",gq=(()=>{let i="";for(let e=32;e<127;e++)i+=String.fromCharCode(e);return i})();let fq=class{constructor(e,t,r,s,a){this.paddingTop=e,this.paddingBottom=t,this.lineHeight=r,this.displayWidth=s,this.baselinePosition=a}},_q=class{constructor(e,t){this.actualBoundingBoxAscent=e,this.actualBoundingBoxDescent=t}};const KO=new Map,yq=Object.freeze({left:0,center:.5,right:1}),q0=Object.freeze({"bottom-left":It(0,0),bottom:It(.5,0),"bottom-right":It(1,0),left:It(0,.5),center:It(.5,.5),right:It(1,.5),"top-left":It(0,1),top:It(.5,1),"top-right":It(1,1)});function UL(i){switch(i){case"left":return nh.Left;case"right":return nh.Right;default:return nh.Center}}function JO(i){switch(i){case"bottom-left":case"left":case"top-left":return"left";case"bottom":case"center":case"top":return"center";case"bottom-right":case"right":case"top-right":return"right"}}function vq(i){switch(i){case"bottom-left":case"bottom":case"bottom-right":return"bottom";case"left":case"center":case"right":return"center";case"top-left":case"top":case"top-right":return"top"}}function bq(i,e){switch(e){case"bottom":return i==="left"?"bottom-left":i==="right"?"bottom-right":"bottom";case"center":return i;case"top":return i==="left"?"top-left":i==="right"?"top-right":"top"}}function xq(i){return i==="middle"?"center":i}var hs,eR;function Dm(i){return i!=null}function Iu(i){return typeof i=="number"}function Hv(i){return typeof i=="string"}function wq(i){return i==null||Hv(i)}function cr(i,e){i&&i.push(e)}function Tq(i,e,t,r=ce()){const s=i||0,a=e||0,n=t||0;return s!==0&&Bg(r,r,-s/180*Math.PI),a!==0&&Hg(r,r,a/180*Math.PI),n!==0&&nT(r,r,n/180*Math.PI),r}function Tc(i,e,t,r,s){const a=i.minSize,n=i.maxSize;if(i.expression)return cr(s,"Could not convert size info: expression not supported"),!1;if(i.useSymbolValue){const o=r.symbolSize[t];return e.minSize[t]=o,e.maxSize[t]=o,e.offset[t]=e.minSize[t],e.factor[t]=0,e.type[t]=hs.DefinedSize,!0}if(Dm(i.field))return Dm(i.stops)?i.stops.length===2&&Iu(i.stops[0].size)&&Iu(i.stops[1].size)?(tR(i.stops[0].size,i.stops[1].size,i.stops[0].value,i.stops[1].value,e,t),e.type[t]=hs.DefinedSize,!0):(cr(s,"Could not convert size info: stops only supported with 2 elements"),!1):Iu(a)&&Iu(n)&&Dm(i.minDataValue)&&Dm(i.maxDataValue)?(tR(a,n,i.minDataValue,i.maxDataValue,e,t),e.type[t]=hs.DefinedSize,!0):BS[i.valueUnit]!=null?(e.minSize[t]=-1/0,e.maxSize[t]=1/0,e.offset[t]=0,e.factor[t]=1/BS[i.valueUnit],e.type[t]=hs.DefinedSize,!0):i.valueUnit==="unknown"?(cr(s,"Could not convert size info: proportional size not supported"),!1):(cr(s,"Could not convert size info: scale-dependent size not supported"),!1);if(!Dm(i.field)){if(i.stops&&i.stops[0]&&Iu(i.stops[0].size))return e.minSize[t]=i.stops[0].size,e.maxSize[t]=i.stops[0].size,e.offset[t]=e.minSize[t],e.factor[t]=0,e.type[t]=hs.DefinedSize,!0;if(Iu(a))return e.minSize[t]=a,e.maxSize[t]=a,e.offset[t]=a,e.factor[t]=0,e.type[t]=hs.DefinedSize,!0}return cr(s,"Could not convert size info: unsupported variant of sizeInfo"),!1}function tR(i,e,t,r,s,a){const n=Math.abs(r-t)>0?(e-i)/(r-t):0;s.minSize[a]=n>0?i:e,s.maxSize[a]=n>0?e:i,s.offset[a]=i-t*n,s.factor[a]=n}function Cq(i,e,t,r){if(i.normalizationField||i.valueRepresentation)return cr(r,"Could not convert size info: unsupported property"),null;if(!wq(i.field))return cr(r,"Could not convert size info: field is not a string"),null;if(e.size){if(i.field)if(e.size.field){if(i.field!==e.size.field)return cr(r,"Could not convert size info: multiple fields in use"),null}else e.size.field=i.field}else e.size={field:i.field,minSize:[0,0,0],maxSize:[0,0,0],offset:[0,0,0],factor:[0,0,0],type:[hs.Undefined,hs.Undefined,hs.Undefined]};let s;switch(i.axis){case"width":return s=Tc(i,e.size,0,t,r),s?e:null;case"height":return s=Tc(i,e.size,2,t,r),s?e:null;case"depth":return s=Tc(i,e.size,1,t,r),s?e:null;case"width-and-depth":return s=Tc(i,e.size,0,t,r),s&&Tc(i,e.size,1,t,r),s?e:null;case null:case void 0:case"all":return s=Tc(i,e.size,0,t,r),s=s&&Tc(i,e.size,1,t,r),s=s&&Tc(i,e.size,2,t,r),s?e:null;default:return cr(r,`Could not convert size info: unknown axis "${i.axis}""`),null}}function Sq(i,e,t){for(let s=0;s<3;++s){let a=e.unitInMeters;i.type[s]===hs.DefinedSize&&(a*=e.modelSize[s],i.type[s]=hs.DefinedScale),i.minSize[s]=i.minSize[s]/a,i.maxSize[s]=i.maxSize[s]/a,i.offset[s]=i.offset[s]/a,i.factor[s]=i.factor[s]/a}let r;if(i.type[0]!==hs.Undefined)r=0;else if(i.type[1]!==hs.Undefined)r=1;else{if(i.type[2]===hs.Undefined)return cr(t,"No size axis contains a valid size or scale"),!1;r=2}for(let s=0;s<3;++s)i.type[s]===hs.Undefined&&(i.minSize[s]=i.minSize[r],i.maxSize[s]=i.maxSize[r],i.offset[s]=i.offset[r],i.factor[s]=i.factor[r],i.type[s]=i.type[r]);return!0}function iR(i,e,t){i[4*e+0]=t.r/255,i[4*e+1]=t.g/255,i[4*e+2]=t.b/255,i[4*e+3]=t.a}function Pq(i,e,t){if(i.normalizationField)return cr(t,"Could not convert color info: unsupported property"),null;if(Hv(i.field)){if(!i.stops)return cr(t,"Could not convert color info: missing stops or colors"),null;{if(i.stops.length>8)return cr(t,"Could not convert color info: too many color stops"),null;e.color={field:i.field,values:[0,0,0,0,0,0,0,0],colors:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]};const r=i.stops;for(let s=0;s<8;++s){const a=r[Math.min(s,r.length-1)];e.color.values[s]=a.value,iR(e.color.colors,s,a.color)}}}else{if(!(i.stops&&i.stops.length>=0))return cr(t,"Could not convert color info: no field and no colors/stops"),null;{const r=i.stops&&i.stops.length>=0&&i.stops[0].color;e.color={field:null,values:[0,0,0,0,0,0,0,0],colors:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]};for(let s=0;s<8;s++)e.color.values[s]=1/0,iR(e.color.colors,s,r)}}return e}function Oq(i,e,t){if(i.normalizationField)return cr(t,"Could not convert opacity info: unsupported property"),null;if(Hv(i.field)){if(!i.stops)return cr(t,"Could not convert opacity info: missing stops or opacities"),null;{if(i.stops.length>8)return cr(t,"Could not convert opacity info: too many opacity stops"),null;e.opacity={field:i.field,values:[0,0,0,0,0,0,0,0],opacityValues:[0,0,0,0,0,0,0,0]};const r=i.stops;for(let s=0;s<8;++s){const a=r[Math.min(s,r.length-1)];e.opacity.values[s]=a.value,e.opacity.opacityValues[s]=a.opacity}}}else{if(!(i.stops&&i.stops.length>=0))return cr(t,"Could not convert opacity info: no field and no opacities/stops"),null;{const r=i.stops&&i.stops.length>=0?i.stops[0].opacity:0;e.opacity={field:null,values:[0,0,0,0,0,0,0,0],opacityValues:[0,0,0,0,0,0,0,0]};for(let s=0;s<8;s++)e.opacity.values[s]=1/0,e.opacity.opacityValues[s]=r}}return e}function Sb(i,e,t){const r=t===2&&i.rotationType==="arithmetic";e.offset[t]=r?90:0,e.factor[t]=r?-1:1,e.type[t]=1}function Rq(i,e,t){if(!Hv(i.field))return cr(t,"Could not convert rotation info: field is not a string"),null;if(e.rotation){if(i.field)if(e.rotation.field){if(i.field!==e.rotation.field)return cr(t,"Could not convert rotation info: multiple fields in use"),null}else e.rotation.field=i.field}else e.rotation={field:i.field,offset:[0,0,0],factor:[1,1,1],type:[0,0,0]};switch(i.axis){case"tilt":return Sb(i,e.rotation,0),e;case"roll":return Sb(i,e.rotation,1),e;case null:case void 0:case"heading":return Sb(i,e.rotation,2),e;default:return cr(t,`Could not convert rotation info: unknown axis "${i.axis}""`),null}}function VL(i,e,t){if(!i)return null;const r=!e.supportedTypes||!!e.supportedTypes.size,s=!e.supportedTypes||!!e.supportedTypes.color,a=!e.supportedTypes||!!e.supportedTypes.rotation,n=!!e.supportedTypes&&!!e.supportedTypes.opacity,o=i.reduce((l,c)=>{if(!l)return l;if(c.valueExpression)return cr(t,"Could not convert visual variables: arcade expressions not supported"),null;switch(c.type){case"size":return r?Cq(c,l,e,t):l;case"color":return s?Pq(c,l,t):l;case"opacity":return n?Oq(c,l,t):null;case"rotation":return a?Rq(c,l,t):l;default:return null}},{size:null,color:null,opacity:null,rotation:null});return!(i.length>0&&o)||o.size||o.color||o.opacity||o.rotation?o&&o.size&&!Sq(o.size,e,t)?null:o:null}function JC(i){return i&&i.size!=null}function Pf(i,e){if(!i)return{enabled:!1};if(Ot.TESTS_DISABLE_FAST_UPDATES)return{enabled:!1};const t=VL(i.visualVariables,e);return t?{enabled:!0,visualVariables:t,materialParameters:GL(t,e),requiresShaderTransformation:JC(t)}:{enabled:!1}}function Of(i,e,t){if(!e||!i.enabled)return!1;const r=i.visualVariables,s=VL(e.visualVariables,t);return!!s&&!!(X_(r.size,s.size,"size")&&X_(r.color,s.color,"color")&&X_(r.rotation,s.rotation,"rotation")&&X_(r.opacity,s.opacity,"opacity"))&&(i.visualVariables=s,i.materialParameters=GL(s,t),i.requiresShaderTransformation=JC(s),!0)}function X_(i,e,t){if(!!i!=!!e||i&&i.field!==e.field)return!1;if(i&&t==="rotation"){const r=i,s=e;for(let a=0;a<3;a++)if(r.type[a]!==s.type[a]||r.offset[a]!==s.offset[a]||r.factor[a]!==s.factor[a])return!1}return!0}function GL(i,e){const t={vvSizeEnabled:!1,vvSizeMinSize:null,vvSizeMaxSize:null,vvSizeOffset:null,vvSizeFactor:null,vvSizeValue:null,vvColorEnabled:!1,vvColorValues:null,vvColorColors:null,vvOpacityEnabled:!1,vvOpacityValues:null,vvOpacityOpacities:null,vvSymbolAnchor:null,vvSymbolRotationMatrix:null},r=JC(i);return i&&i.size?(t.vvSizeEnabled=!0,t.vvSizeMinSize=i.size.minSize,t.vvSizeMaxSize=i.size.maxSize,t.vvSizeOffset=i.size.offset,t.vvSizeFactor=i.size.factor):i&&r&&(t.vvSizeValue=e.transformation.scale),i&&r&&(t.vvSymbolAnchor=e.transformation.anchor,t.vvSymbolRotationMatrix=ys(),Ad($g),Tq(e.transformation.rotation[2],e.transformation.rotation[0],e.transformation.rotation[1],$g),Xl(t.vvSymbolRotationMatrix,$g)),i&&i.color&&(t.vvColorEnabled=!0,t.vvColorValues=i.color.values,t.vvColorColors=i.color.colors),i&&i.opacity&&(t.vvOpacityEnabled=!0,t.vvOpacityValues=i.opacity.values,t.vvOpacityOpacities=i.opacity.opacityValues),t}function Pw(i,e,t){if(!i.vvSizeEnabled)return t;Kr(Cc,t);const r=i.vvSymbolRotationMatrix;KA($g,r[0],r[1],r[2],0,r[3],r[4],r[5],0,r[6],r[7],r[8],0,0,0,0,1),pr(Cc,Cc,$g);for(let s=0;s<3;++s){const a=i.vvSizeOffset[s]+e[0]*i.vvSizeFactor[s];rR[s]=ee(a,i.vvSizeMinSize[s],i.vvSizeMaxSize[s])}return JA(Cc,Cc,rR),pl(Cc,Cc,i.vvSymbolAnchor),Cc}function Eq(i,e,t){if(!e.vvSizeEnabled)return j(i,1,1,1);for(let r=0;r<3;++r){const s=e.vvSizeOffset[r]+t[0]*e.vvSizeFactor[r];i[r]=ee(s,e.vvSizeMinSize[r],e.vvSizeMaxSize[r])}return i}(function(i){i[i.Undefined=0]="Undefined",i[i.DefinedSize=1]="DefinedSize",i[i.DefinedScale=2]="DefinedScale"})(hs||(hs={})),function(i){i[i.Undefined=0]="Undefined",i[i.DefinedAngle=1]="DefinedAngle"}(eR||(eR={}));const Cc=ce(),rR=T(),$g=ce();let Qp=class{constructor(e,t={}){this.geometry=e,this.boundingSphere=Pt(),this.screenToWorldRatio=1,this._transformation=ce(),this._shaderTransformationDirty=!0,this.id=Up(),this.layerUid=t.layerUid,this.graphicUid=t.graphicUid,this.boundingInfo=t.boundingInfo,this.shaderTransformer=t.shaderTransformer,this.castShadow=!!t.castShadow&&t.castShadow}get transformation(){return this._transformation}updateTransformation(e){e(this._transformation),this._shaderTransformationDirty=!0,this.computeBoundingSphere(this._transformation,this.boundingSphere)}shaderTransformationChanged(){this._shaderTransformationDirty=!0}computeBoundingSphere(e,t,r=Dd(e)){P(this.boundingInfo)||(xe(t,this.boundingInfo.center,e),t[3]=this.boundingInfo.radius*r)}get hasShaderTransformation(){return g(this.shaderTransformer)}get material(){return this.geometry.material}get type(){return this.geometry.type}get shaderTransformation(){return P(this.shaderTransformer)?this.transformation:(this._shaderTransformationDirty&&(this._shaderTransformation||(this._shaderTransformation=ce()),Kr(this._shaderTransformation,this.shaderTransformer(this.transformation)),this._shaderTransformationDirty=!1),this._shaderTransformation)}get indices(){return this.geometry.indices}get vertexAttributes(){return this.geometry.vertexAttributes}get highlights(){return this.geometry.highlights}get occludees(){return this.geometry.occludees}get visible(){return this.geometry.visible}set visible(e){this.geometry.visible=e}};const Aq=ce(),sR=Ge(0,0,1),Mq=16,Dq=1.5,vd=MC,Iq=[vd/2,vd/2,1-vd/2,1-vd/2],Lq=[vf*vd,vf*vd];let Ow=class BL extends _l{getCachedSize(){return{size:this._getIconSize()}}constructor(e,t,r,s){super(e,t,r,s),this._cimLayers=null,this._cimSymbolMaterials=new Map,this._cimSymbolTextures=new Map,this._cimMaterialParametersInfo=null,this._cimRequiredFields=null,this._cimScaleFactorOrFunction=null,this._size=null,this._symbolTextureRatio=1,this._outlineSize=0,this._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!0}}async doLoad(e){this._validateOrThrow();const t=this._prepareMaterialParameters(),r=this._getPrimitive();if(g(r))this._prepareResourcesPrimitive(t,r);else{const s=vN(this.symbolLayer),a=bN(s);a&&a.mediaType==="application/json"?await this._prepareResourcesCIM(t,JSON.parse(a.data),e):await this._prepareResourcesHref(t,s,e)}}_validateOrThrow(){if(this._drivenProperties.size)return;const e=Uv(this._getIconSize());if(e)throw new bt("graphics3diconsymbollayer:invalid-size",e)}_getIconSize(){const e=this.symbolLayer,t=Math.round(e.size!=null?ta(e.size):Mq);return this._drivenProperties.size?Math.max(t,64):t}_generateTextureCIM(e){const t=this._getGraphicHash(e);let r=t===""?null:this._cimSymbolTextures.get(t);if(!r){const s={scaleFactor:this._cimScaleFactorOrFunction},a=this._context.sharedResources.cimSymbolRasterizer.rasterizeCIMSymbol3D(this._cimLayers,e,"esriGeometryPoint",s,void 0,void 0);this._cimMaterialParametersInfo.anchorPosition=this._getAnchorPos("relative",a.anchorPosition);const n={width:a.imageData.width,height:a.imageData.height,powerOfTwoResizeMode:jT.PAD};r=new Bf(a.imageData,n),this._cimSymbolTextures.set(t,r),this._context.stage.add(r)}return r}_computeSize(e,t){const r=e.width/e.height;return r>1?[t,Math.round(t/r)]:[Math.round(t*r),t]}_prepareMaterialParameters(){const e={anchorPosition:this._getAnchorPos(this.symbolLayer.anchor,this.symbolLayer.anchorPosition)},t=this.symbol;if($q(t)){const{screenLength:r,minWorldLength:s,maxWorldLength:a}=t.verticalOffset;e.verticalOffset={screenLength:ta(r),minWorldLength:s||0,maxWorldLength:g(a)?a:1/0}}return this._context.screenSizePerspectiveEnabled&&(e.screenSizePerspective=this._context.sharedResources.screenSizePerspectiveSettings),e.occlusionTest=!0,e.hasSlicePlane=this._context.slicePlaneEnabled,e}_prepareResourcesPrimitive(e,t){const r=this._getOutlineSize();if(Pb(t)&&r===0)throw new Error("Nothing to render");if(this._outlineSize=r,e.color=this._getFillColor(),e.outlineColor=this._getOutlineColor(),e.outlineSize=this._outlineSize,g(this._context.sharedResources.textures)){const a=this._context.sharedResources.textures.fromData(`${t}-icon`,()=>yI(t));this._texture=a.texture,this._releaseTexture=a,e.textureId=this._texture.id}e.textureIsSignedDistanceField=!0,e.distanceFieldBoundingBox=Iq;const s=this._getIconSize();this._size=[s,s],this._symbolTextureRatio=1/vd,this._createMaterialAndAddToStage(e,this._context.stage)}async _prepareResourcesHref(e,t,r){this._outlineSize=this._getOutlineSize(),e.color=this._getFillColor(),e.outlineColor=this._getOutlineColor(),e.outlineSize=this._outlineSize,e.textureIsSignedDistanceField=!1;const s=this._getIconSize(),a=s*this._context.graphicsCoreOwner.view.state.rasterPixelRatio;if(g(this._context.sharedResources.textures)){const n=await ly(this._context.sharedResources.textures.fromUrl(t,a,{signal:r}));if(n.ok===!1)throw xN(n.error),new bt("graphics3diconsymbollayer:request-failed",`Failed to load (Request for icon resource failed: ${t})`);this._releaseTexture=n.value;const o=n.value.texture,l=o.params;this._size=this._computeSize(l,s),e.textureId=o.id}this._createMaterialAndAddToStage(e,this._context.stage)}async _prepareResourcesCIM(e,t,r){const s=new wN({data:t});if(!this._context.sharedResources.cimSymbolRasterizer){const h=(await _e(()=>import("./CIMSymbolRasterizer-ebfa91ff.js"),["assets/CIMSymbolRasterizer-ebfa91ff.js","assets/calcite-8912bd40.js","assets/index-00759e4a.js","assets/index-5026a37a.css","assets/calcite-96fa36fd.css","assets/cimAnalyzer-96bde6b1.js","assets/BidiEngine-836b7ef6.js","assets/GeometryUtils-53652037.js","assets/enums-4b2a86a0.js","assets/alignmentUtils-ae955d28.js","assets/definitions-3ddd14a8.js","assets/number-b10bd8f5.js","assets/Rect-ea14f53a.js","assets/callExpressionWithFeature-df1a8f01.js","assets/quantizationUtils-b3b2ae2a.js","assets/floatRGBA-ca2b39ca.js","assets/CIMResourceManager-f4862aa2.js","assets/Rasterizer-76d04c43.js","assets/_commonjsHelpers-2f3e7994.js","assets/rasterizingUtils-c992e204.js","assets/imageutils-68b5fcaa.js"])).CIMSymbolRasterizer;lr(r),this._context.sharedResources.cimSymbolRasterizer||(this._context.sharedResources.cimSymbolRasterizer=new h(this._context.renderCoordsHelper.spatialReference,!0))}const a=this._context.layer.fields?this._context.layer.fields.map(h=>h.toJSON()):null;let n,o;if(this._cimLayers=await this._context.sharedResources.cimSymbolRasterizer.analyzeCIMSymbol(s,a,this._context.renderer&&this._context.renderer.type==="dictionary"?this._context.renderer.fieldMap:null,"esriGeometryPoint",{signal:r}),this._context.renderer&&this._context.renderer.type==="dictionary"&&this._context.renderer.scaleExpression){const h=this._context.renderer;if(isNaN(h.scaleExpression)){const u=h.scaleExpression,p=await TN(u,this._context.layer.spatialReference,a);o=(m,f,y)=>{const b=q6(p,m,{$view:y},"esriGeometryPoint",f);return b!==null?b:1}}else n=Number(h.scaleExpression)}this._cimScaleFactorOrFunction=n||o||1;const l=this._context.renderer?await this._context.renderer.getRequiredFields(this._context.layer.fieldsIndex):[];lr(r);const c=this._context.layer.fieldsIndex;this._cimRequiredFields=l.map(h=>c.get(h).name),this._cimMaterialParametersInfo=e,this._cimMaterialParametersInfo.color=this._getFillColor(),this._cimMaterialParametersInfo.outlineColor=[0,0,0,0],this._cimMaterialParametersInfo.outlineSize=0,this._cimMaterialParametersInfo.textureIsSignedDistanceField=!1}_getPrimitive(){return this.symbolLayer.resource&&this.symbolLayer.resource.href?null:this.symbolLayer.resource&&this.symbolLayer.resource.primitive||CN}_getOutlineSize(){let e=0;const t=this.symbolLayer;return g(t.outline)&&t.outline.size!=null?Math.max(ta(t.outline.size),0):(e=Pb(this._getPrimitive())?Dq:0,Math.max(e,0))}_getOutlineColor(){const e=this._getLayerOpacity(),t=this.symbolLayer,r=Ur(t,"outline","color");if(g(r)){const s=ui.toUnitRGB(r),a=r.a*e;return[s[0],s[1],s[2],a]}return[0,0,0,0]}_getFillColor(){if(Pb(this._getPrimitive()))return pq;const e=P(this._getPrimitive()),t=Ur(this.symbolLayer,"material","color");return this._getCombinedOpacityAndColor(t,{hasIntrinsicColor:e})}_getAnchorPos(e,t){return e==="relative"?It((t.x||0)+.5,.5-(t.y||0)):e in q0?q0[e]:q0.center}_createMaterialAndAddToStage(e,t){if(this._cimLayers?this._fastUpdates={enabled:!1}:this._fastUpdates=Pf(this._context.renderer,this._fastVisualVariableConvertOptions()),this._fastUpdates.enabled&&Object.assign(e,this._fastUpdates.materialParameters),this._cimLayers){let r=g(e.textureId)?this._cimSymbolMaterials.get(e.textureId):null;return r||(r=new Wp(e),this._cimSymbolMaterials.set(je(e.textureId,0),r),t.add(r)),r}return this._material=new Wp(e),t.add(this._material),this._material}_setDrapingDependentMaterialParameters(){this.draped&&(this._forEachMaterial(e=>{e.setParameters({verticalOffset:null,screenSizePerspective:null,occlusionTest:!1,hasSlicePlane:!1,shaderPolygonOffset:0,isDraped:this.draped})}),this.layerOpacityChanged())}destroy(){super.destroy(),this._forEachMaterial(e=>this._context.stage.remove(e)),this._material=null,this._cimSymbolMaterials.clear(),this._cimSymbolTextures.forEach(e=>this._context.stage.remove(e)),this._cimSymbolTextures.clear(),this._releaseTexture=er(this._releaseTexture)}_getScaleFactor(e,t){if(this._drivenProperties.size&&e.size){for(let r=0;r<3;r++){const s=e.size[r];s&&s!=="symbol-value"&&s!=="proportional"&&(e.size[r]=ta(s))}if(e.size[0]==="symbol-value")return 1;if(isFinite(+e.size[0]))return+e.size[0]/t;if(isFinite(+e.size[2]))return+e.size[2]/t}return 1}createGraphics3DGraphic(e){const t=e.graphic;if(!this._validateGeometry(t.geometry))return null;let r,s=[0,0];if(this._cimLayers){if(!this._cimLayers.length)return null;const u=this._generateTextureCIM(t),p={textureId:u.id,...this._cimMaterialParametersInfo};r=this._createMaterialAndAddToStage(p,this._context.stage),s=[u.params.width,u.params.height]}else s=this._size,r=Si(this._material);const a=wf(t.geometry);if(P(a))return this.logger.warn(`unsupported geometry type for icon symbol: ${t.geometry.type}`),null;const n=e.renderingInfo,o=this._getVertexOpacityAndColor(n);let l=1;if(!this._fastUpdates.enabled||!this._fastUpdates.visualVariables.size){const u=s[0]>s[1]?s[0]:s[1];l=this._getScaleFactor(n,u)}l*=this._symbolTextureRatio;const c=It(s[0]*l,s[1]*l),h=this.setGraphicElevationContext(t,new Po);return this.ensureDrapedStatus(h.mode==="on-the-ground")&&this._setDrapingDependentMaterialParameters(),this.draped?this._createAsOverlay(t,a,r,o,c,e.layer.uid):this._createAs3DShape(t,a,r,o,c,h,t.uid)}layerOpacityChanged(){const e=this._getFillColor(),t=this._getOutlineColor();this._forEachMaterial(r=>{r.setParameters({color:e}),r.setParameters({outlineColor:t})})}layerElevationInfoChanged(e,t,r){const s=this._elevationContext.mode,a=Qf(BL.elevationModeChangeTypes,r,s);if(a!==Oi.UPDATE)return a;const n=Un(s)||s==="absolute-height";return this.updateGraphics3DGraphicElevationInfo(e,t,()=>n)}slicePlaneEnabledChanged(){return this.draped||this._forEachMaterial(e=>{e.setParameters({hasSlicePlane:this._context.slicePlaneEnabled})}),!0}physicalBasedRenderingChanged(){return!0}pixelRatioChanged(){return!!this._getPrimitive()}skipHighSymbolLodsChanged(){return!0}applyRendererDiff(e,t){for(const r in e.diff){if(r!=="visualVariables"||!Of(this._fastUpdates,t,this._fastVisualVariableConvertOptions()))return dr.Recreate_Symbol;g(this._material)&&this._material.setParameters(this._fastUpdates.materialParameters)}return dr.Fast_Update}_defaultElevationInfoNoZ(){return Nq}_createAs3DShape(e,t,r,s,a,n,o){const l=this.getFastUpdateAttrValues(e),c=l?y=>Pw(this._fastUpdates.materialParameters,l,y):void 0,h=this._context.layer.uid,u=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:o,layerUid:h}),p=Kx(r,sR,null,s,a,Fq,null,l,u),m=VC(this._context,t,p,n,o,c);if(P(m))return null;const f=new fl(this,m.object,[p],null,null,bf,n);return f.alignedSampledElevation=m.sampledElevation,f.needsElevationUpdates=Un(n.mode)||n.mode==="absolute-height",f.getScreenSize=this._createScreenSizeGetter(a,c),f.calculateRelativeScreenBounds=y=>r.calculateRelativeScreenBounds(f.getScreenSize(),1,y),xf(f,t,this._context.elevationProvider),f}_createAsOverlay(e,t,r,s,a,n){r.renderPriority=this._renderPriority;const o=Pt();ts(t,o,this._context.overlaySR),o[2]=ZC;const l=this._context.clippingExtent;if(g(l)&&!mT(l,o))return null;const c=this.getFastUpdateAttrValues(e),h=c?y=>Pw(this._fastUpdates.materialParameters,c,y):void 0,u=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:e.uid,layerUid:this._context.layer.uid}),p=Kx(r,sR,o,s,a,null,null,c,u),m=new Qp(p,{layerUid:n,graphicUid:e.uid,shaderTransformer:h});o[3]=0,Zc(m.boundingSphere,o);const f=new Bv(this,[m],null,this._context.drapeSourceRenderer);return f.getScreenSize=this._createScreenSizeGetter(a,h),f.calculateRelativeScreenBounds=y=>r.calculateRelativeScreenBounds(f.getScreenSize(),1,y),f}_createScreenSizeGetter(e,t){const r=this._outlineSize+2;if(this._fastUpdates.enabled){const s=e[0]/this._symbolTextureRatio,a=e[1]/this._symbolTextureRatio;return(n=$e())=>{const o=t(Aq);return n[0]=o[0]*s+r,n[1]=o[5]*a+r,n}}{const s=e[0]/this._symbolTextureRatio+r,a=e[1]/this._symbolTextureRatio+r;return(n=$e())=>(n[0]=s,n[1]=a,n)}}_fastVisualVariableConvertOptions(){const e=this._size[0]>this._size[1]?this._size[0]:this._size[1],t=Ge(e,e,e),r=vx(1),s=e*r;return{modelSize:t,symbolSize:Ge(s,s,s),unitInMeters:r,transformation:{anchor:on,scale:Yc,rotation:on}}}_getGraphicHash(e){let t="";for(const r of this._cimRequiredFields)t+=r+e.attributes[r];return t}_forEachMaterial(e){g(this._material)&&e(this._material),this._cimSymbolMaterials.forEach(e)}test(){return{...super.test(),material:this._material}}};function $q(i){return i&&i.type==="point-3d"&&i.hasVisibleVerticalOffset()}function Pb(i){return!P(i)&&(i==="cross"||i==="x")}Ow.PRIMITIVE_SIZE=Lq,Ow.elevationModeChangeTypes={definedChanged:Oi.UPDATE,staysOnTheGround:Oi.NONE,onTheGroundChanged:Oi.RECREATE};const Nq={mode:"relative-to-ground",offset:0},Fq=hi(0,0,0,1);function Rw(i){switch(i){case"butt":return $n.BUTT;case"square":return $n.SQUARE;case"round":return $n.ROUND;default:return null}}function zq(i){return i==="diamond"?"kite":i}function Ew(i,e,t=null){const r=[],s=[],a=e.mapPositions;Uq(e,s,r);const n=s[0][1].data,o=r[0][1].length,l=new Array(o).fill(0);return Vq(e,s,r,l),Hq(e,s,r,l),Gq(e,s,r,l),Bq(e,s,r,l),kq(e,s,r,l),jq(e,s,r,l),qq(e,s,r,n),new Cr(i,s,r,a,ps.Line,t)}function Uq(i,e,t){const{attributeData:{position:r},removeDuplicateStartEnd:s}=i,a=Wq(r)&&s,n=r.length/3-(a?1:0),o=new Array(2*(n-1)),l=a?r.slice(0,r.length-3):r;let c=0;for(let h=0;h<n-1;h++)o[c++]=h,o[c++]=h+1;e.push([w.POSITION,new be(l,3,a)]),t.push([w.POSITION,o])}function Vq(i,e,t,r){if(g(i.attributeData.colorFeature))return;const s=i.attributeData.color;e.push([w.COLOR,new be(je(s,no),4)]),t.push([w.COLOR,r])}function Gq(i,e,t,r){if(!g(i.attributeData.normal))return;const s=i.attributeData.normal;e.push([w.NORMAL,new be(s,3)]),t.push([w.NORMAL,r])}function Bq(i,e,t,r){const s=i.attributeData.colorFeature;P(s)||(e.push([w.COLORFEATUREATTRIBUTE,new be([s],1,!0)]),t.push([w.COLOR,r]))}function Hq(i,e,t,r){if(g(i.attributeData.sizeFeature))return;const s=i.attributeData.size;e.push([w.SIZE,new be([je(s,1)],1,!0)]),t.push([w.SIZE,r])}function kq(i,e,t,r){const s=i.attributeData.sizeFeature;P(s)||(e.push([w.SIZEFEATUREATTRIBUTE,new be([s],1,!0)]),t.push([w.SIZEFEATUREATTRIBUTE,r]))}function jq(i,e,t,r){const s=i.attributeData.opacityFeature;P(s)||(e.push([w.OPACITYFEATUREATTRIBUTE,new be([s],1,!0)]),t.push([w.OPACITYFEATUREATTRIBUTE,r]))}function qq(i,e,t,r){if(P(i.overlayInfo)||i.overlayInfo.renderCoordsHelper.viewingMode!==ve.Global||!i.overlayInfo.spatialReference.isGeographic)return;const s=Fn(r.length),a=Et(i.overlayInfo.spatialReference);for(let p=0;p<s.length;p+=3)e3(r,p,s,p,a);const n=r.length/3,o=zi(n+1);let l=Xq,c=Qq,h=0,u=0;j(l,s[u++],s[u++],s[u++]),o[0]=0;for(let p=1;p<n+1;++p)p===n&&(u=0),j(c,s[u++],s[u++],s[u++]),h+=SN(l,c),o[p]=h,[l,c]=[c,l];e.push([w.DISTANCETOSTART,new be(o,1,!0)]),t.push([w.DISTANCETOSTART,t[0][1]])}function Wq(i){const e=i.length;return i[0]===i[e-3]&&i[1]===i[e-2]&&i[2]===i[e-1]}const Xq=T(),Qq=T();function qoe(i,e){if(P(i)||i.length===0)return[];const t=[];return i.forEach(r=>{const s=r.length,a=Fn(3*s);r.forEach((o,l)=>{a[3*l+0]=o[0],a[3*l+1]=o[1],a[3*l+2]=o[2]});const n={attributeData:{position:a,normal:e},removeDuplicateStartEnd:!1};t.push(n)}),t}function Zq(i,e,t,r){const s=i.type==="polygon"?Bp.CCW_IS_HOLE:Bp.NONE,a=i.type==="polygon"?i.rings:i.paths,{position:n,outlines:o}=wv(a,!!i.hasZ,s),l=Fn(n.length),c=$I(n,i.spatialReference,0,l,0,n,0,n.length/3,e,t,r),h=c!=null;return{lines:h?HL(o,n,l):[],projectionSuccess:h,sampledElevation:c}}function Yq(i,e){const t=i.type==="polygon"?Bp.CCW_IS_HOLE:Bp.NONE,r=i.type==="polygon"?i.rings:i.paths,{position:s,outlines:a}=wv(r,!1,t),n=ha(s,i.spatialReference,0,s,e,0,s.length/3);for(let o=2;o<s.length;o+=3)s[o]=ZC;return{lines:n?HL(a,s):[],projectionSuccess:n}}function HL(i,e,t=null){const r=new Array;for(const{index:s,count:a}of i){if(a<=1)continue;const n=3*s,o=3*a;r.push({position:mo(e,3*s,3*a),mapPositions:g(t)?mo(t,n,o):void 0})}return r}function Kq(i){const e=new $t,t=i.hasMultipassTerrain&&(i.output===A.Color||i.output===A.Alpha),r=i.space===Ln.World;i.hasTip&&r&&e.extensions.add("GL_OES_standard_derivatives"),e.include(oL,i),e.include(mL,i),i.output===A.Depth&&e.include(gh,i);const{vertex:s,fragment:a}=e;return a.include(To),nc(s,i),e.attributes.add(w.POSITION,"vec3"),e.attributes.add(w.UV0,"vec2"),e.attributes.add(w.AUXPOS1,"vec3"),e.varyings.add("vColor","vec4"),e.varyings.add("vpos","vec3"),e.varyings.add("vUV","vec2"),e.varyings.add("vSize","float"),Gp(e),t&&e.varyings.add("depth","float"),i.hasTip&&e.varyings.add("vLineWidth","float"),s.uniforms.add([new pi("nearFar",(n,o)=>o.camera.nearFar),new ai("viewport",(n,o)=>o.camera.fullViewport)]),s.code.add(_`vec4 projectAndScale(vec4 pos) {
vec4 posNdc = proj * pos;
posNdc.xy *= viewport.zw / posNdc.w;
return posNdc;
}`),s.code.add(_`void clip(vec4 pos, inout vec4 prev) {
float vnp = nearFar[0] * 0.99;
if (prev.z > -nearFar[0]) {
float interpolation = (-vnp - pos.z) / (prev.z - pos.z);
prev = mix(pos, prev, interpolation);
}
}`),r?(e.attributes.add(w.NORMAL,"vec3"),Zg(s),s.constants.add("tiltThreshold","float",.7),s.code.add(_`vec3 perpendicular(vec3 v) {
vec3 n = (viewNormal * vec4(normal.xyz, 1.0)).xyz;
vec3 n2 = cross(v, n);
vec3 forward = vec3(0.0, 0.0, 1.0);
float tiltDot = dot(forward, n);
return abs(tiltDot) < tiltThreshold ? n : n2;
}`)):s.code.add(_`vec2 perpendicular(vec2 v) {
return vec2(v.y, -v.x);
}`),s.code.add(_`
      #define vecN ${r?"vec3":"vec2"}

      vecN normalizedSegment(vecN pos, vecN prev) {
        vecN segment = pos - prev;
        float segmentLen = length(segment);

        // normalize or zero if too short
        return (segmentLen > 0.001) ? segment / segmentLen : ${r?"vec3(0.0, 0.0, 0.0)":"vec2(0.0, 0.0)"};
      }

      vecN displace(vecN pos, vecN prev, float displacementLen) {
        vecN segment = normalizedSegment(pos, prev);

        vecN displacementDirU = perpendicular(segment);
        vecN displacementDirV = segment;

        ${i.anchor===Fd.Tip?"pos -= 0.5 * displacementLen * displacementDirV;":""}

        return pos + displacementLen * (uv0.x * displacementDirU + uv0.y * displacementDirV);
      }
    `),i.space===Ln.Screen&&(s.uniforms.add(new ir("inverseProjectionMatrix",(n,o)=>o.camera.inverseProjectionMatrix)),s.code.add(_`vec3 inverseProject(vec4 posScreen) {
posScreen.xy = (posScreen.xy / viewport.zw) * posScreen.w;
return (inverseProjectionMatrix * posScreen).xyz;
}`),s.code.add(_`bool rayIntersectPlane(vec3 rayDir, vec3 planeOrigin, vec3 planeNormal, out vec3 intersection) {
float cos = dot(rayDir, planeNormal);
float t = dot(planeOrigin, planeNormal) / cos;
intersection = t * rayDir;
return abs(cos) > 0.001 && t > 0.0;
}`),s.uniforms.add(new ue("perScreenPixelRatio",(n,o)=>o.camera.perScreenPixelRatio)),s.code.add(_`
      vec4 toFront(vec4 displacedPosScreen, vec3 posLeft, vec3 posRight, vec3 prev, float lineWidth) {
        // Project displaced position back to camera space
        vec3 displacedPos = inverseProject(displacedPosScreen);

        // Calculate the plane that we want the marker to lie in. Note that this will always be an approximation since ribbon lines are generally
        // not planar and we do not know the actual position of the displaced prev vertices (they are offset in screen space, too).
        vec3 planeNormal = normalize(cross(posLeft - posRight, posLeft - prev));
        vec3 planeOrigin = posLeft;

        ${i.hasCap?`
                if(prev.z > posLeft.z) {
                  vec2 diff = posLeft.xy - posRight.xy;
                  planeOrigin.xy += perpendicular(diff) / 2.0;
                }
              `:""};

        // Move the plane towards the camera by a margin dependent on the line width (approximated in world space). This tolerance corrects for the
        // non-planarity in most cases, but sharp joins can place the prev vertices at arbitrary positions so markers can still clip.
        float offset = lineWidth * perScreenPixelRatio;
        planeOrigin *= (1.0 - offset);

        // Intersect camera ray with the plane and make sure it is within clip space
        vec3 rayDir = normalize(displacedPos);
        vec3 intersection;
        if (rayIntersectPlane(rayDir, planeOrigin, planeNormal, intersection) && intersection.z < -nearFar[0] && intersection.z > -nearFar[1]) {
          return vec4(intersection.xyz, 1.0);
        }

        // Fallback: use depth of pos or prev, whichever is closer to the camera
        float minDepth = planeOrigin.z > prev.z ? length(planeOrigin) : length(prev);
        displacedPos *= minDepth / length(displacedPos);
        return vec4(displacedPos.xyz, 1.0);
      }
  `)),s.uniforms.add(new ue("pixelRatio",(n,o)=>o.camera.pixelRatio)),L3(e),s.code.add(_`void main(void) {
if (uv0.y == 0.0) {
gl_Position = vec4(1e038, 1e038, 1e038, 1.0);
}
else {
float lineWidth = getLineWidth();
float screenMarkerSize = getScreenMarkerSize();
vec4 pos  = view * vec4(position.xyz, 1.0);
vec4 prev = view * vec4(auxpos1.xyz, 1.0);
clip(pos, prev);`),r?(i.hideOnShortSegments&&s.code.add(_`if (areWorldMarkersHidden(pos, prev)) {
gl_Position = vec4(1e038, 1e038, 1e038, 1.0);
return;
}`),s.code.add(_`pos.xyz = displace(pos.xyz, prev.xyz, getWorldMarkerSize(pos));
vec4 displacedPosScreen = projectAndScale(pos);`)):(s.code.add(_`vec4 posScreen = projectAndScale(pos);
vec4 prevScreen = projectAndScale(prev);
vec4 displacedPosScreen = posScreen;
displacedPosScreen.xy = displace(posScreen.xy, prevScreen.xy, screenMarkerSize);`),i.space===Ln.Screen&&s.code.add(_`vec2 displacementDirU = perpendicular(normalizedSegment(posScreen.xy, prevScreen.xy));
vec3 lineRight = inverseProject(posScreen + lineWidth * vec4(displacementDirU.xy, 0.0, 0.0));
vec3 lineLeft = pos.xyz + (pos.xyz - lineRight);
pos = toFront(displacedPosScreen, lineLeft, lineRight, prev.xyz, lineWidth);
displacedPosScreen = projectAndScale(pos);`)),s.code.add(_`
        ${t?"depth = pos.z;":""}
        linearDepth = calculateLinearDepth(nearFar,pos.z);

        // Convert back into NDC
        displacedPosScreen.xy = (displacedPosScreen.xy / viewport.zw) * displacedPosScreen.w;

        // Convert texture coordinate into [0,1]
        vUV = (uv0 + 1.0) / 2.0;

        ${r?"":"vUV *= displacedPosScreen.w;"}

        ${i.hasTip?"vLineWidth = lineWidth;":""}

        vSize = screenMarkerSize;
        vColor = getColor();

        // Use camera space for slicing
        vpos = pos.xyz;

        gl_Position = displacedPosScreen;
      }
    }
  `),t&&e.include(Yl,i),e.include(Qr,i),a.uniforms.add([new ai("intrinsicColor",n=>n.color),new lt("tex",n=>n.texture)]),a.include(rc),e.constants.add("texelSize","float",1/Cf),a.code.add(_`float markerAlpha(vec2 samplePos) {
samplePos += vec2(0.5, -0.5) * texelSize;
float sdf = rgba2float(texture2D(tex, samplePos)) - 0.5;
float distance = sdf * vSize;
distance -= 0.5;
return clamp(0.5 - distance, 0.0, 1.0);
}`),i.hasTip&&(e.constants.add("relativeMarkerSize","float",HC/Cf),e.constants.add("relativeTipLineWidth","float",oj),a.code.add(_`
    float tipAlpha(vec2 samplePos) {
      // Convert coordinates s.t. they are in pixels and relative to the tip of an arrow marker
      samplePos -= vec2(0.5, 0.5 + 0.5 * relativeMarkerSize);
      samplePos *= vSize;

      float halfMarkerSize = 0.5 * relativeMarkerSize * vSize;
      float halfTipLineWidth = 0.5 * max(1.0, relativeTipLineWidth * vLineWidth);

      ${r?"halfTipLineWidth *= fwidth(samplePos.y);":""}

      float distance = max(abs(samplePos.x) - halfMarkerSize, abs(samplePos.y) - halfTipLineWidth);
      return clamp(0.5 - distance, 0.0, 1.0);
    }
  `)),e.constants.add("symbolAlphaCutoff","float",ra),a.code.add(_`
  void main() {
    discardBySlice(vpos);
    ${t?"terrainDepthTest(gl_FragCoord, depth);":""}

    vec4 finalColor = intrinsicColor * vColor;

    ${r?"vec2 samplePos = vUV;":"vec2 samplePos = vUV * gl_FragCoord.w;"}

    ${i.hasTip?"finalColor.a *= max(markerAlpha(samplePos), tipAlpha(samplePos));":"finalColor.a *= markerAlpha(samplePos);"}

    ${i.output===A.ObjectAndLayerIdColor?_`finalColor.a = 1.0;`:""}

    if (finalColor.a < symbolAlphaCutoff) {
      discard;
    }

    ${i.output===A.Alpha?_`gl_FragColor = vec4(finalColor.a);`:""}
    ${i.output===A.Color?_`gl_FragColor = highlightSlice(finalColor, vpos);`:""}
    ${i.output===A.Color&&i.transparencyPassType===We.Color?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}
    ${i.output===A.Highlight?_`gl_FragColor = vec4(1.0);`:""}
    ${i.output===A.Depth?_`outputDepth(linearDepth);`:""}
  }
  `),e}const Jq=Object.freeze(Object.defineProperty({__proto__:null,build:Kq},Symbol.toStringTag,{value:"Module"})),kL=new Map([[w.POSITION,0],[w.UV0,2],[w.AUXPOS1,3],[w.NORMAL,4],[w.COLOR,5],[w.COLORFEATUREATTRIBUTE,5],[w.SIZE,6],[w.SIZEFEATUREATTRIBUTE,6],[w.OPACITYFEATUREATTRIBUTE,7]]);let jL=class qL extends Mt{initializeProgram(e){return new Rt(e.rctx,qL.shader.get().build(this.configuration),kL)}_makePipelineState(e,t){const r=this.configuration,s=e===We.NONE;return qe({blending:r.output===A.Color||r.output===A.Alpha?s?In:Ph(e):null,depthTest:{func:Xd(e)},depthWrite:s?r.writeDepth?cn:null:bv(e),colorWrite:at,stencilWrite:r.hasOccludees?Kl:null,stencilTest:r.hasOccludees?t?Md:Wd:null,polygonOffset:{factor:0,units:-10}})}initializePipeline(){return this.configuration.occluder&&(this._occluderPipelineTransparent=qe({blending:In,depthTest:py,depthWrite:null,colorWrite:at,stencilWrite:null,stencilTest:$3}),this._occluderPipelineOpaque=qe({blending:In,depthTest:py,depthWrite:null,colorWrite:at,stencilWrite:N3,stencilTest:F3}),this._occluderPipelineMaskWrite=qe({blending:null,depthTest:IT,depthWrite:null,colorWrite:null,stencilWrite:Kl,stencilTest:Md})),this._occludeePipelineState=this._makePipelineState(this.configuration.transparencyPassType,!0),this._makePipelineState(this.configuration.transparencyPassType,!1)}getPipelineState(e,t){return t?this._occludeePipelineState:this.configuration.occluder?e===K.TRANSPARENT_OCCLUDER_MATERIAL?this._occluderPipelineTransparent:e===K.OCCLUDER_MATERIAL?this._occluderPipelineOpaque:this._occluderPipelineMaskWrite:super.getPipelineState(e,t)}};jL.shader=new Dt(Jq,()=>_e(()=>import("./LineMarker.glsl-5c46ac87.js"),["assets/LineMarker.glsl-5c46ac87.js","assets/calcite-8912bd40.js","assets/index-00759e4a.js","assets/index-5026a37a.css","assets/calcite-96fa36fd.css","assets/floatRGBA-ca2b39ca.js","assets/objectResourceUtils-782953c3.js","assets/devEnvironmentUtils-5002a058.js","assets/mat3f64-50f3b9f6.js","assets/mat4f64-abdda1bb.js","assets/BufferView-379a78a4.js","assets/vec33-69c9e93b.js","assets/DefaultMaterial_COLOR_GAMMA-6ed76d86.js","assets/types-e1c0a5bf.js","assets/enums-e2e92c86.js","assets/Version-aa0a1d91.js","assets/quat-7b70e9a8.js","assets/quatf64-f8f1c132.js","assets/resourceUtils-527631ac.js","assets/basicInterfaces-7449a8bf.js","assets/Indices-d8bff7b2.js","assets/NestedMap-1b5db22e.js","assets/requestImageUtils-d1ba3b36.js","assets/symbolColorUtils-c9d24716.js","assets/Util-6d3f024a.js","assets/sphere-d0e5285d.js","assets/VertexAttribute-15d1866a.js","assets/doublePrecisionUtils-e3c3d0d8.js","assets/OrderIndependentTransparency-5f7257d7.js","assets/Texture-563cf5e5.js","assets/FramebufferObject-8b18fc0c.js","assets/VertexElementDescriptor-2925c6af.js","assets/InterleavedLayout-d57c91d0.js","assets/vec3f32-01c06d8d.js","assets/plane-5e2b046c.js","assets/spatialReferenceEllipsoidUtils-afb35af9.js","assets/scaleUtils-d13015f2.js","assets/ElevationSamplerData-e3118b17.js","assets/Octree-499541ed.js","assets/edgeProcessing-20e12367.js","assets/deduplicate-769a6f51.js","assets/MeshComponent-788e605a.js","assets/earcut-61f7b102.js","assets/imageUtils-c2d0d1ae.js","assets/projection-5969b753.js","assets/ZoomMomentumEstimator-ef57e6a4.js","assets/dehydratedFeatures-3a140d03.js","assets/quantizationUtils-b3b2ae2a.js","assets/labelFormatUtils-71e1f841.js","assets/orientedBoundingBox-a14b97b5.js","assets/quatf32-51a323b8.js","assets/SnappingCandidate-970faec6.js","assets/callExpressionWithFeature-df1a8f01.js","assets/DefaultVertexAttributeLayouts-5f20d8dd.js","assets/geometryServiceUtils-a536bb19.js","assets/project-909a4219.js","assets/LercDecoder-65586d50.js","assets/VectorTile-d41a1f0f.js","assets/enums-fb086c25.js","assets/config-1337d16e.js","assets/TiledDisplayObject-419c008b.js","assets/DisplayObject-87c37b69.js","assets/rasterUtils-7694cc98.js","assets/resources-7587d8f4.js","assets/workerHelper-6131d203.js","assets/webgl-debug-7f880832.js","assets/RenderingContext-0f21aa0e.js","assets/ProgramCache-f29c900e.js","assets/Program-77209250.js","assets/MediaLayer-4c42fc2f.js","assets/MediaElementView-06baa4d4.js","assets/normalizeUtilsSync-3ea564a9.js","assets/resourceExtension-f31d9f10.js","assets/BoundsStore-00da37da.js","assets/PooledRBush-5a11bc7e.js","assets/prism-line-numbers-eff41b13.js","assets/label2-a2f37e65.js","assets/interactive-1de2e238.js","assets/loadable-6afd516d.js","assets/t9n-81df3a71.js","assets/observers-c89705b8.js","assets/icon-8e47fbec.js","assets/loader-c773e800.js","assets/guid-51402ee7.js","assets/prism-line-numbers-7c5d72ff.css"]));let eW=class extends jd{constructor(e){super(e,new iW),this._vertexAttributeLocations=kL,this._configuration=new Ir,this._layout=this.createLayout()}dispose(){}getConfiguration(e,t){return this._configuration.output=e,this._configuration.space=t.slot===K.DRAPED_MATERIAL?Ln.Draped:this.parameters.worldSpace?Ln.World:Ln.Screen,this._configuration.hideOnShortSegments=this.parameters.hideOnShortSegments,this._configuration.hasCap=this.parameters.cap!==$n.BUTT,this._configuration.anchor=this.parameters.anchor,this._configuration.hasTip=this.parameters.hasTip,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.hasOccludees=this.parameters.hasOccludees,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.vvColor=this.parameters.vvColorEnabled,this._configuration.vvOpacity=this.parameters.vvOpacityEnabled,this._configuration.vvSize=this.parameters.vvSizeEnabled,this._configuration.occluder=this.parameters.renderOccluded===qi.OccludeAndTransparentStencil,this._configuration.transparencyPassType=t.transparencyPassType,this._configuration.hasMultipassTerrain=t.multipassTerrain.enabled,this._configuration.cullAboveGround=t.multipassTerrain.cullAboveGround,this._configuration}intersect(){}createLayout(){const e=mr().vec3f(w.POSITION).vec2f(w.UV0).vec3f(w.AUXPOS1);return this.parameters.worldSpace&&e.vec3f(w.NORMAL),this.parameters.vvSizeEnabled?e.f32(w.SIZEFEATUREATTRIBUTE):e.f32(w.SIZE),this.parameters.vvColorEnabled?e.f32(w.COLORFEATUREATTRIBUTE):e.vec4f(w.COLOR),this.parameters.vvOpacityEnabled&&e.f32(w.OPACITYFEATUREATTRIBUTE),e}createBufferWriter(){return new rW(this._layout,this.parameters)}requiresSlot(e,t){return t===A.Color||t===A.Alpha||t===A.Highlight||t===A.Depth?e===K.DRAPED_MATERIAL?!0:this.parameters.renderOccluded===qi.OccludeAndTransparentStencil?e===K.OPAQUE_MATERIAL||e===K.OCCLUDER_MATERIAL||e===K.TRANSPARENT_OCCLUDER_MATERIAL:t===A.Color||t===A.Alpha?e===(this.parameters.writeDepth?K.TRANSPARENT_MATERIAL:K.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL):e===K.OPAQUE_MATERIAL:!1}createGLMaterial(e){return new tW(e)}},tW=class extends A3{_updateParameters(e){return this.updateTexture(this._material.parameters.textureId),this._material.setParameters(this.textureBindParameters),this.ensureTechnique(jL,e)}_updateOccludeeState(e){e.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:e.hasOccludees})}beginSlot(e){return this._output!==A.Color&&this._output!==A.Alpha||this._updateOccludeeState(e),this._updateParameters(e)}},iW=class extends LT{constructor(){super(...arguments),this.width=0,this.color=[1,1,1,1],this.placement="end",this.cap=$n.BUTT,this.anchor=Fd.Center,this.hasTip=!1,this.worldSpace=!1,this.hideOnShortSegments=!1,this.writeDepth=!0,this.hasSlicePlane=!1,this.vvFastUpdate=!1,this.hasOccludees=!1}},rW=class{constructor(e,t){this.vertexBufferLayout=e,this._parameters=t}allocate(e){return this.vertexBufferLayout.createBuffer(e)}elementCount(){return this._parameters.placement==="begin-end"?12:6}write(e,t,r,s,a){const n=r.vertexAttributes.get(w.POSITION).data,o=n.length/3;let l=[1,0,0];const c=r.vertexAttributes.get(w.NORMAL);this._parameters.worldSpace&&g(c)&&(l=c.data);let h=1,u=0;this._parameters.vvSizeEnabled?u=r.vertexAttributes.get(w.SIZEFEATUREATTRIBUTE).data[0]:r.vertexAttributes.has(w.SIZE)&&(h=r.vertexAttributes.get(w.SIZE).data[0]);let p=[1,1,1,1],m=0;this._parameters.vvColorEnabled?m=r.vertexAttributes.get(w.COLORFEATUREATTRIBUTE).data[0]:r.vertexAttributes.has(w.COLOR)&&(p=r.vertexAttributes.get(w.COLOR).data);let f=0;this._parameters.vvOpacityEnabled&&(f=r.vertexAttributes.get(w.OPACITYFEATUREATTRIBUTE).data[0]);const y=new Float32Array(s.buffer);let b=a*(this.vertexBufferLayout.stride/4);const x=(R,E,$,M)=>{if(y[b++]=R[0],y[b++]=R[1],y[b++]=R[2],y[b++]=$[0],y[b++]=$[1],y[b++]=E[0],y[b++]=E[1],y[b++]=E[2],this._parameters.worldSpace&&(y[b++]=l[0],y[b++]=l[1],y[b++]=l[2]),this._parameters.vvSizeEnabled?y[b++]=u:y[b++]=h,this._parameters.vvColorEnabled)y[b++]=m;else{const L=Math.min(4*M,p.length-4);y[b++]=p[L+0],y[b++]=p[L+1],y[b++]=p[L+2],y[b++]=p[L+3]}this._parameters.vvOpacityEnabled&&(y[b++]=f)};let S;(function(R){R[R.ASCENDING=1]="ASCENDING",R[R.DESCENDING=-1]="DESCENDING"})(S||(S={}));const C=(R,E)=>{const $=j(sW,n[3*R],n[3*R+1],n[3*R+2]),M=aW;let L=R+E;do j(M,n[3*L],n[3*L+1],n[3*L+2]),L+=E;while(Ed($,M)&&L>=0&&L<o);e&&(xe($,$,e),xe(M,M,e)),x($,M,[-1,-1],R),x($,M,[1,-1],R),x($,M,[1,1],R),x($,M,[-1,-1],R),x($,M,[1,1],R),x($,M,[-1,1],R)},O=this._parameters.placement;O!=="begin"&&O!=="begin-end"||C(0,S.ASCENDING),O!=="end"&&O!=="begin-end"||C(o-1,S.DESCENDING)}};const sW=T(),aW=T(),ns={dash:[4,3],dot:[1,3],"long-dash":[8,3],"short-dash":[4,1],"short-dot":[1,1]},nW={dash:ns.dash,"dash-dot":[...ns.dash,...ns.dot],dot:ns.dot,"long-dash":ns["long-dash"],"long-dash-dot":[...ns["long-dash"],...ns.dot],"long-dash-dot-dot":[...ns["long-dash"],...ns.dot,...ns.dot],none:null,"short-dash":ns["short-dash"],"short-dash-dot":[...ns["short-dash"],...ns["short-dot"]],"short-dash-dot-dot":[...ns["short-dash"],...ns["short-dot"],...ns["short-dot"]],"short-dot":ns["short-dot"],solid:null},oW=8;function lW(i,e=2){return P(i)?i:{pattern:i.slice(),pixelRatio:e}}function Yoe(i,e=2){return{pattern:[i,i],pixelRatio:e}}function WL(i){return g(i)&&i.type==="style"?cW(i.style):null}function cW(i){return g(i)?lW(nW[i],oW):null}const hW=["polyline","polygon","extent"];let XL=class QL extends _l{constructor(e,t,r,s){super(e,t,r,s)}async doLoad(){if(this._vvConvertOptions={modelSize:[1,1,1],symbolSize:[1,1,1],unitInMeters:1,transformation:{anchor:[0,0,0],scale:[1,1,1],rotation:[0,0,0]},supportedTypes:{size:!0,color:!0,opacity:!0,rotation:!1}},this._context.renderer&&this._context.renderer.visualVariables&&this._context.renderer.visualVariables.length>0?this._fastUpdates=Pf(this._context.renderer,this._vvConvertOptions):this._fastUpdates={enabled:!1},!this._drivenProperties.size&&(this.symbolLayer.size!=null?this.symbolLayer.size:vx(1))<0)throw new bt("graphics3dlinesymbollayer:invalid-size","Symbol sizes may not be negative values");this._markerTexture=g(this.symbolLayer.marker)&&g(this._context.sharedResources.textures)?lj(this._context.sharedResources.textures,zq(this.symbolLayer.marker.style)):null}_getMaterialParameters(e,t=!1){var a;const r=this._getCombinedOpacityAndColor(t&&this._markerColor||this._materialColor);this._patternHidesLine&&!t&&(r[3]=0);const s={width:this._computeMaterialWidth((a=this.symbolLayer)==null?void 0:a.size),color:r,hasPolygonOffset:!0,join:this.symbolLayer.join||"miter",cap:Rw(this.symbolLayer.cap||"butt"),hasSlicePlane:this._context.slicePlaneEnabled,isClosed:e,stipplePattern:WL(this.symbolLayer.pattern),stippleScaleWithLineWidth:!0};return this._fastUpdates&&this._fastUpdates.visualVariables?{...s,...this._fastUpdates.materialParameters}:s}get _materialColor(){return th(this.symbolLayer.material,e=>e.color)}get _markerColor(){return th(this.symbolLayer.marker,e=>e.color)}get _lineMaterial(){return P(this._lineMaterialCached)&&(this._lineMaterialCached=new yp(this._getMaterialParameters(!1)),this._context.stage.add(this._lineMaterialCached)),this._lineMaterialCached}get _ringMaterial(){return P(this._ringMaterialCached)&&(this._ringMaterialCached=new yp(this._getMaterialParameters(!0)),this._context.stage.add(this._ringMaterialCached)),this._ringMaterialCached}get _wireframeLineMaterial(){return P(this._wireframeLineMaterialCached)&&(this._wireframeLineMaterialCached=new yp({...this._getMaterialParameters(!1),wireframe:!0}),this._context.stage.add(this._wireframeLineMaterialCached)),this._wireframeLineMaterialCached}get _wireframeRingMaterial(){return P(this._wireframeRingMaterialCached)&&(this._wireframeRingMaterialCached=new yp({...this._getMaterialParameters(!0),wireframe:!0}),this._context.stage.add(this._wireframeRingMaterialCached)),this._wireframeRingMaterialCached}get _markerMaterial(){return P(this._markerMaterialCached)&&g(this.symbolLayer.marker)&&g(this._markerTexture)&&(this._markerMaterialCached=new eW({...this._getMaterialParameters(!1,!0),placement:this.symbolLayer.marker.placement,textureId:this._markerTexture.texture.id}),this._context.stage.add(this._markerMaterialCached)),this._markerMaterialCached}destroy(){super.destroy(),this._forEachMaterial(e=>this._context.stage.remove(e)),this._lineMaterialCached=null,this._ringMaterialCached=null,this._wireframeLineMaterialCached=null,this._wireframeRingMaterialCached=null,this._markerMaterialCached=null,this._markerTexture=er(this._markerTexture)}_getDrivenSize(e){return this._drivenProperties.size&&e.size?ta(Gk(e.size)):1}_getSizeFeatureAttributeData(e){return this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size?kl(this._fastUpdates.visualVariables.size.field,e):null}_getDrivenColor(e){const t=hi(1,1,1,1);return this._drivenProperties.color&&e.color&&(t[0]=e.color[0],t[1]=e.color[1],t[2]=e.color[2],e.color.length>0&&(t[3]=e.color[3])),this._drivenProperties.opacity&&e.opacity&&(t[3]=e.opacity),t}_getColorFeatureAttributeData(e){return this._fastUpdates.enabled&&this._fastUpdates.visualVariables.color?kl(this._fastUpdates.visualVariables.color.field,e):null}_getOpacityFeatureAttributeData(e){return this._fastUpdates.enabled&&this._fastUpdates.visualVariables.opacity?kl(this._fastUpdates.visualVariables.opacity.field,e):null}createGraphics3DGraphic(e){const t=e.graphic;if(!this._validateGeometry(t.geometry,hW,this.symbolLayer.type))return null;const r=this.setGraphicElevationContext(t,new Po);return this.ensureDrapedStatus(r.mode==="on-the-ground"),this.draped?this._createAsOverlay(e,this._context.layer.uid):this._createAs3DShape(e,r,t.uid)}applyRendererDiff(e,t){for(const r in e.diff){if(r!=="visualVariables"||!Of(this._fastUpdates,t,this._vvConvertOptions))return dr.Recreate_Symbol;this._forEachMaterial(s=>s.setParameters(this._fastUpdates.materialParameters))}return dr.Fast_Update}prepareSymbolLayerPatch(e){var a,n;if(e.diff.type!=="partial")return;const t=e.diff.diff,r={};((a=t.size)==null?void 0:a.type)==="complete"&&(r.width=this._computeMaterialWidth(t.size.newValue),delete t.size),((n=t.cap)==null?void 0:n.type)==="complete"&&(r.cap=Rw(je(t.cap.newValue,"butt")),delete t.cap);const s=this._prepareMarkerPatch(e,t);this._prepareMaterialPatch(e,t,s),e.symbolLayerStatePatches.push(()=>this._forEachMaterial(o=>o.setParameters(r)))}layerOpacityChanged(){this._forEachMaterial((e,t)=>this._updateMaterialLayerOpacity(e,t))}_forEachMaterial(e){g(this._lineMaterialCached)&&e(this._lineMaterialCached),g(this._ringMaterialCached)&&e(this._ringMaterialCached),g(this._wireframeLineMaterialCached)&&e(this._wireframeLineMaterialCached),g(this._wireframeRingMaterialCached)&&e(this._wireframeRingMaterialCached),g(this._markerMaterialCached)&&e(this._markerMaterialCached,!0)}_updateMaterialLayerOpacity(e,t=!1){const r=e.parameters.color,s=Ur(this.symbolLayer,"material","color"),a=this._patternHidesLine&&!t?0:this._getCombinedOpacity(s),n=hi(r[0],r[1],r[2],a);e.setParameters({color:n})}layerElevationInfoChanged(e,t,r){const s=this._elevationContext.mode,a=Qf(QL.elevationModeChangeTypes,r,s);if(a!==Oi.UPDATE)return a;const n=Un(s);return this.updateGraphics3DGraphicElevationInfo(e,t,()=>n)}slicePlaneEnabledChanged(){const e={hasSlicePlane:this._context.slicePlaneEnabled};return this._forEachMaterial(t=>t.setParameters(e)),!0}physicalBasedRenderingChanged(){return!0}pixelRatioChanged(){return!0}skipHighSymbolLodsChanged(){return!0}_getGeometryAsPolygonOrPolyline(e){switch(e.type){case"extent":if(e instanceof ds)return _T.fromExtent(e);break;case"polygon":case"polyline":return e}return null}_createAs3DShape(e,t,r){const s=e.graphic,a=this._getGeometryAsPolygonOrPolyline(s.geometry),n=a.type==="polygon"?a.rings:a.paths,o=new Array,l=_s(),c=Zq(a,this._context.elevationProvider,this._context.renderCoordsHelper,t),h=a.type==="polygon"?"rings":"paths";this._logGeometryCreationWarnings(c,n,h,"LineSymbol3DLayer");for(let m=0;m<c.lines.length;m++){const f=c.lines[m],y=f.position,b=f.mapPositions;if(g(this._context.clippingExtent)&&(di(l),nn(l,b),!co(l,this._context.clippingExtent)))continue;const x=this._createGeometry(a.type==="polygon"?this._ringMaterial:this._lineMaterial,e,y,b,a.type,Ng.ELEVATED,r);o.push(x),Ot.LINE_WIREFRAMES&&o.push(x.instantiate({material:a.type==="polygon"?this._wireframeRingMaterial:this._wireframeLineMaterial})),g(this._markerMaterial)&&o.push(x.instantiate({material:this._markerMaterial}))}if(o.length===0)return null;const u=new hc({geometries:o,castShadow:!1,metadata:{layerUid:this._context.layer.uid,graphicUid:r}}),p=new fl(this,u,o,null,null,ck,t);return p.alignedSampledElevation=c.sampledElevation,p.needsElevationUpdates=Un(t.mode),p}_createGeometry(e,t,r,s,a,n,o){const l=a==="polygon",c=this._fastUpdates.enabled&&this._fastUpdates.visualVariables.color,h=this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size,u=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:o,layerUid:this._context.layer.uid});return Ew(e,{overlayInfo:n===Ng.DRAPED?{spatialReference:this._context.overlaySR,renderCoordsHelper:this._context.renderCoordsHelper}:null,removeDuplicateStartEnd:l,mapPositions:s,attributeData:{position:r,size:h?null:this._getDrivenSize(t.renderingInfo),color:c?null:this._getDrivenColor(t.renderingInfo),sizeFeature:this._getSizeFeatureAttributeData(t.graphic),colorFeature:this._getColorFeatureAttributeData(t.graphic),opacityFeature:this._getOpacityFeatureAttributeData(t.graphic)}},u)}_createAsOverlay(e,t){const r=e.graphic,s=this._getGeometryAsPolygonOrPolyline(r.geometry),a=s.type==="polygon"?s.rings:s.paths,n=s.type==="polygon"?this._ringMaterial:this._lineMaterial;n.renderPriority=this._renderPriority;const o=Ot.LINE_WIREFRAMES?s.type==="polygon"?this._wireframeRingMaterial:this._wireframeLineMaterial:null,l=this._markerMaterial;g(o)&&(o.renderPriority=this._renderPriority-.001),g(l)&&(l.renderPriority=this._renderPriority-.002);const c=new Array,h=_s(),u=di(),p=Yq(s,this._context.overlaySR),m=s.type==="polygon"?"rings":"paths";this._logGeometryCreationWarnings(p,a,m,"LineSymbol3DLayer");for(const f of p.lines){if(di(h),nn(h,f.position),!co(h,this._context.clippingExtent))continue;zp(u,h);const y=x=>{const S=this._createGeometry(x,e,f.position,void 0,s.type,Ng.DRAPED,r.uid),C=new Qp(S,{layerUid:t,graphicUid:r.uid});return c.push(C),C};if(g(l)){const x=y(l),S=Si(this.symbolLayer.marker).placement;S!=="begin"&&S!=="begin-end"||nn(h,f.position,0,1),S!=="end"&&S!=="begin-end"||nn(h,f.position,f.position.length-3,1),this._updateBoundingSphere(x,h)}const b=y(n);if(this._updateBoundingSphere(b,h),Ot.LINE_WIREFRAMES){const x=y(o);this._updateBoundingSphere(x,h)}}return new Bv(this,c,u,this._context.drapeSourceRenderer)}_updateBoundingSphere(e,t){Br(e.boundingSphere,.5*(t[0]+t[3]),.5*(t[1]+t[4]),0,.5*Math.sqrt((t[3]-t[0])*(t[3]-t[0])+(t[4]-t[1])*(t[4]-t[1])))}get _patternHidesLine(){const e=this.symbolLayer.pattern;return g(e)&&e.type==="style"&&e.style==="none"}_computeMaterialWidth(e){return e=je(e,vx(1)),this._drivenProperties.size?this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size?ta(1):1:ta(e)}_prepareMaterialPatch(e,t,r){var o;const s=t.material;if(P(s))return void(r.changed&&r.useMaterialColor&&this._patchMaterialColor(this._getCombinedOpacityAndColor(this._materialColor),this._markerMaterialCached,e));if(s.type==="collection")return;const a=s.type==="complete"?th(s.newValue,l=>l.color):((o=s.diff.color)==null?void 0:o.type)==="complete"?s.diff.color.newValue:null,n=this._getCombinedOpacityAndColor(a);r.useMaterialColor&&this._patchMaterialColor(lv(n),this._markerMaterialCached,e),this._patternHidesLine&&(n[3]=0),this._patchMaterialColor(n,this._lineMaterialCached,e),delete t.material}_prepareMarkerPatch(e,t){const r=t.marker;if(P(r)||r.type!=="partial"||g(r.diff.style)||g(r.diff.placement)||g(r.diff.color)&&r.diff.color.type!=="complete")return{changed:!1,useMaterialColor:P(this._markerColor)};const s=r.diff.color;if(P(s))return delete t.marker,{changed:!1,useMaterialColor:P(this._markerColor)};const a=Si(s.newValue);return P(a)?(delete t.marker,{changed:!0,useMaterialColor:!0}):(this._patchMaterialColor(this._getCombinedOpacityAndColor(a),this._markerMaterialCached,e),delete t.marker,{changed:!0,useMaterialColor:!1})}_patchMaterialColor(e,t,r){P(t)||r.symbolLayerStatePatches.push(()=>t.setParameters({color:e}))}};var Ng;XL.elevationModeChangeTypes={definedChanged:Oi.RECREATE,staysOnTheGround:Oi.NONE,onTheGroundChanged:Oi.RECREATE},function(i){i[i.DRAPED=0]="DRAPED",i[i.ELEVATED=1]="ELEVATED"}(Ng||(Ng={}));function dW(i){const e=new $t,{vertex:t,fragment:r}=e;return e.include(il,i),e.include(jf,i),e.include(uL,i),nc(t,i),i.stippleEnabled&&(e.attributes.add(w.UV0,"vec2"),e.attributes.add(w.AUXPOS1,"vec3"),t.uniforms.add(new ai("viewport",(s,a)=>a.camera.fullViewport))),e.attributes.add(w.POSITION,"vec3"),e.varyings.add("vpos","vec3"),t.code.add(_`void main(void) {
vpos = position;
forwardNormalizedVertexColor();
gl_Position = transformPosition(proj, view, vpos);`),i.stippleEnabled&&(t.code.add(_`vec4 vpos2 = transformPosition(proj, view, auxpos1);
vec2 ndcToPixel = viewport.zw * 0.5;
float lineSegmentPixelSize = length((vpos2.xy / vpos2.w - gl_Position.xy / gl_Position.w) * ndcToPixel);`),i.draped?t.uniforms.add(new ue("worldToScreenRatio",(s,a)=>1/a.screenToPCSRatio)):t.code.add(_`vec3 segmentCenter = (position + auxpos1) * 0.5;
float worldToScreenRatio = computeWorldToScreenRatio(segmentCenter);`),t.code.add(_`float discreteWorldToScreenRatio = discretizeWorldToScreenRatio(worldToScreenRatio);`),i.draped?t.code.add(_`float startPseudoScreen = uv0.y * discreteWorldToScreenRatio - mix(0.0, lineSegmentPixelSize, uv0.x);
float segmentLengthPseudoScreen = lineSegmentPixelSize;`):t.code.add(_`float segmentLengthRender = length(position - auxpos1);
float startPseudoScreen = mix(uv0.y, uv0.y - segmentLengthRender, uv0.x) * discreteWorldToScreenRatio;
float segmentLengthPseudoScreen = segmentLengthRender * discreteWorldToScreenRatio;`),t.uniforms.add(new ue("stipplePatternPixelSize",s=>BC(s))),t.code.add(_`vec2 stippleDistanceLimits = computeStippleDistanceLimits(startPseudoScreen, segmentLengthPseudoScreen, lineSegmentPixelSize, stipplePatternPixelSize);
vStippleDistance = mix(stippleDistanceLimits.x, stippleDistanceLimits.y, uv0.x);
vStippleDistance *= gl_Position.w;`)),t.code.add(_`}`),i.output===A.Highlight&&e.include(Sh,i),e.include(Qr,i),r.uniforms.add(new ue("alphaCoverage",(s,a)=>Math.min(1,s.width*a.camera.pixelRatio))),i.hasVertexColors||r.uniforms.add(new ai("constantColor",s=>s.color)),r.code.add(_`
  void main() {
    discardBySlice(vpos);

    vec4 color = ${i.hasVertexColors?"vColor":"constantColor"};

    float stippleAlpha = getStippleAlpha();
    discardByStippleAlpha(stippleAlpha, stippleAlphaColorDiscard);

    vec4 finalColor = blendStipple(vec4(color.rgb, color.a * alphaCoverage), stippleAlpha);

    ${i.output===A.ObjectAndLayerIdColor?_`finalColor.a = 1.0;`:""}

    if (finalColor.a < ${_.float(ra)}) {
      discard;
    }

    ${i.output===A.Color?_`gl_FragColor = highlightSlice(finalColor, vpos);`:""}
    ${i.output===A.Highlight?_`outputHighlight();`:""}
  }
  `),e}const uW=Object.freeze(Object.defineProperty({__proto__:null,build:dW},Symbol.toStringTag,{value:"Module"}));let ZL=class YL extends Mt{get _stippleEnabled(){return this.configuration.stippleEnabled&&this.configuration.output!==A.Highlight}initializeConfiguration(e,t){t.hasWebGL2Context=e.rctx.type===da.WEBGL2}initializeProgram(e){return new Rt(e.rctx,YL.shader.get().build(this.configuration),Lt)}initializePipeline(){const e=this.configuration,t=Ar(ae.SRC_ALPHA,ae.ONE,ae.ONE_MINUS_SRC_ALPHA,ae.ONE_MINUS_SRC_ALPHA),r=(s,a=null,n=null)=>qe({blending:a,depthTest:IT,depthWrite:n,colorWrite:at,stencilWrite:e.hasOccludees?Kl:null,stencilTest:e.hasOccludees?s?Md:Wd:null});return e.output===A.Color?(this._occludeePipelineState=r(!0,e.transparent||this._stippleEnabled?t:null,cn),r(!1,e.transparent||this._stippleEnabled?t:null,cn)):r(!1)}get primitiveType(){return Ut.LINES}getPipelineState(e,t){return t?this._occludeePipelineState:super.getPipelineState(e,t)}};ZL.shader=new Dt(uW,()=>_e(()=>import("./NativeLine.glsl-8c11833d.js"),["assets/NativeLine.glsl-8c11833d.js","assets/objectResourceUtils-782953c3.js","assets/devEnvironmentUtils-5002a058.js","assets/calcite-8912bd40.js","assets/index-00759e4a.js","assets/index-5026a37a.css","assets/calcite-96fa36fd.css","assets/mat3f64-50f3b9f6.js","assets/mat4f64-abdda1bb.js","assets/BufferView-379a78a4.js","assets/vec33-69c9e93b.js","assets/DefaultMaterial_COLOR_GAMMA-6ed76d86.js","assets/types-e1c0a5bf.js","assets/enums-e2e92c86.js","assets/Version-aa0a1d91.js","assets/quat-7b70e9a8.js","assets/quatf64-f8f1c132.js","assets/resourceUtils-527631ac.js","assets/basicInterfaces-7449a8bf.js","assets/Indices-d8bff7b2.js","assets/NestedMap-1b5db22e.js","assets/requestImageUtils-d1ba3b36.js","assets/symbolColorUtils-c9d24716.js","assets/Util-6d3f024a.js","assets/sphere-d0e5285d.js","assets/VertexAttribute-15d1866a.js","assets/doublePrecisionUtils-e3c3d0d8.js","assets/OrderIndependentTransparency-5f7257d7.js","assets/Texture-563cf5e5.js","assets/FramebufferObject-8b18fc0c.js","assets/VertexElementDescriptor-2925c6af.js","assets/InterleavedLayout-d57c91d0.js","assets/vec3f32-01c06d8d.js","assets/plane-5e2b046c.js","assets/spatialReferenceEllipsoidUtils-afb35af9.js","assets/scaleUtils-d13015f2.js","assets/ElevationSamplerData-e3118b17.js","assets/Octree-499541ed.js","assets/edgeProcessing-20e12367.js","assets/deduplicate-769a6f51.js","assets/MeshComponent-788e605a.js","assets/earcut-61f7b102.js","assets/imageUtils-c2d0d1ae.js","assets/projection-5969b753.js","assets/ZoomMomentumEstimator-ef57e6a4.js","assets/floatRGBA-ca2b39ca.js","assets/dehydratedFeatures-3a140d03.js","assets/quantizationUtils-b3b2ae2a.js","assets/labelFormatUtils-71e1f841.js","assets/orientedBoundingBox-a14b97b5.js","assets/quatf32-51a323b8.js","assets/SnappingCandidate-970faec6.js","assets/callExpressionWithFeature-df1a8f01.js","assets/DefaultVertexAttributeLayouts-5f20d8dd.js","assets/geometryServiceUtils-a536bb19.js","assets/project-909a4219.js","assets/LercDecoder-65586d50.js","assets/VectorTile-d41a1f0f.js","assets/enums-fb086c25.js","assets/config-1337d16e.js","assets/TiledDisplayObject-419c008b.js","assets/DisplayObject-87c37b69.js","assets/rasterUtils-7694cc98.js","assets/resources-7587d8f4.js","assets/workerHelper-6131d203.js","assets/webgl-debug-7f880832.js","assets/RenderingContext-0f21aa0e.js","assets/ProgramCache-f29c900e.js","assets/Program-77209250.js","assets/MediaLayer-4c42fc2f.js","assets/MediaElementView-06baa4d4.js","assets/normalizeUtilsSync-3ea564a9.js","assets/resourceExtension-f31d9f10.js","assets/BoundsStore-00da37da.js","assets/PooledRBush-5a11bc7e.js","assets/prism-line-numbers-eff41b13.js","assets/label2-a2f37e65.js","assets/interactive-1de2e238.js","assets/loadable-6afd516d.js","assets/t9n-81df3a71.js","assets/observers-c89705b8.js","assets/icon-8e47fbec.js","assets/loader-c773e800.js","assets/guid-51402ee7.js","assets/prism-line-numbers-7c5d72ff.css"]));let qa=class extends Vn{constructor(){super(...arguments),this.output=A.Color,this.hasSlicePlane=!1,this.hasVertexColors=!1,this.transparent=!1,this.draped=!1,this.stippleEnabled=!1,this.stippleOffColorEnabled=!1,this.stipplePreferContinuous=!0,this.hasOccludees=!1}};d([D({count:A.COUNT})],qa.prototype,"output",void 0),d([D()],qa.prototype,"hasSlicePlane",void 0),d([D()],qa.prototype,"hasVertexColors",void 0),d([D()],qa.prototype,"transparent",void 0),d([D()],qa.prototype,"draped",void 0),d([D()],qa.prototype,"stippleEnabled",void 0),d([D()],qa.prototype,"stippleOffColorEnabled",void 0),d([D()],qa.prototype,"stipplePreferContinuous",void 0),d([D()],qa.prototype,"hasOccludees",void 0),d([D({constValue:!1})],qa.prototype,"stippleRequiresClamp",void 0),d([D({constValue:!1})],qa.prototype,"stippleScaleWithLineWidth",void 0),d([D({constValue:!1})],qa.prototype,"stippleRequiresStretchMeasure",void 0);var qy;(function(i){i[i.START=0]="START",i[i.END=1]="END"})(qy||(qy={}));let aR=class extends jd{constructor(e){super(e,new gW),this._configuration=new qa}getConfiguration(e,t){this._configuration.output=e,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.hasVertexColors=this.parameters.hasVertexColors,this._configuration.transparent=this.parameters.color[3]<1||this.parameters.width<1,this._configuration.draped=t.slot===K.DRAPED_MATERIAL;const r=g(this.parameters.stipplePattern);return this._configuration.stippleEnabled=r,this._configuration.stippleOffColorEnabled=r&&g(this.parameters.stippleOffColor),this._configuration.hasOccludees=this.parameters.hasOccludees,this._configuration.stipplePreferContinuous=this.parameters.stipplePreferContinuous,this._configuration}intersect(e,t,r,s,a,n){if(!r.options.selectionMode||!e.visible)return;if(!y3(t))return void Pe.getLogger("esri.views.3d.webgl-engine.materials.NativeLineMaterial").error("intersection assumes a translation-only matrix");const o=e.vertexAttributes.get(w.POSITION).data,l=r.camera,c=_W;fs(c,r.point);const h=2;j(Im[0],c[0]-h,c[1]+h,0),j(Im[1],c[0]+h,c[1]+h,0),j(Im[2],c[0]+h,c[1]-h,0),j(Im[3],c[0]-h,c[1]-h,0);for(let y=0;y<4;y++)if(!l.unprojectFromRenderScreen(Im[y],Sl[y]))return;tl(l.eye,Sl[0],Sl[1],Ob),tl(l.eye,Sl[1],Sl[2],Rb),tl(l.eye,Sl[2],Sl[3],Eb),tl(l.eye,Sl[3],Sl[0],Ab);let u=Number.MAX_VALUE,p=0;for(let y=0;y<o.length-5;y+=3){if(ws[0]=o[y]+t[12],ws[1]=o[y+1]+t[13],ws[2]=o[y+2]+t[14],Ts[0]=o[y+3]+t[12],Ts[1]=o[y+4]+t[13],Ts[2]=o[y+5]+t[14],Ri(Ob,ws)<0&&Ri(Ob,Ts)<0||Ri(Rb,ws)<0&&Ri(Rb,Ts)<0||Ri(Eb,ws)<0&&Ri(Eb,Ts)<0||Ri(Ab,ws)<0&&Ri(Ab,Ts)<0)continue;if(l.projectToRenderScreen(ws,Bh),l.projectToRenderScreen(Ts,Hh),Bh[2]<0&&Hh[2]>0){Q(Io,ws,Ts);const x=l.frustum,S=-Ri(x[$i.NEAR],ws)/J(Io,As(x[$i.NEAR]));B(Io,Io,S),X(ws,ws,Io),l.projectToRenderScreen(ws,Bh)}else if(Bh[2]>0&&Hh[2]<0){Q(Io,Ts,ws);const x=l.frustum,S=-Ri(x[$i.NEAR],Ts)/J(Io,As(x[$i.NEAR]));B(Io,Io,S),X(Ts,Ts,Io),l.projectToRenderScreen(Ts,Hh)}else if(Bh[2]<0&&Hh[2]<0)continue;Bh[2]=0,Hh[2]=0;const b=RT(wd(Bh,Hh,lR),c);b<u&&(u=b,H(nR,ws),H(oR,Ts),p=y/3)}const m=r.rayBegin,f=r.rayEnd;if(u<h*h){let y=Number.MAX_VALUE;if(v3(wd(nR,oR,lR),wd(m,f,fW),Gh)){Q(Gh,Gh,m);const b=pe(Gh);B(Gh,Gh,1/b),y=b/yi(m,f)}n(y,Gh,p,!1)}}intersectDraped(e,t,r,s,a,n){if(!r.options.selectionMode)return;const o=e.vertexAttributes.get(w.POSITION).data,l=e.vertexAttributes.get(w.SIZE),c=l?l.data[0]:0,h=s[0],u=s[1],p=((c+1)/2+4)*e.screenToWorldRatio;let m=Number.MAX_VALUE,f=0;for(let y=0;y<o.length-5;y+=3){const b=o[y],x=o[y+1],S=h-b,C=u-x,O=o[y+3]-b,R=o[y+4]-x,E=ee((O*S+R*C)/(O*O+R*R),0,1),$=O*E-S,M=R*E-C,L=$*$+M*M;L<m&&(m=L,f=y/3)}m<p*p&&a(n.dist,n.normal,f,!1)}requiresSlot(e,t){return!(t!==A.Color&&t!==A.Highlight&&t!==A.ObjectAndLayerIdColor||e!==K.OPAQUE_MATERIAL&&e!==K.DRAPED_MATERIAL)}createGLMaterial(e){return new pW(e)}createBufferWriter(){const e=this.parameters.hasVertexColors?CL:Mj;return P(this.parameters.stipplePattern)?new kf(e):new mW(e.clone().vec3f(w.AUXPOS1).vec2f(w.UV0))}},pW=class extends qd{constructor(){super(...arguments),this._stipplePattern=null}dispose(){super.dispose(),this._stippleTextureRepository.release(this._stipplePattern),this._stipplePattern=null}_updateOccludeeState(e){e.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:e.hasOccludees})}beginSlot(e){this._output===A.Color&&this._updateOccludeeState(e);const t=this._material.parameters.stipplePattern;return this._stipplePattern!==t&&(this._material.setParameters(this._stippleTextureRepository.swap(this._stipplePattern,t)),this._stipplePattern=t),this.ensureTechnique(ZL,e)}},mW=class{constructor(e){this.vertexBufferLayout=e}allocate(e){return this.vertexBufferLayout.createBuffer(e)}elementCount(e){return e.indices.get(w.POSITION).length}write(e,t,r,s,a){PF(r,this.vertexBufferLayout,e,t,s,a),this._writeAuxpos1(e,r,s,a),this._writeUV0(e,r,s,a)}_writeAuxpos1(e,t,r,s){const a=r.getField(w.AUXPOS1,_h),n=t.indices.get(w.POSITION),o=t.vertexAttributes.get(w.POSITION).data,l=e,c=a.typedBufferStride,h=a.typedBuffer;s*=c;for(let u=0;u<n.length-1;u+=2)for(const p of[1,0]){const m=3*n[u+p],f=o[m],y=o[m+1],b=o[m+2],x=l[0]*f+l[4]*y+l[8]*b+l[12],S=l[1]*f+l[5]*y+l[9]*b+l[13],C=l[2]*f+l[6]*y+l[10]*b+l[14];h[s]=x,h[s+1]=S,h[s+2]=C,s+=c}}_writeUV0(e,t,r,s){var C;const a=r.getField(w.UV0,hM),n=t.indices.get(w.POSITION),o=t.vertexAttributes.get(w.POSITION).data,l=(C=t.vertexAttributes.get(w.DISTANCETOSTART))==null?void 0:C.data,c=a.typedBufferStride,h=a.typedBuffer;let u=0;h[s*=c]=qy.START,h[s+1]=u,s+=c;const p=3*n[0],m=j(ws,o[p],o[p+1],o[p+2]);e&&xe(m,m,e);const f=Ts,y=n.length-1;let b=1;const x=l?(O,R,E)=>u=l[E]:(O,R,E)=>u+=yi(O,R);for(let O=1;O<y;O+=2){const R=3*n[O];j(f,o[R],o[R+1],o[R+2]),e&&xe(f,f,e),x(m,f,b++);for(let E=0;E<2;++E)h[s]=1-E,h[s+1]=u,s+=c;H(m,f)}const S=3*n[y];j(f,o[S],o[S+1],o[S+2]),e&&xe(f,f,e),x(m,f,b),h[s]=qy.END,h[s+1]=u}},gW=class extends Hf{constructor(){super(...arguments),this.color=no,this.hasVertexColors=!1,this.hasSlicePlane=!1,this.width=1,this.stipplePreferContinuous=!0,this.hasOccludees=!1,this.stippleTexture=null}};const ws=T(),Ts=T(),Io=T(),Gh=T(),Bh=Zr(),Hh=Zr(),nR=T(),oR=T(),lR=em(),fW=em(),_W=T(),Im=[Zr(),Zr(),Zr(),Zr()],Sl=[T(),T(),T(),T()],Ob=Ui(),Rb=Ui(),Eb=Ui(),Ab=Ui(),yW=["mesh"];class vW extends _l{constructor(e,t,r,s){super(e,t,r,s),this._materials=new Map,this._textures=new Map,this.ensureDrapedStatus(!1)}async doLoad(){Ot.DRAW_MESH_GEOMETRY_NORMALS&&(this._debugVertexNormalMaterial=new aR({color:[1,0,1,1]}),this._debugFaceNormalMaterial=new aR({color:[0,1,1,1]}))}destroy(){super.destroy(),this._context.stage.removeMany(Array.from(this._materials.values(),e=>e.material)),this._context.stage.removeMany(Array.from(this._textures.values())),this._materials.clear(),this._textures.clear()}createGraphics3DGraphic(e){const t=e.graphic;if(!this._validateGeometry(t.geometry,yW,"fill on mesh-3d"))return null;const r=this.setGraphicElevationContext(t,new Po),s=e.renderingInfo;return this._createAs3DShape(t,s,r,t.uid)}layerOpacityChanged(e,t){const r=this._getLayerOpacity();this._materials.forEach(s=>{s.material.setParameters({layerOpacity:r});const a=s.material.parameters;this._setMaterialTransparentParameter(a,s),s.material.setParameters({transparent:a.transparent})}),e.forEach(s=>{const a=t(s);g(a)&&a.layerOpacityChanged(r,this._context.isAsync)})}layerElevationInfoChanged(e,t){return this.updateGraphics3DGraphicElevationInfo(e,t,wh)}slicePlaneEnabledChanged(e,t){return this._materials.forEach(r=>{r.material.setParameters({hasSlicePlane:this._context.slicePlaneEnabled})}),e.forEach(r=>{const s=t(r);g(s)&&s.slicePlaneEnabledChanged(this._context.slicePlaneEnabled,this._context.isAsync)}),!0}physicalBasedRenderingChanged(){const e=this._usePBR();return this._materials.forEach(t=>t.material.setParameters({usePBR:e})),!0}pixelRatioChanged(){return!0}skipHighSymbolLodsChanged(){return!0}_requiresSymbolVertexColors(){return this._drivenProperties.color||this._drivenProperties.opacity}_colorOrTextureUid(e){return P(e)?"-":e instanceof ui?e.toHex():e.contentHash}_materialPropertiesDefault(e,t){const r=this._requiresSymbolVertexColors(),s=!!e.vertexAttributes.color,a=!!e.vertexAttributes.tangent;return{hasSymbolVertexColors:r,hasVertexColors:s,hasVertexTangents:a,uid:`vc:${s},vt:${a},vct${t},svc:${r}`}}_materialProperties(e,t,r){const s=this._materialPropertiesDefault(e,r);if(!t.material)return s;const{color:a,colorTexture:n,normalTexture:o,doubleSided:l,alphaCutoff:c,alphaMode:h}=t.material,u=this._colorOrTextureUid(a),p=this._colorOrTextureUid(n),m=this._colorOrTextureUid(o);if(s.color=a,s.colorTexture=n,s.normalTexture=o,s.uid=`${s.uid},cmuid:${u},ctmuid:${p},ntmuid:${m},ds:${l},ac:${c},am:${h}`,t.material instanceof C6){const{metallic:f,roughness:y,metallicRoughnessTexture:b,emissiveColor:x,emissiveTexture:S,occlusionTexture:C}=t.material,O=this._colorOrTextureUid(b),R=this._colorOrTextureUid(x),E=this._colorOrTextureUid(S),$=this._colorOrTextureUid(C);s.metallic=f,s.roughness=y,s.metallicRoughnessTexture=b,s.emissiveColor=x,s.emissiveTexture=S,s.occlusionTexture=C,s.colorTextureTransform=t.material.colorTextureTransform,s.normalTextureTransform=t.material.normalTextureTransform,s.emissiveTextureTransform=t.material.emissiveTextureTransform,s.occlusionTextureTransform=t.material.occlusionTextureTransform,s.metallicRoughnessTextureTransform=t.material.metallicRoughnessTextureTransform,s.uid=`${s.uid},mrm:${f},mrr:${y},mrt:${O},emuid:${R},etmuid:${E},otmuid:${$}`}return s}_setInternalColorValueParameters(e,t){t.diffuse=ui.toUnitRGB(e),t.opacity=e.a}_getLoadableTextureResource(e){return e.data?e.data:e.url}_getInternalTextureId(e){const t=this._getInternalTexture(e,en.Opaque);return g(t)?t.id:null}_getInternalTexture(e,t){const r=this._getLoadableTextureResource(e);if(!r)return null;const s=`${e.contentHash}/${t}`;let a=this._textures.get(s);return a||(a=new Bf(y1(r)?r.data:r,{mipmap:!0,wrap:this._castTextureWrap(e.wrap),noUnpackFlip:!0,preMultiplyAlpha:!y1(r)&&t!==en.Opaque,encoding:y1(r)&&g(r.encoding)?r.encoding:void 0}),this._textures.set(s,a),this._context.stage.add(a),this._context.stage.loadImmediate(a)),a}_castTextureWrap(e="repeat"){if(typeof e=="string"){const t=this._castTextureWrapIndividual(e);return{s:t,t}}return{s:this._castTextureWrapIndividual(e.horizontal),t:this._castTextureWrapIndividual(e.vertical)}}_castTextureWrapIndividual(e){switch(e){case"clamp":return kt.CLAMP_TO_EDGE;case"mirror":return kt.MIRRORED_REPEAT;default:return kt.REPEAT}}_setInternalMaterialParameters(e,t){if(g(e.color)&&this._setInternalColorValueParameters(e.color,t),g(e.colorTexture)){const r=this._getInternalTexture(e.colorTexture,t.textureAlphaMode);g(r)?(t.textureId=r.id,t.textureAlphaPremultiplied=!!r.params.preMultiplyAlpha):t.textureId=void 0}g(e.normalTexture)&&(t.normalTextureId=this._getInternalTextureId(e.normalTexture)),g(e.emissiveColor)&&(t.emissiveFactor=ui.toUnitRGB(e.emissiveColor)),g(e.emissiveTexture)&&(t.emissiveTextureId=this._getInternalTextureId(e.emissiveTexture)),g(e.occlusionTexture)&&(t.occlusionTextureId=this._getInternalTextureId(e.occlusionTexture)),g(e.metallicRoughnessTexture)&&(t.metallicRoughnessTextureId=this._getInternalTextureId(e.metallicRoughnessTexture)),t.colorTextureTransformMatrix=_m(e.colorTextureTransform),t.normalTextureTransformMatrix=_m(e.normalTextureTransform),t.occlusionTextureTransformMatrix=_m(e.occlusionTextureTransform),t.emissiveTextureTransformMatrix=_m(e.emissiveTextureTransform),t.metallicRoughnessTextureTransformMatrix=_m(e.metallicRoughnessTextureTransform)}_setExternalMaterialParameters(e){const t=this._drivenProperties.color;let r=g(this.symbolLayer.material)?this.symbolLayer.material.colorMixMode:null;if(t)e.externalColor=no;else{const s=g(this.symbolLayer.material)?this.symbolLayer.material.color:null;g(s)?e.externalColor=ui.toUnitRGBA(s):(r=null,e.externalColor=no)}r&&(e.colorMixMode=r),e.castShadows=!!this.symbolLayer.castShadows}_hasTransparentVertexColors(e){const t=e.vertexAttributes.color;if(P(t))return!1;for(let r=3;r<t.length;r+=4)if(t[r]!==255)return!0;return!1}_getOrCreateMaterial(e,t){var f,y,b;const r=(f=t.material)==null?void 0:f.color,s=(y=t.material)==null?void 0:y.colorTexture,a=(b=t.material)==null?void 0:b.alphaMode,n=a==="blend",o=a!=="opaque"&&(this._hasTransparentVertexColors(e)||g(r)&&r.a<1||g(s)&&s.transparent||n),l=this._materialProperties(e,t,o),c=this._materials.get(l.uid);if(c)return c.material;const h={material:null,isComponentTransparent:o,alphaMode:t.material?t.material.alphaMode:"opaque"},u=l.metallicRoughnessTexture==null&&l.metallic==null&&l.roughness==null,p={usePBR:this._usePBR(),isSchematic:u,hasVertexColors:l.hasVertexColors,hasSymbolColors:l.hasSymbolVertexColors,hasVertexTangents:l.hasVertexTangents,ambient:on,diffuse:Yc,opacity:1,doubleSided:!0,doubleSidedType:"winding-order",cullFace:Tr.None,layerOpacity:this._getLayerOpacity(),hasSlicePlane:this._context.slicePlaneEnabled,initTextureTransparent:!0};u||(p.mrrFactors=[l.metallic!=null?l.metallic:1,l.roughness!=null?l.roughness:1,.5]),t.material&&(p.doubleSided=t.material.doubleSided,p.cullFace=t.material.doubleSided?Tr.None:Tr.Back,p.textureAlphaCutoff=t.material.alphaCutoff),this._setExternalMaterialParameters(p),this._setMaterialTransparentParameter(p,h),this._setInternalMaterialParameters(l,p);const m=new Kg(p);return h.material=m,this._materials.set(l.uid,h),this._context.stage.add(m),m}_usePBR(){return this._context.physicalBasedRenderingEnabled}_setMaterialTransparentParameter(e,t){e.transparent=this.needsDrivenTransparentPass||t.isComponentTransparent||e.layerOpacity<1||e.opacity<1||e.externalColor&&e.externalColor[3]<1,t.alphaMode==="auto"?e.textureAlphaMode=e.transparent?en.MaskBlend:en.Opaque:e.textureAlphaMode=t.alphaMode==="opaque"?en.Opaque:t.alphaMode==="mask"?en.Mask:en.Blend}_addDebugNormals(e,t){const r=t.length,s=e.spatialReference.isGeographic?20015077/180:1,a=.1*Math.max(e.extent.width*s,e.extent.height*s,e.extent.zmax-e.extent.zmin),n=[],o=[],l=[],c=[];for(let m=0;m<r;m++){const f=t[m],y=f.vertexAttributes.get(w.POSITION),b=f.vertexAttributes.get(w.NORMAL),x=f.indices.get(w.POSITION),S=f.indices.get(w.NORMAL),C=y.data,O=b.data;for(let R=0;R<x.length;R++){const E=3*x[R],$=3*S[R];for(let M=0;M<3;M++)n.push(C[E+M]);for(let M=0;M<3;M++)n.push(C[E+M]+O[$+M]*a);if(o.push(o.length),o.push(o.length),R%3==0){this._calculateFaceNormal(C,x,R,Nu),this._getFaceVertices(C,x,R,jr,Lu,$u),X(jr,jr,Lu),X(jr,jr,$u),B(jr,jr,1/3);for(let M=0;M<3;M++)l.push(jr[M]);for(let M=0;M<3;M++)l.push(jr[M]+Nu[M]*a);c.push(c.length),c.push(c.length)}}}const h=t[0].transformation,u=new Cr(this._debugVertexNormalMaterial,[[w.POSITION,new be(n,3,!0)]],[[w.POSITION,o]],null,ps.Line);t.push(u),u.transformation=h;const p=new Cr(this._debugFaceNormalMaterial,[[w.POSITION,new be(l,3,!0)]],[[w.POSITION,c]],null,ps.Line);p.transformation=h,t.push(p)}_createAs3DShape(e,t,r,s){const a=e.geometry;if(a.type!=="mesh")return null;const n=this._createGeometryInfo(a,t,s);if(P(n))return null;const{geometries:o,objectTransformation:l}=n;Ot.DRAW_MESH_GEOMETRY_NORMALS&&this._addDebugNormals(a,o);const c=new hc({geometries:o,metadata:{layerUid:this._context.layer.uid,graphicUid:s}});c.transformation=l;const h=dM(this.symbolLayer,{opacity:this._getLayerOpacity()}),u=g(h)?new fk(o[0].material,[h],{mergeGeometries:!0,hasSlicePlane:this._context.slicePlaneEnabled}):null,p=new fl(this,c,o,null,null,bf,r,u);p.needsElevationUpdates=wh(r.mode),p.useObjectOriginAsAttachmentOrigin=!0,r.centerPointInElevationSR=this._getCenterPointInElevationSR(c);const{elevationProvider:m,renderCoordsHelper:f}=this._context,y=(b,x)=>cm(b,m,r,f,x);return p.alignedSampledElevation=bf(p,r,m.spatialReference,y,f),p}_getCenterPointInElevationSR(e){const t=lc(0,0,0,g(this._context.elevationProvider.spatialReference)?this._context.elevationProvider.spatialReference:null);return t3([e.transformation[12],e.transformation[13],e.transformation[14]],this._context.renderCoordsHelper.spatialReference,t),t}_createComponentNormals(e,t,r,s){switch(r.shading||"flat"){default:case"source":return this._createComponentNormalsSource(e,t,r,s);case"flat":return this._createComponentNormalsFlat(e,s);case"smooth":return this._createComponentNormalsSmooth(e,s)}}_createComponentNormalsSource(e,t,r,s){if(P(t))return this._createComponentNormalsFlat(e,s);let a=!1;if(!r.trustSourceNormals)for(let n=0;n<s.length;n+=3){this._calculateFaceNormal(e,s,n,Nu);for(let o=0;o<3;o++){const l=3*s[n+o];jr[0]=t[l+0],jr[1]=t[l+1],jr[2]=t[l+2],J(Nu,jr)<0&&(t[l+0]=-t[l+0],t[l+1]=-t[l+1],t[l+2]=-t[l+2],a=!0)}}return new Mb(t,s,a)}_createComponentNormalsFlat(e,t){const r=zi(t.length),s=new Array(3*t.length);for(let a=0;a<t.length;a+=3){const n=this._calculateFaceNormal(e,t,a,Nu);for(let o=0;o<3;o++)r[a+o]=n[o],s[a+o]=a/3}return new Mb(r,s,!1)}_createComponentNormalsSmooth(e,t){const r={};for(let n=0;n<t.length;n+=3){const o=this._calculateFaceNormal(e,t,n,Nu);for(let l=0;l<3;l++){const c=t[n+l];let h=r[c];h||(h={normal:T(),count:0},r[c]=h),X(h.normal,h.normal,o),h.count++}}const s=zi(3*t.length),a=new Array(3*t.length);for(let n=0;n<t.length;n++){const o=r[t[n]];o.count!==1&&(W(o.normal,o.normal),o.count=1);for(let l=0;l<3;l++)s[3*n+l]=o.normal[l];a[n]=n}return new Mb(s,a,!1)}_getFaceVertices(e,t,r,s,a,n){const o=3*t[r+0],l=3*t[r+1],c=3*t[r+2];s[0]=e[o+0],s[1]=e[o+1],s[2]=e[o+2],a[0]=e[l+0],a[1]=e[l+1],a[2]=e[l+2],n[0]=e[c+0],n[1]=e[c+1],n[2]=e[c+2]}_calculateFaceNormal(e,t,r,s){return this._getFaceVertices(e,t,r,jr,Lu,$u),Q(Lu,Lu,jr),Q($u,$u,jr),Be(jr,Lu,$u),W(s,jr),s}_getOrCreateComponents(e){return je(e.components,bW)}_createPositionBuffer(e,t){let r=e.vertexAttributes.position;const s=t.reprojection===Za.ECEF?t.transformBeforeProject:null;if(g(s)&&(r=O6(r,new Float64Array(r.length),s)),t.reprojection===Za.NONE)return t.needsBufferCopy?new Float64Array(r):r;const a=g(s)?r:new Float64Array(r.length);return ha(r,e.spatialReference,0,a,this._context.renderCoordsHelper.spatialReference,0,r.length/3),a}_createNormalBuffer(e,t,r){let s=e.vertexAttributes.normal;if(P(s))return null;const a=r.reprojection===Za.ECEF?r.transformBeforeProject:null;if(g(a)&&(s=R6(s,new Float32Array(s.length),a)),this._context.graphicsCoreOwner.view.viewingMode==="local"||r.reprojection===Za.NONE)return r.needsBufferCopy&&e.vertexAttributes.normal===s?new Float32Array(s):s;const n=e.vertexAttributes.position,o=g(a)?s:new Float32Array(s.length);return E6(s,n,t,e.spatialReference,o)}_createTangentBuffer(e,t,r){let s=e.vertexAttributes.tangent;if(P(s))return null;const a=r.reprojection===Za.ECEF?r.transformBeforeProject:null;if(g(a)&&(s=A6(s,new Float32Array(s.length),a)),this._context.graphicsCoreOwner.view.viewingMode==="local"||r.reprojection===Za.NONE)return r.needsBufferCopy&&e.vertexAttributes.normal===s?new Float32Array(s):s;const n=e.vertexAttributes.position,o=g(a)?s:new Float32Array(s.length);return M6(s,n,t,e.spatialReference,o)}_createColorBuffer(e){return e.vertexAttributes.color}_createSymbolColorBuffer(e){if(this._requiresSymbolVertexColors()){const t=this._getVertexOpacityAndColor(e),r=w6(Ur(this.symbolLayer,"material","colorMixMode")),s=new Uint8Array(4);return nM(t,r,s),s}return null}_createBuffers(e,t){const r=e.vertexAttributes&&e.vertexAttributes.position;if(!r)return this.logger.warn("Mesh geometry must contain position vertex attributes"),null;const s=e.vertexAttributes.normal,a=e.vertexAttributes.uv,n=e.vertexAttributes.tangent;if(g(s)&&s.length!==r.length)return this.logger.warn("Mesh normal vertex buffer must contain the same number of elements as the position buffer"),null;if(g(n)&&n.length/4!=r.length/3)return this.logger.warn("Mesh tangent vertex buffer must contain the same number of elements as the position buffer"),null;if(g(a)&&a.length/2!=r.length/3)return this.logger.warn("Mesh uv vertex buffer must contain the same number of elements as the position buffer"),null;const o=this._computeReprojectionInfo(e),l=this._createPositionBuffer(e,o),c=this._createColorBuffer(e),h=this._createSymbolColorBuffer(t),u=this._createNormalBuffer(e,l,o),p=this._createTangentBuffer(e,l,o);return{positionBuffer:l,normalBuffer:u,tangentBuffer:p,uvBuffer:a,colorBuffer:c,symbolColorBuffer:h,objectTransformation:o.reprojection===Za.NONE&&g(o.objectTransformation)?o.objectTransformation:this._transformOriginLocal(e,l,u,p),geometryTransformation:o.reprojection===Za.NONE&&g(o.geometryTransformation)?o.geometryTransformation:ce()}}_computeReprojectionInfo(e){const t=g(e.transform),r=t&&e.transform.geographic||this._context.renderCoordsHelper.viewingMode===ve.Local?Za.NONE:Za.ECEF;if(t){if(r===Za.NONE){const a=ce();return Zl(e.spatialReference,e.transform.origin,a,this._context.renderCoordsHelper.spatialReference),{reprojection:r,objectTransformation:a,geometryTransformation:Z9(e.transform.localMatrix),needsBufferCopy:!1}}const s=YA(ce(),e.transform.origin);return pr(s,s,e.transform.localMatrix),{reprojection:r,transformBeforeProject:s,needsBufferCopy:!0}}return{reprojection:r,needsBufferCopy:!0}}_transformOriginLocal(e,t,r,s){const a=this._context.renderCoordsHelper.spatialReference,n=e.anchor;Q_[0]=n.x,Q_[1]=n.y,Q_[2]=n.z;const o=ce();Zl(e.spatialReference,Q_,o,a);const l=_y.fromTypedArray(t);if($a(cR,o),uM(l,l,cR),g(r)||g(s)){if(Xl(Lm,o),ic(Lm,Lm),g(r)){const c=_h.fromTypedArray(r);vy(c,c,Lm)}if(g(s)){const c=_h.fromTypedArray(s,4*s.BYTES_PER_ELEMENT);vy(c,c,Lm)}}return o}_validateFaces(e,t){const r=e.vertexAttributes.position.length/3,s=t.faces;if(s){let a=-1;for(let n=0;n<s.length;n++){const o=s[n];o>a&&(a=o)}if(r<=a)return this.logger.warn(`Vertex index ${a} is out of bounds of the mesh position buffer`),!1}else if(r%3!=0)return this.logger.warn("Mesh position buffer length must be a multiple of 9 if no component faces are defined (3 values per vertex * 3 vertices per triangle)"),!1;return!0}_getOrCreateFaces(e,t){return t.faces?t.faces:kT(e.vertexAttributes.position.length/3)}_isOutsideClippingArea(e){if(!this._context.clippingExtent)return!1;const t=e.vertexAttributes&&e.vertexAttributes.position;if(!t)return!1;const r=this._context.elevationProvider.spatialReference;let s;const a=t.length/3;return g(r)&&!e.spatialReference.equals(r)?(s=new Float64Array(t.length),ha(e.vertexAttributes.position,e.spatialReference,0,s,r,0,a)):s=t,di(Db),nn(Db,s,0,a),!co(Db,this._context.clippingExtent)}_createGeometryInfo(e,t,r){if(!i3(e.spatialReference,this._context.graphicsCoreOwner.view.spatialReference))return this.logger.warn("Geometry spatial reference is not compatible with the view"),null;if(this._isOutsideClippingArea(e))return null;const s=this._createBuffers(e,t);if(P(s))return null;const{positionBuffer:a,uvBuffer:n,colorBuffer:o,symbolColorBuffer:l,normalBuffer:c,tangentBuffer:h,objectTransformation:u,geometryTransformation:p}=s,m=this._getOrCreateComponents(e),f=new Array;let y=!1;for(const b of m){if(!this._validateFaces(e,b))return null;const x=this._getOrCreateFaces(e,b);if(x.length===0)continue;const S=this._createComponentNormals(a,c,b,x);S.didFlipNormals&&(y=!0);const C=[[w.POSITION,new be(a,3,!0)],[w.NORMAL,new be(S.normals,3,!0)]],O=[[w.POSITION,x],[w.NORMAL,S.indices]];g(o)&&(C.push([w.COLOR,new be(o,4,!0)]),O.push([w.COLOR,x])),g(l)&&(C.push([w.SYMBOLCOLOR,new be(l,4,!0)]),O.push([w.SYMBOLCOLOR,new Array(x.length).fill(0)])),g(n)&&(C.push([w.UV0,new be(n,2,!0)]),O.push([w.UV0,x])),g(h)&&(C.push([w.TANGENT,new be(h,4,!0)]),O.push([w.TANGENT,x]));const R=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:r,layerUid:this._context.layer.uid}),E=this._getOrCreateMaterial(e,b),$=new Cr(E,C,O,null,ps.Mesh,R);$.transformation=p,f.push($)}return y&&this.logger.warn("Normals have been automatically flipped to be consistent with the counter clock wise face winding order. It is better to generate mesh geometries that have consistent normals."),{geometries:f,objectTransformation:u}}}let Mb=class{constructor(e,t,r){this.normals=e,this.indices=t,this.didFlipNormals=r}};const Q_=T(),jr=T(),Lu=T(),$u=T(),Nu=T(),cR=ce(),Lm=ys(),Db=_s(),bW=[new T6];var Za;(function(i){i[i.NONE=0]="NONE",i[i.ECEF=1]="ECEF"})(Za||(Za={}));let xW=class{constructor(e,t,r,s){this.graphics3DSymbolLayer=e,this.instanceIndex=t,this.elevationAligner=r,this.elevationContext=s,this.type="lod-instance",this._highlights=new Set,this.alignedSampledElevation=0,this.isElevationSource=!1,this.needsElevationUpdates=!1}initialize(){}setVisibility(e){const t=this._lodRenderer.instanceData;e!==t.getVisible(this.instanceIndex)&&t.setVisible(this.instanceIndex,e)}destroy(){this.instanceIndex!=null&&(this._lodRenderer.instanceData.removeInstance(this.instanceIndex),this.graphics3DSymbolLayer.notifyDestroyGraphicLayer(this))}alignWithElevation(e,t,r){if(this.elevationAligner){NC(this.elevationContext.featureExpressionInfoContext,r);const s=(n,o)=>cm(n,e,this.elevationContext,t,o),a=this.elevationAligner(this,this.elevationContext,e.spatialReference,s,t);g(a)&&(this.alignedSampledElevation=a)}}getCenterObjectSpace(e=T()){return this._lodRenderer.instanceData.getCombinedLocalTransform(this.instanceIndex,Lo),xe(e,this._lodRenderer.baseBoundingSphere.center,Lo)}getBoundingBoxObjectSpace(e=_s()){this._lodRenderer.instanceData.getCombinedLocalTransform(this.instanceIndex,Lo);const t=this._lodRenderer.baseBoundingBox;di(e);for(let r=0;r<8;++r)j(dn,1&r?t[3]:t[0],2&r?t[4]:t[1],4&r?t[5]:t[2]),xe(dn,dn,Lo),Fp(e,dn);return e}computeAttachmentOrigin(e){this._lodRenderer.instanceData.getGlobalTransform(this.instanceIndex,Lo),e.render.origin[0]+=Lo[12],e.render.origin[1]+=Lo[13],e.render.origin[2]+=Lo[14],e.render.num++}async getProjectedBoundingBox(e,t,r,s,a){const n=this.getBoundingBoxObjectSpace(a),o=wW,l=cT(n)?1:o.length;this._lodRenderer.instanceData.getGlobalTransform(this.instanceIndex,Lo);for(let h=0;h<l;h++){const u=o[h];dn[0]=n[u[0]],dn[1]=n[u[1]],dn[2]=n[u[2]],xe(dn,dn,Lo),kh[3*h+0]=dn[0],kh[3*h+1]=dn[1],kh[3*h+2]=dn[2]}if(!e(kh,0,l))return null;di(n);let c=null;this.calculateRelativeScreenBounds&&(c=this.calculateRelativeScreenBounds());for(let h=0;h<3*l;h+=3){for(let u=0;u<3;u++)n[u]=Math.min(n[u],kh[h+u]),n[u+3]=Math.max(n[u+3],kh[h+u]);c&&r.push({location:kh.slice(h,h+3),screenSpaceBoundingRect:c})}if(t&&(oo(n,Ib),this.elevationContext.mode!=="absolute-height")){let h;const u=IC(n,t.service.spatialReference,t);try{h=await t.service.queryElevation(Ib[0],Ib[1],s,u,"ground")}catch{}g(h)&&qA(n,0,0,-this.alignedSampledElevation+h)}return n}addObjectState(e,t){if(e===Hp.Highlight){const r=new Ax(e);this._addHighlightId(r),t.addExternal(s=>{this._removeHighlightId(s)},r)}}removeObjectState(e){this._highlights.forEach(t=>e.remove(t))}_addHighlightId(e){this._highlights.add(e),this._lodRenderer.instanceData.setHighlight(this.instanceIndex,!0)}_removeHighlightId(e){this._highlights.delete(e),this._lodRenderer.instanceData.setHighlight(this.instanceIndex,this._highlights.size>0)}get _lodRenderer(){return this.graphics3DSymbolLayer.lodRenderer}};const kh=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],dn=T(),Ib=T(),wW=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]],Lo=ce();function TW(i){const e=new Array;return i.stageResources.geometries.forEach(t=>{const r=i.stageResources.textures;e.push(new qI(t,r))}),{components:e,minScreenSpaceRadius:je(i.lodThreshold,0),pivotOffset:i.pivotOffset}}function CW(i){return{levels:i.map(e=>TW(e))}}var ti;function SW(i){let e=mr().mat4f64(w.LOCALTRANSFORM).mat4f64(w.GLOBALTRANSFORM).vec4f64(w.BOUNDINGSPHERE).vec3f64(w.MODELORIGIN).mat3f(w.MODEL).mat3f(w.MODELNORMAL).vec2f(w.MODELSCALEFACTORS);return i.includes("color")&&(e=e.vec4f(w.COLOR)),i.includes("featureAttribute")&&(e=e.vec4f(w.FEATUREATTRIBUTE)),e=e.u8(w.STATE).u8(w.LODLEVEL),i.includes(w.OBJECTANDLAYERIDCOLOR)&&(e=e.vec4u8(w.OBJECTANDLAYERIDCOLOR)),e.alignTo(8),e}(function(i){i[i.ALLOCATED=1]="ALLOCATED",i[i.DEFAULT_ACTIVE=2]="DEFAULT_ACTIVE",i[i.VISIBLE=4]="VISIBLE",i[i.HIGHLIGHT=8]="HIGHLIGHT",i[i.HIGHLIGHT_ACTIVE=16]="HIGHLIGHT_ACTIVE",i[i.REMOVE=32]="REMOVE",i[i.TRANSFORM_CHANGED=64]="TRANSFORM_CHANGED",i[i.ACTIVE=18]="ACTIVE"})(ti||(ti={}));let PW=class{constructor(e){this.localTransform=e.getField(w.LOCALTRANSFORM,_2),this.globalTransform=e.getField(w.GLOBALTRANSFORM,_2),this.modelOrigin=e.getField(w.MODELORIGIN,_y),this.model=e.getField(w.MODEL,rf),this.modelNormal=e.getField(w.MODELNORMAL,rf),this.modelScaleFactors=e.getField(w.MODELSCALEFACTORS,hM),this.boundingSphere=e.getField(w.BOUNDINGSPHERE,$6),this.color=e.getField(w.COLOR,sf),this.featureAttribute=e.getField(w.FEATUREATTRIBUTE,sf),this.state=e.getField(w.STATE,y2),this.lodLevel=e.getField(w.LODLEVEL,y2),this.objectAndLayerIdColor=e.getField(w.OBJECTANDLAYERIDCOLOR,fh)}},sp=class extends Ie{constructor(e,t){super(e),this.events=new Ms,this._capacity=0,this._size=0,this._next=0,this._buffer=null,this._view=null,this._layout=SW(t)}get capacity(){return this._capacity}get size(){return this._size}get buffer(){return this._buffer.buffer}get view(){return this._view}addInstance(){this._size+1>this._capacity&&this._grow();const e=this._findSlot();return this._view.state.set(e,ti.ALLOCATED),this._size++,this.events.emit("instances-changed"),e}removeInstance(e){const t=this._view.state;dt(e>=0&&e<this._capacity&&(t.get(e)&ti.ALLOCATED)!=0,"invalid instance handle"),this._getStateFlag(e,ti.ACTIVE)?this._setStateFlags(e,ti.REMOVE):this.freeInstance(e),this.events.emit("instances-changed")}freeInstance(e){const t=this._view.state;dt(e>=0&&e<this._capacity&&(t.get(e)&ti.ALLOCATED)!=0,"invalid instance handle"),t.set(e,0),this._size--}setLocalTransform(e,t,r=!0){this._view.localTransform.setMat(e,t),r&&this.updateModelTransform(e)}getLocalTransform(e,t){this._view.localTransform.getMat(e,t)}setGlobalTransform(e,t,r=!0){this._view.globalTransform.setMat(e,t),r&&this.updateModelTransform(e)}getGlobalTransform(e,t){this._view.globalTransform.getMat(e,t)}updateModelTransform(e){const t=this._view,r=Sc,s=kn;t.localTransform.getMat(e,hR),t.globalTransform.getMat(e,Lb);const a=pr(Lb,Lb,hR);j(r,a[12],a[13],a[14]),t.modelOrigin.setVec(e,r),Xl(s,a),t.model.setMat(e,s);const n=_8(Sc,a);n.sort(),t.modelScaleFactors.set(e,0,n[1]),t.modelScaleFactors.set(e,1,n[2]),Jp(s,s),ic(s,s),t.modelNormal.setMat(e,s),this._setStateFlags(e,ti.TRANSFORM_CHANGED),this.events.emit("instance-transform-changed",{index:e})}getModelTransform(e,t){const r=this._view;r.model.getMat(e,kn),r.modelOrigin.getVec(e,Sc),t[0]=kn[0],t[1]=kn[1],t[2]=kn[2],t[3]=0,t[4]=kn[3],t[5]=kn[4],t[6]=kn[5],t[7]=0,t[8]=kn[6],t[9]=kn[7],t[10]=kn[8],t[11]=0,t[12]=Sc[0],t[13]=Sc[1],t[14]=Sc[2],t[15]=1}applyShaderTransformation(e,t){g(this.shaderTransformation)&&this.shaderTransformation.applyTransform(this,e,t)}getCombinedModelTransform(e,t){return this.getModelTransform(e,t),g(this.shaderTransformation)&&this.shaderTransformation.applyTransform(this,e,t),t}getCombinedLocalTransform(e,t){return this._view.localTransform.getMat(e,t),g(this.shaderTransformation)&&this.shaderTransformation.applyTransform(this,e,t),t}getCombinedMaxScaleFactor(e){let t=this._view.modelScaleFactors.get(e,1);if(g(this.shaderTransformation)){const r=this.shaderTransformation.scaleFactor(Sc,this,e);t*=Math.max(r[0],r[1],r[2])}return t}getCombinedMedianScaleFactor(e){let t=this._view.modelScaleFactors.get(e,0);if(g(this.shaderTransformation)){const r=this.shaderTransformation.scaleFactor(Sc,this,e);t*=OW(r[0],r[1],r[2])}return t}getModel(e,t){this._view.model.getMat(e,t)}setFeatureAttribute(e,t){this._view.featureAttribute.setVec(e,t)}getFeatureAttribute(e,t){this._view.featureAttribute.getVec(e,t)}setColor(e,t){this._view.color.setVec(e,t)}setObjectAndLayerIdColor(e,t){this._view.objectAndLayerIdColor.setVec(e,t)}getColor(e,t){this._view.color.getVec(e,t)}setVisible(e,t){t!==this.getVisible(e)&&(this._setStateFlag(e,ti.VISIBLE,t),this.events.emit("instance-visibility-changed",{index:e}))}getVisible(e){return this._getStateFlag(e,ti.VISIBLE)}setHighlight(e,t){t!==this.getHighlight(e)&&(this._setStateFlag(e,ti.HIGHLIGHT,t),this.events.emit("instance-highlight-changed"))}getHighlight(e){return this._getStateFlag(e,ti.HIGHLIGHT)}getState(e){return this._view.state.get(e)}getLodLevel(e){return this._view.lodLevel.get(e)}countFlags(e){let t=0;for(let r=0;r<this._capacity;++r)this.getState(r)&e&&++t;return t}_setStateFlags(e,t){const r=this._view.state;t=r.get(e)|t,r.set(e,t)}_clearStateFlags(e,t){const r=this._view.state;t=r.get(e)&~t,r.set(e,t)}_setStateFlag(e,t,r){r?this._setStateFlags(e,t):this._clearStateFlags(e,t)}_getStateFlag(e,t){return!!(this._view.state.get(e)&t)}_grow(){const e=Math.max(RW,Math.floor(this._capacity*EW)),t=this._layout.createBuffer(e);if(this._buffer){const r=new Uint8Array(this._buffer.buffer);new Uint8Array(t.buffer).set(r)}this._capacity=e,this._buffer=t,this._view=new PW(this._buffer)}_findSlot(){const e=this._view.state;let t=this._next;for(;e.get(t)&ti.ALLOCATED;)t=t+1===this._capacity?0:t+1;return this._next=t+1===this._capacity?0:t+1,t}};function OW(i,e,t){return Math.max(Math.min(i,e),Math.min(Math.max(i,e),t))}d([v({constructOnly:!0})],sp.prototype,"shaderTransformation",void 0),d([v()],sp.prototype,"_size",void 0),d([v({readOnly:!0})],sp.prototype,"size",null),sp=d([Y("esri.views.3d.webgl-engine.lib.lodRendering.InstanceData")],sp);const RW=1024,EW=2,Sc=T(),kn=ys(),hR=ce(),Lb=ce();let AW=class extends ho{constructor(e,t){super(r=>Q9(this._instanceData.view.boundingSphere.getVec(r,this._tmpSphere)),{maximumDepth:25}),this._tmpSphere=Nn(),this._tmpMat4=ce(),this._instanceData=e,this._boundingSphere=t}addInstance(e){const t=this._instanceData.view.boundingSphere,r=this._instanceData.getCombinedModelTransform(e,this._tmpMat4);xe(this._tmpSphere,this._boundingSphere.center,r),this._tmpSphere[3]=this._boundingSphere.radius*Dd(r),t.setVec(e,this._tmpSphere),this.add([e])}removeInstance(e){this.remove([e])}},MW=class{constructor(e,t){this._worldSpaceRadius=e,this._minScreenSpaceRadii=t}selectLevel(e,t,r){const s=r.computeScreenPixelSizeAt(e),a=this._worldSpaceRadius*t/s;let n=0;for(let o=1;o<this._minScreenSpaceRadii.length;++o)a>=this._minScreenSpaceRadii[o]&&(n=o);return n}},DW=class extends Ev{constructor(e,t,r,s,a,n){super(e,t),this.layerUid=e,this.graphicUid=t,this.geometryId=r,this.triangleNr=s,this.baseBoundingSphere=a,this.numLodLevels=n}};function eS(i){return So(i)&&i.intersector===ci.LOD&&!!i.target}let IW=class{constructor(e,t){const r=e.renderContext.rctx,s=t.geometry;this._materialRepository=e.materialRepository,s.material.setParameters({instancedDoublePrecision:!0});const a=s.material.createBufferWriter(),n=a.vertexBufferLayout,o=a.elementCount(s),l=a.allocate(o);a.write(null,null,s,l,0),this.geometry=s,this.material=s.material,this.glMaterials=new TL(s.material,this._materialRepository),this.vertexBufferLayout=n,this.vbo=gs.createVertex(r,ca.STATIC_DRAW,l.buffer),this.vao=new ac(r,Lt,{geometry:Co(n)},{geometry:this.vbo}),this.vertexCount=o}destroy(){this.glMaterials.destroy(),this.vbo.dispose(),this.vao.dispose()}get boundingInfo(){return this.geometry.boundingInfo}get triangleCount(){return this.vertexCount/3}intersect(e,t,r,s,a,n,o,l){const c=this.geometry.id;this.material.intersect(this.geometry,e.transform.transform,e,r,s,(h,u,p,m,f)=>{if(h>=0){if(t!=null&&!t(e.rayBegin,e.rayEnd,h))return;const y=new DW(n.layerUid,n.graphicUid(a),c,p,o,l);if((e.results.min.drapedLayerOrder==null||f>=e.results.min.drapedLayerOrder)&&(e.results.min.dist==null||h<e.results.min.dist)&&e.results.min.set(ci.LOD,y,h,u,e.transform.transform,f),e.options.store!==Vr.MIN&&(e.results.max.drapedLayerOrder==null||f>=e.results.max.drapedLayerOrder)&&(e.results.max.dist==null||h>e.results.max.dist)&&e.results.max.set(ci.LOD,y,h,u,e.transform.transform,f),e.options.store===Vr.ALL){const b=hC(e.results.min.ray);b.set(ci.LOD,y,h,u,e.transform.transform,f),e.results.all.push(b)}}})}},LW=class KL{static async create(e,t,r){const s=await Promise.allSettled(t.components.map(n=>e.controller.schedule(()=>new IW(e,n),r))),a=s.map(n=>n.status==="fulfilled"?n.value:null).filter(g);if(Qo(r)||a.length!==s.length){a.forEach(n=>n.destroy()),lr(r);for(const n of s)if(n.status==="rejected")throw n.reason}return new KL(t.minScreenSpaceRadius,a)}constructor(e,t){this.minScreenSpaceRadius=e,this.components=t}destroy(){this.components.forEach(e=>e.destroy())}intersect(e,t,r,s,a,n,o){this.components.forEach(l=>l.intersect(e,t,r,s,a,n,this.boundingSphere,o))}get boundingBox(){if(P(this._boundingBox)){const e=di();this.components.forEach(t=>{g(t.boundingInfo)&&(Fp(e,t.boundingInfo.bbMin),Fp(e,t.boundingInfo.bbMax))}),this._boundingBox=e}return this._boundingBox}get boundingSphere(){if(P(this._boundingSphere)){const e=this.boundingBox,t=T();oo(e,t),this._boundingSphere={center:t,radius:.5*r3(e)}}return this._boundingSphere}get triangleCount(){return this.components.reduce((e,t)=>e+t.triangleCount,0)}},$W=class{constructor(e,t,r){this._elementSize=t,this._buffer=gs.createVertex(e,ca.STATIC_DRAW),this.resize(r)}destroy(){this._buffer.dispose()}get elementSize(){return this._elementSize}get capacity(){return this._capacity}get array(){return this._array}get buffer(){return this._buffer}get memoryUsage(){return{cpu:this._capacity*this._elementSize,gpu:this._capacity*this._elementSize}}copyRange(e,t,r,s=0){const a=new Uint8Array(this.array,e*this.elementSize,(t-e)*this.elementSize);new Uint8Array(r.array,s*this.elementSize).set(a)}transferAll(){this._buffer.setData(this._array)}transferRange(e,t){const r=e*this._elementSize,s=t*this._elementSize;this._buffer.setSubData(new Uint8Array(this._array),r,r,s)}resize(e){const t=e*this._elementSize,r=new ArrayBuffer(t);this._array&&(e>=this._capacity?new Uint8Array(r).set(new Uint8Array(this._array)):new Uint8Array(r).set(new Uint8Array(this._array).subarray(0,e*this._elementSize))),this._array=r,this._buffer.setSize(t),this._capacity=e}},NW=class{constructor(e){this.modelOriginHi=e.getField(w.MODELORIGINHI,_h),this.modelOriginLo=e.getField(w.MODELORIGINLO,_h),this.model=e.getField(w.MODEL,rf),this.modelNormal=e.getField(w.MODELNORMAL,rf),this.color=e.getField(w.INSTANCECOLOR,sf),this.featureAttribute=e.getField(w.INSTANCEFEATUREATTRIBUTE,sf),this.objectAndLayerIdColor=e.getField(w.OBJECTANDLAYERIDCOLOR_INSTANCED,fh)}},dR=class{constructor(e,t){this._headIndex=0,this._tailIndex=0,this._firstIndex=null,this._captureFirstIndex=!0,this._updating=!1,this._prevHeadIndex=0,this._resized=!1,this._rctx=e,this._instanceBufferLayout=t,this._elementSize=t.stride,this._capacity=1}destroy(){this._buffer&&this._buffer.destroy()}get buffer(){return this._buffer.buffer}get view(){return this._view}get capacity(){return this._capacity}get size(){const e=this._headIndex,t=this._tailIndex;return e>=t?e-t:e+this._capacity-t}get isEmpty(){return this._headIndex===this._tailIndex}get isFull(){return this._tailIndex===(this._headIndex+1)%this._capacity}get headIndex(){return this._headIndex}get tailIndex(){return this._tailIndex}get firstIndex(){return this._firstIndex}get memoryUsage(){return this._buffer?this._buffer.memoryUsage:{cpu:0,gpu:0}}reset(){this._headIndex=0,this._tailIndex=0,this._firstIndex=null}startUpdateCycle(){this._captureFirstIndex=!0}beginUpdate(){dt(!this._updating,"already updating"),this._updating=!0,this._prevHeadIndex=this._headIndex}endUpdate(){dt(this._updating,"not updating"),this.size<zW*this.capacity&&this._shrink(),this._resized?(this._buffer.transferAll(),this._resized=!1):this._transferRange(this._prevHeadIndex,this._headIndex),this._updating=!1}allocateHead(){dt(this._updating,"not updating"),this.isFull&&this._grow();const e=this.headIndex;return this._captureFirstIndex&&(this._firstIndex=e,this._captureFirstIndex=!1),this._incrementHead(),dt(this._headIndex!==this._tailIndex,"invalid pointers"),e}freeTail(){dt(this._updating,"not updating"),dt(this.size>0,"invalid size");const e=this._tailIndex===this._firstIndex;this._incrementTail(),e&&(this._firstIndex=this._tailIndex)}_grow(){const e=Math.max(uR,Math.floor(this._capacity*FW));this._resize(e)}_shrink(){const e=Math.max(uR,Math.floor(this._capacity*UW));this._resize(e)}_resize(e){if(dt(this._updating,"not updating"),e===this._capacity)return;const t=new $W(this._rctx,this._elementSize,e);if(this._buffer){this._firstIndex&&(this._firstIndex=(this._firstIndex+this._capacity-this._tailIndex)%this._capacity);const r=this.size,s=this._compactInstances(t);dt(s===r,"invalid compaction"),this._buffer.destroy(),this._tailIndex=0,this._headIndex=s,this._prevHeadIndex=0}this._resized=!0,this._capacity=e,this._buffer=t,this._view=new NW(this._instanceBufferLayout.createView(this._buffer.array))}_compactInstances(e){const t=this._headIndex,r=this._tailIndex;return r<t?(this._buffer.copyRange(r,t,e),t-r):r>t?(this._buffer.copyRange(r,this._capacity,e),t>0&&this._buffer.copyRange(0,t,e,this._capacity-r),t+(this._capacity-r)):0}_incrementHead(e=1){this._headIndex=(this._headIndex+e)%this._capacity}_incrementTail(e=1){this._tailIndex=(this._tailIndex+e)%this._capacity}_transferRange(e,t){e<t?this._buffer.transferRange(e,t):e>t&&(t>0&&this._buffer.transferRange(0,t),this._buffer.transferRange(e,this._capacity))}};const uR=1024,FW=2,zW=.3,UW=.5,VW=i=>{const e=i.baseBoundingSphere.radius,t=i.levels.map(r=>r.minScreenSpaceRadius);return new MW(e,t)};let fn=class extends Ie{constructor(e,t){super(e),this.type=ci.LOD,this.isGround=!1,this._levels=[],this._defaultRenderInstanceData=[],this._highlightRenderInstanceData=[],this._instanceIndex=0,this._cycleStartIndex=0,this._slicePlane=!1,this._camera=new Fe,this._updateCyclesWithStaticCamera=-1,this._needFullCycle=!1,this.slots=[K.OPAQUE_MATERIAL,K.TRANSPARENT_MATERIAL],this.canRender=!0,this._instanceData=new sp({shaderTransformation:e.shaderTransformation},e.optionalFields),this._frameTask=t.registerTask(Zi.LOD_RENDERER,this)}initialize(){this._instanceBufferLayout=BW(this.optionalFields),this._glInstanceBufferLayout=Co(this._instanceBufferLayout,1),this._instanceData.events.on("instances-changed",()=>this._requestUpdateCycle()),this._instanceData.events.on("instance-transform-changed",({index:e})=>{this._requestUpdateCycle(),this.metadata.notifyGraphicGeometryChanged(e)}),this._instanceData.events.on("instance-visibility-changed",({index:e})=>{this._requestUpdateCycle(!0),this.metadata.notifyGraphicVisibilityChanged(e)}),this._instanceData.events.on("instance-highlight-changed",()=>this._requestUpdateCycle(!0))}destroy(){this._frameTask.remove()}get _enableLevelSelection(){return this.symbol.levels.length>1}get levels(){return this._levels}get baseBoundingBox(){return this._levels[this._levels.length-1].boundingBox}get baseBoundingSphere(){return this._levels[this._levels.length-1].boundingSphere}get baseMaterial(){return this._levels[this._levels.length-1].components[0].material}get slicePlaneEnabled(){return this._slicePlane}set slicePlaneEnabled(e){this._slicePlane=e}get layerUid(){return this.metadata.layerUid}get instanceData(){return this._instanceData}get memoryUsage(){const e={cpu:0,gpu:0};return this._defaultRenderInstanceData.forEach(t=>{const r=t.memoryUsage;e.cpu+=r.cpu,e.gpu+=r.gpu}),this._highlightRenderInstanceData.forEach(t=>{const r=t.memoryUsage;e.cpu+=r.cpu,e.gpu+=r.gpu}),e}get renderStats(){const e=this._instanceData.size,t=[];return this._levels.forEach((r,s)=>{const a=this._defaultRenderInstanceData[s],n=this._highlightRenderInstanceData[s],o=a.size+n.size,l=r.triangleCount;t.push({renderedInstances:o,renderedTriangles:o*l,trianglesPerInstance:l})}),{totalInstances:e,renderedInstances:t.reduce((r,s)=>r+s.renderedInstances,0),renderedTriangles:t.reduce((r,s)=>r+s.renderedTriangles,0),levels:t}}async initializeRenderContext(e,t){this._context=e;const r=e.renderContext.rctx,s=await Promise.allSettled(this.symbol.levels.map(n=>(this._defaultRenderInstanceData.push(new dR(r,this._instanceBufferLayout)),this._highlightRenderInstanceData.push(new dR(r,this._instanceBufferLayout)),LW.create(e,n,t)))),a=s.map(n=>n.status==="fulfilled"?n.value:null).filter(g);if(Qo(t)||a.length!==s.length){a.forEach(n=>n.destroy()),lr(t);for(const n of s)if(n.status==="rejected")throw n.reason}this._levels=a,this._levelSelector=VW(this)}uninitializeRenderContext(){this._invalidateOctree(),this._levels.forEach(e=>e.destroy()),this._defaultRenderInstanceData.forEach(e=>e.destroy()),this._highlightRenderInstanceData.forEach(e=>e.destroy())}get needsTransparentPass(){return this._levels.some(e=>e.components.some(t=>t.material.requiresSlot(K.TRANSPARENT_MATERIAL,A.Color)))}get needsHighlight(){return this._highlightRenderInstanceData.some(e=>e.size>0)}prepareRender(e){if(!Ot.LOD_INSTANCE_RENDERER_DISABLE_UPDATES){if(this._enableLevelSelection){const t=e.bindParameters.contentCamera.equals(this._camera);this._camera.copyFrom(e.bindParameters.contentCamera),t||this._requestUpdateCycle()}this._needFullCycle&&(this.runTask(Ea),this._needFullCycle=!1)}}render(e){!this.baseMaterial.isVisible()||!this.baseMaterial.isVisibleForOutput(e.output)||(e.rctx.bindVAO(),e.output!==A.Highlight&&e.output!==A.ShadowHighlight&&this._renderComponents(e,this._defaultRenderInstanceData),e.output!==A.ShadowExcludeHighlight&&this._renderComponents(e,this._highlightRenderInstanceData))}intersect(e,t,r,s){if(!this.baseMaterial.isVisible()||P(this._octree))return;const a=T();Q(a,s,r);const n=o=>{this._instanceData.getCombinedModelTransform(o,gR),e.transform.set(gR),xe(fR,r,e.transform.inverse),xe(_R,s,e.transform.inverse);const l=this._instanceData.getState(o),c=this._instanceData.getLodLevel(o),h=this._levels.length;dt((l&ti.ACTIVE)!=0,"invalid instance state"),dt(c>=0&&c<h,"invaid lod level"),this._levels[c].intersect(e,t,fR,_R,o,this.metadata,h)};this.baseMaterial.parameters.verticalOffset?this._octree.forEach(n):this._octree.forEachAlongRay(r,a,n)}queryDepthRange(e){return this._queryDepthRangeOctree(e)}notifyShaderTransformationChanged(){this._invalidateOctree(),this._requestUpdateCycle()}get _octree(){var e;if(P(this._octreeCached)){const t=this._instanceData,r=(e=t.view)==null?void 0:e.state;if(!r)return null;this._octreeCached=new AW(t,this.baseBoundingSphere);for(let s=0;s<t.capacity;++s)r.get(s)&ti.ACTIVE&&this._octreeCached.addInstance(s)}return this._octreeCached}_invalidateOctree(){this._octreeCached=Te(this._octreeCached)}_queryDepthRangeOctree(e){if(P(this._octree))return{near:1/0,far:-1/0};const t=e.viewForward,r=this._octree.findClosest(t,ho.DepthOrder.FRONT_TO_BACK,e.frustum),s=this._octree.findClosest(t,ho.DepthOrder.BACK_TO_FRONT,e.frustum);if(r==null||s==null)return{near:1/0,far:-1/0};const a=e.eye,n=this._instanceData.view;n.boundingSphere.getVec(r,$o),Q($o,$o,a);const o=J($o,t)-$o[3];n.boundingSphere.getVec(s,$o),Q($o,$o,a);const l=J($o,t)+$o[3];return{near:Math.max(e.near,o),far:Math.min(e.far,l)}}_requestUpdateCycle(e=!1){this._updateCyclesWithStaticCamera=-1,this._cycleStartIndex=this._instanceIndex,e&&(this._needFullCycle=!0,this._context.requestRender())}_startUpdateCycle(){this._updateCyclesWithStaticCamera++,this._defaultRenderInstanceData.forEach(e=>e.startUpdateCycle()),this._highlightRenderInstanceData.forEach(e=>e.startUpdateCycle())}get running(){return this._instanceData.size>0&&this._updateCyclesWithStaticCamera<1}runTask(e){const{_enableLevelSelection:t,_camera:r,_levelSelector:s}=this;this._defaultRenderInstanceData.forEach(h=>h.beginUpdate()),this._highlightRenderInstanceData.forEach(h=>h.beginUpdate());const a=this._instanceData,n=a.view;let o=a.size;const l=a.capacity;let c=this._instanceIndex;for(let h=0;h<o&&!e.done;++h){c===this._cycleStartIndex&&this._startUpdateCycle();const u=n.state.get(c);let p=0;if(!(u&ti.ALLOCATED)){c=c+1===l?0:c+1,o++;continue}const m=n.lodLevel.get(c);if(u&ti.DEFAULT_ACTIVE&&this._defaultRenderInstanceData[m].freeTail(),u&ti.HIGHLIGHT_ACTIVE&&this._highlightRenderInstanceData[m].freeTail(),u&ti.REMOVE)a.freeInstance(c);else if(u&ti.VISIBLE){let f=0;t&&(n.modelOrigin.getVec(c,mR),f=s.selectLevel(mR,a.getCombinedMedianScaleFactor(c),r)),p=u&~(ti.ACTIVE|ti.TRANSFORM_CHANGED),f>=0&&(u&ti.HIGHLIGHT?(pR(this._highlightRenderInstanceData[f],n,c),p|=ti.HIGHLIGHT_ACTIVE):(pR(this._defaultRenderInstanceData[f],n,c),p|=ti.DEFAULT_ACTIVE)),n.state.set(c,p),n.lodLevel.set(c,f)}else p=u&~(ti.ACTIVE|ti.TRANSFORM_CHANGED),n.state.set(c,p);if(g(this._octreeCached)){const f=!!(u&ti.ACTIVE),y=!!(p&ti.ACTIVE);!f&&y?this._octreeCached.addInstance(c):f&&!y?this._octreeCached.removeInstance(c):f&&y&&u&ti.TRANSFORM_CHANGED&&(this._octreeCached.removeInstance(c),this._octreeCached.addInstance(c))}c=c+1===l?0:c+1,e.madeProgress()}this._instanceIndex=c,this._defaultRenderInstanceData.forEach(h=>h.endUpdate()),this._highlightRenderInstanceData.forEach(h=>h.endUpdate()),this._context.requestRender()}_renderComponents(e,t){this.levels.forEach((r,s)=>{const a=r.components.map(n=>this._beginComponent(e,t[s],n));r.components.forEach((n,o)=>this._renderComponent(e,a[o],t[s],n,s))})}_beginComponent(e,t,r){const{bindParameters:s,rctx:a,output:n}=e;if(t.size===0||!r.material.requiresSlot(s.slot,e.output))return null;const o=r.glMaterials.load(a,s.slot,n);return g(o)?o.beginSlot(s):null}_renderComponent(e,t,r,s,a){if(P(t))return;const{bindParameters:n,rctx:o}=e,l=o.bindTechnique(t,s.material.parameters,n);o.bindVAO(s.vao),t.ensureAttributeLocations(s.vao),l.bindDraw(HW,n,s.material.parameters),Ot.LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL&&e.output===A.Color&&(l.setUniform4fv("externalColor",yR[Math.min(a,yR.length-1)]),l.setUniform1i("colorMixMode",RF.replace));const c=o.capabilities.instancing,h=r.capacity,u=r.headIndex,p=r.tailIndex,m=r.firstIndex,f=this._glInstanceBufferLayout,y=(b,x)=>{tM(o,Lt,r.buffer,f,b),c.drawArraysInstanced(t.primitiveType,0,s.vertexCount,x-b),iM(o,Lt,r.buffer,f)};s.material.parameters.transparent&&m!=null?u>p?(dt(m>=p&&m<=u,"invalid firstIndex"),y(m,u),y(p,m)):u<p&&(m<=u?(dt(m>=0&&m<=u,"invalid firstIndex"),y(m,u),y(p,h),y(0,m)):(dt(m>=p&&m<=h,"invalid firstIndex"),y(m,h),y(0,u),y(p,m))):u>p?y(p,u):u<p&&(y(0,u),y(p,h)),o.bindVAO(null)}};function pR(i,e,t){const r=i.allocateHead();GW(e,t,i.view,r)}function GW(i,e,t,r){EF(i.modelOrigin,e,t.modelOriginHi,t.modelOriginLo,r),t.model.copyFrom(r,i.model,e),t.modelNormal.copyFrom(r,i.modelNormal,e),i.color&&t.color&&t.color.copyFrom(r,i.color,e),i.objectAndLayerIdColor&&t.objectAndLayerIdColor&&t.objectAndLayerIdColor.copyFrom(r,i.objectAndLayerIdColor,e),i.featureAttribute&&t.featureAttribute&&t.featureAttribute.copyFrom(r,i.featureAttribute,e)}function BW(i){let e=mr().vec3f(w.MODELORIGINHI).vec3f(w.MODELORIGINLO).mat3f(w.MODEL).mat3f(w.MODELNORMAL);return g(i)&&i.includes("color")&&(e=e.vec4f(w.INSTANCECOLOR)),g(i)&&i.includes("featureAttribute")&&(e=e.vec4f(w.INSTANCEFEATUREATTRIBUTE)),g(i)&&i.includes("objectAndLayerIdColor")&&(e=e.vec4u8(w.OBJECTANDLAYERIDCOLOR_INSTANCED)),e}d([v({constructOnly:!0})],fn.prototype,"symbol",void 0),d([v({constructOnly:!0})],fn.prototype,"optionalFields",void 0),d([v({constructOnly:!0})],fn.prototype,"metadata",void 0),d([v({constructOnly:!0})],fn.prototype,"shaderTransformation",void 0),d([v()],fn.prototype,"_instanceData",void 0),d([v()],fn.prototype,"_cycleStartIndex",void 0),d([v({readOnly:!0})],fn.prototype,"_enableLevelSelection",null),d([v()],fn.prototype,"_updateCyclesWithStaticCamera",void 0),d([v({readOnly:!0})],fn.prototype,"running",null),fn=d([Y("esri.views.3d.webgl-engine.lib.lodRendering.LodRenderer")],fn);const mR=T(),$o=Pt(),gR=ce(),fR=T(),_R=T(),yR=[hi(1,0,1,1),hi(0,0,1,1),hi(0,1,0,1),hi(1,1,0,1),hi(1,0,0,1)],HW=new OF;let vR=class{constructor(e,t,r,s,a,n,o,l,c,h,u,p){this.lodResources=e,this.lodRenderer=t,this.stageResources=r,this.originalMaterialParameters=s,this.resourceSize=a,this.isEsriSymbolResource=n,this.isWosr=o,this.resourceBoundingBox=l,this.symbolSize=c,this.extentPadding=h,this.physicalBasedRenderingEnabled=u,this.pivotOffset=p}},kW=class extends _l{getCachedSize(){const[e,t,r]=g(this._resources)?this._resources.symbolSize:[1,1,1];return{width:e,depth:t,height:r}}constructor(e,t,r,s){super(e,t,r,s),this._resources=null,this._optionalFields=new Array,this._instanceIndexToGraphicUid=new Map,this._hasLoadedPBRTextures=!1,this._disposeResourceHandles=new Array,this.ensureDrapedStatus(!1),this._hasLoadedPBRTextures=r.physicalBasedRenderingEnabled}async doLoad(e){if(!this._drivenProperties.size&&Uv(this.symbolLayer))throw new Error;const t=this.symbolLayer;if(this._isPrimitive){const r=t.resource?t.resource.primitive:WA;this._resources=await this._createResourcesForPrimitive(r,e)}else this._resources=await this._createResourcesForUrl(t.resource.href,e);this.layerOpacityChanged(),this.slicePlaneEnabledChanged(),this.physicalBasedRenderingChanged(),this.complexity=this.computeComplexity()}get extentPadding(){return g(this._resources)?this._resources.extentPadding:0}get _isPrimitive(){return!(this.symbolLayer.resource&&this.symbolLayer.resource.href)}get lodRenderer(){return g(this._resources)?this._resources.lodRenderer:null}_setMaterialTransparencyParams(e,t=Ur(this.symbolLayer,"material","color")){const r=this._getCombinedOpacity(t),s=r<1||this.needsDrivenTransparentPass;return e.transparent=s,e.opacity=r,e.cullFace=s?Tr.None:Tr.Back,e}async _createResourcesForPrimitive(e,t){if(!yk(e))throw new Error(`Unknown object symbol primitive: ${e}`);const r=this.symbolLayer,s=_s(PN(e)),a=wn(t_(s)),n=wn(l1(a,r)),o=pe(n),l=!1,c=!1,h={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0,ambient:Yc,diffuse:Yc,hasSlicePlane:this._context.slicePlaneEnabled,hasSliceHighlight:!1,castShadows:this.symbolLayer.castShadows,offsetTransparentBackfaces:!this.symbolLayer.isPrimitive},u=!!h.usePBR;this._setMaterialTransparencyParams(h);const p=this.symbol;if(p.type==="point-3d"&&p.verticalOffset){const{screenLength:S,minWorldLength:C,maxWorldLength:O}=p.verticalOffset;h.verticalOffset={screenLength:ta(S),minWorldLength:C||0,maxWorldLength:g(O)?O:1/0},h.castShadows=!1}if(this._context.screenSizePerspectiveEnabled&&(h.screenSizePerspective=this._context.sharedResources.screenSizePerspectiveSettings),this._drivenProperties.color)h.externalColor=no;else{const S=g(r.material)?r.material.color:null,C=g(S)?ui.toUnitRGBA(S):no;h.externalColor=C}this._fastUpdates=Pf(this._context.renderer,this._fastVisualVariableConvertOptions(s,n,a,hu)),h.instanced=["transformation"],this._fastUpdates.enabled?(Object.assign(h,this._fastUpdates.materialParameters),h.instanced.push("featureAttribute"),this._optionalFields.push("featureAttribute")):this._hasPerInstanceColor()&&(h.instanced.push("color"),this._optionalFields.push("color")),vi("enable-feature:objectAndLayerId-rendering")&&(h.instanced.push("objectAndLayerIdColor"),this._optionalFields.push("objectAndLayerIdColor"));const m=new Kg(h),f=XI(e,m);if(!f)throw new Error(`Unknown object symbol primitive: ${e}`);const y=N_(f).map(S=>({opacity:1,transparent:S.parameters.transparent})),b=await this._createStageResources(f,u,t),x=await this._createLodRenderer(f,t);return new vR(f,x,b,y,a,l,c,s,n,o,u,hu)}async _createResourcesForUrl(e,t){const r=["transformation"],s={materialParamsMixin:{instanced:r,hasSlicePlane:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows},streamDataRequester:this._context.streamDataRequester,cache:this._context.sharedResources.objectResourceCache};this._fastUpdates=Pf(this._context.renderer,this._fastVisualVariableConvertOptions(hu,hu,hu,hu)),this._fastUpdates.enabled?(Object.assign(s.materialParamsMixin,this._fastUpdates.materialParameters),r.push("featureAttribute"),this._optionalFields.push("featureAttribute")):this._hasPerInstanceColor()&&(r.push("color"),this._optionalFields.push("color")),vi("enable-feature:objectAndLayerId-rendering")&&(r.push("objectAndLayerIdColor"),this._optionalFields.push("objectAndLayerIdColor"));const a=this.symbol;if(a.type==="point-3d"&&a.verticalOffset){const{screenLength:F,minWorldLength:N,maxWorldLength:G}=a.verticalOffset;s.materialParamsMixin.verticalOffset={screenLength:ta(F),minWorldLength:N||0,maxWorldLength:g(G)?G:1/0},s.materialParamsMixin.castShadows=!1}s.signal=t,s.usePBR=this._context.physicalBasedRenderingEnabled,s.skipHighLods=this._context.skipHighSymbolLods;const n=s.usePBR,o=await AF(e,s),l=o.isEsriSymbolResource,c=o.isWosr,h=CW(o.lods);h.levels.sort((F,N)=>F.minScreenSpaceRadius-N.minScreenSpaceRadius);const u=this._context,p=this.symbolLayer.material,m=this._getExternalColorParameters(p),f=Ur(this.symbolLayer,"material","color"),y=this._getCombinedOpacity(f,{hasIntrinsicColor:!0}),b=this.needsDrivenTransparentPass,x=N_(h),S=N_(h).map(F=>({opacity:F.parameters.opacity||1,transparent:F.parameters.transparent}));x.forEach(F=>{const N=F.parameters;F.setParameters(m);const G=N.opacity*y,q=G<1||b||N.transparent;F.setParameters({opacity:G,transparent:q}),u.screenSizePerspectiveEnabled&&F.setParameters({screenSizePerspective:u.sharedResources.screenSizePerspectiveSettings})});const C=o.referenceBoundingBox,O=wn(t_(C)),R=wn(h.levels[0].pivotOffset),E=wn(l1(O,this.symbolLayer)),$=pe(E);Of(this._fastUpdates,this._context.renderer,this._fastVisualVariableConvertOptions(C,E,O,R))&&x.forEach(F=>F.setParameters(this._fastUpdates.materialParameters));const M=await this._createStageResources(h,n,t),L=await this._createLodRenderer(h,t);return new vR(h,L,M,S,O,l,c,C,E,$,n,R)}_addDisposeResource(e){this._disposeResourceHandles.push(e)}async _createStageResources(e,t,r){const s=this._context.stage,a=N_(e);t!==this._context.physicalBasedRenderingEnabled&&this.physicalBasedRenderingChanged(),s.addMany(a),this._addDisposeResource(()=>s.removeMany(a));const n=sO(e);s.addMany(n),this._addDisposeResource(()=>s.removeMany(n)),await s.load(n,r),lr(r);const o=aO(e);return s.addMany(o),this._addDisposeResource(()=>s.removeMany(o)),{materials:a,textures:n,geometries:o}}async _createLodRenderer(e,t){const r=this._context.stage,s={layerUid:this._context.layer.uid,graphicUid:o=>this._instanceIndexToGraphicUid.get(o),notifyGraphicGeometryChanged:o=>this._context.notifyGraphicGeometryChanged(this._instanceIndexToGraphicUid.get(o)),notifyGraphicVisibilityChanged:o=>this._context.notifyGraphicVisibilityChanged(this._instanceIndexToGraphicUid.get(o))},a=this._fastUpdates.enabled?{applyTransform:(o,l,c)=>{o.getFeatureAttribute(l,Z_),Kr(c,Pw(this._fastUpdates.materialParameters,Z_,c))},scaleFactor:(o,l,c)=>(l.getFeatureAttribute(c,Z_),Eq(o,this._fastUpdates.materialParameters,Z_))}:null,n=new fn({symbol:e,optionalFields:this._optionalFields,metadata:s,shaderTransformation:a},this._context.scheduler);return n.slicePlaneEnabled=this._context.slicePlaneEnabled,this._addDisposeResource(()=>{r.removeRenderPlugin(n),n.destroy()}),await r.addRenderPlugin(n.slots,n,t),n}_getExternalColorParameters(e){const t={};return this._drivenProperties.color?t.externalColor=no:g(e)&&g(e.color)?t.externalColor=ui.toUnitRGBA(e.color):(t.externalColor=no,t.colorMixMode="ignore"),t}destroy(){super.destroy(),this._cleanupResources()}_cleanupResources(){this._disposeResourceHandles.forEach(e=>e()),this._disposeResourceHandles.length=0,this._resources=null}createGraphics3DGraphic(e){const t=e.graphic;if(!this._validateGeometry(t.geometry))return null;const r=wf(t.geometry);if(P(r))return this.logger.warn(`unsupported geometry type for icon symbol: ${t.geometry.type}`),null;const s=this.setGraphicElevationContext(t,new Po),a=e.renderingInfo;return this._createAs3DShape(t,r,a,s,t.uid,e.layer.uid)}notifyDestroyGraphicLayer(e){this._instanceIndexToGraphicUid.delete(e.instanceIndex)}graphicLayerToGraphicId(){return 0}layerOpacityChanged(){if(P(this._resources))return;const e=this._drivenProperties.opacity,t=!this._isPrimitive,r=this._resources.stageResources.materials,s=this._resources.originalMaterialParameters;for(let a=0;a<r.length;a++){const n=r[a],o=Ur(this.symbolLayer,"material","color"),l=s[a],c=this._getCombinedOpacity(o,{hasIntrinsicColor:t})*l.opacity,h=c<1||e||l.transparent;n.setParameters({opacity:c,transparent:h}),this._isPrimitive&&n.setParameters({cullFace:h?Tr.None:Tr.Back})}}layerElevationInfoChanged(e,t){return this.updateGraphics3DGraphicElevationInfo(e,t,wh)}slicePlaneEnabledChanged(){if(P(this._resources))return!0;this._resources.lodRenderer.slicePlaneEnabled=this._context.slicePlaneEnabled;for(const e of this._resources.stageResources.materials)e.setParameters({hasSlicePlane:this._context.slicePlaneEnabled});return!0}physicalBasedRenderingChanged(){if(P(this._resources))return!0;const{stageResources:e,isWosr:t}=this._resources;for(const r of e.materials)this._isPrimitive?r.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}):t||r.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!1});return this._hasLoadedPBRTextures!==!1||this._context.physicalBasedRenderingEnabled!==!0||(this._hasLoadedPBRTextures=!0,!1)}pixelRatioChanged(){return!0}skipHighSymbolLodsChanged(){return!1}applyRendererDiff(e,t){if(P(this._resources))return dr.Recreate_Symbol;const{stageResources:{materials:r},lodRenderer:s,resourceBoundingBox:a,symbolSize:n,resourceSize:o,pivotOffset:l}=this._resources;for(const c in e.diff){if(c!=="visualVariables"||!Of(this._fastUpdates,t,this._fastVisualVariableConvertOptions(a,n,o,l)))return dr.Recreate_Symbol;for(const h of r)h.setParameters(this._fastUpdates.materialParameters);s.notifyShaderTransformationChanged()}return dr.Fast_Update}computeComplexity(){if(P(this._resources))return super.computeComplexity();const e=this._resources.lodResources,t=WI(e.levels[0]).reduce((a,n)=>a+n.indices.get(w.POSITION).length,0)/3,r=a=>Array.from(a.vertexAttributes.values()).reduce((n,o)=>{var l;return n+(((l=o.data.buffer)==null?void 0:l.byteLength)??0)},0)+Array.from(a.indices.values()).reduce((n,o)=>n+(Array.isArray(o)?12*o.length:o.buffer.byteLength),0),s=sO(e).reduce((a,n)=>a+(n.params.encoding&&n.params.encoding==="image/ktx2"?n.estimatedTexMemRequired:n.estimatedTexMemRequired/4),0)+aO(e).reduce((a,n)=>a+r(n),0);return{primitivesPerFeature:t,primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!1,memory:{...ZI(this.symbol,this.symbolLayer),resourceBytes:s}}}_hasLodRenderer(){return g(this._resources)}_createAs3DShape(e,t,r,s,a,n){if(!this._hasLodRenderer()||P(this._resources))return null;const o=this.getFastUpdateAttrValues(e),l=!this._fastUpdates.enabled&&this._hasPerInstanceColor()?Mg(r.color,r.opacity):null,c=this._context.clippingExtent;if(ts(t,Fu,this._context.elevationProvider.spatialReference),g(c)&&!mT(c,Fu))return null;const h=this._requiresTerrainElevation(s),u=this._computeGlobalTransform(t,s,$b,Y_),p=this._computeLocalTransform(this._resources,this.symbolLayer,r,bR),m=this._resources.lodRenderer.instanceData,f=m.addInstance();this._instanceIndexToGraphicUid.set(f,a),m.setLocalTransform(f,p,!1),m.setGlobalTransform(f,u),o&&m.setFeatureAttribute(f,o),l&&m.setColor(f,l),g(this._context.stage.renderView.objectAndLayerIdRenderHelper)&&m.setObjectAndLayerIdColor(f,this._context.stage.renderView.objectAndLayerIdRenderHelper.getObjectAndLayerIdColor({graphicUid:a,layerUid:n}));const y=new xW(this,f,lk,s);return h&&(y.alignedSampledElevation=Y_.sampledElevation),y.needsElevationUpdates=wh(s.mode),xf(y,t,this._context.elevationProvider),y}_computeGlobalTransform(e,t,r,s){return cm(e,this._context.elevationProvider,t,this._context.renderCoordsHelper,s),Fu[0]=e.x,Fu[1]=e.y,Fu[2]=s.z,Zl(e.spatialReference,Fu,r,this._context.renderCoordsHelper.spatialReference),r}_computeLocalTransform(e,t,r,s){return Ad(s),this._applyObjectRotation(r,!1,s),this._applyObjectRotation(t,!0,s),this._applyObjectScale(e,r,s),this._applyAnchor(e,t,s),s}_applyObjectScale(e,t,r){if(this._fastUpdates.enabled&&this._fastUpdates.requiresShaderTransformation)return;const s=this._drivenProperties.size&&t.size?t.size:e.symbolSize,a=iO(s,e.symbolSize,e.resourceSize,this._context.renderCoordsHelper.unitInMeters);a[0]===1&&a[1]===1&&a[2]===1||JA(r,r,a)}prepareSymbolLayerPatch(e){if(e.diff.type!=="partial")return;const t=e.diff.diff;this._preparePatchTransform(e,t),this._preparePatchColor(e,t)}updateGeometry(e,t){if(P(this._resources))return!0;const r=t&&wf(t);if(P(r))return!1;const s=this.getGeometryElevationMode(t);return e.elevationContext.mode===s&&(this._computeGlobalTransform(r,e.elevationContext,$b,Y_),this._requiresTerrainElevation(e.elevationContext)&&(e.alignedSampledElevation=Y_.sampledElevation),this._resources.lodRenderer.instanceData.setGlobalTransform(e.instanceIndex,$b,!0),xf(e,r,this._context.elevationProvider),!0)}_preparePatchTransform(e,t){if(!(t.heading||t.tilt||t.roll||t.width||t.height||t.depth||t.anchor||t.anchorPosition)||P(this._resources))return;const r=(f,y,b)=>je(f!=null&&f.type==="complete"?f.newValue:y,b),s=r(t.heading,this.symbolLayer.heading,0),a=r(t.tilt,this.symbolLayer.tilt,0),n=r(t.roll,this.symbolLayer.roll,0),o=r(t.width,this.symbolLayer.width,void 0),l=r(t.height,this.symbolLayer.height,void 0),c=r(t.depth,this.symbolLayer.depth,void 0),h=r(t.anchor,this.symbolLayer.anchor,void 0),u=r(t.anchorPosition,this.symbolLayer.anchorPosition,void 0);delete t.heading,delete t.tilt,delete t.roll,delete t.width,delete t.height,delete t.depth,delete t.anchor,delete t.anchorPosition;const p={heading:s,tilt:a,roll:n,anchor:h,anchorPosition:u},m=this._resources;this.loadStatus===tn.LOADED&&e.symbolLayerStatePatches.push(()=>{m.symbolSize=wn(l1(m.resourceSize,{width:o,height:l,depth:c,isPrimitive:this.symbolLayer.isPrimitive}))}),e.graphics3DGraphicPatches.push((f,y)=>{const b=this._computeLocalTransform(m,p,y,bR),x=f.instanceIndex;m.lodRenderer.instanceData.setLocalTransform(x,b,!0)})}_preparePatchColor(e,t){if(!t.material||t.material.type!=="partial")return;const r=t.material.diff;if(!r.color||r.color.type!=="complete"||r.color.newValue==null||r.color.oldValue==null)return;const s=r.color.newValue,a=g(s)?ui.toUnitRGBA(s):no;delete r.color;const n=this._resources;P(n)||e.graphics3DGraphicPatches.push(o=>{let l;this._hasPerInstanceColor()?(n.lodRenderer.instanceData.setColor(o.instanceIndex,a),l=this._setMaterialTransparencyParams({},s)):l=this._setMaterialTransparencyParams({externalColor:a},s);for(const c of n.stageResources.materials)c.setParameters(l)})}_requiresTerrainElevation(e){return e.mode!=="absolute-height"}_applyObjectRotation(e,t,r){if(!(this._fastUpdates.enabled&&this._fastUpdates.requiresShaderTransformation&&t))return YH(e.heading,e.tilt,e.roll,r)}_computeAnchor(e,t,r){const s=T();switch(r.anchor){case"center":H(s,oo(e)),oa(s,s);break;case"top":{const a=oo(e);j(s,-a[0],-a[1],-e[5]);break}case"bottom":{const a=oo(e);j(s,-a[0],-a[1],-e[2]);break}case"relative":{const a=oo(e),n=t_(e),o=r.anchorPosition,l=o?Ge(o.x,o.y,o.z):on;ON(s,n,l),X(s,s,a),oa(s,s);break}default:g(t)?oa(s,t):H(s,on)}return s}_applyAnchor(e,t,r){if(this._fastUpdates.enabled&&this._fastUpdates.requiresShaderTransformation)return;const s=this._computeAnchor(e.resourceBoundingBox,e.pivotOffset,t);s&&pl(r,r,s)}_hasPerInstanceColor(){return this._drivenProperties.color||this._drivenProperties.opacity}_fastVisualVariableConvertOptions(e,t,r,s){const a=g(e)?wn(t_(e)):Yc,n=g(e)?this._computeAnchor(e,s,this.symbolLayer):on,o=this._context.renderCoordsHelper.unitInMeters,l=iO(g(t)?t:void 0,t,r,o),c=Ge(this.symbolLayer.tilt||0,this.symbolLayer.roll||0,this.symbolLayer.heading||0);return{modelSize:a,symbolSize:g(t)?t:Yc,unitInMeters:o,transformation:{anchor:n,scale:l,rotation:c}}}};const Fu=T(),bR=ce(),$b=ce(),Z_=Pt(),Y_=new Zf;function jW(i,e){return i[0]=e[0],i[1]=e[1],i[2]=e[2],i[3]=e[3],i}function qW(i){return i[0]=1,i[1]=0,i[2]=0,i[3]=1,i}function Aw(i,e,t,r,s){return i[0]=e,i[1]=t,i[2]=r,i[3]=s,i}function WW(i,e){if(i===e){const t=e[1];i[1]=e[2],i[2]=t}else i[0]=e[0],i[1]=e[2],i[2]=e[1],i[3]=e[3];return i}function XW(i,e){const t=e[0],r=e[1],s=e[2],a=e[3];let n=t*a-s*r;return n?(n=1/n,i[0]=a*n,i[1]=-r*n,i[2]=-s*n,i[3]=t*n,i):null}function QW(i,e){const t=e[0];return i[0]=e[3],i[1]=-e[1],i[2]=-e[2],i[3]=t,i}function ZW(i){return i[0]*i[3]-i[2]*i[1]}function JL(i,e,t){const r=e[0],s=e[1],a=e[2],n=e[3],o=t[0],l=t[1],c=t[2],h=t[3];return i[0]=r*o+a*l,i[1]=s*o+n*l,i[2]=r*c+a*h,i[3]=s*c+n*h,i}function YW(i,e,t){const r=e[0],s=e[1],a=e[2],n=e[3],o=Math.sin(t),l=Math.cos(t);return i[0]=r*l+a*o,i[1]=s*l+n*o,i[2]=r*-o+a*l,i[3]=s*-o+n*l,i}function KW(i,e,t){const r=e[0],s=e[1],a=e[2],n=e[3],o=t[0],l=t[1];return i[0]=r*o,i[1]=s*o,i[2]=a*l,i[3]=n*l,i}function JW(i,e){const t=Math.sin(e),r=Math.cos(e);return i[0]=r,i[1]=t,i[2]=-t,i[3]=r,i}function eX(i,e){return i[0]=e[0],i[1]=0,i[2]=0,i[3]=e[1],i}function tX(i){return"mat2("+i[0]+", "+i[1]+", "+i[2]+", "+i[3]+")"}function iX(i){return Math.sqrt(i[0]**2+i[1]**2+i[2]**2+i[3]**2)}function rX(i,e,t,r){return i[2]=r[2]/r[0],t[0]=r[0],t[1]=r[1],t[3]=r[3]-i[2]*t[1],[i,e,t]}function sX(i,e,t){return i[0]=e[0]+t[0],i[1]=e[1]+t[1],i[2]=e[2]+t[2],i[3]=e[3]+t[3],i}function e$(i,e,t){return i[0]=e[0]-t[0],i[1]=e[1]-t[1],i[2]=e[2]-t[2],i[3]=e[3]-t[3],i}function aX(i,e){return i[0]===e[0]&&i[1]===e[1]&&i[2]===e[2]&&i[3]===e[3]}function nX(i,e){const t=i[0],r=i[1],s=i[2],a=i[3],n=e[0],o=e[1],l=e[2],c=e[3],h=vT();return Math.abs(t-n)<=h*Math.max(1,Math.abs(t),Math.abs(n))&&Math.abs(r-o)<=h*Math.max(1,Math.abs(r),Math.abs(o))&&Math.abs(s-l)<=h*Math.max(1,Math.abs(s),Math.abs(l))&&Math.abs(a-c)<=h*Math.max(1,Math.abs(a),Math.abs(c))}function oX(i,e,t){return i[0]=e[0]*t,i[1]=e[1]*t,i[2]=e[2]*t,i[3]=e[3]*t,i}function lX(i,e,t,r){return i[0]=e[0]+t[0]*r,i[1]=e[1]+t[1]*r,i[2]=e[2]+t[2]*r,i[3]=e[3]+t[3]*r,i}const cX=JL,hX=e$;Object.freeze(Object.defineProperty({__proto__:null,LDU:rX,add:sX,adjoint:QW,copy:jW,determinant:ZW,equals:nX,exactEquals:aX,frob:iX,fromRotation:JW,fromScaling:eX,identity:qW,invert:XW,mul:cX,multiply:JL,multiplyScalar:oX,multiplyScalarAndAdd:lX,rotate:YW,scale:KW,set:Aw,str:tX,sub:hX,subtract:e$,transpose:WW},Symbol.toStringTag,{value:"Module"}));let dX=class extends Cr{constructor(e,t,r,s,a,n,o,l){super(e,t,r,null,ps.Mesh,l),this.path=s,this.geometrySR=a,this.upVectorAlignment=n,this.stencilWidth=o}};var oh;function t$(i){return"upVectorAlignment"in i}(function(i){i[i.World=0]="World",i[i.Path=1]="Path"})(oh||(oh={}));function i$(){return[1,0,0,1]}function uX(i){return[i[0],i[1],i[2],i[3]]}function pX(i,e,t,r){return[i,e,t,r]}function mX(i,e){return new Float64Array(i,e,4)}Object.freeze(Object.defineProperty({__proto__:null,clone:uX,create:i$,createView:mX,fromValues:pX},Symbol.toStringTag,{value:"Module"}));function r$(){return{up:T(),right:T()}}function gX(i,e,t){xe(i.up,e.up,t),xe(i.right,e.right,t)}function fX(i,e,t){zt(i,J(t,e.right),J(t,e.up))}let _X=class{constructor(){this.pos=T(),this.posES=T(),this.vLeft=T(),this.vRight=T(),this.vMinSiblingLength=0,this.frame=r$(),this.rotationFrameUp=T(),this.rotationRight=$e(),this.rotationAngle=0,this.miterStretch=i$(),this.maxStretchDistance=0}setFrameFromUpVector(e){H(this.frame.up,e),X(ap,this.vLeft,this.vRight),W(ap,ap),B(Mw,this.frame.up,J(ap,this.frame.up)),Q(J_,ap,Mw),W(J_,J_),Be(this.frame.right,J_,this.frame.up)}},s$=class{constructor(){this.vertices=[],this.vertexIndices=[],this.vertexNormals=[],this.poles=[],this.poleIndices=[]}addVertex(e,t){return this.vertices.push(i_(e)),this.vertexNormals.push(i_(t)),this.vertices.length-1}addPole(e,t=null){return this.poles.push({position:i_(e),normal:t?i_(t):null}),this.poles.length-1}addSegment(e,t=null){this.vertexIndices.push(e.v0),this.vertexIndices.push(e.v1),t&&(this.poleIndices.push(t.v0),this.poleIndices.push(t.v1))}get numSegments(){return this.vertexIndices.length/2}translate(e,t){for(const r of this.vertices)r[0]+=e,r[1]+=t;for(const r of this.poles)r.position[0]+=e,r.position[1]+=t}};function yX(i=20){const t=new s$,r={v0:0,v1:0};t.addPole(It(0,0));for(let a=0;a<i;++a){const n=2*a*Math.PI/i,o=Math.cos(n),l=Math.sin(n),c=It(o*.5,l*.5),h=It(o,l);t.addVertex(c,h)}for(let a=0;a<i-1;++a){const n={v0:a,v1:a+1};t.addSegment(n,r)}const s={v0:i-1,v1:0};return t.addSegment(s,r),t}function vX(){const t=new s$,r=It(.5*-1,.5*-1),s=It(.5*1,.5*-1),a=It(.5*1,.5*1),n=It(.5*-1,.5*1),o=It(0,-1),l=It(1,0),c=It(0,1),h=It(-1,0);return t.addPole(It(0,.5*1),c),t.addPole(It(0,.5*1)),t.addPole(It(0,.5*-1)),t.addPole(It(0,.5*-1),o),t.addVertex(r,o),t.addVertex(s,o),t.addSegment({v0:0,v1:1},{v0:3,v1:3}),t.addVertex(s,l),t.addVertex(a,l),t.addSegment({v0:2,v1:3},{v0:2,v1:1}),t.addVertex(a,c),t.addVertex(n,c),t.addSegment({v0:4,v1:5},{v0:0,v1:0}),t.addVertex(n,h),t.addVertex(r,h),t.addSegment({v0:6,v1:7},{v0:1,v1:2}),t}let bX=class{constructor(e){this.vertices=e,this.offset=T(),this.xform=ce();const t=Math.floor((e.length-1)/2);H(this.offset,this.vertices[t].pos);for(const r of this.vertices)Q(r.pos,r.pos,this.offset);pl(this.xform,this.xform,this.offset),this.updatePathVertexInformation()}updatePathVertexInformation(){const e=this.vertices.length,t=this.vertices[0];t.index=0,t.vLeft=T(),Q(t.vRight,this.vertices[1].pos,t.pos);let r=pe(t.vRight);t.vMinSiblingLength=r,W(t.vRight,t.vRight);let s=t;for(let a=1;a<e;++a){const n=this.vertices[a];if(n.index=a,n.vLeft=s.vRight,a<e-1){Q(n.vRight,this.vertices[a+1].pos,n.pos);const o=pe(n.vRight);n.vMinSiblingLength=Math.min(r,o),r=o,W(n.vRight,n.vRight)}else H(n.vRight,n.vLeft),n.vMinSiblingLength=r;s=n}}};function xX(i,e){let t=null;const r=i.vertices.length,s=.99619469809,a=T(),n=T(),o=T(),l=T(),c=T(),h=T(),u=Ui();let p=i.vertices[0];H(n,e),j(a,0,1,0),wy(p.vRight,n,a,a,o,n,s),H(p.frame.up,n),H(p.frame.right,o),t=p;for(let m=1;m<r;++m){p=i.vertices[m],X(c,p.vLeft,p.vRight);let f=pe(c);f>0?(f=1/Math.sqrt(f),c[0]=c[0]*f,c[1]=c[1]*f,c[2]=c[2]*f):(c[0]=p.vRight[0],c[1]=p.vRight[1],c[2]=p.vRight[2]),X(h,t.pos,t.frame.up),mv(p.pos,c,u),kd(u,xo(h,p.vLeft),l)?(Q(l,l,p.pos),W(n,l),Be(o,c,n),W(o,o)):wy(c,t.frame.up,t.frame.right,a,o,n,s),H(p.frame.up,n),H(p.frame.right,o),t=p}}let wX=class{numProfilesPerJoin(){return 1}extrude(e,t,r){for(let s=0;s<t.vertices.length;++s)r(e.index,e.frame,t.vertices[s],t.vertexNormals[s],!1)}},Nb=class{constructor(e=.8*Math.PI,t=1){this.cutoffAngle=e,this.numBendSubdivisions=t}numProfilesPerJoin(){return this.numBendSubdivisions+1}extrude(e,t,r){const s=EX;if(Math.abs(e.rotationAngle)>=this.cutoffAngle)for(let a=0;a<this.numBendSubdivisions+1;++a){go(TR,.5*-e.rotationAngle+a*e.rotationAngle/this.numBendSubdivisions,e.rotationFrameUp),gX(s,e.frame,TR);for(let n=0;n<t.vertices.length;++n)_r(t.vertices[n],e.rotationRight)*e.rotationAngle>=0?r(e.index,s,t.vertices[n],t.vertexNormals[n],!1):(HS(bd,t.vertices[n],e.miterStretch),r(e.index,e.frame,bd,t.vertexNormals[n],!0))}else for(let a=0;a<this.numBendSubdivisions+1;++a)for(let n=0;n<t.vertices.length;++n){const o=_r(t.vertices[n],e.rotationRight)*e.rotationAngle>=0;HS(bd,t.vertices[n],e.miterStretch),r(e.index,e.frame,bd,t.vertexNormals[n],!o)}}},tS=class{rebuildConnectingProfileGeometry(e,t,r){for(let s=0;s<t.vertices.length;++s)r(e.index,e.frame,t.vertices[s],t.vertexNormals[s],0,0)}},xR=class extends tS{constructor(){super()}getNumVertices(){return 0}getNumIndices(){return 0}rebuildCapGeometry(){}buildTopology(){}},K_=class extends tS{constructor(e,t=0,r=!1){super(),this.profile=e,this.profilePlaneOffset=t,this.flip=r}getNumVertices(){return this.profile.vertices.length}getNumIndices(){return 3*this.profile.numSegments}rebuildConnectingProfileGeometry(e,t,r){for(let s=0;s<t.vertices.length;++s)r(e.index,e.frame,t.vertices[s],t.vertexNormals[s],this.profilePlaneOffset,0)}rebuildCapGeometry(e,t){const r=iS;zt(r,0,0);const s=this.flip?1:-1;for(let a=0;a<this.profile.vertices.length;++a)t(e.index,e.frame,this.profile.vertices[a],r,this.profilePlaneOffset,s)}buildTopology(e,t){const r=this.vertexBufferStart+this.profile.vertexIndices[0];for(let s=1;s<this.profile.numSegments;++s){const a=this.profile.vertexIndices[2*s+0],n=this.profile.vertexIndices[2*s+1],o=this.vertexBufferStart+a,l=this.vertexBufferStart+n;this.flip?t(l,o,r):t(r,o,l)}}},wR=class extends tS{constructor(e){super(),this.flip=!1,this.sign=0,this.breakNormals=!1,this.numSegments=3,this.profile=e.profile,this.flip=e.flip,this.sign=this.flip?1:-1,this.breakNormals=e.breakNormals,this.numSegments=e.subdivisions}getNumVertices(){let e=0;return e=this.profile.vertices.length*(this.numSegments-1),this.breakNormals&&(e+=this.profile.vertices.length),e+=this.profile.poles.length,e}getNumIndices(){let e=0;e+=2*this.profile.numSegments*(this.numSegments-1);for(let t=0;t<this.profile.numSegments;++t){const r=this.profile.vertexIndices[2*t+0],s=this.profile.vertexIndices[2*t+1];this.profile.poleIndices[r]===this.profile.poleIndices[s]?e+=1:e+=2}return 3*e}rebuildCapGeometry(e,t){const r=e.frame,s=.5*this.sign,a=bd,n=iS;zt(n,0,0);for(let o=0;o<this.profile.poles.length;++o){const l=this.profile.poles[o];l.normal?t(e.index,r,l.position,l.normal,s,0):t(e.index,r,l.position,n,s,this.sign)}if(this.breakNormals)for(let o=0;o<this.profile.vertices.length;++o)t(e.index,r,this.profile.vertices[o],this.profile.vertexNormals[o],0,0);for(let o=0;o<this.numSegments-1;++o){const l=(1-(o+1)/this.numSegments)*Math.PI*.5,c=Math.sin(l),h=Math.cos(l);for(let u=0;u<this.profile.vertices.length;++u){const p=this.profile.poles[this.profile.poleIndices[u]];kc(a,this.profile.vertices[u],p.position),On(a,a,c),p.normal?(qo(a,a,p.position),t(e.index,r,a,p.normal,s*h,0)):(hy(n,a),On(n,n,c),qo(a,a,p.position),t(e.index,r,a,n,s*h,this.sign*h))}}}buildTopology(e,t){const r=this.breakNormals?this.vertexBufferStart+this.profile.poles.length:this.firstProfileVertexIndex,s=this.breakNormals?this.vertexBufferStart+this.profile.poles.length+this.profile.vertices.length:this.vertexBufferStart+this.profile.poles.length;for(let a=0;a<this.profile.numSegments;++a){const n=this.profile.vertexIndices[2*a+0],o=this.profile.vertexIndices[2*a+1],l=this.vertexBufferStart+this.profile.poleIndices[n],c=this.vertexBufferStart+this.profile.poleIndices[o];let h=r+n,u=r+o;for(let p=0;p<this.numSegments-1;++p){const m=s+p*this.profile.vertices.length+n,f=s+p*this.profile.vertices.length+o;this.flip?(t(m,u,h),t(u,m,f)):(t(h,u,m),t(f,m,u)),h=m,u=f}this.flip?(t(l,u,h),l!==c&&t(l,c,u)):(t(h,u,l),l!==c&&t(u,c,l))}}},TX=class{constructor(e,t,r,s,a,n={}){this.options=n,this._extrusionVertexCount=0,this.numExtrusionProfiles=0,this.numVerticesTotal=0,this.numNormalsTotal=0,this.profile=t,this.path=e,this.extruder=r,this.startCap=s,this.endCap=a;const o=this.path.vertices.length-2;this.numExtrusionProfiles=r.numProfilesPerJoin()*o+2,this.numVerticesTotal=t.vertices.length*this.numExtrusionProfiles,this.numNormalsTotal=this.numVerticesTotal,this.startCap.vertexBufferStart=this.numVerticesTotal;const l=this.startCap.getNumVertices();this.numVerticesTotal+=l,this.numNormalsTotal+=l,this.endCap.vertexBufferStart=this.numVerticesTotal;const c=this.endCap.getNumVertices();this.numVerticesTotal+=c,this.numNormalsTotal+=c,this.pathVertexData=zi(1*this.numVerticesTotal),this.profileRightAxisData=zi(4*this.numVerticesTotal),this.profileUpAxisData=zi(4*this.numVerticesTotal),this.profileVertexAndNormalData=zi(4*this.numVerticesTotal),this.originData=zi(3*this.path.vertices.length),this._rebuildGeometry(),this.buildTopology()}emitVertex(e,t,r,s,a){if(this.profileRightAxisData[4*this._extrusionVertexCount+0]=t.right[0],this.profileRightAxisData[4*this._extrusionVertexCount+1]=t.right[1],this.profileRightAxisData[4*this._extrusionVertexCount+2]=t.right[2],this.profileUpAxisData[4*this._extrusionVertexCount+0]=t.up[0],this.profileUpAxisData[4*this._extrusionVertexCount+1]=t.up[1],this.profileUpAxisData[4*this._extrusionVertexCount+2]=t.up[2],this.profileVertexAndNormalData[4*this._extrusionVertexCount+0]=r[0],this.profileVertexAndNormalData[4*this._extrusionVertexCount+1]=r[1],this.profileVertexAndNormalData[4*this._extrusionVertexCount+2]=s[0],this.profileVertexAndNormalData[4*this._extrusionVertexCount+3]=s[1],this.pathVertexData[this._extrusionVertexCount]=e,a){const n=this.path.vertices[e];this.profileRightAxisData[4*this._extrusionVertexCount+3]=n.rotationRight[0]*n.maxStretchDistance,this.profileUpAxisData[4*this._extrusionVertexCount+3]=n.rotationRight[1]*n.maxStretchDistance}else this.profileRightAxisData[4*this._extrusionVertexCount+3]=0,this.profileUpAxisData[4*this._extrusionVertexCount+3]=0;++this._extrusionVertexCount}emitCapVertex(e,t,r,s,a,n){this.profileRightAxisData[4*this._extrusionVertexCount+0]=t.right[0],this.profileRightAxisData[4*this._extrusionVertexCount+1]=t.right[1],this.profileRightAxisData[4*this._extrusionVertexCount+2]=t.right[2],this.profileUpAxisData[4*this._extrusionVertexCount+0]=t.up[0],this.profileUpAxisData[4*this._extrusionVertexCount+1]=t.up[1],this.profileUpAxisData[4*this._extrusionVertexCount+2]=t.up[2],this.profileVertexAndNormalData[4*this._extrusionVertexCount+0]=r[0],this.profileVertexAndNormalData[4*this._extrusionVertexCount+1]=r[1],this.profileVertexAndNormalData[4*this._extrusionVertexCount+2]=s[0],this.profileVertexAndNormalData[4*this._extrusionVertexCount+3]=s[1],this.pathVertexData[this._extrusionVertexCount]=e,this.profileRightAxisData[4*this._extrusionVertexCount+3]=a,this.profileUpAxisData[4*this._extrusionVertexCount+3]=n,++this._extrusionVertexCount}_rebuildGeometry(){const e=(r,s,a,n,o)=>this.emitVertex(r,s,a,n,o),t=(r,s,a,n,o,l)=>this.emitCapVertex(r,s,a,n,o,l);this._extrusionVertexCount=0;for(const r of this.path.vertices)this.originData[3*r.index+0]=r.pos[0],this.originData[3*r.index+1]=r.pos[1],this.originData[3*r.index+2]=r.pos[2];this.startCap.rebuildConnectingProfileGeometry(this.path.vertices[0],this.profile,t);for(let r=1;r<this.path.vertices.length-1;++r)this.extruder.extrude(this.path.vertices[r],this.profile,e);this.endCap.rebuildConnectingProfileGeometry(this.path.vertices[this.path.vertices.length-1],this.profile,t),this.startCap.rebuildCapGeometry(this.path.vertices[0],t),this.endCap.rebuildCapGeometry(this.path.vertices[this.path.vertices.length-1],t)}buildTopology(){const e=this.profile.vertices.length,t=this.profile.numSegments,r=this.numExtrusionProfiles-1;let s=3*(2*(t*r));this.startCap.indexBufferStart=s,this.startCap.firstProfileVertexIndex=0,s+=this.startCap.getNumIndices(),this.endCap.indexBufferStart=s,this.endCap.firstProfileVertexIndex=e*(this.numExtrusionProfiles-1);const a=new Array,n=new Array,o=new Array,l=(c,h,u)=>{a.push(c),a.push(h),a.push(u),n.push(c),n.push(h),n.push(u),o.push(this.pathVertexData[c]),o.push(this.pathVertexData[h]),o.push(this.pathVertexData[u])};for(let c=0;c<t;++c){const h=this.profile.vertexIndices[2*c],u=this.profile.vertexIndices[2*c+1];for(let p=0;p<r;++p){const m=p*e+h,f=(p+1)*e+u,y=p*e+u;l(m,(p+1)*e+h,f),l(m,f,y)}}this.startCap.buildTopology(this.path.vertices[0],l),this.endCap.buildTopology(this.path.vertices[this.path.vertices.length-1],l),this.vertexIndices=f1(a),this.normalIndices=f1(n),this.pathVertexIndices=f1(o)}onPathChanged(){this._rebuildGeometry()}},a$=class{constructor(e){this.builder=e}get xform(){return this.builder.path.xform}onPathChanged(){this.builder.onPathChanged()}},n$=class extends a${constructor(e){super(e),this.vertexAttributePosition=null,this.vertexAttributeNormal=null,this.vertexAttributeColor=null,this.vertexAttributePosition=zi(3*this.builder.numVerticesTotal),this.vertexAttributeNormal=zi(3*this.builder.numNormalsTotal),this.vertexAttributeColor=new Uint8Array(4),this.vertexAttributeColor[0]=255,this.vertexAttributeColor[1]=255,this.vertexAttributeColor[2]=255,this.vertexAttributeColor[3]=255}bakeVertexColors(e){this.vertexAttributeColor[0]=255*e[0],this.vertexAttributeColor[1]=255*e[1],this.vertexAttributeColor[2]=255*e[2],this.vertexAttributeColor[3]=255*(e.length>3?e[3]:1)}bake(e){this.size=e;for(let t=0;t<this.builder.numVerticesTotal;++t){let r=this.builder.pathVertexData[t];const s=r===0||r===this.builder.path.vertices.length-1;r*=3;const a=SX;j(a,this.builder.originData[r++],this.builder.originData[r++],this.builder.originData[r]);const n=4*t,o=Mw,l=bd,c=ap,h=OX,u=RX;let p=0,m=0;if(j(h,this.builder.profileRightAxisData[n],this.builder.profileRightAxisData[n+1],this.builder.profileRightAxisData[n+2]),j(u,this.builder.profileUpAxisData[n],this.builder.profileUpAxisData[n+1],this.builder.profileUpAxisData[n+2]),zt(l,this.builder.profileVertexAndNormalData[n]*e[0],this.builder.profileVertexAndNormalData[n+1]*e[1]),s)Be(c,u,h),p=this.builder.profileRightAxisData[n+3]*e[0],m=this.builder.profileUpAxisData[n+3];else{const y=iS,b=PX;zt(y,this.builder.profileRightAxisData[n+3],this.builder.profileUpAxisData[n+3]);const x=RN(y);hy(y,y);const S=_r(l,y);if(Math.abs(S)>x){zt(b,-y[1],y[0]);const C=_r(l,b);On(y,y,x*Math.sign(S)),On(b,b,C),qo(l,y,b)}j(c,0,0,0)}j(o,h[0]*l[0]+u[0]*l[1],h[1]*l[0]+u[1]*l[1],h[2]*l[0]+u[2]*l[1]),this.vertexAttributePosition[3*t+0]=a[0]+o[0]+c[0]*p,this.vertexAttributePosition[3*t+1]=a[1]+o[1]+c[1]*p,this.vertexAttributePosition[3*t+2]=a[2]+o[2]+c[2]*p;const f=bd;zt(f,this.builder.profileVertexAndNormalData[n+2],this.builder.profileVertexAndNormalData[n+3]),this.vertexAttributeNormal[3*t+0]=h[0]*f[0]+u[0]*f[1]+c[0]*m,this.vertexAttributeNormal[3*t+1]=h[1]*f[0]+u[1]*f[1]+c[1]*m,this.vertexAttributeNormal[3*t+2]=h[2]*f[0]+u[2]*f[1]+c[2]*m}}createGeometryData(){const e=[[w.POSITION,this.builder.vertexIndices],[w.NORMAL,this.builder.normalIndices]],t=[[w.POSITION,new be(this.vertexAttributePosition,3,!0)],[w.NORMAL,new be(this.vertexAttributeNormal,3,!0)]];if(this.vertexAttributeColor){const r=this.builder.vertexIndices.length;e.push([w.COLOR,new Array(r).fill(0)]),t.push([w.COLOR,new be(this.vertexAttributeColor,4)])}return{vertexAttributes:t,indices:e}}onPathChanged(){super.onPathChanged(),this.bake(this.size)}intersect(e,t,r){const s=this.builder.vertexIndices,a=new be(this.vertexAttributePosition,3),n=s.length/3;$T(e,t,0,n,s,a,void 0,void 0,r)}},CX=class extends a${constructor(e,t,r,s){super(e),this.sizeAttributeValue=t,this.colorAttributeValue=r,this.opacityAttributeValue=s,this.vvData=null,this.baked=new n$(e),this.vvData=zi(4*this.builder.path.vertices.length);for(let a=0;a<this.builder.path.vertices.length;++a){this.vvData[4*a+0]=t,this.vvData[4*a+1]=r,this.vvData[4*a+2]=s;const n=a===0||a===this.builder.path.vertices.length-1;this.vvData[4*a+3]=n?1:0}}createGeometryData(){return{vertexAttributes:[[w.POSITION,new be(this.builder.originData,3,!0)],[w.PROFILERIGHT,new be(this.builder.profileRightAxisData,4,!0)],[w.PROFILEUP,new be(this.builder.profileUpAxisData,4,!0)],[w.PROFILEVERTEXANDNORMAL,new be(this.builder.profileVertexAndNormalData,4,!0)],[w.FEATUREVALUE,new be(this.vvData,4,!0)]],indices:[[w.POSITION,this.builder.pathVertexIndices],[w.PROFILERIGHT,this.builder.vertexIndices],[w.PROFILEUP,this.builder.vertexIndices],[w.PROFILEVERTEXANDNORMAL,this.builder.vertexIndices],[w.FEATUREVALUE,this.builder.pathVertexIndices]]}}};const SX=T(),bd=$e(),iS=$e(),PX=$e(),Mw=T(),ap=T(),OX=T(),RX=T(),J_=T(),EX=r$(),TR=ce(),Fb=8;function AX(i,e){const t=w.FEATUREVALUE;i.attributes.add(t,"vec4");const r=i.vertex;r.code.add(_`
  bool isCapVertex() {
    return ${t}.w == 1.0;
  }
  `),r.uniforms.add(new pi("size",s=>s.size)),e.vvSize?(r.uniforms.add(new si("vvSizeMinSize",s=>s.vvSizeMinSize)),r.uniforms.add(new si("vvSizeMaxSize",s=>s.vvSizeMaxSize)),r.uniforms.add(new si("vvSizeOffset",s=>s.vvSizeOffset)),r.uniforms.add(new si("vvSizeFactor",s=>s.vvSizeFactor)),r.code.add(_`
    vec2 getSize() {
      return size * clamp(vvSizeOffset + ${t}.x * vvSizeFactor, vvSizeMinSize, vvSizeMaxSize).xz;
    }
    `)):r.code.add(_`vec2 getSize(){
return size;
}`),e.vvOpacity?(r.constants.add("vvOpacityNumber","int",Fb),r.uniforms.add([new Ps("vvOpacityValues",s=>s.vvOpacityValues,Fb),new Ps("vvOpacityOpacities",s=>s.vvOpacityOpacities,Fb)]),r.code.add(_`
    vec4 applyOpacity(vec4 color) {
      float value = ${t}.z;
      if (value <= vvOpacityValues[0]) {
        return vec4( color.xyz, vvOpacityOpacities[0]);
      }

      for (int i = 1; i < vvOpacityNumber; ++i) {
        if (vvOpacityValues[i] >= value) {
          float f = (value - vvOpacityValues[i-1]) / (vvOpacityValues[i] - vvOpacityValues[i-1]);
          return vec4( color.xyz, mix(vvOpacityOpacities[i-1], vvOpacityOpacities[i], f));
        }
      }

      return vec4( color.xyz, vvOpacityOpacities[vvOpacityNumber - 1]);
    }
    `)):r.code.add(_`vec4 applyOpacity(vec4 color){
return color;
}`),e.vvColor?(r.constants.add("vvColorNumber","int",rh),r.uniforms.add([new Ps("vvColorValues",s=>s.vvColorValues,rh),new MT("vvColorColors",s=>s.vvColorColors,rh)]),r.code.add(_`
    vec4 getColor() {
      float value = ${t}.y;
      if (value <= vvColorValues[0]) {
        return applyOpacity(vvColorColors[0]);
      }

      for (int i = 1; i < vvColorNumber; ++i) {
        if (vvColorValues[i] >= value) {
          float f = (value - vvColorValues[i-1]) / (vvColorValues[i] - vvColorValues[i-1]);
          return applyOpacity(mix(vvColorColors[i-1], vvColorColors[i], f));
        }
      }

      return applyOpacity(vvColorColors[vvColorNumber - 1]);
    }
    `)):r.code.add(_`vec4 getColor(){
return applyOpacity(vec4(1, 1, 1, 1));
}`),i.include(V3),i.attributes.add(w.PROFILERIGHT,"vec4"),i.attributes.add(w.PROFILEUP,"vec4"),i.attributes.add(w.PROFILEVERTEXANDNORMAL,"vec4"),r.code.add(_`vec3 calculateVPos() {
vec2 size = getSize();
vec3 origin = position;
vec3 right = profileRight.xyz;
vec3 up = profileUp.xyz;
vec3 forward = cross(up, right);
vec2 profileVertex = profileVertexAndNormal.xy * size;
vec2 profileNormal = profileVertexAndNormal.zw;
float positionOffsetAlongProfilePlaneNormal = 0.0;
float normalOffsetAlongProfilePlaneNormal = 0.0;`),r.code.add(_`if(!isCapVertex()) {
vec2 rotationRight = vec2(profileRight.w, profileUp.w);
float maxDistance = length(rotationRight);`),r.code.add(_`rotationRight = maxDistance > 0.0 ? normalize(rotationRight) : vec2(0, 0);
float rx = dot(profileVertex, rotationRight);
if (abs(rx) > maxDistance) {
vec2 rotationUp = vec2(-rotationRight.y, rotationRight.x);
float ry = dot(profileVertex, rotationUp);
profileVertex = rotationRight * maxDistance * sign(rx) + rotationUp * ry;
}
}else{
positionOffsetAlongProfilePlaneNormal = profileRight.w * size[0];
normalOffsetAlongProfilePlaneNormal = profileUp.w;
}
vec3 offset = right * profileVertex.x + up * profileVertex.y + forward * positionOffsetAlongProfilePlaneNormal;
return origin + offset;
}`),r.code.add(_`vec3 localNormal() {
vec3 right = profileRight.xyz;
vec3 up = profileUp.xyz;
vec3 forward = cross(up, right);
vec2 profileNormal = profileVertexAndNormal.zw;
vec3 normal = right * profileNormal.x + up * profileNormal.y;
if(isCapVertex()) {
normal += forward * profileUp.w;
}
return normal;
}`)}let MX=class extends LT{constructor(){super(...arguments),this.size=It(1,1)}};function DX(i){const e=new $t,{vertex:t,fragment:r}=e;switch(nc(t,i),e.varyings.add("vpos","vec3"),e.include(AX,i),i.output!==A.Color&&i.output!==A.Alpha||(e.include(il,i),e.include(Yg,i),e.include(yv,i),e.varyings.add("vnormal","vec3"),e.varyings.add("vcolor","vec4"),i.hasMultipassTerrain&&e.varyings.add("depth","float"),t.code.add(_`
      void main() {
        vpos = calculateVPos();
        vnormal = normalize(localNormal());

        ${i.hasMultipassTerrain?"depth = (view * vec4(vpos, 1.0)).z;":""}
        gl_Position = transformPosition(proj, view, vpos);

        ${i.output===A.Color?"forwardLinearDepth();":""}

        vcolor = getColor();
      }
    `)),e.include(Yl,i),i.output){case A.Alpha:e.include(Qr,i),r.uniforms.add(new ue("opacity",s=>s.opacity)),r.code.add(_`
      void main() {
        discardBySlice(vpos);
        ${i.hasMultipassTerrain?"terrainDepthTest(gl_FragCoord, depth);":""}
        float combinedOpacity = vcolor.a * opacity;
        gl_FragColor = vec4(combinedOpacity);
      }
    `);break;case A.Color:e.include(Qr,i),e.include(ef,i),e.include(G3,i),e.include(Yg,i),e.include(MF,i),rm(r,i),B3(r),NT(r),r.uniforms.add([t.uniforms.get("localOrigin"),new si("ambient",s=>s.ambient),new si("diffuse",s=>s.diffuse),new si("specular",s=>s.specular),new ue("opacity",s=>s.opacity)]),r.include(rc),im(r),r.code.add(_`
        void main() {
          discardBySlice(vpos);
          ${i.hasMultipassTerrain?"terrainDepthTest(gl_FragCoord, depth);":""}

          shadingParams.viewDirection = normalize(vpos - cameraPosition);
          shadingParams.normalView = vnormal;
          vec3 normal = shadingNormal(shadingParams);
          float ssao = evaluateAmbientOcclusionInverse();

          float additionalAmbientScale = additionalDirectedAmbientLight(vpos + localOrigin);
          vec3 additionalLight = ssao * mainLightIntensity * additionalAmbientScale * ambientBoostFactor * lightingGlobalFactor;
          ${i.receiveShadows?"float shadow = readShadowMap(vpos, linearDepth);":i.spherical?"float shadow = lightingGlobalFactor * (1.0 - additionalAmbientScale);":"float shadow = 0.0;"}
          vec3 albedo = vcolor.rgb * max(ambient, diffuse); // combine the old material parameters into a single one
          float combinedOpacity = vcolor.a * opacity;
          albedo += 0.25 * specular; // don't completely ignore specular for now

          vec3 shadedColor = evaluateSceneLighting(normal, albedo, shadow, 1.0 - ssao, additionalLight);
          gl_FragColor = vec4(shadedColor, combinedOpacity);
          gl_FragColor = highlightSlice(gl_FragColor, vpos);
          ${i.transparencyPassType===We.Color?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}
        }
      `);break;case A.Depth:case A.Shadow:case A.ShadowHighlight:case A.ShadowExcludeHighlight:e.include(il,i),Jg(e),e.varyings.add("depth","float"),t.code.add(_`void main() {
vpos = calculateVPos();
gl_Position = transformPositionWithDepth(proj, view, vpos, nearFar, depth);
}`),e.include(Qr,i),e.include(gh,i),r.code.add(_`void main() {
discardBySlice(vpos);
outputDepth(depth);
}`);break;case A.Normal:e.include(il,i),e.include(Sf,i),Zg(t),e.varyings.add("vnormal","vec3"),t.code.add(_`void main(void) {
vpos = calculateVPos();
vnormal = normalize((viewNormal * vec4(localNormal(), 1.0)).xyz);
gl_Position = transformPosition(proj, view, vpos);
}`),e.include(Qr,i),r.code.add(_`void main() {
discardBySlice(vpos);
vec3 normal = normalize(vnormal);
if (gl_FrontFacing == false) normal = -normal;
gl_FragColor = vec4(vec3(0.5) + 0.5 * normal, 1.0);
}`);break;case A.Highlight:e.include(il,i),e.include(Sf,i),e.varyings.add("vnormal","vec3"),t.code.add(_`void main(void) {
vpos = calculateVPos();
gl_Position = transformPosition(proj, view, vpos);
}`),e.include(Qr,i),e.include(Sh,i),r.code.add(_`void main() {
discardBySlice(vpos);
outputHighlight();
}`)}return e}const IX=Object.freeze(Object.defineProperty({__proto__:null,build:DX},Symbol.toStringTag,{value:"Module"})),o$=new Map([[w.POSITION,0],[w.PROFILERIGHT,1],[w.PROFILEUP,2],[w.PROFILEVERTEXANDNORMAL,3],[w.FEATUREVALUE,4]]);let LX=class extends MX{constructor(){super(...arguments),this.ambient=Ge(.2,.2,.2),this.diffuse=Ge(.8,.8,.8),this.specular=Ge(0,0,0),this.opacity=1}},l$=class c$ extends Mt{initializeConfiguration(e,t){t.hasWebGL2Context=e.rctx.type===da.WEBGL2,t.spherical=e.viewingMode===ve.Global,t.doublePrecisionRequiresObfuscation=e.rctx.driverTest.doublePrecisionRequiresObfuscation.result}initializeProgram(e){return new Rt(e.rctx,c$.shader.get().build(this.configuration),o$)}initializePipeline(){const e=this.configuration.transparencyPassType,t=this.configuration,r=e===We.NONE,s=e===We.FrontFace;return qe({blending:t.output!==A.Color&&t.output!==A.Alpha||!t.transparent?null:r?In:Ph(e),culling:t.hasSlicePlane&&!t.transparent&&t.doubleSidedMode!==Ia.None?s6:null,depthTest:{func:Xd(e)},depthWrite:r||s?cn:null,colorWrite:at,stencilWrite:t.hasOccludees?Kl:null,stencilTest:t.hasOccludees?Wd:null,polygonOffset:r||s?null:VT})}};l$.shader=new Dt(IX,()=>_e(()=>import("./Path.glsl-607165a9.js"),["assets/Path.glsl-607165a9.js","assets/objectResourceUtils-782953c3.js","assets/devEnvironmentUtils-5002a058.js","assets/calcite-8912bd40.js","assets/index-00759e4a.js","assets/index-5026a37a.css","assets/calcite-96fa36fd.css","assets/mat3f64-50f3b9f6.js","assets/mat4f64-abdda1bb.js","assets/BufferView-379a78a4.js","assets/vec33-69c9e93b.js","assets/DefaultMaterial_COLOR_GAMMA-6ed76d86.js","assets/types-e1c0a5bf.js","assets/enums-e2e92c86.js","assets/Version-aa0a1d91.js","assets/quat-7b70e9a8.js","assets/quatf64-f8f1c132.js","assets/resourceUtils-527631ac.js","assets/basicInterfaces-7449a8bf.js","assets/Indices-d8bff7b2.js","assets/NestedMap-1b5db22e.js","assets/requestImageUtils-d1ba3b36.js","assets/symbolColorUtils-c9d24716.js","assets/Util-6d3f024a.js","assets/sphere-d0e5285d.js","assets/VertexAttribute-15d1866a.js","assets/doublePrecisionUtils-e3c3d0d8.js","assets/OrderIndependentTransparency-5f7257d7.js","assets/Texture-563cf5e5.js","assets/FramebufferObject-8b18fc0c.js","assets/VertexElementDescriptor-2925c6af.js","assets/InterleavedLayout-d57c91d0.js","assets/vec3f32-01c06d8d.js","assets/plane-5e2b046c.js","assets/spatialReferenceEllipsoidUtils-afb35af9.js","assets/scaleUtils-d13015f2.js","assets/ElevationSamplerData-e3118b17.js","assets/Octree-499541ed.js","assets/edgeProcessing-20e12367.js","assets/deduplicate-769a6f51.js","assets/MeshComponent-788e605a.js","assets/earcut-61f7b102.js","assets/imageUtils-c2d0d1ae.js","assets/projection-5969b753.js","assets/ZoomMomentumEstimator-ef57e6a4.js","assets/floatRGBA-ca2b39ca.js","assets/dehydratedFeatures-3a140d03.js","assets/quantizationUtils-b3b2ae2a.js","assets/labelFormatUtils-71e1f841.js","assets/orientedBoundingBox-a14b97b5.js","assets/quatf32-51a323b8.js","assets/SnappingCandidate-970faec6.js","assets/callExpressionWithFeature-df1a8f01.js","assets/DefaultVertexAttributeLayouts-5f20d8dd.js","assets/geometryServiceUtils-a536bb19.js","assets/project-909a4219.js","assets/LercDecoder-65586d50.js","assets/VectorTile-d41a1f0f.js","assets/enums-fb086c25.js","assets/config-1337d16e.js","assets/TiledDisplayObject-419c008b.js","assets/DisplayObject-87c37b69.js","assets/rasterUtils-7694cc98.js","assets/resources-7587d8f4.js","assets/workerHelper-6131d203.js","assets/webgl-debug-7f880832.js","assets/RenderingContext-0f21aa0e.js","assets/ProgramCache-f29c900e.js","assets/Program-77209250.js","assets/MediaLayer-4c42fc2f.js","assets/MediaElementView-06baa4d4.js","assets/normalizeUtilsSync-3ea564a9.js","assets/resourceExtension-f31d9f10.js","assets/BoundsStore-00da37da.js","assets/PooledRBush-5a11bc7e.js","assets/prism-line-numbers-eff41b13.js","assets/label2-a2f37e65.js","assets/interactive-1de2e238.js","assets/loadable-6afd516d.js","assets/t9n-81df3a71.js","assets/observers-c89705b8.js","assets/icon-8e47fbec.js","assets/loader-c773e800.js","assets/guid-51402ee7.js","assets/prism-line-numbers-7c5d72ff.css"]));let Pr=class extends Vn{constructor(){super(...arguments),this.output=A.Color,this.doubleSidedMode=Ia.None,this.transparencyPassType=We.NONE,this.spherical=!1,this.receiveShadows=!1,this.receiveAmbientOcclusion=!1,this.vvSize=!1,this.vvColor=!1,this.vvOpacity=!1,this.hasSlicePlane=!1,this.transparent=!1,this.hasOccludees=!1,this.hasMultipassTerrain=!1,this.cullAboveGround=!1,this.doublePrecisionRequiresObfuscation=!1}};d([D({count:A.COUNT})],Pr.prototype,"output",void 0),d([D({count:Ia.COUNT})],Pr.prototype,"doubleSidedMode",void 0),d([D({count:We.COUNT})],Pr.prototype,"transparencyPassType",void 0),d([D()],Pr.prototype,"spherical",void 0),d([D()],Pr.prototype,"receiveShadows",void 0),d([D()],Pr.prototype,"receiveAmbientOcclusion",void 0),d([D()],Pr.prototype,"vvSize",void 0),d([D()],Pr.prototype,"vvColor",void 0),d([D()],Pr.prototype,"vvOpacity",void 0),d([D()],Pr.prototype,"hasSlicePlane",void 0),d([D()],Pr.prototype,"transparent",void 0),d([D()],Pr.prototype,"hasOccludees",void 0),d([D()],Pr.prototype,"hasMultipassTerrain",void 0),d([D()],Pr.prototype,"cullAboveGround",void 0),d([D()],Pr.prototype,"doublePrecisionRequiresObfuscation",void 0),d([D({constValue:Wt.Disabled})],Pr.prototype,"pbrMode",void 0),d([D({constValue:!0})],Pr.prototype,"hasVvInstancing",void 0),d([D({constValue:!1})],Pr.prototype,"useCustomDTRExponentForWater",void 0),d([D({constValue:!1})],Pr.prototype,"useFillLights",void 0);let $X=class h$ extends jd{constructor(e){super(e,new FX),this.supportsEdges=!0,this._vertexAttributeLocations=o$,this._configuration=new Pr,this._vertexBufferLayout=h$.getVertexBufferLayout()}getConfiguration(e,t){return this._configuration.output=e,this._configuration.vvSize=this.parameters.vvSizeEnabled,this._configuration.vvColor=this.parameters.vvColorEnabled,this._configuration.vvOpacity=this.parameters.vvOpacityEnabled,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.transparent=this.parameters.transparent,this._configuration.hasOccludees=this.parameters.hasOccludees,e!==A.Color&&e!==A.Alpha||(this._configuration.doubleSidedMode=this.parameters.doubleSided&&this.parameters.doubleSidedType==="normal"?Ia.View:this.parameters.doubleSided&&this.parameters.doubleSidedType==="winding-order"?Ia.WindingOrder:Ia.None,this._configuration.receiveShadows=this.parameters.receiveShadows,this._configuration.receiveAmbientOcclusion=!!t.ssaoHelper.active&&this.parameters.receiveSSAO),this._configuration.transparencyPassType=t.transparencyPassType,this._configuration.hasMultipassTerrain=t.multipassTerrain.enabled,this._configuration.cullAboveGround=t.multipassTerrain.cullAboveGround,this._configuration}isVisibleForOutput(e){return e!==A.Shadow&&e!==A.ShadowExcludeHighlight&&e!==A.ShadowHighlight||this.parameters.castShadows}isVisible(){return super.isVisible()&&this.parameters.opacity>0}intersect(e,t,r,s,a,n){const o=e;if(!t$(o))return;const l=o.path,c=[this.parameters.size[0],this.parameters.size[1]];if(this.parameters.vvSizeEnabled){const b=this.parameters.vvSizeOffset,x=this.parameters.vvSizeFactor,S=this.parameters.vvSizeMinSize,C=this.parameters.vvSizeMaxSize,O=l.sizeAttributeValue;c[0]*=ee(b[0]+O*x[0],S[0],C[0]),c[1]*=ee(b[2]+O*x[2],S[2],C[2])}const h=Math.max(c[0],c[1]),u=e.boundingInfo;if(P(u))return void this._intersectTriangles(l,c,s,a,n);const p=bx(u.bbMin[0]-h,u.bbMin[1]-h,u.bbMin[2]-h,u.bbMax[0]+h,u.bbMax[1]+h,u.bbMax[2]+h),m=[a[0]-s[0],a[1]-s[1],a[2]-s[2]],f=Math.sqrt(m[0]*m[0]+m[1]*m[1]+m[2]*m[2]),y=[f/m[0],f/m[1],f/m[2]];H3(p,s,y,r.tolerance)&&this._intersectTriangles(l,c,s,a,n)}_intersectTriangles(e,t,r,s,a){e.baked.size&&e.baked.size[0]===t[0]&&e.baked.size[1]===t[1]||e.baked.bake(t),e.baked.intersect(r,s,a)}createBufferWriter(){return new kf(this._vertexBufferLayout)}requiresSlot(e,t){switch(t){case A.Shadow:case A.ShadowHighlight:case A.ShadowExcludeHighlight:if(!this.parameters.castShadows)return!1;case A.Color:case A.Alpha:case A.Depth:case A.Normal:case A.Highlight:case A.ObjectAndLayerIdColor:return e===(this.parameters.transparent?K.TRANSPARENT_MATERIAL:K.OPAQUE_MATERIAL)||e===K.DRAPED_MATERIAL;default:return!1}}createGLMaterial(e){return new NX(e)}static getVertexBufferLayout(){return mr().vec3f(w.POSITION).vec4f(w.PROFILERIGHT).vec4f(w.PROFILEUP).vec4f(w.PROFILEVERTEXANDNORMAL).vec4f(w.FEATUREVALUE)}},NX=class extends qd{_updateOccludeeState(e){e.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:e.hasOccludees})}_updateShadowState(e){(P(this.technique)||e.shadowMap.enabled!==this.technique.configuration.receiveShadows)&&this._material.setParameters({receiveShadows:e.shadowMap.enabled})}beginSlot(e){return this._output!==A.Color&&this._output!==A.Alpha||(this._updateShadowState(e),this._updateOccludeeState(e)),this.ensureTechnique(l$,e)}},FX=class extends LX{constructor(){super(...arguments),this.doubleSided=!1,this.doubleSidedType="normal",this.receiveSSAO=!0,this.receiveShadows=!1,this.castShadows=!0,this.hasSlicePlane=!1,this.transparent=!1,this.hasOccludees=!1}};const zX=["polyline"];let UX=class extends _l{constructor(e,t,r,s){super(e,t,r,s),this._intrinsicSize=It(1,1),this._upVectorAlignment=oh.Path,this._stencilWidth=.1,this.ensureDrapedStatus(!1)}async doLoad(){const e=g(this.symbolLayer.width)?this.symbolLayer.width:this.symbolLayer.height,t=g(this.symbolLayer.height)?this.symbolLayer.height:e;this._vvConvertOptions={modelSize:[1,1,1],symbolSize:[e,1,t],unitInMeters:this._context.renderCoordsHelper.unitInMeters,transformation:{anchor:[0,0,0],scale:[1,1,1],rotation:[0,0,0]},supportedTypes:{size:!0,color:!0,opacity:!0,rotation:!1}},this._context.renderer&&this._context.renderer.visualVariables&&this._context.renderer.visualVariables.length>0?this._fastUpdates=Pf(this._context.renderer,this._vvConvertOptions):this._fastUpdates={enabled:!1};const r=this.symbolLayer.anchor||"center";this._upVectorAlignment=this.symbolLayer.profileRotation==="heading"?oh.World:oh.Path;const s=this.symbolLayer.profile||"circle";switch(s){default:case"circle":this._profile=yX(jI);break;case"quad":this._profile=vX()}let a=[0,0];switch(r!=="center"&&(a={left:[.5,0],right:[-.5,0],top:[0,-.5],bottom:[0,.5]}[r],this._profile.translate(a[0],a[1])),this.symbolLayer.join){case"round":this._extruder=new Nb(0,kI);break;case"bevel":this._extruder=new Nb(0,1);break;case"miter":this._extruder=new Nb(.8*Math.PI,1);break;default:this._extruder=new wX}const n=this.symbolLayer.cap||"butt";switch(n){case"none":this._startCap=new xR,this._endCap=new xR;break;case"butt":default:this._startCap=new K_(this._profile,0),this._endCap=new K_(this._profile,0,!0);break;case"square":this._startCap=new K_(this._profile,-.5),this._endCap=new K_(this._profile,.5,!0);break;case"round":{const m=s==="quad";this._startCap=new wR({profile:this._profile,flip:!1,breakNormals:m,subdivisions:bw}),this._endCap=new wR({profile:this._profile,flip:!0,breakNormals:m,subdivisions:bw});break}}const o=Ur(this.symbolLayer,"material","color"),l=this._getCombinedOpacityAndColor(o),c=wn(l),h=l[3],u=h<1||this.needsDrivenTransparentPass,p={diffuse:c,ambient:c,opacity:h,transparent:u,hasVertexColors:!1,hasSlicePlane:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows,cullFace:u||n==="none"?Tr.None:Tr.Back,offsetTransparentBackfaces:!0};if(!this._drivenProperties.size&&(zt(this._intrinsicSize,e,t),!Vy(this._intrinsicSize[0])||!Vy(this._intrinsicSize[1])))throw new bt("graphics3dpathsymbollayer:invalid-size","Symbol sizes may not be negative values");if(this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size||On(this._intrinsicSize,this._intrinsicSize,1/this._context.renderCoordsHelper.unitInMeters),this._fastUpdates.enabled){const m={...p,...this._fastUpdates.materialParameters,size:EN(this._intrinsicSize)};this._material=new $X(m)}else p.hasVertexColors=this._drivenProperties.color||this._drivenProperties.opacity,this._material=new Kg(p);this._material.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}),this._context.stage.add(this._material)}destroy(){super.destroy(),this._context.stage.remove(this._material),this._material=null}createGraphics3DGraphic(e){const t=e.graphic;if(!this._validateGeometry(t.geometry,zX,this.symbolLayer.type))return null;const r=this.setGraphicElevationContext(t,new Po),s=e.renderingInfo;return this._createAs3DShape(t,s,r,t.uid)}layerOpacityChanged(){const e=Ur(this.symbolLayer,"material","color"),t=this._getCombinedOpacity(e),r=t<1||this.needsDrivenTransparentPass;this._material.setParameters({opacity:t,transparent:r})}layerElevationInfoChanged(e,t){return this.updateGraphics3DGraphicElevationInfo(e,t,wh)}slicePlaneEnabledChanged(){return this._material.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),!0}physicalBasedRenderingChanged(){return this._material.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}),!0}pixelRatioChanged(){return!0}skipHighSymbolLodsChanged(){return!0}applyRendererDiff(e,t){for(const r in e.diff){if(r!=="visualVariables"||!Of(this._fastUpdates,t,this._vvConvertOptions))return dr.Recreate_Symbol;this._material.setParameters(this._fastUpdates.materialParameters)}return dr.Fast_Update}_getVertexData(e){let t=0;const r=e.paths,s=[],a=e.spatialReference,n=this._context.elevationProvider.spatialReference,o=this._context.renderCoordsHelper.spatialReference;for(const p of r)t+=p.length;const l=Fn(3*t),c=Fn(3*t);let h=0;for(const p of r){s.push({index:h,numVertices:p.length});for(const m of p)l[h++]=m[0],l[h++]=m[1],l[h++]=e.hasZ?m[2]:0}let u=!0;return g(n)&&!a.equals(n)&&(u=ha(l,a,0,l,n,0,t)),g(n)&&!n.equals(o)?ha(l,n,0,c,o,0,t):this._copyVertices(l,0,c,0,t),{pathVertexDataInfos:s,vertexDataES:l,vertexDataRS:c,projectionSuccess:u,terrainElevation:0}}_copyVertices(e,t,r,s,a){t*=3,s*=3;for(let n=0;n<a;++n)r[s++]=e[t++],r[s++]=e[t++],r[s++]=e[t++]}_createAs3DShape(e,t,r,s){const a=e.geometry,n=new Array,o=a.spatialReference,l=_s(),c=this._context.renderCoordsHelper;u$.spatialReference=o;const h=this._getVertexData(a);if(!h.projectionSuccess)return this.logger.warn("PathSymbol3DLayer geometry failed to be created (failed to project geometry to view spatial reference)"),null;if(h.pathVertexDataInfos.length===0)return a.paths.length!==0&&a.paths.some(f=>f.length>0)||this.logger.warn("PathSymbol3DLayer geometry failed to be created (no paths were defined)"),null;for(const f of h.pathVertexDataInfos){const y=f.index,b=f.numVertices;if(b<2||g(this._context.clippingExtent)&&(di(l),nn(l,h.vertexDataES,3*y,b),!co(l,this._context.clippingExtent)))continue;const x=[];for(let L=y;L<y+3*b;){const F=L++,N=L++,G=L++,q=new _X;j(q.posES,h.vertexDataES[F],h.vertexDataES[N],h.vertexDataES[G]);const se=KH(q.posES,this._context.elevationProvider,r,c);j(Jt,h.vertexDataRS[F],h.vertexDataRS[N],h.vertexDataRS[G]),c.setAltitude(Jt,se),H(q.pos,Jt),x.push(q)}const S=new bX(x);d$(S,this._upVectorAlignment,this._context.renderCoordsHelper);const C=new TX(S,this._profile,this._extruder,this._startCap,this._endCap);let O=null;if(this._fastUpdates.enabled){const L=this._fastUpdates.visualVariables,F=L.size?kl(L.size.field,e):0,N=L.color?kl(L.color.field,e):0,G=L.opacity?kl(L.opacity.field,e):0;O=new CX(C,F,N,G)}else{const L=[this._intrinsicSize[0],this._intrinsicSize[1]];if(this._drivenProperties.size){const G=t.size;L[0]*=CR(G[0],G[2]==="symbol-value"?this.symbolLayer.height||0:G[2],this.symbolLayer.width||0),L[1]*=CR(G[2],G[0]==="symbol-value"?this.symbolLayer.width||0:G[0],this.symbolLayer.height||0)}let F;this._drivenProperties.color&&(F=t.color),this._drivenProperties.opacity&&t.opacity!=null&&(F=F?[F[0],F[1],F[2],t.opacity]:[1,1,1,t.opacity]);const N=new n$(C);N.bake(L),F&&N.bakeVertexColors(F),O=N}const{vertexAttributes:R,indices:E}=O.createGeometryData(),$=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:s,layerUid:this._context.layer.uid}),M=new dX(this._material,R,E,O,o,this._upVectorAlignment,this._stencilWidth,$);M.transformation=O.xform,n.push(M)}if(n.length===0)return null;const u={layerUid:this._context.layer.uid,graphicUid:s},p=new hc({geometries:n,metadata:u}),m=new fl(this,p,n,null,null,GX,r);return m.alignedSampledElevation=h.terrainElevation,m.needsElevationUpdates=wh(r.mode),m}};function d$(i,e,t){switch(e){default:case oh.World:for(const r of i.vertices){X(Jt,r.pos,i.offset),t.worldUpAtPosition(Jt,Jt),r.setFrameFromUpVector(Jt),r.rotationFrameUp=r.frame.up,zt(r.rotationRight,1,0),B(Jt,r.frame.up,J(r.frame.up,r.vLeft)),Q(Jt,r.vLeft,Jt),oa(Jt,Jt),W(Jt,Jt),B(Pc,r.frame.up,J(r.frame.up,r.vRight)),Q(Pc,r.vRight,Pc),W(Pc,Pc),Be(SR,r.rotationFrameUp,r.vLeft);const s=Math.sign(J(SR,r.vRight));if(r.rotationAngle=s*(Math.PI-es(J(Jt,Pc))),Math.abs(r.rotationAngle)>0){const n=c1(Math.cos(.5*r.rotationAngle));Aw(r.miterStretch,n-1+1,0,0,1)}const a=Math.PI-r.rotationAngle;r.maxStretchDistance=Math.abs(r.vMinSiblingLength/Math.cos(.5*a))}break;case oh.Path:X(Jt,i.vertices[0].pos,i.offset),t.worldUpAtPosition(Jt,Jt),xX(i,Jt);for(const r of i.vertices){const s=Math.sign(J(r.frame.right,r.vRight));Be(r.rotationFrameUp,r.vRight,r.vLeft),B(r.rotationFrameUp,r.rotationFrameUp,s),W(r.rotationFrameUp,r.rotationFrameUp);const a=J(r.rotationFrameUp,r.frame.up),n=J(r.rotationFrameUp,r.frame.right);if(B(Jt,r.frame.up,-n),B(Pc,r.frame.right,a),X(Jt,Jt,Pc),W(Jt,Jt),fX(r.rotationRight,r.frame,Jt),oa(Jt,r.vLeft),r.rotationAngle=-s*(Math.PI-es(J(Jt,r.vRight))),Math.abs(r.rotationAngle)>0){const l=c1(Math.cos(.5*r.rotationAngle));Aw(r.miterStretch,1+(l-1)*r.rotationRight[0]*r.rotationRight[0],(l-1)*r.rotationRight[0]*r.rotationRight[1],(l-1)*r.rotationRight[0]*r.rotationRight[1],1+(l-1)*r.rotationRight[1]*r.rotationRight[1])}const o=Math.PI-r.rotationAngle;r.maxStretchDistance=Math.abs(r.vMinSiblingLength*c1(Math.cos(.5*o)))}}}function CR(i,e,t){switch(i){case"symbol-value":return t;case"proportional":return e;default:return i}}function VX(i,e,t,r){let s=0;for(const a of i.vertices)t(a.posES,zb),s+=zb.sampledElevation,X(Jt,a.pos,i.offset),r.setAltitude(Jt,zb.z),Q(a.pos,Jt,i.offset);return i.updatePathVertexInformation(),s/i.vertices.length}function GX(i,e,t,r,s){const a=i.stageObject,n=a.geometries;let o=0;BX.spatialReference=s.spatialReference;for(const l of n){if(!t$(l))continue;const c=l.path,h=c.builder.path,u=l.geometrySR;u$.spatialReference=u,o+=VX(h,e,r,s),l.upVectorAlignment!==oh.World&&d$(h,l.upVectorAlignment,s),c.onPathChanged(),l.invalidateBoundingInfo(),a.geometryVertexAttrsUpdated(l)}return o/n.length}const BX=lc(0,0,0,null),u$=lc(0,0,0,null),Jt=T(),Pc=T(),SR=T(),zb=new Zf;function HX(i,e,t,r,s=1){if(t.isGeographic&&r===ve.Global){const c=Fn(e.length),h=e.length,u=Et(t);for(let p=0;p<h;p+=3)e3(e,p,c,p,u);e=c}zt(nr,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY);for(let c=0;c<e.length;c+=3)nr[0]=Math.min(nr[0],e[c]),nr[1]=Math.min(nr[1],e[c+1]);const a=nr[0]%s,n=nr[1]%s,o=nr[0]-a,l=nr[1]-n;for(let c=0;c<e.length;c+=3){const h=c/3*4;i[h]=(e[c]-o)/s,i[h+1]=(e[c+1]-l)/s,i[h+2]=o/s,i[h+3]=l/s}}function p$(i,e,t,r,s=1){j(jh,1,0,0),j(qh,0,1,0),j(Uu,0,0,1),qX(Ub,t),kX(t,PR)&&jX(PR,jh,qh,Uu,r,Ub),zt(nr,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),zt(Wh,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY);for(let h=0;h<t.length;h+=3){j(zu,t[h],t[h+1],t[h+2]);const u=J(jh,zu),p=J(qh,zu);nr[0]=Math.min(nr[0],u),nr[1]=Math.min(nr[1],p),Wh[0]=Math.max(Wh[0],u),Wh[1]=Math.max(Wh[1],p)}const a=J(Uu,Ub);Gb(Oc,nr[0],nr[1],a,jh,qh,Uu),Gb(Xh,Wh[0],nr[1],a,jh,qh,Uu),Gb(Qh,nr[0],Wh[1],a,jh,qh,Uu),Q(Xh,Xh,Oc),B(Xh,Xh,.5),Q(Qh,Qh,Oc),B(Qh,Qh,.5),X(Oc,Oc,Xh),X(Oc,Oc,Qh);const n=nr[0]%s,o=nr[1]%s,l=nr[0]-n,c=nr[1]-o;for(let h=0;h<t.length;h+=3){j(zu,t[h],t[h+1],t[h+2]);const u=h/3,p=4*u;i[p]=(J(jh,zu)-l)/s,i[p+1]=(J(qh,zu)-c)/s,i[p+2]=l/s,i[p+3]=c/s;const m=9*u;for(let f=0;f<3;f++)e[m+f]=Oc[f],e[m+f+3]=Xh[f],e[m+f+6]=Qh[f]}}const Ub=T(),zu=T(),PR=Ui(),jh=T(),qh=T(),Uu=T(),nr=$e(),Wh=$e(),Oc=T(),Xh=T(),Qh=T();function kX(i,e){const t=i.length/3-1;return sF(i,e,0,Math.floor(t/3),Math.floor(t*(2/3)))}function jX(i,e,t,r,s,a){g(s)?(s.basisMatrixAtPosition(a,No),j(e0,No[0],No[1],No[2]),j(t0,No[4],No[5],No[6]),j(Vb,No[8],No[9],No[10])):(j(e0,1,0,0),j(t0,0,1,0),j(Vb,0,0,1));const n=As(i);J(n,Vb)<0&&B(n,n,-1),H(r,n);const o=J(n,t0),l=J(n,e0);Math.abs(o)<Math.abs(l)?(kS(e,e0,n,-l),W(e,e),Be(t,e,n),W(t,t),B(t,t,-1)):(kS(t,t0,n,-o),W(t,t),Be(e,t,n),W(e,e))}const No=ce(),e0=T(),t0=T(),Vb=T();function qX(i,e){j($m,0,0,0);for(let t=0;t<e.length-3;t+=3)$m[0]+=e[t],$m[1]+=e[t+1],$m[2]+=e[t+2];B(i,$m,1/(e.length/3-1))}const $m=T();function Gb(i,e,t,r,s,a,n){j(i,e*s[0]+t*a[0]+r*n[0],e*s[1]+t*a[1]+r*n[1],e*s[2]+t*a[2]+r*n[2])}function WX(i){const e=new $t,{vertex:t,fragment:r}=e,s=i.output===A.Depth,a=i.hasMultipassTerrain&&(i.output===A.Color||i.output===A.Alpha);return nc(t,i),e.include(il,i),e.include(jf,i),e.include(AT,i),e.attributes.add(w.POSITION,"vec3"),e.varyings.add("vpos","vec3"),a&&e.varyings.add("depth","float"),s&&(e.include(gh,i),Jg(e),Gp(e)),t.code.add(_`
    void main(void) {
      vpos = position;
      forwardNormalizedVertexColor();
      forwardObjectAndLayerIdColor();
      ${a?"depth = (view * vec4(vpos, 1.0)).z;":""}
      gl_Position = ${s?_`transformPositionWithDepth(proj, view, vpos, nearFar, linearDepth);`:_`transformPosition(proj, view, vpos);`}
    }
  `),e.include(Qr,i),a&&e.include(Yl,i),r.include(rc),r.uniforms.add(new ai("eColor",n=>n.color)),i.output===A.Highlight&&e.include(Sh,i),r.code.add(_`
  void main() {
    discardBySlice(vpos);
    ${a?"terrainDepthTest(gl_FragCoord, depth);":""}
    vec4 fColor = ${i.hasVertexColors?"vColor * eColor;":"eColor;"}

    ${i.output===A.ObjectAndLayerIdColor?_`fColor.a = 1.0;`:""}

    if (fColor.a < ${_.float(ra)}) {
      discard;
    }

    ${i.output===A.Alpha?_`gl_FragColor = vec4(fColor.a);`:""}

    ${i.output===A.Color?_`gl_FragColor = highlightSlice(fColor, vpos); ${i.transparencyPassType===We.Color?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}`:""}
    ${i.output===A.Highlight?_`outputHighlight();`:""};
    ${i.output===A.Depth?_`outputDepth(linearDepth);`:""};
    ${i.output===A.ObjectAndLayerIdColor?_`outputObjectAndLayerIdColor();`:""}
  }
  `),e}const XX=Object.freeze(Object.defineProperty({__proto__:null,build:WX},Symbol.toStringTag,{value:"Module"}));let m$=class g$ extends Mt{initializeConfiguration(e,t){t.hasWebGL2Context=e.rctx.type===da.WEBGL2}initializeProgram(e){return new Rt(e.rctx,g$.shader.get().build(this.configuration),Lt)}_createPipeline(e,t){const r=this.configuration,s=e===We.NONE,a=e===We.FrontFace;return qe({blending:r.output!==A.Color&&r.output!==A.Alpha||!r.transparent?null:s?In:Ph(e),culling:HT(r.cullFace),depthTest:{func:Xd(e)},depthWrite:(s||a)&&r.writeDepth?cn:null,colorWrite:at,stencilWrite:r.hasOccludees?Kl:null,stencilTest:r.hasOccludees?t?Md:Wd:null,polygonOffset:s||a?r.polygonOffset?QX:null:GT(r.enableOffset)})}initializePipeline(){return this._occludeePipelineState=this._createPipeline(this.configuration.transparencyPassType,!0),this._createPipeline(this.configuration.transparencyPassType,!1)}getPipelineState(e,t){return t?this._occludeePipelineState:super.getPipelineState(e,t)}};m$.shader=new Dt(XX,()=>_e(()=>import("./ColorMaterial.glsl-6d6257f0.js"),["assets/ColorMaterial.glsl-6d6257f0.js","assets/objectResourceUtils-782953c3.js","assets/devEnvironmentUtils-5002a058.js","assets/calcite-8912bd40.js","assets/index-00759e4a.js","assets/index-5026a37a.css","assets/calcite-96fa36fd.css","assets/mat3f64-50f3b9f6.js","assets/mat4f64-abdda1bb.js","assets/BufferView-379a78a4.js","assets/vec33-69c9e93b.js","assets/DefaultMaterial_COLOR_GAMMA-6ed76d86.js","assets/types-e1c0a5bf.js","assets/enums-e2e92c86.js","assets/Version-aa0a1d91.js","assets/quat-7b70e9a8.js","assets/quatf64-f8f1c132.js","assets/resourceUtils-527631ac.js","assets/basicInterfaces-7449a8bf.js","assets/Indices-d8bff7b2.js","assets/NestedMap-1b5db22e.js","assets/requestImageUtils-d1ba3b36.js","assets/symbolColorUtils-c9d24716.js","assets/Util-6d3f024a.js","assets/sphere-d0e5285d.js","assets/VertexAttribute-15d1866a.js","assets/doublePrecisionUtils-e3c3d0d8.js","assets/OrderIndependentTransparency-5f7257d7.js","assets/Texture-563cf5e5.js","assets/FramebufferObject-8b18fc0c.js","assets/VertexElementDescriptor-2925c6af.js","assets/InterleavedLayout-d57c91d0.js","assets/vec3f32-01c06d8d.js","assets/plane-5e2b046c.js","assets/spatialReferenceEllipsoidUtils-afb35af9.js","assets/scaleUtils-d13015f2.js","assets/ElevationSamplerData-e3118b17.js","assets/Octree-499541ed.js","assets/edgeProcessing-20e12367.js","assets/deduplicate-769a6f51.js","assets/MeshComponent-788e605a.js","assets/earcut-61f7b102.js","assets/imageUtils-c2d0d1ae.js","assets/projection-5969b753.js","assets/ZoomMomentumEstimator-ef57e6a4.js","assets/floatRGBA-ca2b39ca.js","assets/dehydratedFeatures-3a140d03.js","assets/quantizationUtils-b3b2ae2a.js","assets/labelFormatUtils-71e1f841.js","assets/orientedBoundingBox-a14b97b5.js","assets/quatf32-51a323b8.js","assets/SnappingCandidate-970faec6.js","assets/callExpressionWithFeature-df1a8f01.js","assets/DefaultVertexAttributeLayouts-5f20d8dd.js","assets/geometryServiceUtils-a536bb19.js","assets/project-909a4219.js","assets/LercDecoder-65586d50.js","assets/VectorTile-d41a1f0f.js","assets/enums-fb086c25.js","assets/config-1337d16e.js","assets/TiledDisplayObject-419c008b.js","assets/DisplayObject-87c37b69.js","assets/rasterUtils-7694cc98.js","assets/resources-7587d8f4.js","assets/workerHelper-6131d203.js","assets/webgl-debug-7f880832.js","assets/RenderingContext-0f21aa0e.js","assets/ProgramCache-f29c900e.js","assets/Program-77209250.js","assets/MediaLayer-4c42fc2f.js","assets/MediaElementView-06baa4d4.js","assets/normalizeUtilsSync-3ea564a9.js","assets/resourceExtension-f31d9f10.js","assets/BoundsStore-00da37da.js","assets/PooledRBush-5a11bc7e.js","assets/prism-line-numbers-eff41b13.js","assets/label2-a2f37e65.js","assets/interactive-1de2e238.js","assets/loadable-6afd516d.js","assets/t9n-81df3a71.js","assets/observers-c89705b8.js","assets/icon-8e47fbec.js","assets/loader-c773e800.js","assets/guid-51402ee7.js","assets/prism-line-numbers-7c5d72ff.css"]));const QX={factor:1,units:1};let ba=class extends Vn{constructor(){super(...arguments),this.output=A.Color,this.cullFace=Tr.None,this.hasSlicePlane=!1,this.hasVertexColors=!1,this.transparent=!1,this.polygonOffset=!1,this.enableOffset=!0,this.writeDepth=!0,this.hasOccludees=!1,this.transparencyPassType=We.NONE,this.hasMultipassTerrain=!1,this.cullAboveGround=!1,this.objectAndLayerIdColorInstanced=!1}};d([D({count:A.COUNT})],ba.prototype,"output",void 0),d([D({count:Tr.COUNT})],ba.prototype,"cullFace",void 0),d([D()],ba.prototype,"hasSlicePlane",void 0),d([D()],ba.prototype,"hasVertexColors",void 0),d([D()],ba.prototype,"transparent",void 0),d([D()],ba.prototype,"polygonOffset",void 0),d([D()],ba.prototype,"enableOffset",void 0),d([D()],ba.prototype,"writeDepth",void 0),d([D()],ba.prototype,"hasOccludees",void 0),d([D({count:We.COUNT})],ba.prototype,"transparencyPassType",void 0),d([D()],ba.prototype,"hasMultipassTerrain",void 0),d([D()],ba.prototype,"cullAboveGround",void 0),d([D()],ba.prototype,"objectAndLayerIdColorInstanced",void 0);let OR=class extends qC{constructor(e){super(e,new YX),this.supportsEdges=!0,this._configuration=new ba}getConfiguration(e,t){return this._configuration.output=e,this._configuration.cullFace=this.parameters.cullFace,this._configuration.hasVertexColors=this.parameters.hasVertexColors,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.transparent=this.parameters.transparent,this._configuration.polygonOffset=this.parameters.polygonOffset,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.hasOccludees=this.parameters.hasOccludees,this._configuration.transparencyPassType=t.transparencyPassType,this._configuration.enableOffset=t.camera.relativeElevation<BT,this._configuration.hasMultipassTerrain=t.multipassTerrain.enabled,this._configuration.cullAboveGround=t.multipassTerrain.cullAboveGround,this._configuration}requiresSlot(e,t){return t===A.Color||t===A.Alpha||t===A.Highlight||t===A.Depth&&this.parameters.writeLinearDepth||t===A.ObjectAndLayerIdColor?e===K.DRAPED_MATERIAL?!0:t===A.Highlight?e===K.OPAQUE_MATERIAL:e===(this.parameters.transparent?this.parameters.writeDepth?K.TRANSPARENT_MATERIAL:K.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL:K.OPAQUE_MATERIAL):!1}createGLMaterial(e){return new ZX(e)}createBufferWriter(){return new kf(vi("enable-feature:objectAndLayerId-rendering")?Ij:CL)}},ZX=class extends qd{_updateOccludeeState(e){e.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:e.hasOccludees})}beginSlot(e){return this._output!==A.Color&&this._output!==A.Alpha||this._updateOccludeeState(e),this.ensureTechnique(m$,e)}},YX=class extends Hf{constructor(){super(...arguments),this.color=Bl,this.transparent=!1,this.writeDepth=!0,this.writeLinearDepth=!1,this.hasVertexColors=!1,this.polygonOffset=!1,this.hasSlicePlane=!1,this.cullFace=Tr.None,this.hasOccludees=!1}};var zr;(function(i){i[i.Horizontal=0]="Horizontal",i[i.Vertical=1]="Vertical",i[i.Cross=2]="Cross",i[i.ForwardDiagonal=3]="ForwardDiagonal",i[i.BackwardDiagonal=4]="BackwardDiagonal",i[i.DiagonalCross=5]="DiagonalCross",i[i.COUNT=6]="COUNT"})(zr||(zr={}));const Dw=.70710678118,RR=Dw,KX=.08715574274;function JX(i){const e=new $t,t=i.hasMultipassTerrain&&(i.output===A.Color||i.output===A.Alpha);i.draped||e.extensions.add("GL_OES_standard_derivatives");const{vertex:r,fragment:s}=e;nc(r,i),e.include(il,i),e.include(jf,i),i.draped?r.uniforms.add(new ue("worldToScreenRatio",(o,l)=>1/l.screenToPCSRatio)):e.attributes.add(w.BOUNDINGRECT,"mat3"),e.attributes.add(w.POSITION,"vec3"),e.attributes.add(w.UVMAPSPACE,"vec4"),e.varyings.add("vpos","vec3"),e.varyings.add("vuv","vec2"),t&&e.varyings.add("depth","float");const a=i.style===zr.ForwardDiagonal||i.style===zr.BackwardDiagonal||i.style===zr.DiagonalCross;a&&r.code.add(_`
      const mat2 rotate45 = mat2(${_.float(Dw)}, ${_.float(-RR)},
                                 ${_.float(RR)}, ${_.float(Dw)});
    `),i.draped||(rm(r,i),r.uniforms.add(new ue("worldToScreenPerDistanceRatio",(o,l)=>1/l.camera.perScreenPixelRatio)),r.code.add(_`vec3 projectPointToLineSegment(vec3 center, vec3 halfVector, vec3 point) {
float projectedLength = dot(halfVector, point - center) / dot(halfVector, halfVector);
return center + halfVector * clamp(projectedLength, -1.0, 1.0);
}`),r.code.add(_`vec3 intersectRayPlane(vec3 rayDir, vec3 rayOrigin, vec3 planeNormal, vec3 planePoint) {
float d = dot(planeNormal, planePoint);
float t = (d - dot(planeNormal, rayOrigin)) / dot(planeNormal, rayDir);
return rayOrigin + t * rayDir;
}`),r.code.add(_`
      float boundingRectDistanceToCamera() {
        vec3 center = vec3(boundingRect[0][0], boundingRect[0][1], boundingRect[0][2]);
        vec3 halfU = vec3(boundingRect[1][0], boundingRect[1][1], boundingRect[1][2]);
        vec3 halfV = vec3(boundingRect[2][0], boundingRect[2][1], boundingRect[2][2]);
        vec3 n = normalize(cross(halfU, halfV));

        vec3 viewDir = - vec3(view[0][2], view[1][2], view[2][2]);

        float viewAngle = dot(viewDir, n);
        float minViewAngle = ${_.float(KX)};

        if (abs(viewAngle) < minViewAngle) {
          // view direction is (almost) parallel to plane -> clamp it to min angle
          float normalComponent = sign(viewAngle) * minViewAngle - viewAngle;
          viewDir = normalize(viewDir + normalComponent * n);
        }

        // intersect view direction with infinite plane that contains bounding rect
        vec3 planeProjected = intersectRayPlane(viewDir, cameraPosition, n, center);

        // clip to bounds by projecting to u and v line segments individually
        vec3 uProjected = projectPointToLineSegment(center, halfU, planeProjected);
        vec3 vProjected = projectPointToLineSegment(center, halfV, planeProjected);

        // use to calculate the closest point to camera on bounding rect
        vec3 closestPoint = uProjected + vProjected - center;

        return length(closestPoint - cameraPosition);
      }
    `)),r.code.add(_`
    vec2 scaledUV() {
      vec2 uv = uvMapSpace.xy ${a?" * rotate45":""};
      vec2 uvCellOrigin = uvMapSpace.zw ${a?" * rotate45":""};

      ${i.draped?"":_`
            float distanceToCamera = boundingRectDistanceToCamera();
            float worldToScreenRatio = worldToScreenPerDistanceRatio / distanceToCamera;
          `}

      // Logarithmically discretize ratio to avoid jittering
      float step = 0.1;
      float discreteWorldToScreenRatio = log(worldToScreenRatio);
      discreteWorldToScreenRatio = ceil(discreteWorldToScreenRatio / step) * step;
      discreteWorldToScreenRatio = exp(discreteWorldToScreenRatio);

      vec2 uvOffset = mod(uvCellOrigin * discreteWorldToScreenRatio, ${_.float(i.patternSpacing)});
      return uvOffset + (uv * discreteWorldToScreenRatio);
    }
  `);const n=i.output===A.Depth;return n&&(e.include(gh,i),Jg(e),Gp(e)),r.code.add(_`
    void main(void) {
      vuv = scaledUV();
      vpos = position;
      ${t?"depth = (view * vec4(vpos, 1.0)).z;":""}
      forwardNormalizedVertexColor();
      gl_Position = ${n?_`transformPositionWithDepth(proj, view, vpos, nearFar, linearDepth);`:_`transformPosition(proj, view, vpos);`}
    }
  `),e.include(Qr,i),s.include(rc),i.draped&&s.uniforms.add(new ue("texelSize",(o,l)=>1/l.camera.pixelRatio)),i.output===A.Highlight&&e.include(Sh,i),t&&e.include(Yl,i),i.output!==A.Highlight&&(s.code.add(_`
      const float lineWidth = ${_.float(i.lineWidth)};
      const float spacing = ${_.float(i.patternSpacing)};
      const float spacingINV = ${_.float(1/i.patternSpacing)};

      float coverage(float p, float txlSize) {
        p = mod(p, spacing);

        float halfTxlSize = txlSize / 2.0;

        float start = p - halfTxlSize;
        float end = p + halfTxlSize;

        float coverage = (ceil(end * spacingINV) - floor(start * spacingINV)) * lineWidth;
        coverage -= min(lineWidth, mod(start, spacing));
        coverage -= max(lineWidth - mod(end, spacing), 0.0);

        return coverage / txlSize;
      }
    `),i.draped||s.code.add(_`const int maxSamples = 5;
float sample(float p) {
vec2 dxdy = abs(vec2(dFdx(p), dFdy(p)));
float fwidth = dxdy.x + dxdy.y;
ivec2 samples = 1 + ivec2(clamp(dxdy, 0.0, float(maxSamples - 1)));
vec2 invSamples = 1.0 / vec2(samples);
float accumulator = 0.0;
for (int j = 0; j < maxSamples; j++) {
if(j >= samples.y) {
break;
}
for (int i = 0; i < maxSamples; i++) {
if(i >= samples.x) {
break;
}
vec2 step = vec2(i,j) * invSamples - 0.5;
accumulator += coverage(p + step.x * dxdy.x + step.y * dxdy.y, fwidth);
}
}
accumulator /= float(samples.x * samples.y);
return accumulator;
}`)),s.uniforms.add(new ai("uColor",o=>o.color)),s.code.add(_`
    void main() {
      discardBySlice(vpos);
      ${t?"terrainDepthTest(gl_FragCoord, depth);":""}
      vec4 color = ${i.hasVertexColors?"vColor * uColor;":"uColor;"}
      color = highlightSlice(color, vpos);

      ${i.output!==A.Highlight?_`color.a *= ${eQ(i)};`:""}

      ${i.output===A.ObjectAndLayerIdColor?_`color.a = 1.0;`:""}

      if (color.a < ${_.float(ra)}) {
        discard;
      }

      ${i.output===A.Alpha?_`gl_FragColor = vec4(color.a);`:""}

      ${i.output===A.Color?_`gl_FragColor = color; ${i.transparencyPassType===We.Color?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}`:""}
      ${i.output===A.Highlight?_`outputHighlight();`:""}
      ${i.output===A.Depth?_`outputDepth(linearDepth);`:""};
    }
  `),e}function eQ(i){function e(t){return i.draped?_`coverage(vuv.${t}, texelSize)`:_`sample(vuv.${t})`}switch(i.style){case zr.ForwardDiagonal:case zr.Horizontal:return e("y");case zr.BackwardDiagonal:case zr.Vertical:return e("x");case zr.DiagonalCross:case zr.Cross:return _`
        1.0 - (1.0 - ${e("x")}) * (1.0 - ${e("y")})
      `;default:return"0.0"}}const tQ=Object.freeze(Object.defineProperty({__proto__:null,build:JX},Symbol.toStringTag,{value:"Module"}));let f$=class _$ extends Mt{initializeConfiguration(e,t){t.hasWebGL2Context=e.rctx.type===da.WEBGL2}initializeProgram(e){return new Rt(e.rctx,_$.shader.get().build(this.configuration),y$)}_setPipelineState(e,t){const r=this.configuration,s=e===We.NONE,a=e===We.FrontFace;return qe({blending:r.output===A.Color||r.output===A.Alpha?s?In:Ph(e):null,culling:HT(r.cullFace),depthTest:{func:Xd(e)},depthWrite:s?r.writeDepth?cn:null:bv(e),colorWrite:at,stencilWrite:r.hasOccludees?Kl:null,stencilTest:r.hasOccludees?t?Md:Wd:null,polygonOffset:s||a?r.polygonOffset?iQ:null:GT(r.enableOffset)})}initializePipeline(){return this._occludeePipelineState=this._setPipelineState(this.configuration.transparencyPassType,!0),this._setPipelineState(this.configuration.transparencyPassType,!1)}getPipelineState(e,t){return t?this._occludeePipelineState:super.getPipelineState(e,t)}};f$.shader=new Dt(tQ,()=>_e(()=>import("./Pattern.glsl-c16981af.js"),["assets/Pattern.glsl-c16981af.js","assets/objectResourceUtils-782953c3.js","assets/devEnvironmentUtils-5002a058.js","assets/calcite-8912bd40.js","assets/index-00759e4a.js","assets/index-5026a37a.css","assets/calcite-96fa36fd.css","assets/mat3f64-50f3b9f6.js","assets/mat4f64-abdda1bb.js","assets/BufferView-379a78a4.js","assets/vec33-69c9e93b.js","assets/DefaultMaterial_COLOR_GAMMA-6ed76d86.js","assets/types-e1c0a5bf.js","assets/enums-e2e92c86.js","assets/Version-aa0a1d91.js","assets/quat-7b70e9a8.js","assets/quatf64-f8f1c132.js","assets/resourceUtils-527631ac.js","assets/basicInterfaces-7449a8bf.js","assets/Indices-d8bff7b2.js","assets/NestedMap-1b5db22e.js","assets/requestImageUtils-d1ba3b36.js","assets/symbolColorUtils-c9d24716.js","assets/Util-6d3f024a.js","assets/sphere-d0e5285d.js","assets/VertexAttribute-15d1866a.js","assets/doublePrecisionUtils-e3c3d0d8.js","assets/OrderIndependentTransparency-5f7257d7.js","assets/Texture-563cf5e5.js","assets/FramebufferObject-8b18fc0c.js","assets/VertexElementDescriptor-2925c6af.js","assets/InterleavedLayout-d57c91d0.js","assets/vec3f32-01c06d8d.js","assets/plane-5e2b046c.js","assets/spatialReferenceEllipsoidUtils-afb35af9.js","assets/scaleUtils-d13015f2.js","assets/ElevationSamplerData-e3118b17.js","assets/Octree-499541ed.js","assets/edgeProcessing-20e12367.js","assets/deduplicate-769a6f51.js","assets/MeshComponent-788e605a.js","assets/earcut-61f7b102.js","assets/imageUtils-c2d0d1ae.js","assets/projection-5969b753.js","assets/ZoomMomentumEstimator-ef57e6a4.js","assets/floatRGBA-ca2b39ca.js","assets/dehydratedFeatures-3a140d03.js","assets/quantizationUtils-b3b2ae2a.js","assets/labelFormatUtils-71e1f841.js","assets/orientedBoundingBox-a14b97b5.js","assets/quatf32-51a323b8.js","assets/SnappingCandidate-970faec6.js","assets/callExpressionWithFeature-df1a8f01.js","assets/DefaultVertexAttributeLayouts-5f20d8dd.js","assets/geometryServiceUtils-a536bb19.js","assets/project-909a4219.js","assets/LercDecoder-65586d50.js","assets/VectorTile-d41a1f0f.js","assets/enums-fb086c25.js","assets/config-1337d16e.js","assets/TiledDisplayObject-419c008b.js","assets/DisplayObject-87c37b69.js","assets/rasterUtils-7694cc98.js","assets/resources-7587d8f4.js","assets/workerHelper-6131d203.js","assets/webgl-debug-7f880832.js","assets/RenderingContext-0f21aa0e.js","assets/ProgramCache-f29c900e.js","assets/Program-77209250.js","assets/MediaLayer-4c42fc2f.js","assets/MediaElementView-06baa4d4.js","assets/normalizeUtilsSync-3ea564a9.js","assets/resourceExtension-f31d9f10.js","assets/BoundsStore-00da37da.js","assets/PooledRBush-5a11bc7e.js","assets/prism-line-numbers-eff41b13.js","assets/label2-a2f37e65.js","assets/interactive-1de2e238.js","assets/loadable-6afd516d.js","assets/t9n-81df3a71.js","assets/observers-c89705b8.js","assets/icon-8e47fbec.js","assets/loader-c773e800.js","assets/guid-51402ee7.js","assets/prism-line-numbers-7c5d72ff.css"]));const iQ={factor:1,units:1};let Cs=class extends Vn{constructor(){super(...arguments),this.output=A.Color,this.cullFace=Tr.None,this.transparencyPassType=We.NONE,this.hasSlicePlane=!1,this.hasVertexColors=!1,this.polygonOffset=!1,this.writeDepth=!0,this.hasOccludees=!1,this.enableOffset=!0,this.hasMultipassTerrain=!1,this.cullAboveGround=!1}};d([D({count:A.COUNT})],Cs.prototype,"output",void 0),d([D({count:Tr.COUNT})],Cs.prototype,"cullFace",void 0),d([D({count:zr.COUNT})],Cs.prototype,"style",void 0),d([D({count:We.COUNT})],Cs.prototype,"transparencyPassType",void 0),d([D()],Cs.prototype,"hasSlicePlane",void 0),d([D()],Cs.prototype,"hasVertexColors",void 0),d([D()],Cs.prototype,"polygonOffset",void 0),d([D()],Cs.prototype,"writeDepth",void 0),d([D()],Cs.prototype,"hasOccludees",void 0),d([D()],Cs.prototype,"patternSpacing",void 0),d([D()],Cs.prototype,"lineWidth",void 0),d([D()],Cs.prototype,"enableOffset",void 0),d([D()],Cs.prototype,"draped",void 0),d([D()],Cs.prototype,"hasMultipassTerrain",void 0),d([D()],Cs.prototype,"cullAboveGround",void 0);const y$=new Map([[w.POSITION,0],[w.COLOR,3],[w.UVMAPSPACE,4],[w.BOUNDINGRECT,5]]);let rS=class extends qC{constructor(e){super(e,new aQ),this.supportsEdges=!0,this._vertexAttributeLocations=y$,this._configuration=new Cs}getConfiguration(e,t){return this._configuration.output=e,this._configuration.cullFace=this.parameters.cullFace,this._configuration.hasVertexColors=this.parameters.hasVertexColors,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.polygonOffset=this.parameters.polygonOffset,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.style=this.parameters.style,this._configuration.patternSpacing=this.parameters.patternSpacing,this._configuration.lineWidth=this.parameters.lineWidth,this._configuration.draped=this.parameters.draped,this._configuration.transparencyPassType=t.transparencyPassType,this._configuration.enableOffset=t.camera.relativeElevation<BT,this._configuration.hasMultipassTerrain=t.multipassTerrain.enabled,this._configuration.cullAboveGround=t.multipassTerrain.cullAboveGround,this._configuration}requiresSlot(e,t){return t===A.Color||t===A.Alpha||t===A.Highlight||t===A.Depth&&this.parameters.writeLinearDepth?e===K.DRAPED_MATERIAL?!0:t===A.Highlight?e===K.OPAQUE_MATERIAL:e===(this.parameters.writeDepth?K.TRANSPARENT_MATERIAL:K.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL):!1}createGLMaterial(e){return new rQ(e)}createBufferWriter(){const e=mr().vec3f(w.POSITION).vec4u8(w.COLOR).vec4f(w.UVMAPSPACE);return this.parameters.draped||e.mat3f(w.BOUNDINGRECT),new sQ(e)}},rQ=class extends qd{_updateParameters(e){return this.ensureTechnique(f$,e)}_updateOccludeeState(e){e.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:e.hasOccludees})}beginSlot(e){return this._output!==A.Color&&this._output!==A.Alpha||this._updateOccludeeState(e),this._updateParameters(e)}},sQ=class extends kf{write(e,t,r,s,a){for(const n of this.vertexBufferLayout.fieldNames){const o=r.vertexAttributes.get(n),l=r.indices.get(n);if(o&&l)switch(n){case w.POSITION:{dt(o.size===3);const c=s.getField(n,_h);c&&DT(l,o.data,e,c,a);break}case w.COLOR:{dt(o.size===3||o.size===4);const c=s.getField(n,fh);c&&D3(l,o.data,o.size,c,a);break}case w.UVMAPSPACE:{dt(o.size===4);const c=s.getField(n,sf);c&&uy(l,o.data,c,a);break}case w.BOUNDINGRECT:{dt(o.size===9);const c=s.getField(n,rf);c&&this.writeBoundingRect(l,o.data,e,c,a);break}}}}writeBoundingRect(e,t,r,s,a){const n=r,o=s.typedBuffer,l=s.typedBufferStride,c=e.length;a*=l;for(let h=0;h<c;++h){const u=9*e[h],p=t[u],m=t[u+1],f=t[u+2];o[a]=n[0]*p+n[4]*m+n[8]*f+n[12],o[a+1]=n[1]*p+n[5]*m+n[9]*f+n[13],o[a+2]=n[2]*p+n[6]*m+n[10]*f+n[14];for(let y=3;y<9;++y)o[a+y]=t[u+y];a+=l}}},aQ=class extends Hf{constructor(){super(...arguments),this.color=hi(1,1,1,1),this.writeDepth=!0,this.writeLinearDepth=!1,this.hasVertexColors=!1,this.polygonOffset=!1,this.hasSlicePlane=!1,this.cullFace=Tr.None,this.hasOccludees=!1,this.style=zr.Cross,this.patternSpacing=10,this.lineWidth=1,this.draped=!0}};function nQ(i,e,t){return lQ(oQ(i),e,t)}function oQ(i){return i&&i.pattern||null}function lQ(i,e,t){return g(i)?i.style==="none"||i.style==="solid"?(i.style==="none"&&(e.color=hi(0,0,0,0),e.transparent=!0),new OR(e)):(e.style=cQ(i.style),e.draped=t.isDraped,new rS(e)):new OR(e)}function cQ(i){switch(i){case"horizontal":return zr.Horizontal;case"vertical":return zr.Vertical;case"cross":return zr.Cross;case"forward-diagonal":return zr.ForwardDiagonal;case"backward-diagonal":return zr.BackwardDiagonal;case"diagonal-cross":return zr.DiagonalCross;default:return}}function hQ(i){return i.material instanceof rS&&!i.material.parameters.draped}function dQ(i,e){if(hQ(i)){const t=i.vertexAttributes.get(w.POSITION).data,r=i.getMutableAttribute(w.UVMAPSPACE).data,s=i.getMutableAttribute(w.BOUNDINGRECT).data;p$(r,s,t,e)}}function uQ(i,e,t,r,s){const a=NI(i,e,t,r,s),n=i.stageObject.geometries;for(const o of n)dQ(o,s);return a}const pQ=["polyline","polygon","extent"];let v$=class b$ extends _l{constructor(e,t,r,s){super(e,t,r,s),this._needsUV=!1,this._hasOutline=!1}async doLoad(){}_ensureMaterials(){this._ensureFillMaterial(),this._ensureOutlineMaterial()}_ensureFillMaterial(){if(g(this._material))return;const e=Ur(this.symbolLayer,"material","color"),t=this._getCombinedOpacityAndColor(e);this._material=nQ(this.symbolLayer,{color:t,transparent:t[3]<1||this.needsDrivenTransparentPass,polygonOffset:!1,hasVertexColors:!0,writeLinearDepth:!0,hasSlicePlane:this._context.slicePlaneEnabled},{isDraped:this.draped}),this._needsUV=this._material instanceof rS,this._context.stage.add(this._material)}_ensureOutlineMaterial(){const e=this.symbolLayer.outline;if(g(this._outlineMaterial)||!this._isValidOutline(e))return;this._hasOutline=!0;const t=r=>{const s=WL(e.pattern);return new yp({width:r,color:this._getOutlineColor(),hasPolygonOffset:!0,hasSlicePlane:this._context.slicePlaneEnabled,isClosed:!0,stipplePattern:s,stippleScaleWithLineWidth:!0,cap:Rw(e.patternCap||"butt")})};this._outlineMaterial=t(ta(e.size)),this._context.stage.add(this._outlineMaterial)}_isValidOutline(e){return g(e)&&e.size!=null&&e.size>0&&g(e.color)&&(P(e.pattern)||e.pattern.type!=="style"||e.pattern.style!=="none")}destroy(){super.destroy(),this._context.stage.remove(this._material),this._material=null,this._context.stage.remove(this._outlineMaterial),this._outlineMaterial=null}createGraphics3DGraphic(e){const t=e.graphic;if(!this._validateGeometry(t.geometry,pQ,this.symbolLayer.type))return null;const r=this._getVertexOpacityAndColor(e.renderingInfo,255),s=this.setGraphicElevationContext(t,new Po);return this.ensureDrapedStatus(s.mode==="on-the-ground"),this._ensureMaterials(),this.draped?this._createAsOverlay(t,r):this._createAs3DShape(t,r,s)}layerOpacityChanged(){if(g(this._material)){const e=this._material.parameters.color,t=Ur(this.symbolLayer,"material","color"),r=this._getCombinedOpacity(t);this._material.setParameters({color:[e[0],e[1],e[2],r],transparent:r<1||this.needsDrivenTransparentPass})}if(g(this._outlineMaterial)){const e=this._outlineMaterial.parameters.color;this._outlineMaterial.setParameters({color:[e[0],e[1],e[2],this._getOutlineOpacity()]})}}layerElevationInfoChanged(e,t,r){const s=this._elevationContext.mode,a=Qf(b$.elevationModeChangeTypes,r,s);if(a!==Oi.UPDATE)return a;const n=Un(s);return this.updateGraphics3DGraphicElevationInfo(e,t,()=>n)}slicePlaneEnabledChanged(){if(g(this._material)&&this._material.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),g(this._outlineMaterial)){const e={hasSlicePlane:this._context.slicePlaneEnabled};this._outlineMaterial.setParameters(e)}return!0}physicalBasedRenderingChanged(){return!0}pixelRatioChanged(){return!0}skipHighSymbolLodsChanged(){return!0}_createAs3DShape(e,t,r){var h;const s=Tf(e.geometry);if(P(s))return null;const a=YC(s,this._context.elevationProvider,this._context.renderCoordsHelper,r),n=new mQ(a,t,this._context.layer.uid,e.uid),o=n.renderData.position.length/3;if(this._needsUV&&(n.uvMapSpace=zi(4*o,!0),n.boundingRect=Fn(9*o,!0),p$(n.uvMapSpace,n.boundingRect,n.renderData.position,this._context.renderCoordsHelper)),n.objectAndLayerIdColor=(h=this._context.stage.renderView)==null?void 0:h.getObjectAndLayerIdColor(n),this._createAs3DShapeFill(n),this._hasOutline&&this._createAs3DShapeOutline(n),this._logGeometryCreationWarnings(n.renderData,s.rings,"rings","FillSymbol3DLayer"),n.outGeometries.length===0)return null;const l=new hc({geometries:n.outGeometries,castShadow:!1,metadata:{layerUid:this._context.layer.uid,graphicUid:e.uid}}),c=new fl(this,l,n.outGeometries,null,null,uQ,r);return c.alignedSampledElevation=n.renderData.sampledElevation,c.needsElevationUpdates=Un(r.mode),c}_createAs3DShapeFill(e){const t=e.renderData.polygons;for(const{position:r,mapPositions:s,holeIndices:a,index:n,count:o}of t){if(g(this._context.clippingExtent)&&(di(un),nn(un,s),!co(un,this._context.clippingExtent)))continue;const l=of(s,a,3);if(l.length===0)continue;const c=fO({material:Si(this._material),indices:l,mapPositions:s,attributeData:{position:r,color:e.color,uvMapSpace:this._needsUV?V2(e.uvMapSpace,4*n,4*o):null,boundingRect:this._needsUV?mo(e.boundingRect,9*n,9*o):null,objectAndLayerIdColor:e.objectAndLayerIdColor}});e.outGeometries.push(c)}}_createAs3DShapeOutline(e){if(!this._hasOutline)return;const t=e.renderData.outlines;for(let r=0;r<t.length;++r){const{mapPositions:s,position:a}=t[r];if(g(this._context.clippingExtent)&&(di(un),nn(un,s),!co(un,this._context.clippingExtent)))continue;const n=Ew(Si(this._outlineMaterial),{overlayInfo:null,removeDuplicateStartEnd:!0,mapPositions:s,attributeData:{position:a}},e.objectAndLayerIdColor),o=n.vertexAttributes.get(w.POSITION);o.data===a&&(o.data=S6(a)),e.outGeometries.push(n)}}_createAsOverlay(e,t){var o;const r=Tf(e.geometry);if(P(r))return null;Si(this._material).renderPriority=this._renderPriority+this._renderPriorityStep/2,g(this._outlineMaterial)&&(this._outlineMaterial.renderPriority=this._renderPriority);const s=IL(r,this._context.overlaySR),a=new gQ(s,t,this._context.layer.uid,e.uid),n=a.renderData.position.length/3;return this._needsUV&&(a.uvMapSpace=zi(4*n,!0),HX(a.uvMapSpace,a.renderData.position,this._context.overlaySR,this._context.graphicsCoreOwner.view.state.viewingMode)),a.outBoundingBox=di(),a.objectAndLayerIdColor=(o=this._context.stage.renderView)==null?void 0:o.getObjectAndLayerIdColor(a),this._createAsOverlayFill(a),this._hasOutline&&this._createAsOverlayOutline(a),this._logGeometryCreationWarnings(a.renderData,r.rings,"rings","FillSymbol3DLayer"),a.outGeometries.length===0?null:new Bv(this,a.outGeometries,a.outBoundingBox,this._context.drapeSourceRenderer)}_createAsOverlayFill(e){const t=e.renderData.polygons;for(const{position:r,holeIndices:s,index:a,count:n}of t){const o=di(un);if(nn(o,r),!co(o,this._context.clippingExtent))continue;const l=of(r,s,3);if(l.length===0)continue;zp(e.outBoundingBox,o);const c=fO({material:Si(this._material),indices:l,attributeData:{position:r,color:e.color,uvMapSpace:this._needsUV?V2(e.uvMapSpace,4*a,4*n):null,objectAndLayerIdColor:e.objectAndLayerIdColor}}),h=new Qp(c,e);Br(h.boundingSphere,.5*(o[0]+o[3]),.5*(o[1]+o[4]),0,.5*Math.sqrt((o[3]-o[0])*(o[3]-o[0])+(o[4]-o[1])*(o[4]-o[1]))),e.outGeometries.push(h)}}_createAsOverlayOutline(e){if(!this._hasOutline)return;const t=e.renderData.outlines;for(let r=0;r<t.length;++r){const{position:s}=t[r];if(di(un),nn(un,s),!co(un,this._context.clippingExtent))continue;zp(e.outBoundingBox,un);const a=Ew(Si(this._outlineMaterial),{overlayInfo:{spatialReference:this._context.overlaySR,renderCoordsHelper:this._context.renderCoordsHelper},removeDuplicateStartEnd:!0,attributeData:{position:s}},e.objectAndLayerIdColor),n=new Qp(a,e),o=un;Br(n.boundingSphere,.5*(o[0]+o[3]),.5*(o[1]+o[4]),0,.5*Math.sqrt((o[3]-o[0])*(o[3]-o[0])+(o[4]-o[1])*(o[4]-o[1]))),e.outGeometries.push(n)}}_getOutlineOpacity(){const e=Ur(this.symbolLayer,"outline","color");return(this.draped?1:this._getLayerOpacity())*(g(e)?e.a:0)}_getOutlineColor(){const e=Ur(this.symbolLayer,"outline","color"),t=this._getOutlineOpacity();return Mg(g(e)?ui.toUnitRGB(e):null,t)}test(){return{...super.test(),createAsOverlay:(e,t)=>this._createAsOverlay(e,t),createAs3DShape:(e,t,r)=>this._createAs3DShape(e,t,r)}}};v$.elevationModeChangeTypes={definedChanged:Oi.RECREATE,staysOnTheGround:Oi.NONE,onTheGroundChanged:Oi.RECREATE};const un=_s();let mQ=class extends Gv{constructor(e,t,r,s){super(e,r,s),this.color=t}},gQ=class extends Gv{constructor(e,t,r,s){super(e,r,s),this.color=t}},x$=class w${constructor(e){this.definition=e,this.key=JSON.stringify(e),this.haloSize=Math.round(e.halo.size),this.textStyle=this._colorToRGBA(e.color),this.haloStyle=this._colorToRGB(e.halo.color),this.backgroundStyle=e.background.color[3]!==0?this._colorToRGBA(e.background.color):null}fontString(e){const t=this.definition.font;return`${t.style} ${t.weight} ${e}px ${t.family}, sans-serif`}_colorToRGB(e){return`rgb(${e.slice(0,3).map(t=>Math.floor(255*t)).toString()})`}_colorToRGBA(e){return`rgba(${e.slice(0,3).map(t=>Math.floor(255*t)).toString()},${e[3]})`}static async fromSymbol(e,t){const r=Ur(e,"material","color"),s=Vc(r,Bl,ui.toUnitRGBA),a=Vc(e.size,12,ta),n=e.lineHeight,o=g(e.background)?Si(ui.toUnitRGBA(e.background.color)):Bl,l={family:Vc(e.font,"sans-serif",m=>m.family),decoration:Vc(e.font,"none",m=>m.decoration),weight:Vc(e.font,"normal",m=>m.weight),style:Vc(e.font,"normal",m=>m.style)},c=e.halo,h=g(c)&&g(c.color)&&c.size>0?{size:ta(c.size),color:ui.toUnitRGBA(c.color)}:{size:0,color:Bl},u=new w$({color:s,size:a,background:{color:o,padding:g(e.background)?[.65*a,.5*a]:[0,0],borderRadius:g(e.background)?a*(6/16):0},lineSpacingFactor:n,font:l,halo:h,pixelRatio:t}),p=u.fontString(a);try{await document.fonts.load(p)}catch{Pe.getLogger("esri.views.3d.webgl-engine.lib.TextRenderParameters").warnOnce(`Failed to preload font '${p}'. Some text symbology may be rendered using the default browser font.`)}return u}},fQ=class{constructor(e,t,r){this._renderer=new FL(e,t,r)}get key(){return this._renderer.key}get baselineAnchorY(){return 1-this._renderer.firstRenderedBaselinePosition/this._renderer.renderedHeight}get displayWidth(){return this._renderer.displayWidth}get displayHeight(){return this._renderer.displayHeight}create(){const e=Sw(_Q,this._renderer.renderedWidth,this._renderer.renderedHeight),t=e.getContext("2d");return t.save(),this._renderer.render(t,0,0),t.restore(),new Bf(e,{wrap:{s:kt.CLAMP_TO_EDGE,t:kt.CLAMP_TO_EDGE},noUnpackFlip:!1,mipmap:!0,preMultiplyAlpha:!0,powerOfTwoResizeMode:jT.PAD})}};const _Q={canvas:null},yQ=[0,0,1];let vQ=class extends _l{constructor(e,t,r,s){super(e,t,r,s),this._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!1},this.ensureDrapedStatus(!1)}async doLoad(){if(!this._drivenProperties.size){const e=Uv(this.symbolLayer.size);if(e)throw new bt("graphics3dtextsymbollayer:invalid-size",e)}await this._createTextRenderParameters()}async _createTextRenderParameters(){const e=this._context.graphicsCoreOwner.view.state.rasterPixelRatio;this._textRenderParameters=await x$.fromSymbol(this.symbolLayer,e)}destroy(){super.destroy()}createGraphics3DGraphic(e){const t=e.graphic,r=wf(t.geometry);if(P(r))return this.logger.warn(`unsupported geometry type for text symbol: ${t.geometry.type}`),null;const s=this.symbolLayer.text;if(P(s)||s==="")return null;const a=gT(this.symbol)&&this.symbol.hasVisibleVerticalOffset()?this.symbol.verticalOffset:null;if(g(a)&&!XA(this.symbolLayer))return this.logger.errorOncePerTick(`Callouts and vertical offset on text symbols are currently only supported with 'center' horizontal alignment (not with '${this.symbolLayer.horizontalAlignment}' alignment)`),null;const n=new II(a,this.symbolLayer.horizontalAlignment,xq(this.symbolLayer.verticalAlignment));return this._createAs3DShape(t,r,s,n)}createLabel(e,t,r,s){const a=e.graphic,n=wf(a.geometry);if(P(n))return this.logger.warn(`unsupported geometry type for label: ${a.geometry.type}`),null;const o=t.text;return!o||/^\s+$/.test(o)?null:this._createAs3DShape(a,n,o,t,r,s)}setGraphicElevationContext(e,t,r=0){const s=super.setGraphicElevationContext(e,t);return s.addOffsetRenderUnits(r),s}layerOpacityChanged(){return this.logger.warn("layer opacity change not yet implemented in Graphics3DTextSymbolLayer"),!1}layerElevationInfoChanged(e,t){return ER(e,t,(r,s)=>{this.updateGraphicElevationContext(s,r)}),Oi.UPDATE}slicePlaneEnabledChanged(e,t){return ER(e,t,r=>{for(const s of r.stageObject.geometries)s.material.setParameters({hasSlicePlane:this._context.slicePlaneEnabled})}),!0}physicalBasedRenderingChanged(){return!0}pixelRatioChanged(){return!1}skipHighSymbolLodsChanged(){return!0}updateGraphicElevationContext(e,t){const r=t.elevationContext;this.setGraphicElevationContext(e,r,g(t.metadata)?t.metadata.elevationOffset:0),t.needsElevationUpdates=Un(r.mode)||r.mode==="absolute-height"}_defaultElevationInfoNoZ(){return xQ}_createAs3DShape(e,t,r,s,a,n){const o=this.setGraphicElevationContext(e,new Po,s.elevationOffset),l=Ur(e.geometry,"type")==="polyline",c=e.uid;let h=null,u=null;if(P(n)){const M=UL(s.horizontalPlacement);h=new fQ(r,M,this._textRenderParameters);let L=null;if(g(this._context.sharedResources.textures)){u=this._context.sharedResources.textures.fromData(h.key,()=>Si(h).create(),()=>{g(L)&&L.release()});const F=this._context.stage.renderView.textureRepository.acquire(u.texture.id);if(P(F)||dv(F))return u.release(),null;L=F}}const p=bQ(h,s),m={occlusionTest:!0,screenOffset:s.screenOffset,anchorPosition:p,polygonOffset:!0,color:[1,1,1,1],centerOffsetUnits:s.centerOffsetUnits,drawInSecondSlot:!0};if(g(n)?m.textureId=n.id:g(u)&&(m.textureId=u.texture.id),g(s.verticalOffset)){const{screenLength:M,minWorldLength:L,maxWorldLength:F}=s.verticalOffset;m.verticalOffset={screenLength:ta(M),minWorldLength:L||0,maxWorldLength:g(F)?F:1/0}}if(this._context.screenSizePerspectiveEnabled){const{screenSizePerspectiveSettings:M,screenSizePerspectiveSettingsLabels:L}=this._context.sharedResources;m.screenSizePerspective=L.overridePadding(this._textRenderParameters.haloSize+this._textRenderParameters.definition.background.padding[0]),m.screenSizePerspectiveAlignment=M}let f;if(l&&(m.shaderPolygonOffset=1e-4),m.hasSlicePlane=this._context.slicePlaneEnabled,g(a)){const M=JSON.stringify(m);f=a.get(M),P(f)&&(f=new Wp(m),a.add(M,f))}else f=new Wp(m);const y=s.translation,b=g(h)?It(h.displayWidth,h.displayHeight):uh,x=s.centerOffset,S=Kx(f,yQ,y,null,b,x,[0,0],null),C=VC(this._context,t,S,o,c);if(P(C))return null;const O=new fl(this,C.object,[S],P(a)?[f]:null,u,bf,o);O.alignedSampledElevation=C.sampledElevation,O.needsElevationUpdates=Un(o.mode)||o.mode==="absolute-height";const{displayWidth:R,displayHeight:E}=g(h)?h:s;O.getScreenSize=(M=$e())=>(M[0]=R,M[1]=E,M);const $=new HI(s.elevationOffset,r);return O.metadata=$,xf(O,t,this._context.elevationProvider),O}};function ER(i,e,t){i&&i.forEach(r=>{const s=e(r);g(s)&&t(s,r.graphic)})}function bQ(i,e){if(e.verticalPlacement==="baseline"){const r=yq[e.horizontalPlacement],s=g(i)?i.baselineAnchorY:0;return It(r,s)}const t=bq(e.horizontalPlacement,e.verticalPlacement);return q0[t]}const xQ={mode:"relative-to-ground",offset:0},wQ={"calm-small":{waveStrength:.005,perturbationStrength:.02,textureRepeat:12,waveVelocity:.01},"rippled-small":{waveStrength:.02,perturbationStrength:.09,textureRepeat:32,waveVelocity:.07},"slight-small":{waveStrength:.05,perturbationStrength:.07,textureRepeat:28,waveVelocity:.1},"moderate-small":{waveStrength:.075,perturbationStrength:.07,textureRepeat:24,waveVelocity:.1},"calm-medium":{waveStrength:.003125,perturbationStrength:.01,textureRepeat:8,waveVelocity:.02},"rippled-medium":{waveStrength:.035,perturbationStrength:.015,textureRepeat:12,waveVelocity:.07},"slight-medium":{waveStrength:.06,perturbationStrength:.015,textureRepeat:8,waveVelocity:.12},"moderate-medium":{waveStrength:.09,perturbationStrength:.03,textureRepeat:4,waveVelocity:.12},"calm-large":{waveStrength:.01,perturbationStrength:0,textureRepeat:4,waveVelocity:.05},"rippled-large":{waveStrength:.025,perturbationStrength:.01,textureRepeat:8,waveVelocity:.11},"slight-large":{waveStrength:.06,perturbationStrength:.02,textureRepeat:3,waveVelocity:.13},"moderate-large":{waveStrength:.14,perturbationStrength:.03,textureRepeat:2,waveVelocity:.15}},TQ=["polyline","polygon","extent"];let Iw=class od extends _l{constructor(e,t,r,s){super(e,t,r,s)}async doLoad(){}destroy(){super.destroy(),this._context.stage.remove(this._material),this._material=null}createGraphics3DGraphic(e){const t=e.graphic;if(!this._validateGeometry(t.geometry,TQ,this.symbolLayer.type))return null;const r=this.setGraphicElevationContext(t,new Po);return this.ensureDrapedStatus(r.mode==="on-the-ground"),this.ensureMaterial(),this.draped?this._createAsOverlay(t):this._createAs3DShape(t,r,t.uid)}ensureMaterial(){if(g(this._material))return;const e=new EL,t=this.symbolLayer.color;g(t)&&(e.color=ui.toUnitRGBA(t));const r=this._getCombinedOpacity(t,{hasIntrinsicColor:!0});e.color=[e.color[0],e.color[1],e.color[2],r],e.transparent=r<1||this.needsDrivenTransparentPass,e.waveDirection=g(this.symbolLayer.waveDirection)?od.headingVectorFromAngle(this.symbolLayer.waveDirection):It(0,0);const s=this.symbolLayer.waveStrength+"-"+this.symbolLayer.waterbodySize,a=wQ[s];e.waveStrength=a.waveStrength,e.waveTextureRepeat=a.textureRepeat,e.waveVelocity=a.waveVelocity,e.flowStrength=a.perturbationStrength,e.hasSlicePlane=this._context.slicePlaneEnabled,e.isDraped=this.draped,this._material=new RL(e),this._context.stage.add(this._material)}layerOpacityChanged(){if(P(this._material))return;const e=this._material.parameters.color,t=this._getCombinedOpacity(this.symbolLayer.color,{hasIntrinsicColor:!0}),r=t<1||this.needsDrivenTransparentPass;this._material.setParameters({color:[e[0],e[1],e[2],t],transparent:r})}layerElevationInfoChanged(e,t,r){const s=this._elevationContext.mode,a=Qf(od.elevationModeChangeTypes,r,s);if(a!==Oi.UPDATE)return a;const n=Un(s);return this.updateGraphics3DGraphicElevationInfo(e,t,()=>n)}slicePlaneEnabledChanged(){return g(this._material)&&this._material.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),!0}physicalBasedRenderingChanged(){return!0}pixelRatioChanged(){return!0}skipHighSymbolLodsChanged(){return!0}_createAs3DShape(e,t,r){const s=Tf(e.geometry);if(P(s))return null;const a=YC(s,this._context.elevationProvider,this._context.renderCoordsHelper,t),n=a.position.length/3,o=Fn(2*n);this._createUVCoordsFromVertices(o,a.mapPositions,n,this._context.elevationProvider.spatialReference);const l=new CQ(a,o);if(this._create3DShapeGeometries(l),this._logGeometryCreationWarnings(l.renderData,s.rings,"rings","WaterSymbol3DLayer"),l.outGeometries.length===0)return null;const c=new hc({geometries:l.outGeometries,castShadow:!1,metadata:{layerUid:this._context.layer.uid,graphicUid:r}}),h=new fl(this,c,l.outGeometries,null,null,NI,t);return h.alignedSampledElevation=l.renderData.sampledElevation,h.needsElevationUpdates=Un(t.mode),h}_createUVCoordsFromVertices(e,t,r,s){const a=Hd(s);bo(Rc);for(let l=0;l<r;l++)zt(AR,t[3*l],t[3*l+1]),bT(Rc,AR);sv(Rc,Rc,a);const n=Rc[0]%od.unitSizeOfTexture,o=Rc[1]%od.unitSizeOfTexture;i0[0]=Rc[0]-n,i0[1]=Rc[1]-o;for(let l=0;l<r;l++)e[2*l]=(t[3*l]*a-i0[0])/od.unitSizeOfTexture,e[2*l+1]=(t[3*l+1]*a-i0[1])/od.unitSizeOfTexture}_create3DShapeGeometries(e){const t=e.renderData.polygons,r=e.uvCoords;for(const{count:s,index:a,position:n,mapPositions:o,holeIndices:l}of t){if(g(this._context.clippingExtent)&&(di(Ec),nn(Ec,o),!co(Ec,this._context.clippingExtent)))continue;const c=of(o,l,3);if(c.length===0)continue;const h=mo(r,2*a,2*s),u=_O({material:Si(this._material),indices:c,mapPositions:o,attributeData:{position:n,uv0:h}});e.outGeometries.push(u)}}_createAsOverlay(e){const t=Tf(e.geometry);if(P(t))return null;Si(this._material).renderPriority=this._renderPriority;const r=IL(t,this._context.overlaySR),s=r.position.length/3,a=Fn(2*s);this._createUVCoordsFromVertices(a,r.position,s,this._context.overlaySR);const n=new SQ(r,a,this._context.layer.uid,e.uid);return n.outBoundingBox=di(),this._createAsOverlayWater(n),this._logGeometryCreationWarnings(n.renderData,t.rings,"rings","WaterSymbol3DLayer"),n.outGeometries.length===0?null:new Bv(this,n.outGeometries,n.outBoundingBox,this._context.drapeSourceRenderer)}_createAsOverlayWater(e){const t=e.uvCoords,r=e.renderData.polygons;for(const{position:s,holeIndices:a,index:n,count:o}of r){if(di(Ec),nn(Ec,s),!co(Ec,this._context.clippingExtent))continue;zp(e.outBoundingBox,Ec);const l=of(s,a,3);if(l.length===0)continue;const c=mo(t,2*n,2*o),h=_O({material:Si(this._material),indices:l,attributeData:{position:s,uv0:c}}),u=new Qp(h,e),p=Ec;Br(u.boundingSphere,.5*(p[0]+p[3]),.5*(p[1]+p[4]),0,.5*Math.sqrt((p[3]-p[0])*(p[3]-p[0])+(p[4]-p[1])*(p[4]-p[1]))),e.outGeometries.push(u)}}static headingVectorFromAngle(e){const t=$e(),r=AN(e);return t[0]=Math.sin(r),t[1]=Math.cos(r),t}test(){return{...super.test(),create3DShape:e=>this._createAs3DShape(e.graphic,e.elevationContext,e.graphicUid),ensureMaterial:()=>this.ensureMaterial()}}};Iw.unitSizeOfTexture=100,Iw.elevationModeChangeTypes={definedChanged:Oi.RECREATE,staysOnTheGround:Oi.NONE,onTheGroundChanged:Oi.RECREATE};const i0=$e(),Rc=yt(),AR=$e(),Ec=_s();let CQ=class extends Gv{constructor(e,t){super(e,null,null),this.uvCoords=t}},SQ=class extends Gv{constructor(e,t,r,s){super(e,r,s),this.uvCoords=t}};function PQ(i,e,t,r){const s=MR[i.type]&&MR[i.type][e.type]||OQ[e.type];return s?new s(i,e,t,r):(Pe.getLogger("esri.views.3d.layers.graphics.Graphics3DSymbolLayerFactory").error("GraphicsLayerFactory#make",`unknown symbol type ${e.type}`),null)}const OQ={icon:Ow,object:kW,line:XL,path:UX,fill:v$,extrude:nq,text:vQ,water:Iw},MR={"mesh-3d":{fill:vW}};let RQ=class extends FC{set symbol(e){this._symbol=e,e.symbolLayers.forEach((t,r)=>{const s=this.symbolLayers[r];g(s)&&(s.symbol=e,s.symbolLayer=t)})}get symbol(){return this._symbol}constructor(e,t,r){super(t.schedule),this._symbol=e,this._context=t,this._backgroundLayers=r,this._destroyed=!1,this.symbolLayers=new Array,this.referenced=0,this._extentPadding=0}async doLoad(e){let t=this._symbol.symbolLayers;this._extentPadding=0,this._backgroundLayers&&(t=this._backgroundLayers.concat(t));const r=t.length;for(;this.symbolLayers.length<t.length;)this.symbolLayers.push(null);this.symbolLayers.length=t.length;const s=[];for(let a=0;a<r;a++){const n=t.getItemAt(a);if(n.enabled===!1)continue;r0.renderPriority=1-(1+a)/r,r0.renderPriorityStep=1/r,r0.ignoreDrivers=n._ignoreDrivers;const o=PQ(this.symbol,n,this._context,r0),l=MN(e,()=>{this.symbolLayers[a]=null,o.destroy()});l&&s.push(l),this.symbolLayers[a]=o}if(await yT(this.symbolLayers,async(a,n)=>{if(g(a))try{await a.load(),this._extentPadding+=Math.max(this._extentPadding,a.extentPadding)}catch{this.symbolLayers[n]=null}}),s.forEach(a=>a.remove()),lr(e),this.symbolLayers.length&&!this.symbolLayers.some(a=>!!a))throw new Error}getSymbolLayerSize(e){const t=this.symbolLayers[e];return g(t)?t.getCachedSize():null}get extentPadding(){return this._extentPadding}get symbologySnappingSupported(){return this.symbolLayers.some(e=>g(e)&&e.queryForSnapping)}createGraphics3DGraphic(e,t){const r=e.graphic,s=new Array(this.symbolLayers.length);for(let n=0;n<this.symbolLayers.length;n++){const o=this.symbolLayers[n];s[n]=g(o)?o.createGraphics3DGraphic(e):null}const a=this._context.arcade||this._context.featureExpressionInfoContext&&this._context.featureExpressionInfoContext.arcade&&this._context.featureExpressionInfoContext.arcade.modules||null;return new Nk(r,t||this,s,e.layer,a)}get complexity(){return UC(this.symbolLayers.map(e=>Ur(e,"complexity")))}globalPropertyChanged(e,t){const r=this.symbolLayers.length;for(let s=0;s<r;s++){const a=this.symbolLayers[s],n=o=>{const l=o.layers[s];return l instanceof fl?l:null};if(g(a)&&!a.globalPropertyChanged(e,t,n))return!1}return!0}applyRendererDiff(e,t){return this.loadStatus!==tn.LOADED?dr.Recreate_Symbol:this.symbolLayers.reduce((r,s)=>r!==dr.Recreate_Symbol&&g(s)?Math.min(r,s.applyRendererDiff(e,t)):r,dr.Fast_Update)}prepareSymbolPatch(e){if(this.loadStatus===tn.FAILED||e.diff.type!=="partial")return;const t=e.diff.diff;if(!t.symbolLayers||t.symbolLayers.type!=="partial")return;const r=t.symbolLayers.diff;this.symbolLayers.forEach((s,a)=>{if(P(s))return;const n=r[a];if(n){const o={diff:n,graphics3DGraphicPatches:[],symbolLayerStatePatches:[]};s.prepareSymbolLayerPatch(o),e.symbolStatePatches.push(...o.symbolLayerStatePatches),o.graphics3DGraphicPatches.length&&e.graphics3DGraphicPatches.push((l,c)=>{const h=l.layers[a];g(h)&&o.graphics3DGraphicPatches.forEach(u=>u(h,c))})}})}updateGeometry(e,t){for(let r=0;r<this.symbolLayers.length;r++){const s=this.symbolLayers[r];if(P(s))continue;const a=e.layers[r];if(P(a)||!s.updateGeometry(a,t))return!1}return!0}onRemoveGraphic(e){for(let t=0;t<this.symbolLayers.length;t++){const r=this.symbolLayers[t];if(P(r))continue;const s=e.layers[t];g(s)&&r.onRemoveGraphic(s)}}getFastUpdateStatus(){let e=0,t=0,r=0;return this.symbolLayers.forEach(s=>{P(s)||(s.loadStatus===tn.LOADING?e++:s.isFastUpdatesEnabled()?r++:t++)}),{loading:e,slow:t,fast:r}}async queryForSnapping(e,t,r,s){const a=this.symbolLayers.filter(g).filter(o=>g(o.queryForSnapping)).map(o=>o.queryForSnapping(e,t,r,s)),n=await Promise.all(a);return lr(s),n.flat()}destroy(){if(this.destroyed)console.error("Graphics3DSymbol.destroy called when already destroyed!");else{super.destroy();for(const e of this.symbolLayers)g(e)&&e.destroy();this.symbolLayers.length=0,this._destroyed=!0}}get destroyed(){return this._destroyed}};const r0={renderPriority:0,renderPriorityStep:1,ignoreDrivers:!1};let EQ=class extends FC{constructor(e,t,r){super(t),this.symbol=e,this._convert=r,this.symbologySnappingSupported=!1,this.graphics3DSymbol=null,this.referenced=0}getSymbolLayerSize(e){return g(this.graphics3DSymbol)?this.graphics3DSymbol.getSymbolLayerSize(e):null}get symbolLayers(){return g(this.graphics3DSymbol)?this.graphics3DSymbol.symbolLayers:[]}get extentPadding(){return g(this.graphics3DSymbol)?this.graphics3DSymbol.extentPadding:0}async doLoad(e){const t=await this.symbol.fetchSymbol({signal:e});t.id=this.symbol.id,this.graphics3DSymbol=this._convert(t),g(this.graphics3DSymbol)&&await this.graphics3DSymbol.load()}createGraphics3DGraphic(e){return g(this.graphics3DSymbol)?this.graphics3DSymbol.createGraphics3DGraphic(e,this):null}get complexity(){return g(this.graphics3DSymbol)?this.graphics3DSymbol.complexity:zC}globalPropertyChanged(e,t){return!!g(this.graphics3DSymbol)&&this.graphics3DSymbol.globalPropertyChanged(e,t)}applyRendererDiff(e,t){return g(this.graphics3DSymbol)?this.graphics3DSymbol.applyRendererDiff(e,t):dr.Recreate_Symbol}prepareSymbolPatch(e){g(this.graphics3DSymbol)&&this.graphics3DSymbol.prepareSymbolPatch(e)}updateGeometry(e,t){return!!g(this.graphics3DSymbol)&&this.graphics3DSymbol.updateGeometry(e,t)}onRemoveGraphic(){}getFastUpdateStatus(){return g(this.graphics3DSymbol)?this.graphics3DSymbol.getFastUpdateStatus():{loading:1,fast:0,slow:0}}destroy(){g(this.graphics3DSymbol)&&this.graphics3DSymbol.destroy(),this.graphics3DSymbol=void 0,super.destroy()}get destroyed(){return this.graphics3DSymbol===void 0}};function sS(i){return i instanceof EQ?i.graphics3DSymbol:i instanceof RQ?i:null}const Rf=Pe.getLogger("esri.views.3d.layers.graphics.labelPlacement");function AQ(i){const e=UQ(i);if(P(e))return null;const t=MQ(i,e);if(P(t))return null;const r=t.anchor,s=!!e.hasLabelVerticalOffset;return IQ({anchor:r,verticalOffset:e.verticalOffset,screenOffset:$e(),centerOffset:hi(0,0,0,-1),centerOffsetUnits:"world",translation:T(),elevationOffset:0,hasLabelVerticalOffset:s},t,i)}function MQ(i,e){if(e.anchor)return e;const t=i.labelClass.labelPlacement,r=uo[t],s=r||Wy(i);return t&&!r&&Rf.warnOncePerTick(`the requested label placement '${t}' is currently unsupported in SceneView.`),DQ(s,i)}function aS(i){const e=i.graphics3DGraphic.graphics3DSymbol,t=sS(e);return g(t)?t.symbol.symbolLayers.getItemAt(0):null}function DQ(i,e){const t=e.graphics3DGraphic.graphic.geometry;if(P(t))return null;if(g(e.disablePlacement))return e.labelClass.labelPlacement?(Rf.warnOncePerTick(DR(i.placement,e.disablePlacement.logEntityDescription)),Wy(e)):i;const r=t.type;switch(r){case"polyline":case"polygon":case"extent":case"multipoint":if(e.labelClass.labelPlacement)return Rf.warnOncePerTick(DR(i.placement,`'${r}' geometries`)),Wy(e);break;case"point":case"mesh":return i}return i}function DR(i,e){return`the requested label placement '${i}' is currently unsupported for ${e} in SceneView.`}function Wy(i){const e=i.graphics3DGraphic.graphic.geometry;if(P(e))return null;switch(e.type){case"polyline":case"extent":case"multipoint":return{placement:"center-center",normalizedOffset:null,anchor:"center"};case"polygon":{const t=aS(i);return g(t)&&t.type==="extrude"?uo["above-center"]:{placement:"center-center",normalizedOffset:null,anchor:"center"}}case"point":case"mesh":return uo["above-center"];default:return}}function IQ(i,e,t){const r=t.graphics3DGraphic.graphic.geometry;if(P(r))return null;switch(r.type){case"point":$Q(i,e,t);break;case"polygon":LQ(i,e,t);break;case"mesh":nS(i,e,t.graphics3DGraphic.layers[0])}return i}function LQ(i,e,t){const r=aS(t);if(!P(r))switch(r.type){case"extrude":{const s=t.graphics3DGraphic.layers[0];g(s)?(s.getBoundingBoxObjectSpace(Fg),oo(Fg,i.translation),i.translation[2]=dT(Fg)/2):j(i.translation,0,0,0),nS(i,e,s);break}}}function $Q(i,e,t){const r=aS(t);if(P(r))return;const s=t.graphics3DGraphic.layers[0];switch(g(s)?s.getCenterObjectSpace(i.translation):j(i.translation,0,0,0),r.type){case"icon":case"text":NQ(i,e,t,s);break;case"object":nS(i,e,s)}}function NQ(i,e,t,r){const{graphics3DGraphic:s}=t,a=g(r)?r.getScreenSize():null;if(!s.isDraped&&g(a)){const n=FQ(t);Nm[0]=a[0]/2*(e.normalizedOffset[0]-n[0]),Nm[1]=a[1]/2*(e.normalizedOffset[1]-n[1]),i.screenOffset[0]=Nm[0],i.hasLabelVerticalOffset?(i.centerOffset[1]=Nm[1],i.centerOffsetUnits="screen"):i.screenOffset[1]=Nm[1]}else i.hasLabelVerticalOffset||i.anchor==="center"||(uo[t.labelClass.labelPlacement]&&Rf.warnOncePerTick(`the requested placement '${e.placement}' is currently unsupported for draped graphics`),i.anchor="center")}function FQ(i,e=VQ){const{graphics3DGraphic:t}=i,r=t.layers[0],s=g(r)?r.stageObject.geometries[0].material:null;if(s&&s instanceof Wp){const a=s.parameters.anchorPosition;e[0]=2*(a[0]-.5),e[1]=2*(a[1]-.5)}else e[0]=0,e[1]=0;return e}function nS(i,e,t){const r=g(t)?t.getBoundingBoxObjectSpace(Fg):Fg,s=Ge(r[3]-r[0],r[4]-r[1],r[5]-r[2]),a=Math.sqrt(s[0]*s[0]+s[1]*s[1]);i.centerOffset[0]=a/2*e.normalizedOffset[0];const n=i.translation[2],o=s[2]/2*e.normalizedOffset[1];i.translation[2]=0,i.elevationOffset=n+o;const l=pe(s);i.centerOffset[2]=l/2*e.normalizedOffset[2]}function zQ(i){return i==="above-center"}function UQ(i){const e=i.labelClass.labelPlacement,{labelSymbol:t,graphics3DGraphic:r}=i,s=sS(r.graphics3DSymbol),a=th(s,o=>o.symbol.type==="point-3d"?o.symbol:null),n=uo[e]||Wy(i);return g(a)&&a.supportsCallout()&&a.hasVisibleVerticalOffset()&&!r.isDraped?{placement:null,hasLabelVerticalOffset:!1,verticalOffset:IR(a.verticalOffset),anchor:null,normalizedOffset:null}:t&&t.hasVisibleVerticalOffset()&&(P(a)||!a.supportsCallout()||!a.verticalOffset||r.isDraped)?zQ(n.placement)?{placement:"above-center",verticalOffset:IR(t.verticalOffset),anchor:"bottom",normalizedOffset:[0,n.normalizedOffset[1],0],hasLabelVerticalOffset:!0}:(Rf.errorOncePerTick("Callouts and vertical offset on labels are currently only supported with 'above-center' label placement (not with "+e+" placement)"),null):{placement:null,verticalOffset:null,anchor:null,normalizedOffset:null,hasLabelVerticalOffset:!1}}function IR(i){const{screenLength:e,minWorldLength:t,maxWorldLength:r}=i;return{screenLength:e,minWorldLength:t,maxWorldLength:r}}const uo={"above-center":{placement:"above-center",normalizedOffset:[0,1,0],anchor:"bottom"},"above-left":{placement:"above-left",normalizedOffset:[-1,1,0],anchor:"bottom-right"},"above-right":{placement:"above-right",normalizedOffset:[1,1,0],anchor:"bottom-left"},"below-center":{placement:"below-center",normalizedOffset:[0,-1,2],anchor:"top"},"below-left":{placement:"below-left",normalizedOffset:[-1,-1,0],anchor:"top-right"},"below-right":{placement:"below-right",normalizedOffset:[1,-1,0],anchor:"top-left"},"center-center":{placement:"center-center",normalizedOffset:[0,0,1],anchor:"center"},"center-left":{placement:"center-left",normalizedOffset:[-1,0,0],anchor:"right"},"center-right":{placement:"center-right",normalizedOffset:[1,0,0],anchor:"left"}},LR={"above-center":["default","esriServerPointLabelPlacementAboveCenter"],"above-left":["esriServerPointLabelPlacementAboveLeft"],"above-right":["esriServerPointLabelPlacementAboveRight"],"below-center":["esriServerPointLabelPlacementBelowCenter"],"below-left":["esriServerPointLabelPlacementBelowLeft"],"below-right":["esriServerPointLabelPlacementBelowRight"],"center-center":["esriServerPointLabelPlacementCenterCenter"],"center-left":["esriServerPointLabelPlacementCenterLeft"],"center-right":["esriServerPointLabelPlacementCenterRight"]};for(const i in LR){const e=LR[i],t=uo[i];e.forEach(r=>{uo[r]=t})}Object.freeze&&(Object.freeze(uo),Object.keys(uo).forEach(i=>{Object.freeze(uo[i]),Object.freeze(uo[i].normalizedOffset)}));const Nm=[0,0],VQ=[0,0],Fg=_s();let $R=class{constructor(e){this._stage=e,this._materials=new Map}get(e){return this._materials.get(e)}add(e,t){this._materials.set(e,t),this._stage.add(t)}dispose(){this._stage.removeMany(Array.from(this._materials.values())),this._materials.clear()}};const Bb=512,Hb=4096,GQ=.85,BQ=.95;let HQ=class{constructor(){this.offset={x:0,y:0},this.uvMinMax=Pt()}},kQ=class{constructor(e,t){this.textId=e,this.textRenderer=t,this.placement=new HQ,this.rendered=!1}},hg=class extends Ie{constructor(e){super(e),this.type=ps.Texture,this.id=Up(),this.events=new Ms,this._glTexture=null,this._needsClear=!1,this._elementsToAddOrUpdate=new Map,this._elementsToRemove=new Map,this._elementsToRender=new Map,this._elements=new Map,this._stageObjects=new Map,this.updating=!1}initialize(){this._stage=this.view._stage,this._canvas=this._create2DCanvas(),this._ctx=this._canvas.getContext("2d"),this._stage.add(this);const e=this._computeAtlasResolution(this.view.width,this.view.height);this._createAtlasRegion(e),this._update2DCanvasSize(),this._resetAtlasCursor()}unload(){this._glTexture=De(this._glTexture),this.updating=!1,this.events.emit("unloaded")}get width(){return this._atlas.size.width}get height(){return this._atlas.size.height}get requiresFrameUpdates(){return!1}_createDescriptor(e){return{target:tr.TEXTURE_2D,pixelFormat:St.RGBA,dataType:Zt.UNSIGNED_BYTE,wrapMode:kt.CLAMP_TO_EDGE,flipped:!0,samplingMode:Qt.LINEAR_MIPMAP_LINEAR,hasMipmap:!0,preMultiplyAlpha:!0,maxAnisotropy:e.parameters.maxMaxAnisotropy}}get glTexture(){return this._glTexture}load(e){return g(this._glTexture)||(this._glTexture=new Ai(e,this._createDescriptor(e),this._canvas),this._frameWorker=this.view.resourceController.scheduler.registerTask(Zi.TEXT_TEXTURE_ATLAS,this),this.setDirty()),this._glTexture}dispose(){this._elements=null,this._elementsToAddOrUpdate=null,this._elementsToRemove=null,this._elementsToRender=null,this._frameWorker=fo(this._frameWorker),this._glTexture&&(this._stage.remove(this),this._glTexture=De(this._glTexture)),this._canvas.width=0,this._canvas.height=0,this._canvas=null,this._ctx=null}_create2DCanvas(){const e=document.createElement("canvas");return e.setAttribute("id","canvas2d"),e.setAttribute("style","display:none"),e.setAttribute("width",Bb.toString()),e.setAttribute("height",Bb.toString()),e}_update2DCanvasSize(){this._canvas.setAttribute("width",this._atlas.size.width.toString()),this._canvas.setAttribute("height",this._atlas.size.height.toString())}_createAtlasRegion(e=Bb){this._atlas={size:{width:e,height:e},cursor:{x:0,y:0},lineHeight:0}}_computeAtlasResolution(e,t){let r=Math.max(e,t);return r+=256,r=xT(r),r=Math.min(r,Hb),r}_resizeAtlas(e,t){t=t||e;const r=this._atlas;r.size.width=e,r.size.height=t,g(this._glTexture)&&this._glTexture.resize(e,t),this._update2DCanvasSize()}_resetAtlasCursor(){const e=this._atlas;e.cursor.x=Fm,e.cursor.y=Fm+NR,e.lineHeight=0,this._needsClear=!0}_getAtlasUsage(){const e=this._atlas;return(e.cursor.x+e.cursor.y*e.size.width)/(e.size.width*e.size.height)}_getExpectedAtlasUsage(){const e=this._elementsToRemove.size,t=this._elementsToAddOrUpdate.size,r=this._elements.size;return this._getAtlasUsage()/r*(r+t-e)}_addAtlasElement(e,t,r,s){const a=this._atlas,{renderedWidth:n,renderedHeight:o}=e.textRenderer;e.placement.offset.x=a.cursor.x,e.placement.offset.y=a.cursor.y,Br(e.placement.uvMinMax,e.placement.offset.x/a.size.width,1-(e.placement.offset.y+o)/a.size.height,(e.placement.offset.x+n)/a.size.width,1-e.placement.offset.y/a.size.height),a.cursor.x+=r,a.lineHeight=Math.max(a.lineHeight,s),this._elements.set(t,e)}_removeAtlasElement(e){if(e&&this._elements.has(e.textId)){const t=e.placement.offset;this._ctx.clearRect(t.x,t.y,e.textRenderer.renderedWidth,e.textRenderer.renderedHeight),this._elements.delete(e.textId)}}_ensureStageObjects(e){const t=this._stageObjects.get(e);if(t)return t;const r=new Set;return this._stageObjects.set(e,r),r}_addStageObject(e,t){this._ensureStageObjects(e).add(t)}_removeStageObject(e,t){const r=this._stageObjects.get(e);r&&r.delete(t)&&(t.geometries[0].vertexAttributes.get(w.SIZE).data=[0,0],t.geometryVertexAttrsUpdated(t.geometries[0]))}_processAddition(e,t){const r=this._atlas,s=e.textId,a=e.textRenderer.renderedWidth,n=e.textRenderer.renderedHeight,o=a+Fm,l=n+Fm+NR;if(r.cursor.x+o<r.size.width&&r.cursor.y+l<r.size.height)this._addAtlasElement(e,s,o,l),this._elementsToRender.set(s,e),this._elementsToAddOrUpdate.delete(s);else{if(!(r.cursor.y+l+r.lineHeight<r.size.height)){const c=this._getExpectedAtlasUsage(),h=c>GQ&&r.size.width<Hb;return h&&this._resizeAtlas(2*r.size.width,2*r.size.height),!t||!h&&c>BQ&&r.size.width===Hb?(this._processRemovals(),vp.OK):(this._repack(),vp.REPACK)}r.cursor.x=Fm,r.cursor.y+=r.lineHeight,r.lineHeight=0,this._addAtlasElement(e,s,o,l),this._elementsToRender.set(s,e),this._elementsToAddOrUpdate.delete(s)}return vp.OK}_processRemovals(){this._elementsToRemove.forEach((e,t)=>{const r=this._stageObjects.get(t);r&&r.size!==0||this._removeAtlasElement(e),r&&r.size===0&&this._stageObjects.delete(t)}),this._elementsToRemove.clear()}_repack(){this._processRemovals(),this._elements.forEach((e,t)=>{e.rendered=!1,this._elementsToAddOrUpdate.set(t,e)}),this._elements.clear(),this._resetAtlasCursor(),this._elementsToRender.clear()}_processRenderingRequest(e){this._ctx.clearRect(e.placement.offset.x,e.placement.offset.y,e.textRenderer.renderedWidth,e.textRenderer.renderedHeight),e.textRenderer.render(this._ctx,e.placement.offset.x,e.placement.offset.y);const t=this._stageObjects.get(e.textId);t&&t.forEach(r=>{r.geometries[0].vertexAttributes.get(w.UV0).data=new Float32Array(e.placement.uvMinMax),r.geometries[0].vertexAttributes.get(w.SIZE).data=[e.textRenderer.displayWidth,e.textRenderer.displayHeight],r.geometryVertexAttrsUpdated(r.geometries[0])}),e.rendered=!0}get running(){return this.updating}runTask(e,t=!0){if(P(this._glTexture))return na.YIELD;let r=!1;if(Ks(this._elementsToAddOrUpdate,(a,n)=>{const o=this._elements.get(n);if(o&&o.rendered){const l=this._stageObjects.get(n);return l&&l.forEach(c=>{const h=c.geometries[0].vertexAttributes,u=this._elements.get(n);h.get(w.UV0).data=u.placement.uvMinMax,h.get(w.SIZE).data=[u.textRenderer.displayWidth,u.textRenderer.displayHeight],c.geometryVertexAttrsUpdated(c.geometries[0])}),this._elementsToAddOrUpdate.delete(n),e.madeProgress(),!1}return this._processAddition(this._elementsToAddOrUpdate.get(n),t)===vp.REPACK&&(r=!0,!0)}),r)return this.runTask(Ea,!1),void e.madeProgress();let s=!1;this._elementsToRender.size>0&&this._needsClear&&(this._ctx.clearRect(0,0,this._canvas.width,this._canvas.height),this._needsClear=!1),Ks(this._elementsToRender,(a,n)=>(this._processRenderingRequest(a),this._elementsToRender.delete(n),s=!0,e.madeProgress(),e.done)),s&&this._glTexture.setData(this._canvas),this.updating=this._elementsToRender.size>0,!this.updating&&Qk.orderedRepackingEnabled&&(this.repackOrdered(),e.madeProgress())}addTextTexture(e,t){const r=e.key;this._elementsToAddOrUpdate.has(r)||this._elementsToAddOrUpdate.set(r,new kQ(r,e)),this._addStageObject(r,t),this._elementsToRemove.delete(r),this.setDirty()}removeTextTexture(e,t){const r=e.key;this._elementsToRemove.set(r,this._elements.get(r)),this._removeStageObject(r,t)}setDirty(){this._glTexture&&(this.updating=!0)}repackOrdered(){if(this._elements.size===0)return;const e=[];this._elements.forEach((r,s)=>e.push({element:r,key:s}));let t=!0;for(let r=0;r<e.length-1;r++)if(e[r].key.localeCompare(e[r+1].key)>0){t=!1;break}if(!t||this._elementsToRemove.size){e.sort((r,s)=>r.key.localeCompare(s.key)),this._elements.clear();for(const{element:r,key:s}of e)this._elements.set(s,r);this._repack(),this.setDirty()}}get test(){const{_elements:e,_stageObjects:t,_elementsToRemove:r,_atlas:s}=this,a=this;return{elements:e,stageObjects:t,elementsToRemove:r,atlas:s,resizeAtlas:(n,o)=>a._resizeAtlas(n,o),run:(n,o)=>a.runTask(n,o)}}};d([v({constructOnly:!0})],hg.prototype,"view",void 0),d([v({type:Boolean})],hg.prototype,"updating",void 0),hg=d([Y("esri.views.3d.webgl-engine.lib.TextTextureAtlas")],hg);const Fm=2,NR=2;var vp;(function(i){i[i.OK=0]="OK",i[i.REPACK=1]="REPACK"})(vp||(vp={}));let FR=class{constructor(e,t){this.labelingContext=e,this.graphics3DGraphic=t,this.hasGraphics3DResources=!1,this.visible=!1,this.rendered=!1,this.textInitialized=!1,this.textRenderers=new Array,this.textLabelPlacements=new Array}},jQ=class{constructor(e,t,r,s,a){this.labelClass=e,this.graphics3DSymbol=t,this.graphics3DCalloutSymbolLayer=r,this.textRenderParameters=s,this.labelFunction=a,this.calloutSymbolLayerIndex=0}},qQ=class{constructor(e,t,r,s,a,n,o){this.layer=e,this.graphics3DCore=t,this.scaleVisibility=r,this.emptySymbolLabelSupported=s,this.elevationInfoOverride=a,this.disablePlacement=n,this.active=o,this.labelClassAbortController=new AbortController,this.labelClassContexts=new Array,this.graphics=new Map,this.labelsToInitialize=new Map,this.stageLayer=new nL({pickable:!0,disableOctree:!0},e.uid)}},ld=class extends Ie{constructor(e){super(e),this._dirty=!1,this._labels=new Map,this._labelsToAdd=new Map,this._labelsToRemove=new Map,this._labelingContexts=new Array}setup(){this.dispose(),this._handles=new Vi,this._handles.add([te(()=>{var e;return(e=this.view.state)==null?void 0:e.camera},()=>this.setDirty()),te(()=>{var e;return(e=this.view.state)==null?void 0:e.rasterPixelRatio},()=>this._resetAllLabels()),this.view.resourceController.scheduler.registerTask(Zi.LABELER,this)]),this._textTextureAtlas=new hg({view:this.view}),this._hudMaterialCollection=new $R(this.view._stage),this._calloutMaterialCollection=new $R(this.view._stage)}dispose(){this._handles=Te(this._handles),this._textTextureAtlas=De(this._textTextureAtlas),this._hudMaterialCollection=De(this._hudMaterialCollection),this._calloutMaterialCollection=De(this._calloutMaterialCollection),this._labelingContexts.length=0,this._labels.clear(),this._labelsToAdd.clear(),this._labelsToRemove.clear()}_activateLabelingContext(e){e.graphics.forEach((t,r)=>{const s=new FR(e,t);this._labels.set(r,s),e.labelsToInitialize.set(r,s),t.setVisibilityFlag(Ma.USER_SETTING,!0,Fr.LABEL)}),e.active=!0}_deactivateLabelingContext(e){e.graphics.forEach((t,r)=>{t.setVisibilityFlag(Ma.USER_SETTING,!1,Fr.LABEL),this.setLabelGraphicVisibility(t,!1),this._labels.delete(r)}),e.active=!1}_addLabelTextureToAtlas(e){for(const t of e.graphics3DGraphic.labelLayers){if(!t._labelClass)continue;const r=e.textRenderers[t._labelIndex];g(r)&&this._textTextureAtlas.addTextTexture(r,t.stageObject)}e.rendered=!0}_removeLabelTextureFromAtlas(e){for(const t of e.graphics3DGraphic.labelLayers){if(!t._labelClass)continue;const r=e.textRenderers[t._labelIndex];g(r)&&this._textTextureAtlas.removeTextTexture(r,t.stageObject)}e.rendered=!1}get running(){return this.view.ready&&(this._dirty||this.deconflictor.running)}runTask(e){return this._updateLabels(e),!this._dirty&&this.deconflictor.running&&this.deconflictor.runTask(e),na.YIELD}_updateLabels(e){if(this._dirty){this._dirty=!1;for(const t of this._labelingContexts)if(t.active){if(!zR(t)){if(WQ(t)){this._deactivateLabelingContext(t);continue}if(this._createLabelClassContext(t),kb(t)){this._dirty=!0;continue}if(!zR(t))continue}Ks(t.labelsToInitialize,(r,s)=>(this._ensureGraphics3DResources(r)&&(this._labels.set(s,r),this.deconflictor.setDirty(),e.madeProgress()),(r.visible&&r.textInitialized||!r.visible&&r.hasGraphics3DResources)&&(t.labelsToInitialize.delete(s),e.madeProgress()),e.done))&&(this._dirty=!0)}this._labelsToRemove.forEach(t=>this._removeLabelTextureFromAtlas(t)),this._labelsToAdd.forEach(t=>this._addLabelTextureToAtlas(t)),this._labelsToRemove.clear(),this._labelsToAdd.clear(),this._dirty||this.notifyChange("updating")}}async _createLabelClassContextAsync(e){var n,o,l;const t=(n=e.labelClassAbortController)==null?void 0:n.signal;await((l=(o=e.layer).when)==null?void 0:l.call(o)),lr(t),e.scaleVisibility&&e.scaleVisibility.updateScaleRangeActive();const r=e.graphics3DCore,s=r.layer,a=s.labelingInfo&&s.labelingInfo.filter(c=>!!c.symbol);!a||a.length===0||(await yT(a,async(c,h)=>{const u=c.symbol,p=sS(r.getOrCreateGraphics3DSymbol(u));if(P(p))return void Pe.getLogger(this.declaredClass).error("Failed to create Graphics3DSymbol for label");await p.load(),lr(t);let m=null;gT(u)&&u.hasVisibleCallout()&&(m=Ik(u,r.symbolCreationContext),await m.load(),lr(t));const f=await ly(U6(c,e.layer.fieldsIndex,this.view.spatialReference));if(lr(t),f.ok===!0){const y=await this._createTextRenderParameters(p.symbol);lr(t),e.labelClassContexts[h]=new jQ(c,p,m,y,f.value)}else Pe.getLogger(this.declaredClass).error(`Label expression failed to evaluate: ${f.error}`)}),lr(t))}async _createLabelClassContext(e){return P(e.labelClassPromise)&&(e.labelClassPromise=this._createLabelClassContextAsync(e).catch(t=>{if(yo(t))throw t;e.labelClassContexts.length=0}).then(()=>{e.labelClassAbortController=null,this.notifyChange("updating")}).catch(()=>{}),this.notifyChange("updating")),e.labelClassPromise}async _createTextRenderParameters(e){const t=e.symbolLayers.getItemAt(0);return t&&t.type==="text"?x$.fromSymbol(t,this.view.state.rasterPixelRatio):null}_destroyLabelClassContext(e){for(const r of e.labelClassContexts)--r.graphics3DSymbol.referenced;const t=e.labelClassAbortController;e.labelClassAbortController=new AbortController,Th(t),e.labelClassContexts.length=0,e.labelClassPromise=null,this.notifyChange("updating")}_createTextSymbolGraphic(e,t,r,s,a){const n=new II(r.verticalOffset,JO(r.anchor),vq(r.anchor),e.text,r.translation,r.elevationOffset,r.centerOffset,r.screenOffset,r.centerOffsetUnits,e.displayWidth,e.displayHeight);return Ac.graphic=t,Ac.renderingInfo=null,Ac.layer=s,a.createLabel(Ac,n,this._hudMaterialCollection,this._textTextureAtlas)}_createLineCalloutGraphic(e,t,r,s,a){return Ac.graphic=e,Ac.layer=a,Ac.renderingInfo=new Mk(null,t,s.translation,s.centerOffset,s.screenOffset,s.centerOffsetUnits,s.elevationOffset,this._calloutMaterialCollection),r.createGraphics3DGraphic(Ac)}_ensureGraphics3DResources(e){if(e.hasGraphics3DResources)return!1;const t=e.graphics3DGraphic;if(t.destroyed)return!1;this._ensureTextTextureResources(e);const r=e.labelingContext,s=r.labelClassContexts;if(!s||s.length===0||!r.emptySymbolLabelSupported&&t.layers.length===0)return!1;let a=!1;const n=t.graphic,o=r.layer,l=s0(r.layer),c=this.view._stage;for(let h=0;h<s.length;h++){const u=e.textRenderers[h],p=e.textLabelPlacements[h];if(P(u)||P(p))continue;const m=s[h],f=m.graphics3DSymbol,y=f.symbol&&f.symbol.type==="label-3d"?f.symbol:null,b=f.symbolLayers[0];if(!b)continue;b.setElevationInfoOverride(r.elevationInfoOverride);const x=this._createTextSymbolGraphic(u,n,p,o,b);if(P(x))return!1;x._labelClass=m.labelClass,x._labelIndex=h,t.addLabelGraphic(x,c,r.stageLayer),t.setVisibilityFlag(Ma.USER_SETTING,l,Fr.LABEL),t.clearVisibilityFlag(Ma.SCALE_RANGE,Fr.LABEL),t.setVisibilityFlag(Ma.DECONFLICTION,!1,Fr.LABEL),a=!0;const S=m.graphics3DCalloutSymbolLayer;if(S&&p.hasLabelVerticalOffset){S.setElevationInfoOverride(r.elevationInfoOverride);const C=this._createLineCalloutGraphic(n,y,S,p,o);g(C)&&(m.calloutSymbolLayerIndex=t.labelLayers.length,t.addLabelGraphic(C,c,r.stageLayer))}break}return r.scaleVisibility&&a&&r.scaleVisibility.updateGraphicLabelScaleVisibility(t),e.hasGraphics3DResources=!0,!0}_destroyGraphics3DResources(e){const t=e.labelingContext.labelClassContexts;for(const r of e.graphics3DGraphic.labelLayers){if(r._labelClass==null)continue;const s=t[r._labelIndex].graphics3DSymbol.symbolLayers[0];s!=null&&s.onRemoveGraphic(r)}e.graphics3DGraphic.clearLabelGraphics(),e.hasGraphics3DResources=!1}_ensureTextTextureResources(e){var a;if(e.textInitialized)return;const t=e.labelingContext,r=t.labelClassContexts;if(!r||r.length===0)return;const s=e.graphics3DGraphic.graphic;for(let n=0;n<r.length;n++){const o=r[n];if(e.textRenderers[n]=null,e.textLabelPlacements[n]=null,!o.textRenderParameters)continue;const l=o.labelFunction;let c;if(l.type==="arcade")try{const S=l.needsHydrationToEvaluate()?kH(s,t.layer):s;c=l.evaluate(S)}catch{c=null}else c=l.evaluate(s);if(P(c)||c===""||/^\s+$/.test(c))continue;const h=o.graphics3DSymbol,u=((a=h.symbol)==null?void 0:a.type)==="label-3d"?h.symbol:null;if(!h.symbolLayers[0])continue;const p=e.graphics3DGraphic,m=o.labelClass,f=t.disablePlacement,y=AQ({graphics3DGraphic:p,labelSymbol:u,labelClass:m,disablePlacement:f});if(P(y))continue;const b=JO(y.anchor),x=UL(b);e.textRenderers[n]=new FL(c,x,o.textRenderParameters),e.textLabelPlacements[n]=y}e.textInitialized=!0}_destroyTextTextureResources(e){e.textInitialized=!1,e.textRenderers.length=0,e.textLabelPlacements.length=0}_addGraphic(e,t){const r=t.graphic.uid;if(e.graphics.set(r,t),e.active){const s=new FR(e,t);this._labels.set(r,s),e.labelsToInitialize.set(r,s)}this.setDirty(),this.deconflictor.setDirty()}_removeGraphic(e,t){const r=t.graphic.uid,s=this._labels.get(r);e.graphics.delete(r),s&&(this._destroyGraphic(s,r),e.labelsToInitialize.delete(r),this.setDirty(),this.deconflictor.setDirty())}_destroyGraphic(e,t){this._labels.has(t)&&(this._labels.delete(t),this._labelsToAdd.delete(t),this._labelsToRemove.delete(t)),e.textInitialized&&(this._removeLabelTextureFromAtlas(e),this._destroyTextTextureResources(e)),e.hasGraphics3DResources&&this._destroyGraphics3DResources(e)}async _labelingInfoChange(e,t){if(!t)return this._visibilityInfoChange(e),this._resetLabels(e),this._createLabelClassContext(e);for(const r of t){const s=e.graphics.get(r);s&&(this._removeGraphic(e,s),this._addGraphic(e,s))}}_globalPropertyChanged(e,t){for(const r of t.labelClassContexts){const s=new Map;t.graphics.forEach(n=>s.set(n.graphic.uid,n));const a=n=>n.labelLayers[0];if(Si(r.graphics3DSymbol.symbolLayers[0]).globalPropertyChanged(e,s,a),r.graphics3DCalloutSymbolLayer){const n=o=>o.labelLayers[r.calloutSymbolLayerIndex];r.graphics3DCalloutSymbolLayer.globalPropertyChanged(e,s,n)}}}_visibilityInfoChange(e){const t=s0(e.layer);t&&!e.active&&this._activateLabelingContext(e),!t&&e.active&&this._deactivateLabelingContext(e),this.setDirty()}_resetAllLabels(){for(const e of this._labelingContexts)this._resetLabels(e)}_resetLabels(e){e.graphics.forEach((t,r)=>{const s=this._labels.get(r);s&&(this._destroyGraphic(s,r),s.visible=!1,s.rendered=!1,e.labelsToInitialize.set(r,s))}),this._destroyLabelClassContext(e),this.setDirty(),this.deconflictor.setDirty()}_findLabelingContext(e){for(const t of this._labelingContexts)if(t.graphics3DCore===e)return t;return null}addGraphicsOwner(e,t,r){const s=r&&r.emptySymbolLabelSupported||!1,a=r&&r.elevationInfoOverride||null,n=r&&r.disablePlacement||null;if(this._findLabelingContext(e))return;const o=e.layer,l=new qQ(o,e,t,s,a,n,s0(o));return this.view._stage.add(l.stageLayer),this._labelingContexts.push(l),this.setDirty(),{addGraphic:c=>this._addGraphic(l,c),removeGraphic:c=>this._removeGraphic(l,c),featureReductionChange:()=>{},layerLabelsEnabled:()=>s0(l.layer),labelingInfoChange:c=>this._labelingInfoChange(l,c),elevationInfoChange:()=>this._globalPropertyChanged("elevationInfo",l),slicePlaneEnabledChange:()=>this._globalPropertyChanged("slicePlaneEnabled",l),visibilityInfoChange:()=>this._visibilityInfoChange(l),reset:()=>this._resetLabels(l),clear:()=>{}}}removeGraphicsOwner(e){const t=this._findLabelingContext(e);if(!t)return;const r=this._labelingContexts.indexOf(t);this._labelingContexts.splice(r,1),t.graphics.forEach(s=>this._removeGraphic(t,s)),this.view._stage.remove(t.stageLayer),this.setDirty()}setLabelGraphicVisibility(e,t){const r=e.graphic.uid,s=this._labels.get(r);s&&s.visible!==t&&(t&&!s.rendered?(this._labelsToAdd.set(r,s),this._labelsToRemove.delete(r),s.textInitialized||s.labelingContext.labelsToInitialize.set(r,s)):!t&&s.rendered&&(this._labelsToRemove.set(r,s),this._labelsToAdd.delete(r)),s.visible=t,this.setDirty())}setDirty(){!this._dirty&&this._labelingContexts.length>0&&(this._dirty=!0,this.notifyChange("updating"))}get updating(){var e;return this._dirty||((e=this._textTextureAtlas)==null?void 0:e.updating)||this.deconflictor.updating||this._labelingContexts.some(t=>kb(t))}get updatingProgress(){if(!this.updating||!this._textTextureAtlas)return 1;const e=this._labelingContexts.length>0?this._labelingContexts.reduce((t,r)=>t+(kb(r)?0:1),0)/this._labelingContexts.length:1;return(this._dirty?0:.3)+(this._textTextureAtlas.updating?0:.1)+.1*e+.5*this.deconflictor.updatingProgress}get test(){return{textTextureAtlas:this._textTextureAtlas,resetAllLabels:()=>this._resetAllLabels()}}};function kb(i){return!!i.labelClassPromise&&!!i.labelClassAbortController}function zR(i){return i.labelClassContexts&&i.labelClassContexts.length}function WQ(i){return i.labelClassContexts===null}function s0(i){var e;return i.labelsVisible===!0&&!!((e=i.labelingInfo)!=null&&e.some(t=>!!t.symbol))}d([v({constructOnly:!0})],ld.prototype,"view",void 0),d([v({constructOnly:!0})],ld.prototype,"deconflictor",void 0),d([v()],ld.prototype,"_textTextureAtlas",void 0),d([v({type:Boolean,readOnly:!0})],ld.prototype,"updating",null),ld=d([Y("esri.views.3d.layers.graphics.Labeler")],ld);const Ac=new Dk(null,null,null);let dg=class np{constructor(e,t,r,s=null){this.lij=[0,0,0],this.extent=yt(),this.resolution=0,this.loadPriority=0,this.measures={visibility:ls.VISIBLE_ON_SURFACE,screenRect:yt(),distance:0,shouldSplit:!1},this.used=!1,s&&this.acquire(e,t,r,s)}acquire(e,t,r,s){this.tilingScheme=s,this.id=np.id(e,t,r),this.lij[0]=e,this.lij[1]=t,this.lij[2]=r,s.getExtent(e,t,r,this.extent),this.resolution=s.resolutionAtLevel(e)}release(){this.tilingScheme=null}getChildren(e){const t=this.lij[0]+1,r=2*this.lij[1],s=2*this.lij[2];return e?(e[0].acquire(t,r,s,this.tilingScheme),e[1].acquire(t,r+1,s,this.tilingScheme),e[2].acquire(t,r,s+1,this.tilingScheme),e[3].acquire(t,r+1,s+1,this.tilingScheme),e):[new np(t,r,s,this.tilingScheme),new np(t,r+1,s,this.tilingScheme),new np(t,r,s+1,this.tilingScheme),new np(t,r+1,s+1,this.tilingScheme)]}copyMeasurementsFrom(e){this.measures.visibility=e.measures.visibility,this.measures.shouldSplit=e.measures.shouldSplit,this.measures.distance=e.measures.distance,Wg(e.measures.screenRect,this.measures.screenRect)}static id(e,t,r){return`${e}/${t}/${r}`}};var ls;(function(i){i[i.INVISIBLE=0]="INVISIBLE",i[i.VISIBLE_WHEN_EXTENDED=1]="VISIBLE_WHEN_EXTENDED",i[i.VISIBLE_ON_SURFACE=2]="VISIBLE_ON_SURFACE"})(ls||(ls={}));const T$=.5*Math.PI,XQ=T$/Math.PI*180;let QQ=class{constructor(e){this._renderCoordsHelper=e.renderCoordsHelper,this._extent=new Array(4),this._planes=new Array(6),this._maxSpan=0,this._center={origin:T(),direction:T()};for(let t=0;t<4;t++)this._extent[t]={origin:T(),direction:T(),cap:{next:null,direction:T()}},this._planes[t]=Ui();this._planes[$i.NEAR]=Ui(),this._planes[$i.FAR]=Ui(),this._planesWithoutFar=this._planes.slice(0,5)}update(e,t,r,s=!0){const a=this._extent;this._toRenderBoundingExtent(e,t,r),X(this._center.origin,a[0].origin,a[2].origin),B(this._center.origin,this._center.origin,.5),this._renderCoordsHelper.worldUpAtPosition(this._center.origin,this._center.direction),s||B(this._center.direction,this._center.direction,-1);for(let n=0;n<4;n++){const o=a[n];this._renderCoordsHelper.worldUpAtPosition(o.origin,o.direction);const l=a[n===3?0:n+1];o.cap.next=l.origin,Bd(o.cap.direction,o.origin,l.origin),Qg(o.direction,o.cap.direction,o.origin,this._planes[n]),s||B(o.direction,o.direction,-1)}Qg(a[0].cap.direction,a[1].cap.direction,a[0].origin,this._planes[$i.NEAR]),s?Ox(this._planes[$i.NEAR],this._planes[$i.FAR]):(b3(this._planes[$i.FAR],this._planes[$i.NEAR]),Ox(this._planes[$i.NEAR],this._planes[$i.NEAR])),this._maxSpan=Math.max(Math.abs(e[0]-e[2]),Math.abs(e[1]-e[3])),this._maxSpanSpatialReference=t,this._minGlobalAltitude=.9*Et(this._maxSpanSpatialReference).radius}isVisibleInFrustum(e,t,r=!1){if(e==null)return!1;if(this._renderCoordsHelper.viewingMode===ve.Global){const a=this._maxSpanSpatialReference.isGeographic?XQ:T$*t;if(this._maxSpan>a)return!0;if(e.altitude!=null&&e.altitude>=this._minGlobalAltitude)return this._isVisibleInFrustumGlobal(e)}if(this._maxSpan===0){const a=this._extent[0];return!(r||!e.intersectsRay(xo(a.origin,a.direction)))}for(let a=0;a<this._extent.length;a++){const n=this._extent[a];if(!r&&e.intersectsRay(xo(n.origin,n.direction))||e.intersectsLineSegment(wd(n.origin,n.cap.next,YQ),n.cap.direction))return!0}const s=r?this._planes:this._planesWithoutFar;for(let a=0;a<e.lines.length;a++){const n=e.lines[a];if(xU(s,n.origin,n.endpoint,n.direction))return!0}return!1}_toRenderBoundingExtentGlobal(e,t,r){wT(e,jn),jn[2]=r,Zl(t,jn,jb,this._renderCoordsHelper.spatialReference),$a(UR,jb),di(ya);for(const{x0:a,x1:n,y0:o,y1:l}of ZQ)for(let c=0;c<5;c++){const h=c/4;jn[0]=st(e[a],e[n],h),jn[1]=st(e[o],e[l],h),jn[2]=r,Jr(jn,t,jn,this._renderCoordsHelper.spatialReference),xe(jn,jn,UR),Fp(ya,jn)}j(this._extent[0].origin,ya[0],ya[1],ya[2]),j(this._extent[1].origin,ya[3],ya[1],ya[2]),j(this._extent[2].origin,ya[3],ya[4],ya[2]),j(this._extent[3].origin,ya[0],ya[4],ya[2]);for(let a=0;a<4;++a)xe(this._extent[a].origin,this._extent[a].origin,jb)}_toRenderBoundingExtentLocal(e,t,r){hv(e,t,Pl,this._renderCoordsHelper.spatialReference),j(this._extent[0].origin,Pl[0],Pl[1],r),j(this._extent[1].origin,Pl[2],Pl[1],r),j(this._extent[2].origin,Pl[2],Pl[3],r),j(this._extent[3].origin,Pl[0],Pl[3],r)}_toRenderBoundingExtent(e,t,r){switch(this._renderCoordsHelper.viewingMode){case ve.Global:this._toRenderBoundingExtentGlobal(e,t,r);break;case ve.Local:this._toRenderBoundingExtentLocal(e,t,r);break;default:_o(this._renderCoordsHelper.viewingMode)}}_isVisibleInFrustumGlobal(e){if(Ri(e.planes[$i.NEAR],this._center.origin)<0&&J(this._center.direction,e.direction)<0)return!0;for(let t=0;t<4;t++){const r=this._extent[t];if(Ri(e.planes[$i.NEAR],r.origin)<0&&J(r.direction,e.direction)<0)return!0}return!1}};const ZQ=[{x0:0,y0:1,x1:2,y1:1},{x0:0,y0:3,x1:2,y1:3},{x0:0,y0:1,x1:0,y1:3},{x0:2,y0:1,x1:2,y1:3}],jn=T(),jb=ce(),UR=ce(),ya=_s(),Pl=yt(),YQ=em();let KQ=class{constructor(e){this._renderCoordsHelper=e,this._surfaceElevation=0,this._cache=new Map,this._frustum=new Wc(e),this._extendedFrustum=new Wc(e),this._intersector=new QQ({renderCoordsHelper:e}),this._renderCoordsHelper=e}begin(e,t){this._surfaceElevation=t,this._aboveGround=this._renderCoordsHelper.getAltitude(e.eye)>t,this._frustum.update(e),this._shortenFrustumFarPlane(this._frustum),this._updateExtendedFrustum(e)}end(){this._cache.clear()}calculate(e){if(this._allTilesInvisible)return ls.INVISIBLE;const t=this._renderCoordsHelper.viewingMode===ve.Global&&e.lij[0]>=JQ&&e.lij[0]<eZ,r=this._getOrCalculateSingleTileVisibility(e,!t);return r!==ls.INVISIBLE&&t?this._calculateAggregatedChildrenVisibility(e):r}_shortenFrustumFarPlane(e){const t=Wc.nearFarLineIndices,r=e.mutablePoints;for(const s of t){const[a,n]=s,o=r[a],l=r[n];Q(ka,l,o),B(ka,ka,iZ),X(r[n],o,ka)}e.updatePoints(r)}_calculateAggregatedChildrenVisibility(e){let t=ls.INVISIBLE;const r=this._cache.get(e.id);if(r!=null)return r;const s=HR.acquire();e.getChildren(s);for(const a of s){const n=this.calculate(a);if(n!==ls.INVISIBLE&&(t=n,n===ls.VISIBLE_ON_SURFACE))break}return HR.release(s),this._cache.set(e.id,t),t}_getOrCalculateSingleTileVisibility(e,t){const r=this._cache.get(e.id);if(r!=null)return r;const s=this._calculateSingleTileVisibility(e);return t&&this._cache.set(e.id,s),s}_calculateSingleTileVisibility(e){return!this._aboveGround&&this._renderCoordsHelper.viewingMode===ve.Global&&e.lij[0]<tZ?this._calculateSingleTileVisibilitySided(e,!1)===ls.INVISIBLE?this._calculateSingleTileVisibilitySided(e,!0):void 0:this._calculateSingleTileVisibilitySided(e,this._aboveGround)}_calculateSingleTileVisibilitySided(e,t){this._intersector.update(e.extent,e.tilingScheme.spatialReference,this._surfaceElevation,t);const r=Et(e.tilingScheme.spatialReference).radius;return this._intersector.isVisibleInFrustum(this._extendedFrustum,r)?this._intersector.isVisibleInFrustum(this._frustum,r,!0)?ls.VISIBLE_ON_SURFACE:ls.VISIBLE_WHEN_EXTENDED:ls.INVISIBLE}_updateExtendedFrustum(e){this._extendedFrustum.update(e),this._shortenFrustumFarPlane(this._extendedFrustum);const t=this._renderCoordsHelper.worldUpAtPosition(e.eye,ka);this._aboveGround||oa(t,t);const r=es(-J(t,e.viewForward));if(this._allTilesInvisible=r>(Math.PI+e.fovY)/2,this._allTilesInvisible||(this._hasExtendedFrustum=r>e.fovY/2,!this._hasExtendedFrustum))return;const s=this._extendedFrustumParameters(),a=this._extendedFrustum.mutablePoints;for(let n=0;n<4;n++){const o=s.pointIndices[n],l=a[o],c=this._renderCoordsHelper.getAltitude(l);if(s.needsAltitudeAdjustment(c)){switch(this._renderCoordsHelper.worldUpAtPosition(l,ka),o){case ei.FAR_BOTTOM_LEFT:case ei.FAR_TOP_LEFT:case ei.NEAR_BOTTOM_LEFT:case ei.NEAR_TOP_LEFT:s2(this._extendedFrustum.planes[$i.LEFT],ka,ka);break;case ei.FAR_BOTTOM_RIGHT:case ei.FAR_TOP_RIGHT:case ei.NEAR_BOTTOM_RIGHT:case ei.NEAR_TOP_RIGHT:s2(this._extendedFrustum.planes[$i.RIGHT],ka,ka)}B(ka,ka,s.direction),this._renderCoordsHelper.intersectInfiniteManifold(xo(l,ka),s.zWithMargin,l)}}if(this._extendedFrustum.updatePoints(a),tl(a[ei.NEAR_BOTTOM_LEFT],a[ei.NEAR_BOTTOM_RIGHT],a[ei.NEAR_TOP_RIGHT],GR),tl(a[ei.NEAR_BOTTOM_RIGHT],a[ei.NEAR_TOP_RIGHT],a[ei.NEAR_TOP_LEFT],BR),J(As(GR),As(BR))<0){const n=this._extendedFrustum.mutablePoints;this._aboveGround?[n[ei.NEAR_BOTTOM_LEFT],n[ei.NEAR_BOTTOM_RIGHT]]=[n[ei.NEAR_BOTTOM_RIGHT],n[ei.NEAR_BOTTOM_LEFT]]:[n[ei.NEAR_TOP_LEFT],n[ei.NEAR_TOP_RIGHT]]=[n[ei.NEAR_TOP_RIGHT],n[ei.NEAR_TOP_LEFT]],this._extendedFrustum.updatePoints(n)}}_extendedFrustumParameters(){return this._aboveGround?this._extendedFrustumParametersAboveSurface():this._extendedFrustumParametersBelowSurface()}_extendedFrustumParametersAboveSurface(){const e=this._surfaceElevation-VR;return{zWithMargin:e,pointIndices:Wc.planePointIndices.bottom,direction:-1,needsAltitudeAdjustment:t=>t>e}}_extendedFrustumParametersBelowSurface(){const e=this._surfaceElevation+VR;return{zWithMargin:e,pointIndices:Wc.planePointIndices.top,direction:1,needsAltitudeAdjustment:t=>t<e}}};const JQ=2,eZ=6,tZ=12,iZ=.95,VR=1,ka=T(),GR=Ui(),BR=Ui(),HR=new lo(Array,i=>{i.length!==4&&(i[0]=new dg,i[1]=new dg,i[2]=new dg,i[3]=new dg)},i=>{i[0].release(),i[1].release(),i[2].release(),i[3].release()});let rZ=class{constructor(e){this._camera=new Fe,this._focusOnMap=[0,0],this._screenRect=yt(),this._tileSize=e.tileSize,this._renderCoordsHelper=e.renderCoordsHelper,this._tilingScheme=e.tilingScheme,this._visibility=new KQ(e.renderCoordsHelper)}begin(e,t,r){this._camera.copyFrom(e),this._surfaceElevation=r,this._focusOnMap[0]=t.x,this._focusOnMap[1]=t.y,s3(0,0,e.fullWidth,e.fullHeight,this._screenRect),this._visibility.begin(this._camera,r)}end(){this._visibility.end()}updateTile(e){e.measures.visibility=this._visibility.calculate(e),e.measures.distance=DN(e.extent,this._focusOnMap),e.measures.visibility!==ls.INVISIBLE&&this._updateScreenMeasure(e)}_updateScreenMeasure(e){const t=sZ,r=1<<t,s=e.measures.screenRect;bo(s);let a=0;const n=e.lij[0]+t,o=e.lij[1]<<t,l=e.lij[2]<<t,c=this._tileSizeWithBias(e),h=c*c;for(let u=0;u<r;u++)for(let p=0;p<r;p++)if(a+=this._computeScreenArea(e,n,o+u,l+p,s),a>h)return void(e.measures.shouldSplit=!0);e.measures.shouldSplit=!1}_tileSizeWithBias(e){return e.measures.visibility===ls.VISIBLE_WHEN_EXTENDED?this._tileSize*aZ:this._tileSize}_computeScreenArea(e,t,r,s,a){const n=e.measures.visibility===ls.VISIBLE_WHEN_EXTENDED;this._projectToScreen(t,r,s,n,Mc),bo(qb);for(let o=0;o<4;o++)bT(qb,Mc[o]);return eh(a,qb,a),h2(Mc[0],Mc[1],Mc[2])+h2(Mc[0],Mc[2],Mc[3])}_projectToScreen(e,t,r,s,a){this._tilingScheme.ensureMaxLod(e),this._tilingScheme.getExtent(e,t,r,zm),this._toRenderCoords(zm,0,3,Dc[0]),this._toRenderCoords(zm,2,3,Dc[1]),this._toRenderCoords(zm,2,1,Dc[2]),this._toRenderCoords(zm,0,1,Dc[3]),s&&(this._projectToPlane(Dc,this._camera.frustum[$i.NEAR]),this._projectToPlane(Dc,this._camera.frustum[$i.TOP]),this._projectToPlane(Dc,this._camera.frustum[$i.BOTTOM]));for(let n=0;n<4;n++)this._camera.projectToRenderScreen(Dc[n],kR),this._camera.renderToScreen(kR,a[n])}_projectToPlane(e,t){for(let s=0;s<4;s++)Vm[s]=Ri(t,e[s]);const r=Math.max(Vm[0],Vm[1],Vm[2],Vm[3]);if(r>0){const s=B(Um,As(t),-r);for(let a=0;a<4;a++)X(e[a],e[a],s)}}_toRenderCoords(e,t,r,s){return Um[0]=e[t],Um[1]=e[r],Um[2]=this._surfaceElevation,this._renderCoordsHelper.toRenderCoords(Um,this._tilingScheme.spatialReference,s),s}};const qb=yt(),sZ=2,aZ=5,Mc=[Pi(),Pi(),Pi(),Pi()],zm=yt(),Um=T(),Dc=[T(),T(),T(),T()],Vm=[0,0,0,0],kR=Zr();function dce(i,e,t){if(P(i)||P(t))return!1;let r=!0;return ar[0]=i.xmin!=null?i.xmin:0,ar[1]=i.ymin!=null?i.ymin:0,ar[2]=i.zmin!=null?i.zmin:0,r=r&&ha(ar,i.spatialReference,0,e,t,0,1),ar[0]=i.xmax!=null?i.xmax:0,ar[1]=i.ymax!=null?i.ymax:0,ar[2]=i.zmax!=null?i.zmax:0,r=r&&ha(ar,i.spatialReference,0,e,t,3,1),i.xmin==null&&(e[0]=-1/0),i.ymin==null&&(e[1]=-1/0),i.zmin==null&&(e[2]=-1/0),i.xmax==null&&(e[3]=1/0),i.ymax==null&&(e[4]=1/0),i.zmax==null&&(e[5]=1/0),r}function C$(i,e,t){if(P(i)||P(t))return!1;let r=!0;return ar[0]=i.xmin!=null?i.xmin:0,ar[1]=i.ymin!=null?i.ymin:0,ar[2]=i.zmin!=null?i.zmin:0,r=r&&ha(ar,i.spatialReference,0,ar,t,0,1),e[0]=ar[0],e[1]=ar[1],ar[0]=i.xmax!=null?i.xmax:0,ar[1]=i.ymax!=null?i.ymax:0,ar[2]=i.zmax!=null?i.zmax:0,r=r&&ha(ar,i.spatialReference,0,ar,t,0,1),e[2]=ar[0],e[3]=ar[1],i.xmin==null&&(e[0]=-1/0),i.ymin==null&&(e[1]=-1/0),i.xmax==null&&(e[2]=1/0),i.ymax==null&&(e[3]=1/0),r}const ar=T();let Nr=class extends Ie{get tilingScheme(){const e=this.tilingSchemeOwner.tilingScheme;return e?e.clone():null}set filterExtent(e){if(g(e)&&!e.spatialReference.equals(this.viewState.spatialReference))return void Pe.getLogger(this.declaredClass).error("#extent","extent spatial reference needs to be in the same spatial reference as the view");const t=this._get("filterExtent");if(t===e||g(t)&&e&&t.equals(e))return;const r=g(e)?e.clone():null;this._set("filterExtent",r),this._setDirty()}get _filterExtentRect(){if(P(this.filterExtent))return null;const e=yt();return C$(this.filterExtent,e,this.tilingScheme.spatialReference),e}get _rootTileIds(){const{tilingScheme:e}=this;return this._filterExtentRect&&e?e.rootTilesInExtent(this._filterExtentRect):[[0,0,0]]}set suspended(e){e!==this._get("suspended")&&(this._set("suspended",e),this._setDirty())}get updating(){return this._dirty||!!this._pendingTiles}constructor(e){super(e),this.tiles=new Od,this.tileSize=512,this._idToTile=new Map,this._handles=new Vi,this._clients=new Set,this._dirty=!1,this._pendingTiles=null,this._newTiles=new At}initialize(){this._handles.add([te(()=>[this.tilingScheme,this.tileSize],()=>this._reset(),Bt),te(()=>{var e,t,r;return[this.tileSize,(e=this.cameraOnSurface)==null?void 0:e.location,this.tilingScheme,(t=this.viewState)==null?void 0:t.contentCamera,(r=this.focus)==null?void 0:r.location]},()=>this._setDirty(),Qi)]),this.scheduler&&(this._frameWorker=this.scheduler.registerTask(Zi.FEATURE_TILE_TREE,this))}destroy(){this._frameWorker=fo(this._frameWorker),this._handles=Te(this._handles)}addClient(){const e=oZ();return this._clients.add(e),this._clients.size===1&&this._setDirty(),{remove:()=>this._removeClient(e)}}_removeClient(e){this._clients.delete(e),this._hasClients||this._clear()}get _hasClients(){return this._clients.size>0}_setDirty(){!this._hasClients||this.suspended||this._dirty||(this._frameWorker?(this._dirty=!0,this.notifyChange("updating")):this.runTask(Ea))}_clear(){this.tiles.removeAll(),this._idToTile.clear(),this._reset(),this._dirty=!1,this.notifyChange("updating")}get running(){return this.updating}runTask(e){this._dirty=!1,this._pendingTiles||(this._startUpdate(),g(this._frameWorker)&&(this._frameWorker.priority=Zi.FEATURE_TILE_TREE_ACTIVE)),this._subdivideTilesForView(e),!this._pendingTiles&&g(this._frameWorker)&&(this._frameWorker.priority=Zi.FEATURE_TILE_TREE),this.notifyChange("updating")}_startUpdate(){if(this.suspended)return;if(!this.tilingScheme)return void this._clear();this._tileMeasurements||(this._tileMeasurements=new rZ({renderCoordsHelper:this.renderCoordsHelper,tilingScheme:this.tilingScheme,tileSize:this.tileSize}));const e=this.viewState.contentCamera;this._tileMeasurements.begin(e,this.focus.location,this.cameraOnSurface.location.z??0),this._pendingTiles=this._getRootTiles()}_reset(){this._newTiles.clear(),this._tileMeasurements=null,this._pendingTiles=null,this._setDirty()}_getRootTiles(){const{tilingScheme:e}=this;return this._rootTileIds.map(t=>new dg(t[0],t[1],t[2],e))}_purgeHorizonTiles(e){e.sort((t,r)=>{const s=t.measures.screenRect,a=r.measures.screenRect;return s[1]+s[3]-(a[1]+a[3])}),bo(a0);for(let t=0;t<e.length;t++)if(eh(a0,e.data[t].measures.screenRect,a0),dh(a0)>lZ)return e.data.slice(t,e.length);return[]}_subdivideTilesForView(e){if(!this._pendingTiles)return;const{tilingScheme:t}=this;for(;this._pendingTiles.length>0&&!e.done;){const r=this._pendingTiles.pop();e.madeProgress(),this._filterExtentRect&&!ov(this._filterExtentRect,r.extent)||(this._tileMeasurements.updateTile(r),r.measures.visibility!==ls.INVISIBLE&&(r.measures.shouldSplit?(t.ensureMaxLod(r.lij[0]+1),this._pendingTiles.push(...r.getChildren())):this._newTiles.push(r)))}this._pendingTiles.length===0&&(this._updateTiles(this._purgeHorizonTiles(this._newTiles)),this._newTiles.clear(),this._tileMeasurements.end(),this._pendingTiles=null)}_updateTiles(e){for(const s of this.tiles.items)s.used=!1;const t=e.filter(s=>{const a=this._idToTile.get(s.id);return a?(a.copyMeasurementsFrom(s),a.used=!0):this._idToTile.set(s.id,s),!a}),r=this.tiles.items.filter(s=>!s.used&&(this._idToTile.delete(s.id),!0));this.tiles.removeMany(r),this.tiles.addMany(t),this._sortTiles()}_sortTiles(){this.viewState.fixedContentCamera||this.tiles.sort((e,t)=>e.measures.visibility!==t.measures.visibility?e.measures.visibility===ls.VISIBLE_ON_SURFACE?-1:1:e.measures.distance-t.measures.distance),this.tiles.forEach((e,t)=>e.loadPriority=t)}};d([v({constructOnly:!0})],Nr.prototype,"scheduler",void 0),d([v({constructOnly:!0})],Nr.prototype,"renderCoordsHelper",void 0),d([v({constructOnly:!0})],Nr.prototype,"tilingSchemeOwner",void 0),d([v({constructOnly:!0})],Nr.prototype,"cameraOnSurface",void 0),d([v({constructOnly:!0})],Nr.prototype,"focus",void 0),d([v({constructOnly:!0})],Nr.prototype,"viewState",void 0),d([v({constructOnly:!0})],Nr.prototype,"terrain",void 0),d([v()],Nr.prototype,"tiles",void 0),d([v()],Nr.prototype,"tileSize",void 0),d([v({readOnly:!0})],Nr.prototype,"tilingScheme",null),d([v()],Nr.prototype,"filterExtent",null),d([v({readOnly:!0})],Nr.prototype,"_filterExtentRect",null),d([v({readOnly:!0})],Nr.prototype,"_rootTileIds",null),d([v({value:!1})],Nr.prototype,"suspended",null),d([v({readOnly:!0})],Nr.prototype,"updating",null),Nr=d([Y("esri.views.3d.layers.support.FeatureTileTree3D")],Nr);let nZ=0;function oZ(){return nZ++}const a0=yt(),lZ=10;let sr=class extends Ie{constructor(){super(...arguments),this._propertiesPool=new hh({camera:Fe},this),this._lastSeenCameraProjectionValues=new Fe,this.mode=ii.ANIMATING,this.rasterPixelRatio=1,this.contentPixelRatio=1,this.events=new Ms,this.viewingMode=ve.Global,this._cameraChanged=!1,this._updateQueue=new Array,this._processingUpdates=!1}init(e,t){this._set("viewingMode",e),this._set("spatialReference",t),this._set("constraints",new Dl({mode:this.viewingMode}))}exit(){this.cameraController=null,this._propertiesPool.destroy(),this._propertiesPool=new hh({camera:Fe},this)}createInitialCamera(){if(this.viewingMode===ve.Global){const e=Et(this.spatialReference).radius;this.camera=new Fe({eye:Ge(4*e,0,0),center:Ge(e,0,0),up:Ge(0,0,1)})}else this.camera=new Fe({eye:Ge(0,0,100),center:Ge(0,0,0),up:Ge(0,1,0)})}get animation(){return this.cameraController instanceof gf&&g(this.cameraController.viewAnimation)?this.cameraController.viewAnimation:null}get camera(){return this._get("camera")}set camera(e){e!==pn&&pn.copyFrom(e),pn.computeUp(this.viewingMode),this.events.emit("before-camera-change",pn);const t=this._get("camera");if(this._cameraProjectionChanged(this._lastSeenCameraProjectionValues,pn)&&(this._lastSeenCameraProjectionValues.copyFrom(pn),this.events.emit("camera-projection-changed",this._lastSeenCameraProjectionValues)),(!t||!t.equals(pn))&&(this._set("camera",this._propertiesPool.get("camera").copyFrom(pn)),this._cameraChanged=!t||!t.almostEquals(pn),this._cameraChanged)){const r=IN(()=>{this._cameraChanged=!1,r.remove()})}}get pixelRatio(){return this.camera.pixelRatio}get contentCamera(){return je(this._contentCamera,this.camera)}set contentCamera(e){this._contentCamera=g(e)?e.clone():null}get fixedContentCamera(){return g(this._contentCamera)}get isGlobal(){return this.viewingMode===ve.Global}get isLocal(){return this.viewingMode===ve.Local}get navigating(){return!(!this.cameraController||!this.cameraController.isInteractive)}get stationary(){return!this._cameraChanged&&!this.navigating}get cameraController(){return this._get("cameraController")}set cameraController(e){this.stopActiveCameraController()?(e&&(this.removeHandles(jR),this.addHandles(Rd(()=>e.state===_i.Finished||e.state===_i.Stopped,()=>{this._set("cameraController",null),this.updateCamera(t=>e.onControllerEnd(t))},{sync:!0,once:!0}),jR),e.onControllerStart(this.camera)),this._set("cameraController",e)):e&&(e.state=_i.Rejected)}switchCameraController(e){return this.cameraController=e,e.state!==_i.Rejected}stopActiveCameraController(){return!(this.cameraController&&!this.cameraController.stopController())}updateCamera(e){this._updateQueue.push(e),this._processUpdateQueue()}_processUpdateQueue(){if(this._updateQueue.length===0||this._processingUpdates)return;this._processingUpdates=!0;const e=this._updateQueue.shift();pn.copyFrom(this._get("camera")),e(pn),this.camera=pn,this._processingUpdates=!1,this._processUpdateQueue()}_cameraProjectionChanged(e,t){return e.fov!==t.fov||e.fullViewport[0]!==t.fullViewport[0]||e.fullViewport[1]!==t.fullViewport[1]||e.fullViewport[2]!==t.fullViewport[2]||e.fullViewport[3]!==t.fullViewport[3]||e.padding[rt.TOP]!==t.padding[rt.TOP]||e.padding[rt.RIGHT]!==t.padding[rt.RIGHT]||e.padding[rt.BOTTOM]!==t.padding[rt.BOTTOM]||e.padding[rt.LEFT]!==t.padding[rt.LEFT]}};d([v()],sr.prototype,"mode",void 0),d([v({readOnly:!0,type:$p})],sr.prototype,"animation",null),d([v({type:Fe})],sr.prototype,"camera",null),d([v({readOnly:!0})],sr.prototype,"pixelRatio",null),d([v()],sr.prototype,"rasterPixelRatio",void 0),d([v()],sr.prototype,"contentPixelRatio",void 0),d([v({})],sr.prototype,"_contentCamera",void 0),d([v({type:Fe})],sr.prototype,"contentCamera",null),d([v({readOnly:!0})],sr.prototype,"fixedContentCamera",null),d([v({readOnly:!0})],sr.prototype,"constraints",void 0),d([v({readOnly:!0})],sr.prototype,"events",void 0),d([v({readOnly:!0})],sr.prototype,"isGlobal",null),d([v({readOnly:!0})],sr.prototype,"isLocal",null),d([v({readOnly:!0})],sr.prototype,"viewingMode",void 0),d([v({readOnly:!0})],sr.prototype,"spatialReference",void 0),d([v()],sr.prototype,"navigating",null),d([v()],sr.prototype,"stationary",null),d([v()],sr.prototype,"_cameraChanged",void 0),d([v()],sr.prototype,"cameraController",null),sr=d([Y("esri.views.3d.state.ViewState")],sr);const cZ=sr,pn=new Fe,jR="ViewStateHandles";let hZ=class{constructor(e,t,r){this.viewingMode=e,this._forEachLayer=t,this._view=r,this._externalIntersectionHandlers=new At,this._tolerance=kp,this._tmpRay=Aa(),this._tmpRegion=yt(),this._validateHUDIntersector=zn(this.viewingMode),this._validateHUDIntersector.options.hud=!1}intersectScreen(e,t,r){return this.intersectRay(this._getPickRay(e,this._tmpRay),qR(this.viewingMode),t,r)}intersectScreenFreePointFallback(e,t,r){return this.intersectRayFreePointFallback(this._getPickRay(e,this._tmpRay),t,r)}intersectRayFreePointFallback(e,t,r){return this.intersectRay(e,qR(this.viewingMode),t,r)||this._intersectRayFreePointLocal(e,t)}intersectRay(e,t,r,s){return t.options.selectionMode=!1,t.options.store=Vr.MIN,this.computeIntersection(e,t,s),!!t.results.min&&t.results.min.getIntersectionPoint(r)}getCenterRayWithSubpixelOffset(e,t,r=.5,s=.5){return e.getRenderCenter(l0,r,s),l0[0]+=.0466,l0[1]-=.0123,bC(e,l0,t)}intersectIntersectorScreen(e,t,r){this.computeIntersection(this._getPickRay(e,this._tmpRay),t,r)}intersectToolIntersectorScreen(e,t,r){const s=this._getPickRay(e,this._tmpRay);this.intersectToolIntersectorRay(s,t,r)}intersectToolIntersectorRay(e,t,r){t.options.selectionMode=!0,this.computeIntersection(e,t,r);const s=t.results.min;this._view.basemapTerrain&&this._view.basemapTerrain.opaque||So(s)&&s.intersector!==ci.TERRAIN||(t.options.selectionMode=!1,this.computeIntersection(e,t,r))}setTolerance(e=kp){this._tolerance=e}addIntersectionHandler(e){this._externalIntersectionHandlers.push(e),this._externalIntersectionHandlers.sort((t,r)=>t.type===ci.TERRAIN?1:r.type===ci.TERRAIN?-1:0)}removeIntersectionHandler(e){this._externalIntersectionHandlers.removeUnordered(e)!=null&&this._externalIntersectionHandlers.sort((t,r)=>t.type===ci.TERRAIN?1:r.type===ci.TERRAIN?-1:0)}_getPickRay(e,t){const r=this._view.state.camera;return CD(r,e,t)}_intersectRayFreePointLocal(e,t){return this.viewingMode!==ve.Local||P(e)||X(t,e.origin,W(Ve.get(),e.direction)),!1}intersectElevationFromScreen(e,t,r=0,s=null){return this._intersectElevation(this._getPickRay(e,this._tmpRay),t,r,s)}_intersectElevation(e,t,r=0,s=null){if(P(e))return null;const a=g(t)?t.mode:"absolute-height",n=g(t)?je(t.offset,0):0,o=a!=="on-the-ground"?n+r:0,l=o/this._view.renderCoordsHelper.unitInMeters;if(a==="absolute-height"){if(this._view.renderCoordsHelper.intersectInfiniteManifold(e,o,o0)){const S=this._view.computeMapPointFromVec3d(o0);return S.z??(S.z=0),S.z-=n,S}return null}const c=this._view.state.camera,h=Np(Ve.get());c.projectToRenderScreen(e.origin,h);const u=new WR(null,this._forEachLayer),p=this._view.slicePlane,m=g(p)?mP(p):null,f=zn(this.viewingMode);f.options.store=Vr.MIN,f.options.verticalOffset=l;const y=e.origin,b=X(Ve.get(),y,e.direction);f.reset(y,b,c),f.point=h;const x=g(s)?"type"in s&&s.type==="graphics"?S=>{var C;return((C=S.metadata)==null?void 0:C.layerUid)!==s.uid}:S=>{var C;return((C=S.metadata)==null?void 0:C.graphicUid)!==s.uid}:null;switch(a){case"relative-to-scene":{const S=C=>{var O;return(P(x)||x(C))&&!!((O=C.metadata)!=null&&O.isElevationSource)};f.intersect(u.layers,h,this._tolerance,null,S),this._externalIntersectionHandlers.forAll(C=>{if(C.type===ci.I3S||C.type===ci.TERRAIN){const O=C.slicePlaneEnabled?m:null;C.intersect(f,O,f.rayBegin,f.rayEnd,h)}});break}case"on-the-ground":case"relative-to-ground":this._externalIntersectionHandlers.forAll(S=>{if(S.isGround){const C=S.slicePlaneEnabled?m:null;S.intersect(f,C,f.rayBegin,f.rayEnd,h)}})}if(f.results.min.getIntersectionPoint(o0)){const S=this._view.computeMapPointFromVec3d(o0);return S.z=r,S}return null}computeIntersection(e,t,r){var f;if(P(e))return;const s=this._view.state.camera,a=Np(Ve.get());s.projectToRenderScreen(e.origin,a);const n=new WR(r,this._forEachLayer);t.options.selectOpaqueTerrainOnly=!r||!("include"in r||"exclude"in r);const o=e.origin,l=X(Ve.get(),e.origin,e.direction);t.reset(o,l,s),t.intersect(n.layers,a,this._tolerance);const c=this._view.slicePlane,h=g(c)?mP(c):null;t.intersect(n.sliceableLayers,a,this._tolerance,h);const u=r&&(r.requiresGroundFeedback||r.enableDraped);this._externalIntersectionHandlers.forAll(y=>{const b=y.layerUid,x=Array.isArray(b),S=x?b:[b];x&&(t.options.filteredLayerUids=[]);let C=!1;for(const O of S)n.filterLayerUid(O)?C=!0:x&&t.options.filteredLayerUids.push(O);if(t.options.isFiltered=!C,y.isGround&&u||!t.options.isFiltered){const O=y.slicePlaneEnabled?h:null;y.intersect(t,O,o,l,a)}});const p=Ve.get(),m=this._view.basemapTerrain;if(r&&r.enableDraped&&g(m.spatialReference)&&t.results.ground.getIntersectionPoint(p)){const y=m.overlayManager.renderer,b=this._view.renderCoordsHelper.spatialReference,x=Ve.get();this._view.renderCoordsHelper.fromRenderCoords(p,x,m.spatialReference),x[2]=je((f=this._view.elevationProvider)==null?void 0:f.getElevation(p[0],p[1],p[2],b,"ground"),0),y.intersect(t,x,t.results.ground,S=>n.filterRenderGeometry(S))}t.sortResults(),this._processHUDResults(t)}_processHUDResults(e){const t=e.results.hud;Wg(this._tmpRegion,LN);const r=this._view.state.camera,s=[],a=this._tmpRegion,n=x=>{const S=new uZ(x);r.projectToRenderScreen(x.target.center,S.screenPoint),S.screenPoint[0]=Math.floor(S.screenPoint[0]),S.screenPoint[1]=Math.floor(S.screenPoint[1]),s.push(S),bT(a,S.screenPoint)};e.sortResults(t.all),g(t.min.dist)&&n(t.min);for(const x of t.all)t.min.target.object!==x.target.object&&t.max.target.object!==x.target.object&&n(x);if(g(t.max.dist)&&t.max.target.object!==t.min.target.object&&n(t.max),!s.length)return;a[0]===a[2]&&(a[2]+=1),a[1]===a[3]&&(a[3]+=1);const o=r.fullWidth,l=r.fullHeight,c=Math.max(0,a[0]-ug),h=Math.max(0,a[1]-ug),u=Math.min(Yo(a)+2*ug,o-c),p=Math.min(dh(a)+2*ug,l-h),m=new Uint8Array(u*p*4);this._view._stage.renderer.readHUDVisibility(c,h,u,p,m);let f=!0;const y=P(e.results.max.dist);let b=0;for(const x of s)for(const S of dZ)if(m[4*(Math.min(x.screenPoint[0]+S[0],o)-a[0]+(Math.min(x.screenPoint[1]+S[1],l)-a[1])*u)]){f&&(e.results.min.copy(x.result),f=!1),y&&e.results.max.copy(x.result),e.options.store===Vr.ALL&&e.results.all.splice(b++,0,x.result);break}}};const ug=1,dZ=(()=>{const i=[],e=ug;for(let t=-e;t<=e;t++)for(let r=-e;r<=e;r++)i.push([r+e,t+e]);return i})();let uZ=class{constructor(e){this.result=e,this.screenPoint=Zr()}},n0;function qR(i){return n0&&n0.viewingMode===i||(n0=zn(i)),n0}let WR=class{constructor(e,t){this.layers=new Array,this.sliceableLayers=new Array,this.include=e==null?void 0:e.include,this.exclude=e==null?void 0:e.exclude,t(r=>{r.pickable&&this.filterLayerUid(r.apiLayerUid)&&(r.sliceable?this.sliceableLayers:this.layers).push(r)})}filterLayerUid(e){const{include:t,exclude:r}=this;return P(e)?t==null&&r==null:(t==null||t.has(e))&&(r==null||!r.has(e))}filterRenderGeometry(e){return this.filterLayerUid(e.layerUid)}};function XR(i){return typeof i=="object"&&"intersect"in i}const o0=T(),l0=Zr();let _ce=class{constructor(e,t){this.spatialReference=e,this._view=t}getElevation(e,t,r){return this._view.elevationProvider.getElevation(e,t,0,this.spatialReference,r)}async queryElevation(e,t,r,s,a){return this._view.elevationProvider.queryElevation(e,t,0,this.spatialReference,a,r,s)}},pZ=class{constructor(e,t,r,s){this.spatialReference=t,this._getElevationQueryProvider=r,this._queries=new Array,this._queryOptions={...s,ignoreInvisibleLayers:!0},this._frameTask=e.registerTask(Zi.ELEVATION_QUERY,this)}destroy(){this._frameTask.remove()}queryElevation(e,t,r,s=0){return new Promise((a,n)=>{const o={x:e,y:t,minDemResolution:s,result:{resolve:a,reject:n},signal:r};this._queries.push(o),jg(r,()=>{$N(this._queries,o),n(ea())})})}get running(){return this._queries.length>0}runTask(e){const t=this._queries;this._queries=[];const r=this._getElevationQueryProvider();if(!r)return t.forEach(h=>h.result.reject()),void e.madeProgress();const s=t.map(h=>[h.x,h.y]),a=t.reduce((h,u)=>Math.min(h,u.minDemResolution),1/0),n=new NN({points:s,spatialReference:this.spatialReference}),o=t.length>1&&t.some(h=>!!h.signal)?new AbortController:null,l=g(o)?o.signal:t[0].signal;if(g(o)){let h=0;t.forEach(u=>jg(u.signal,()=>{h++,u.result.reject(ea()),h===t.length&&o.abort()}))}const c={...this._queryOptions,minDemResolution:a,signal:l};r.queryElevation(n,c).then(h=>{t.forEach((u,p)=>{g(u.signal)&&u.signal.aborted?u.result.reject(ea()):u.result.resolve(h.geometry.points[p][2])})}).catch(h=>{t.forEach(u=>u.result.reject(h))}),e.madeProgress()}get test(){const e=this;return{update:()=>e._queries.length>0&&e.runTask(Ea)}}},pg=class extends Ms.EventedMixin(Ie){get spatialReference(){var e,t;return(t=(e=this.view)==null?void 0:e.basemapTerrain)==null?void 0:t.spatialReference}constructor(e){super(e),this._im=new Array,this._ground=new Array,this._scene=new Array,this._handles=new Map,this.lastElevationQuery=null,this.elevationCacheEnabled=!1}destroy(){this._elevationQueryCached=Te(this._elevationQueryCached)}get _elevationQuery(){return P(this._elevationQueryCached)&&(this._elevationQueryCached=new pZ(this.view.resourceController.scheduler,this.view.spatialReference,()=>this.view.map&&this.view.map.ground,{maximumAutoTileRequests:4})),this._elevationQueryCached}enableElevationCache(e){e||(this.lastElevationQuery=null),this.elevationCacheEnabled=e}getElevation(e,t,r,s,a){if(this.elevationCacheEnabled&&this.lastElevationQuery!=null){const o=this.lastElevationQuery;if(e===o.x&&t===o.y&&r===o.z&&QA(s,o.spatialReference)&&a===o.queryContext)return o.result}let n=null;return n=c0(n,this._im,e,t,r,s,a),P(n)&&(n=c0(n,this._ground,e,t,r,s,a)),a==="scene"&&(n=c0(n,this._scene,e,t,r,s,a)),this.elevationCacheEnabled&&(this.lastElevationQuery={x:e,y:t,z:r,spatialReference:s,queryContext:a,result:n}),n}queryElevation(e,t,r,s,a,n=null,o=0){const l=Uf();return this._elevationQuery.queryElevation(e,t,n,o).then(c=>{a==="scene"&&(c=c0(c,this._scene,e,t,r,s,a)),l.resolve(c)}).catch(c=>{yo(c)?l.reject(c):l.resolve(this.getElevation(e,t,r,s,a))}),l.promise}register(e,t){this._handles.set(t,t.on("elevation-change",r=>this.emit("elevation-change",r))),this._providersFromContext(e).push(t)}unregister(e){var t;this._handles.has(e)&&((t=this._handles.get(e))==null||t.remove(),this._handles.delete(e));for(const r of[this._im,this._ground,this._scene]){const s=r.indexOf(e);s>-1&&r.splice(s,1)}}_providersFromContext(e){switch(e){case"ground":return this._ground;case"im":return this._im;case"scene":return this._scene}}};function c0(i,e,t,r,s,a,n){for(const o of e){const l=o.getElevation(t,r,s,a,n);g(l)&&(i=g(i)?Math.max(l,i):l)}return i}d([v({constructOnly:!0})],pg.prototype,"view",void 0),d([v()],pg.prototype,"spatialReference",null),pg=d([Y("esri.views.3d.support.CombinedElevationProvider")],pg);let mg=class Lw{static isValidProfile(e){return e in Lw.profiles}static getDefaultProfile(){return vi("esri-iPhone")?"low":"medium"}static apply(e,t){const r=Lw.profiles[e];t.graphics3D.maxTotalNumberOfFeatures=r.graphics3D.maxTotalNumberOfFeatures,t.graphics3D.maxTotalNumberOfPrimitives=r.graphics3D.maxTotalNumberOfPrimitives,t.graphics3D.polygonLodFactor=r.graphics3D.polygonLodFactor,t.graphics3D.polylineLodFactor=r.graphics3D.polylineLodFactor,t.graphics3D.snapshotAvailable=r.graphics3D.snapshotAvailable,t.graphics3D.skipHighSymbolLods=r.graphics3D.skipHighSymbolLods;const s=t.sceneService.object,a=r.sceneService.object;s.lodFactor=a.lodFactor,s.lodCrossfadeinDuration=a.lodCrossfadeinDuration,s.lodCrossfadeoutDuration=a.lodCrossfadeoutDuration,s.lodCrossfadeUncoveredDuration=a.lodCrossfadeUncoveredDuration,t.sceneService.point.lodFactor=r.sceneService.point.lodFactor,t.sceneService.integratedMesh.lodFactor=r.sceneService.integratedMesh.lodFactor,t.sceneService.pointCloud.lodFactor=r.sceneService.pointCloud.lodFactor,t.sceneService.uncompressedTextureDownsamplingEnabled=r.sceneService.uncompressedTextureDownsamplingEnabled,t.tiledSurface.lodBias=r.tiledSurface.lodBias,t.tiledSurface.angledSplitBias=r.tiledSurface.angledSplitBias,t.tiledSurface.reduceTileLevelDifferences=r.tiledSurface.reduceTileLevelDifferences,t.tiledSurface.textureFadeDuration=r.tiledSurface.textureFadeDuration,t.heatmap.pixelRatio=r.heatmap.pixelRatio,t.heatmap.maxTotalNumberOfFeatures=r.heatmap.maxTotalNumberOfFeatures,t.fadeDuration=r.fadeDuration,t.antialiasingEnabled=r.antialiasingEnabled,t.physicallyBasedRenderingEnabled=r.physicalBasedRenderingEnabled,t.highQualityTransparency=r.highQualityTransparency,t.memoryLimit=r.memoryLimit,t.additionalCacheMemory=r.additionalCacheMemory,t.frameRate=r.frameRate,t.maximumPixelRatio=r.maximumPixelRatio}};function QR(){const i=!!vi("esri-mobile"),e=!!vi("ios"),t=Je(400);return{low:{graphics3D:{maxTotalNumberOfFeatures:25e3,maxTotalNumberOfPrimitives:85e4,polygonLodFactor:.5,polylineLodFactor:1,snapshotAvailable:!1,skipHighSymbolLods:!0},heatmap:{pixelRatio:.125,maxTotalNumberOfFeatures:25e3},sceneService:{object:{lodFactor:.2,lodCrossfadeinDuration:Je(0),lodCrossfadeoutDuration:Je(0),lodCrossfadeUncoveredDuration:Je(0)},point:{lodFactor:1},integratedMesh:{lodFactor:.6},pointCloud:{lodFactor:.5},uncompressedTextureDownsamplingEnabled:!0},tiledSurface:{lodBias:-1,angledSplitBias:.5,reduceTileLevelDifferences:!1,textureFadeDuration:Je(0)},fadeDuration:Je(0),antialiasingEnabled:!1,physicalBasedRenderingEnabled:!1,highQualityTransparency:!1,memoryLimit:200,additionalCacheMemory:0,frameRate:0,maximumPixelRatio:1},medium:{graphics3D:{maxTotalNumberOfFeatures:5e4,maxTotalNumberOfPrimitives:17e5,polygonLodFactor:i?.8:1,polylineLodFactor:i?1.2:1.5,snapshotAvailable:!e,skipHighSymbolLods:!1},heatmap:{pixelRatio:.25,maxTotalNumberOfFeatures:5e4},sceneService:{object:{lodFactor:1,lodCrossfadeinDuration:Je(0),lodCrossfadeoutDuration:Je(0),lodCrossfadeUncoveredDuration:t},point:{lodFactor:1},integratedMesh:{lodFactor:1},pointCloud:{lodFactor:1},uncompressedTextureDownsamplingEnabled:i},tiledSurface:{lodBias:0,angledSplitBias:1,reduceTileLevelDifferences:!vi("disable-feature:reduce-map-tile-levels"),textureFadeDuration:t},fadeDuration:t,antialiasingEnabled:!0,physicalBasedRenderingEnabled:!0,highQualityTransparency:!0,memoryLimit:i?600:750,additionalCacheMemory:i?0:150,frameRate:0,maximumPixelRatio:1},high:{graphics3D:{maxTotalNumberOfFeatures:5e4,maxTotalNumberOfPrimitives:17e5,polygonLodFactor:i?1.2:2,polylineLodFactor:i?1.2:2,snapshotAvailable:!e,skipHighSymbolLods:!1},heatmap:{pixelRatio:.5,maxTotalNumberOfFeatures:5e4},sceneService:{object:{lodFactor:1,lodCrossfadeinDuration:Je(0),lodCrossfadeoutDuration:Je(0),lodCrossfadeUncoveredDuration:t},point:{lodFactor:1},integratedMesh:{lodFactor:1},pointCloud:{lodFactor:1},uncompressedTextureDownsamplingEnabled:!1},tiledSurface:{lodBias:0,angledSplitBias:1,reduceTileLevelDifferences:!vi("disable-feature:reduce-map-tile-levels"),textureFadeDuration:t},fadeDuration:t,antialiasingEnabled:!0,physicalBasedRenderingEnabled:!0,highQualityTransparency:!0,memoryLimit:i?900:1500,additionalCacheMemory:0,frameRate:0,maximumPixelRatio:i?1:1/0}}}mg.test={reset(){const i=QR();for(const e in i)mg.profiles[e]=i[e]}},function(i){i.profiles=QR()}(mg||(mg={}));const W0=mg,ZR=new ui([0,255,255]),YR=new ui([0,0,0]),KR=1,JR=.25,eE=.4,tE=.2;let Vo=class extends Ie{constructor(){super(...arguments),this.color=ZR.clone(),this.haloColor=null,this.haloOpacity=KR,this.fillOpacity=JR,this.shadowOpacity=eE,this.shadowColor=YR.clone(),this.shadowDifference=tE}static toEngineOptions(e){const t=ui.toUnitRGBA(e.color??ZR),r=g(e.haloColor)?ui.toUnitRGBA(e.haloColor):t,s=ui.toUnitRGBA(e.shadowColor??YR),a=e.haloOpacity??KR,n=e.fillOpacity??JR,o=e.shadowOpacity??eE,l=e.shadowDifference??tE;return{color:lf(t[0],t[1],t[2],t[3]),haloColor:lf(r[0],r[1],r[2],r[3]),haloOpacity:a,haloOpacityOccluded:.25*a,fillOpacity:n,fillOpacityOccluded:.25*n,shadowOpacity:o,shadowColor:hi(s[0],s[1],s[2],s[3]),occludedShadowOpacity:o*(1-l)}}};d([v({type:ui})],Vo.prototype,"color",void 0),d([v({type:ui})],Vo.prototype,"haloColor",void 0),d([v()],Vo.prototype,"haloOpacity",void 0),d([v()],Vo.prototype,"fillOpacity",void 0),d([v()],Vo.prototype,"shadowOpacity",void 0),d([v({type:ui})],Vo.prototype,"shadowColor",void 0),d([v()],Vo.prototype,"shadowDifference",void 0),Vo=d([Y("esri.views.3d.support.HighlightOptions")],Vo);const $w=Vo;let mZ=class{constructor(e,t){this.spatialReference=t,this.unitInMeters=Hd(this.spatialReference,Et(this.spatialReference).metersPerDegree),this._geometryServiceURLPromise=W6(e&&e.get("portalItem")).catch(()=>{throw new bt("mapcoordshelper:missing-geometry-service","Must specify geometryService in esri/config")})}async toGeographic(e){const t=await this._geometryServiceURLPromise;let r,s=!0;Array.isArray(e[0])&&typeof e[0]!="number"?r=e:(r=[e],s=!1);const a=r.map(l=>l instanceof Ht?l:new Ht(l,this.spatialReference)),n=new X6({geometries:a,outSpatialReference:li.WGS84}),o=(await Q6(t,n)).map(l=>l.type==="point"?[l.x,l.y]:void 0).filter(l=>!!l);return s?o:o[0]}},eo=class extends Ie{constructor(){super(...arguments),this.minTotalNumberOfFeatures=2e3,this.maxTotalNumberOfFeatures=5e4,this.maxTotalNumberOfPrimitives=17e5,this.snapshotAvailable=!0,this.polygonLodFactor=1,this.polylineLodFactor=1,this.skipHighSymbolLods=!1}};d([v()],eo.prototype,"minTotalNumberOfFeatures",void 0),d([v()],eo.prototype,"maxTotalNumberOfFeatures",void 0),d([v()],eo.prototype,"maxTotalNumberOfPrimitives",void 0),d([v()],eo.prototype,"snapshotAvailable",void 0),d([v()],eo.prototype,"polygonLodFactor",void 0),d([v()],eo.prototype,"polylineLodFactor",void 0),d([v()],eo.prototype,"skipHighSymbolLods",void 0),eo=d([Y("esri.views.3d.support.QualitySettings.Graphics3DSettings")],eo);let cl=class extends Ie{constructor(){super(...arguments),this.lodFactor=1}};d([v()],cl.prototype,"lodFactor",void 0),cl=d([Y("esri.views.3d.support.QualitySettings.LoDFactorSettings")],cl);let Xy=class extends cl{constructor(){super(...arguments),this.lodCrossfadeinDuration=Je(0),this.lodCrossfadeoutDuration=Je(0),this.lodCrossfadeUncoveredDuration=Je(0)}};Xy=d([Y("esri.views.3d.support.QualitySettings.LoDFactor3DObjectSettings")],Xy);let Fl=class extends Ie{constructor(){super(...arguments),this.object=new Xy,this.point=new cl,this.integratedMesh=new cl,this.pointCloud=new cl,this.uncompressedTextureDownsamplingEnabled=!1}};d([v({type:Xy})],Fl.prototype,"object",void 0),d([v({type:cl})],Fl.prototype,"point",void 0),d([v({type:cl})],Fl.prototype,"integratedMesh",void 0),d([v({type:cl})],Fl.prototype,"pointCloud",void 0),d([v()],Fl.prototype,"uncompressedTextureDownsamplingEnabled",void 0),Fl=d([Y("esri.views.3d.support.QualitySettings.SceneServiceSettings")],Fl);let Bc=class extends Ie{constructor(){super(...arguments),this.lodBias=0,this.angledSplitBias=1,this.reduceTileLevelDifferences=!0,this.textureFadeDuration=Je(400)}};d([v()],Bc.prototype,"lodBias",void 0),d([v()],Bc.prototype,"angledSplitBias",void 0),d([v()],Bc.prototype,"reduceTileLevelDifferences",void 0),d([v()],Bc.prototype,"textureFadeDuration",void 0),Bc=d([Y("esri.views.3d.support.QualitySettings.TiledSurfaceSettings")],Bc);let bp=class extends Ie{constructor(){super(...arguments),this.pixelRatio=1,this.maxTotalNumberOfFeatures=5e4}};d([v()],bp.prototype,"pixelRatio",void 0),d([v()],bp.prototype,"maxTotalNumberOfFeatures",void 0),bp=d([Y("esri.views.3d.support.QualitySettings.HeatmapSettings")],bp);let Gs=class extends Ie{constructor(){super(...arguments),this.graphics3D=new eo,this.sceneService=new Fl,this.tiledSurface=new Bc,this.heatmap=new bp,this.fadeDuration=Je(400),this.antialiasingEnabled=!0,this.physicallyBasedRenderingEnabled=!1,this.highQualityTransparency=!0,this.memoryLimit=void 0,this.additionalCacheMemory=void 0,this.frameRate=void 0,this.maximumPixelRatio=1/0}};d([v({type:eo})],Gs.prototype,"graphics3D",void 0),d([v({type:Fl})],Gs.prototype,"sceneService",void 0),d([v({type:Bc})],Gs.prototype,"tiledSurface",void 0),d([v({type:bp})],Gs.prototype,"heatmap",void 0),d([v()],Gs.prototype,"fadeDuration",void 0),d([v()],Gs.prototype,"antialiasingEnabled",void 0),d([v()],Gs.prototype,"physicallyBasedRenderingEnabled",void 0),d([v()],Gs.prototype,"highQualityTransparency",void 0),d([v()],Gs.prototype,"memoryLimit",void 0),d([v()],Gs.prototype,"additionalCacheMemory",void 0),d([v()],Gs.prototype,"frameRate",void 0),d([v()],Gs.prototype,"maximumPixelRatio",void 0),Gs=d([Y("esri.views.3d.support.QualitySettings.QualitySettings")],Gs);const iE=Gs;function gZ(i){return BA(i)&&i.length>=3}function fZ(i){return(HA(i)||Array.isArray(i))&&i.length>=3}function _Z(i){return gZ(i)||fZ(i)}let yZ=class Nw{constructor(e,t,r,s){this.viewingMode=e,this.spatialReference=t,this.unitInMeters=r,this._coordinateSystem=s,this._tmpCoordinateSystem=$8(s)}set extent(e){e&&N8(this._coordinateSystem,e,this._coordinateSystem)}getAltitude(e){return k8(this._coordinateSystem,e)}setAltitude(e,t,r=e){return OM(this._coordinateSystem,r,t,e)}setAltitudeOfTransformation(e,t){j8(this._coordinateSystem,t,e,t)}worldUpAtPosition(e,t){return V8(this._coordinateSystem,e,t)}worldBasisAtPosition(e,t,r){return G8(this._coordinateSystem,e,t,r)}basisMatrixAtPosition(e,t){const r=this.worldBasisAtPosition(e,Kc.X,Ve.get()),s=this.worldBasisAtPosition(e,Kc.Y,Ve.get()),a=this.worldBasisAtPosition(e,Kc.Z,Ve.get());return KA(t,r[0],r[1],r[2],0,s[0],s[1],s[2],0,a[0],a[1],a[2],0,0,0,0,1),t}headingAtPosition(e,t){const r=this.worldUpAtPosition(e,Ve.get()),s=this.worldBasisAtPosition(e,Kc.Y,Ve.get()),a=g3(t,s,r);return ln(a)}intersectManifoldClosestSilhouette(e,t,r){return T1(this._coordinateSystem,t,this._tmpCoordinateSystem),H8(this._tmpCoordinateSystem,e,r),r}intersectManifold(e,t,r){T1(this._coordinateSystem,t,this._tmpCoordinateSystem);const s=Ve.get();return B8(this._tmpCoordinateSystem,e,s)?H(r,s):null}intersectInfiniteManifold(e,t,r){if(this.viewingMode===ve.Global)return this.intersectManifold(e,t,r);T1(this._coordinateSystem,t,this._tmpCoordinateSystem);const s=this._tmpCoordinateSystem.value,a=Ve.get();return kd(s.plane,e,a)?H(r,a):null}toRenderCoords(e,t,r){return Dy(e)?ts(e,t,this.spatialReference):Jr(e,t,r,this.spatialReference)}fromRenderCoords(e,t,r=null){return Dy(t)?(g(r)&&(t.spatialReference=r),t3(e,this.spatialReference,t)):_Z(t)?Jr(e,this.spatialReference,t,r)?t:null:ch(e,this.spatialReference,t)}static create(e,t){switch(e){case ve.Local:return new Nw(ve.Local,t,Hd(t),U8());case ve.Global:return new Nw(ve.Global,t,1,z8(t))}}static renderUnitScaleFactor(e,t){return rE(e)/rE(t)}};function rE(i){if(Iy(i,ve.Global))return 1;const e=RM(!1,i);return Hd(e)}var Jo;(function(i){i[i.ELEVATION=0]="ELEVATION",i[i.BASEMAP=1]="BASEMAP",i[i.I3S_INDEX=2]="I3S_INDEX",i[i.I3S_DATA=3]="I3S_DATA",i[i.SYMBOLOGY=4]="SYMBOLOGY"})(Jo||(Jo={}));const vZ=(()=>{const i=new Array;return i[Jo.ELEVATION]=10,i[Jo.BASEMAP]=10,i[Jo.I3S_INDEX]=10,i[Jo.I3S_DATA]=10,i[Jo.SYMBOLOGY]=5,i})(),bZ=30;function S$(i){return typeof i.getUsedMemory=="function"}function xZ(i){return new Bs({view:i})}const h0=1,Wb=1,wZ=.75,TZ=.6,sE=1.3;let Bs=class extends Ie{constructor(e){super(e),this._quality=1,this._memoryUsed=0,this._updating=!1,this.minQuality=.1,this._stableQuality=0,this._downscaleMemoryUsed=0,this._canFastRecover=!1,this._memoryPredicted=0,this._cacheStorage=new FN,this._warnMemoryUsage=null,this._numQualityChanges=0,this._maxMemory=500,this._additionalCacheMemory=100}destroy(){this._cacheStorage.destroy()}set maxMemory(e){e==null||e<=0||(this._stableQuality=0,this._canFastRecover=!1,this._maxMemory<e&&this._updateQuality(h0),this._maxMemory=e)}get maxMemory(){return this._maxMemory}set additionalCacheMemory(e){e!=null&&e>=0&&(this._additionalCacheMemory=e)}get additionalCacheMemory(){return this._additionalCacheMemory}get memoryFactor(){return this._quality}get updating(){return this._updating}get usedMemory(){return this._memoryUsed}newCache(e,t){return new zN(e,this._cacheStorage,t)}resetStableQuality(){this._stableQuality=0}disableMemCache(){this.additionalCacheMemory=-4096}update(){if(this._updateMemory(),this._memoryPredicted<=0&&!this._updating)return;let e=this._layersUpdating();if(this._memoryPredicted<TZ&&this._canFastRecover)this._downscaleMemoryUsed=0,this._stableQuality=0,this._canFastRecover=!1,this._updateQuality(h0);else if(e)(this._memoryPredicted>1.1*Wb||this._memoryUsed>Wb)&&(this._stableQuality>0?(this._downscaleMemoryUsed=0,this._updateQuality(this._stableQuality)):this._quality>this.minQuality&&this._downscaleMemoryUsed<this._memoryUsed&&(this._updateQuality(this._quality/sE),this._downscaleMemoryUsed=this._memoryUsed,this._canFastRecover=!1));else if(this._downscaleMemoryUsed=0,this._memoryUsed>Wb)this._stableQuality=0,this._canFastRecover=!1,e=this._updateQuality(this._quality/sE),this._downscaleMemoryUsed=this._memoryPredicted;else if(this._stableQuality!==this._quality)if(this._memoryUsed<wZ&&this._quality<h0){this._stableQuality=this._quality;const t=.05;e=this._updateQuality(this._quality+t)}else this._quality<1&&(this._canFastRecover=!0);this._updating=e}_updateQuality(e){return(e=Math.min(Math.max(e,this.minQuality),h0))!==this._quality&&(this._quality=e,++this._numQualityChanges,!0)}_layersUpdating(){return this.view.allLayerViews.some(e=>!!e.updating)}_updateMemory(){let e=0,t=0;this.view.basemapTerrain&&this.view.basemapTerrain.getUsedMemory&&(e+=this.view.basemapTerrain.getUsedMemory());const r=this.view._stage&&this.view._stage.renderView&&this.view._stage.renderer.edgeView;g(r)&&(e+=r.usedMemory),this.view.allLayerViews&&this.view.allLayerViews.forEach(o=>{if(S$(o)){const l=o.ignoresMemoryFactor()?this._quality:1;e+=o.getUsedMemory()*l,t+=o.getUnloadedMemory()*l}});const s=P(this._warnMemoryUsage)||Math.round(10*e)!==Math.round(10*this._warnMemoryUsage),a=1048576*this.maxMemory;if(e>a&&s){this._warnMemoryUsage=e;const o=c=>(c/1048576).toLocaleString(void 0,{maximumFractionDigits:1})+" MB",l=Math.round(100*this._quality);Pe.getLogger(this.declaredClass).warn(`Memory Limit exceeded! Limit: ${o(a)} Current: ${o(e)} Projected: ${o(e+t)} Quality: ${l}%`)}this._memoryUsed=e/a,this._memoryPredicted=(e+t)/a;const n=a-e;this._cacheStorage.maxSize=Math.max(0,n+1048576*this.additionalCacheMemory)}get test(){const e=this;return{cacheStorage:this._cacheStorage,resetQualityChanges:()=>{const t=e._numQualityChanges;return e._numQualityChanges=0,t}}}};d([v({constructOnly:!0})],Bs.prototype,"view",void 0),d([v()],Bs.prototype,"maxMemory",null),d([v()],Bs.prototype,"additionalCacheMemory",null),d([v()],Bs.prototype,"memoryFactor",null),d([v()],Bs.prototype,"updating",null),d([v()],Bs.prototype,"usedMemory",null),d([v()],Bs.prototype,"_quality",void 0),d([v()],Bs.prototype,"_memoryUsed",void 0),d([v()],Bs.prototype,"_updating",void 0),d([v()],Bs.prototype,"_stableQuality",void 0),d([v()],Bs.prototype,"_maxMemory",void 0),d([v()],Bs.prototype,"_additionalCacheMemory",void 0),Bs=d([Y("esri.views.3d.support.MemoryController")],Bs);let CZ=class{constructor(e){this.client=e,this._cancelled=!1,this.size=0,this.duration=0}},SZ=class{constructor(e){this.typeWorkerQuota=e,this.tasks=new Array,this.numWorkers=0,this.statistics=new PZ}},PZ=class{constructor(){this.requests=0,this.size=0,this.duration=0,this.speed=0}},OZ=class{constructor(e,t,r,s){this._workerFunc=e,this._callbackFunc=t,this._maxTotalNumWorkers=r,this._totalNumWorkers=0,this._clients=s.map(a=>new SZ(a))}destroy(){this._clients.length=0}hasQuota(e){const t=this._clients[e];return!!t&&(this._totalNumWorkers<this._maxTotalNumWorkers||t.numWorkers+t.tasks.length<t.typeWorkerQuota)}push(e){const t=this._clients[e.client];t&&(this._totalNumWorkers<this._maxTotalNumWorkers?(t.numWorkers++,this._totalNumWorkers++,this._workerFunc(e,(r,s)=>this._taskCallback(r,s))):t.tasks.push(e))}cancel(e){this._taskFinished(e),e._cancelled=!0}_taskFinished(e){const t=this._clients[e.client];this._totalNumWorkers--,t.numWorkers--,t.statistics.requests++,t.statistics.size+=e.size||0,t.statistics.duration+=e.duration||0,t.statistics.speed=t.statistics.duration>0?t.statistics.size/t.statistics.duration:0,dt(t.numWorkers>=0),this._next()}_next(){for(const e of this._clients)if(e&&e.numWorkers<e.typeWorkerQuota&&this._processQueue(e))return;for(const e of this._clients)if(e&&this._processQueue(e))return}_processQueue(e){for(;e.tasks.length>0;)if(this._workerFunc(e.tasks.shift(),(t,r)=>this._taskCallback(t,r)))return e.numWorkers++,this._totalNumWorkers++,!0;return!1}_taskCallback(e,t){e._cancelled||(this._callbackFunc(e,t),this._taskFinished(e))}getStatsForType(e){const t=this._clients[e];return t?{quota:t.typeWorkerQuota,workers:t.numWorkers,queueSize:t.tasks.length,requestStats:t.statistics}:null}get test(){const e=this;return{set workerFunc(t){e._workerFunc=t}}}},X0=class extends Ie{constructor(){super(...arguments),this._tasks=new Map,this._onLoadQueue=new Array,this._doneQueue=new Array,this.updating=!1}setup(e,t,r){this._loadQueue=new OZ((s,a)=>this._startLoading(s,a),(s,a)=>this._doneLoadingCB(s,a),e,t),r&&(this._frameTask=r.registerTask(Zi.STREAM_DATA_LOADER,this))}destroy(){this._frameTask=fo(this._frameTask),this._tasks.forEach(e=>Th(e.abortController)),this._loadQueue=Te(this._loadQueue),this._onLoadQueue=null,this._doneQueue=null,this._tasks=null}hasDownloadSlots(e){return this._loadQueue.hasQuota(e)}request(e,t,r,s={}){const a=Uf();a.__signal=g(s)?s.signal:null;const n=this._createOrUpdateTask(e,t,r,s,a);return jg(s,()=>this._cancelRequest(n,a)),a.promise}_createTask(e,t,r,s,a,n){const o=new AZ(e,t,r,s,a);return this._updateTask(o,n),this._tasks.set(a,o),this._tasks.size===1&&this._set("updating",!0),this._loadQueue.push(o),o}_cancelRequest(e,t){var r;dy(e.resolvers,t),t.reject(ea()),e.resolvers.length===0&&(e.status===yn.DOWNLOADING&&(e.status=yn.CANCELLED,this._loadQueue.cancel(e),(r=e.abortController)==null||r.abort(),e.request=null,e.abortController=null),e.status=yn.CANCELLED,this._tasks.delete(e.key),this._tasks.size===0&&this._set("updating",!1))}_updateTask(e,t){e.resolvers.push(t)}_createOrUpdateTask(e,t,r,s,a){const n=MZ(g(s)&&s.uid||e,t,r),o=this._tasks.get(n);return o?(this._updateTask(o,a),o):this._createTask(e,s,t,r,n,a)}_doneLoadingCB(e,t){this._loadQueue&&(dt(e.status===yn.DOWNLOADING),e.status=yn.DOWNLOADED,this._frameTask?this._doneQueue.push({task:e,err:t}):this._doneLoading(e,t))}get running(){return this._doneQueue.length>0||this._onLoadQueue.length>0}runTask(e){for(;!e.done&&this._onLoadQueue.length>0;){const t=this._onLoadQueue.shift();lr(t.task.abortController),t.task.abortController=null,t.callback(t.task),e.madeProgress()}for(;!e.done&&this._doneQueue.length>0;){const t=this._doneQueue.shift();t.task.status!==yn.DOWNLOADED&&(t.err=t.err||ea()),this._doneLoading(t.task,t.err),e.madeProgress()}}_doneLoading(e,t){if(t&&!yo(t)&&e.numRetries>0)return--e.numRetries,void this._loadQueue.push(e);let r=e.result instanceof HTMLImageElement?0:e.resolvers.length;for(const s of e.resolvers)if(t)yo(t)?s.reject(t):s.reject(new bt("stream-data-loader:request-error",`Failed to request resource at '${e.url}'. ${t}`,{url:e.url,error:t}));else{--r;const a=r<=0?e.result:Gl(e.result);s.resolve(a)}this._tasks.delete(e.key),this._tasks.size===0&&this._set("updating",!1)}_startLoading(e,t){if(e.status===yn.CANCELLED)return!1;let r,s;switch(e.startTime=performance.now(),e.status=yn.DOWNLOADING,e.docType){case"binary":s="array-buffer",r=0;break;case"image":s="image";break;case"image+type":s="array-buffer";break;default:s="json"}e.abortController=new AbortController;const a=e.abortController.signal;e.request=h1(e.url,{...e.options,responseType:s,timeout:r,signal:a});let n=()=>{};const o=c=>{e.duration=performance.now()-e.startTime,e.size=c instanceof ArrayBuffer?c.byteLength:e.size||0,e.result=c,this._frameTask?this._onLoadQueue.push({callback:t,task:e}):(e.abortController=null,t(e))},l=c=>{e.status===yn.DOWNLOADING&&t(e,c),n()};return e.docType!=="image+type"?(e.request.then(c=>o(c.data),l),!0):(e.request.then(c=>{const h=c.data,u=EZ(h);if(s="image",e.size=h.byteLength,u==="unknown")return e.request=h1(e.url,{responseType:s,timeout:r,signal:a}),void e.request.then(f=>o(f.data),l);const p=new Blob([h],{type:u}),m=window.URL.createObjectURL(p);n=()=>window.URL.revokeObjectURL(m),e.request=h1(m,{responseType:s,timeout:r,signal:a}),e.request.then(f=>o(new kv(f.data,u,n)),l)},l),!0)}get test(){return{loadQueue:this._loadQueue}}};d([v({readOnly:!0})],X0.prototype,"updating",void 0),X0=d([Y("esri.views.3d.support.StreamDataLoader")],X0);const RZ={numRetries:0};function EZ(i){if(i.byteLength<2)return"unknown";const e=new Uint8Array(i,0,i.byteLength);return e[0]===137&&e[1]===80?"image/png":e[0]===71&&e[1]===73?"image/gif":e[0]===66&&e[1]===77?"image/bmp":e[0]===255&&e[1]===216?"image/jpeg":"unknown"}let kv=class{constructor(e,t,r){this.image=e,this.type=t,this.release=r}get isOpaque(){return this.type==="image/jpeg"}},AZ=class extends CZ{constructor(e,t,r,s,a){super(s),this.url=e,this.options=t,this.docType=r,this.key=a,this.result=null,this.status=yn.QUEUED,this.request=null,this.abortController=null,this.resolvers=new Array,this.startTime=0,this.numRetries=RZ.numRetries}};function MZ(i,e,t){return`${i}:${e}:${t}`}var yn;(function(i){i[i.QUEUED=1]="QUEUED",i[i.DOWNLOADING=2]="DOWNLOADING",i[i.DOWNLOADED=3]="DOWNLOADED",i[i.CANCELLED=4]="CANCELLED"})(yn||(yn={}));let Q0=class extends Ie{constructor(){super(...arguments),this.updating=!1}};function DZ(i){return new Go({view:i})}d([v({readOnly:!0})],Q0.prototype,"updating",void 0),Q0=d([Y("esri.views.3d.support.ResourceControllerMain")],Q0);let Go=class extends Q0{constructor(){super(...arguments),this._immediateTask=xx,this._normalTask=xx,this._frameTask=null}get immediate(){return this._immediateTask}get normal(){return this._normalTask}initialize(){this._scheduler=UN(),this._memoryController=xZ(this.view),this._streamDataLoader=new X0,this._streamDataLoader.setup(bZ,vZ,this._scheduler),this.addHandles([te(()=>{var e;return(e=this.view.state)==null?void 0:e.mode},e=>{e!=null&&(this._scheduler.state=e)},Bt),te(()=>this.view.stationary,()=>this._stationaryChangedHandler())]),this._frameTask=uT({update:e=>this._frame(e)}),this._immediateTask=this._scheduler.registerTask(Zi.RESOURCE_CONTROLLER_IMMEDIATE),this._normalTask=this._scheduler.registerTask(Zi.RESOURCE_CONTROLLER)}destroy(){this._immediateTask.remove(),this._normalTask.remove(),this._frameTask=fo(this._frameTask),this._streamDataLoader=Te(this._streamDataLoader),this._memoryController=Te(this._memoryController),this._scheduler=Te(this._scheduler)}get updating(){var e,t,r;return!!((e=this._memoryController)!=null&&e.updating||(t=this._streamDataLoader)!=null&&t.updating||(r=this._immediateTask)!=null&&r.updating)}get scheduler(){return this._scheduler}get memoryController(){return this._memoryController}createStreamDataRequester(e){const t=this._streamDataLoader;return{request:(r,s,a)=>t.request(r,s,e,a),get busy(){return!t.hasDownloadSlots(e)}}}_frame(e){this.view.suspended||this.view.stateManager&&(this.view.stateManager.step(aT(e.deltaTime)),!this._scheduler)||(this._scheduler.updateBudget(e)?(this._memoryController.update(),this._scheduler.frame()):this._memoryController.updating&&this._memoryController.update())}_stationaryChangedHandler(){this.memoryController.resetStableQuality()}get test(){return{getQueueStats:e=>this._streamDataLoader.test.loadQueue.getStatsForType(e)}}};d([v({constructOnly:!0})],Go.prototype,"view",void 0),d([v()],Go.prototype,"_scheduler",void 0),d([v()],Go.prototype,"_memoryController",void 0),d([v()],Go.prototype,"_streamDataLoader",void 0),d([v()],Go.prototype,"_immediateTask",void 0),d([v()],Go.prototype,"_normalTask",void 0),d([v({readOnly:!0})],Go.prototype,"updating",null),Go=d([Y("esri.views.3d.support.ResourceControllerImpl")],Go);function IZ(i){return"performanceInfo"in i}const Vu=T(),LZ=T(),Ol=T(),Rl=T();function $Z(i,e,t=0){const r=i.extent;if(P(r))return!1;if(t===0)return $A(r,e);const s=Math.min(r[2]-r[0],r[3]-r[1]);return VN(r,e,t*s)}function d0(i,e,t,r){H(Vu,t),Vu[r]=e[r];const s=Q(Vu,Vu,e),a=Q(LZ,i,e),n=J(a,s),o=J(s,s);let l;l=n<=0?e:o<=n?t:X(Vu,e,B(s,s,n/o));const c=Q(Vu,i,l);return Math.PI/2-Math.atan(c[2]/Math.sqrt(c[0]*c[0]+c[1]*c[1]))}function NZ(i,e,t){const r=i.extent;if(P(r))return 0;Ol[0]=r[0],Ol[1]=r[1],Ol[2]=t,Rl[0]=r[2],Rl[1]=r[3],Rl[2]=t;let s=1/0,a=1/0;return e[0]<Ol[0]?s=d0(e,Ol,Rl,0):e[0]>Rl[0]&&(s=d0(e,Rl,Ol,0)),e[1]<Ol[1]?a=d0(e,Ol,Rl,1):e[1]>Rl[1]&&(a=d0(e,Rl,Ol,1)),Math.min(s,a)}function FZ(i,e,t){if(P(i))return JT();if(i.spatialReference.isGeographic&&!Pd(i.spatialReference))return new bt("tilingscheme:local-unsupported-spatial-reference","The tiling scheme spatial reference is not supported in local scenes");const r=Ra.checkUnsupported(i);if(g(r))return r;if(P(t))return new bt("tilingscheme:extent-not-exist","The layer does not provide a layer extent.");const s=zZ(i,t);if(s)return s;const a=i.spatialReference;return g(e)&&!(a.equals(e)||e.isWGS84&&a.isWebMercator)?new bt("tilingscheme:spatial-reference-mismatch","The tiling scheme does not match the spatial reference of the local scene"):null}function zZ(i,e){const t=i.lods,r=t[0].resolution*2**t[0].level,s=[r*i.size[0],r*i.size[1]],a=[i.origin.x,i.origin.y],n=a3(e),o=yt();Ra.computeRowColExtent(n,s,a,o);const l=(o[2]-o[0])*(o[3]-o[1]);if(l>dp){const c=t[0].scale*2**t[0].level;let h=Math.max((n[3]-n[1])/i.size[1],(n[2]-n[0])/i.size[0])*c/r;const u=Math.floor(Math.log(h)/Math.log(10));return h=Math.ceil(h/10**u)*10**u,new bt("tilingscheme:too-many-root-tiles","Scale of level 0 of the tiling scheme (1:"+Math.floor(c).toLocaleString()+") is too large for the layer's extent. Suggested scale: 1:"+h.toLocaleString()+".",{level0Scale:c,suggestedLevel0Scale:h,requiredNumRootTiles:l,allowedNumRootTiles:dp})}return null}const UZ=Object.freeze(Object.defineProperty({__proto__:null,checkIfTileInfoSupportedForViewSR:FZ,isInsideExtent:$Z,tiltToExtentEdge:NZ},Symbol.toStringTag,{value:"Module"}));function VZ(){return!0}function GZ(){return 0}function BZ(i,e){if(P(i))return JT();const t=i.lods.length-1,r=i.spatialReference,s=Pd(r)||Ff(r)||zf(r);if(r.isWebMercator){if(!Ra.makeWebMercatorAuxiliarySphere(t).compatibleWith(i))return new bt("tilingscheme:incompatible-global-web-mercator","The tiling scheme is not compatible with the ArcGIS Online Web Mercator tiling scheme")}else{if(!s)return new bt("tilingscheme:global-unsupported-spatial-reference","The tiling scheme spatial reference is not supported in global scenes");if(!Ra.makeGCSWithTileSize(i.spatialReference,i.size[0],t).compatibleWith(i))return i.spatialReference.isWGS84?new bt("tilingscheme:incompatible-global-wgs84","The tiling scheme is not compatible with the ArcGIS Online WGS84 tiling scheme"):new bt("tilingscheme:incompatible-global","The tiling scheme is not compatible with the ArcGIS Online tiling scheme")}return g(e)&&!i.spatialReference.equals(e)?new bt("tilingscheme:spatial-reference-mismatch","The tiling scheme does not match the spatial reference of the global scene"):void 0}const HZ=Object.freeze(Object.defineProperty({__proto__:null,checkIfTileInfoSupportedForViewSR:BZ,isInsideExtent:VZ,tiltToExtentEdge:GZ},Symbol.toStringTag,{value:"Module"})),kZ={[ve.Global]:HZ,[ve.Local]:UZ};function Xo(i,e){i||console.warn("Terrain: "+e)}let ur=!1,Qy=!1;function jZ(i){Qy=i,ur=ur||i}function qZ(i){ur=i}function Z(i,e){var t;if(ur&&!i){const r=(t=new Error().stack)==null?void 0:t.slice(5);throw console.warn("Terrain internal: "+(e||"")+" at "+r),new Error("Assertion failed"+(e?": "+e:""))}}function Fw(i){return jv(i)?{fullExtent:i.fullExtent,minScale:i.layer.minScale,maxScale:i.layer.maxScale,tilemapCache:null}:i.layer}function Zy(i){return(i==null?void 0:i.type)==="imagery-tile"||(i==null?void 0:i.type)==="wcs"}function jv(i){return(i==null?void 0:i.type)==="imagery-tile-3d"}function oS(i){return(i==null?void 0:i.type)==="tile-3d"}function Ef(i){return(i==null?void 0:i.type)==="vector-tile-3d"}function P$(i){return(i==null?void 0:i.type)==="wmts-3d"}function zw(i){return(i==null?void 0:i.type)==="elevation-3d"}function Gm(i){return(i==null?void 0:i.type)==="group"}function Yy(i){return i&&(oS(i)||P$(i)||jv(i)||Ef(i))}function Uw(i){return i&&(oS(i)||jv(i)||Ef(i)||P$(i))}function Af(i){return Uw(i)||zw(i)}function WZ(i){var t;const e=(t=i==null?void 0:i.sourceLayerInfo)==null?void 0:t.data;return g(e)&&"type"in e&&e.type==="raster-tile"}function XZ(i){var t;const e=(t=i==null?void 0:i.sourceLayerInfo)==null?void 0:t.data;return g(e)&&"type"in e&&e.type==="vector-tile"}function QZ(i){var t;const e=(t=i==null?void 0:i.sourceLayerInfo)==null?void 0:t.data;return g(e)&&"type"in e&&e.type==="tile-texture"}function ZZ(i){var t;const e=(t=i==null?void 0:i.sourceLayerInfo)==null?void 0:t.data;return e instanceof HTMLImageElement||e instanceof kv||e instanceof HTMLCanvasElement||e instanceof ImageData}function Mp(i){return g(i)&&"release"in i&&i.release(),null}function aE(i){return i.fetchTile&&i.hasOverriddenFetchTile!==!1}function lS(i,e,t,r){return kZ[r].checkIfTileInfoSupportedForViewSR(i,t,e)}function qv(i,e,t){let r=null,s=null;if((i==null?void 0:i.type)==="wmts"){const a=YZ(i,e,t);r=a.tileInfo,s=a.fullExtent}else{s=Zy(i)?i.getCompatibleFullExtent(e):i.fullExtent;const a=t===ve.Local;if(Zy(i))r=i.getCompatibleTileInfo(e,s,a);else if((i==null?void 0:i.type)==="vector-tile"){const n=a&&!KZ(e)||JZ.force512VTL,o=i.tileInfo.spatialReference.isGeographic;r=n?i.tileInfo:i.tileInfo.getOrCreateCompatible(256,o?1:2)}else r=i.tileInfo}return g(r)&&g(s)&&lS(r,s,e,t)==null?{tileInfo:r,fullExtent:s}:null}function YZ(i,e,t){const r=GN(i);if(g(r)){if(!Od.isCollection(r))return{tileInfo:r.tileInfo,fullExtent:r.fullExtent};{const s=r.find(a=>lS(a.tileInfo,a.fullExtent,e,t)==null);if(s)return{tileInfo:s.tileInfo,fullExtent:s.fullExtent}}}return{tileInfo:null,fullExtent:null}}function KZ(i){return i.isWGS84||i.isWebMercator||BN(i)||!ny(i)}const JZ={force512VTL:!1};function nE(i){return"["+i[0]+","+i[1]+","+i[2]+"]"}function El(i){return"("+i[0]+","+i[1]+","+i[2]+")"}function Pn(i,e,t=iY){return Math.abs(i-e)<t}function Vw(i){return i===ze.NORTH_EAST?ze.SOUTH_WEST:i===ze.NORTH_WEST?ze.SOUTH_EAST:i===ze.SOUTH_WEST?ze.NORTH_EAST:ze.NORTH_WEST}function Ky(i){return i===ze.NORTH?ze.SOUTH:i===ze.EAST?ze.WEST:i===ze.SOUTH?ze.NORTH:ze.EAST}function eY(i){return i===ze.NORTH_WEST||i===ze.SOUTH_WEST}function tY(i){return i===ze.NORTH_WEST||i===ze.NORTH_EAST}function oE(i){return i===ze.NORTH_WEST||i===ze.WEST||i===ze.SOUTH_WEST}function lE(i){return i===ze.NORTH_EAST||i===ze.EAST||i===ze.SOUTH_EAST}function cE(i){return i===ze.SOUTH_EAST||i===ze.SOUTH||i===ze.SOUTH_WEST}function hE(i){return i===ze.NORTH_EAST||i===ze.NORTH||i===ze.NORTH_WEST}const al=[ze.NORTH,ze.EAST,ze.SOUTH,ze.WEST],Jy=[ze.NORTH_EAST,ze.SOUTH_EAST,ze.SOUTH_WEST,ze.NORTH_WEST],iY=1e-5;let rY=class{constructor(e,t){if(this.layer=null,this.memory=0,this.displayedNumberOfFeatures=0,this.maximumNumberOfFeatures=null,this.totalNumberOfFeatures=null,this.layer=e.layer,this.memory=Af(e)?t.basemapTerrain.getUsedMemoryForLayerView(e):e.getUsedMemory(),IZ(e)){const r=e.performanceInfo;this.displayedNumberOfFeatures=r.displayedNumberOfFeatures,this.maximumNumberOfFeatures=r.maximumNumberOfFeatures,this.totalNumberOfFeatures=r.totalNumberOfFeatures}}},sY=class{constructor(e){var r;if(this.totalMemory=0,this.usedMemory=0,this.quality=1,this.load=0,this.terrainMemory=0,this.edgesMemory=0,this.layerPerformanceInfos=new Array,g(e.resourceController)){const s=e.resourceController.memoryController;this.totalMemory=(s.maxMemory??0)*HN.MEGABYTES,this.usedMemory=Math.round(s.usedMemory*this.totalMemory),this.quality=s.memoryFactor,this.load=e.resourceController.scheduler.load}this.terrainMemory=((r=e.basemapTerrain)==null?void 0:r.getUsedMemory())??0;const t=e._stage&&e._stage.renderView&&e._stage.renderer.edgeView;this.edgesMemory=g(t)?t.usedMemory:0,e.allLayerViews.items.forEach(s=>{(S$(s)||Af(s))&&this.layerPerformanceInfos.push(new rY(s,e))}),this.layerPerformanceInfos.sort((s,a)=>a.memory-s.memory)}},aY=class{constructor(e){this._gltfLoading=new Map,this._wosrLoading=new Map,this._gltfMemCache=e("gltf-resources",()=>{}),this._wosrMemCache=e("wosr-resources",()=>{})}destroy(){this._gltfLoading.forEach(e=>e.abortController.abort()),this._wosrLoading.forEach(e=>e.abortController.abort()),this._gltfMemCache.destroy(),this._wosrMemCache.destroy()}loadGLTF(e,t,r){const s=r?`gltfPBR:${e}`:`gltf:${e}`,a=this._gltfMemCache.get(s);return g(a)?Promise.resolve(a):this._loadOnce(this._gltfLoading,this._gltfMemCache,s,n=>Z6(new Y6(n.streamDataRequester),e,n,r),t)}loadWOSR(e,t){const r=`wosr:${e}:${t.disableTextures}`,s=this._wosrMemCache.get(r);return g(s)?Promise.resolve(s):this._loadOnce(this._wosrLoading,this._wosrMemCache,r,a=>DF(e,a),t)}async _loadOnce(e,t,r,s,a){lr(a);const n=jg(a,()=>this._abortLoad(e,r));let o=e.get(r);if(o)o.refCount++;else{const l=new AbortController;o={refCount:1,abortController:l,promise:s({...a,signal:l.signal})},e.set(r,o)}try{const l=await o.promise;return t.put(r,l,l.size),e.delete(r),lr(a),l}finally{fo(n)}}_abortLoad(e,t){const r=e.get(t);g(r)&&--r.refCount>0||(e.delete(t),g(r)&&r.abortController.abort())}},nY=class extends kN{constructor(e,t,r,s){super(t,s),this._streamDataRequester=e,this._parameters=r}async fromUrl(e,t,r){lr(r);const s=g(r)?r.signal:null,a=this.makeUid(e,t);let n=this._textureRequests.get(a);if(!n){const o=new AbortController,l=this._streamDataRequester.request(e,"image",{uid:a,signal:o.signal});n={referenceCount:0,texture:null,textureAsync:null,abortController:o};const c=n;this._textureRequests.set(a,n),n.textureAsync=l.then(async h=>{const u=this._createTexture(e,h,t);return c.texture=u,c.abortController=null,this._stage.add(u),await this._stage.load(u),{uid:a,texture:u,release:()=>this._release(a)}},h=>{throw c.abortController=null,h})}n.referenceCount++;try{return await jN(n.textureAsync,s)}catch(o){throw this._release(a),o}}_createTexture(e,t,r){var a;const s={...this._parameters,powerOfTwoResizeMode:jT.PAD};if(n3(e)){if(r||t.width===0&&t.height===0){const n=t.width?t.height/t.width:1;r=r||64,n>1?(t.width=Math.round(r/n),t.height=r):(t.width=r,t.height=Math.round(r*n))}(a=this._stage.renderView)!=null&&a.renderingContext.driverTest.svgPremultipliesAlpha.result&&(s.preMultiplyAlpha=!1)}return s.width=t.width,s.height=t.height,new Bf(t,s)}},oY=class{constructor(e){this.textures=null,this.streamDataRequester=null,this._graphicsOwners=[],this._screenSizePerspectiveHandles=null,this.cimSymbolRasterizer=null,this._viewState=e.viewState,this._view=e.view,this._pointsOfInterest=e.pointsOfInterest,this.streamDataRequester=e.resourceController.createStreamDataRequester(Jo.SYMBOLOGY),this.objectResourceCache=new aY((r,s)=>e.resourceController.memoryController.newCache(r,s)),this.textures=new nY(this.streamDataRequester,e.view._stage,{preMultiplyAlpha:!0,wrap:{s:kt.CLAMP_TO_EDGE,t:kt.CLAMP_TO_EDGE}},e.resourceController.scheduler);const t=Et(this._view.spatialReference).radius;this.screenSizePerspectiveSettings=k3(e.viewingMode,t),this.screenSizePerspectiveSettingsLabels=IF(e.viewingMode,t)}destroy(){Te(this.textures),this.textures=null,this.streamDataRequester=null}addGraphicsOwner(e){if(!e)return wx();this._graphicsOwners.push(e);const t=te(()=>{var r;return(r=e.layer)==null?void 0:r.screenSizePerspectiveEnabled},()=>this._updateScreenSizePerspectiveEnabled());return this._updateScreenSizePerspectiveEnabled(),wx(()=>{t.remove(),dy(this._graphicsOwners,e),this._updateScreenSizePerspectiveEnabled()})}_updateScreenSizePerspectiveEnabled(){const e=this._graphicsOwners.some(t=>{var r;return((r=t.layer)==null?void 0:r.screenSizePerspectiveEnabled)===!0});if(e&&!this._screenSizePerspectiveHandles){this._screenSizePerspectiveHandles=new Vi;const t=()=>this._updateScreenSizePerspectiveSettings();this._screenSizePerspectiveHandles.add([te(()=>this._pointsOfInterest.centerOnSurfaceInfrequent.distance,t,Bt),this._viewState.events.on("camera-projection-changed",t)]),this._updateScreenSizePerspectiveSettings()}else e||(this._screenSizePerspectiveHandles=Te(this._screenSizePerspectiveHandles))}_updateScreenSizePerspectiveSettings(){const e=this._pointsOfInterest;u0.distance=e.centerOnSurfaceInfrequent.distance,u0.fovY=this._viewState.camera.fovY,this.screenSizePerspectiveSettings.update(u0),this.screenSizePerspectiveSettingsLabels.update(u0),this._view._stage.renderView.requestRender()}get test(){return{screenSizePerspectiveHandles:this._screenSizePerspectiveHandles}}};const u0={distance:0,fovY:0};let op=class{constructor(e,t,r=""){this.graphics=e,this._symbol=new qN({symbolLayers:[new WN({material:{color:t},outline:{color:[255,255,255],size:1},resource:{primitive:"circle"}}),new XN({text:r,halo:{color:"white",size:1/.75},material:{color:t},size:12})]})}show(e,t){if(P(t))return;this.hide();const r=new Ht({x:e[0],y:e[1],z:e[2],spatialReference:t});this._graphic=new nv({geometry:r,symbol:this._symbol}),this.graphics.add(this._graphic)}hide(){g(this._graphic)&&(this.graphics.remove(this._graphic),this._graphic=null)}},Qc=class extends Ie{constructor(e){super(e),this.handles=new Vi}destroy(){this.handles.destroy()}};d([v({constructOnly:!0})],Qc.prototype,"renderCoordsHelper",void 0),d([v({constructOnly:!0})],Qc.prototype,"surface",void 0),d([v({constructOnly:!0})],Qc.prototype,"state",void 0),Qc=d([Y("esri.views.3d.support.PointOfInterest")],Qc);const lY=Array;let Yn=class extends Qc{constructor(e){super(e),this._dirty=!1,this._propertiesPool=new hh({location:Ht,renderLocation:lY},this),this._estimatedSurfaceAltitude=0,this._pendingElevationQueryController=null,this.renderLocation=T(),this._tmpPoint=new Ht}initialize(){if(this.scheduler&&this.handles.add(this.scheduler.registerTask(this.task,this)),this.runTask(),this.map){const e=()=>this._setDirty();this.handles.add(ll(()=>{var t,r;return(r=(t=this.map)==null?void 0:t.ground)==null?void 0:r.layers},"change",e,{onListenerAdd:e,onListenerRemove:e}))}this._updateRenderLocation()}destroy(){this._cancelPendingRequest(),this._propertiesPool=Te(this._propertiesPool)}get _camera(){return this.state.contentCamera}get location(){const e=this._propertiesPool.get("location");return this.renderCoordsHelper.fromRenderCoords(this.renderLocation,e,this.state.spatialReference),e}get scale(){const e=this._camera,t=yi(e.eye,this.renderLocation),r={renderCoordsHelper:this.renderCoordsHelper,state:{camera:e}};return $d(r,t,0)}get updating(){return this._dirty||this._pendingElevationQueryController!=null}updateRenderLocation(){this._setDirty(),this._updateRenderLocation()}_setDirty(){this._dirty||(this._dirty=!0,this.notifyChange("updating"))}_cancelPendingRequest(){const e=this._pendingElevationQueryController;e&&(this._pendingElevationQueryController=null,e.abort(),this.notifyChange("updating"))}get running(){return!this._pendingElevationQueryController&&this._dirty}runTask(){if(this._cancelPendingRequest(),this._dirty=!1,this.notifyChange("updating"),!this.map||!this.map.ground)return this._updateSurfaceAltitude(0),na.YIELD;const e=this.state.spatialReference;this.renderCoordsHelper.fromRenderCoords(this._camera.eye,this._tmpPoint,e);const t=(this._tmpPoint.z??0)>cY&&this.renderCoordsHelper.viewingMode===ve.Global&&(e.isWGS84||e.isWebMercator);let r=new AbortController;return this.map.ground.queryElevation(this._tmpPoint,{signal:r.signal,cache:this.cache,minDemResolution:t?hY:0}).then(s=>this._updateSurfaceAltitude(s.geometry.z??0)).catch(s=>{yo(s)||this._updateSurfaceAltitude(0)}).catch(()=>{}).then(()=>{this._pendingElevationQueryController===r&&(this._pendingElevationQueryController=null,this.notifyChange("updating")),r=null}),this._pendingElevationQueryController=r,na.YIELD}_updateSurfaceAltitude(e){this._estimatedSurfaceAltitude!==e&&(this._estimatedSurfaceAltitude=e,this._updateRenderLocation())}_updateRenderLocation(){this.renderCoordsHelper.setAltitude(Xb,this._estimatedSurfaceAltitude,this._camera.eye),An(this._get("renderLocation"),Xb)||(this._set("renderLocation",H(this._propertiesPool.get("renderLocation"),Xb)),this.notifyChange("renderLocation"))}};d([v({constructOnly:!0})],Yn.prototype,"scheduler",void 0),d([v({constructOnly:!0})],Yn.prototype,"cache",void 0),d([v({constructOnly:!0})],Yn.prototype,"task",void 0),d([v({readOnly:!0})],Yn.prototype,"location",null),d([v({constructOnly:!0})],Yn.prototype,"map",void 0),d([v({readOnly:!0})],Yn.prototype,"renderLocation",void 0),d([v({readOnly:!0})],Yn.prototype,"scale",null),d([v({readOnly:!0})],Yn.prototype,"updating",null),Yn=d([Y("esri.views.3d.support.CameraOnSurface")],Yn);const Xb=T(),cY=1e5,hY=1e6,dY=Array;let vn=class extends Qc{constructor(e){super(e),this._propertiesPool=new hh({location:Ht,renderLocation:dY},this),this._currentSurfaceAltitude=0,this._latestSurfaceAltitude=0,this.distance=0,this.renderLocation=T(),this.updating=!1}initialize(){this._frameWorker=this.scheduler.registerTask(this.task,this),this.runTask()}destroy(){this._frameWorker=fo(this._frameWorker),this._propertiesPool=Te(this._propertiesPool)}get _camera(){return this.state.contentCamera}get location(){const e=this._propertiesPool.get("location");return this.renderCoordsHelper.fromRenderCoords(this.renderLocation,e,this.state.spatialReference),e}updateRenderLocation(){this.updating=!0,this._updateRenderLocation()}get estimatedSurfaceAltitude(){return this._latestSurfaceAltitude}get running(){return this.updating}runTask(){return this._latestSurfaceAltitude=this.estimateSurfaceAltitudeAtCenter(),this._updateRenderLocation(),this.updating=!1,na.YIELD}_updateRenderLocation(){const e=pY;let t=this._calculateSurfaceIntersection(this._currentSurfaceAltitude,e);const r=this._currentSurfaceAltitude!==this._latestSurfaceAltitude;!t&&r&&(t=this._calculateSurfaceIntersection(this._latestSurfaceAltitude,e),t&&(this._currentSurfaceAltitude=this._latestSurfaceAltitude));const s=mY;t&&this._latestSurfaceAltitudeChangesDistanceSignificantly(e,s)&&(H(e,s),this._currentSurfaceAltitude=this._latestSurfaceAltitude),t?this.distance=yi(this._camera.eye,e):(B(e,this._camera.viewForward,this._get("distance")),X(e,e,this._camera.eye)),An(this._get("renderLocation"),e)||this._set("renderLocation",H(this._propertiesPool.get("renderLocation"),e))}_calculateSurfaceIntersection(e,t){var s,a;const r=this._camera;if(!this.renderCoordsHelper.intersectManifold(r.ray,e,t))return!1;if(this.state.isGlobal){const n=Et(this.renderCoordsHelper.spatialReference).radius,o=n+e,l=sn(r.eye),c=l<o*o,h=yi(r.eye,t);if(c&&h>n/4){const u=o-Math.sqrt(l);return B(t,r.viewForward,u),X(t,t,r.eye),!0}}else{const n=(s=this.surface)!=null&&s.ready?this.surface.extent:null;g(n)&&hv(n,(a=this.surface)==null?void 0:a.spatialReference,Bm,this.renderCoordsHelper.spatialReference)&&(t[0]=ee(t[0],Bm[0],Bm[2]),t[1]=ee(t[1],Bm[1],Bm[3]))}return!0}_latestSurfaceAltitudeChangesDistanceSignificantly(e,t){if(this._latestSurfaceAltitude===this._currentSurfaceAltitude||e==null)return!1;if(this._calculateSurfaceIntersection(this._latestSurfaceAltitude,t)){if(Ot.TESTS_DISABLE_OPTIMIZATIONS)return!0;const r=this._camera.eye,s=yi(r,e),a=yi(r,t);if(Math.abs(a-s)/s>uY)return!0}return!1}};d([v({constructOnly:!0})],vn.prototype,"scheduler",void 0),d([v({constructOnly:!0})],vn.prototype,"task",void 0),d([v()],vn.prototype,"distance",void 0),d([v({constructOnly:!0})],vn.prototype,"estimateSurfaceAltitudeAtCenter",void 0),d([v({readOnly:!0})],vn.prototype,"location",null),d([v({readOnly:!0})],vn.prototype,"renderLocation",void 0),d([v()],vn.prototype,"updating",void 0),vn=d([Y("esri.views.3d.support.CenterOnSurface")],vn);const uY=.05,pY=T(),mY=T(),Bm=yt();let gY=class{constructor(e){this._handles=new Vi,this.events=new Ms,this._contentLayerViews=e.contentLayerViews,this._handles.add(this._contentLayerViews.on("change",t=>this._layerViewsChanged(t))),this._layerViewsChanged({added:this._contentLayerViews.toArray(),removed:[],moved:[],target:this._contentLayerViews})}destroy(){this._handles=Te(this._handles)}_layerViewsChanged(e){e.added.forEach(t=>{t.declaredClass==="esri.views.3d.layers.SceneLayerView3D"&&this._handles.add(t.on("visible-geometry-changed",()=>this._contentChanged()),t.uid)}),e.removed.forEach(t=>this._handles.remove(t.uid))}_contentChanged(){this.events.emit("request-update",fY)}};const fY={},_Y=Array;let Bo=class extends Qc{constructor(e){super(e),this._propertiesPool=new hh({location:Ht,renderLocation:_Y},this),this._dirty=!0,this.renderLocation=this._propertiesPool.get("renderLocation")}initialize(){this.handles.add([te(()=>this.centerOnSurface.renderLocation,()=>this.updateRenderLocation()),te(()=>this.state.contentCamera,()=>this.updateRenderLocation())]),this.scheduler&&this.handles.add(this.scheduler.registerTask(Zi.POINT_OF_INTEREST_FREQUENT,this))}destroy(){this._propertiesPool=Te(this._propertiesPool)}get updating(){return this._dirty||this.centerOnSurface.updating}get location(){const e=this._propertiesPool.get("location");return this.renderCoordsHelper.fromRenderCoords(this.renderLocation,e,this.state.spatialReference),e}get running(){return this._dirty}runTask(){const e=this._get("renderLocation"),t=this.centerOnSurface.renderLocation,r=this.renderCoordsHelper,s=this.state.contentCamera;this._dirty=!1,r.worldUpAtPosition(t,dE);const a=Math.max(0,(Math.acos(J(dE,s.viewForward))-.5*Math.PI)*(s.aboveGround?1:-1));if(Number.isNaN(a)){if(!e||!Ed(e,t)){const c=this._propertiesPool.get("renderLocation");H(c,t),this._set("renderLocation",c)}return na.YIELD}const n=1-ee(a/(.5*Math.PI),0,1),o=n*n*n;this._calculateScreenHorizontalEdgeOnSurface(uE);const l=this._propertiesPool.get("renderLocation");return Gr(l,t,uE,o),e&&Ed(e,l)||this._set("renderLocation",l),na.YIELD}_calculateScreenHorizontalEdgeOnSurface(e){const t=this.state.contentCamera,r=t.getRenderCenter(Zr());if(r[1]=t.aboveGround?t.padding[rt.BOTTOM]:t.fullHeight-t.padding[rt.TOP],this.estimateSurfaceIntersectionAtRenderPoint(r,e))return e;const s=this.renderCoordsHelper.getAltitude(this.centerOnSurface.renderLocation);if(t.unprojectFromRenderScreen(r,Hm)){Q(Hm,Hm,t.eye);const a=W(Hm,Hm);if(this.renderCoordsHelper.intersectManifold(xo(t.eye,a),s,e))return e}return this.renderCoordsHelper.setAltitude(e,s,t.eye)}updateRenderLocation(){this._dirty=!0}};d([v()],Bo.prototype,"_dirty",void 0),d([v({constructOnly:!0})],Bo.prototype,"scheduler",void 0),d([v({constructOnly:!0})],Bo.prototype,"centerOnSurface",void 0),d([v({constructOnly:!0})],Bo.prototype,"estimateSurfaceIntersectionAtRenderPoint",void 0),d([v({readOnly:!0})],Bo.prototype,"updating",null),d([v({readOnly:!0})],Bo.prototype,"location",null),d([v({readOnly:!0})],Bo.prototype,"renderLocation",void 0),Bo=d([Y("esri.views.3d.support.pointsOfInterest.Focus")],Bo);const dE=T(),Hm=T(),uE=T();let Il=class extends Ie{get surface(){var e;return(e=this.view.map)==null?void 0:e.ground}get surfaceView(){return this.view.basemapTerrain}get renderLocation(){if(!this.location)return null;const e=T();return this.view.renderCoordsHelper.toRenderCoords(this.location,e),e}constructor(e){super(e),this.location=null,this._updateController=null,this._handles=new Vi}initialize(){this.view.state.isLocal&&(this._handles.add([te(()=>{var e,t;return[(e=this.surfaceView)==null?void 0:e.spatialReference,(t=this.surfaceView)==null?void 0:t.extent]},()=>this._update()),ll(()=>{var e;return(e=this.surface)==null?void 0:e.layers},"change",()=>this._update())]),this._update())}destroy(){this._handles.destroy()}_update(){if(this._updateController&&(this._updateController.abort(),this._updateController=null),!this.surfaceView||P(this.surfaceView.extent)||P(this.surfaceView.spatialReference))return void this._set("location",null);const e=wT(this.surfaceView.extent),t=new Ht({x:e[0],y:e[1],z:0,spatialReference:this.surfaceView.spatialReference});this.surface&&this.surface.layers.length>0?(this._set("location",null),this._updateController=new AbortController,this.surface.queryElevation(t,{noDataValue:0,signal:this._updateController.signal,cache:this.cache}).then(r=>{this._updateController=null,this._set("location",r.geometry)}).catch(r=>{yo(r)||r&&r.name==="elevation-query:invalid-layer"||console.error("StableSurfaceCenter failed to update: ",r)})):this._set("location",t)}};d([v({constructOnly:!0})],Il.prototype,"view",void 0),d([v({constructOnly:!0})],Il.prototype,"cache",void 0),d([v()],Il.prototype,"surface",null),d([v()],Il.prototype,"surfaceView",null),d([v({readOnly:!0})],Il.prototype,"location",void 0),d([v({readOnly:!0})],Il.prototype,"renderLocation",null),Il=d([Y("esri.views.3d.terrain.StableSurfaceCenter")],Il);let Ll=class extends Ie{constructor(e){super(e),this._tileGeometryUpdateExtent=bo(),this._tileGeometryUpdateSpatialReference=null,this.events=new Ms,this.updating=!1}initialize(){this.addHandles([this.surface.on("elevation-change",e=>this._tileGeometryChanged(e)),this.scheduler.registerTask(Zi.SURFACE_GEOMETRY_UPDATES,this)])}get running(){return this.updating}runTask(){return this.updating?(this._tileGeometryUpdateSpatialReference&&this._centerIntersectsExtent(this._tileGeometryUpdateExtent,this._tileGeometryUpdateSpatialReference)&&this.events.emit("request-update",yY),bo(this._tileGeometryUpdateExtent),this._set("updating",!1),na.YIELD):na.YIELD}_tileGeometryChanged(e){this._tileGeometryUpdateSpatialReference=Si(e.spatialReference),eh(this._tileGeometryUpdateExtent,e.extent,this._tileGeometryUpdateExtent),this._set("updating",!0)}_furthestCenterOnSurface(){let e=this.centerOnSurfaces[0];for(let t=1;t<this.centerOnSurfaces.length;t++){const r=this.centerOnSurfaces[t];r.distance>e.distance&&(e=r)}return e}_centerIntersectsExtent(e,t){const r=this.state.contentCamera.eye,s=vY,a=this._furthestCenterOnSurface();return this.renderCoordsHelper.fromRenderCoords(r,Zh,t),this.renderCoordsHelper.fromRenderCoords(a.renderLocation,Yh,t),Zh[0]<Yh[0]?(s[0]=Zh[0],s[2]=Yh[0]):(s[0]=Yh[0],s[2]=Zh[0]),Zh[1]<Yh[1]?(s[1]=Zh[1],s[3]=Yh[1]):(s[1]=Yh[1],s[3]=Zh[1]),ov(s,e)}};d([v({constructOnly:!0})],Ll.prototype,"state",void 0),d([v({constructOnly:!0})],Ll.prototype,"centerOnSurfaces",void 0),d([v({constructOnly:!0})],Ll.prototype,"renderCoordsHelper",void 0),d([v({constructOnly:!0})],Ll.prototype,"scheduler",void 0),d([v({constructOnly:!0})],Ll.prototype,"surface",void 0),d([v({readOnly:!0})],Ll.prototype,"updating",void 0),Ll=d([Y("esri.views.3d.support.SurfaceGeometryUpdates")],Ll);const yY={},Zh=T(),Yh=T(),vY=bo();let js=class extends Ie{constructor(e){super(e),this._handles=new Vi,this._tmpRay=Aa(),this._centerRayDirty=!0,this._surfaceAltitudeAtCenter=0,this._surfaceAltitudeAtCenterDirty=!0,this._contentAltitudeAtCenter=0,this._contentAltitudeAtCenterDirty=!0,this._propertiesPool=new hh({renderPointOfView:bY},this),this.renderPointOfView=T(),this._pois=new Array,this._debugCenters=new Map}initialize(){var h;const{state:e,basemapTerrain:t,renderCoordsHelper:r,map:s}=this.view;this._surfaceIntersector=zn(e.viewingMode),e.isGlobal?this._surfaceIntersector.options.backfacesTerrain=!1:this._surfaceIntersector.options.backfacesTerrain=!0,this._surfaceIntersector.options.invisibleTerrain=!1,this._surfaceIntersector.options.store=Vr.MIN,this._contentIntersector=zn(e.viewingMode);const a=()=>this._estimateSurfaceAltitudeAtCenter(),n=this.view.resourceController.scheduler,o=Si((h=this.view.basemapTerrain)==null?void 0:h.elevationQueryCache),l={state:e,scheduler:n,surface:t,renderCoordsHelper:r};this._set("centerOnSurfaceInfrequent",new vn({...l,task:Zi.POINT_OF_INTEREST_INFREQUENT,estimateSurfaceAltitudeAtCenter:a})),this._set("centerOnSurfaceFrequent",new vn({...l,task:Zi.POINT_OF_INTEREST_FREQUENT,estimateSurfaceAltitudeAtCenter:a})),this._set("centerOnContent",new vn({...l,task:Zi.POINT_OF_INTEREST_FREQUENT,estimateSurfaceAltitudeAtCenter:()=>this._estimateContentAltitudeAtCenter()})),this._set("cameraOnSurface",new Yn({...l,cache:o,task:Zi.POINT_OF_INTEREST_INFREQUENT,map:s})),this._set("surfaceGeometryUpdates",new Ll({...l,centerOnSurfaces:[this.centerOnSurfaceFrequent,this.centerOnContent,this.centerOnSurfaceInfrequent]})),this._set("contentGeometryUpdates",new gY({contentLayerViews:this.view.allLayerViews,renderCoordsHelper:r})),this._set("surfaceOrigin",new Il({cache:o,view:this.view})),this._set("focus",new Bo({state:e,scheduler:n,surface:t,renderCoordsHelper:r,centerOnSurface:this.centerOnSurfaceInfrequent,estimateSurfaceIntersectionAtRenderPoint:(u,p)=>this._estimateSurfaceIntersectionAtRenderPoint(u,this.view.state.contentCamera,p)})),this._pois.push(this.centerOnContent,this.centerOnSurfaceFrequent,this.centerOnSurfaceInfrequent,this.cameraOnSurface,this.focus);const c=this.view.graphics;this._debugCenters.set(this.centerOnContent,new op(c,"red","CenterOnContent")),this._debugCenters.set(this.centerOnSurfaceFrequent,new op(c,"red","CenterOnSurface")),this._debugCenters.set(this.centerOnSurfaceInfrequent,new op(c,"red","CenterOnSurface")),this._debugCenters.set(this.cameraOnSurface,new op(c,"blue","CameraOnSurface")),this._debugCenters.set(this.focus,new op(c,"green","Focus")),this._handles.add([te(()=>e.contentCamera,u=>this._cameraChanged(u),Bt),te(()=>t.extent,()=>this._updateCenterPointsOfInterest()),Rd(()=>!t.updating,()=>this._updateCenterPointsOfInterest(),Bt),ll(()=>this.surfaceGeometryUpdates.events,"request-update",()=>this._updateCenterPointsOfInterest()),ll(()=>this.contentGeometryUpdates.events,"request-update",()=>this._updateCenterOnContent()),Rd(()=>Ot.SHOW_POI,u=>this._setDebug(u),Ji)]),this._cameraChanged(this.view.state.contentCamera);for(const u of this._pois)u.runTask()}destroy(){this._setDebug(!1),this._handles.destroy(),this._propertiesPool.destroy();for(const e of this._pois)e.destroy();this.surfaceOrigin.destroy()}get updating(){var e;return!(!((e=this.surfaceGeometryUpdates)!=null&&e.updating)&&!this._pois.some(t=>t.updating))}get _centerRay(){return this._centerRayDirty&&(this._centerRayCached=this.view.sceneIntersectionHelper.getCenterRayWithSubpixelOffset(this.view.state.contentCamera,this._tmpRay),this._centerRayDirty=!1),this._centerRayCached}_estimateContentAltitudeAtCenter(){if(!this._contentAltitudeAtCenterDirty)return this._contentAltitudeAtCenter;this._contentAltitudeAtCenterDirty=!1;const e=this._centerRay;return P(e)||(this.view.sceneIntersectionHelper.intersectRay(e,this._contentIntersector,Gu,wY)?this._contentAltitudeAtCenter=this.view.renderCoordsHelper.getAltitude(Gu):this._contentAltitudeAtCenter=this._estimateSurfaceAltitudeAtCenter()),this._contentAltitudeAtCenter}_estimateSurfaceAltitudeAtCenter(){if(!this.view.basemapTerrain)return 0;if(!this._surfaceAltitudeAtCenterDirty)return this._surfaceAltitudeAtCenter;this._surfaceAltitudeAtCenterDirty=!1;const e=this._centerRay;if(P(e))return this._surfaceAltitudeAtCenter;const t=e.origin,r=X(Gu,e.origin,e.direction);return this._surfaceIntersector.resetWithRay(e,this.view.state.contentCamera),this.view.basemapTerrain.intersect(this._surfaceIntersector,null,t,r),this._surfaceIntersector.results.min.getIntersectionPoint(Gu)&&(this._surfaceAltitudeAtCenter=this.view.renderCoordsHelper.getAltitude(Gu)),this._surfaceAltitudeAtCenter}_estimateSurfaceIntersectionAtRenderPoint(e,t,r){const s=bC(t,e,xY);if(P(s))return null;const a=s.origin,n=X(Gu,s.origin,s.direction);return this._surfaceIntersector.resetWithRay(s,t),this.view.basemapTerrain.intersect(this._surfaceIntersector,null,a,n),this._surfaceIntersector.results.min.getIntersectionPoint(r)?r:null}_cameraChanged(e){this._updateCenterPointsOfInterest();const t=e.eye;An(this.renderPointOfView,t)||this._set("renderPointOfView",H(this._propertiesPool.get("renderPointOfView"),t))}_updateCenterPointsOfInterest(){this._centerRayDirty=!0,this._surfaceAltitudeAtCenterDirty=!0,this._contentAltitudeAtCenterDirty=!0;for(const e of this._pois)e.updateRenderLocation()}_updateCenterOnContent(){this._contentAltitudeAtCenterDirty=!0,this.centerOnContent.updateRenderLocation()}_setDebug(e){if(!e)return this._debugCenters.forEach(t=>t.hide()),void this._handles.remove("debug");for(const t of this._pois)this._handles.add(te(()=>t.renderLocation,r=>{var s;return(s=this._debugCenters.get(t))==null?void 0:s.show(r,t.renderCoordsHelper.spatialReference)},Ji),"debug")}get test(){return{update:()=>{this.surfaceGeometryUpdates.runTask();for(const e of this._pois)e.runTask()},surfaceGeometryUpdates:this.surfaceGeometryUpdates}}};d([v({readOnly:!0})],js.prototype,"centerOnContent",void 0),d([v({readOnly:!0})],js.prototype,"centerOnSurfaceFrequent",void 0),d([v({readOnly:!0})],js.prototype,"centerOnSurfaceInfrequent",void 0),d([v({readOnly:!0})],js.prototype,"cameraOnSurface",void 0),d([v({readOnly:!0})],js.prototype,"focus",void 0),d([v({readOnly:!0})],js.prototype,"renderPointOfView",void 0),d([v({readOnly:!0})],js.prototype,"surfaceOrigin",void 0),d([v({readOnly:!0})],js.prototype,"contentGeometryUpdates",void 0),d([v({readOnly:!0})],js.prototype,"surfaceGeometryUpdates",void 0),d([v({constructOnly:!0})],js.prototype,"view",void 0),d([v({readOnly:!0})],js.prototype,"updating",null),js=d([Y("esri.views.3d.support.PointsOfInterest")],js);const bY=Array,Gu=T(),xY=Aa(),wY={exclude:new Set([jc])};let TY=class{constructor(e){this._store=e}destroy(){this._store.destroy()}get(e){return this._store.get(e)}put(e,t){this._store.put(e,t,t.values.byteLength+256)}};const the={value:.5,readOnly:!0},CY={readOnly:!0,value:.5,get(){return this.updating?this.updatingProgressValue:1}};let xp=class{constructor(e=0,t=0){this.min=e,this.max=t,this.level=0,this.hasNoDataValues=!1}copyFrom(e){this.min=e.min,this.max=e.max,this.level=e.level,this.hasNoDataValues=e.hasNoDataValues}},SY=class{constructor(e,t,r){this.type="elevation",this.level=e[0],this.i=e[1],this.j=e[2],this.extent=t,this.samplerData=new cF(r,t)}computeMinMaxValue(e,t,r,s){s.min=1/0,s.max=-1/0,s.hasNoDataValues=!1;const a=e-this.level;if(a<=0)return s;const n=2**a;if(!(Math.floor(t/n)===this.i&&Math.floor(r/n)===this.j))return s;let o=1/0,l=-1/0;const c=this.samplerData.data.width,h=this.samplerData.data.values,u=.5*hf;let p=(c-1)/n,m=(r-this.j*n)*p,f=(t-this.i*n)*p;if(p<1){const y=Math.floor(m),b=Math.floor(f),x=y+b*c,S=h[x],C=h[x+1],O=h[x+c],R=h[x+c+1];if(S+C+O+R<u){const E=m-y,$=f-b,M=n_(S,C,O,R,E,$),L=n_(S,C,O,R,E+p,$),F=n_(S,C,O,R,E,$+p),N=n_(S,C,O,R,E+p,$+p);return s.min=Math.min(M,L,F,N),s.max=Math.max(M,L,F,N),s}m=y,f=b,p=1}else m=Math.floor(m),f=Math.floor(f),p=Math.ceil(p);for(let y=m;y<=m+p;y++)for(let b=f;b<=f+p;b++){const x=h[y+b*c];x<u?(o=Math.min(o,x),l=Math.max(l,x)):s.hasNoDataValues=!0}return s.min=o,s.max=l,s}};const PY=.5*hf;function ri(i,e,t){if(P(t))return null;for(const r of t){if(!r)continue;const s=r.safeWidth;let a=ee(r.dy*(r.y1-e),0,s),n=ee(r.dx*(i-r.x0),0,s);const o=Math.floor(a),l=Math.floor(n),c=r.data.width,h=o*c+l,u=r.data.values,p=u[h],m=u[h+1],f=h+c,y=u[f],b=u[f+1];if(p+y+m+b<PY){a-=o,n-=l;const x=p+(m-p)*n;return x+(y+(b-y)*n-x)*a}}return null}let _n=class extends Ie{constructor(e){super(e),this._handles=new Vi}initialize(){this._handles.add([this.layerViews.on("change",()=>this.notifyChange("stencilEnabledExtents"))])}destroy(){this._handles=Te(this._handles)}get layerViewsExtent(){return this._computeLayerViewsExtent()}get tiledLayersExtent(){return this._computeTiledLayersExtent()}get stencilEnabledExtents(){return this._computeStencilEnabledExtents()}_computeStencilEnabledExtents(){const e=[];return this.layerViews.forEach(t=>{const r=t.layer;if(r.operationalLayerType==="IntegratedMeshLayer"&&this.viewSpatialReference!=null){const s=O$(r.fullExtent,this.viewSpatialReference);g(s)&&e.push(a3(s))}}),e}};function OY(i,e){return i===ve.Global?new Gw(e):new Bw(e)}d([v({readOnly:!0})],_n.prototype,"layerViewsExtent",null),d([v({readOnly:!0})],_n.prototype,"tiledLayersExtent",null),d([v({readOnly:!0})],_n.prototype,"stencilEnabledExtents",null),d([v()],_n.prototype,"viewSpatialReference",void 0),d([v()],_n.prototype,"tilingScheme",void 0),d([v()],_n.prototype,"defaultTiledLayersExtent",void 0),d([v({constructOnly:!0})],_n.prototype,"layers",void 0),d([v({constructOnly:!0})],_n.prototype,"layerViews",void 0),_n=d([Y("esri.views.3d.terrain.ExtentHelper")],_n);let Gw=class extends _n{_computeLayerViewsExtent(){return this._globalExtent}_computeTiledLayersExtent(){return this._globalExtent}get _globalExtent(){return this.viewSpatialReference.isWebMercator?AM:X8}};Gw=d([Y("esri.views.3d.terrain.ExtentHelperGlobal")],Gw);let Bw=class extends _n{_computeLayerViewsExtent(){const e=bo(),t=this.viewSpatialReference;this.layerViews.forEach(a=>{const n=a.layer;if(a.isResolved()&&(n.type!=="graphics"||!n.internal)){const o=O$("fullExtentInLocalViewSpatialReference"in a&&a.fullExtentInLocalViewSpatialReference||a.layer.fullExtent,t);eh(e,o,e)}});const r=yx(e)?e:null,s=this._get("layerViewsExtent");return xd(r,s)?s:r}_computeTiledLayersExtent(){const e=this.tilingScheme;if(!e)return null;const t=this.viewSpatialReference,r=bo();this.layers.forEach(n=>{if(n.loaded&&xg(n)){const o=qv(n,t,ve.Local);if(P(o))return;const{tileInfo:l,fullExtent:c}=o;g(l)&&g(c)&&(Zy(n)||e.compatibleWith(l)&&c.spatialReference.equals(e.spatialReference))&&eh(r,c,r)}}),eh(r,this.defaultTiledLayersExtent,r);const s=yx(r)?r:null,a=this._get("tiledLayersExtent");return xd(s,a)?a:s}};function O$(i,e){return g(i)&&!i.spatialReference.equals(e)?QN(i,i.spatialReference,e):i}Bw=d([Y("esri.views.3d.terrain.ExtentHelperLocal")],Bw);var ot;(function(i){i[i.ELEVATION=0]="ELEVATION",i[i.MAP=1]="MAP"})(ot||(ot={}));const cd=[ot.ELEVATION,ot.MAP];function R$(){var e;const i=(e=globalThis.require)==null?void 0:e.modules;if(i){const t=Object.keys(i);for(const r of t)r.search(".glsl")!==-1&&delete i[r]}}const RY=[[-.1,-2,3.9,2],[-.1,-3.9,3.9,.1],[-2,-3.9,2,.1],[-3.9,-3.9,.1,.1],[-3.9,-2,.1,2],[-3.9,-.1,.1,3.9],[-2,-.1,2,3.9],[-.1,-.1,3.9,3.9]];let Ic,Hs=class extends Ie{get running(){return this._placementDirty&&(this._drapeSources.size>0||this._view.graphics.length>0||Ot.OVERLAY_DRAW_DEBUG_TEXTURE)&&!!this._spatialReference&&!this.suspended&&this.surface.ready}get _isSpherical(){return this._view.state.isGlobal}get _worldToPCSRatio(){return g(this._spatialReference)&&this._spatialReference.isGeographic&&!this._view.state.isLocal?Et(this._spatialReference).metersPerDegree:1}get _view(){return this.surface.view}get suspended(){return this.surface.suspended}get updating(){return this.running||this.renderer.updating||this._contentUpdated}get hasHighlights(){return this.renderer.hasHighlights}get rendersOccluded(){return this.renderer.rendersOccluded}constructor(e){super(e),this._handles=new Vi,this._spatialReference=null,this._renderSR=null,this._overlaySREqualsRenderSR=!0,this._drapeSources=new Set,this._drapeTargets=new Set,this._placementDirty=!1,this._contentUpdated=!1,this._drawTexturesDirty=!1,this._drawTexturesAnimateDirty=!1,this._hasUnusedRenderTargets=!1,this._longitudeCyclical=null,this._latestOriginId=0,this._maxResolution=vi("esri-mobile")?2048:4096,this._animationTimeLast=0}initialize(){var t;const e=this._view;this.renderer=new Zn({view:e,worldToPCSRatio:this._worldToPCSRatio,spatialReference:this._spatialReference}),this._groundIntersector=zn(this._view.state.viewingMode),this._groundIntersector.options.backfacesTerrain=!0,this._groundIntersector.options.invisibleTerrain=!0,this._groundIntersector.options.hud=!1,this._handles.add([this.renderer.events.on("has-highlights",()=>{this.setDrawTexturesDirty(),this.notifyChange("hasHighlights")}),this.renderer.events.on("has-water",r=>{var s;return(s=e._stage)==null?void 0:s.renderer.setParameters({hasOverlayWater:r})}),this.renderer.events.on("renders-occluded",()=>{this.setDrawTexturesDirty(),this.notifyChange("rendersOccluded")}),this.renderer.events.on("content-changed",()=>this.setDrawTexturesDirty()),this.renderer.events.on("textures-disposed",()=>this.updateOverlayResult()),te(()=>{var r,s,a;return[(r=e.pointsOfInterest)==null?void 0:r.renderPointOfView,(a=(s=e.pointsOfInterest)==null?void 0:s.centerOnSurfaceFrequent)==null?void 0:a.location]},()=>this.setPlacementDirty()),te(()=>{var r,s;return[(r=e.state)==null?void 0:r.pixelRatio,(s=e.state)==null?void 0:s.contentPixelRatio]},()=>this.setPlacementDirty(),Bt),this.surface.on("elevation-change",()=>this.setPlacementDirty()),e.on("resize",()=>this.setPlacementDirty()),e.resourceController.scheduler.registerTask(Zi.OVERLAY,this),e._stage.renderView.events.on("force-camera-for-screenshot",r=>{this._updateOverlays(Ea,r,Wi.BACKGROUND),this.renderer.hasOverlays&&this._drawOverlayTextures(this.renderer.overlays,Wi.BACKGROUND,r.pixelRatio)})]),(t=e._stage)==null||t.renderer.setParameters({renderOverlay:r=>{this._contentUpdated=!1,this.renderer.processSyncDrapeSources(),this.renderer.hasOverlays&&(this._dispatchAnimationUpdate(r),this._drawOverlayTextures(this.renderer.overlays,Wi.UPDATE)),this._hasUnusedRenderTargets&&this._collectUnusedRenderTargetMemory()}})}destroy(){this._handles=Te(this._handles),g(Ic)&&(Ic.hide(),Ic=null)}get hasOverlays(){return this.renderer.hasOverlays}setSpatialReference(e){this._spatialReference=e,this.renderer.spatialReference=e,this._longitudeCyclical=null;const t=this._view.renderSpatialReference;g(e)&&g(t)?(this._renderSR=t,this._overlaySREqualsRenderSR=e.equals(this._renderSR),this._isSpherical&&(this._longitudeCyclical=e.isWebMercator?new kg(-20037508342787e-6,20037508342787e-6):new kg(-180,180),this.renderer.longitudeCyclical=this._longitudeCyclical),this.renderer&&(this.renderer.worldToPCSRatio=this._worldToPCSRatio)):this.renderer.disposeOverlays()}get gpuMemoryUsage(){return this.renderer.gpuMemoryUsage}registerDrapeSource(e,t,r){this._drapeSources.add(e),this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources);const s=this.renderer.createDrapeSourceRenderer(e,t,r);return this._updateDrapeSourceExtent(e),this._setContentDirty(),this.notifyChange("running"),s}registerGeometryDrapeSource(e){return this.registerDrapeSource(e,Qa)}_updateDrapeSourceExtent(e){this.renderer.overlays.length===2&&g(e.setDrapingExtent)&&g(this._spatialReference)&&e.setDrapingExtent(this.renderer.overlays,this._spatialReference)}unregisterDrapeSource(e){this._drapeSources.has(e)&&(this._drapeSources.delete(e),this.renderer.removeDrapeSourceRenderer(e),this.renderer.ensureDrapeSources(this._drapeSources),this._setContentDirty(),this.notifyChange("running"))}registerDrapeTarget(e){this._drapeTargets.add(e),this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources)}updateOverlayResult(){var e;(e=this._view._stage)==null||e.renderer.setParameters({overlays:this.renderer.overlays})}unregisterDrapeTarget(e){this._drapeTargets.delete(e),this.renderer.ensureDrapeTargets(this._drapeTargets)}_setContentDirty(){this.setPlacementDirty(),this.setDrawTexturesDirty()}setPlacementDirty(){this._placementDirty=!0}runTask(e){return this._updateOverlays(e,this._view.state.contentCamera,Wi.UPDATE)}_updateOverlays(e,t,r){if(!this._spatialReference)return na.YIELD;const s=this._computeOverlayResolution(t);this._computeOverlayExtents(t,s,Al);const a=Yo(Al.inner)/Yo(Al.outer);this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources);const n=this._updateOverlay(oi.INNER,Al.inner,s,1*Al.pixelRatioAdjustment,Al.mapUnitsPerPixel),o=this._updateOverlay(oi.OUTER,Al.outer,s,a*Al.pixelRatioAdjustment,Al.mapUnitsPerPixel);n!==jo.EXTENT&&o!==jo.EXTENT||(this._drapeSources.forEach(l=>this._updateDrapeSourceExtent(l)),this.surface.updateTileOverlayParams(r)),n===jo.NONE&&o===jo.NONE||this.setDrawTexturesDirty(),this._placementDirty=!1,e.madeProgress()}_computeOverlayResolution(e){const t=this._view.state.contentPixelRatio,r=e.fullWidth/e.pixelRatio*t,s=e.fullHeight/e.pixelRatio*t;return Math.min(xT(Math.max(r,s)+256),this._maxResolution)}_updateOverlay(e,t,r,s,a){if(this.renderer.overlays.length===0)return jo.NONE;const n=this.renderer.overlays[e],o=n.mapUnitsPerPixel;if(n.mapUnitsPerPixel=a,n.pixelRatio=s,EY(t,n.extent)&&r===n.resolution)return o===a?jo.NONE:jo.RERENDER_ONLY;Wg(n.extent,t),n.resolution=r;const l=wT(n.extent);return n.renderLocalOrigin=Lg(l[0],l[1],0,"OV_"+this._latestOriginId++),jo.EXTENT}setTileParameters(e){const t=e.renderData.overlay;if(this.renderer.overlays.length>0){const r=this.renderer.overlays[oi.INNER],s=this.renderer.overlays[oi.OUTER],a=e.extent;this._rectInsideRect(r.extent,a)||this._rectanglesOverlap(a,r.extent)||this._rectanglesOverlap(a,s.extent)?(this._setTileOverlayData(a,oi.INNER,t),this._setTileOverlayData(a,oi.OUTER,t)):(this._clearTileOverlayData(oi.INNER,t),this._clearTileOverlayData(oi.OUTER,t))}else this._clearTileOverlayData(oi.INNER,t),this._clearTileOverlayData(oi.OUTER,t)}overlayPixelSizeInMapUnits(e){if(this.renderer.overlays.length===0)return 0;const t=this.renderer.overlays[oi.INNER],r=this.renderer.overlays[oi.OUTER],s=this._pointIsInExtent(e,t.extent)?t:r;return(s.extent[2]-s.extent[0])/s.resolution}_setTileOverlayData(e,t,r){if(this.renderer.overlays.length===0)return;const s=this.renderer.overlays[t].extent,a=Yo(s),n=dh(s);let o=e[0];if(this._longitudeCyclical){o=this._longitudeCyclical.minimalMonotonic(s[0],o);const l=this._longitudeCyclical.minimalMonotonic(s[0],e[2]);o>l&&(o=l-(e[2]-e[0]))}r.setScale(t,Yo(e)/a,dh(e)/n),r.setOffset(t,(o-s[0])/a,(e[1]-s[1])/n)}_clearTileOverlayData(e,t){t.setScale(e,-1,-1),t.setOffset(e,-1,-1)}async reloadShaders(){R$(),await this.renderer.reloadShaders(),this.setDrawTexturesDirty(),this.runTask(Ea)}_dispatchAnimationUpdate(e){const t=Je(e-this._animationTimeLast);if(t>=this.surface.view._stage.renderer.animationTimestep||g(this._view.state.forcedAnimationTime)||this._drawTexturesDirty||this._drawTexturesAnimateDirty){const r=Je(t/this.surface.view._stage.renderer.animationTimeDilation),s=new j3(this._view.state.camera,r,this._view.state.forcedAnimationTime);this.renderer.updateAnimation(s)&&(this._drawTexturesAnimateDirty=!0),this._animationTimeLast=e}}setDrawTexturesDirty(){this.renderer.hasOverlays?(this._contentUpdated=!0,this._drawTexturesDirty=!0,this._view._stage.renderView.requestRender()):this.setPlacementDirty()}_intersectGroundFromView(e,t,r,s){const a=this._view.sceneIntersectionHelper.getCenterRayWithSubpixelOffset(e,DY,t,r);if(P(a))return!1;const n=a.origin,o=X(p0,a.origin,a.direction);return this._groundIntersector.reset(n,o,e),this._groundIntersector.intersect([]),this._view.basemapTerrain.intersect(this._groundIntersector,null,n,o),this._groundIntersector.results.min.getIntersectionPoint(s)}_findHorizonBasedPointOfInterest(e,t){let r=.5;const s=.55,a=this._view.renderCoordsHelper.getAltitude(e.eye),n=this._view.pointsOfInterest.centerOnSurfaceFrequent,o=1e-5,l=ee(n.estimatedSurfaceAltitude,e.aboveGround?-1/0:a+o,e.aboveGround?a-o:1/0),c=e.aboveGround;if(this._view.viewingMode==="global"){const h=p0;pv(ST(PT,Et(this._view.spatialReference).radius+l),xo(e.eye,e.viewForward),h),Q(h,h,e.eye);const u=lh.normalize(g3(e.viewForward,h,e.viewRight))/e.fovY+.5,p=u<=0||u>=1?.5:s;r=c?p*u:u+p*(1-u)}else{const h=.5*Math.PI-Math.acos(-e.viewForward[2]),u=Math.tan(h),p=hi(0,u,1,0),m=Ul(p,p,e.projectionMatrix)[1],f=ee(.5+.5*m,0,1);r=f===1||f===0?.5:c?f*s:1-(1-f)*s}return!!this._intersectGroundFromView(e,.5,r,t)&&IA(t,e.eye)<n.distance*n.distance}_computeOverlayExtents(e,t,r){const s=this._view.pointsOfInterest.centerOnSurfaceFrequent.renderLocation,a=T();this._findHorizonBasedPointOfInterest(e,a)||H(a,s);const n=Math.max(.1,yi(e.eye,a)),o=bh(this._view.renderCoordsHelper,s,e.eye),l=Math.PI/2-Math.abs(o-Math.PI/2);Ot.OVERLAY_SHOW_CENTER?(P(Ic)&&(Ic=new op(this._view.graphics,"red")),Ic.show(a,this._renderSR)):g(Ic)&&Ic.hide(),this._overlaySREqualsRenderSR||Jr(a,this._renderSR,a,this._spatialReference);const c=this.surface.extent,h=!this._isSpherical&&g(this._spatialReference)&&this._spatialReference.isGeographic,u=h&&g(this._spatialReference)?1/Et(this._spatialReference).metersPerDegree:1,p=this._view.state.contentPixelRatio,m=e.perScreenPixelRatio/p*n*u;r.mapUnitsPerPixel=m/this._worldToPCSRatio;let f=t*m/2,y=!1,b=h?90:1/0;this._isSpherical&&g(c)&&g(this._spatialReference)&&(this._spatialReference.isWebMercator?(f/=Math.cos(fx(a[1])),b=c[3]):(y=!0,f/=Et(this._spatialReference).metersPerDegree,b=90),f>=b&&(f=b,a[1]=0,this._spatialReference.isWebMercator&&(a[0]=0)));let x=1;y&&(x=1/Math.max(.2,Math.cos(Math.abs(ut(a[1])))),f*x>180&&(x=180/f),r.mapUnitsPerPixel*=x);const S=Math.log(2)/12;f=Math.exp(Math.round(Math.log(f)/S)*S);const C=f*x,O=32,R=.5*t/(O*C),E=.5*t/(O*f);a[0]=Math.round(a[0]*R)/R,a[1]=Math.round(a[1]*E)/E;const $=r.inner;$[0]=a[0]-C,$[1]=a[1]-f,$[2]=a[0]+C,$[3]=a[1]+f,this._isSpherical&&this._shiftExtentToFitBounds($,1/0,b);const M=r.outer;if(6*C>Yo(c))Wg(M,Si(c));else if(l<=.25*Math.PI)M[0]=$[0]-C,M[1]=$[1]-f,M[2]=$[2]+C,M[3]=$[3]+f;else{Jr(e.eye,this._renderSR,p0,this._spatialReference),kc(Kh,a,p0);let F=-Math.atan2(Kh[1],Kh[0])+.125*Math.PI;F<0&&(F+=2*Math.PI);const N=Math.floor(F/(.25*Math.PI));sv(Kh,RY[N],2*f),Kh[0]*=x,Kh[2]*=x,ZN(M,$,Kh)}if(this._isSpherical)M[0]=this._longitudeCyclical.clamp(M[0]),M[2]=this._longitudeCyclical.clamp(M[2]),M[1]=Math.max(M[1],-b),M[3]=Math.min(M[3],b);else{const F=Tx($,c,AY),N=Tx(M,c,MY);jS(F,N)&&(M[2]=M[0],M[3]=M[1])}const L=Math.abs($[2]-$[0])/t;r.mapUnitsPerPixel=Math.max(r.mapUnitsPerPixel,L),r.pixelRatioAdjustment=r.mapUnitsPerPixel/L}_drawOverlayTextures(e,t,r=this._view.state.contentPixelRatio){if(e.length===0||!this._drawTexturesDirty&&!this._drawTexturesAnimateDirty)return;const s=this._drawTexturesDirty;this._drawTexturesDirty=!1,this._drawTexturesAnimateDirty=!1;const a=this._drawOverlay(e[oi.INNER],r),n=this._drawOverlay(e[oi.OUTER],r);a!==yy.CHANGED&&n!==yy.CHANGED||this.surface.updateTileOverlayParams(Wi.UPDATE),this._collectUnusedRenderTargetMemory(),this.updateOverlayResult(),s?(this.surface.requestRender(t),t===Wi.UPDATE&&this.surface.requestUpdate()):this.surface.requestRender(Wi.BACKGROUND)}_drawOverlay(e,t){return this._longitudeCyclical?e.setupGeometryViewsCyclical(this._longitudeCyclical):e.setupGeometryViewsDirect(),e.draw(this.renderer,t)}_collectUnusedRenderTargetMemory(){if(this._hasUnusedRenderTargets=!1,this.renderer.hasOverlays){const e=performance.now();this._hasUnusedRenderTargets=this.renderer.collectUnusedRenderTargetMemory(e)}}_rectanglesOverlap(e,t){return!P(e)&&(this._longitudeCyclical?(this._longitudeCyclical.contains(t[0],t[2],e[0])||this._longitudeCyclical.contains(t[0],t[2],e[2])||this._longitudeCyclical.contains(e[0],e[2],t[0]))&&!(e[1]>t[3]||e[3]<t[1]):ov(e,t))}_rectInsideRect(e,t){return!P(t)&&(this._longitudeCyclical?this._longitudeCyclical.contains(e[0],e[2],t[0])&&this._longitudeCyclical.contains(e[0],e[2],t[2])&&t[1]>e[1]&&t[3]<e[3]:jS(e,t))}_pointIsInExtent(e,t){if(this._longitudeCyclical)return this._longitudeCyclical.contains(t[0],t[2],e.x)&&e.y>=t[1]&&e.y<=t[3];const r=e.x,s=e.y;return r>t[0]&&r<t[2]&&s>t[1]&&s<t[3]}_shiftExtentToFitBounds(e,t,r){let s=0,a=0;e[0]<-t?s=e[0]+t:e[2]>t&&(s=t-e[2]),e[1]<-r?a=e[1]+r:e[3]>r&&(a=r-e[3]),cy(e,s,a)}get test(){return{renderer:this.renderer,update:()=>this.runTask(Ea)}}};function EY(i,e){const r=Ot.TESTS_DISABLE_OPTIMIZATIONS?0:1e-5*Math.max(i[2]-i[0],i[3]-i[1],e[2]-e[0],e[3]-e[1]);return Math.abs(e[0]-i[0])<=r&&Math.abs(e[1]-i[1])<=r&&Math.abs(e[2]-i[2])<=r&&Math.abs(e[3]-i[3])<=r}d([v()],Hs.prototype,"_spatialReference",void 0),d([v({readOnly:!0})],Hs.prototype,"running",null),d([v()],Hs.prototype,"_placementDirty",void 0),d([v()],Hs.prototype,"_contentUpdated",void 0),d([v()],Hs.prototype,"_isSpherical",null),d([v()],Hs.prototype,"_worldToPCSRatio",null),d([v({autoDestroy:!0})],Hs.prototype,"renderer",void 0),d([v({constructOnly:!0})],Hs.prototype,"surface",void 0),d([v()],Hs.prototype,"suspended",null),d([v()],Hs.prototype,"updating",null),d([v({type:Boolean})],Hs.prototype,"hasHighlights",null),d([v({type:Boolean})],Hs.prototype,"rendersOccluded",null),Hs=d([Y("esri.views.3d.terrain.OverlayManager")],Hs);const Kh=Pt(),p0=T(),Al={inner:yt(),outer:yt(),mapUnitsPerPixel:0,pixelRatioAdjustment:1},AY=yt(),MY=yt(),DY=Aa();var jo;(function(i){i[i.NONE=0]="NONE",i[i.EXTENT=1]="EXTENT",i[i.RERENDER_ONLY=2]="RERENDER_ONLY"})(jo||(jo={}));let E$=class Hw{constructor(e,t){this._factoryCallback=e,this._lengthCallback=t,this._pool=new Map}acquire(e){if(!Hw.test.disabled){const t=this._pool.get(e);if(t&&t.length!==0)return t.pop()}try{return this._factoryCallback(e)}catch(t){const r=window.performance&&window.performance.memory;let s="";throw r&&(s=`
  totalJSHeapSize: ${r.totalJSHeapSize}, usedJSHeapSize: ${r.usedJSHeapSize}, jsHeapSizeLimit: ${r.jsHeapSizeLimit}`),console.log("Array allocation of size "+e+" failed: "+t+s),t}}release(e){if(Hw.test.disabled)return;const t=this._lengthCallback(e);let r=this._pool.get(t);r||(r=new At({shrink:!0}),this._pool.set(t,r)),r.push(e)}clear(){this._pool.clear()}get test(){return{size:this._pool.size}}};E$.test={disabled:!1};let IY=class{constructor(){this.indices=null,this.vertexAttributes=null,this.boundingBox=di(),this.indexCount=0,this.numVerticesPerSide=0,this.uvRange=[0,0,1,1],this.outerEdges=[null,null,null,null],this.innerEdges=[null,null,null,null]}},pE=class{constructor(e,t,r,s,a){this.attributes=e,this.localOrigin=t,this.index0=r,this.stride=s,this.count=a}getVertexIndex(e){return this.getAttributeIndex(e)}getAttributeIndex(e){return Z(0<=e&&e<this.count),this.index0+this.stride*e}_getVertexRaw(e,t){this.attributes.position.getVec(e,t)}_getNormalRaw(e,t){this.attributes.normalCompressed.getVec(e,t)}getVertexPos(e,t){this._getVertexRaw(this.getAttributeIndex(t),e),X(e,e,this.localOrigin)}getNormal(e,t){const r=$e();this._getNormalRaw(this.getAttributeIndex(t),r),FY(e,r)}_setNormal(e,t,r,s){Mf(this.attributes.normalCompressed,e,t,r,s)}_setUV(e,t,r){Na(this.attributes.uv0,e,t,r)}setNormalFromValues(e,t,r,s){this._setNormal(this.getAttributeIndex(e),t,r,s)}setVertexFromValuesRawPositionUV(e,t,r,s,a,n){const o=this.getAttributeIndex(e);this.attributes.position.setValues(o,t,r,s),this._setUV(o,a,n)}setVertexFromValuesRawPositionUVNormal(e,t,r,s,a,n,o,l,c){const h=this.getAttributeIndex(e);this.attributes.position.setValues(h,t,r,s),this._setUV(h,a,n),this._setNormal(h,o,l,c)}};const LY=mr().vec3f(w.POSITION).vec2i16(w.UV0).vec2i16(w.NORMALCOMPRESSED,{glNormalized:!0}),cS=new E$(i=>LY.createBuffer(i),i=>i.count);function $Y(){cS.clear()}function A$(i){return cS.acquire(i)}function NY(i){cS.release(i.vertexAttributes),i.vertexAttributes=null,i.indices=null}function Mf(i,e,t,r,s){const a=1/(Math.abs(t)+Math.abs(r)+Math.abs(s)),n=t*a,o=r*a,l=s<=0?(n>=0?1:-1)*(1-Math.abs(o)):n,c=s<=0?(o>=0?1:-1)*(1-Math.abs(n)):o;i.setValues(e,gE(l),gE(c))}function FY(i,e){const t=fE(e[0]),r=fE(e[1]),s=1-Math.abs(t)-Math.abs(r);i[2]=s,s<0?(i[0]=(t>=0?1:-1)*(1-Math.abs(r)),i[1]=(r>=0?1:-1)*(1-Math.abs(t))):(i[0]=t,i[1]=r),W(i,i)}const mE=16384;function Na(i,e,t,r){i.setValues(e,t*mE,r*mE)}function gE(i){return ee(Math.round(32767*i),-32767,32767)}function fE(i){return ee(i/32767,-1,1)}function Es(i,e,t,r){i<r[0]?r[0]=i:i>r[3]&&(r[3]=i),e<r[1]?r[1]=e:e>r[4]&&(r[4]=e),t<r[2]?r[2]=t:t>r[5]&&(r[5]=t)}let zY=class{constructor(){this.sinLonLUT=new Array(Xm+1),this.cosLonLUT=new Array(Xm+1),this.sinLatLUT=new Array(Xm+1),this.cosLatLUT=new Array(Xm+1)}update(e,t,r){const s=t[0],a=t[2];for(let n=0;n<=e;n++){const o=n/e,l=s*(1-o)+a*o;this.sinLonLUT[n]=Math.sin(l),this.cosLonLUT[n]=Math.cos(l);const c=r(o);this.sinLatLUT[n]=Math.sin(c),this.cosLatLUT[n]=Math.cos(c)}}},m0=class{constructor(){this.cornerTiles=[null,null,null,null],this.cornerTileSamplerVersions=[-1,-1,-1,-1]}},UY=class{constructor(){this.cornerNeighborData=[new m0,new m0,new m0,new m0],this.edgeResolutions=[-1,-1,-1,-1],this.edgePeerNeighbors=[null,null,null,null],this.edgePeerNeighborSamplerVersions=[-1,-1,-1,-1],this.cornerPeerNeighbors=[null,null,null,null]}},VY=class{constructor(){this.numVerticesPerSide=0,this.samplerData=null,this.clippingArea=null,this.wireframe=!1,this.shading=!1,this.samplerDataVersion=0,this.neighborData=new UY}},M$=class Z0{constructor(e){this._getFadeDuration=e,this._fadeStart=0,this._delayedTime=0}clear(){this._current=Te(this._current),this._next=Te(this._next),this._waiting=Te(this._waiting),this._delayed=Te(this._delayed)}get current(){if(P(this._current))return null;if(!this._isFadingEnabled){const t=this._delayed||this._waiting||this._next||this._current;t!==this._current&&(this._current=null,this.clear(),this._current=t)}let e=Z0.test.fadeMoment;if(g(this._delayed)&&(e=e||performance.now(),e>=this._delayedTime&&(this._push(this._delayed,jl.Immediate),this._delayed=null)),g(this._next)){e=e||performance.now();const t=this._fadeDuration,r=g(this._current)&&this._next.texture===this._current.texture,s=this._next.type!==or.FADING,a=e-this._fadeStart>=t;(r||s||a)&&(Te(this._current),this._current=this._next,this._next=this._waiting,this._waiting=null,this._fadeStart=this._alignFadeStart(e))}return this._current}get next(){return this._next}get fadeFactor(){if(P(this._next))return 1;const e=Z0.test.fadeMoment||performance.now(),t=Math.max(0,e-this._fadeStart),r=this._fadeDuration;return t>r?0:1-t/r}get isFading(){return g(this._next)||g(this._delayed)}push(e,t=jl.Immediate){this._delayed=Te(this._delayed),this._push(e,t)}_push(e,t){if(this._isFadingEnabled||this.clear(),P(this._current))return void(this._current=e);const r=Z0.test.fadeMoment||performance.now();return t!==jl.Immediate?(this._delayed=e,void(this._delayedTime=r+t)):P(this._next)?(this._next=e,void(this._fadeStart=this._alignFadeStart(r))):void(P(e)||(Te(this._waiting),this._waiting=e))}get _fadeDuration(){return P(this._waiting)?this._getFadeDuration():.5*this._getFadeDuration()}_alignFadeStart(e){const t=this._getFadeDuration();return e+t-e%t}get _isFadingEnabled(){return this._getFadeDuration()>0}};var jl;M$.test={fadeMoment:0},function(i){i[i.Immediate=0]="Immediate",i[i.Delayed=5e3]="Delayed"}(jl||(jl={}));var Zp;(function(i){i[i.BACK_TO_FRONT=-1]="BACK_TO_FRONT",i[i.NONE=0]="NONE",i[i.FRONT_TO_BACK=1]="FRONT_TO_BACK"})(Zp||(Zp={}));let D$=class{constructor(){this._queue=new At,this.remove=()=>{}}get done(){return this._queue.length===0&&(!this._last||this._last.isLeaf)}resetOne(e){this._queue.clear(),this._queue.push(e),this._last=void 0}reset(e=null){this._queue.clear(),g(e)&&this._queue.pushArray(e),this._last=void 0}skipSubtree(){this._last=void 0}next(){var t;const e=(t=this._last)==null?void 0:t.children;return e&&e[0]&&this._queue.pushArray(e),this._last=this._queue.pop(),this._last}},GY=class{constructor(){this._q=new At}get done(){return this._q.length===0}reset(e){if(this._q.clear(),!P(e)){this._q.pushArray(e);for(let t=0;t<this._q.length;++t){const r=this._q.data[t];r.isLeaf||this._q.pushArray(r.children)}}}next(){return this._q.pop()}};function zg(i,e,t){if(P(e)||P(e.fullExtent))return!1;const r=e.fullExtent,s=i.extent;if(t){if(s[0]<r.xmin||s[1]<r.ymin||s[2]>r.xmax||s[3]>r.ymax)return!1}else if(r.xmin>s[2]||r.ymin>s[3]||r.xmax<s[0]||r.ymax<s[1])return!1;const a=i.surface.tilingScheme.levels[i.level].scale,n=e.minScale;if(n>0&&a>1.00000001*n)return!1;const o=e.maxScale;return!(o>0&&a<.99999999*o)}function ql(i,e){const t=i.lij,r=e.lij;return t[0]-r[0]||t[1]-r[1]||t[2]-r[2]}function I$(i,e,t=null){P(t)||t.length===0?i===Zp.BACK_TO_FRONT?e.sort(BY):e.sort(HY):e.sort((r,s)=>kY(r,s,i,t))}function BY(i,e){const t=e.screenDepth-i.screenDepth;if(t!==0)return t;const r=i.lij,s=e.lij;return r[0]-s[0]||r[1]-s[1]||r[2]-s[2]}function HY(i,e){const t=i.screenDepth-e.screenDepth;if(t!==0)return t;const r=i.lij,s=e.lij;return r[0]-s[0]||r[1]-s[1]||r[2]-s[2]}function L$(i,e,t){const r=i.screenDepth,s=e.screenDepth;return r<s?-t:r>s?t:ql(i,e)}function kY(i,e,t,r){return _E(i,r)===_E(e,r)?L$(i,e,t):i?t:-t}function _E(i,e){for(const t of e)if(i.intersectsExtent(t))return!0;return!1}function jY(i,e){const t=i.distanceToPOI-e.distanceToPOI;if(t!==0)return t;const r=i.lij,s=e.lij;return r[0]-s[0]||r[1]-s[1]||r[2]-s[2]}function qY(i,e){const t=i.length;for(let r=0;r<t;++r)i.getItemAt(r).updateDistanceToPOI(e);i.sort(jY)}function WY(i,e,t){let r=1,s=0,a=0;for(;i!==e;)if(r*=.5,s*=.5,a*=.5,1&i.lij[2]&&(s+=.5),!(1&i.lij[1])&&(a+=.5),(i=i.parent)==null)throw new Error("tile was not a descendant of upsampleTile");t.init(e,s,a,r)}function XY(i){for(let e=0;e<i.length;e++){const t=i[e],r=t.parent;if(r)for(let s=0;s<4;s++){const a=r.children[s];if(a&&a!==t)return!0}}return!1}function fhe(i,e){if(!i||!e||i[0]===e[0])return!1;const t=i[0]<e[0],r=t?i:e,s=t?e:i,a=1<<s[0]-r[0];return Math.floor(s[1]/a)===r[1]&&Math.floor(s[2]/a)===r[2]}let hS=class{get updating(){return!!this._tileRequested}init(e,t,r,s){this.tile=e,this._layerIdx=t,this._layerClass=r,this._suspended=s,this._tileLayerInfo=e.getLayerInfo(t,r),this._tileRequested=null;const a=this._findAncestorWithData();this._setUpsampleTile(a)}startLoading(){return this._requestNext()}dispose(){this._tileRequested&&(this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null),this.tile=null,this._tileLayerInfo=null}setSuspension(e){e!==this._suspended&&(this._suspended=e,e?this._tileRequested&&(this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null):this._tileLayerInfo.data||this.update())}update(){const e=this._findAncestorWithData();return this._setUpsampleTile(e),this._requestNext()}dataArrived(e){this._setUpsampleTile(e),this._tileRequested=null,e===this.tile?this.tile.updateRenderData(this._layerClass,or.FADING):this._requestNext()}dataMissing(){this._tileRequested=null,this._tileLayerInfo.data=null,this._requestNext()}_agentDone(){this.tile.agentDone(this._layerIdx,this._layerClass),this.dispose()}_requestNext(){if(this._suspended)return!0;const e=this._findNextDownload();if(this._tileRequested){if(e===this._tileRequested)return!0;this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null}return g(e)?e.requestLayerData(this._layerIdx,this._layerClass,this)&&(this._tileRequested=e):this._agentDone(),!!this._tileRequested}_findNextDownload(){const e=this._layerIdx,t=this._layerClass,r=this.tile.surface.layerViewByIndex(e,t),s=Fw(r),{minLevel:a,maxLevel:n}=r.dataLevelRange,o=this._desiredMinLevelDelta,l=this._progressiveLevelModulo+o,c=this._scaleRangeEnabled?zg:()=>!0;let h=this.tile;const u=h.level;let p;const m=this._tileLayerInfo.upsampleInfo,f=g(m)?m.tile.level:-1,y=!!g(m)&&f-u>=o,b=Ur(s,"tilemapCache");for(;h&&c(h,s,!1)&&h.level>=a;){const x=h.level,S=u-x,C=h.layerInfo[t][e];if(C.data&&S>=o){(!y||x>f)&&this._setUpsampleTile(h),C.dataInvalidated&&(p=h);break}if((P(b)||b.getAvailability(h.lij[0],h.lij[1],h.lij[2])!=="unavailable")&&x<=n&&!C.data&&!C.dataMissing&&((P(p)||h.level===a||x%EM==0||u-p.level<o)&&(p=h),S>=l))break;h=h.parent}return g(p)&&u-p.level<o&&this._tileLayerInfo.upsampleInfo&&(p=null),p}_findAncestorWithData(){const e=this.tile.vlevel,t=this._desiredMinLevelDelta;let r;for(let s=this.tile;s;s=s.parent)if(s.hasLayerData(this._layerIdx,this._layerClass)){if(e-s.level>=t)return s;r=s}return r}_setUpsampleTile(e){this._tileLayerInfo.setUpsampleInfo(this.tile,e),this.tile.updateRenderData(this._layerClass,or.FADING)}get test(){return{findNextDownload:()=>this._findNextDownload(),tileLayerInfo:this._tileLayerInfo}}},QY=class extends hS{get _desiredMinLevelDelta(){throw yE}get _progressiveLevelModulo(){throw yE}dispose(){}};const yE=new Error("Abstract method called on TileAgent"),va=new QY;let $$=class extends hS{constructor(){super(...arguments),this._scaleRangeEnabled=!1}get _desiredMinLevelDelta(){return Ix(this.tile.level)-(this.tile.vlevel-this.tile.level)}get _progressiveLevelModulo(){return 0}},N$=class extends hS{constructor(){super(),this._scaleRangeEnabled=!0}get _desiredMinLevelDelta(){return 0}get _progressiveLevelModulo(){return EM}};var Sd,zd;(function(i){i[i.Stretch=0]="Stretch",i[i.Lut=1]="Lut",i[i.Hillshade=2]="Hillshade",i[i.COUNT=3]="COUNT"})(Sd||(Sd={})),function(i){i[i.Noop=0]="Noop",i[i.PerBand=1]="PerBand",i[i.COUNT=2]="COUNT"}(zd||(zd={}));function ZY(i,e){i.fragment.uniforms.add([new lt("u_colormap",t=>t.u_colormap),new ue("u_colormapOffset",t=>t.colormap.u_colormapOffset),new ue("u_colormapMaxIndex",t=>t.colormap.u_colormapMaxIndex),new ue("u_opacity",t=>t.common.u_opacity)]),i.fragment.code.add(_`
    vec4 colormap(vec4 currentPixel, bool isFloat) {
      float colorIndex = isFloat ? currentPixel.r - u_colormapOffset : currentPixel.r * 255.0 - u_colormapOffset;
      vec4 result;
      // handle no data and out of range pixels
      if (currentPixel.a == 0.0 || colorIndex > u_colormapMaxIndex) {
        result = vec4(0.0, 0.0, 0.0, 0.0);
      } else {
        // colormap lookup
        vec2 texelCoordinates = vec2((colorIndex + 0.5), 0.5);
        result = ${ia(e,"u_colormap","texelCoordinates","(1.0 / vec2(u_colormapMaxIndex + 1.0, 1.0))")};
      }
      return result;
    }
  `)}function YY(i,e){i.fragment.uniforms.add(_v("u_transformGrid",t=>t.u_transformGrid,e.hasWebGL2Context?ms.None:ms.InvSize)),i.fragment.uniforms.add(new pi("u_transformSpacing",t=>t.common.u_transformSpacing)),i.fragment.uniforms.add(new pi("u_targetImageSize",t=>t.common.u_targetImageSize)),i.fragment.code.add(_`
    vec2 projectPixelLocation(vec2 coords) {
      // Pixel index in row/column, corresponds to upperleft corner, e.g. [100, 20]
      vec2 index_image = floor(coords * u_targetImageSize);

      // Pixel's corresponding cell index in transform grid
      // Each transform cell corresponds to 4 pixels: 6 coefficients from lowerleft triangle followed by 6 coefficients from upperright triangle
      vec2 oneTransformPixel = vec2(4.0, 1.0);
      vec2 index_transform = floor(index_image / u_transformSpacing) * oneTransformPixel;

      // Correspoding position in transform grid cell, cell center coordinates
      vec2 pos = fract((index_image + 0.5) / u_transformSpacing);

      // Pixel's corresponding transform cell location, cell center coordinates
      vec2 transform_location = index_transform + 0.5;

      vec2 srcLocation;

      // Use lower triangle or upper triangle
      if (pos.s <= pos.t) {
        vec3 ll_abc = ${ia(e,"u_transformGrid","transform_location")}.rgb;
        vec3 ll_def = ${ia(e,"u_transformGrid","vec2(transform_location.s + 1.0, transform_location.t)")}.rgb;
        srcLocation.s = dot(ll_abc, vec3(pos, 1.0));
        srcLocation.t = dot(ll_def, vec3(pos, 1.0));
      } else {
        vec3 ur_abc = ${ia(e,"u_transformGrid","vec2(transform_location.s + 2.0, transform_location.t)")}.rgb;
        vec3 ur_def = ${ia(e,"u_transformGrid","vec2(transform_location.s + 3.0, transform_location.t)")}.rgb;
        srcLocation.s = dot(ur_abc, vec3(pos, 1.0));
        srcLocation.t = dot(ur_def, vec3(pos, 1.0));
      }

      return srcLocation;
    }
  `)}let F$=class extends Gi{constructor(){super(...arguments),this.scale=1,this.offset=uh}};function z$(i){i.attributes.add(w.POSITION,"vec2"),i.attributes.add(w.UV0,"vec2"),i.vertex.uniforms.add(new ue("scale",e=>e.scale)),i.vertex.uniforms.add(new pi("offset",e=>e.offset)),i.varyings.add("uv","vec2"),i.varyings.add("vuv","vec2"),i.vertex.code.add(_`void main(void) {
gl_Position = vec4(position, 0.0, 1.0);
uv = uv0 * scale + offset;
vuv = uv0;
}`)}let KY=class extends F${constructor(e,t,r){super(),this.common=e,this.u_image=t,this.u_transformGrid=r}};function JY(i,e){i.include(YY,e),i.fragment.uniforms.add([new lt("u_image",t=>t.u_image),new ih("u_flipY",t=>t.common.u_flipY),new ih("u_applyTransform",t=>t.common.u_applyTransform)]),i.fragment.code.add(_`vec2 getPixelLocation(vec2 coords) {
vec2 targetLocation = u_flipY ? vec2(coords.s, 1.0 - coords.t) : coords;
if (!u_applyTransform) {
return targetLocation;
}
return projectPixelLocation(targetLocation);
}
bool isOutside(vec2 coords){
if (coords.t>1.00001 ||coords.t<-0.00001 || coords.s>1.00001 ||coords.s<-0.00001) {
return true;
} else {
return false;
}
}
vec4 getPixel(vec2 pixelLocation) {
return texture2D(u_image, pixelLocation);
}`)}var le;(function(i){i[i.Normal=0]="Normal",i[i.Average=1]="Average",i[i.Lighten=2]="Lighten",i[i.Lighter=3]="Lighter",i[i.Plus=4]="Plus",i[i.Screen=5]="Screen",i[i.ColorDodge=6]="ColorDodge",i[i.Darken=7]="Darken",i[i.Multiply=8]="Multiply",i[i.ColorBurn=9]="ColorBurn",i[i.Overlay=10]="Overlay",i[i.SoftLight=11]="SoftLight",i[i.HardLight=12]="HardLight",i[i.VividLight=13]="VividLight",i[i.Hue=14]="Hue",i[i.Saturation=15]="Saturation",i[i.Luminosity=16]="Luminosity",i[i.Color=17]="Color",i[i.DestinationOver=18]="DestinationOver",i[i.DestinationAtop=19]="DestinationAtop",i[i.DestinationIn=20]="DestinationIn",i[i.DestinationOut=21]="DestinationOut",i[i.SourceAtop=22]="SourceAtop",i[i.SourceIn=23]="SourceIn",i[i.SourceOut=24]="SourceOut",i[i.Xor=25]="Xor",i[i.Difference=26]="Difference",i[i.Exclusion=27]="Exclusion",i[i.Minus=28]="Minus",i[i.Invert=29]="Invert",i[i.Reflect=30]="Reflect",i[i.COUNT=31]="COUNT"})(le||(le={}));const kw={normal:le.Normal,average:le.Average,lighten:le.Lighten,lighter:le.Lighter,screen:le.Screen,plus:le.Plus,"color-dodge":le.ColorDodge,darken:le.Darken,multiply:le.Multiply,"color-burn":le.ColorBurn,overlay:le.Overlay,"soft-light":le.SoftLight,"hard-light":le.HardLight,"vivid-light":le.VividLight,hue:le.Hue,saturation:le.Saturation,luminosity:le.Luminosity,color:le.Color,difference:le.Difference,exclusion:le.Exclusion,minus:le.Minus,invert:le.Invert,reflect:le.Reflect,"destination-over":le.DestinationOver,"destination-atop":le.DestinationAtop,"destination-in":le.DestinationIn,"destination-out":le.DestinationOut,"source-atop":le.SourceAtop,"source-in":le.SourceIn,"source-out":le.SourceOut,xor:le.Xor};function eK(i){return i===le.DestinationOver||i===le.DestinationAtop||i===le.DestinationIn||i===le.DestinationOut||i===le.SourceAtop||i===le.SourceIn||i===le.SourceOut||i===le.Xor}function dS(i){i.code.add(_`
    float lineFactorAtPosition(float value) {
      float pos = value * ${_.float(257)};
      if(pos < 0.5 || pos > ${_.float(257-.5)}) {
        return 1.0;
      }

      pos = pos + 0.5;
      float modulo = mod(pos, 16.0);
      return modulo <= 2.0 ?  1.0 - abs(modulo - 1.0) : 0.0;
    }

    float lineFactorAtUV(vec2 uv) {
      return max(lineFactorAtPosition(uv.x), lineFactorAtPosition(uv.y));
    }

    float lineFactor(vec2 uv) {
      vec2 offset = fwidth(uv) * 0.25;
      return (lineFactorAtUV(vec2(uv.x + offset.x, uv.y + offset.y)) +
              lineFactorAtUV(vec2(uv.x - offset.x, uv.y + offset.y)) +
              lineFactorAtUV(vec2(uv.x + offset.x, uv.y - offset.y)) +
              lineFactorAtUV(vec2(uv.x - offset.x, uv.y - offset.y))) / 4.0;
    }

    vec3 gridColor(vec2 uv) {
      float line = lineFactor(uv) * 0.1 + 0.9;
      return vec3(1.0, 0.972, 0.918) * line;
    }`)}function tK(i,e){const t=e.blendMode;t!==le.Normal&&(t===le.Reflect&&i.code.add(_`float reflectBlend(in float cb, in float cl) {
return (cl == 1.0) ? cl : min(cb * cb / (1.0 - cl), 1.0);
}`),t!==le.ColorDodge&&t!==le.VividLight||i.code.add(_`float colorDodge(in float cb, in float cl) {
return (cb == 0.0) ? 0.0 : (cl == 1.0) ? 1.0 : min(1.0, cb / (1.0 - cl));
}`),t!==le.ColorBurn&&t!==le.VividLight||i.code.add(_`float colorBurn(in float cb, in float cl) {
return (cb == 1.0) ? 1.0 : (cl == 0.0) ? 0.0 : 1.0 - min(1.0, (1.0 - cb) / cl);
}`),t===le.Overlay&&i.code.add(_`float overlay(in float cb, in float cl) {
return (1.0 - step(0.5, cl)) * (1.0 - 2.0 * (1.0 - cl ) * (1.0 - cb)) + step(0.5, cl) * (2.0 * cl * cb);
}`),t===le.HardLight&&i.code.add(_`float hardLight(in float cb, in float cl) {
return (1.0 - step(0.5, cl)) * (2.0 * cl * cb) + step(0.5, cl) * (1.0 - 2.0 * (1.0 - cl) * (1.0 - cb));
}`),t===le.SoftLight&&i.code.add(_`float softLight(in float cb, in float cl) {
if (cl <= 0.5) {
return cb - (1.0 - 2.0 * cl) * cb * (1.0 - cb);
}
if (cb <= 0.25) {
return cb + (2.0 * cl - 1.0) * cb * ((16.0 * cb - 12.0) * cb + 3.0);
}
return cb + (2.0 * cl - 1.0) * (sqrt(cb) - cb);
}`),t===le.VividLight&&i.code.add(_`float vividLight(in float cb, in float cl) {
return (1.0 - step(0.5, cl)) * colorBurn(cb, 2.0 * cl) + step(0.5, cl) * colorDodge(cb, (2.0 * (cl - 0.5)));
}`),t!==le.Hue&&t!==le.Saturation&&t!==le.Color&&t!==le.Luminosity||(i.code.add(_`float minv3(in vec3 c) {
return min(min(c.r, c.g), c.b);
}
float maxv3(in vec3 c) {
return max(max(c.r, c.g), c.b);
}
float lumv3(in vec3 c) {
return dot(c, vec3(0.3, 0.59, 0.11));
}
vec3 clipColor(vec3 color) {
float lum = lumv3(color);
float mincol = minv3(color);
float maxcol = maxv3(color);
if (mincol < 0.0) {
color = lum + ((color - lum) * lum) / (lum - mincol);
}
if (maxcol > 1.0) {
color = lum + ((color - lum) * (1.0 - lum)) / (maxcol - lum);
}
return color;
}
vec3 setLum(vec3 cbase, vec3 clum) {
return clipColor(cbase + vec3(lumv3(clum) - lumv3(cbase)));
}`),t!==le.Hue&&t!==le.Saturation||i.code.add(_`float satv3(vec3 c) {
return maxv3(c) - minv3(c);
}
vec3 setLumSat(vec3 cbase, vec3 csat, vec3 clum)
{
float minbase = minv3(cbase);
float sbase = satv3(cbase);
float ssat = satv3(csat);
return setLum(sbase > 0.0 ? (cbase - minbase) * ssat / sbase : vec3(0.0), clum);
}`)),i.code.add(_`
    vec4 applyBlendMode(vec3 cl, float ol, vec3 cb, float ob) {
      ${t===le.Multiply?_`return vec4(cl * ol * cb * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:t===le.Average?_`return vec4((cb + cl) * 0.5 * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:t===le.Lighten?_`return vec4(max(cb, cl) * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:t===le.Darken?_`return vec4(min(cl, cb) * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:t===le.Lighter?_`return vec4(cl * ol + cb * ob, ol + ob);`:t===le.Plus?_`return clamp(vec4(cl.rgb + cb.rgb, ol + ob), 0.0, 1.0);`:t===le.Minus?_`return vec4(clamp(vec3(cb.rgb - cl.rgb), 0.0, 1.0), ob * ol);`:t===le.Screen?_`return vec4((cl + cb - cl * cb) * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:t===le.Difference?_`return vec4(abs(cb - cl) * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:t===le.Invert?_`return vec4((1.0 - cb) * ol * ob + cb * ob * (1.0 - ol), ob);`:t===le.DestinationOver?_`return vec4(cl * ol * (1.0 - ob) + cb * ob, ol + ob - ol * ob);`:t===le.DestinationAtop?_`return vec4(cl * ol * (1.0 - ob) + cb * ob * ol, ol);`:t===le.DestinationOut?_`return vec4(cb * ob * (1.0 - ol), ob * (1.0 - ol));`:t===le.SourceAtop?_`return vec4(cl * ol * ob + cb * ob * (1.0 - ol), ob);`:t===le.SourceOut?_`return vec4(cl * ol * (1.0 - ob), ol * (1.0 - ob));`:t===le.Xor?_`return vec4(cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), ol * (1.0 - ob) + ob * (1.0 - ol));`:t===le.DestinationIn?_`return vec4(cb * ob * ol, ol * ob);`:t===le.SourceIn?_`return vec4(cl * ol * ob, ol * ob);`:t===le.Hue?_`
          vec3 f = setLumSat(cl, cb, cb);
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:t===le.Saturation?_`
          vec3 f = setLumSat(cb, cl, cb);
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:t===le.Color?_`
          vec3 f = setLum(cl, cb);
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:t===le.Luminosity?_`
          vec3 f = setLum(cb, cl);
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:t===le.Exclusion?_`
          vec3 f = cl + cb - 2.0 * cl * cb;
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:t===le.Reflect?_`
          vec3 f = vec3(reflectBlend(cb.r, cl.r), reflectBlend(cb.g, cl.g), reflectBlend(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:t===le.ColorDodge?_`
          vec3 f = vec3(colorDodge(cb.r, cl.r), colorDodge(cb.g, cl.g), colorDodge(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:t===le.ColorBurn?_`
          vec3 f = vec3(colorBurn(cb.r, cl.r), colorBurn(cb.g, cl.g), colorBurn(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:t===le.Overlay?_`
          vec3 f = vec3(overlay(cb.r, cl.r), overlay(cb.g, cl.g), overlay(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:t===le.SoftLight?_`
          vec3 f = vec3(softLight(cb.r, cl.r), softLight(cb.g, cl.g), softLight(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:t===le.HardLight?_`
          vec3 f = vec3(hardLight(cb.r, cl.r), hardLight(cb.g, cl.g), hardLight(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:t===le.VividLight?_`
          vec3 f = vec3(vividLight(cb.r, cl.r), vividLight(cb.g, cl.g), vividLight(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:_``}
    }
  `))}var xr,po,ro;(function(i){i[i.Composite=0]="Composite",i[i.ColorComposite=1]="ColorComposite",i[i.GridComposite=2]="GridComposite",i[i.GroupBackgroundComposite=3]="GroupBackgroundComposite",i[i.COUNT=4]="COUNT"})(xr||(xr={})),function(i){i[i.NotRequired=0]="NotRequired",i[i.Required=1]="Required",i[i.COUNT=2]="COUNT"}(po||(po={})),function(i){i[i.Off=0]="Off",i[i.On=1]="On",i[i.COUNT=2]="COUNT"}(ro||(ro={}));function U$(i,e){const t=e.output===xr.GridComposite,r=e.output===xr.ColorComposite,s=e.output===xr.GroupBackgroundComposite,a=e.output===xr.Composite;t&&(i.extensions.add("GL_OES_standard_derivatives"),i.fragment.include(dS)),r&&i.fragment.uniforms.add(new si("backgroundColor",c=>c.backgroundColor));const n=e.baseOpacityMode===po.Required;if(n&&i.fragment.uniforms.add(new ue("baseOpacity",c=>c.baseOpacity)),a){const c=e.hasWebGL2Context?ms.None:ms.InvSize;i.fragment.uniforms.add(_v("fboColor",h=>h.fboTexture,c))}const o=e.blendMode!==le.Normal,l=e.premultipliedSource===ro.On;i.fragment.include(tK,e),i.fragment.code.add(_`
    vec4 getBackground(vec2 uv) {
      return ${n?_`baseOpacity *`:""} ${s?_`vec4(0.0, 0.0, 0.0, 0.0)`:r?_`vec4(backgroundColor, 1.0)`:t?_`vec4(gridColor(uv), 1.0)`:_`${ia(e,"fboColor","gl_FragCoord.xy")}`};
    }

    vec4 blendLayers(vec4 bgColor, vec4 colorLayer, float opacity) {
      ${o?_`
          vec3 cl = colorLayer.a == 0.0 ? colorLayer.rgb : colorLayer.rgb / colorLayer.a;
          vec3 cb = bgColor.a == 0.0 ? bgColor.rgb : bgColor.rgb / bgColor.a;
          return applyBlendMode(clamp(cl, vec3(0.0), vec3(1.0)), colorLayer.a * opacity, cb, bgColor.a);`:_`
          float composeAlpha = colorLayer.a * opacity;
          return ${!l&&(a&&!n||s)?_`colorLayer * opacity;`:_`bgColor * (1.0 - composeAlpha) + colorLayer * opacity;`}`}
    }`)}let Wv=class extends KY{constructor(e,t,r,s,a,n){super(e,s,a),this.colormap=t,this.symbolizer=r,this.u_colormap=n,this.backgroundColor=on,this.fboTexture=null,this.baseOpacity=1}},iK=class extends Wv{},rK=class extends Wv{};function sK(i){const e=new $t;return e.include(z$),e.include(JY,i),e.include(ZY,i),e.include(U$,i),e.fragment.code.add(_`vec4 applyBackgroundBlend(vec4 layerColor) {
vec4 bgColor = getBackground(vuv);
return blendLayers(bgColor, layerColor, u_opacity);
}`),i.colorizerType===Sd.Stretch?nK(e,i):i.colorizerType===Sd.Lut?aK(e):i.colorizerType===Sd.Hillshade&&oK(e,i),e}function aK(i){i.fragment.code.add(_`void main() {
vec2 pixelLocation = getPixelLocation(uv);
if (isOutside(pixelLocation)) {
gl_FragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));
return;
}
vec4 currentPixel = getPixel(pixelLocation);
gl_FragColor = applyBackgroundBlend(colormap(currentPixel, true));
}`)}function nK(i,e){i.fragment.uniforms.add([new FT("u_bandCount",r=>r.symbolizer.u_bandCount),new Ps("u_minCutOff",r=>r.symbolizer.u_minCutOff,3),new Ps("u_maxCutOff",r=>r.symbolizer.u_maxCutOff,3),new Ps("u_factor",r=>r.symbolizer.u_factor,3),new ue("u_minOutput",r=>r.symbolizer.u_minOutput),new ue("u_maxOutput",r=>r.symbolizer.u_maxOutput),new ih("u_useGamma",r=>r.symbolizer.u_useGamma),new Ps("u_gamma",r=>r.symbolizer.u_gamma,3),new Ps("u_gammaCorrection",r=>r.symbolizer.u_gammaCorrection,3),new ue("u_opacity",r=>r.common.u_opacity)]),i.fragment.code.add(_`float stretchOneValue(float val, float minCutOff, float maxCutOff, float minOutput, float maxOutput, float factor, bool useGamma, float gamma, float gammaCorrection) {
if (val >= maxCutOff) {
return maxOutput;
} else if (val <= minCutOff) {
return minOutput;
}
float stretchedVal;
if (useGamma) {
float tempf = 1.0;
float outRange = maxOutput - minOutput;
float relativeVal = (val - minCutOff) / (maxCutOff - minCutOff);
if (gamma > 1.0) {
tempf -= pow(1.0 / outRange, relativeVal * gammaCorrection);
}
stretchedVal = (tempf * outRange * pow(relativeVal, 1.0 / gamma) + minOutput) / 255.0;
} else {
stretchedVal = minOutput + (val - minCutOff) * factor;
}
return stretchedVal;
}`);const t=e.applyColormap?_`gl_FragColor = applyBackgroundBlend(colormap(vec4(grayVal, grayVal, grayVal, currentPixel.a), !u_useGamma));`:_`gl_FragColor = applyBackgroundBlend(vec4(grayVal, grayVal, grayVal, currentPixel.a));`;i.fragment.code.add(_`
      void main() {
        vec2 pixelLocation = getPixelLocation(uv);
        if (isOutside(pixelLocation)) {
          gl_FragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));
          return;
        }

        vec4 currentPixel = getPixel(pixelLocation);
        ${e.stretchType===zd.Noop?_`
        gl_FragColor = applyBackgroundBlend(currentPixel);`:_`
        if (currentPixel.a == 0.0) {
          gl_FragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));
          return;
        }
        if (u_bandCount == 1) {
          float grayVal = stretchOneValue(currentPixel.r, u_minCutOff[0], u_maxCutOff[0], u_minOutput, u_maxOutput, u_factor[0], u_useGamma, u_gamma[0], u_gammaCorrection[0]);
          ${t}
        } else {
          float redVal = stretchOneValue(currentPixel.r, u_minCutOff[0], u_maxCutOff[0], u_minOutput, u_maxOutput, u_factor[0], u_useGamma, u_gamma[0], u_gammaCorrection[0]);
          float greenVal = stretchOneValue(currentPixel.g, u_minCutOff[1], u_maxCutOff[1], u_minOutput, u_maxOutput, u_factor[1], u_useGamma, u_gamma[1], u_gammaCorrection[1]);
          float blueVal = stretchOneValue(currentPixel.b, u_minCutOff[2], u_maxCutOff[2], u_minOutput, u_maxOutput, u_factor[2], u_useGamma, u_gamma[2], u_gammaCorrection[2]);
          gl_FragColor = applyBackgroundBlend(vec4(redVal, greenVal, blueVal, currentPixel.a));
        }`}
      }`)}function oK(i,e){const t=i.fragment;t.uniforms.add([new lt("u_image",s=>s.u_image),new FT("u_hillshadeType",s=>s.symbolizer.u_hillshadeType),new Ps("u_sinZcosAs",s=>s.symbolizer.u_sinZcosAs,6),new Ps("u_sinZsinAs",s=>s.symbolizer.u_sinZsinAs,6),new Ps("u_cosZs",s=>s.symbolizer.u_cosZs,6),new Ps("u_weights",s=>s.symbolizer.u_weights,6),new pi("u_factor",s=>s.symbolizer.u_factor),new ue("u_minValue",s=>s.symbolizer.u_minValue),new ue("u_maxValue",s=>s.symbolizer.u_maxValue),new pi("u_srcImageSize",s=>s.common.u_srcImageSize)]),t.include(rc),t.code.add(_`vec4 overlay(float val, float minValue, float maxValue, float hillshade, float alpha) {
val = clamp((val - minValue) / (maxValue - minValue), 0.0, 1.0);
vec4 color = colormap(vec4(val, val, val, 1.0), false);
vec3 hsv = rgb2hsv(color.rgb);
hsv.z = hillshade;
return vec4(hsv2rgb(hsv), 1.0) * alpha * color.a;
}`),t.code.add(_`float getNeighborHoodAlpha(float a, float b, float c, float d, float e, float f, float g, float h, float i){
if (a == 0.0 || a == 0.0 || a==0.0 || a == 0.0 || a == 0.0 || a==0.0 || a == 0.0 || a == 0.0 || a==0.0) {
return 0.0;
}  else {
return e;
}
}`);const r=e.applyColormap?_`gl_FragColor = applyBackgroundBlend(overlay(ve.r, u_minValue, u_maxValue, hillshade, alpha));`:_`hillshade *= alpha;
gl_FragColor = applyBackgroundBlend(vec4(hillshade, hillshade, hillshade, alpha));`;t.code.add(_`
    void main() {
      vec2 pixelLocation = getPixelLocation(uv);
      if (isOutside(pixelLocation)) {
        gl_FragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));
        return;
      }

      vec4 currentPixel = getPixel(pixelLocation);
      if (currentPixel.a == 0.0) {
        gl_FragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));
        return;
      }

      //mirror edge pixels
      vec2 axy = vec2(-1.0, -1.0);
      vec2 bxy = vec2(0.0, -1.0);
      vec2 cxy = vec2(1.0, -1.0);
      vec2 dxy = vec2(-1.0, 0.0);
      vec2 fxy = vec2(1.0, 0.0);
      vec2 gxy = vec2(-1.0, 1.0);
      vec2 hxy = vec2(0.0, 1.0);
      vec2 ixy = vec2(1.0, 1.0);
      vec2 onePixel = 1.0 / u_srcImageSize;
      if (pixelLocation.s < onePixel.s) {
        axy[0] = 1.0;
        dxy[0] = 1.0;
        gxy[0] = 1.0;
      }
      if (pixelLocation.t < onePixel.t) {
        axy[1] = 1.0;
        bxy[1] = 1.0;
        cxy[1] = 1.0;
      }
      if (pixelLocation.s > 1.0 - onePixel.s) {
        cxy[0] = -1.0;
        fxy[0] = -1.0;
        ixy[0] = -1.0;
      }
      if (pixelLocation.t > 1.0 - onePixel.t) {
        gxy[1] = -1.0;
        hxy[1] = -1.0;
        ixy[1] = -1.0;
      }

      // calculate hillshade
      vec4 va = texture2D(u_image, pixelLocation + onePixel * axy);
      vec4 vb = texture2D(u_image, pixelLocation + onePixel * bxy);
      vec4 vc = texture2D(u_image, pixelLocation + onePixel * cxy);
      vec4 vd = texture2D(u_image, pixelLocation + onePixel * dxy);
      vec4 ve = texture2D(u_image, pixelLocation);
      vec4 vf = texture2D(u_image, pixelLocation + onePixel * fxy);
      vec4 vg = texture2D(u_image, pixelLocation + onePixel * gxy);
      vec4 vh = texture2D(u_image, pixelLocation + onePixel * hxy);
      vec4 vi = texture2D(u_image, pixelLocation + onePixel * ixy);

      // calculate the rate of z change along the x, y, and diagonal direction
      float dzx = (vc + 2.0 * vf + vi - va - 2.0 * vd - vg).r * u_factor.s;
      float dzy = (vg + 2.0 * vh + vi - va - 2.0 * vb - vc).r * u_factor.t;
      float dzd = sqrt(1.0 + dzx * dzx + dzy * dzy);
      float hillshade = 0.0;

      // traditional single light source
      if (u_hillshadeType == 0){
        float cosDelta = u_sinZsinAs[0] * dzy - u_sinZcosAs[0] * dzx;
        float z = (u_cosZs[0] + cosDelta) / dzd;
        if (z < 0.0)  z = 0.0;
        hillshade = z;
      } else {
        // multi-directional with 6 light sources
        for (int k = 0; k < 6; k++) {
        float cosDelta = u_sinZsinAs[k] * dzy - u_sinZcosAs[k] * dzx;
        float z = (u_cosZs[k] + cosDelta) / dzd;
        if (z < 0.0) z = 0.0;
        hillshade = hillshade + z * u_weights[k];
        if (k == 5) break;
        }
      }

      // set color
      float alpha = getNeighborHoodAlpha(va.a, vb.a, vc.a, vd.a, ve.a, vf.a, vg.a, vh.a, vi.a);
      alpha *= u_opacity;
      ${r}
    }
  `)}const lK=Object.freeze(Object.defineProperty({__proto__:null,ColorizerHillshadeUniforms:rK,ColorizerStretchUniforms:iK,ColorizerUniforms:Wv,build:sK},Symbol.toStringTag,{value:"Module"})),vE={bandCount:3,outMin:0,outMax:1,minCutOff:[0,0,0],maxCutOff:[255,255,255],factor:[1/255,1/255,1/255],useGamma:!1,gamma:[1,1,1],gammaCorrection:[1,1,1],colormap:null,colormapOffset:null,stretchType:"none",type:"stretch"};let cK=class{constructor(e,t,r=null,s=null){this.type="raster-tile",this._memoryUsed=null,this._source=null,this._symbolizerParameters=null,this._bandIds=null,this._interpolation=null,this._dirty=!1,this._transformGrid=null,this.isRendereredSource=!1,this.symbolizerRenderer=null,this.rawPixelData=null,this.lij=null,this.opacity=1,this.lij=e,this.source=t,this.width=r||t.width,this.height=s||t.height}get source(){return this._source}set source(e){this._source=e,this._rasterTexture=De(this._rasterTexture),this._memoryUsed=null}get symbolizerParameters(){return this.isRendereredSource?{...vE,maxCutOff:[1,1,1],factor:[1,1,1]}:this._symbolizerParameters||vE}set symbolizerParameters(e){this._symbolizerParameters=e}get bandIds(){return this._bandIds}set bandIds(e){g(e)&&e.length>0?this._bandIds&&e.every((t,r)=>{var s;return!!((s=this._bandIds)!=null&&s[r])&&t===this._bandIds[r]})||(this._bandIds=e,this._dirty=!0):this._bandIds=null}get interpolation(){return this._interpolation||"nearest"}set interpolation(e){if(this._interpolation=e,g(this._rasterTexture)){const t=this._getRasterTextureInterpolation(e);this._rasterTexture.setSamplingMode(t==="bilinear"?Qt.LINEAR:Qt.NEAREST)}}get transformGrid(){return this._transformGrid}set transformGrid(e){this._transformGrid=e,this._transformGridTexture=De(this._transformGridTexture),this._memoryUsed=null}bind(e){return!!(this.source&&this.source.pixels&&this.source.pixels.length>0)&&((P(this._rasterTexture)||this._dirty)&&this._updateRasterTexture(e,this.bandIds),g(this._rasterTexture)&&(this._updateColormapTexture(e),this.transformGrid&&P(this._transformGridTexture)&&(this._transformGridTexture=i8(e,this.transformGrid))),!0)}getUniforms(){const{symbolizerParameters:e,transformGrid:t,width:r,height:s,opacity:a}=this,n=r8(t,[r,s],[this.source.width,this.source.height],a),o=s8(e.colormap,e.colormapOffset),l=this.symbolizerParameters.type==="stretch"?a8(this.symbolizerParameters):null,c=this.symbolizerParameters.type==="hillshade"?n8(this.symbolizerParameters):null;return new Wv(n,o,l||c,this._rasterTexture,this._transformGridTexture,this._colormapTexture)}get memoryUsage(){if(P(this._memoryUsed)){const e=[this._rasterTexture,this._transformGridTexture,this._colormapTexture];this._memoryUsed=e.map(t=>g(t)?t.descriptor.width*t.descriptor.height*4:0).reduce((t,r)=>t+r,0)}return this._memoryUsed}release(){return this._rasterTexture=De(this._rasterTexture),this._transformGridTexture=De(this._transformGridTexture),this._colormapTexture=De(this._colormapTexture),this.source=null,this.transformGrid=null,this.rawPixelData=null,!0}_updateRasterTexture(e,t){const r=this.source?this.source.extractBands(t):null;if(!(r&&r.pixels&&r.pixels.length>0))return void(this._rasterTexture=De(this._rasterTexture));const s=P(t)&&P(this.bandIds)||g(t)&&g(this.bandIds)&&t.join("")===this.bandIds.join("");if(g(this._rasterTexture)&&s)return;this._rasterTexture=De(this._rasterTexture);const a=this._getRasterTextureInterpolation(this.interpolation);this._rasterTexture=o8(e,r,a,this.isRendereredSource||this.hasStretchTypeNone())}hasStretchTypeNone(){return"stretchType"in this.symbolizerParameters&&this.symbolizerParameters.stretchType==="none"&&!this.symbolizerParameters.useGamma&&this.source.pixelType==="u8"}_getRasterTextureInterpolation(e){return this.symbolizerParameters.type==="lut"||e==="nearest"||e==="majority"?"nearest":"bilinear"}_updateColormapTexture(e){const t=this._colormap,r=this.symbolizerParameters.colormap;return r?t?r.length!==t.length||r.some((s,a)=>s!==t[a])?(this._colormapTexture=De(this._colormapTexture),this._colormapTexture=x2(e,r),void(this._colormap=r)):void 0:(this._colormapTexture=x2(e,r),void(this._colormap=r)):(this._colormapTexture=De(this._colormapTexture),void(this._colormap=null))}},Y0=class{constructor(){this.waitingAgents=new At,this._upsampleInfo=null,this.loadingAgent=null,this.requestPromise=null,this.requestAbort=null,this.pendingUpdates=0}static acquire(e){const t=Qb.acquire();return t._init(e),t}release(){this.dispose(),K0.delete(this),Qb.release(this)}dispose(){this.loadingAgent=De(this.loadingAgent),this.abortRequest(),this._unsetUpsampleInfo(),this.pendingUpdates=0,this._data=Mp(this._data)}static prune(){Qb.prune(0)}_init(e){this.waitingAgents.clear(),this._data=Mp(this._data),this.dataMissing=!1,this.dataInvalidated=!1,this._unsetUpsampleInfo(),this.abortRequest(),this.loadingAgent=null,this.pendingUpdates=0,this._pool=e,this.elevationBounds=null}invalidateSourceData(){this.dataInvalidated=!0,this.dataMissing=!1,this._unsetUpsampleInfo()}abortRequest(){this.requestAbort=Th(this.requestAbort),this.requestPromise=null}get upsampleInfo(){return this._upsampleInfo}_unsetUpsampleInfo(){g(this._upsampleInfo)&&(this._upsampleInfo.tile.unrefMapData(),this._pool.release(this._upsampleInfo),this._upsampleInfo=null)}setUpsampleInfo(e,t){if(e===t||P(t))this._unsetUpsampleInfo();else{if(P(this._upsampleInfo))this._upsampleInfo=this._pool.acquire();else{if(this._upsampleInfo.tile===t)return;this._upsampleInfo.tile.unrefMapData()}t.refMapData(),WY(e,t,this._upsampleInfo)}}get data(){return this._data}set data(e){Mp(this._data),this._data=e}};const Qb=new lo(Y0,null,()=>{}),K0=new Map;function hK(){K0.size>0&&(console.log(`${K0.size} live TilePerLayerInfo allocations:`),K0.forEach(i=>console.log(i,`
`)))}let lp=class{constructor(e){this._texture=e,this.type="tile-texture",this._refCount=1}retain(){++this._refCount}release(){--this._refCount,this._refCount===0&&this._texture.dispose()}get texture(){return this._texture}generateMipmap(){this._texture.generateMipmap()}get descriptor(){return this._texture.descriptor}};var Le;(function(i){i[i.NONE=0]="NONE",i[i.NONE_HIT_MAXLOD=1]="NONE_HIT_MAXLOD",i[i.SPLIT=2]="SPLIT",i[i.VSPLITMERGE=4]="VSPLITMERGE",i[i.MERGE=8]="MERGE",i[i.RENDERDATA=16]="RENDERDATA",i[i.GEOMETRY=32]="GEOMETRY",i[i.TEXTURE_NOFADING=64]="TEXTURE_NOFADING",i[i.TEXTURE_FADING=128]="TEXTURE_FADING"})(Le||(Le={}));const Zb=T(),Bu=T(),Dr=T(),dK=.1;let uS=class{constructor(){this.lij=[0,0,0],this._children=[null,null,null,null],this._pendingUpdates=0,this.renderData=null,this._dirty=!0,this._previouslyRendered=!1,this.extent=yt(),this._elevationBounds=$e(),this.layerInfo=[[],[]],this.extentInRadians=yt(),this.centerAtSeaLevel=T(),this._center=[T(),Nn(),T()],this.up=YN(),this._isWithinClippingArea=!0,this._intersectsClippingArea=!0,this._maxTesselation=0,this._usedMemory=null,this._mapTileMemoryInternal=0,this._mapDataRefCount=0,this.screenDepth=0,this.renderOrder=0,this._edgeLen=0,this._edgeLen2=0,this._curvatureHeight=0,this.extentMidX=0,this.extentMidY=0,this.distanceToPOI=-1,this._lastPOI=T()}static prune(){pS.prune(0),mS.prune(0),Y0.prune()}get _isCached(){return!this.shouldLoad&&this._mapDataRefCount<=0}get maxTesselation(){return this._maxTesselation}get isWithinClippingArea(){return this._isWithinClippingArea}get intersectsClippingArea(){return this._intersectsClippingArea}get clippingArea(){return this._clippingArea}get parent(){return this._parent}get children(){return this._children}get surface(){return this._surface}get elevationBounds(){return this._elevationBounds}get level(){return this.lij[0]}get key(){return`${this.lij[0]}/${this.lij[1]}/${this.lij[2]}`}get edgeLen(){return this._edgeLen}get radius(){return this._center[ji.MIDDLE][3]}get visible(){return this._dirty&&this.computeVisibility(),this._visible}get frustumVisibility(){return this._dirty&&this.computeVisibility(),this._frustumVisibility}computeVisibility(){var r;this._dirty=!1;const e=((r=this.parent)==null?void 0:r.frustumVisibility)??cs.INTERSECTS;this._frustumVisibility=e===cs.INSIDE?cs.INSIDE:e===cs.OUTSIDE?cs.OUTSIDE:this._calculateFrustumVisibilityStatus(this.surface.frustum);const t=this._frustumVisibility!==cs.OUTSIDE&&this._intersectsClippingArea;t!==this._visible&&(this._visible=t,this._surface.emit("tiles-visibility-changed"),this._surface.renderer.setDirty(),this.updateAgentSuspension())}get loadable(){return this.visible||this._surface.view.state.fixedContentCamera}get rendered(){const e=!!this.renderData;return e!==this._previouslyRendered&&(this._surface.emit("tiles-visibility-changed"),this._previouslyRendered=e,this._surface.renderer.setDirty()),e}get shouldLoad(){const e=this._surface.snapLevel;if(g(e)){const t=this.level-e;if(t===0)return!0;if(t===1)return!1}return this.isLeaf}init(e,t,r){this.lij[0]=e[0],this.lij[1]=e[1],this.lij[2]=e[2],this.ellipsoid=Et(r.tilingScheme.spatialReference),r.tilingScheme.getExtent(e[0],e[1],e[2],this.extent),r.tilingScheme.convertExtentToRadians(this.extent,this.extentInRadians),this.extentMidX=.5*(this.extent[0]+this.extent[2]),this.extentMidY=.5*(this.extent[1]+this.extent[3]),this._isWithinClippingArea=!0,this._intersectsClippingArea=!0,this._clippingArea=null,this._mapDataRefCount=0,r.upsampleMapCache.pop(this.key),this._edgeLen=0,this._edgeLen2=0,this._center[ji.MIDDLE][3]=0,this.vlevel=e?e[0]:0,t&&t.elevationBounds?fs(this._elevationBounds,t.elevationBounds):zt(this._elevationBounds,0,0),this._pendingUpdates=0,this.renderData=null,this.screenDepth=0,this._visible=!1,this._previouslyRendered=!1,this._parent=t,this.unsetChildren(),this._surface=r,this.updateVisibility();for(const s of cd){const a=r.numLayers(s),n=this.layerInfo[s];for(const o of n)o.release();n.length=a;for(let o=0;o<a;o++)n[o]=Y0.acquire(this._surface.upsampleInfoPool),s===ot.ELEVATION&&this.findElevationBoundsForLayer(o,-1)}this.computeElevationBounds(),this._maxTesselation=Math.min(r.tilingScheme.pixelSize,Xm)}release(){Xo(!this.renderData,"tile.renderData was not unloaded"),this._surface.upsampleMapCache.pop(this.key);for(const e of cd){for(const t of this.layerInfo[e])t.release();this.layerInfo[e].length=0}this._parent=null;for(let e=0;e<4;++e)this._children[e]=null;this._surface=null,this.setMemoryDirty()}refMapData(){++this._mapDataRefCount,this._isCached||this._surface.upsampleMapCache.pop(this.key)}unrefMapData(){if(--this._mapDataRefCount,this._isCached){this.setMemoryDirty();const e=this._cachedMemory;e>0&&this._surface.upsampleMapCache.put(this.key,this,e)}}setMemoryDirty(){this._usedMemory=null}get usedMemory(){return this._ensureUsedMemory()+(this._isCached?0:this._mapTileMemoryInternal)}get _cachedMemory(){return this._isCached?this._mapTileMemory:0}get _mapTileMemory(){return this._ensureUsedMemory(),this.layerInfo[ot.MAP].reduce((e,t)=>e+(t instanceof v1?t.memoryUsage:0),this._mapTileMemoryInternal)}get _cpuImageMemorySize(){const t=this._surface.tilingScheme.pixelSize;return t*t*4}_ensureUsedMemory(){if(g(this._usedMemory))return this._usedMemory;this._usedMemory=0,this._mapTileMemoryInternal=0;let e=0;for(const{data:r}of this.layerInfo[ot.MAP])r instanceof v1?e+=this._getTerrainDataMemory(r):this._mapTileMemoryInternal+=this._getTerrainDataMemory(r);const t=this._cpuImageMemorySize;for(const r of this.layerInfo[ot.ELEVATION])this._usedMemory+=r.data?t:0;return this.renderData&&(this._usedMemory+=this.renderData.estimatedGeometryMemoryUsage,this._mapTileMemoryInternal+=my(this.renderData.textureDescriptor)),this._isCached&&this._surface.upsampleMapCache.updateSize(this.key,this,this._mapTileMemoryInternal+e),this._usedMemory}getUsedMemoryForLayer(e,t){const r=this.layerInfo[e][t];return r!=null&&r.data?e===ot.MAP?this._isCached?0:this._getTerrainDataMemory(r.data):e===ot.ELEVATION?this._cpuImageMemorySize:0:0}_getTerrainDataMemory(e){return e instanceof lp?my(e.texture):e instanceof HTMLImageElement||e instanceof kv?this._cpuImageMemorySize:e instanceof v1||e instanceof cK?e.memoryUsage:0}updateScreenDepth(e){const t=this._center[ji.MIDDLE],r=e,s=t[0],a=t[1],n=t[2],o=r[2]*s+r[6]*a+r[10]*n+r[14];this.screenDepth=o<0?0:o/(r[3]*s+r[7]*a+r[11]*n+r[15])}shouldSplit(e,t,r){if(!this.visible||g(e.frustum)&&(!this._intersectsClippingArea||this._calculateFrustumVisibilityStatus(e.frustum)===cs.OUTSIDE))return Le.NONE;const s=this.level;Q(Zb,this._center[ji.MIDDLE],t);let a=sn(Zb),n=ji.MIDDLE;Q(Bu,this._center[ji.TOP],t);const o=sn(Bu);o<a&&(a=o,n=ji.TOP),Q(Bu,this._center[ji.BOTTOM],t);const l=sn(Bu);if(l<a&&(a=l,n=ji.BOTTOM),this._edgeLen2>a&&s<e.maxLod)return Le.SPLIT;const c=Math.sqrt(a),h=e.fovX*c*2,u=this._edgeLen/h,p=()=>{const b=s+Math.ceil(-Math.log2(e.relativeWidthLimit/u));return b!==this.vlevel?(this.vlevel=b,Le.VSPLITMERGE):Le.NONE_HIT_MAXLOD};if(g(r)&&r-s===1)return s>=e.maxLod?p():Le.SPLIT;const m=J(this.up,Zb),f=this._elevationBounds[1]-this._elevationBounds[0],y=f/this.edgeLen;if(e.aboveGround&&m>0&&y<.001&&m/c-Math.sin(this._curvatureHeight/(this.edgeLen*Math.SQRT1_2)*Math.PI)-y>0)return Le.NONE;if(u<e.relativeWidthLimit)return this.vlevel!==this.level?(this.vlevel=this.level,Le.VSPLITMERGE):Le.NONE;if(s>=e.maxLod)return p();if(s>6){Q(Bu,this._center[n],t),B(Dr,this.up,m),Q(Dr,Dr,Bu);const b=sn(Dr);if(b>this.radius*this.radius){B(Dr,Dr,this.radius/Math.sqrt(b)),X(Dr,Dr,this._center[n]),Q(Dr,t,Dr);const x=Math.min(1,(Math.abs(J(Dr,this.up))+.5*f+this._curvatureHeight)/pe(Dr)),S=dK/e.angledSplitBias,C=e.fovY*c*2;if(x*(this._edgeLen/C)<S*e.relativeHeightLimit)return Le.NONE}}return Le.SPLIT}setChildren(e,t,r,s){Xo(!!(e&&t&&r&&s),"Null child passed"),this._children[0]=e,this._children[1]=t,this._children[2]=r,this._children[3]=s}unsetChildren(){this._children[0]=null,this._children[1]=null,this._children[2]=null,this._children[3]=null}get isLoaded(){var e;return((e=this.renderData)==null?void 0:e.hasGeometry)??!1}load(){this.refMapData();for(const e of cd)this._createOrUpdateAgents(0,e);this.surface.renderer.loadTile(this)}unload(e){e.unloadTile(this);for(const t of cd){const r=this.layerInfo[t];for(const s of r)s.loadingAgent&&s.loadingAgent!==va&&(g0(s.loadingAgent),s.loadingAgent=null),s.pendingUpdates=0}this.resetPendingUpdate(Le.GEOMETRY),this.resetPendingUpdate(Le.TEXTURE_NOFADING),this.resetPendingUpdate(Le.TEXTURE_FADING),this.unrefMapData()}unloadMapData(){const e=this.layerInfo[ot.MAP];for(const t of e)t.loadingAgent&&t.loadingAgent!==va&&(g0(t.loadingAgent),t.loadingAgent=null),t.pendingUpdates=0;this.renderData&&this.renderData.releaseTexture(),this.setMemoryDirty()}updateClippingStatus(e){if(xd(e,this._clippingArea))return!1;const t=this._intersectsClippingArea,r=this._isWithinClippingArea;g(e)?(this._intersectsClippingArea=this.intersectsExtent(e),this._isWithinClippingArea=this._isWithinExtent(e)):(this._intersectsClippingArea=!0,this._isWithinClippingArea=!0),this._clippingArea=e,this.updateVisibility();const s=r&&this._isWithinClippingArea,a=!(r||t||this._isWithinClippingArea||this._intersectsClippingArea);return!this.renderData||s||a||this.setPendingUpdate(Le.GEOMETRY),!0}updateVisibility(){this._dirty=!0,this._surface.setTileTreeDirty()}getLayerInfo(e,t){return this.layerInfo[t][e]}hasLayerData(e,t){const r=this.layerInfo[t][e];return!(!r||!r.data||r.dataInvalidated)}get updating(){if(this.hasPendingUpdates)return!0;for(const e of cd){const t=this.layerInfo[e];for(const r of t)if(r.loadingAgent&&r.loadingAgent!==va&&r.loadingAgent.updating)return!0}return!1}_isSuspended(e){return!!this.hasPendingUpdate(Le.SPLIT)||e!==ot.ELEVATION&&!this.loadable}get hasPendingUpdates(){return this._pendingUpdates!==0}hasPendingUpdate(e){return(this._pendingUpdates&e)===e}setPendingUpdate(e){this._pendingUpdates|=e,e===Le.SPLIT||e===Le.MERGE?this._surface.setTileTreeDirty():this._surface.requestUpdate()}resetPendingUpdate(e){return!!this.hasPendingUpdate(e)&&(this._pendingUpdates&=~e,!0)}requestLayerData(e,t,r){const s=this.layerInfo[t][e];if(s.waitingAgents.has(r))return console.warn("agent already requested this piece of map data (tile %s, agent tile %s, layer: %d/%d)",this.lij.toString(),r.tile.lij.toString(),t,e),!0;if(s.waitingAgents.push(r),s.data&&!s.dataInvalidated)return console.warn("agent requested existing data (tile %s, agent tile %s, layer: %d/%d)",this.lij.toString(),r.tile.lij.toString(),t,e),r.dataArrived(this),!0;if(s.requestPromise)return!0;Th(s.requestAbort),s.requestAbort=new AbortController;const a=this._surface.requestTileData(this,e,t,s.requestAbort);if(!a)return s.requestAbort=null,!1;const n=()=>{s.requestPromise===a&&(s.requestPromise=null,s.requestAbort=null)};return s.requestPromise=a,a.then(n,n),!0}get isLeaf(){return this._children[0]==null}hasLij(e){return this.lij[0]===e[0]&&this.lij[1]===e[1]&&this.lij[2]===e[2]}findByLij(e){if(this.hasLij(e))return this;const t=this._children;return t[0]?t[0].findByLij(e)||t[1].findByLij(e)||t[2].findByLij(e)||t[3].findByLij(e):null}distanceToSquared(e){return sn(Q(Dr,this._center[ji.MIDDLE],e))}containsPoint(e){const t=this.extent;return e[0]>=t[0]&&e[1]>=t[1]&&e[0]<=t[2]&&e[1]<=t[3]}containsPointXY(e,t){const r=this.extent;return e>=r[0]&&t>=r[1]&&e<=r[2]&&t<=r[3]}unrequestLayerData(e,t,r){const s=this.layerInfo[t][e],a=s.waitingAgents,n=a.removeUnordered(r)!=null;Xo(n,"agent has not requested this piece of map data"),a.length<1&&(s.abortRequest(),this.setMemoryDirty())}dataArrived(e,t,r){const s=this.layerInfo[t][e];s.data=r,s.dataInvalidated=!1,s.waitingAgents.forAll(a=>a.dataArrived(this)),s.waitingAgents.clear(),this.setMemoryDirty()}dataMissing(e,t,r){r.notInTilemap||console.error(`Tile ${this.lij.toString()} layer ${t}/${e} error ${r}`);const s=this.layerInfo[t][e];s.dataMissing=!0,s.waitingAgents.forAll(a=>a.dataMissing()),s.waitingAgents.clear(),this.setMemoryDirty()}updateRenderData(e,t){switch(e){case ot.MAP:return this._updateTexture(t);case ot.ELEVATION:return this._updateGeometry()}}_updateTexture(e){this.renderData&&(this.resetPendingUpdate(e===or.FADING?Le.TEXTURE_NOFADING:Le.TEXTURE_FADING),this.setPendingUpdate(e===or.FADING?Le.TEXTURE_FADING:Le.TEXTURE_NOFADING))}_updateGeometry(){this.setPendingUpdate(Le.GEOMETRY);for(const e of this.layerInfo[ot.ELEVATION])e.pendingUpdates|=Le.GEOMETRY}invalidateLayerData(e,t){this.layerInfo[t][e].invalidateSourceData(),this.restartAgents(t)}computeElevationBounds(){const e=this._elevationBounds,t=e[0],r=e[1];zt(e,1/0,-1/0);const s=this.layerInfo[ot.ELEVATION];let a=!0;for(const n of s)g(n.elevationBounds)&&(e[0]=Math.min(e[0],n.elevationBounds.min),e[1]=Math.max(e[1],n.elevationBounds.max),n.elevationBounds.hasNoDataValues||(a=!1));a&&(e[0]=Math.min(e[0],0),e[1]=Math.max(e[1],0)),t===e[0]&&r===e[1]||(this.updateRadiusAndCenter(),this._surface.setTileTreeDirty())}_updateCenter(){const e=this._elevationBounds,t=.5*(e[0]+e[1]),r=this._center;B(Dr,this.up,t),X(r[ji.MIDDLE],this.centerAtSeaLevel,Dr),B(Dr,this.up,e[0]),X(r[ji.TOP],this.centerAtSeaLevel,Dr),B(Dr,this.up,e[1]),X(r[ji.BOTTOM],this.centerAtSeaLevel,Dr)}findElevationBoundsForLayer(e,t){const r=this.layerInfo[ot.ELEVATION][e],s=Ix(this.level),a=Math.max(this.vlevel-s,0),n=r.elevationBounds;if(g(n)&&n.level>=t&&n.level<=a)return;const o=this._surface.layerViewByIndex(e,ot.ELEVATION),l=Fw(o);if(!zg(this,l,!1))return;const c=pK;let h=!1;const u=r.data;if(u&&u.level<=a){const p=r.data;c.min=p.samplerData.data.minValue,c.max=p.samplerData.data.maxValue,c.hasNoDataValues=p.samplerData.data.hasNoDataValues,c.level=this.level,h=!0}else{let p,m,f=0;for(let y=this._parent;y&&(!m||f<s)&&(f=this.vlevel-y.level,p=m||p,m=y.layerInfo[ot.ELEVATION][e].data,!(!m&&p&&y.level<=a));y=y.parent);m=m||p,m&&(m.computeMinMaxValue(this.lij[0],this.lij[1],this.lij[2],c),c.min!==1/0&&(c.level=m.level,h=!0))}h&&(P(r.elevationBounds)&&(r.elevationBounds=new xp),r.elevationBounds.copyFrom(c))}modifyLayers(e,t,r){const s=this.layerInfo[r];for(const o of s)o.loadingAgent&&o.loadingAgent!==va&&(g0(o.loadingAgent),o.loadingAgent=null),o.waitingAgents.clear();for(let o=0;o<s.length;++o)e[o]===void 0&&s[o].release();const a=new Array(...s),n=t.length;s.length=n;for(let o=0;o<n;o++){const l=t[o];s[o]=l>-1?a[l]:Y0.acquire(this._surface.upsampleInfoPool)}this.setMemoryDirty()}restartAgents(e){this.renderData&&(this._createOrUpdateAgents(0,e),this.updateRenderData(e,or.FADING))}updateAgents(e){if(this.renderData){const t=this.layerInfo[e];for(const r of t)r.loadingAgent===va&&(r.loadingAgent=null);this._createOrUpdateAgents(0,e)}}updateAgentSuspension(){for(const e of cd){const t=this._isSuspended(e);for(const r of this.layerInfo[e])r.loadingAgent&&r.loadingAgent!==va&&(r.loadingAgent.setSuspension(t),r.loadingAgent===va&&this.updateRenderData(e,or.FADING))}}removeLayerAgent(e,t){const r=this.layerInfo[t][e];r.loadingAgent&&r.loadingAgent!==va&&r.loadingAgent.dispose(),r.loadingAgent=null}agentDone(e,t){const r=this.layerInfo[t][e];r.loadingAgent=va,!r.data&&P(r.upsampleInfo)&&this._createOrUpdateAgents(e+1,t)}_hasBlendableAncestor(e){return e.blendMode!=="normal"||Vp(e.parent)&&this._hasBlendableAncestor(e.parent)}_hasBlendModes(e,t,r){var s,a,n;for(let o=e;o<t;++o){const l=this._surface.layerViewByIndex(o,r);if(Yy(l)&&((s=l==null?void 0:l.layer)==null?void 0:s.blendMode)!=="normal"||Vp((a=l==null?void 0:l.layer)==null?void 0:a.parent)&&this._hasBlendableAncestor((n=l==null?void 0:l.layer)==null?void 0:n.parent))return!0}return!1}_createOrUpdateAgents(e,t){const r=this.layerInfo[t];if(r.length===0)return;const s=this._isSuspended(t);for(let a=e;a<r.length;++a){const n=r[a];let o=!1;const l=this._surface.layerViewByIndex(a,t),c=Fw(l);if(n.loadingAgent?zg(this,c,!1)?(n.loadingAgent!==va&&n.loadingAgent.setSuspension(s),n.loadingAgent!==va&&(o=n.loadingAgent.update())):n.dispose():zg(this,c,!1)&&(n.loadingAgent=uK(this,a,t,s),o=n.loadingAgent.startLoading(),o?n.loadingAgent===va&&this.setPendingUpdate(Le.GEOMETRY):(g0(n.loadingAgent),n.loadingAgent=va)),n.loadingAgent===va&&this.updateRenderData(t,or.FADING),!this._hasBlendModes(e,r.length,t)&&o&&l.isOpaque)return}}_isWithinExtent(e){const t=this.extent;return t[0]>=e[0]&&e[2]>=t[2]&&t[1]>=e[1]&&e[3]>=t[3]}intersectsExtent(e){const t=this.extent;return t[2]>=e[0]&&e[2]>=t[0]&&t[3]>=e[1]&&e[3]>=t[1]}getElevationVerticesPerSide(e){const t=this.vlevel-this.level,r=Math.max(this.level-e,Ix(this.level)-t),s=ee(1+(this.maxTesselation>>r),2,this.maxTesselation+1),a=this.getDefaultVerticesPerSide();return Math.max(s,a)}get test(){return{cachedMemory:this._cachedMemory}}_findLIJ(e,t){if(!e)return null;const r=this.surface.rootTiles;if(g(r)){for(const s of r)if(mK(s,e)){let a=s,n=e[0]-a.level-1;for(;n>=0&&!a.isLeaf&&!t(a);){const o=e[1]>>n&1,l=e[2]>>n&1;a=a.children[2*o+l],n--}return t(a)?a:null}}return null}findNeighborTile(e,t){const r=this.lij,s=this.getNeighborLIJ(r,e);return s?gK(r,s)?t(this)?this:null:this._findLIJ(s,t):null}findCorner(e,t){const r=e===ze.NORTH_EAST?1:e===ze.NORTH_WEST?0:e===ze.SOUTH_WEST?2:3;let s=this;for(;s.children[0]&&(!t||!t(s));)s=s.children[r];return s}findNeighborCornerTileExact(e,t){var r;return((r=this.findNeighborTile(e,s=>t(s)||s.level===this.level))==null?void 0:r.findCorner(Vw(e),t))||null}forAllSubtreeOnSide(e,t){const r=e===ze.NORTH?[0,1]:e===ze.NORTH_EAST?[1]:e===ze.EAST?[1,3]:e===ze.SOUTH_EAST?[3]:e===ze.SOUTH?[2,3]:e===ze.SOUTH_WEST?[2]:e===ze.WEST?[0,2]:[0],s=a=>{const n=a.children;!t(a)&&n[0]&&r.forEach(o=>s(n[o]))};s(this)}forallNeighbors(e){Jy.forEach(t=>this.findNeighborCornerTileExact(t,e)),al.forEach(t=>{var r;return(r=this.findNeighborTile(t,s=>s.level===this.level||e(s)))==null?void 0:r.forAllSubtreeOnSide(Ky(t),e)})}getNeighborEdgeStartVertexIndex(e,t){if(!t)return 0;const r=this.level-t.level;if(Z(!ur||r>=0),r===0)return 0;const s=2**r,a=(1&e)==1,n=a?0:1,o=t.lij[n+1]*s,l=this.lij[n+1],c=l-o,h=a?s-1-c:c;return ur&&(Z(o<=l&&l<o+s),Z(0<=h&&h<s)),h}forEachLoadedNeighbor(e){const t=this.level,r=s=>s.level===t||s.isLoaded;al.forEach(s=>{const a=this.findNeighborTile(s,r);a!=null&&a!==this&&a.forAllSubtreeOnSide(Ky(s),n=>!!n.isLoaded&&(e(n,s),!0))}),Jy.forEach(s=>{var n;const a=(n=this.findNeighborTile(s,r))==null?void 0:n.findCorner(Vw(s),o=>o.isLoaded);Z(!a||jw(this,a,s)),a!=null&&a.isLoaded&&e(a,s)})}getNeighborLIJ(e,t){const r=hE(t)?-1:cE(t)?1:0,s=oE(t)?-1:lE(t)?1:0,a=[e[0],e[1]+r,e[2]+s];return a[1]<0?null:this.surface.isGlobal?this.wrapLIJ(a):a[2]<0?null:a}wrapLIJ(e){return!e||e[1]<0||e[1]>=2**e[0]?null:this.surface.wrapEastWest(e)}get westNeighborWestExtent(){return this.extent[0]*(this.isWestEnd?-1:1)}get eastNeighborEastExtent(){return this.extent[2]*(this.isEastEnd?-1:1)}get isEastEnd(){return this.lij[2]===this.surface.lijEastEnd(this.level)-1}get isWestEnd(){return this.lij[2]===0}get isNorthEnd(){return this.lij[1]===0}get isSouthEnd(){return this.extent[1]+vT()>=this.surface.extent[1]}checkGeometryWaterproofness(){var e;Qy&&(Z(this.isLoaded),(e=this.renderData)==null||e.checkGeometryWaterproofness())}shouldHaveNeighbor(e){const t=this.extent,r=this.surface.rootTilesExtent,s=.25*(t[2]-t[0]);if(hE(e)&&t[3]+s>=r[3]||cE(e)&&t[1]-s<=r[1])return!1;const a=this.surface.isGlobal;return!(!a&&oE(e)&&t[0]-s<=r[0])&&!(!a&&lE(e)&&t[2]+s>=r[2])}updateDistanceToPOI(e){const t=this._lastPOI;if(this.distanceToPOI>=0&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return;H(this._lastPOI,e);const r=this._center[ji.MIDDLE],s=e[0]-r[0],a=e[1]-r[1],n=e[2]-r[2];this.distanceToPOI=s*s+a*a+n*n}};function uK(i,e,t,r){const s=t===ot.ELEVATION?mS.acquire():pS.acquire();return s.init(i,e,t,r),s}function g0(i){i.dispose(),i instanceof $$?mS.release(i):i instanceof N$&&pS.release(i)}const pS=new lo(N$),mS=new lo($$),pK=new xp;var ji;function mK(i,e){const t=i.level,r=e[0];if(t>r)return!1;const s=r-t,a=Math.floor(e[1]/2**s),n=Math.floor(e[2]/2**s);return a===i.lij[1]&&n===i.lij[2]}function gK(i,e){return i[0]===e[0]&&i[1]===e[1]&&i[2]===e[2]}function fK(i,e,t){if(P(i)||P(e))return!1;if(i.level===0&&e.level===0&&(i.isEastEnd&&e.isWestEnd&&t===ze.EAST||i.isWestEnd&&e.isEastEnd&&t===ze.WEST))return!0;const r=Math.max(1e-6*(i.extent[2]-i.extent[0]),1);switch(t){case ze.NORTH:return Pn(i.extent[3],e.extent[1],r);case ze.SOUTH:return Pn(i.extent[1],e.extent[3],r);case ze.EAST:return Pn(i.extent[2],e.extent[0],r)||Pn(i.extent[2],-e.extent[0],r);case ze.WEST:return Pn(i.extent[0],e.extent[2],r)||Pn(i.extent[0],-e.extent[2],r)}}function jw(i,e,t){return!P(i)&&!P(e)&&e!==i&&(i.level>=e.level?bE(i,e,t):bE(e,i,Vw(t)))}function bE(i,e,t){Z(i.level>=e.level);const r=eY(t),s=tY(t),a=i.extent,n=e.extent,o=[r?a[0]:a[2],s?a[3]:a[1]],l=[r?n[2]:n[0],s?n[1]:n[3]],c=1e-5*(a[2]-a[0]),h=Pn(o[0],l[0],c)||i.surface.isGlobal&&Pn(o[0],-l[0],c),u=Pn(o[1],l[1],c);if(h&&u)return!0;if(i.level===e.level||!h&&!u)return Z(!1),!1;const p=h?xE(n[1],n[3],a[1],a[3],c):xE(n[0],n[2],a[0],a[2],c);return Z(p),p}function xE(i,e,t,r,s=vT()){return i-s<=t&&t<=r&&r<=e+s}(function(i){i[i.TOP=0]="TOP",i[i.MIDDLE=1]="MIDDLE",i[i.BOTTOM=2]="BOTTOM"})(ji||(ji={}));let _K=class{constructor(){this._scales=hi(-1,-1,-1,-1),this._offsets=hi(-1,-1,-1,-1)}clear(){this._scales[0]=this._scales[1]=this._scales[2]=this._scales[3]=-1,this._offsets[0]=this._offsets[1]=this._offsets[2]=this._offsets[3]=-1}setScale(e,t,r){this._scales[2*e]=t,this._scales[2*e+1]=r}setOffset(e,t,r){this._offsets[2*e]=t,this._offsets[2*e+1]=r}get scales(){return this._scales}get offsets(){return this._offsets}};function yK(i,e){i.varyings.add("tbnTangent","vec3"),i.varyings.add("tbnBiTangent","vec3"),e.spherical?i.vertex.code.add(_`void forwardVertexTangent(vec3 n) {
tbnTangent = normalize(cross(vec3(0.0, 0.0, 1.0), n));
tbnBiTangent = normalize(cross(n, tbnTangent));
}`):i.vertex.code.add(_`void forwardVertexTangent(vec3 n) {
tbnTangent = vec3(1.0, 0.0, 0.0);
tbnBiTangent = normalize(cross(n, tbnTangent));
}`),i.fragment.code.add(_`mat3 getTBNMatrix(vec3 n) {
return mat3(tbnTangent, tbnBiTangent, n);
}`)}let gS=class extends LF{constructor(){super(...arguments),this.slicePlaneLocalOrigin=T(),this.origin=this.slicePlaneLocalOrigin}};var Da;(function(i){i[i.Material=0]="Material",i[i.ShadowMap=1]="ShadowMap",i[i.Highlight=2]="Highlight"})(Da||(Da={}));let vK=class extends gS{constructor(){super(...arguments),this.identifier=Da.Material,this.output=A.Color,this.transparent=!1,this.integratedMesh=!1}},bK=class extends gS{constructor(){super(...arguments),this.identifier=Da.ShadowMap}},xK=class extends gS{constructor(){super(...arguments),this.identifier=Da.Highlight}},ev=class extends Ch{constructor(e,t){super(e,"vec4",fv.Draw,(r,s,a)=>r.setUniform4fv(e,t(s,a)))}};var Wl;function wK(i,e){const{vertex:t,fragment:r}=i;t.uniforms.add([new ev("overlayTexOffset",(s,a)=>TK(s,a)),new ev("overlayTexScale",(s,a)=>CK(s,a))]),r.constants.add("overlayOpacity","float",1),r.uniforms.add(new lt("ovColorTex",(s,a)=>qw(s,a))),V$(i,e)}function V$(i,e){i.extensions.add("GL_OES_standard_derivatives"),e.pbrMode!==Wt.Water&&e.pbrMode!==Wt.WaterOnIntegratedMesh&&e.pbrMode!==Wt.TerrainWithWater||i.include(SL,e);const{vertex:t,fragment:r}=i;i.varyings.add("vtcOverlay","vec4"),t.code.add(_`void setOverlayVTC(in vec2 uv) {
vtcOverlay = vec4(uv, uv) * overlayTexScale + overlayTexOffset;
}`),r.code.add(_`bool isValid(vec2 uv, vec2 dxdy) {
return (uv.x >= 0.0 + dxdy.x) && (uv.x <= 1.0 - dxdy.x) && (uv.y >= 0.0 + dxdy.y) && (uv.y <= 1.0 - dxdy.y);
}
vec4 getOverlayColor(sampler2D ov0Tex, vec4 texCoords) {
vec4 color0 = texture2D(ov0Tex, vec2(texCoords.x * 0.5, texCoords.y));
vec4 color1 = texture2D(ov0Tex, vec2(texCoords.z * 0.5 + 0.5, texCoords.w));
bool isValid0 = isValid(texCoords.xy, fwidth(texCoords.xy));
bool isValid1 = isValid(texCoords.zw, vec2(0.0, 0.0));
return mix(color1 * float(isValid1), color0, float(isValid0));
}`),r.code.add(_`vec4 getCombinedOverlayColor() {
return overlayOpacity * getOverlayColor(ovColorTex, vtcOverlay);
}`),r.code.add(_`
    vec4 getOverlayColorTexel(vec4 texCoords) {
          vec2 texDim =  ${sm(e,"ovColorTex")};

          vec4 color0 = ${ia(e,"ovColorTex","vec2(texCoords.x * 0.5, texCoords.y)*texDim")};
          vec4 color1 = ${ia(e,"ovColorTex","vec2(texCoords.z * 0.5 + 0.5, texCoords.w)*texDim")};

          bool isValid0 = isValid(texCoords.xy, fwidth(texCoords.xy));
          bool isValid1 = isValid(texCoords.zw, vec2(0.0, 0.0));

          return mix(color1 * float(isValid1), color0, float(isValid0));
    }
  `),e.pbrMode!==Wt.Water&&e.pbrMode!==Wt.WaterOnIntegratedMesh&&e.pbrMode!==Wt.TerrainWithWater||(tm(r),im(r),r.code.add(_`vec4 getOverlayWaterColor(vec4 maskInput, vec4 colorInput, vec3 vposEyeDir,
float shadow, vec3 localUp, mat3 tbn, vec3 position, vec3 positionWorld) {
vec3 n = normalize(tbn *  (2.0 * maskInput.rgb - vec3(1.0)));
vec3 v = vposEyeDir;
vec3 final = getSeaColor(n, v, mainLightDirection, colorInput.rgb, mainLightIntensity, localUp, 1.0 - shadow, maskInput.w, position, positionWorld);
return vec4(final, colorInput.w);
}`))}function qw(i,e){return e.overlays.length===0?null:i.identifier===Da.Material&&i.output===A.Color?e.overlays[oi.INNER].getColorTextureNoRasterImage():i.identifier===Da.Material&&i.output===A.ObjectAndLayerIdColor?e.overlays[oi.INNER].getColorTexture(Xs.ObjectAndLayerIdColor):i.identifier===Da.Highlight?e.overlays[oi.INNER].getValidTexture(Ci.Highlight):null}function TK(i,e){for(const t of e.overlays){const{index:r,extent:s}=t;o3(s)>0&&(Dp[2*r]=i.toMapSpace[0]/Yo(s)-s[0]/Yo(s),Dp[2*r+1]=i.toMapSpace[1]/dh(s)-s[1]/dh(s))}return Dp}function CK(i,e){for(const t of e.overlays){const{index:r,extent:s}=t;o3(s)>0&&(Dp[2*r]=i.toMapSpace[2]/Yo(s),Dp[2*r+1]=i.toMapSpace[3]/dh(s))}return Dp}(function(i){i[i.Disabled=0]="Disabled",i[i.Enabled=1]="Enabled",i[i.EnabledWithWater=2]="EnabledWithWater",i[i.COUNT=3]="COUNT"})(Wl||(Wl={}));const Dp=Pt();var nl;(function(i){i[i.LayerOnly=0]="LayerOnly",i[i.ColorComposite=1]="ColorComposite",i[i.GridComposite=2]="GridComposite",i[i.COUNT=3]="COUNT"})(nl||(nl={}));let SK=class extends Gi{constructor(){super(...arguments),this.overlayOpacity=1}};function km(i,e){i.vertex.uniforms.add([new tv("overlayTexOffset"),new tv("overlayTexScale")]),i.fragment.uniforms.add([new ue("overlayOpacity",t=>t.overlayOpacity),new lt("ovColorTex",(t,r)=>r.overlays.length===0?null:r.overlays[oi.INNER].getColorTexture(t.overlaySource))]),V$(i,e)}function PK(i,e){const{vertex:t,fragment:r,varyings:s}=i;s.add("vtc","vec2"),t.uniforms.add(new tv("texOffsetAndScale")),r.uniforms.add(new wE("tex")),r.uniforms.add(new Yb("textureOpacities"));const a=e.textureFadingEnabled&&!e.renderOccluded;a&&(t.uniforms.add(new tv("nextTexOffsetAndScale")),s.add("nvtc","vec2"),r.uniforms.add(new wE("texNext")),r.uniforms.add(new Yb("nextTexOpacities")),r.uniforms.add(new OK("fadeFactor")));const n=e.tileBlendInput===nl.ColorComposite,o=e.tileBlendInput===nl.GridComposite;o&&r.include(dS),n&&r.uniforms.add(new Yb("backgroundColor")),t.code.add(_`
  void forwardTextureCoordinatesWithTransform(in vec2 uv) {
    vtc = uv * texOffsetAndScale.zw + texOffsetAndScale.xy;
    ${a?_`nvtc = uv * nextTexOffsetAndScale.zw + nextTexOffsetAndScale.xy;`:_``}
  }`),r.code.add(_`
    vec4 getColor(vec4 color, vec2 uv, vec3 opacities) {
      ${o||n?_`
              if (opacities.y <= 0.0) {
                return color * opacities.z * opacities.x;
              }
              vec4 bg = vec4(${n?_`backgroundColor`:_`gridColor(uv)`} * opacities.y, opacities.y);
              vec4 layer = color * opacities.z;
              return (bg * (1.0 - layer.a) + layer) * opacities.x;`:_`return color;`}
    }`),a?r.code.add(_`vec4 getTileColor() {
vec4 color = getColor(texture2D(tex, vtc), vtc, textureOpacities);
if (fadeFactor >= 1.0) {
return color;
}
vec4 nextColor = getColor(texture2D(texNext, nvtc), nvtc, nextTexOpacities);
return mix(nextColor, color, fadeFactor);
}`):r.code.add(_`vec4 getTileColor() {
return getColor(texture2D(tex, vtc), vtc, textureOpacities);
}`)}let OK=class extends Ch{constructor(e){super(e,"float")}},Yb=class extends Ch{constructor(e){super(e,"vec3")}},tv=class extends Ch{constructor(e){super(e,"vec4")}},wE=class extends Ch{constructor(e){super(e,"sampler2D")}},G$=class extends SK{};function RK(i){const e=new $t,{vertex:t,fragment:r,varyings:s}=e;e.include(V3),e.include($F,i),e.include(gv,i);const a=()=>{e.include(Sf,i),t.code.add(_`
      vec3 decodeNormalTerrain(vec2 e) {
        float z = 1.0 - abs(e.x) - abs(e.y);
        vec3 n = vec3(e + vec2(e.x >= 0.0 ? 1.0 : -1.0, e.y >= 0.0 ? 1.0 : -1.0) * min(z,0.0),z);
        return normalize(n);
      }

      vec3 getNormal() {
        return  ${i.shading?_`decodeNormalTerrain(normalCompressed)`:_`getLocalUp(position, localOrigin)`};
      }
  `)};nc(t,i),e.include(il,i);const n=i.overlayMode!==Wl.Disabled;switch(i.output){case A.Color:{e.include(PK,i),e.include(ef,i),n&&e.include(km,{...i,pbrMode:i.pbrMode===Wt.Terrain?Wt.TerrainWithWater:Wt.Water});const o=i.overlayMode===Wl.EnabledWithWater;o&&e.include(yK,i),s.add("vnormal","vec3"),s.add("vpos","vec3"),s.add("vup","vec3"),a(),(i.atmosphere||i.screenSizePerspective)&&Zg(t);const l=i.receiveShadows&&!i.renderOccluded;l&&e.include(yv,i),i.atmosphere&&s.add("wnormal","vec3"),i.screenSizePerspective&&(s.add("screenSizeDistanceToCamera","float"),s.add("screenSizeCosAngle","float")),t.code.add(_`
        void main(void) {
          //Position
          vpos = position;
          vec3 positionWorld = position + localOrigin;
          gl_Position = transformPosition(proj, view, vpos);

          //Normal
          vnormal = getNormal();

          //Up
          vup = getLocalUp(position, localOrigin);

          ${o?_`forwardVertexTangent(vnormal);`:_``}

          ${i.atmosphere?_`wnormal = normalize((viewNormal * vec4(normalize(positionWorld), 1.0)).xyz);`:""}

          //Texture UV
          vec2 uv = getUV0();
          forwardTextureCoordinatesWithTransform(uv);
          ${n?_`setOverlayVTC(uv);`:""}
          ${i.tileBorders?_`forwardTextureCoordinates();`:""}

          ${i.screenSizePerspective?_`
          vec3 viewPos = (view * vec4(vpos, 1.0)).xyz;
          screenSizeDistanceToCamera = length(viewPos);
          vec3 viewSpaceNormal = (viewNormal * vec4(normalize(positionWorld), 1.0)).xyz;
          screenSizeCosAngle = abs(viewSpaceNormal.z);`:""}

          ${l?_`forwardLinearDepth();`:""}

        }
      `),e.extensions.add("GL_OES_standard_derivatives"),e.extensions.add("GL_EXT_shader_texture_lod"),e.include(Qr,i),e.include(ef,i),e.include(G3,i),e.include(Yg,i),rm(r,i),B3(r),NT(r),r.uniforms.add([t.uniforms.get("localOrigin"),new si("viewDirection",(c,h)=>W(TE,j(TE,h.camera.viewMatrix[12],h.camera.viewMatrix[13],h.camera.viewMatrix[14])))]),o&&r.uniforms.add([new lt("ovWaterTex",(c,h)=>h.overlays.length===0?null:h.overlays[oi.INNER].getNormalTexture(c.overlaySource)),new NF("view",(c,h)=>pl(EK,h.camera.viewMatrix,c.origin))]),r.code.add(_`const float sliceOpacity = 0.2;
float lum(vec3 c) {
return (min(min(c.r, c.g), c.b) + max(max(c.r, c.g), c.b)) * 0.5;
}`),tm(r),im(r),r.code.add(_`
        void main() {
          vec3 normal = normalize(vnormal);
          float vndl = dot(normal, mainLightDirection);

          float additionalAmbientScale = smoothstep(0.0, 1.0, clamp(vndl*2.5, 0.0, 1.0));
          float shadow = ${i.receiveShadows&&!i.renderOccluded?"readShadowMap(vpos, linearDepth)":i.spherical&&i.shading?"lightingGlobalFactor * (1.0 - additionalAmbientScale)":"0.0"};

          float ssao = evaluateAmbientOcclusionInverse();
          vec4 tileColor = getTileColor();

          ${n?_`
              vec4 overlayColorOpaque = getOverlayColor(ovColorTex, vtcOverlay);
              vec4 overlayColor = overlayOpacity * overlayColorOpaque;
              ${i.invisible?_`if (overlayColor.a == 0.0) { discard; }`:""}
              vec4 groundColor = tileColor;
              tileColor = tileColor * (1.0 - overlayColor.a) + overlayColor;`:""}

          // If combined alpha is 0 we can discard pixel. The performance impact by having a discard here
          // is neglectable because terrain typically renders first into the framebuffer.
          if(tileColor.a <= 0.0) {
            discard;
          }

          bool sliced = rejectBySlice(vpos);
          if (sliced) {
            tileColor *= sliceOpacity;
          }
          ${i.atmosphere?_`
              float ndotl = clamp(vndl, 0.0, 1.0);
              vec3 atm = vec3(clamp(1.0 - dot(-viewDirection, wnormal), 0.0, 1.0));
              atm *= clamp(1.0 - lum(tileColor.rgb) * 1.5, 0.0, 1.0); // avoid atmosphere on bright base maps
              atm *= clamp(ndotl * 2.0, 0.0, 1.0); // avoid atmosphere on dark side of the globe
              atm *= tileColor.a; // premultiply with tile alpha`:""}

          vec3 albedo = ${i.atmosphere?_`atm + tileColor.rgb;`:_`tileColor.rgb;`}

          // heuristic shading function used in the old terrain, now used to add ambient lighting

          vec3 additionalLight = ssao * mainLightIntensity * additionalAmbientScale * ambientBoostFactor * lightingGlobalFactor;

          ${i.pbrMode===Wt.Terrain||i.pbrMode===Wt.TerrainWithWater?_`gl_FragColor = vec4(evaluateTerrainLighting(normal, albedo, shadow, 1.0 - ssao, additionalLight, normalize(vpos - cameraPosition), vup), tileColor.a);`:_`gl_FragColor = vec4(evaluateSceneLighting(normal, albedo, shadow, 1.0 - ssao, additionalLight), tileColor.a);`}
          ${o?_`
              vec4 overlayWaterMask = getOverlayColor(ovWaterTex, vtcOverlay);
              float waterNormalLength = length(overlayWaterMask);
              if (waterNormalLength > 0.95) {
                mat3 tbnMatrix = mat3(tbnTangent, tbnBiTangent, vnormal);
                vec4 waterOverlayColor = vec4(overlayColor.w > 0.0 ? overlayColorOpaque.xyz/overlayColor.w : vec3(1.0), overlayColor.w);
                vec4 viewPosition = view*vec4(vpos, 1.0);
                vec4 waterColorLinear = getOverlayWaterColor(overlayWaterMask, waterOverlayColor, -normalize(vpos - cameraPosition), shadow, vnormal, tbnMatrix, viewPosition.xyz,  vpos + localOrigin);
                vec4 waterColorNonLinear = delinearizeGamma(vec4(waterColorLinear.xyz, 1.0));
                float opacity = sliced ? sliceOpacity : 1.0;
                // un-gamma the ground color to mix in linear space
                gl_FragColor = mix(groundColor, waterColorNonLinear, waterColorLinear.w) * opacity;
              }`:""}
          ${i.screenSizePerspective?_`
            float perspectiveScale = screenSizePerspectiveScaleFloat(1.0, screenSizeCosAngle, screenSizeDistanceToCamera, vec4(0.0, 0.0, 0.0, 0.0));
            if (perspectiveScale <= 0.25) {
              gl_FragColor = mix(gl_FragColor, vec4(1.0, 0.0, 0.0, 1.0), perspectiveScale * 4.0);
            }
            else if (perspectiveScale <= 0.5) {
              gl_FragColor = mix(gl_FragColor, vec4(0.0, 0.0, 1.0, 1.0), (perspectiveScale - 0.25) * 4.0);
            }
            else if (perspectiveScale >= 0.99) {
              gl_FragColor = mix(gl_FragColor, vec4(0.0, 1.0, 0.0, 1.0), 0.2);
            }
            else {
              gl_FragColor = mix(gl_FragColor, vec4(1.0, 0.0, 1.0, 1.0), (perspectiveScale - 0.5) * 2.0);
            }`:""}
          ${i.visualizeNormals?i.spherical?_`
                  vec3 localUp = normalize(vpos + localOrigin);
                  vec3 right = normalize(cross(vec3(0.0, 0.0, 1.0), localUp));
                  vec3 forward = normalize(cross(localUp, right));
                  mat3 tbn = mat3(right, forward, localUp);
                  vec3 tNormal = normalize(normal * tbn);
                  gl_FragColor = vec4(vec3(0.5) + 0.5 * tNormal, 0.0);
              `:_`
                  vec3 tNormal = normalize(normal);
                  gl_FragColor = vec4(vec3(0.5) + 0.5 * tNormal, 0.0);
              `:""}
          ${i.tileBorders?_`
              vec2 dVuv = fwidth(vuv0);
              vec2 edgeFactors = smoothstep(vec2(0.0), 1.5 * dVuv, min(vuv0, 1.0 - vuv0));
              float edgeFactor = 1.0 - min(edgeFactors.x, edgeFactors.y);
              gl_FragColor = mix(gl_FragColor, vec4(1.0, 0.0, 0.0, 1.0), edgeFactor);`:""}
          gl_FragColor = highlightSlice(gl_FragColor, vpos);
        }
      `)}break;case A.Depth:n&&e.include(km,i),e.include(gh,i),Gp(e),Jg(e),t.code.add(_`
              void main(void) {
                ${n?_`setOverlayVTC(getUV0());`:""}
                gl_Position = transformPositionWithDepth(proj, view, position, nearFar, linearDepth);
              }
          `),r.code.add(_`
              void main() {
                ${n&&i.invisible?_`if (getCombinedOverlayColor().a == 0.0) { discard; }`:""}
                outputDepth(linearDepth);
              }
          `);break;case A.Shadow:case A.ShadowHighlight:case A.ShadowExcludeHighlight:e.include(gh,i),Gp(e),Jg(e),t.code.add(_`void main(void) {
gl_Position = transformPositionWithDepth(proj, view, position, nearFar, linearDepth);
}`),r.code.add(_`void main() {
outputDepth(linearDepth);
}`);break;case A.Normal:n&&e.include(km,i),s.add("vnormal","vec3"),Zg(t),a(),t.code.add(_`
            void main(void) {
              ${n?_`setOverlayVTC(getUV0());`:""}
              gl_Position = transformPosition(proj, view, position);
              vnormal = normalize((viewNormal * vec4(getNormal(), 1.0)).xyz);
            }
        `),r.code.add(_`
            void main() {
              ${n&&i.invisible?_`if (getCombinedOverlayColor().a == 0.0) { discard; }`:""}
              vec3 normal = normalize(vnormal);
              if (gl_FrontFacing == false) {
                normal = -normal;
              }
              gl_FragColor = vec4(vec3(0.5) + 0.5 * normal, 0.0);
            }
        `);break;case A.Highlight:n&&e.include(km,i),t.code.add(_`
          void main() {
            ${n?_`setOverlayVTC(getUV0());`:""}
            gl_Position = transformPosition(proj, view, position);
          }
        `),e.include(Sh,i),r.code.add(_`
          void main() {
            ${n?_`if (getCombinedOverlayColor().a == 0.0) { discard; }`:""}
            outputHighlight();
          }
        `)}return i.output===A.ObjectAndLayerIdColor&&(e.include(km,{...i,pbrMode:Wt.Disabled}),t.code.add(_`void main(void) {
gl_Position = transformPosition(proj, view, position);
setOverlayVTC(getUV0());
}`),r.code.add(_`void main() {
gl_FragColor = getOverlayColorTexel(vtcOverlay);
}`)),e}const EK=ce(),TE=T(),AK=Object.freeze(Object.defineProperty({__proto__:null,TerrainPassParameters:G$,build:RK},Symbol.toStringTag,{value:"Module"}));let B$=class H$ extends Mt{constructor(){super(...arguments),this.useStencil=!1}initializeConfiguration(e,t){t.hasWebGL2Context=e.rctx.type===da.WEBGL2,t.spherical=e.viewingMode===ve.Global}initializeProgram(e){return new Rt(e.rctx,H$.shader.get().build(this.configuration),k$)}initializePipeline(){return this._stencilPipelineState=this._createPipeline(!0),this._createPipeline(!1)}_createPipeline(e){const t=this.configuration,r=t.backfaceCullingEnabled&&!t.renderOccluded;return qe({blending:t.renderOccluded?oc(ae.ONE,ae.ONE_MINUS_SRC_ALPHA):null,culling:r?J3:null,depthTest:t.renderOccluded?null:{func:Fa.LESS},depthWrite:t.renderOccluded?null:cn,colorWrite:at,stencilTest:e?FF(Tg.IntegratedMeshMaskExcluded):null})}getPipelineState(e,t){return this.useStencil?this._stencilPipelineState:super.getPipelineState(e,t)}};B$.shader=new Dt(AK,()=>_e(()=>import("./Terrain.glsl-3328dbca.js"),["assets/Terrain.glsl-3328dbca.js","assets/calcite-8912bd40.js","assets/index-00759e4a.js","assets/index-5026a37a.css","assets/calcite-96fa36fd.css","assets/mat4f64-abdda1bb.js","assets/objectResourceUtils-782953c3.js","assets/devEnvironmentUtils-5002a058.js","assets/mat3f64-50f3b9f6.js","assets/BufferView-379a78a4.js","assets/vec33-69c9e93b.js","assets/DefaultMaterial_COLOR_GAMMA-6ed76d86.js","assets/types-e1c0a5bf.js","assets/enums-e2e92c86.js","assets/Version-aa0a1d91.js","assets/quat-7b70e9a8.js","assets/quatf64-f8f1c132.js","assets/resourceUtils-527631ac.js","assets/basicInterfaces-7449a8bf.js","assets/Indices-d8bff7b2.js","assets/NestedMap-1b5db22e.js","assets/requestImageUtils-d1ba3b36.js","assets/symbolColorUtils-c9d24716.js","assets/Util-6d3f024a.js","assets/sphere-d0e5285d.js","assets/VertexAttribute-15d1866a.js","assets/doublePrecisionUtils-e3c3d0d8.js","assets/OrderIndependentTransparency-5f7257d7.js","assets/Texture-563cf5e5.js","assets/FramebufferObject-8b18fc0c.js","assets/VertexElementDescriptor-2925c6af.js","assets/InterleavedLayout-d57c91d0.js","assets/vec3f32-01c06d8d.js","assets/plane-5e2b046c.js","assets/spatialReferenceEllipsoidUtils-afb35af9.js","assets/scaleUtils-d13015f2.js","assets/ElevationSamplerData-e3118b17.js","assets/Octree-499541ed.js","assets/edgeProcessing-20e12367.js","assets/deduplicate-769a6f51.js","assets/MeshComponent-788e605a.js","assets/earcut-61f7b102.js","assets/imageUtils-c2d0d1ae.js","assets/projection-5969b753.js","assets/ZoomMomentumEstimator-ef57e6a4.js","assets/floatRGBA-ca2b39ca.js","assets/dehydratedFeatures-3a140d03.js","assets/quantizationUtils-b3b2ae2a.js","assets/labelFormatUtils-71e1f841.js","assets/orientedBoundingBox-a14b97b5.js","assets/quatf32-51a323b8.js","assets/SnappingCandidate-970faec6.js","assets/callExpressionWithFeature-df1a8f01.js","assets/DefaultVertexAttributeLayouts-5f20d8dd.js","assets/geometryServiceUtils-a536bb19.js","assets/project-909a4219.js","assets/LercDecoder-65586d50.js","assets/VectorTile-d41a1f0f.js","assets/enums-fb086c25.js","assets/config-1337d16e.js","assets/TiledDisplayObject-419c008b.js","assets/DisplayObject-87c37b69.js","assets/rasterUtils-7694cc98.js","assets/resources-7587d8f4.js","assets/workerHelper-6131d203.js","assets/webgl-debug-7f880832.js","assets/RenderingContext-0f21aa0e.js","assets/ProgramCache-f29c900e.js","assets/Program-77209250.js","assets/MediaLayer-4c42fc2f.js","assets/MediaElementView-06baa4d4.js","assets/normalizeUtilsSync-3ea564a9.js","assets/resourceExtension-f31d9f10.js","assets/BoundsStore-00da37da.js","assets/PooledRBush-5a11bc7e.js","assets/prism-line-numbers-eff41b13.js","assets/label2-a2f37e65.js","assets/interactive-1de2e238.js","assets/loadable-6afd516d.js","assets/t9n-81df3a71.js","assets/observers-c89705b8.js","assets/icon-8e47fbec.js","assets/loader-c773e800.js","assets/guid-51402ee7.js","assets/prism-line-numbers-7c5d72ff.css"]));const k$=new Map([[w.POSITION,0],[w.UV0,1],[w.NORMALCOMPRESSED,2]]);let MK=class{constructor(){this.geometryInfo=new IY,this.intersectionData=null,this.geometryState=null,this._textureRef=new M$(()=>this.tile.surface.textureFadeDuration),this.overlay=new _K,this._geometryStateChangedSinceLastUpdate=!0,this._hasGeometry=!1,this._numVerticesPerSideChanged=!1,this._samplerDataChanged=!1,this._clippingAreaChanged=!1,this._wireframeChanged=!1,this._shadingChanged=!1,this._dirtyEdgeResolutions=15,this._dirtyEdges=15,this._dirtyCorners=15}get tile(){return this._tile}init(e){this.clear(),this._tile=e;const t=this.geometryInfo;t.indices=null,t.vertexAttributes=null,di(t.boundingBox),t.indexCount=0,t.numVerticesPerSide=0,this.intersectionData=null,this.geometryState=new VY,this.localOrigin=null,this.overlay.clear()}clear(){this.releaseGeometry(),this.releaseTexture(),this._textureRef.clear(),this._tile=null,this.intersectionData=null,this.geometryState=null}updateGeometryIfNeeded(e){if((!this._vao||this._geometryStateChangedSinceLastUpdate||this._wireframeChanged||this._shadingChanged||this._clippingAreaChanged||this._samplerDataChanged||this._numVerticesPerSideChanged||this._dirtyCorners||this._dirtyEdgeResolutions||this._dirtyEdges)&&(this._updateGeometry(e),this._geometryStateChangedSinceLastUpdate=!1),ur&&this.tile.intersectsClippingArea)for(let t=0;t<4;++t)Z(this.geometryInfo.outerEdges[t].count===this.geometryState.neighborData.edgeResolutions[t]+1)}_calculateEdgeResolution(e,t){var l;const r=this.tile,s=this.geometryState.numVerticesPerSide-1;if(!r.surface.isGlobal){const c=r.surface.extent;if(g(c)&&(e===0&&r.extent[3]>c[3]||e===1&&r.extent[2]>c[2]||e===2&&r.extent[1]<c[1]||e===3&&r.extent[0]<c[0]))return s}const a=r.level,n=al[e];if(!t)return Z(P((l=r.surface)==null?void 0:l.rootTiles)||r.surface.updatingRootTiles||!r.shouldHaveNeighbor(n)),s;if(t.isLoaded){const c=t,h=c.renderData.geometryState,u=a-c.level;if(Z(u>=0),u===0){const f=h.numVerticesPerSide-1;return Math.max(f,s)}const p=2**u,m=h.neighborData.edgeResolutions[(e+2)%4]/p;return Math.max(1,m)}Z(!t.isLeaf);let o=s;return t.forAllSubtreeOnSide(Ky(n),c=>c===r||(c.isLoaded?(o=Math.max(o,2**(c.level-a)),!0):(Z(!c.isLeaf),!1))),o}updateNeighborData(){var o;const e=this.tile;if(!e.intersectsClippingArea)return;const t=e.renderData.geometryState.neighborData,r=l=>(l.isLoaded||l.level===e.level)&&(l==null?void 0:l.intersectsClippingArea),s=t.edgePeerNeighbors,a=t.edgePeerNeighborSamplerVersions;for(let l=0;l<4;++l){const c=e.findNeighborTile(al[l],r),h=md(e,c),u=((o=h==null?void 0:h.renderData)==null?void 0:o.geometryState.samplerDataVersion)??-1,p=s[l],m=h!==md(e,p),f=a[l]!==u;s[l]=c,(m||f)&&(a[l]=u,this._markEdgeDirty(l));const y=t.edgeResolutions[l],b=this._calculateEdgeResolution(l,c);Z(Xg(b)),Z(b>=1),t.edgeResolutions[l]=b,y!==b&&this._markEdgeResolutionDirty(l)}const n=t.cornerPeerNeighbors;for(let l=0;l<4;++l){const c=e.findNeighborTile(Jy[l],r);n[l]=c;const h=md(e,s[l]),u=md(e,s[(l+1)%4]),p=md(e,c);qn[l]=p,qn[(l+1)%4]=u,qn[(l+2)%4]=e,qn[(l+3)%4]=h,Z(qn.some(b=>(b==null?void 0:b.isLoaded)||b===e));const m=qn.reduce((b,x)=>Math.min(b,(x==null?void 0:x.level)??1/0),1/0);qn.forEach((b,x)=>{b&&(b==null?void 0:b.level)>m&&(qn[x]=null)}),Z(qn.some(b=>(b==null?void 0:b.isLoaded)||b===e));const f=t.cornerNeighborData[l].cornerTiles,y=t.cornerNeighborData[l].cornerTileSamplerVersions;for(let b=0;b<4;++b){const x=qn[b],S=(x==null?void 0:x.renderData.geometryState.samplerDataVersion)??-1,C=f[b]!==x,O=!C&&y[b]!==S;(C||O)&&(f[b]=x,y[b]=S,this._markCornerDirty(l))}Z(f.some(b=>(b==null?void 0:b.isLoaded)||b===e))}ur&&Z(this.geometryState.neighborData.edgeResolutions.every(l=>l>0));for(let l=0;l<4;++l)qn[l]=null}_updateGeometry(e){if(!this.tile.intersectsClippingArea)return;ur&&Z(!this.tile.intersectsClippingArea||this.geometryState.neighborData.edgeResolutions.every(l=>l>0)),this.intersectionData=null;const t=this.tile,r=this._vao,s=this.geometryInfo.vertexAttributes,a=!r||!s||this._wireframeChanged||this._shadingChanged||this._numVerticesPerSideChanged||this._samplerDataChanged||this._clippingAreaChanged||this._dirtyEdgeResolutions,n=!a&&(this._dirtyEdges!==0||this._dirtyEdgeResolutions!==0),o=!n&&this._dirtyCorners!==0;a?(this.releaseGeometry(),this._createGeometry(e)):n||o?t.updateEdgeElevations():o?t.updateCornerElevations():console.warn("Update for no reason?"),this._numVerticesPerSideChanged=!1,this._samplerDataChanged=!1,this._dirtyEdgeResolutions=0,this._dirtyEdges=0,this._dirtyCorners=0,this._clippingAreaChanged=!1,this._wireframeChanged=!1,this._shadingChanged=!1}get hasGeometry(){return this._hasGeometry}releaseGeometry(){return this._hasGeometry=!1,this.intersectionData=null,!!this._vao&&(this._vao.dispose(),this._vao=null,NY(this.geometryInfo),!0)}ensureTexture(e,t){return g(this._texture)&&this._texture.descriptor.width!==e&&this.releaseTexture(),P(this._texture)&&(this._texture=t(),this.tile.setMemoryDirty()),this._texture}releaseTexture(){g(this._texture)&&(this._texture.release(),this._texture=null,this.tile.setMemoryDirty())}_markCornerDirty(e){const t=1<<e;this._dirtyCorners|=t}_markEdgeDirty(e){const t=1<<e;this._dirtyEdges|=t}_markEdgeResolutionDirty(e){const t=1<<e;this._dirtyEdgeResolutions|=t,this._dirtyEdges|=t}_markAllEdgesAndCornersDirty(){this._dirtyCorners=15,this._dirtyEdges=15,this._dirtyEdgeResolutions=15}updateGeometryState(){const e=this._getElevationInfo(),t=this.tile,r=e.samplerData?t.getElevationVerticesPerSide(e.maxTileLevel):t.getDefaultVerticesPerSide(),s=Math.max(r,5);let a=t.clippingArea;t.intersectsClippingArea&&!t.isWithinClippingArea||(a=null);const n=this.geometryState;let o=!1;n.numVerticesPerSide!==s&&(this._numVerticesPerSideChanged=!0,n.numVerticesPerSide=s,n.samplerDataVersion++,o=!0),e.changed&&(this._samplerDataChanged=!0,n.samplerData=e.samplerData,n.samplerDataVersion++,o=!0),TT(n.clippingArea,a)||(this._clippingAreaChanged=!0,n.clippingArea=a,o=!0);const l=t.surface,c=l.wireframe;n.wireframe!==c&&(this._wireframeChanged=!0,n.wireframe=c,o=!0);const h=l.shading;return n.shading!==h&&(this._shadingChanged=h,n.shading=h,o=h),this._geometryStateChangedSinceLastUpdate||(this._geometryStateChangedSinceLastUpdate=o),o&&this._markAllEdgesAndCornersDirty(),this._hasGeometry=!0,this._geometryStateChangedSinceLastUpdate}_createGeometry(e){this.tile.createGeometry();const t=this.geometryInfo.vertexAttributes,r=this.geometryInfo.indices,s=e.gl;this._vao=new ac(e,k$,{geometry:Co(t.layout)},{geometry:gs.createVertex(e,s.STATIC_DRAW,t.buffer)},gs.createIndex(e,s.STATIC_DRAW,r)),this._hasGeometry=!0}get vao(){return this._vao}setTextureReference(e,t=jl.Immediate){g(e)&&e.texture!==this._texture&&this.releaseTexture(),this._textureRef.push(e,t)}get textureReference(){return this._textureRef.current}get nextTextureReference(){return this._textureRef.next}get textureFadeFactor(){return this._textureRef.fadeFactor}get textureIsFading(){return this._textureRef.isFading}_getElevationInfo(){const e=this.geometryState.samplerData,t=this.tile.layerInfo[ot.ELEVATION],r=t.length,s=new Array(r);let a=0,n=0,o=!1;for(let h=0;h<r;h++){const u=t[h];if(g(u.upsampleInfo)){const p=u.upsampleInfo.tile,m=p.layerInfo[ot.ELEVATION][h].data,f=m&&m.samplerData;e&&e[a]===f||(o=!0),s[a++]=f,n=Math.max(n,p.lij[0])}else if(u.data){const p=this.tile.surface.layerViewByIndex(h,ot.ELEVATION);if(zg(this.tile,p.layer,!1)){const m=u.data;e&&e[a]===m.samplerData||(o=!0),s[a++]=m.samplerData,n=this.tile.level}}}g(e)&&e.length!==a&&(o=!0);const l=a>0,c=l?s:null;return l&&(s.length=a),{changed:o,samplerData:c,maxTileLevel:n}}get estimatedGeometryMemoryUsage(){var t,r;const e=Vc(this.intersectionData,0,s=>s.estimatedMemoryUsage);return(((t=this.geometryInfo.indices)==null?void 0:t.byteLength)??0)+(((r=this.geometryInfo.vertexAttributes)==null?void 0:r.byteLength)??0)+e}get textureDescriptor(){return g(this._texture)?this._texture.descriptor:null}get test(){return{hasTexture:this._texture!=null}}checkGeometryWaterproofness(){if(!ur)return;const e=this.tile;if(Z(e==null?void 0:e.isLoaded),!e.isLoaded||!e.intersectsClippingArea)return;const t=e.renderData;if(e.level===0)return;const r=e.surface.extent;if(g(r)&&!e.intersectsExtent(r))return;const s=al.map((l,c)=>!!g(r)&&(c<2?-1:1)*(e.extent[3-c]-r[3-c])<0),a=e.level;Z(this._dirtyCorners===0),Z(this._dirtyEdges===0),Z(this._dirtyEdgeResolutions===0),Z(!this._numVerticesPerSideChanged),Z(!this._samplerDataChanged),Z(!this._clippingAreaChanged),Z(!this._wireframeChanged);const n=Jy.map(l=>e.findNeighborCornerTileExact(l,c=>!c.intersectsClippingArea||c.isLoaded||c.level===e.level)??null).map(l=>l!=null&&l.intersectsClippingArea?l:null),o=this.geometryState.neighborData;for(let l=0;l<4;++l){const c=o.cornerPeerNeighbors[l],h=n[l];Z(h===c,`Tile[${e.lij}].corner[${l}] out of date: cur=[${c==null?void 0:c.lij}] exp=[${h==null?void 0:h.lij}]`)}al.forEach((l,c)=>{if(s[c])return;const h=e.findNeighborTile(l,V=>(V.level===a||(V==null?void 0:V.isLoaded))&&(V==null?void 0:V.intersectsClippingArea));if(!h){const V=!e.surface.updatingRootTiles&&g(e.surface.rootTiles)&&e.surface.rootTiles.length>0&&e.shouldHaveNeighbor(l);return void Z(!V)}Z(h.isLoaded||h.level===e.level),Z(h===this.geometryState.neighborData.edgePeerNeighbors[c]);const u=a-h.level;if(!h.isLoaded)return Z(!h.isLeaf),void Z(u===0);const p=h.renderData;Z(fK(e,h,l)),Z(u>=0);const m=2**u;if(u<0)return void Z(!1);const f=t.geometryInfo,y=f.outerEdges[c],b=f.numVerticesPerSide-1,x=p.geometryInfo;if(!x)return void Z(!1);{const V=this.geometryState.neighborData.edgePeerNeighbors[c];if(V!=null&&V.isLoaded){const z=V.renderData;Z(V==V),Z(t.geometryState.neighborData.edgePeerNeighborSamplerVersions[c]===z.geometryState.samplerDataVersion),Z(this.geometryState.neighborData.edgePeerNeighborSamplerVersions[c]===z.geometryState.samplerDataVersion)}}const S=(c+2)%4,C=x.outerEdges[S],O=y.count-1,R=C.count-1;Z(O*m===R,`Tile[${e.lij}]:e${c},res=${O} edgeRes mismatch with Neighbor[${h.lij}]:e${S},res=${R} (expected:${O*m})`);const E=e.extent,$=l===ze.NORTH||l===ze.SOUTH,M=C.count-1,L=M/2**u,F=y.count-1;if(L<1)return void Z(F===1);Z(L===F),Z(Xg(L));const N=x.numVerticesPerSide-1;Z(u>0||L===Math.max(N,b));const G=e.getNeighborEdgeStartVertexIndex(c,h);Z(0<=G&&G<m);const q=G*L;Z(0<=q&&q<=M-L);let se=0,k=q;y.getVertexPos(Fo,0),y.getVertexPos(zo,y.count-1);const I=yi(Fo,zo),U=Math.max(DK,1e-4*I);for(let V=0;V<=L;++V){y.getVertexPos(Fo,se),C.getVertexPos(zo,k);const z=V/L,ie=$?E[0]+z*(E[2]-E[0]):l===ze.WEST?E[0]:E[2],re=$?l===ze.SOUTH?E[1]:E[3]:E[1]+z*(E[3]-E[1]),he=e.surface.extent;if(P(he)||KN(he,ie,re)){const oe=lT(Fo,zo),Re=io(Fo)-Ys.radius,ne=io(zo)-Ys.radius,me=oe<U;if(!me){console.warn(`Tile edge vertex position mismatch: between [${e.lij}].edge${c}[${se}/${y.count}] and [${h.lij}].edge${S}[${k}/${C.count}]`),g(he)&&console.warn("  surface extent= ",he," x,y=",ie,",",re);const ge=T();Q(ge,t.localOrigin,p.localOrigin),io(ge)>0&&console.warn(`   localOrigins: ${t.localOrigin} vs ${p.localOrigin} d=${io(ge)} [${ge}]`),(()=>{const Ue=aa(Fo),Ee=aa(zo);e.updateEdgeElevations(),h.updateEdgeElevations(),y.getVertexPos(Fo,se),C.getVertexPos(zo,k);const Ae=T();Xr(Ae,Fo,Ue),io(Ae)>0&&console.warn(`  XXX Tile[${e.lij}] edge out of date: ${Ue} vs ${Fo} d=${io(Ae)} [${Ae}]`),Xr(Ae,zo,Ee),io(Ae)>0&&console.warn(`  XXX Neighbor[${h.lij}] edge out of date: ${Ee} vs ${zo} d=${io(Ae)} [${Ae}]`)})(),Z(me,`Mismatch in tile [${e.lij}].edge[${c}][${se}/${y.count}] vs neighbor [${h.lij}].edge[${S}][${k}/${C.count}] ${El(Fo)} vs ${El(zo)}  dist=${oe} h(t|n|d)=${Re}|${ne}|${ne-Re}`)}if(e.surface.shading){y.getNormal(Hu,se),C.getNormal(ku,k),W(CE,Hu),W(SE,ku);const ge=J(CE,SE),Ue=1-ge<.01||!1||e===h;if(!Ue){const Ee=T();Xr(Ee,Hu,ku);const Ae=()=>`Mismatch in tile edge normal ${nE(e.lij)} (${se}/${y.count-1}) edge ${c} vs neighbor ${nE(h.lij)}  (${k}/${C.count-1}) nedge ${S} :${El(Hu)} vs ${El(ku)}  dot = ${ge} : ${El(Ee)}`;console.warn("Mismatch in tile edge normal: ",Ae());{e.updateEdgeElevations(),h.updateEdgeElevations();const Ze=T(),de=T();y.getNormal(Ze,se),C.getNormal(de,k),Ed(Hu,Ze)||console.warn("Missing update in tile normal: ",El(Hu)," => ",El(Ze)),Ed(ku,de)||console.warn("Missing update in neighbor normal: ",El(ku)," => ",El(de))}Z(Ue,Ae())}}}se+=1,k+=1}})}};const Fo=T(),zo=T(),Hu=T(),ku=T(),CE=T(),SE=T(),DK=1,qn=[null,null,null,null];function md(i,e){return e!=null&&e.isLoaded||e===i?e:null}const IK=65536;function LK(i,e){const t=i.tile,{extent:r,extentInRadians:s,surface:a}=t,n=i.localOrigin,o=i.geometryState,l=a.isWebMercator,c=a.shading||Ud,h=o.numVerticesPerSide,u=h-1,p=(h-2)**2,m=l&&(e===Sn.HAS_SOUTH_POLE||e===Sn.HAS_BOTH_POLES),f=l&&(e===Sn.HAS_NORTH_POLE||e===Sn.HAS_BOTH_POLES),y=6,b=((m?1:0)+(f?1:0))*y*(u+1),x=o.neighborData,S=x.edgeResolutions.reduce((M,L)=>M+L+1,0),C=A$(p+b+S),O=i.geometryInfo;O.numVerticesPerSide=o.numVerticesPerSide,O.vertexAttributes=C;const R=O.boundingBox;di(R);const E=fS(i);Ki.update(u,s,E),$K(i),J$(i,p),j$(i);const $=[];if((()=>{let M=p+S;const L=n[0],F=n[1],N=n[2],G=t.ellipsoid.radius,q=r[1],se=r[3],k=(I,U)=>{const V=U*h;Es(-L,-F,I*G-N,R),$.push({connectedRowOffset:V,connectedOuterEdgeOffset:I===1?0:2,rowOffset:M,latitudeResolution:y});const z=X$(I===-1?q:se,G),ie=I*Math.PI/2-z,re=.99*(I===1?1:-1),he=G+0,oe=C.position,Re=C.uv0,ne=C.normalCompressed;for(let me=1;me<=y;++me){const ge=z+ie*(me/y),Ue=Math.cos(ge),Ee=Math.sin(ge);for(let Ae=0;Ae<=u;Ae++){const Ze=Ae/u,de=Ki.sinLonLUT[Ae],Ne=Ki.cosLonLUT[Ae]*Ue,ye=de*Ue,He=Ee,Ye=Ne*he-L,tt=ye*he-F,Ke=He*he-N;Es(Ye,tt,Ke,R),oe.setValues(M,Ye,tt,Ke),Na(Re,M,Ze,re),c&&Mf(ne,M,Ne,ye,He),++M}}};m&&k(-1,0),f&&k(1,u)})(),K$(O,o.numVerticesPerSide,$,[0,h-1],[0,h-1],o.wireframe),i.intersectionData=null,ur)for(let M=0;M<4;++M)Z(O.outerEdges[M].count===x.edgeResolutions[M]+1)}function $K(i){const e=i.tile;e.intersectsClippingArea&&(e.surface.shading||Ud?FK(i):NK(i))}function NK(i){const e=i.geometryState,t=e.numVerticesPerSide,r=t-2,s=t-1,a=i.geometryInfo,n=a.vertexAttributes,o=n.position,l=n.uv0,c=i.tile,h=c.extent,u=h[0],p=h[2],m=h[1],f=h[3],y=c.ellipsoid.radius,b=e.samplerData,x=i.localOrigin,S=x[0],C=x[1],O=x[2],R=a.boundingBox,E=o.typedBuffer,$=o.typedBufferStride;let M=0;for(let L=1;L<=r;L++){const F=L/s,N=m*(1-F)+f*F,G=Ki.sinLatLUT[L],q=Ki.cosLatLUT[L];for(let se=1;se<=r;se++){const k=se/s,I=u*(1-k)+p*k,U=Ki.sinLonLUT[se],V=Ki.cosLonLUT[se],z=y+ri(I,N,b),ie=V*q*z-S,re=U*q*z-C,he=G*z-O;Es(ie,re,he,R);const oe=M*$;E[oe]=ie,E[oe+1]=re,E[oe+2]=he,Na(l,M,k,F),++M}}}function FK(i){const e=i.geometryState,t=e.numVerticesPerSide,r=t-2,s=t-1,a=i.geometryInfo,n=a.vertexAttributes,o=n.position,l=n.uv0,c=n.normalCompressed,h=i.tile,u=h.extent,p=u[0],m=u[2],f=u[1],y=u[3],b=h.ellipsoid.radius,x=e.samplerData,S=i.localOrigin,C=S[0],O=S[1],R=S[2],E=o.typedBuffer,$=o.typedBufferStride,M=1/s,L=a.boundingBox;let F=0;if(1<=r){const N=M,G=f*(1-N)+y*N,q=Ki.sinLatLUT[1],se=Ki.cosLatLUT[1];for(let k=1;k<=r;k++){const I=k*M,U=p*(1-I)+m*I,V=Ki.sinLonLUT[k],z=Ki.cosLonLUT[k],ie=b+ri(U,G,x),re=ie*z*se-C,he=ie*V*se-O,oe=ie*q-R;Es(re,he,oe,L);const Re=(k-1)*$;E[Re]=re,E[Re+1]=he,E[Re+2]=oe,Na(l,k-1,I,N)}}for(let N=1;N<=r;N++){const G=N*M,q=f*(1-G)+y*G,se=Ki.sinLatLUT[N],k=Ki.cosLatLUT[N],I=N+1,U=I*M,V=f*(1-U)+y*U,z=Ki.sinLatLUT[I],ie=Ki.cosLatLUT[I],re=Ki.sinLonLUT[0],he=Ki.cosLonLUT[0],oe=b+ri(p,q,x);let Re=he*k*oe-C,ne=re*k*oe-O,me=se*oe-R;const ge=F*$;let Ue=E[ge],Ee=E[ge+1],Ae=E[ge+2];for(let Ze=1;Ze<=r;Ze++){const de=Ze*M,Ne=p*(1-de)+m*de,ye=Ki.sinLonLUT[Ze],He=Ki.cosLonLUT[Ze];let Ye=He*k,tt=ye*k,Ke=se,pt=0,Nt=0,vt=0;{let Ce=0,fe=0,Oe=0;if(Ze<r){const xt=(F+1)*$;Ce=E[xt],fe=E[xt+1],Oe=E[xt+2]}else{const xt=Ki.sinLonLUT[s],wt=Ki.cosLonLUT[s],Tt=b+ri(m,q,x);Ce=wt*k*Tt-C,fe=xt*k*Tt-O,Oe=se*Tt-R}const Me=Re,ke=ne,Xe=me;Re=Ue,ne=Ee,me=Ae,Ue=Ce,Ee=fe,Ae=Oe,pt=Ce-Me,Nt=fe-ke,vt=Oe-Xe}{let Ce=0,fe=0,Oe=0;if(N>1){const Me=(F-r)*$;Ce=E[Me],fe=E[Me+1],Oe=E[Me+2]}else{const Me=Ki.sinLatLUT[0],ke=Ki.cosLatLUT[0],Xe=b+ri(Ne,f,x);Ce=He*ke*Xe-C,fe=ye*ke*Xe-O,Oe=Me*Xe-R}{const Me=b+ri(Ne,V,x),ke=He*ie*Me-C,Xe=ye*ie*Me-O,xt=z*Me-R;if(N<r){const Yt=F+r,nt=Yt*$;E[nt]=ke,E[nt+1]=Xe,E[nt+2]=xt,Es(ke,Xe,xt,L),Na(l,Yt,de,U)}const wt=Ce-ke,Tt=fe-Xe,Ct=Oe-xt;Ke*Ke<.999&&(Ye=vt*Tt-Nt*Ct,tt=pt*Ct-vt*wt,Ke=Nt*wt-pt*Tt)}}const ft=1/Math.sqrt(Ye*Ye+tt*tt+Ke*Ke);Mf(c,F,Ye*ft,tt*ft,Ke*ft),++F}}}function zK(i){i.tile.intersectsClippingArea&&(j$(i),Xv(i))}function UK(i){i.tile.intersectsClippingArea&&(W$(i),q$(i,!0),Xv(i))}function j$(i){i.tile.intersectsClippingArea&&(W$(i),q$(i))}function q$(i,e=!1){const t=i.geometryState,r=i.geometryInfo,s=t.neighborData,a=i.tile,n=a.level,o=a.extent,l=a.ellipsoid.radius,c=a.extentInRadians,h=c[0],u=c[2],p=c[1],m=c[3],f=t.samplerData,y=o[0],b=o[2],x=o[1],S=o[3],C=fS(i),O=r.boundingBox,R=i.localOrigin,E=R[0],$=R[1],M=R[2],L=a.surface.shading||Ud,F=r.vertexAttributes,N=F.position,G=N.typedBuffer,q=N.typedBufferStride,se=F.uv0;for(let k=0;k<4;++k){const I=k===1||k===3,U=s.edgeResolutions[k];Z(Xg(U));const V=U+1,z=md(a,s.edgePeerNeighbors[k]);if(i5(a,z,k)){e5(i,k,z);continue}const ie=g(z);Z(!ie||z.level===a.level),Z(!ie||ql(a,z)<=0);const re=z==null?void 0:z.renderData,he=re==null?void 0:re.geometryState;if(ur){const fe=a.surface;if(!z&&fe&&!fe.updatingRootTiles){const Oe=al[k],Me=a.findNeighborTile(Oe,ke=>ke.isLoaded||ke.isLeaf||ke.level===a.level);Me?Me.intersectsClippingArea&&(Z(!Me.isLoaded),Z(!Me.isLeaf),Z(Me.level===n)):Z(P(fe==null?void 0:fe.rootTiles)||!a.shouldHaveNeighbor(Oe))}}const oe=k===1?o[2]:o[0],Re=z==null?void 0:z.extent,ne=Re&&I?k===1?Re[0]:Re[2]:oe,me=k===0?o[3]:o[1],ge=k===1?1:0,Ue=k===0?1:0,Ee=k===1?u:h,Ae=k===0?m:p,Ze=Math.sin(Ee),de=Math.cos(Ee),Ne=Math.sin(Ae),ye=Math.cos(Ae),He=he==null?void 0:he.samplerData,Ye=ie?(fe,Oe,Me)=>.5*(ri(fe,Oe,f)+ri(Me,Oe,He)):(fe,Oe,Me)=>ri(fe,Oe,f),tt=r.outerEdges[k],Ke=e&&V>3?V-3:1,pt=g(f)&&f.some(fe=>fe!=null),Nt=g(He)&&He.some(fe=>fe!=null),vt=pt||Nt,ft=1/U,Ce=tt.index0;L?(Z(!Re||Pn(Re[2]-Re[0],o[2]-o[0])),(()=>{const fe=k===1?-1:k===3?1:0,Oe=k===0?-1:k===2?1:0,Me=(o[2]-o[0])*ft,ke=fe*Me,Xe=Oe*Me,xt=I?fe*((u-h)*ft):0,wt=I?0:Oe*ft,Tt=Ue,Ct=I?Ee+xt:Ee,Yt=I?Math.sin(Ct):Ze,nt=I?Math.cos(Ct):de,gt=I?Ee-xt:Ee,mt=I?Math.sin(gt):Ze,Bi=I?Math.cos(gt):de,Vt=I?Ae:C(Tt+wt),bi=I?Ne:Math.sin(Vt),Kt=I?ye:Math.cos(Vt),mi=I?Ae:C(Tt-wt),Mi=I?Ne:Math.sin(mi),Yi=I?ye:Math.cos(mi);let is=0,Hr=0,Hi=0;{const Gt=0*ft,vs=I?oe:y*(1-Gt)+b*Gt,za=I?ne:vs,Kd=I?x*(1-Gt)+S*Gt:me,dc=I?Ee:h*(1-Gt)+u*Gt,Jd=I?Ze:Math.sin(dc),eu=I?de:Math.cos(dc),yl=I?C(Gt):Ae,Oh=I?Math.sin(yl):Ne,vl=I?Math.cos(yl):ye,bl=l+Ye(vs,Kd,za);is=eu*vl*bl,Hr=Jd*vl*bl,Hi=Oh*bl}let xi=0,wi=0,ki=0;{const Gt=1*ft,vs=I?oe:y*(1-Gt)+b*Gt,za=I?ne:vs,Kd=I?x*(1-Gt)+S*Gt:me,dc=I?Ee:h*(1-Gt)+u*Gt,Jd=I?Ze:Math.sin(dc),eu=I?de:Math.cos(dc),yl=I?C(Gt):Ae,Oh=I?Math.sin(yl):Ne,vl=I?Math.cos(yl):ye,bl=l+Ye(vs,Kd,za);xi=eu*vl*bl,wi=Jd*vl*bl,ki=Oh*bl}for(let Gt=1;Gt<V-1;Gt+=Ke){let vs=0,za=0,Kd=0;{const ma=(Gt+1)*ft,Oo=I?oe:y*(1-ma)+b*ma,uc=I?ne:Oo,bs=I?x*(1-ma)+S*ma:me,pc=I?Ee:h*(1-ma)+u*ma,au=I?Ze:Math.sin(pc),Jf=I?de:Math.cos(pc),um=I?C(ma):Ae,e_=I?Math.sin(um):Ne,pm=I?Math.cos(um):ye,nu=l+Ye(Oo,bs,uc);vs=Jf*pm*nu,za=au*pm*nu,Kd=e_*nu}const dc=vs,Jd=za,eu=Kd,yl=xi,Oh=wi,vl=ki;xi=dc,wi=Jd,ki=eu;{const ma=Ce+Gt,Oo=ma*q,uc=yl-E,bs=Oh-$,pc=vl-M;G[Oo]=uc,G[Oo+1]=bs,G[Oo+2]=pc,Es(uc,bs,pc,O);const au=Gt*ft;Na(se,ma,I?ge:au,I?au:Ue)}const bl=is,p4=Hr,m4=Hi;is=yl,Hr=Oh,Hi=vl;const hm=yl,dm=Oh,tu=vl,Kf=1/Math.sqrt(hm*hm+dm*dm+tu*tu),TS=tu*Kf;let iu=0,ru=0,su=0;if(vt&&TS*TS<.999){let ma=0,Oo=0,uc=0;{const bs=k===0?-1:1;ma=bs*(dc-bl),Oo=bs*(Jd-p4),uc=bs*(eu-m4)}{const bs=Gt*ft,pc=I?oe:y*(1-bs)+b*bs,au=I?ne:pc,Jf=I?x*(1-bs)+S*bs:me,um=I?Ee:h*(1-bs)+u*bs,e_=I?Ze:Math.sin(um),pm=I?de:Math.cos(um),nu=I?C(bs):Ae,CS=I?Math.sin(nu):Ne,SS=I?Math.cos(nu):ye;let Jv=hm,e1=dm,t1=tu;if(ie){const Rh=l+ri(au-ke,Jf-Xe,He),mm=I?SS:Yi;Jv=(I?Bi:pm)*mm*Rh,e1=(I?mt:e_)*mm*Rh,t1=(I?CS:Mi)*Rh}{const Rh=l+ri(pc+ke,Jf+Xe,f),mm=I?SS:Kt,PS=(I?nt:pm)*mm*Rh,OS=(I?Yt:e_)*mm*Rh,RS=(I?CS:bi)*Rh;ie||(Jv=2*hm-PS,e1=2*dm-OS,t1=2*tu-RS);const i1=k===3?-1:1,ES=i1*(Jv-PS),AS=i1*(e1-OS),MS=i1*(t1-RS);iu=uc*AS-Oo*MS,ru=ma*MS-uc*ES,su=Oo*ES-ma*AS;const r1=1/Math.sqrt(iu*iu+ru*ru+su*su);iu*=r1,ru*=r1,su*=r1}}}else iu=hm*Kf,ru=dm*Kf,su=tu*Kf;tt.setNormalFromValues(Gt,iu,ru,su)}})()):(()=>{for(let fe=1;fe<V-1;fe+=Ke){const Oe=fe*ft,Me=I?ge:Oe,ke=I?Oe:Ue,Xe=I?oe:y*(1-Oe)+b*Oe,xt=I?x*(1-Oe)+S*Oe:me,wt=I?ne:Xe,Tt=I?Ee:h*(1-Oe)+u*Oe,Ct=I?Ze:Math.sin(Tt),Yt=I?de:Math.cos(Tt),nt=I?C(Oe):Ae,gt=I?Math.sin(nt):Ne,mt=I?Math.cos(nt):ye,Bi=Ye(Xe,xt,wt),Vt=l+Bi,bi=Yt*mt*Vt-E,Kt=Ct*mt*Vt-$,mi=gt*Vt-M;Es(bi,Kt,mi,O);const Mi=Ce+fe,Yi=Mi*q;G[Yi]=bi,G[Yi+1]=Kt,G[Yi+2]=mi,Na(se,Mi,Me,ke)}})()}}function W$(i){t5(i)}function X$(i,e){return Math.PI/2-2*Math.atan(Math.exp(-i/e))}function VK(i,e,t,r){return X$(i*(1-r)+e*r,t)}function GK(i,e,t){return i*(1-t)+e*t}function fS(i){const e=i.tile;if(e.surface.isWebMercator){const r=e.extent,s=e.ellipsoid.radius;return a=>VK(r[1],r[3],s,a)}const t=e.extentInRadians;return r=>GK(t[1],t[3],r)}function BK(i,e){const t=i.tile.extent,r=i.geometryState,s=t[0],a=t[1],n=t[2]-s,o=t[3]-a,l=r.clippingArea,c=g(l)?Math.max(0,(l[0]-s)/n):0,h=g(l)?Math.max(0,(l[1]-a)/o):0,u=g(l)?Math.min(1,(l[2]-s)/n):1,p=g(l)?Math.min(1,(l[3]-a)/o):1,m=r.numVerticesPerSide,f=(m-2)**2,y=r.neighborData.edgeResolutions.reduce((C,O)=>C+O+1,0),b=A$(f+y),x=i.geometryInfo,S=x.boundingBox;di(S),x.numVerticesPerSide=r.numVerticesPerSide,x.vertexAttributes=b,Br(x.uvRange,c,h,u,p),HK(i),J$(i,f),Q$(i),K$(x,r.numVerticesPerSide,[],[0,m-1],[0,m-1],r.wireframe),i.intersectionData=null}function HK(i){const e=i.tile;e.intersectsClippingArea&&(e.surface.shading?jK(i):kK(i))}function kK(i){const e=i.geometryState,t=e.samplerData,r=i.tile,s=r.surface,a=i.localOrigin,n=s.isWebMercatorOnPlateeCarree,o=e.clippingArea,l=g(o)?o:Qv,c=r.extent,h=c[0],u=c[1],p=c[2],m=c[3],f=Math.max(h,l[0]),y=Math.min(p,l[2]),b=Math.max(u,l[1]),x=Math.min(m,l[3]),S=a[0],C=a[1],O=a[2],R=r.ellipsoid.radius,E=r.horizontalScale,$=_S(n,R,E),M=e.numVerticesPerSide,L=M-1,F=M-2,N=i.geometryInfo,G=N.uvRange,q=G[0],se=G[1],k=G[2],I=G[3],U=N.boundingBox,V=N.vertexAttributes,z=V.position,ie=V.uv0;let re=0;for(let he=1;he<=F;he++){const oe=he/L,Re=ee(u*(1-oe)+m*oe,b,x),ne=ee(oe,se,I),me=$(Re)-C;for(let ge=1;ge<=F;ge++){const Ue=ge/L,Ee=ee(h*(1-Ue)+p*Ue,f,y),Ae=ee(Ue,q,k),Ze=Ee*E-S,de=ri(Ee,Re,t)-O;Es(Ze,me,de,U),z.setValues(re,Ze,me,de),Na(ie,re,Ae,ne),++re}}}function jK(i){const e=i.tile,t=e.surface;if(!(t.shading||Ud))return;const r=i.geometryState,s=r.samplerData,a=i.localOrigin,n=t.isWebMercatorOnPlateeCarree,o=r.clippingArea,l=g(o)?o:Qv,c=e.extent,h=c[0],u=c[1],p=c[2],m=c[3],f=Math.max(h,l[0]),y=Math.min(p,l[2]),b=Math.max(u,l[1]),x=Math.min(m,l[3]),S=e.ellipsoid.radius,C=e.horizontalScale,O=r.numVerticesPerSide,R=O-1,E=O-2,$=i.geometryInfo,M=$.vertexAttributes,L=M.position,F=M.uv0,N=M.normalCompressed,G=$.uvRange,q=G[0],se=G[1],k=G[2],I=G[3],U=$.boundingBox,V=a[0],z=a[1],ie=a[2],re=L.typedBuffer,he=L.typedBufferStride;let oe=0;const Re=ee(u,b,x),ne=n?(Math.PI/2-2*Math.atan(Math.exp(-Re/S)))*S:Re*C,me=1/R,ge=ee(u*(1-me)+m*me,b,x);let Ue=ne,Ee=n?(Math.PI/2-2*Math.atan(Math.exp(-ge/S)))*S:ge*C;for(let Ae=1;Ae<=E;Ae++){const Ze=Ae/R,de=ee(u*(1-Ze)+m*Ze,b,x),Ne=ee(Ze,se,I),ye=Ee,He=(Ae-1)/R,Ye=ee(u*(1-He)+m*He,b,x),tt=Ue,Ke=(Ae+1)/R,pt=ee(u*(1-Ke)+m*Ke,b,x),Nt=n?(Math.PI/2-2*Math.atan(Math.exp(-pt/S)))*S:pt*C,vt=ee(Ke,se,I);Ue=Ee,Ee=Nt;const ft=ee(h,f,y);let Ce=ft*C,fe=ri(ft,de,s);const Oe=1/R,Me=ee(Oe,q,k),ke=ee(h*(1-Me)+p*Me,f,y);let Xe=Me,xt=ke,wt=ke*C,Tt=ri(ke,de,s);if(Ae===1){const Ct=wt-V,Yt=Ue-z,nt=Tt-ie,gt=0*he;re[gt]=Ct,re[gt+1]=Yt,re[gt+2]=nt,Es(Ct,Yt,nt,U);const mt=ee(Oe,q,k);Na(F,oe,mt,Ne)}for(let Ct=1;Ct<=E;Ct++){const Yt=wt,nt=Tt,gt=(Ct+1)/R,mt=ee(gt,q,k),Bi=ee(h*(1-gt)+p*gt,f,y),Vt=xt;xt=Bi;{const Hi=oe+1,xi=Hi*he;if(Ae===1||Ct===E){const wi=Bi*C,ki=ri(Bi,de,s);if(Ae===1&&Ct<E){const Gt=wi-V,vs=ye-z,za=ki-ie;re[xi]=Gt,re[xi+1]=vs,re[xi+2]=za,Es(Gt,vs,za,U),Na(F,Hi,mt,Ne)}wt=wi,Tt=ki}else wt=re[xi]+V,Tt=re[xi+2]+ie}const bi=wt,Kt=Tt,mi=Ce,Mi=fe;Ce=Yt,fe=nt;const Yi=(oe-E)*he,is=Ae===1?ri(Vt,Ye,s):re[Yi+2]+ie,Hr=ri(Vt,pt,s);if(Ae<E){const Hi=oe+E,xi=Hi*he,wi=Yt-V,ki=Nt-z,Gt=Hr-ie;re[xi]=wi,re[xi+1]=ki,re[xi+2]=Gt,Es(wi,ki,Gt,U);const vs=Xe;Xe=mt,Na(F,Hi,vs,vt)}{const Hi=bi-mi,xi=tt-Nt,wi=xi*(Kt-Mi),ki=Hi*(is-Hr),Gt=-xi*Hi,vs=wi*wi+ki*ki+Gt*Gt;if(vs===0)Mf(N,oe,0,0,1);else{const za=1/Math.sqrt(vs);Mf(N,oe,wi*za,ki*za,Gt*za)}}++oe}}}function qK(i,e){i.tile.intersectsClippingArea&&(Y$(i),Z$(i,!0),Xv(i))}function WK(i,e){i.tile.intersectsClippingArea&&(Q$(i),Xv(i))}function Q$(i,e){i.tile.intersectsClippingArea&&(Y$(i),Z$(i,!1))}function Z$(i,e){const t=i.geometryState,r=t.neighborData,s=i.tile,a=s.surface,n=a.shading||Ud,o=s.extent,l=t.clippingArea,c=g(l)?l:Qv,h=o[0],u=o[2],p=o[1],m=o[3],f=[m>c[3],u>c[2],p<c[1],h<c[0]],y=i.geometryInfo,b=s.horizontalScale,x=_S(a.isWebMercatorOnPlateeCarree,s.ellipsoid.radius,b),S=y.boundingBox,C=y.uvRange[0],O=y.uvRange[1],R=y.uvRange[2],E=y.uvRange[3],$=Math.max(h,c[0]),M=Math.min(u,c[2]),L=Math.max(p,c[1]),F=Math.min(m,c[3]),N=i.localOrigin,G=N[0],q=N[1],se=N[2],k=t.samplerData;for(let I=0;I<4;++I){const U=I===1||I===3,V=r.edgeResolutions[I];Z(Xg(V));const z=V+1,ie=f[I],re=md(s,r.edgePeerNeighbors[I]);if(!ie&&i5(s,re,I)){e5(i,I,re);continue}const he=g(re)&&!ie,oe=re==null?void 0:re.renderData,Re=oe==null?void 0:oe.geometryState;if(ur&&(Z(!he||re.level===s.level),Z(!he||ql(s,re)<=0),s&&!re&&!a.updatingRootTiles)){const Ne=al[I],ye=s.findNeighborTile(Ne,He=>He.isLoaded||He.isLeaf||He.level===s.level);a.updatingRootTiles||(ye?ye.intersectsClippingArea&&(Z(!ye.isLoaded),Z(!ye.isLeaf),Z(ye.level===s.level)):Z(P(a==null?void 0:a.rootTiles)||!s.shouldHaveNeighbor(Ne)))}const ne=ee(I===1?u:h,$,M),me=ee(I===0?m:p,L,F),ge=Re==null?void 0:Re.samplerData,Ue=y.outerEdges[I],Ee=e&&z>3?z-3:1,Ae=ee(I===1?1:0,C,R),Ze=ee(I===0?1:0,O,E),de=he?(Ne,ye)=>.5*(ri(Ne,ye,ge)+ri(Ne,ye,k)):(Ne,ye)=>ri(Ne,ye,k);if(n){const Ne=(u-h)/V,ye=U?I===1?Ne:-Ne:0,He=U?0:I===0?Ne:-Ne,Ye=-ye,tt=-He;let Ke=0,pt=0,Nt=0;{const fe=0/V,Oe=U?ne:ee(h*(1-fe)+u*fe,$,M),Me=U?ee(p*(1-fe)+m*fe,L,F):me,ke=de(Oe,Me);Ke=Oe*b,pt=x(Me),Nt=ke}let vt=0,ft=0,Ce=0;{const fe=1/V,Oe=U?ne:ee(h*(1-fe)+u*fe,$,M),Me=U?ee(p*(1-fe)+m*fe,L,F):me,ke=de(Oe,Me);vt=Oe*b,ft=x(Me),Ce=ke}for(let fe=1;fe<z-1;fe+=Ee){const Oe=fe/V,Me=vt,ke=ft,Xe=Ce;{const Vt=U?Ae:ee(Oe,C,R),bi=U?ee(Oe,O,E):Ze,Kt=Me-G,mi=ke-q,Mi=Xe-se;Es(Me,mi,Mi,S),Ue.setVertexFromValuesRawPositionUV(fe,Kt,mi,Mi,Vt,bi)}{const Vt=(fe+1)/V,bi=U?ne:ee(h*(1-Vt)+u*Vt,$,M),Kt=U?ee(p*(1-Vt)+m*Vt,L,F):me,mi=de(bi,Kt);vt=bi*b,ft=x(Kt),Ce=mi}const xt=vt,wt=Ce,Tt=Ke,Ct=pt,Yt=Nt;Ke=Me,pt=ke,Nt=Xe;let nt=0,gt=0,mt=0;if(U){const Vt=ft-ke,bi=wt-Xe,Kt=Ct-ke,mi=Yt-Xe,Mi=ee(p*(1-Oe)+m*Oe,L,F),Yi=ne+Ye,is=Yi*b-Me,Hr=ri(Yi,Mi,k)-Xe,Hi=I===3?-1:1;if(nt=Hi*(-Kt+Vt)*Hr,gt=Hi*is*(-mi+bi),mt=-Hi*is*(-Kt+Vt),he){const xi=ne+ye,wi=xi*b-Me;nt=(-Kt+Vt)*(Hr-(ri(xi,Mi,ge)-Xe)),gt=(is-wi)*(-mi+bi),mt=-(is-wi)*(-Kt+Vt)}}else{const Vt=xt-Me,bi=wt-Xe,Kt=Tt-Me,mi=Yt-Xe,Mi=ee(h*(1-Oe)+u*Oe,$,M),Yi=me+tt,is=ri(Mi,Yi,k)-Xe,Hr=x(Yi)-ke,Hi=I===2?-1:1;if(nt=Hi*Hr*(-mi+bi),gt=Hi*(-Kt+Vt)*is,mt=-Hi*Hr*(-Kt+Vt),he){const xi=Mi,wi=me+He,ki=x(wi)-ke;nt=(-Hr+ki)*(-mi+bi),gt=(-Kt+Vt)*(-is+(ri(xi,wi,ge)-Xe)),mt=-(-Hr+ki)*(-Kt+Vt)}}const Bi=1/Math.sqrt(nt*nt+gt*gt+mt*mt);Ue.setNormalFromValues(fe,nt*Bi,gt*Bi,mt*Bi)}}else for(let Ne=1;Ne<z-1;Ne+=Ee){const ye=Ne/V,He=U?ne:ee(h*(1-ye)+u*ye,$,M),Ye=U?ee(p*(1-ye)+m*ye,L,F):me,tt=U?Ae:ee(ye,C,R),Ke=U?ee(ye,O,E):Ze,pt=de(He,Ye),Nt=He*b-G,vt=x(Ye)-q,ft=pt-se;Es(Nt,vt,ft,S),Ue.setVertexFromValuesRawPositionUV(Ne,Nt,vt,ft,tt,Ke)}}}function Y$(i,e){t5(i)}function XK(i,e){return(Math.PI/2-2*Math.atan(Math.exp(-i/e)))*e}function QK(i,e){return i*e}function _S(i,e,t){return i?r=>XK(r,e):r=>QK(r,t)}function K$(i,e,t,r,s,a){const n=e-1,o=i.vertexAttributes.count,l=2*(Math.min(e-2,r[1])-Math.max(1,r[0]))*(Math.min(e-2,s[1])-Math.max(1,s[0])),c=al.map((C,O)=>O===0&&s[1]<e-2||O===1&&r[1]<e-2||O===2&&s[0]>1||O===3&&r[0]>1),h=i.outerEdges.reduce((C,O,R)=>C+(c[R]?0:n-2+O.count-1),0),u=t.reduce((C,O)=>C+n*(2*(O.latitudeResolution-1)+1),0),p=a?2:1,m=3*(l+h+u)*p,f=o>=IK?new Uint32Array(m):new Uint16Array(m);let y=0;const b=e-2,x=n-2;Z(x>=0);const S=(C,O,R,E,$,M)=>{const L=C*$,F=M[L],N=M[L+1],G=M[L+2],q=O*$,se=M[q],k=M[q+1],I=M[q+2],U=R*$,V=M[U],z=M[U+1],ie=M[U+2],re=E*$,he=M[re],oe=M[re+1],Re=M[re+2];return(se-he)*(se-he)+(k-oe)*(k-oe)+(I-Re)*(I-Re)>(F-V)*(F-V)+(N-z)*(N-z)+(G-ie)*(G-ie)};if(a){const C=(R,E,$)=>{f[y++]=R,f[y++]=E,f[y++]=E,f[y++]=$,f[y++]=$,f[y++]=R,ur&&(Z(R<o),Z(E<o),Z($<o),Z(y<=m))};(()=>{for(let R=Math.max(s[0],1)-1;R<Math.min(s[1],e-2)-1;++R){const E=R*b;for(let $=Math.max(r[0],1)-1;$<Math.min(r[1],e-2)-1;++$){const M=R*b+$,L=M+1,F=L+b,N=F-1,G=E+$,q=G+1,se=q+b,k=se-1,I=i.vertexAttributes.position.typedBuffer,U=i.vertexAttributes.position.typedBufferStride;S(G,q,se,k,U,I)?(C(M,L,F),C(F,N,M)):(C(M,L,N),C(N,F,L))}}})(),Z(y===3*l*p),(()=>{for(let R=0;R<4;++R){const E=y;if(c[R])continue;const $=i.outerEdges[R],M=i.innerEdges[R];let L=0,F=0;const N=$.count,G=M.count;Z(G===n-1);let q=0;const se=R===1||R===2?(k,I,U)=>C(k,I,U):(k,I,U)=>C(k,U,I);for(;L<N-1||F<G-1;){const k=M.getVertexIndex(F),I=$.getVertexIndex(L),U=L<N-1,V=F<G-1;U&&(!V||(U?0+n*(L+.5)/(N-1):0)<=(V?1+x*(F+.5)/(G-1):0))?(++L,ur&&Z(L<N),se(k,I,$.getVertexIndex(L)),q++):(++F,ur&&Z(F<G),se(k,I,M.getVertexIndex(F)),q++)}ur&&(Z(L===N-1),Z(F===G-1),Z(q===N+G-2),Z(q===n-2+$.count-1),Z(y===E+3*q*p))}})(),Z(y===3*(l+h)*p);const O=R=>{const E=i.outerEdges[R.connectedOuterEdgeOffset];let $=E.getVertexIndex(0),M=E.stride;for(let L=0;L<R.latitudeResolution;++L){const F=L===0?R.rowOffset:$+e;for(let N=0;N<n;N++)C($,$+1,F+N),L<R.latitudeResolution-1&&C($+1,F+N+1,F+N),$+=M;$=F,M=1}};t.forEach(O)}else{(()=>{const O=Math.max(s[0],1)-1,R=Math.min(s[1],e-2)-1,E=Math.max(r[0],1)-1,$=Math.min(r[1],e-2)-1;for(let M=O;M<R;++M){const L=M*b;for(let F=E;F<$;++F){const N=L+F,G=N+1,q=G+b,se=q-1,k=i.vertexAttributes.position.typedBuffer,I=i.vertexAttributes.position.typedBufferStride;S(N,G,q,se,I,k)?(f[y]=N,f[y+1]=G,f[y+2]=q,f[y+3]=q,f[y+4]=se,f[y+5]=N):(f[y]=N,f[y+1]=G,f[y+2]=se,f[y+3]=se,f[y+4]=G,f[y+5]=q),y+=6}}})(),Z(y===3*l*p),(()=>{for(let O=0;O<4;++O){if(c[O])continue;const R=i.outerEdges[O],E=i.innerEdges[O];let $=0,M=0;const L=R.count,F=E.count;Z(F===n-1);const N=O===1||O===2,G=N?1:2,q=N?2:1,se=R.index0,k=R.stride,I=E.index0,U=E.stride;for(;$<L-1||M<F-1;){const V=I+M*U,z=se+$*k,ie=$<L-1,re=M<F-1,he=ie&&(!re||(ie?0+n*($+.5)/(L-1):0)<=(re?1+x*(M+.5)/(F-1):0));he?++$:++M;const oe=he?z+k:V+U;f[y]=V,f[y+G]=z,f[y+q]=oe,y+=3}}})(),Z(y===3*(l+h)*p);const C=O=>{const R=i.outerEdges[O.connectedOuterEdgeOffset];let E=R.getVertexIndex(0),$=R.stride;for(let M=0;M<O.latitudeResolution;++M){const L=M===0?O.rowOffset:E+e;for(let F=0;F<n;F++){const N=L+F;f[y]=E,f[y+1]=E+1,f[y+2]=N,M<O.latitudeResolution-1?(f[y+3]=E+1,f[y+4]=N+1,f[y+5]=N,y+=6):y+=3,E+=$}E=L,$=1}};t.forEach(C)}Z(y===m),i.indices=f,i.indexCount=m}function J$(i,e){const t=i.localOrigin,r=i.geometryInfo,s=i.geometryState.neighborData.edgeResolutions,a=r.numVerticesPerSide-2,n=r.vertexAttributes;let o=e;for(let l=0;l<4;++l){{const c=l===0||l===2,h=(l===0?a-1:0)*a+(l===1?a-1:0),u=(c?0:1)*a+(c?1:0);r.innerEdges[l]=new pE(n,t,h,u,a)}{const c=o,h=s[l]+1;r.outerEdges[l]=new pE(n,t,c,1,h),o+=h}}}function e5(i,e,t){const r=(e+2)%4,s=i.geometryState,a=i.tile,n=s.neighborData,o=a.level-t.level,l=e===1||e===3,c=n.edgeResolutions[e];Z(Xg(c));const h=c+1,u=i.geometryInfo,p=u.boundingBox,m=u.outerEdges[e],f=u.uvRange[0],y=u.uvRange[1],b=u.uvRange[2],x=u.uvRange[3],S=ee(e===1?1:0,f,b),C=ee(e===0?1:0,y,x),O=t.renderData,R=O.geometryState,E=O.geometryInfo.outerEdges[r],$=a.getNeighborEdgeStartVertexIndex(e,t)*c,M=c*2**o;Z(R.neighborData.edgeResolutions[r]===M),Z(E.count-1===M);const L=O.localOrigin[0]-i.localOrigin[0],F=O.localOrigin[1]-i.localOrigin[1],N=O.localOrigin[2]-i.localOrigin[2],G=m.attributes,q=m.index0,se=m.stride,k=G.position.typedBuffer,I=G.position.typedBufferStride,U=G.normalCompressed.typedBuffer,V=G.normalCompressed.typedBufferStride,z=G.uv0,ie=E.attributes,re=E.index0,he=E.stride,oe=ie.position.typedBuffer,Re=ie.position.typedBufferStride,ne=ie.normalCompressed.typedBuffer,me=ie.normalCompressed.typedBufferStride;for(let ge=1;ge<h-1;++ge){const Ue=q+se*ge,Ee=re+he*($+ge),Ae=Ue*I,Ze=Ee*Re,de=oe[Ze]+L,Ne=oe[Ze+1]+F,ye=oe[Ze+2]+N;k[Ae]=de,k[Ae+1]=Ne,k[Ae+2]=ye,Es(de,Ne,ye,p);const He=Ue*V,Ye=Ee*me;U[He]=ne[Ye],U[He+1]=ne[Ye+1];const tt=ge/c,Ke=l?S:ee(tt,f,b),pt=l?ee(tt,y,x):C;Na(z,Ue,Ke,pt)}}function t5(i){var Ze;const e=i.geometryState,t=e.neighborData,r=i.localOrigin,s=t.cornerNeighborData,a=i.geometryInfo,n=a.outerEdges,o=a.boundingBox,l=i.tile,c=((Ze=i.tile.surface.view)==null?void 0:Ze.viewingMode)==="local",h=l.ellipsoid.radius,u=l.extentInRadians,p=l.horizontalScale;let m=0,f=0,y=0;const b=(de,Ne,ye)=>{const He=u[Ne===0?1:3],Ye=u[de===0?0:2],tt=Math.cos(He),Ke=Math.sin(He),pt=Math.sin(Ye),Nt=Math.cos(Ye),vt=h+ye;m=Nt*tt*vt,f=pt*tt*vt,y=Ke*vt},x=c?(()=>{const de=i.geometryState.clippingArea,Ne=l.extent,ye=g(de)&&(Ne[3]>de[3]||Ne[2]>de[2]||Ne[1]<de[1]||Ne[0]<de[0]),He=_S(l.surface.isWebMercatorOnPlateeCarree,l.ellipsoid.radius,p);return(Ye,tt,Ke)=>{const pt=Ye===0?q[0]:q[2],Nt=tt===0?q[1]:q[3],vt=ye?ee(pt,de[0],de[2]):pt,ft=ye?ee(Nt,de[1],de[3]):Nt,Ce=Ke;m=vt*p,f=He(ft),y=Ce}})():b;let S=0,C=0,O=0,R=0,E=0,$=0,M=0,L=0,F=0;const N=c&&i.tile.surface.isWebMercatorOnPlateeCarree,G=(de,Ne,ye,He,Ye)=>{let tt=0,Ke=0,pt=0;if(c){const Nt=Ne*p,vt=N?(Math.PI/2-2*Math.atan(Math.exp(-ye/h)))*h:ye*p;tt=Nt-m,Ke=vt-f,pt=He-y}else{const Nt=fS(de),vt=de.tile,ft=vt.extent,Ce=vt.extentInRadians,fe=(Ne-ft[0])/(ft[2]-ft[0]),Oe=(ye-ft[1])/(ft[3]-ft[1]),Me=Ce[0]*(1-fe)+Ce[2]*fe,ke=Nt(Oe),Xe=Math.cos(ke),xt=Math.sin(ke),wt=Math.sin(Me),Tt=Math.cos(Me),Ct=h+He;tt=Tt*Xe*Ct-m,Ke=wt*Xe*Ct-f,pt=xt*Ct-y}switch(Ye){case 0:M+=tt,L+=Ke,F+=pt;break;case 1:R-=tt,E-=Ke,$-=pt;break;case 2:M-=tt,L-=Ke,F-=pt;break;case 3:R+=tt,E+=Ke,$+=pt}},q=l.extent,se=e.clippingArea,k=g(se)?se:Qv,I=q[0],U=q[2],V=q[1],z=q[3],ie=[z>k[3],U>k[2],V<k[1],I<k[0]],re=Math.max(I,k[0]),he=Math.min(U,k[2]),oe=Math.max(V,k[1]),Re=Math.min(z,k[3]),ne=a.uvRange[0],me=a.uvRange[1],ge=a.uvRange[2],Ue=a.uvRange[3],Ee=l.surface.shading||Ud,Ae=de=>{var ft;const Ne=s[de].cornerTiles;S=0,C=0,O=1;let ye=1/0;for(let Ce=0;Ce<4;++Ce)ye=Math.min(ye,((ft=Ne[Ce])==null?void 0:ft.level)??1/0);for(let Ce=0;Ce<4;++Ce){const fe=Ne[Ce];jm[Ce]=(fe==null?void 0:fe.level)===ye?fe:null}let He=1,Ye=0;for(let Ce=0;Ce<4;++Ce){const fe=jm[Ce];fe&&(He=Math.max(He,fe==null?void 0:fe.renderData.geometryState.numVerticesPerSide),Ye=fe.extent[2]-fe.extent[0])}const tt=Ye,Ke=He;Z(Ke>1);const pt=tt/Ke;for(let Ce=0;Ce<4;++Ce){const fe=jm[(Ce+3)%4],Oe=jm[Ce%4];if(!fe&&!Oe)continue;const Me=Ce===0?1:Ce===1?2:Ce===2?3:0,ke=Ce===0?2:Ce===1?3:Ce===2?0:1;if(fe&&Oe){const Xe=Kb[Ce][0]*pt,xt=Kb[Ce][1]*pt,wt=fe.extent,Tt=wt[Me===0||Me===1?2:0]+Xe,Ct=wt[Me===0||Me===3?3:1]+xt,Yt=Oe.extent,nt=Yt[ke===0||ke===1?2:0]+Xe,gt=Yt[ke===0||ke===3?3:1]+xt,mt=fe.renderData,Bi=Oe.renderData,Vt=ri(Tt,Ct,mt.geometryState.samplerData),bi=ri(nt,gt,Bi.geometryState.samplerData);G(mt,Tt,Ct,.5*(Vt+bi),Ce)}else{const Xe=fe??Oe,xt=fe?Me:ke,wt=Xe.extent,Tt=Kb[Ce],Ct=wt[xt===0||xt===1?2:0]+Tt[0]*pt,Yt=wt[xt===0||xt===3?3:1]+Tt[1]*pt,nt=Xe.renderData,gt=ri(Ct,Yt,nt.geometryState.samplerData);G(nt,Ct,Yt,gt,Ce)}}if(!c){const Ce=Math.sqrt(m*m+f*f+y*y);S=m/Ce,C=f/Ce,O=y/Ce}const Nt=Math.sqrt(R*R+E*E+$*$);R/=Nt,E/=Nt,$/=Nt;const vt=Math.sqrt(M*M+L*L+F*F);if(M/=vt,L/=vt,F/=vt,c||O*O<.999){S=$*L-E*F,C=R*F-$*M,O=E*M-R*L;const Ce=1/Math.sqrt(S*S+C*C+O*O);S*=Ce,C*=Ce,O*=Ce}};for(let de=0;de<4;++de){const Ne=de,ye=(de+1)%4,He=de===0||de===1?1:0,Ye=de===0||de===3?1:0,tt=ee(He,ne,ge),Ke=ee(Ye,me,Ue),pt=n[Ne],Nt=de===0||de===3?pt.count-1:0,vt=n[ye],ft=de===0||de===1?vt.count-1:0,Ce=s[de].cornerTiles;let fe=-1;for(let ke=0;ke<4;++ke){const Xe=Ce[ke];Xe&&(fe===-1||ql(Ce[fe],Xe)>0)&&(fe=ke)}const Oe=fe,Me=Ce[Oe];if(S=0,C=0,O=1,Me!==l){const ke=l.level-Me.level,Xe=2**ke,xt=[Me.lij[0]+ke,Me.lij[1]*Xe,Me.lij[2]*Xe],wt=[xt[1]+Xe===l.lij[1],de===0&&(Oe===1||Oe===0&&Me!==Ce[3])||de===1&&(Oe===0||Oe===1&&Me!==Ce[2]),xt[1]===l.lij[1]+1,de===2&&(Oe===3||Oe===2&&Me!==Ce[1])||de===3&&(Oe===2||Oe===3&&Me!==Ce[0])],Tt=wt.reduce((mt,Bi)=>mt+(Bi?1:0),0);Z(Tt===1||Tt===2);let Ct=-1,Yt=-1;const nt=Me.renderData;if(Tt===1){const mt=wt.findIndex(Vt=>Vt);Z(0<=mt&&mt<=3),Ct=(mt+2)%4;const Bi=i.geometryState.neighborData.edgeResolutions[mt];Yt=l.getNeighborEdgeStartVertexIndex(mt,Me)*Bi+Bi*(mt===0&&de===0||mt===1&&de===0||mt===2&&de===1||mt===3&&de===3?1:0)}else{Z(wt[1]||wt[3]),Ct=wt[1]?3:1;const mt=nt.geometryState.neighborData.edgeResolutions[Ct];Yt=de===0||de===3?0:mt}const gt=nt.geometryInfo.outerEdges[Ct];{const mt=pt.index0+Nt*pt.stride,Bi=vt.index0+ft*vt.stride,Vt=gt.index0+Yt*gt.stride;{const bi=gt.attributes.position,Kt=bi.typedBuffer,mi=Vt*bi.typedBufferStride,Mi=i.localOrigin,Yi=gt.localOrigin,is=Kt[mi]+Yi[0]-Mi[0],Hr=Kt[mi+1]+Yi[1]-Mi[1],Hi=Kt[mi+2]+Yi[2]-Mi[2];Es(is,Hr,Hi,o);{const xi=pt.attributes.position,wi=xi.typedBuffer,ki=mt*xi.typedBufferStride;wi[ki]=is,wi[ki+1]=Hr,wi[ki+2]=Hi}{const xi=vt.attributes.position,wi=xi.typedBuffer,ki=Bi*xi.typedBufferStride;wi[ki]=is,wi[ki+1]=Hr,wi[ki+2]=Hi}}Na(pt.attributes.uv0,mt,tt,Ke),Na(vt.attributes.uv0,Bi,tt,Ke);{const bi=gt.attributes.normalCompressed.typedBuffer,Kt=Vt*gt.attributes.normalCompressed.typedBufferStride;{const mi=pt.attributes.normalCompressed,Mi=mi.typedBuffer,Yi=mt*mi.typedBufferStride;Mi[Yi]=bi[Kt],Mi[Yi+1]=bi[Kt+1]}{const mi=vt.attributes.normalCompressed,Mi=mi.typedBuffer,Yi=Bi*mi.typedBufferStride;Mi[Yi]=bi[Kt],Mi[Yi+1]=bi[Kt+1]}}}}else{const ke=ie[Ne],Xe=ie[ye];let xt;if(ke||Xe){const Yt=ee(I*(1-He)+U*He,re,he),nt=ee(V*(1-Ye)+z*Ye,oe,Re),gt=e.samplerData;xt=ri(Yt,nt,gt)}else xt=ZK(Ce);x(He,Ye,xt),(Ee||Ud)&&Ae(de);const wt=m-r[0],Tt=f-r[1],Ct=y-r[2];Es(wt,Tt,Ct,o),pt.setVertexFromValuesRawPositionUVNormal(Nt,wt,Tt,Ct,tt,Ke,S,C,O),vt.setVertexFromValuesRawPositionUVNormal(ft,wt,Tt,Ct,tt,Ke,S,C,O)}}for(let de=0;de<4;++de)jm[de]=null}function ZK(i){var a,n;const e=i.reduce((o,l)=>Math.min(o,(l==null?void 0:l.level)??1/0),1/0);ur&&(Z(!i[0]||!i[2]||jw(i[0],i[2],ze.SOUTH_WEST)),Z(!i[1]||!i[3]||jw(i[1],i[3],ze.NORTH_WEST)));let t=0,r=0;for(let o=0;o<4;++o){const l=i[o];if(l&&l.level===e){const c=o===0||o===1,h=o===0||o===3,u=l.extent,p=u[c?0:2],m=u[h?1:3],f=(n=(a=l.renderData)==null?void 0:a.geometryState)==null?void 0:n.samplerData;r+=ri(p,m,f),t++}}const s=t?r/t:0;return Z(s!=null),s}function Xv(i){const e=i.vao,t=i.geometryInfo.vertexAttributes.position.typedBuffer;e.vertexBuffers.geometry.setSubData(t,0,0,t.length)}const Kb=[[0,1],[1,0],[0,-1],[-1,0]],Ki=new zY,Qv=s3(-1/0,-1/0,1/0,1/0),jm=[null,null,null,null];function i5(i,e,t){if(!e)return!1;const r=ql(i,e);return r>0||r===0&&t>=2}const Ud=!0;let YK=class extends uS{get horizontalScale(){return this._horizontalScaleFactor}constructor(e,t,r){super(),this._horizontalScaleFactor=1,this._extentInRenderSR=yt(),e!==void 0&&this.init(e,t,r)}init(e,t,r){super.init(e,t,r);const s=r.view.renderSpatialReference,a=r.spatialReference,n=g(s)&&l3(s)&&g(a)&&a.isGeographic?this.ellipsoid.radius*Math.PI/180:1;this._horizontalScaleFactor=n;const o=this.surface.isWebMercatorOnPlateeCarree,l=this._extentInRenderSR,c=this.extent;if(o){const h=Ge(c[0],c[1],0);Jr(h,li.WebMercator,h,li.PlateCarree);const u=Ge(c[2],c[3],0);Jr(u,li.WebMercator,u,li.PlateCarree),l[0]=h[0],l[1]=h[1],l[2]=u[0],l[3]=u[1]}else for(let h=0;h<4;++h)l[h]=c[h]*n;this.centerAtSeaLevel[0]=.5*(l[0]+l[2]),this.centerAtSeaLevel[1]=.5*(l[1]+l[3]),this.centerAtSeaLevel[2]=0,this._edgeLen=Math.max(l[2]-l[0],l[3]-l[1]),this._edgeLen2=this._edgeLen*this._edgeLen,this.updateRadiusAndCenter()}updateRadiusAndCenter(){this._updateCenter();const e=this._extentInRenderSR,t=.5*(e[2]-e[0]),r=.5*(e[3]-e[1]),s=Math.sqrt(t*t+r*r),a=.5*(this.elevationBounds[0]-this.elevationBounds[1]),n=Math.max(s,a);this._center[ji.MIDDLE][3]=n}_calculateFrustumVisibilityStatus(e){const t=this._aabb(),r=t[0],s=t[1],a=t[2],n=t[3],o=t[4],l=t[5];let c=!0;for(let h=0;h<6;h++){const u=e[h],p=u[0],m=u[1],f=u[2],y=u[3];if(p*(p>0?r:n)+m*(m>0?s:o)+f*(f>0?a:l)+y>=0)return cs.OUTSIDE;c=c&&p*(p<0?r:n)+m*(m<0?s:o)+f*(f<0?a:l)+y<=0}return c?cs.INSIDE:cs.INTERSECTS}_aabb(){const e=this._extentInRenderSR;return JN(e[0],e[1],this.elevationBounds[0],e[2],e[3],this.elevationBounds[1])}intersectsRay(e,t,r,s){return f0[0]=1/t[0],f0[1]=1/t[1],f0[2]=1/t[2],q3(this._aabb(),e,f0,r,s)}createGeometry(){BK(this.renderData,this._horizontalScaleFactor),this.setMemoryDirty()}getDefaultVerticesPerSide(){return this.level<9?3:2}updateCornerElevations(){qK(this.renderData,this._horizontalScaleFactor)}updateEdgeElevations(){WK(this.renderData,this._horizontalScaleFactor)}};const f0=T();let KK=class{constructor(){this.extent=Pt(),this.minLevel=0,this.maxLevel=0,this.callback=null}},J0=class extends Ie{constructor(){super(...arguments),this._queries=new At({initialSize:10}),this._queriesInvPtr=0,this._queryQueue=new At({initialSize:30}),this._queryPool=new lo(KK)}queryVisibleLevelRange(e,t,r,s){const a=this._queryPool.acquire();Zc(a.extent,e),a.minLevel=t??-Number.MAX_VALUE,a.maxLevel=r??Number.MAX_VALUE,a.callback=s,this._queryQueue.push(a),this.notifyChange("updating")}get updating(){return this._queryQueue.length!==0}prepare(){for(;this._queries.length<this._queries.data.length&&this._queryQueue.length>0;){const e=this._queryQueue.pop();this._queries.push(e)}this._queriesInvPtr=this._queries.length}process(){for(let e=0;e<this._queries.length;e++){const t=this._queries.data[e];this._queryPool.release(t),t.callback(e>=this._queriesInvPtr),t.callback=null}this._queries.clear(),this.notifyChange("updating")}queriesForTile(e){const t=e.level;let r=0;for(;r<this._queriesInvPtr;){const s=this._queries.data[r],a=s.extent;t>=s.minLevel&&t<=s.maxLevel&&a[0]<=e.extent[2]&&a[2]>=e.extent[0]&&a[1]<=e.extent[3]&&a[3]>=e.extent[1]?(this._queries.swapElements(r,this._queriesInvPtr-1),this._queriesInvPtr--):r++}}};d([v()],J0.prototype,"updating",null),J0=d([Y("esri.views.3d.terrain.ScaleRangeQueries")],J0);let JK=class extends uS{get convexHull(){return this._convexHull}constructor(e,t,r){super(),this._convexHull=new Array(24),this._boundingSphere=Nn(),e!==void 0&&this.init(e,t,r)}init(e,t,r){super.init(e,t,r);const s=this.ellipsoid.radius,a=this.extentInRadians[0],n=this.extentInRadians[1],o=this.extentInRadians[2],l=this.extentInRadians[3],c=e[0],h=st(n,l,.5),u=st(a,o,.5),p=c===0?0:Math.min(Math.abs(n),Math.abs(l));this._edgeLen=(o-a)*Math.cos(p)*s,this._edgeLen2=this._edgeLen*this._edgeLen,this._curvatureHeight=s-Math.sqrt(s*s-this._edgeLen2/4),e9(this.centerAtSeaLevel,u,h,this.ellipsoid.radius);const m=wn(this.centerAtSeaLevel);W(m,m),this.up=m,this.updateRadiusAndCenter()}updateRadiusAndCenter(){this._updateBoundingVolumes();const e=this._center;if(this.lij[0]===0)j(e[ji.MIDDLE],0,0,0),j(e[ji.TOP],0,0,0),j(e[ji.BOTTOM],0,0,0),e[ji.MIDDLE][3]=this.ellipsoid.radius+this.elevationBounds[1];else{this._updateCenter();const t=e[ji.MIDDLE],r=this.convexHull;let s=0;for(let a=0;a<8;++a)s=Math.max(s,eJ(t,r,3*a));e[ji.MIDDLE][3]=Math.sqrt(s)}}_calculateFrustumVisibilityStatus(e){if(!xv(e,this._boundingSphere))return cs.OUTSIDE;if(this.lij[0]<10)return cs.INTERSECTS;const t=this.convexHull,r=this.surface.view.state.camera.near;let s=!0;for(let a=0;a<g6.NUM;a++){const n=a===$i.NEAR,o=e[a],l=o[0],c=o[1],h=o[2],u=o[3]-(n?r:0);let p=!1;for(let m=0;m<8;++m){const f=3*m;if(l*t[f+0]+c*t[f+1]+h*t[f+2]+u<0){if(p=!0,!s)break}else s=!1}if(!p)return cs.OUTSIDE}return s?cs.INSIDE:cs.INTERSECTS}computeElevationBounds(){super.computeElevationBounds(),this._updateBoundingVolumes()}createGeometry(){LK(this.renderData,this._getPatchType()),this._updateBoundingVolumes(),this.setMemoryDirty()}_updateBoundingVolumes(){this._updateConvexHull(),this._updateBoundingSphere(),ur&&this._checkBVs()}_updateBoundingSphere(){const e=this._boundingSphere,t=e,r=this.elevationBounds,s=this.ellipsoid.radius,a=r[1];if(this.level===0)j(t,0,0,0),e[3]=s+a;else{const n=this.extentInRadians,o=.5*(n[0]+n[2]),l=n[1],c=n[3];Jh(RE,o,l,s),Jh(EE,o,c,s),X(t,RE,EE);const h=.5*(r[0]+r[1]);B(t,t,(s+h)/io(t));const u=this.convexHull;let p=0;const m=(y,b)=>{const x=y[0]-u[3*b+0],S=y[1]-u[3*b+1],C=y[2]-u[3*b+2];return Math.sqrt(x*x+S*S+C*C)};for(let y=0;y<8;++y){const b=m(t,y);p=Math.max(p,b)}const f=p;e[3]=f+2}}_updateConvexHull(){const e=this.extentInRadians,t=this.ellipsoid.radius;if(this.level===0)return;const r=this.elevationBounds,s=this._getPatchType(),a=this.surface.isWebMercator,n=a&&s===Sn.HAS_NORTH_POLE,o=a&&s===Sn.HAS_SOUTH_POLE,l=o||n,c=Math.PI/2,h=e[0],u=e[2],p=o?-c:e[1],m=n?c:e[3],f=.5*(h+u),y=r[0],b=t+(l?Math.min(0,y-1):y),x=(I,U,V)=>Jh(I,U,V,b),S=T(),C=T(),O=T(),R=T();x(S,h,p),x(C,h,m),x(O,u,m),x(R,u,p);const E=(I,U)=>{for(let V=0;V<3;++V)this._convexHull[3*U+V]=I[V]};E(S,0),E(C,1),E(O,2),E(R,3);const $=r[1],M=t+(l?Math.max(0,$+1):$),L=T(),F=T(),N=T();Jh(F,f,m,b),Jh(N,f,p,b),X(L,F,N),W(L,L);const G=T(),q=T(),se=(I,U)=>{Xr(q,I,U),W(q,q);const V=-J(I,G)/J(q,G);Z(V>=0),B(q,q,V),X(I,I,q)};if(2**this.lij[0]>2*this.lij[1]){const I=N,U=T();Be(U,OE,I),W(U,U),Be(G,I,U),W(G,G),Z(Pn(J(G,I)/io(I),0)),se(S,C),se(R,O),E(S,0),E(R,3)}else if(2**this.lij[0]!==2*this.lij[1]){const I=F,U=T();Be(U,OE,I),W(U,U),Be(G,U,I),W(G,G),se(C,S),se(O,R),E(C,1),E(O,2)}const k=(I,U)=>{const V=M/J(U,L);for(let z=0;z<3;++z)this._convexHull[3*I+z]=U[z]*V};k(4,S),k(5,C),k(6,O),k(7,R)}_getPatchType(){const e=this.lij[1],t=e===0,r=e===(1<<this.level)-1;return t?r?Sn.HAS_BOTH_POLES:Sn.HAS_NORTH_POLE:r?Sn.HAS_SOUTH_POLE:Sn.REGULAR}intersectsRay(e,t,r,s){const a=this._boundingSphere,n=a[3]+r,o=t[0]*t[0]+t[1]*t[1]+t[2]*t[2],l=a[0]-e[0],c=a[1]-e[1],h=a[2]-e[2],u=(l*t[0]+c*t[1]+h*t[2])/o,p=t[0]*u-l,m=t[1]*u-c,f=t[2]*u-h;return p*p+m*m+f*f<n*n}getDefaultVerticesPerSide(){return this.level<PE.length?PE[this.level]+1:2}updateCornerElevations(){UK(this.renderData),this._updateBoundingVolumes()}updateEdgeElevations(){zK(this.renderData),this._updateBoundingVolumes()}_checkBVs(){var Re;if(!ur||this.level<=2)return;const e=this._boundingSphere,t=e[3],r=e,s=T(),a=this.ellipsoid.radius,n=this.elevationBounds;n[1],n[0];const o=a+n[0],l=1,c=0,h=this._center[ji.MIDDLE][3],u=this.convexHull,p=(ne,me)=>{for(let ge=0;ge<3;++ge)ne[ge]=u[3*me+ge]};{const ne=T(),me=T(),ge=T(),Ue=T(),Ee=T(),Ae=(Ze,de,Ne,ye)=>{p(me,Ze),p(ge,de),p(Ue,Ne),Xr(me,me,ge),Xr(Ue,Ue,ge),Be(ne,me,Ue),W(ne,ne);const He=J(ne,ge);p(Ee,ye);const Ye=J(ne,Ee),tt=Math.abs(Ye-He);Z(Pn(tt,0),`Non coplanar ${Ze},${de},${Ne},${ye} diff = ${tt}`)};Ae(0,1,2,3),Ae(4,5,6,7),Ae(0,1,4,5),Ae(1,2,5,6),Ae(2,3,6,7),Ae(3,0,7,4)}const m=Fn(24),f=(ne,me,ge)=>{const Ue=4*ne;for(let Ee=0;Ee<3;++Ee)m[Ue+Ee]=me[Ee];m[Ue+3]=ge},y=T(),b=T(),x=T(),S=T(),C=(ne,me,ge,Ue)=>{p(y,me),p(b,ge),p(x,Ue),Xr(y,y,b),W(y,y),Xr(x,x,b),W(x,x),Be(S,y,x),W(S,S);const Ee=J(S,b);f(ne,S,Ee)};C(0,0,1,2),C(1,1,0,4),C(2,1,5,2),C(3,3,2,6),C(4,4,0,3),C(5,4,6,5);const O=1,R=(ne,me,ge,Ue)=>{const Ee=4*ne;return m[Ee+0]*me+m[Ee+1]*ge+m[Ee+2]*Ue-m[Ee+3]},E=(ne,me,ge,Ue)=>R(ne,me,ge,Ue)>=-O,$=(ne,me)=>E(ne,me[0],me[1],me[2]),M=2**this.lij[0]>2*this.lij[1],L=(ne,me,ge)=>Math.sqrt(r5(ne,me,ge,r[0],r[1],r[2]))<t,F=ne=>L(ne[0],ne[1],ne[2]),N=(ne,me)=>L(ne[me+0],ne[me+1],ne[me+2]),G=this.extentInRadians,q=.5*(G[0]+G[2]),se=G[1],k=G[3],I=T(),U=T();Jh(I,q,k,o),Jh(U,q,se,o);const V=M?"Upper":"Lower";let z=!0;for(let ne=0;ne<6;++ne){for(let me=0;me<8;++me){const ge=3*me,Ue=E(ne,u[ge+0],u[ge+1],u[ge+2]);z&&(z=Ue),Z(Ue,`Tile[${this.lij}] Convex hull point ${me} outside of plane ${ne}`)}Z($(ne,U),`Tile[${this.lij}] (${V}) bottom mid outside of plane ${ne}`),Z($(ne,I),`Tile[${this.lij}] (${V}) top mid outside of plane ${ne}`)}Z(z,"Not all convex hull points are inside  convex hull polyhedron"),Z(F(U),`Tile[${this.lij}] (${V}) bottom mid outside of bounding sphere`),Z(F(I),`Tile[${this.lij}] (${V}) top mid outside of bounding sphere`);for(let ne=0;ne<8;++ne){const me=N(u,3*ne);Z(me,`Tile[${this.lij}] Convex hull point ${ne} outside of bounding sphere`)}for(let ne=0;ne<6;++ne)for(let me=0;me<8;++me){const ge=3*me;E(ne,u[ge+0],u[ge+1],u[ge+2])||console.error(`Tile[${this.lij}] Convex hull point ${me} outside of plane ${ne}`)}const ie=this.extentInRadians,re=Math.max(ie[2]-ie[0],ie[3]-ie[1]),he=Math.round(re*a),oe=this.renderData;if(oe){const ne=oe.geometryInfo,me=oe.localOrigin,ge=(Re=ne.vertexAttributes)==null?void 0:Re.position;if(!ge)return;const Ue=ge.count,Ee=T(),Ae=ne.numVerticesPerSide-2,Ze=Ae*Ae,de=oe.geometryState.neighborData,Ne=de.edgeResolutions.reduce((ye,He)=>ye+He+1,0);for(let ye=0;ye<Ue;++ye){const He=ye<Ze,Ye=!He&&ye<Ze+Ne;let tt=!1,Ke=-1;if(Ye){let nt=Ze;for(let gt=0;gt<4;++gt){const mt=de.edgeResolutions[gt];if(ye===nt||ye===nt+mt-1){tt=!0;break}if(nt+=mt,ye<nt){Ke=gt;break}}}const pt=Ke,Nt=tt,vt=Ye&&!Nt,ft=Ye?de.edgePeerNeighbors[pt]:null,Ce=Ye&&ft&&ql(this,ft)>0,fe=He?"internal":vt?"edge":Nt?"corner":"pole";ge.getVec(ye,s),X(Ee,s,me);const Oe=io(Ee)-a;let Me=0,ke=!1;const Xe=n[0]-Oe,xt=Oe-n[1],wt=Xe>l,Tt=xt>l,Ct=wt||Tt,Yt=`Tile[${this.lij}].vertex[${ye}]:${fe}`+(wt?"(below)":Tt?"(above)":"")+(Ce?"(Neighbor)":"");{const nt=lT(Ee,r);if(nt>=t+c){const gt=nt-t;Ct||(console.error(`${Yt} is out of the bounding sphere by ${gt.toFixed(0)} / ${t.toFixed(0)}[tol=${c}] h=${Oe.toFixed(0)} / [${n[0].toFixed(0)}..${n[1].toFixed(0)}] (${(gt/t).toFixed(0)})`),ke=!0)}}for(let nt=0;nt<6;++nt)if(!E(nt,Ee[0],Ee[1],Ee[2])){const gt=R(nt,Ee[0],Ee[1],Ee[2]),mt=ye%Ae,Bi=(ye-mt)/Ae;nt===0&&Xe||nt===5&&xt||(console.error(`${Yt} (${mt},${Bi})|${Ae}] is out of the bounding trapezoid plane ${nt} h=${Math.round(Oe)} / [${Math.round(n[0])}..${Math.round(n[1])}] dist=${Math.round(gt)} radii = ${Math.round(t)}/${Math.round(h)}} : maxL = ${he}`),++Me)}if(ke||Me>0)break}}}};const PE=[128,64,64,32,16,8,8,4];function eJ(i,e,t){return r5(i[0],i[1],i[2],e[t+0],e[t+1],e[t+2])}function r5(i,e,t,r,s,a){const n=r-i,o=s-e,l=a-t;return n*n+o*o+l*l}const Jh=(i,e,t,r)=>{const s=Math.cos(e),a=Math.sin(e),n=Math.cos(t),o=Math.sin(t);i[0]=r*n*s,i[1]=r*n*a,i[2]=r*o},OE=[0,0,1],RE=T(),EE=T();let tJ=class{constructor(){this.fovX=0,this.fovY=0,this.relativeWidthLimit=0,this.relativeHeightLimit=0,this.maxLod=0,this.angledSplitBias=0,this.aboveGround=!0}},s5=class extends ua{constructor(){super(...arguments),this.blendMode=le.Normal}};d([D({count:le.COUNT})],s5.prototype,"blendMode",void 0);let wp=class extends s5{constructor(){super(...arguments),this.output=xr.Composite,this.baseOpacityMode=po.NotRequired,this.premultipliedSource=ro.Off,this.hasWebGL2Context=!1}};d([D({count:xr.COUNT})],wp.prototype,"output",void 0),d([D({count:po.COUNT})],wp.prototype,"baseOpacityMode",void 0),d([D()],wp.prototype,"premultipliedSource",void 0),d([D()],wp.prototype,"hasWebGL2Context",void 0);var Vd;function iJ(i){const e=new $t;if(e.include(z$),i.background===Vd.Only){const t=i.output===xr.ColorComposite;return t?e.fragment.uniforms.add(new si("backgroundColor",r=>r.backgroundColor)):(e.extensions.add("GL_OES_standard_derivatives"),e.fragment.include(dS)),e.fragment.code.add(_`
    void main() {
      gl_FragColor = vec4(${t?_`backgroundColor`:_`gridColor(uv)`}, 1.0);
    }
  `),e}return e.include(U$,i),e.fragment.uniforms.add(new lt("tex",t=>t.texture)),e.fragment.uniforms.add(new ue("opacity",t=>t.opacity)),e.fragment.code.add(_`void main() {
vec4 bgColor = getBackground(uv);
gl_FragColor = blendLayers(bgColor, texture2D(tex, uv), opacity);
}`),e}(function(i){i[i.BelowLayer=0]="BelowLayer",i[i.Only=1]="Only",i[i.COUNT=2]="COUNT"})(Vd||(Vd={}));const rJ=Object.freeze(Object.defineProperty({__proto__:null,get BackgroundMode(){return Vd},build:iJ},Symbol.toStringTag,{value:"Module"}));let sJ=class extends F${constructor(){super(...arguments),this.opacity=1,this.baseOpacity=1,this.texture=null,this.fboTexture=null,this.backgroundColor=on}},a5=class n5 extends Mt{initializeConfiguration(e,t){t.hasWebGL2Context=e.rctx.type===da.WEBGL2}initializeProgram(e){return new Rt(e.rctx,n5.shader.get().build(this.configuration),Lt)}initializePipeline(){return qe({blending:oc(ae.ONE,ae.ONE_MINUS_SRC_ALPHA),colorWrite:at})}};a5.shader=new Dt(rJ,()=>_e(()=>import("./BlendLayers.glsl-d147967b.js"),["assets/BlendLayers.glsl-d147967b.js","assets/OrderIndependentTransparency-5f7257d7.js","assets/enums-e2e92c86.js","assets/basicInterfaces-7449a8bf.js","assets/calcite-8912bd40.js","assets/index-00759e4a.js","assets/index-5026a37a.css","assets/calcite-96fa36fd.css","assets/objectResourceUtils-782953c3.js","assets/devEnvironmentUtils-5002a058.js","assets/mat3f64-50f3b9f6.js","assets/mat4f64-abdda1bb.js","assets/BufferView-379a78a4.js","assets/vec33-69c9e93b.js","assets/DefaultMaterial_COLOR_GAMMA-6ed76d86.js","assets/types-e1c0a5bf.js","assets/Version-aa0a1d91.js","assets/quat-7b70e9a8.js","assets/quatf64-f8f1c132.js","assets/resourceUtils-527631ac.js","assets/Indices-d8bff7b2.js","assets/NestedMap-1b5db22e.js","assets/requestImageUtils-d1ba3b36.js","assets/symbolColorUtils-c9d24716.js","assets/Util-6d3f024a.js","assets/sphere-d0e5285d.js","assets/VertexAttribute-15d1866a.js","assets/doublePrecisionUtils-e3c3d0d8.js","assets/Texture-563cf5e5.js","assets/FramebufferObject-8b18fc0c.js","assets/VertexElementDescriptor-2925c6af.js","assets/InterleavedLayout-d57c91d0.js","assets/vec3f32-01c06d8d.js","assets/plane-5e2b046c.js","assets/spatialReferenceEllipsoidUtils-afb35af9.js","assets/scaleUtils-d13015f2.js","assets/ElevationSamplerData-e3118b17.js","assets/Octree-499541ed.js","assets/edgeProcessing-20e12367.js","assets/deduplicate-769a6f51.js","assets/MeshComponent-788e605a.js","assets/earcut-61f7b102.js","assets/imageUtils-c2d0d1ae.js","assets/projection-5969b753.js","assets/ZoomMomentumEstimator-ef57e6a4.js","assets/floatRGBA-ca2b39ca.js","assets/dehydratedFeatures-3a140d03.js","assets/quantizationUtils-b3b2ae2a.js","assets/labelFormatUtils-71e1f841.js","assets/orientedBoundingBox-a14b97b5.js","assets/quatf32-51a323b8.js","assets/SnappingCandidate-970faec6.js","assets/callExpressionWithFeature-df1a8f01.js","assets/DefaultVertexAttributeLayouts-5f20d8dd.js","assets/geometryServiceUtils-a536bb19.js","assets/project-909a4219.js","assets/LercDecoder-65586d50.js","assets/VectorTile-d41a1f0f.js","assets/enums-fb086c25.js","assets/config-1337d16e.js","assets/TiledDisplayObject-419c008b.js","assets/DisplayObject-87c37b69.js","assets/rasterUtils-7694cc98.js","assets/resources-7587d8f4.js","assets/workerHelper-6131d203.js","assets/webgl-debug-7f880832.js","assets/RenderingContext-0f21aa0e.js","assets/ProgramCache-f29c900e.js","assets/Program-77209250.js","assets/MediaLayer-4c42fc2f.js","assets/MediaElementView-06baa4d4.js","assets/normalizeUtilsSync-3ea564a9.js","assets/resourceExtension-f31d9f10.js","assets/BoundsStore-00da37da.js","assets/PooledRBush-5a11bc7e.js","assets/prism-line-numbers-eff41b13.js","assets/label2-a2f37e65.js","assets/interactive-1de2e238.js","assets/loadable-6afd516d.js","assets/t9n-81df3a71.js","assets/observers-c89705b8.js","assets/icon-8e47fbec.js","assets/loader-c773e800.js","assets/guid-51402ee7.js","assets/prism-line-numbers-7c5d72ff.css"]));let o5=class extends wp{constructor(){super(...arguments),this.background=Vd.BelowLayer}};d([D()],o5.prototype,"background",void 0);let Jb=class{constructor(e,t,r,s,a,n){this.texture=e,this.type=t,e.retain(),this.offsetAndScale=hi(r.offset[0],r.offset[1],r.scale,r.scale),this.opacities=Ge(s,a,n)}destroy(){this.texture.release()}};const aJ=.125;let nJ=class{constructor(){this._renderParams={context:null,drawPhase:1,state:new t9({viewpoint:new Ql({targetGeometry:new Ht(0,0),scale:1,rotation:0}),size:[256,256]}),stationary:!0,pixelRatio:1,displayLevel:-1,requiredLevel:-1,globalOpacity:1,renderPass:"background",styleLayer:null,styleLayerUID:-1,painter:null,glyphMosaic:null,spriteMosaic:null,profiler:null,renderingOptions:null,requestRender:null,allowDelayedRender:!1,deltaTime:-1,timeline:null,time:0,hasClipping:!1,blendMode:null,dataUploadCounter:0,effects:null,inFadeTransition:!1,requireFBO:!1,highlightGradient:null}}dispose(){this._renderParams=null}render(e,t,r,s,a,n,o,l,c,h){const u=n.adjustLevel(t[0]),p=this._renderParams;p.context=e,p.painter=s,p.glyphMosaic=s.glyphMosaic,p.spriteMosaic=s.spriteMosaic,p.pixelRatio=h,p.displayLevel=u,p.requiredLevel=u;const m=n.getScale(t[0]),[f,y]=n.getShift(t,o*m),b=aJ*o*m/c,x=r.transforms.dvs;x[0]=b,x[4]=-b,x[6]=-1-f-l[0]*o*2,x[7]=1+y+(1-l[1])*o*2-2,p.state.size[0]=c,p.state.size[1]=c,r.stage||r.attachWithContext(e),r.triangleCount=0,s.drawTile(p,r,a)}},l5=class c5 extends Mt{initializeConfiguration(e,t){t.hasWebGL2Context=e.rctx.type===da.WEBGL2}initializeProgram(e){return new Rt(e.rctx,c5.shader.get().build(this.configuration),Lt)}initializePipeline(){return qe({blending:oc(ae.ONE,ae.ONE_MINUS_SRC_ALPHA),colorWrite:at})}};l5.shader=new Dt(lK,()=>_e(()=>import("./RasterColorizer.glsl-c71f4272.js"),["assets/RasterColorizer.glsl-c71f4272.js","assets/calcite-8912bd40.js","assets/index-00759e4a.js","assets/index-5026a37a.css","assets/calcite-96fa36fd.css","assets/OrderIndependentTransparency-5f7257d7.js","assets/enums-e2e92c86.js","assets/basicInterfaces-7449a8bf.js","assets/objectResourceUtils-782953c3.js","assets/devEnvironmentUtils-5002a058.js","assets/mat3f64-50f3b9f6.js","assets/mat4f64-abdda1bb.js","assets/BufferView-379a78a4.js","assets/vec33-69c9e93b.js","assets/DefaultMaterial_COLOR_GAMMA-6ed76d86.js","assets/types-e1c0a5bf.js","assets/Version-aa0a1d91.js","assets/quat-7b70e9a8.js","assets/quatf64-f8f1c132.js","assets/resourceUtils-527631ac.js","assets/Indices-d8bff7b2.js","assets/NestedMap-1b5db22e.js","assets/requestImageUtils-d1ba3b36.js","assets/symbolColorUtils-c9d24716.js","assets/Util-6d3f024a.js","assets/sphere-d0e5285d.js","assets/VertexAttribute-15d1866a.js","assets/doublePrecisionUtils-e3c3d0d8.js","assets/Texture-563cf5e5.js","assets/FramebufferObject-8b18fc0c.js","assets/VertexElementDescriptor-2925c6af.js","assets/InterleavedLayout-d57c91d0.js","assets/vec3f32-01c06d8d.js","assets/plane-5e2b046c.js","assets/spatialReferenceEllipsoidUtils-afb35af9.js","assets/scaleUtils-d13015f2.js","assets/ElevationSamplerData-e3118b17.js","assets/Octree-499541ed.js","assets/edgeProcessing-20e12367.js","assets/deduplicate-769a6f51.js","assets/MeshComponent-788e605a.js","assets/earcut-61f7b102.js","assets/imageUtils-c2d0d1ae.js","assets/projection-5969b753.js","assets/ZoomMomentumEstimator-ef57e6a4.js","assets/floatRGBA-ca2b39ca.js","assets/dehydratedFeatures-3a140d03.js","assets/quantizationUtils-b3b2ae2a.js","assets/labelFormatUtils-71e1f841.js","assets/orientedBoundingBox-a14b97b5.js","assets/quatf32-51a323b8.js","assets/SnappingCandidate-970faec6.js","assets/callExpressionWithFeature-df1a8f01.js","assets/DefaultVertexAttributeLayouts-5f20d8dd.js","assets/geometryServiceUtils-a536bb19.js","assets/project-909a4219.js","assets/LercDecoder-65586d50.js","assets/VectorTile-d41a1f0f.js","assets/enums-fb086c25.js","assets/config-1337d16e.js","assets/TiledDisplayObject-419c008b.js","assets/DisplayObject-87c37b69.js","assets/rasterUtils-7694cc98.js","assets/resources-7587d8f4.js","assets/workerHelper-6131d203.js","assets/webgl-debug-7f880832.js","assets/RenderingContext-0f21aa0e.js","assets/ProgramCache-f29c900e.js","assets/Program-77209250.js","assets/MediaLayer-4c42fc2f.js","assets/MediaElementView-06baa4d4.js","assets/normalizeUtilsSync-3ea564a9.js","assets/resourceExtension-f31d9f10.js","assets/BoundsStore-00da37da.js","assets/PooledRBush-5a11bc7e.js","assets/prism-line-numbers-eff41b13.js","assets/label2-a2f37e65.js","assets/interactive-1de2e238.js","assets/loadable-6afd516d.js","assets/t9n-81df3a71.js","assets/observers-c89705b8.js","assets/icon-8e47fbec.js","assets/loader-c773e800.js","assets/guid-51402ee7.js","assets/prism-line-numbers-7c5d72ff.css"]));let ey=class extends wp{constructor(){super(...arguments),this.colorizerType=Sd.Stretch,this.stretchType=zd.Noop,this.applyColormap=!0}};d([D({count:Sd.COUNT})],ey.prototype,"colorizerType",void 0),d([D({count:zd.COUNT})],ey.prototype,"stretchType",void 0),d([D()],ey.prototype,"applyColormap",void 0);let AE=class{constructor(e){this._rctx=e,this._fbos=new Map}get(e){return this._getPool(e)}dispose(){this._fbos.forEach(e=>e.dispose()),this._fbos.clear()}_getPool(e){const t=this._fbos.get(e);if(t)return t;const r=new Rs(this._rctx,{colorTarget:la.TEXTURE,depthStencilTarget:La.DEPTH_RENDER_BUFFER,width:e,height:e});return this._fbos.set(e,r),r}};const oJ=Pe.getLogger("esri.views.3d.terrain");let lJ=class{constructor(e,t){this._rctx=e,this._techniqueRepository=t,this._fbos=[],this._vectorTileHelper=new nJ,this._bindParameters=new Rv(null,null,null),this._blendLayersTechniqueConfig=new o5,this._current=0,this._lastUsedIds=new Array,this._lastCreatedBufferId=0,this._onHoldIds=new Array,this._vaoQuad=pa(this._rctx,Gf)}dispose(){this._fbos.forEach(De),this._fbos=null,this._vtFBO=De(this._vtFBO),this._vaoQuad=De(this._vaoQuad),this._vectorTileHelper=De(this._vectorTileHelper),this._backgroundTechnique=er(this._backgroundTechnique),this._applyOpacityTechnique=er(this._applyOpacityTechnique),this._blendLayersTechnique=er(this._blendLayersTechnique)}_getBlendLayersTechnique(e,t,r,s=ro.Off,a=Vd.BelowLayer){return this._blendLayersTechniqueConfig.output=t,this._blendLayersTechniqueConfig.blendMode=e,this._blendLayersTechniqueConfig.baseOpacityMode=r,this._blendLayersTechniqueConfig.premultipliedSource=s,this._blendLayersTechniqueConfig.background=a,this._blendLayersTechnique=this._techniqueRepository.releaseAndAcquire(a5,this._blendLayersTechniqueConfig,this._blendLayersTechnique),this._blendLayersTechnique}drawBackground(e,t){const r=this._getBlendLayersTechnique(le.Normal,t?xr.ColorComposite:xr.GridComposite,po.NotRequired,ro.Off,Vd.Only),s=this._rctx.bindTechnique(r,e,this._bindParameters);this._render(s)}_render(e){this._rctx.bindVAO(this._vaoQuad),e.assertCompatibleVertexAttributeLocations(this._vaoQuad),this._rctx.drawArrays(Ut.TRIANGLE_STRIP,0,Os(this._vaoQuad,"geometry"))}drawGroup(e,t,r,s,a,n=ro.On){t===xr.Composite&&(e.fboTexture=this._fbos[this.getLastOnHoldId()].get(r).colorTexture),e.texture=this.currentFBO(r).colorTexture,this.closeGroup(r);const o=this._getBlendLayersTechnique(s,t,a,n),l=this._rctx.bindTechnique(o,e,this._bindParameters);this._render(l)}drawRasterData(e,t,r,s,a,n=ro.Off){if(P(e.texture))return;e.fboTexture=t===xr.GroupBackgroundComposite||s===le.Normal&&a===po.NotRequired&&n===ro.Off?null:this.switch(r).colorTexture;const o=this._getBlendLayersTechnique(s,t,a,n),l=this._rctx.bindTechnique(o,e,this._bindParameters);this._render(l)}drawImageryTileData(e,t,r,s,a,n){const o=n.sourceLayerInfo.data;if(!o.source||(n.tile.surface.layerViewByIndex(n.layerIndex,ot.MAP).ensureSymbolizerParameters(o),!o.bind(this._rctx)))return;e.fboTexture=s===le.Normal&&a===po.NotRequired?null:this.switch(r).colorTexture;const l=this._getRasterColorizerTechnique(o,t,s,a);o.opacity=e.opacity;const c=o.getUniforms();c.scale=n.scale,c.offset=n.offset,c.backgroundColor=e.backgroundColor,c.fboTexture=e.fboTexture,c.baseOpacity=e.baseOpacity;const h=this._rctx.bindTechnique(l,c,null);this._render(h)}_getRasterColorizerTechnique(e,t,r,s){const a=e.symbolizerParameters,n=["stretch","lut","hillshade"].indexOf(a.type);return P(this._rasterColorizerConfig)&&(this._rasterColorizerConfig=new ey,this._rctx.gl.getExtension("WEBGL_color_buffer_float"),this._rctx.gl.getExtension("OES_texture_float")),this._rasterColorizerConfig.output=t,this._rasterColorizerConfig.blendMode=r,this._rasterColorizerConfig.baseOpacityMode=s,this._rasterColorizerConfig.colorizerType=n,this._rasterColorizerConfig.applyColormap=!!a.colormap,this._rasterColorizerConfig.stretchType=e.hasStretchTypeNone()?zd.Noop:zd.PerBand,this._rasterColorizerTechnique=this._techniqueRepository.releaseAndAcquire(l5,this._rasterColorizerConfig,this._rasterColorizerTechnique),this._rasterColorizerTechnique}drawVectorData(e,t,r,s,a,n,o,l,c){const h=this._rctx,u=n.sourceLayerInfo.data,p=n.tile.surface.layerViewByIndex(n.layerIndex,ot.MAP),m=a===po.Required||e.opacity<1||s!==le.Normal||t!==xr.Composite,f=m?ro.On:ro.Off;this._getBlendLayersTechnique(s,t,a,f).bindPipelineState(h);let y=null,b=null;m?(b=this.currentFBO(r),P(this._vtFBO)&&(this._vtFBO=new AE(this._rctx)),y=this._vtFBO.get(r),h.bindFramebuffer(y),this._clearCurrentFBO()):c&&h.clearSafe(Xi.DEPTH_BUFFER_BIT);try{this._vectorTileHelper.render(h,n.sourceLod,u,p.painter,p.layer.styleRepository,p.schemaHelper,Math.round(1/n.scale),n.offset,l,o)}catch(x){oJ.warnOnce("A render call containing vector tiles did not resolve correctly.",x)}return!g(y)||(h.bindFramebuffer(b),e.texture=y.colorTexture,e.offset=uh,e.scale=1,this.drawRasterData(e,t,r,s,a,f),c)}copyFBOToTexture(e){const t=this._rctx,r=t.bindTexture(e.texture,Ai.TEXTURE_UNIT_FOR_UPDATES),s=e.descriptor;t.gl.copyTexImage2D(tr.TEXTURE_2D,0,s.pixelFormat,0,0,s.width,s.height,0),e.generateMipmap(),t.bindTexture(r,Ai.TEXTURE_UNIT_FOR_UPDATES)}_clearCurrentFBO(){this._rctx.setClearColor(0,0,0,0),this._rctx.setClearDepth(1),this._rctx.clearSafe(Xi.COLOR_BUFFER_BIT|Xi.DEPTH_BUFFER_BIT)}_initFBO(e,t,r){this._rctx.bindFramebuffer(e),r&&(this._rctx.setViewport(0,0,t,t),this._clearCurrentFBO())}ensureBuffer(e){this._lastUsedIds.length=0,this._lastUsedIds.push(1),this._lastCreatedBufferId=1,this._onHoldIds.length=0,this.bind(e)}bind(e,t=0,r=!0){if(this._current=t,t>=this._fbos.length)for(let s=this._fbos.length;s<=t;s++)this._fbos.push(new AE(this._rctx));this._initFBO(this._fbos[t].get(e),e,r)}_bindNextFreeBuffer(e){this._lastUsedIds.length>0?this.bind(e,this._lastUsedIds.pop()):(this._lastCreatedBufferId++,this.bind(e,this._lastCreatedBufferId))}openGroup(e){this._onHoldIds.push(this._current),this._bindNextFreeBuffer(e)}switch(e){const t=this.currentFBO(e),r=this._current;return this._bindNextFreeBuffer(e),this._lastUsedIds.push(r),t}getLastOnHoldId(){return this._onHoldIds[this._onHoldIds.length-1]}closeGroup(e){const t=this._current;this._bindNextFreeBuffer(e),this._lastUsedIds.push(t),this._lastUsedIds.push(this._onHoldIds.pop())}unbind(){this._rctx.bindFramebuffer(null)}currentFBO(e){return this._fbos[this._current].get(e)}},cJ=class{constructor(e,t,r,s){this.start=e,this.end=t,this.blendMode=r,this.opacity=s}},hJ=class{constructor(e,t,r){this._rctx=e,this.tileSize=t,this._techniqueRepository=r,this._passParameters=new sJ,this._backgroundTexture=null,this._backgroundColor=null,this._backgroundDirty=!1,this._blackTex=null,this._maxAnisotropy=this._rctx.parameters.maxMaxAnisotropy,this._composition=new lJ(this._rctx,this._techniqueRepository),this._blackTex=new lp(zF(this._rctx,[0,0,0,1])),this._ensureBackgroundTexture(this.tileSize)}dispose(){this._composition=De(this._composition),this._backgroundTexture=er(this._backgroundTexture),this._blackTex=er(this._blackTex)}get backgroundIsGrid(){return P(this._backgroundColor)}get backgroundColor(){return this._backgroundColor}updateTileTexture(e,t){if(!e.renderData)return;const r=e.surface,s=r.baseOpacity;let a=0,n=0,o=this.tileSize,l=!1;const c=r.view.state.contentPixelRatio;let h=!1;iv.clear(),ju.length=0;const u=e.layerInfo[ot.MAP];let p=u.length,m=0;for(;m<u.length;m++){const b=r.layerViewByIndex(m,ot.MAP),x=b.layer.opacity;ME[m]=x;const S=b.fullOpacity;if(DE[m]=S,c3(b.layer)&&p>=u.length&&(p=m),Yy(b)){IE[m]=b.layer.blendMode;let O=b.layer.blendMode!=="normal";if(Vp(b.layer.parent)){const R=Ww(b.layer.parent);g(R)&&R!==""&&(O=h5(b.layer.parent)||O)}O&&(h=O,l=!1)}if(x===0&&!h){u[m].pendingUpdates&=~(Le.TEXTURE_NOFADING&Le.TEXTURE_FADING);continue}++n;const C=ex(e,m);if(C){if(u[m].pendingUpdates&=~(Le.TEXTURE_NOFADING&Le.TEXTURE_FADING),Vp(b.layer.parent)){const O=Ww(b.layer.parent);g(O)&&O!==""&&d5(b.layer.parent,m)}Ef(b)?o=Math.max(o,this.tileSize*c):s===1&&S===1&&(b.isOpaque||this._dataToTexture(C)&&C.sourceLayerInfo.data.descriptor.isOpaque)&&(l=!0),++a}}this._rctx.type===da.WEBGL1&&(o=dJ(o));const f=o/this.tileSize,y=m-1;this._ensureBackgroundTexture(this.tileSize),a!==0?a===1&&!h&&this._useLayerTexture(e,y,p,DE[y])||this._composeMapLayers(e,t,y,p,ME,IE,o,f,!l||h,iv,h):this._useBackgroundTexture(e,n)}_ensureBackgroundTexture(e){P(this._backgroundTexture)&&(this._backgroundTexture=this._buildTexture(e),this._backgroundDirty=!0),this._backgroundDirty&&(this._composition.bind(e),this._passParameters.offset=uh,this._passParameters.scale=1,this._passParameters.opacity=1,g(this.backgroundColor)&&(this._passParameters.backgroundColor=this.backgroundColor),this._composition.drawBackground(this._passParameters,g(this.backgroundColor)),this._composition.copyFBOToTexture(this._backgroundTexture),this._composition.unbind(),this._backgroundDirty=!1)}_useBackgroundTexture(e,t){let r=jl.Immediate;(e.surface.view.layerViewManager.updating||t>0)&&(r=jl.Delayed);const s=e.renderData;this._backgroundTexture&&P(s.textureReference)&&(r=jl.Immediate),s.setTextureReference(g(this._backgroundTexture)?new Jb(this._backgroundTexture,or.FADING,LE,e.surface.baseOpacity,0,1):null,r)}_useLayerTexture(e,t,r,s){const a=t<r,n=a?1:e.surface.baseOpacity,o=a?e.surface.baseOpacity:1,l=ex(e,t);return!!this._dataToTexture(l)&&(e.renderData.setTextureReference(new Jb(l.sourceLayerInfo.data,or.FADING,l,n,o,s)),!0)}_composeMapLayers(e,t,r,s,a,n,o,l,c,h,u){this._composition.ensureBuffer(o);const p=e.surface.baseOpacity;let m=!1,f=Qt.LINEAR_MIPMAP_LINEAR,y=!1,b=0;for(let C=r;C>=0;C--){const O=ex(e,C);if(!O||a[C]===0&&!u)continue;const R=C<s&&p<1&&!m;this._passParameters.baseOpacity=R?p:1;const E=this._passParameters.baseOpacity<1?po.Required:po.NotRequired;R&&(m=!0);let $=!1;h.forEach(N=>{N.start===C&&(ju.push(N),this._composition.openGroup(o),$=!0)});const M=b===0,L=$?xr.GroupBackgroundComposite:c&&M?this.backgroundIsGrid?xr.GridComposite:xr.ColorComposite:xr.Composite,F=kw[n[C]];for(XZ(O)?(this._passParameters.opacity=a[C],y=this._composition.drawVectorData(this._passParameters,L,o,F,E,O,l,this.tileSize,y)):WZ(O)?(this._passParameters.opacity=a[C],this._composition.drawImageryTileData(this._passParameters,L,o,F,E,O),this._hasNearestInterpolation(O)&&(f=Qt.NEAREST)):this._dataToTexture(O)&&(this._passParameters.texture=O.sourceLayerInfo.data.texture,this._passParameters.offset=O.offset,this._passParameters.scale=O.scale,this._passParameters.opacity=a[C],this._composition.drawRasterData(this._passParameters,L,o,F,E));ju.length>0&&ju[ju.length-1].end===C;){const N=ju.pop();this._passParameters.opacity=N.opacity,this._passParameters.offset=uh,this._passParameters.scale=1;const G=c&&M?this.backgroundIsGrid?xr.GridComposite:xr.ColorComposite:xr.Composite;this._composition.drawGroup(this._passParameters,G,o,kw[N.blendMode],E)}b++}const x=e.renderData,S=x.ensureTexture(o,()=>this._buildTexture(o,f));this._composition.copyFBOToTexture(S),this._composition.unbind(),x.setTextureReference(new Jb(S,t,LE,m?1:p,0,1))}_hasNearestInterpolation(e){const t=e.sourceLayerInfo.data;return!!t.source&&t.interpolation==="nearest"}_dataToTexture(e){if(ZZ(e)){const t=e.sourceLayerInfo;t.data=this._buildTexture(t.data),e.tile.setMemoryDirty()}return QZ(e)}setBackground(e){this._backgroundColor!==e&&(this._backgroundColor=e,this._backgroundDirty=!0)}_buildTexture(e,t=Qt.LINEAR_MIPMAP_LINEAR){if(P(e))return null;const r={target:tr.TEXTURE_2D,pixelFormat:St.RGBA,dataType:Zt.UNSIGNED_BYTE,wrapMode:kt.CLAMP_TO_EDGE,samplingMode:t,maxAnisotropy:this._maxAnisotropy,preMultiplyAlpha:!0,flipped:!0,hasMipmap:!0},s=this._rctx;let a;if(typeof e=="number")r.width=r.height=e,a=new lp(new Ai(s,r));else if(e instanceof kv)r.isOpaque=e.isOpaque,a=new lp(new Ai(s,r,e.image)),e.release();else try{r.width=e.width,r.height=e.height,a=new lp(new Ai(s,r,e))}catch{a=new lp(W3(s)),console.warn("TileRenderer: failed to execute 'texImage2D', cross-origin image may not be loaded.")}const n=s.bindTexture(a.texture,Ai.TEXTURE_UNIT_FOR_UPDATES);return a.generateMipmap(),s.bindTexture(n,Ai.TEXTURE_UNIT_FOR_UPDATES),a}get test(){return{backgroundTexture:this._backgroundTexture}}};function dJ(i){const e=xT(i),t=e*e,r=i*i;if(t===r)return i;const s=e/2;return t-r<r-s*s?e:s}function ex(i,e){ja.layerIndex=e;const t=i.layerInfo[ot.MAP][e];if(g(t.data))return zt(ja.offset,0,0),ja.tile=i,ja.scale=1,ja.sourceLod=i.lij,ja.sourceLayerInfo=t,ja;const r=t.upsampleInfo;if(g(r)){const s=r.tile.layerInfo[ot.MAP][e];return ja.tile=r.tile,fs(ja.offset,r.offset),ja.scale=r.scale,ja.sourceLod=r.tile.lij,ja.sourceLayerInfo=s,ja}return null}function Ww(i){return i.get("uid")}function h5(i){let e=i.blendMode!=="normal";return Vp(i.parent)&&(e=h5(i.parent)||e),e}function d5(i,e){Vp(i.parent)&&d5(i.parent,e);const t=Ww(i);if(g(t)&&t!==""){const r=iv.get(t);r?r.start=e:iv.set(t,new cJ(e,e,i.blendMode,i.opacity))}}const ME=new Array,DE=new Array,IE=new Array,iv=new Map,ju=new Array,ja={tile:null,sourceLayerInfo:null,sourceLod:null,offset:[0,0],scale:1,layerIndex:0},LE={offset:[0,0],scale:1},u5=200,tx=40,uJ=.8,pJ=10,gg=1e-6;function mJ(i,e,t){const r=e,s=t;let a=0,n=1/0;for(let o=0;o<3;++o){{const l=i[o];if(r[o]<l){if(s[o]<=gg)return!1;const c=(l-r[o])/s[o];a=Math.max(a,c)}else if(s[o]<=-gg){const c=(l-r[o])/s[o];n=Math.min(n,c)}if(a>n)return!1}{const l=i[o+3];if(r[o]>l){if(s[o]>=-gg)return!1;const c=(l-r[o])/s[o];a=Math.max(a,c)}else if(s[o]>=gg){const c=(l-r[o])/s[o];n=Math.min(n,c)}if(a>n)return!1}}return!0}let $E=class{constructor(e,t,r,s,a){this.aabb=e,this.axis=t,this.d=r,this.midStartIndex=s,this.rightStartIndex=a}},yS=class Xw{constructor(e,t,r,s){this.globalTriangleVertexIndices=e,this.firstTriangleIndex=t,this.positionAttribute=s,this._rayDirection=T(),this.bspNodeTree=new Array;const a=r-t,n=a<=p5?new Uint16Array(a):new Uint32Array(a);this.indices=n;for(let o=0;o<a;++o)n[o]=o;{const o=vJ(e,t,r,s.data,s.stride),l=ee(Math.log2(a/tx),2,pJ),c=(h,u,p)=>{const m=_J(n,o,h,u),f=u-h;if(f<=tx){const O=new $E(m,void 0,0,h,u);return this.bspNodeTree.push(O),O}const{axis:y,midValue:b}=yJ(m),x=fJ(n,o,h,u,y,b),S=(O,R)=>{if(p>l)return;const E=R-O;return E<tx||E>=uJ*f?void 0:c(O,R,p+1)},C=new $E(m,y,b,x.next,x.mid);return this.bspNodeTree.push(C),C.leftNode=S(h,x.next),C.rightNode=S(x.mid,u),C};c(0,a,0),this.triangleVertexIndices=bJ(n,e,t,r)}}intersectRayTriangleRange(e,t){{if(e>=t)return;const r=this.triangleVertexIndices,s=this.positionAttribute.data,a=this.positionAttribute.stride,n=this._rayOrigin,o=n[0],l=n[1],c=n[2],h=this._rayDirection,u=h[0],p=h[1],m=h[2];for(let f=e,y=3*e;f<t;++f){let b=r[y++]*a;const x=s[b++],S=s[b++],C=s[b];b=r[y++]*a;const O=s[b++],R=s[b++],E=s[b];b=r[y++]*a;const $=O-x,M=R-S,L=E-C,F=s[b++]-x,N=s[b++]-S,G=s[b]-C,q=p*G-N*m,se=m*F-G*u,k=u*N-F*p,I=$*q+M*se+L*k;if(Math.abs(I)<=Number.EPSILON)continue;const U=o-x,V=l-S,z=c-C,ie=U*q+V*se+z*k;if(I>0){if(ie<0||ie>I)continue}else if(ie>0||ie<I)continue;const re=V*L-M*z,he=z*$-L*U,oe=U*M-$*V,Re=u*re+p*he+m*oe;if(I>0){if(Re<0||ie+Re>I)continue}else if(Re>0||ie+Re<I)continue;const ne=(F*re+N*he+G*oe)/I;if(ne>=0){const me=this.indices[f]+this.firstTriangleIndex,ge=UF($,M,L,F,N,G,gJ);this._callback(ne,ge,me,!1)}}}Xw.numFacesTested+=t-e}intersectRay(e,t){Xw.numFacesTested=0;const r=Ge(e.r0[0],e.r0[1],e.r0[2]),s=Ge(e.r1[0],e.r1[1],e.r1[2]),a=s[0]-r[0],n=s[1]-r[1],o=s[2]-r[2];if(a*a+n*n+o*o<gg)return;this._rayOrigin=r;const l=this._rayDirection;l[0]=a,l[1]=n,l[2]=o;const c=this.triangleVertexIndices.length/3;this._callback=t;const h=this.bspNodeTree[0];this.intersectRayBSP(h,0,c)}intersectRayBSP(e,t,r){const s=this._rayOrigin,a=this._rayDirection;if(!mJ(e.aabb,s,a))return;const n=e.axis,o=e.d;if(s[n]<o||a[n]<0){const l=t,c=e.midStartIndex;if(l<c){const h=e.leftNode;h!==void 0?this.intersectRayBSP(h,l,c):this.intersectRayTriangleRange(l,c)}}if(this.intersectRayTriangleRange(e.midStartIndex,e.rightStartIndex),s[n]>o||a[n]>0){const l=e.rightStartIndex,c=r;if(l<c){const h=e.rightNode;h!==void 0?this.intersectRayBSP(h,l,c):this.intersectRayTriangleRange(l,c)}}}get estimatedMemoryUsage(){return this.triangleVertexIndices.byteLength+this.indices.byteLength}};yS.numFacesTested=0;const gJ=T(),qu=[1/0,1/0,1/0],Wu=[-1/0,-1/0,-1/0];function fJ(i,e,t,r,s,a){let n=t,o=r;for(;n<o;){const c=i[n];e[6*c+s+3]<=a?++n:(--o,i[n]=i[o],i[o]=c)}let l=n;for(o=r;l<o;){const c=i[o-1];e[6*c+s]>=a?--o:(i[o-1]=i[l],i[l]=c,++l)}return{next:n,mid:l}}function _J(i,e,t,r){if(r<=t)return bx(NaN,NaN,NaN,NaN,NaN,NaN);{const s=6*i[t];for(let a=0;a<3;++a)qu[a]=e[s+0+a],Wu[a]=e[s+3+a]}for(let s=t+1;s<r;++s){const a=6*i[s];for(let n=0;n<3;++n)qu[n]=Math.min(qu[n],e[a+0+n]),Wu[n]=Math.max(Wu[n],e[a+3+n])}return bx(qu[0],qu[1],qu[2],Wu[0],Wu[1],Wu[2])}function yJ(i){const e=i[3]-i[0],t=i[4]-i[1],r=i[5]-i[2],s=e>t?e>r?0:t>r?1:2:t>r?1:r>e?2:0;return{axis:s,midValue:(i[s]+i[s+3])/2}}function vJ(i,e,t,r,s){const a=t-e,n=new Float32Array(6*a);for(let o=0;o<a;++o){const l=3*(o+e),c=i[l+0]*s,h=i[l+1]*s,u=i[l+2]*s;for(let p=0;p<3;++p){const m=r[c+p],f=r[h+p],y=r[u+p];n[6*o+p]=Math.min(m,f,y),n[6*o+3+p]=Math.max(m,f,y)}}return n}function bJ(i,e,t,r){const s=r-t;let a=0;for(let o=t;o<r;++o)for(let l=0;l<3;++l)a=Math.max(e[3*o+l],a);const n=a<=p5?new Uint16Array(3*s):new Uint32Array(3*s);for(let o=0;o<s;++o){const l=3*(i[o]+t);for(let c=0;c<3;++c){const h=e[l+c];n[3*o+c]=h}}return n}const p5=65535;let gi=class extends Vn{constructor(){super(...arguments),this.output=A.Color,this.overlayMode=Wl.Disabled,this.tileBlendInput=nl.LayerOnly,this.spherical=!1,this.doublePrecisionRequiresObfuscation=!1,this.atmosphere=!1,this.receiveShadows=!1,this.hasSlicePlane=!1,this.backfaceCullingEnabled=!1,this.stencilEnabled=!1,this.textureFadingEnabled=!1,this.renderOccluded=!1,this.hasScreenSpaceReflections=!1,this.hasCloudsReflections=!1,this.shading=!Ot.TERRAIN_USE_LEGACY_SHADING,this.useLegacyTerrainShading=Ot.TERRAIN_USE_LEGACY_SHADING,this.invisible=!1,this.tileBorders=!1,this.visualizeNormals=!1,this.screenSizePerspective=!1,this.receiveAmbientOcclusion=!1,this.pbrMode=Wt.Terrain}};d([D({count:A.COUNT})],gi.prototype,"output",void 0),d([D({count:Wl.COUNT})],gi.prototype,"overlayMode",void 0),d([D({count:nl.COUNT})],gi.prototype,"tileBlendInput",void 0),d([D()],gi.prototype,"spherical",void 0),d([D()],gi.prototype,"doublePrecisionRequiresObfuscation",void 0),d([D()],gi.prototype,"atmosphere",void 0),d([D()],gi.prototype,"receiveShadows",void 0),d([D()],gi.prototype,"hasSlicePlane",void 0),d([D()],gi.prototype,"backfaceCullingEnabled",void 0),d([D()],gi.prototype,"stencilEnabled",void 0),d([D()],gi.prototype,"textureFadingEnabled",void 0),d([D()],gi.prototype,"renderOccluded",void 0),d([D()],gi.prototype,"hasScreenSpaceReflections",void 0),d([D()],gi.prototype,"hasCloudsReflections",void 0),d([D()],gi.prototype,"shading",void 0),d([D()],gi.prototype,"useLegacyTerrainShading",void 0),d([D()],gi.prototype,"invisible",void 0),d([D()],gi.prototype,"tileBorders",void 0),d([D()],gi.prototype,"visualizeNormals",void 0),d([D()],gi.prototype,"screenSizePerspective",void 0),d([D()],gi.prototype,"receiveAmbientOcclusion",void 0),d([D({count:Wt.COUNT})],gi.prototype,"pbrMode",void 0),d([D({constValue:Rn.CompressedAttribute})],gi.prototype,"normalType",void 0),d([D({constValue:mh.Compressed})],gi.prototype,"textureCoordinateType",void 0),d([D({constValue:!1})],gi.prototype,"highStepCount",void 0),d([D({constValue:!1})],gi.prototype,"useCustomDTRExponentForWater",void 0),d([D({constValue:!1})],gi.prototype,"useFillLights",void 0);const ix=7,xJ=10,rx=_s();var vr;(function(i){i[i.Opaque=0]="Opaque",i[i.Semitransparent=1]="Semitransparent",i[i.TransparentWithDraped=2]="TransparentWithDraped",i[i.Empty=3]="Empty"})(vr||(vr={}));let xa=class extends Ie{get _isGlobal(){return this._stage.viewingMode===ve.Global}get shading(){return this._techniqueConfiguration.shading}set shading(e){this._techniqueConfiguration.shading=e}constructor(e){super(e),this.type=ci.TERRAIN,this.isGround=!0,this._tileSize=256,this._techniqueConfiguration=new gi,this._passParameters=new G$,this._rctx=null,this._renderDataPool=new lo(MK),this._patchGroups=new Map,this._patchGroupsDirty=!0,this._patchSortingDirty=!0,this._tileIterator=new D$,this._highestVisibleLODTile=null,this._visible=!0,this._transparencyState=vr.Opaque,this._velvetOverground=!0,this._castShadows=!0,this._emptyTex=null,this._tileRenderer=null,this._stencilEnabledLayerExtents=new Array,this._numTilesRendered=0,this._numTilesCulled=0,this._numOriginsRendered=0,this.needsHighlight=!1,this.renderOccludedFlags=qi.Occlude}initialize(){const e=[K.OPAQUE_TERRAIN,K.TRANSPARENT_TERRAIN,K.OCCLUDED_TERRAIN];this._stage.addRenderPlugin(e,this)}destroy(){this._stage.removeRenderPlugin(this),$Y()}get canRender(){return this._visible&&!!this._rootTiles&&!this.renderingDisabled}set renderingDisabled(e){this._set("renderingDisabled",!!e),this.setDirty()}set transparency(e){this._transparencyState!==e&&(this._techniqueConfiguration.invisible=e===vr.TransparentWithDraped||e===vr.Empty,this._transparencyState=e,this.setNeedsRender())}get transparency(){return this._transparencyState}get needsLinearDepth(){return this._overlayRenderer.hasWater}get renderPatchBorders(){return!!this._techniqueConfiguration.tileBorders}set renderPatchBorders(e){this._techniqueConfiguration.tileBorders!==e&&(this._techniqueConfiguration.tileBorders=e,this.setNeedsRender(),this.notifyChange("renderPatchBorders"))}get visualizeNormals(){return!!this._techniqueConfiguration.visualizeNormals}set visualizeNormals(e){this._techniqueConfiguration.visualizeNormals!==e&&(this._techniqueConfiguration.visualizeNormals=e,this.setNeedsRender(),this.notifyChange("visualizeNormals"))}get cullBackFaces(){return this._techniqueConfiguration.backfaceCullingEnabled}set cullBackFaces(e){this._techniqueConfiguration.backfaceCullingEnabled!==e&&(this._techniqueConfiguration.backfaceCullingEnabled=e,this.notifyChange("cullBackFaces"),this.setNeedsRender())}set renderOrder(e){this._set("renderOrder",e),this._setSortingDirty()}set velvetOverground(e){this._velvetOverground!==e&&(this._velvetOverground=e,this.setNeedsRender())}get layerUid(){return jc}get slicePlaneEnabled(){return this._techniqueConfiguration.hasSlicePlane}set slicePlaneEnabled(e){this._techniqueConfiguration.hasSlicePlane!==e&&(this._techniqueConfiguration.hasSlicePlane=e,this.setNeedsRender())}set textureFadingEnabled(e){this._techniqueConfiguration.textureFadingEnabled!==e&&(this._techniqueConfiguration.textureFadingEnabled=e,this.setNeedsRender())}set pbrMode(e){this._techniqueConfiguration.pbrMode!==e&&(this._techniqueConfiguration.pbrMode=e,this.setNeedsRender())}setDebugScreenSizePerspective(e){this._techniqueConfiguration.screenSizePerspective!==e&&(this._techniqueConfiguration.screenSizePerspective=e,this.setNeedsRender())}setRootTiles(e){this._rootTiles=e,this.setDirty()}setNeedsHighlight(e){this.needsHighlight=e,this.setNeedsRender()}setRenderOccludedOverlay(e){this.renderOccludedFlags=e?jy:qi.Occlude,this.setNeedsRender()}setStencilEnabledLayerExtents(e){this._stencilEnabledLayerExtents=e,this._setSortingDirty()}setTileSize(e){this._tileSize=e,g(this._tileRenderer)&&(this._tileRenderer.tileSize=e),this.setDirty()}_prepareTileForLoading(e){e.renderData||(e.renderData=this._renderDataPool.acquire(),e.renderData.init(e),e.renderData.localOrigin=this._getLocalOriginOfTile(e))}loadTile(e){this._prepareTileForLoading(e),this.updateTileGeometryState(e),this.updateTileTexture(e,Le.TEXTURE_FADING)}updateTileTexture(e,t){g(this._tileRenderer)&&(this._tileRenderer.updateTileTexture(e,t===Le.TEXTURE_FADING?or.FADING:or.UNFADED),this.setNeedsRender(),e.resetPendingUpdate(t))}updateTileGeometryState(e){for(const r of e.layerInfo[ot.ELEVATION])r.pendingUpdates&=~Le.GEOMETRY;e.resetPendingUpdate(Le.GEOMETRY);const t=e.renderData.updateGeometryState();return t&&this.setDirty(),t}updateGeometryIfNeeded(e){e.isLoaded&&e.renderData.updateGeometryIfNeeded(this._rctx)}unloadTile(e){const t=e.renderData;t&&(t.releaseGeometry(),this._renderDataPool.release(t),t.clear(),e.renderData=null,e.setMemoryDirty(),this.setDirty())}_getLocalOriginOfTile(e){const t=xJ-ix,r=Math.max(0,Math.floor((e.level-t)/ix)*ix);if(this._isGlobal&&r===0)return on;for(;e.parent&&e.level>r;)e=e.parent;return e.centerAtSeaLevel}setVisibility(e){this._visible=e,this.setDirty()}getStats(){return{numTilesRendered:this._numTilesRendered,numTilesCulled:this._numTilesCulled,numOriginsRendered:this._numOriginsRendered}}set wireframe(e){this._get("wireframe")!==e&&(this._set("wireframe",e),this.setNeedsRender())}setDirty(e=Wi.UPDATE){this._patchGroupsDirty=!0,this._context.requestRender(e)}_setSortingDirty(e=Wi.UPDATE){this._patchSortingDirty=!0,this._context.requestRender(e)}setNeedsRender(e=Wi.UPDATE){this._context.requestRender(e)}initializeRenderContext(e){this._context=e,this._rctx=e.renderContext.rctx,this._techniqueRepository=e.techniqueRepository,this._tileRenderer=new hJ(this._rctx,this._tileSize,this._techniqueRepository),this.updateTileBackground(),this._emptyTex=W3(this._rctx)}uninitializeRenderContext(){this._emptyTex=De(this._emptyTex),this._tileRenderer=De(this._tileRenderer)}intersect(e,t,r,s){if(!this._rootTiles||e.options.selectOpaqueTerrainOnly&&e.options.selectionMode&&this.transparency!==vr.Opaque)return;const a=wJ,n=TJ;Q(a,s,r),j(n,1/a[0],1/a[1],1/a[2]);const o=e.results.min,l=e.results.max,c=e.results.ground,h=e.options.store===Vr.MIN,u=!!e.results.ground.target,p=VF(e.verticalOffset),m=e.tolerance;let f,y=h&&g(o.dist)?o.dist:1/0;const b=S=>{const C=S.renderData;if(!(C!=null&&C.vao))return;const O=C.geometryInfo;fT(rx,O.boundingBox);const R=C.localOrigin;g(p)&&(p.localOrigin=R,p.applyToAabb(rx));const E=rx;if(Xu[0]=r[0]-R[0],Xu[1]=r[1]-R[1],Xu[2]=r[2]-R[2],!q3(E,Xu,n,m,y))return;const $=(k,I,U)=>{k.set(this.type,S,I,U,ph),y=h&&g(o.dist)?o.dist:1/0},M=(k,I)=>{if(g(I)&&k>=0&&(e.options.backfacesTerrain||J(I,a)<0)&&(e.options.invisibleTerrain||!e.options.selectionMode||t==null||t(r,s,k))){if((c.dist==null||k<c.dist)&&$(c,k,I),e.options.isFiltered)return;e.options.store===Vr.ALL&&(P(f)?(f=hC(e.ray),$(f,k,I),e.results.all.push(f)):k<f.dist&&$(f,k,I)),(o.dist==null||k<o.dist)&&$(o,k,I),e.options.store!==Vr.MIN&&(l.dist==null||k>l.dist)&&$(l,k,I)}},L=CJ;Q(L,s,R);const F=O.indices,N=O.vertexAttributes,G=N.getField(w.POSITION,_h),q=new be(G.typedBuffer,3,!1,N.stride/4),se=O.indexCount/3;if(P(p)&&se>u5){const k=S.renderData;P(k.intersectionData)&&(k.intersectionData=new yS(F,0,se,q)),k.intersectionData.intersectRay({r0:Xu,r1:L},M)}else $T(Xu,L,0,se,F,q,null,p,M)},x=this._rootTiles;g(x)&&(()=>{const S=this._tileIterator;S.reset(x);const C=e.options.invisibleTerrain;for(let O=S.next();O;O=S.next())!(O.visible||C&&O.intersectsClippingArea)||!g(p)&&!O.intersectsRay(r,a,m,y)||u&&this._useStencilForTile(O)?S.skipSubtree():b(O)})()}processScaleRangeQueries(e,t){var r;if(!t.done)for(this._updatePatchGroups();e.updating&&!t.done;){e.prepare();for(const s of this._patchGroups.values())for(const a of s)g((r=a.renderData)==null?void 0:r.textureReference)&&e.queriesForTile(a);e.process(),t.madeProgress()}}prepareTechnique(e){if(e.bindParameters.slot===K.OCCLUDED_TERRAIN){if(!(e.renderOccludedMask&jy))return null}else{const t=this.transparency===vr.Opaque?K.OPAQUE_TERRAIN:K.TRANSPARENT_TERRAIN;if(e.bindParameters.slot!==t)return null}switch(e.output){case A.Color:return this.transparency===vr.Empty?null:(this._techniqueConfiguration.hasScreenSpaceReflections=e.bindParameters.ssr.enabled,this._techniqueConfiguration.hasCloudsReflections=g(e.bindParameters.cloudsFade.data),this._techniqueConfiguration.receiveShadows=e.bindParameters.shadowMap.ready,this._techniqueConfiguration.receiveAmbientOcclusion=e.bindParameters.ssaoHelper.active,this._techniqueConfiguration.overlayMode=this._overlayRenderer.isEmpty?Wl.Disabled:this._overlayRenderer.hasWater?Wl.EnabledWithWater:Wl.Enabled,this._updateTechnique(A.Color,e.bindParameters.slot===K.OCCLUDED_TERRAIN));case A.Shadow:case A.ShadowExcludeHighlight:return this._castShadows&&e.bindParameters.lighting.globalFactor===1?(this._techniqueConfiguration.receiveShadows=this._techniqueConfiguration.receiveAmbientOcclusion=!1,this._updateTechnique(A.Shadow,!1)):null;case A.Depth:return this.transparency===vr.Empty?null:(this._techniqueConfiguration.receiveShadows=this._techniqueConfiguration.receiveAmbientOcclusion=!1,this._updateTechnique(A.Depth,!1));case A.Normal:return this.transparency===vr.Empty?null:(this._techniqueConfiguration.receiveShadows=this._techniqueConfiguration.receiveAmbientOcclusion=!1,this._updateTechnique(A.Normal,!1));case A.ObjectAndLayerIdColor:return this.transparency===vr.Empty?null:this._updateTechnique(A.ObjectAndLayerIdColor,!1);case A.Highlight:return this.transparency!==vr.Empty&&this.needsHighlight?(this._techniqueConfiguration.receiveShadows=this._techniqueConfiguration.receiveAmbientOcclusion=!1,this._updateTechnique(A.Highlight,!1)):null}return null}render(e,t){const r=e.bindParameters.lighting.globalFactor===1;switch(this._updatePatchGroups(),t.useStencil=!1,e.output){case A.Color:{const s=e.bindParameters.slot===K.OCCLUDED_TERRAIN?Xs.Occluded:Xs.ColorAndWater;this.transparency===vr.Opaque?this._renderMaterialPass(e,t,s):e.offscreenRenderingHelper.renderToTargets(()=>this._renderMaterialPass(e,t,s),e.offscreenRenderingHelper.tmpColor,e.offscreenRenderingHelper.mainDepth,[0,0,0,0]);break}case A.Depth:case A.Normal:this._renderAuxiliaryPass(e,t,Xs.None);break;case A.Highlight:this.needsHighlight&&this._renderAuxiliaryPass(e,t,Xs.Highlight);break;case A.Shadow:case A.ShadowExcludeHighlight:this._castShadows&&r&&this._renderAuxiliaryPass(e,t,Xs.None);break;case A.ObjectAndLayerIdColor:this._renderAuxiliaryPass(e,t,Xs.ObjectAndLayerIdColor)}}_renderMaterialPass(e,t,r){const{rctx:s}=e;this._passParameters.overlaySource=r,s.bindTechnique(t,this._passParameters,e.bindParameters),this._numTilesRendered=0,this._numTilesCulled=0,this._numOriginsRendered=0,this._renderPatchGroups(e,t,r)}_renderAuxiliaryPass(e,t,r){const s=e.rctx;this._passParameters.overlaySource=r,s.bindTechnique(t,this._passParameters,e.bindParameters),this._renderPatchGroupsAuxiliary(e,t,r)}updateTileBackground(e=null){if(P(this._tileRenderer))return;const t=this._tileRenderer;let r=null;if(g(e)){const s=ui.toUnitRGBA(e);r=Ge(s[0]||0,s[1]||0,s[2]||0)}t.setBackground(r),this._allTiles.forAll(s=>t.updateTileTexture(s,or.FADING)),this._techniqueConfiguration.tileBlendInput=t.backgroundIsGrid?nl.GridComposite:g(t.backgroundColor)?nl.ColorComposite:nl.LayerOnly,this.setNeedsRender()}_updatePatchGroups(){if(this._patchGroupsDirty&&(this._highestVisibleLODTile=null,this._rebuildPatchGroups(),this._patchGroupsDirty=!1,this._patchSortingDirty=!0),this._patchSortingDirty&&this.renderOrder!==Zp.NONE){const e=Array.from(this._patchGroups.values()),t=this._stencilEnabledLayerExtents;for(const r of e)I$(this.renderOrder,r,t);e.sort((r,s)=>L$(r[0],s[0],this.renderOrder)),this._patchGroups=new Map(e.map(r=>[r[0].renderData.localOrigin,r])),this._patchSortingDirty=!1}}_rebuildPatchGroups(){var t;const e=this._rootTiles;if(!P(e)){(t=e[0])==null||t.surface.checkAllTilesWaterproofness(),this._patchGroups.clear();for(const r of e)this._rebuildPatchGroupsForRootTile(r)}}_rebuildPatchGroupsForRootTile(e){const t=this._tileIterator;for(t.resetOne(e);!t.done;){const r=t.next(),s=r.renderData;if(!s){this._numTilesCulled++;continue}if(!r.visible){this._numTilesCulled++,t.skipSubtree();continue}const a=s.localOrigin;let n=this._patchGroups.get(a);n||(n=new Array,this._patchGroups.set(a,n)),n.push(r),(!this._highestVisibleLODTile||r.vlevel>this._highestVisibleLODTile.vlevel)&&(this._highestVisibleLODTile=r),t.skipSubtree()}}_useStencilForTile(e){for(const t of this._stencilEnabledLayerExtents)if(e.intersectsExtent(t))return!0;return!1}_renderPatchGroupsAuxiliary(e,t,r){const s=this._stencilEnabledLayerExtents.length>0;this._patchGroups.forEach(a=>{const n=a[0].renderData.localOrigin;t.program.bindDraw(new Cw(n),e.bindParameters,this._passParameters);for(let o=0;o<a.length;o++)this._renderPatch(e,t,a[o],Ut.TRIANGLES,s,r)}),e.rctx.bindVAO(null)}_renderPatchGroups(e,t,r){const s=e.bindParameters.camera,a=t.program;if(this._techniqueConfiguration.screenSizePerspective&&this.pointsOfInterest){const u=k3(this._stage.viewingMode,this._ellipsoidRadius),p=this.pointsOfInterest.centerOnSurfaceFrequent.distance;u.update({distance:p,fovY:s.fovY})}const n=this._stencilEnabledLayerExtents.length>0,o=r===Xs.Occluded;o&&(a.bindTexture("tex",this._emptyTex),a.setUniform3fv("textureOpacities",on),a.setUniform4fv("texOffsetAndScale",Bl));const l=g(this._tileRenderer)&&g(this._tileRenderer.backgroundColor)?this._tileRenderer.backgroundColor:on;this._techniqueConfiguration.tileBlendInput===nl.ColorComposite&&a.setUniform3fv("backgroundColor",l);const c=this.wireframe?Ut.LINES:Ut.TRIANGLES;this._techniqueConfiguration.textureFadingEnabled&&a.bindTexture("texNext",this._emptyTex);const h=this._patchGroups;for(const u of h.values()){const p=u[0].renderData.localOrigin;t.program.bindDraw(new Cw(p),e.bindParameters,this._passParameters),this._numOriginsRendered++;for(const m of u){const f=m.renderData,y=f.textureReference;if(!P(y)){if(!o){a.setUniform4fv("texOffsetAndScale",y.offsetAndScale),a.bindTexture("tex",y.texture.texture);const b=f.textureFadeFactor,x=b<1?f.nextTextureReference:null;this._techniqueConfiguration.textureFadingEnabled&&g(x)&&b<1?(a.setUniform1f("fadeFactor",b),a.setUniform4fv("nextTexOffsetAndScale",x.offsetAndScale),a.setUniform3fv("nextTexOpacities",x.opacities),a.bindTexture("texNext",x.texture.texture)):a.setUniform1f("fadeFactor",1),f.textureIsFading&&this.setNeedsRender(),a.setUniform3fv("textureOpacities",y.opacities)}this._renderPatch(e,t,m,c,n,r),m.renderOrder=this._numTilesRendered,this._numTilesRendered++}}}e.rctx.bindVAO(null)}_renderPatch(e,t,r,s,a,n){const o=r.renderData,l=o.vao,c=l.indexBuffer;if(P(c))return void(ur&&console.error("Rendered tile with no indices: ",r.lij," : ",o));const h=t.program;n===Xs.None||this._overlayRenderer.isEmpty||this._bindOverlayPatchData(h,o.overlay),a&&(t.useStencil=this._useStencilForTile(r),t.bindPipelineState(e.rctx,e.bindParameters.slot));const u=o.geometryInfo.indexCount;e.rctx.bindVAO(l),h.assertCompatibleVertexAttributeLocations(l),e.rctx.drawElements(s,u,c.indexType,0)}_bindOverlayPatchData(e,t){e.setUniform4fv("overlayTexOffset",t.offsets),e.setUniform4fv("overlayTexScale",t.scales)}_updateTechnique(e,t){return this._techniqueConfiguration.output=e,e===A.Color&&(this._techniqueConfiguration.atmosphere=this._isGlobal&&this._velvetOverground),this._techniqueConfiguration.renderOccluded=t,this._techniqueConfiguration.stencilEnabled=!1,this._shaderTechnique=this._techniqueRepository.releaseAndAcquire(B$,this._techniqueConfiguration,this._shaderTechnique),this._shaderTechnique}get test(){return{tileRenderer:this._tileRenderer}}};d([v({constructOnly:!0})],xa.prototype,"_overlayRenderer",void 0),d([v({constructOnly:!0})],xa.prototype,"_stage",void 0),d([v({readOnly:!0})],xa.prototype,"_isGlobal",null),d([v({constructOnly:!0})],xa.prototype,"_allTiles",void 0),d([v({constructOnly:!0})],xa.prototype,"_ellipsoidRadius",void 0),d([v({value:!1})],xa.prototype,"renderingDisabled",null),d([v()],xa.prototype,"renderPatchBorders",null),d([v()],xa.prototype,"visualizeNormals",null),d([v()],xa.prototype,"cullBackFaces",null),d([v({value:Zp.FRONT_TO_BACK})],xa.prototype,"renderOrder",null),d([v()],xa.prototype,"wireframe",null),xa=d([Y("esri.views.3d.terrain.TerrainRenderer")],xa);const wJ=T(),TJ=T(),Xu=T(),CJ=T();let SJ=class{constructor(){this.numNodes=0,this.numLeaves=0,this.numVisible=0,this.numRendered=0,this.numSplit=0,this.numMerged=0,this.numRenderedPerLevel=new Array,this.numLoadedPerLevel=new Array}},Ho=class extends Ie{constructor(e){super(e),this._handles=new Vi}initialize(){this._handles.add(this.layers.on("change",()=>this._update())),this._handles.add(te(()=>this.extentHelper.layerViewsExtent,()=>this._setAdHocTilingScheme())),this._update(),this.tilingSchemeLocked||this._setAdHocTilingScheme()}destroy(){this._handles=Te(this._handles),this._waitTask=null}_update(){if(this._waitTask=null,this.tilingSchemeLocked)return;let e;if(this.layers.some(t=>!(!xg(t)||t.isRejected())&&!(t.isFulfilled()&&!PJ(t,this.viewSpatialReference,this.viewingMode))&&(e=t,!((t==null?void 0:t.type)==="vector-tile"||Zy(t)))),e)if(e.isResolved()){const t=qv(e,this.viewSpatialReference,this.viewingMode);if(g(t)){const r=new Ra(t.tileInfo);this._lockTilingScheme(r)}}else this._updateWhen(e)}_updateWhen(e){const t=e.when().catch(()=>{}).then(()=>{t!==this._waitTask||this.destroyed||this._update()});this._waitTask=t}_lockTilingScheme(e){if(this.viewingMode===ve.Global){const t=e.levels.length-1;e.spatialReference.isWebMercator?e=Ra.makeWebMercatorAuxiliarySphere(t):Pd(e.spatialReference)&&(e=Ra.makeGCSWithTileSize(e.spatialReference,e.pixelSize,t))}this.tilingSchemeLocked=!0,this.tilingScheme=e,this.extentHelper.tilingScheme=this.tilingScheme,this._updateTiledLayerExtent(),this._handles.removeAll(),this._handles.add(te(()=>this.extentHelper.tiledLayersExtent,()=>this._updateTiledLayerExtent()))}_updateTiledLayerExtent(){this._set("extent",this.extentHelper.tiledLayersExtent)}_setAdHocTilingScheme(){if(this.viewingMode===ve.Global){const e=this.extentHelper.viewSpatialReference,t=Pd(e)||Ff(e)||zf(e);e.isWebMercator?this.tilingScheme=Ra.WebMercatorAuxiliarySphere:t&&(this.tilingScheme=Ra.makeGCSWithTileSize(e,256)),this._set("extent",this.extentHelper.layerViewsExtent)}else{const e=this.extentHelper.layerViewsExtent;g(e)&&!xd(e,this.extent)&&(this.tilingScheme=Ra.fromExtent(e,this.extentHelper.viewSpatialReference),this._set("extent",e))}}get test(){return{lockTilingScheme:e=>this._lockTilingScheme(e),done:!this._waitTask}}};function PJ(i,e,t){return g(qv(i,e,t))}d([v()],Ho.prototype,"tilingScheme",void 0),d([v({readOnly:!0})],Ho.prototype,"extent",void 0),d([v({value:!1})],Ho.prototype,"tilingSchemeLocked",void 0),d([v({constructOnly:!0})],Ho.prototype,"viewSpatialReference",void 0),d([v({constructOnly:!0})],Ho.prototype,"layers",void 0),d([v({constructOnly:!0})],Ho.prototype,"extentHelper",void 0),d([v({constructOnly:!0})],Ho.prototype,"viewingMode",void 0),Ho=d([Y("esri.views.3d.terrain.TilingSchemeLogic")],Ho);let OJ=class{constructor(){this.offset=$e(),this.scale=0,this.tile=null}init(e,t,r,s){this.tile=e,this.offset[0]=t,this.offset[1]=r,this.scale=s}dispose(){this.tile=null,this.offset[0]=0,this.offset[1]=0,this.scale=0}},Qe=class extends Ms.EventedMixin(Ie){constructor(i){var e,t;super(i),this._scaleRangeQueries=new J0,this._iteratorPool=new lo(D$,r=>r.remove=()=>this._iteratorPool.release(r)),this._postorderIterator=new GY,this._hasPendingUpdates=!1,this._pendingUpdates=0,this._asyncWorkItems=0,this._allTilesDirty=!0,this._allTilesSorted=!0,this._visibleCached=!1,this._usedMemory=null,this._performanceInfo=new SJ,this._viewChanged=!1,this._inFrameTask=!1,this._viewChangeUpdateDirty=!1,this._eyePosRenderSR=T(),this._eyePosSurfaceSR=T(),this._splitLimits=new tJ,this._frustum=tf(),this._viewProjectionMatrix=ce(),this._layerViews=[new Array,new Array],this._layerIndexByUid=[new Map,new Map],this._basemapLayerViewHandles=new Map,this._handles=new Vi,this._watchUpdatingTracking=new av,this._frameTask=xx,this._allTiles=new At,this._upsampleInfoPool=new lo(OJ),this._rootTilesExtent=yt(),this.updatingProgress=0,this._maxNumUpdating=1,this.maxTextureScale=1.2,this._spatialReference=li.WebMercator,this.visibleElevationBounds=new xp(1/0,-1/0),this.rootTileElevationBounds=new xp(1/0,-1/0),this._updatingRootTiles=!1,this._pendingTilesForElevationUpdateEvent=new Set,this._pendingTilesToUpdate=new Set,this.totalGeometryUpdates=0,this.totalTileUpdates=0,this.oneBatchPerFrameTask=!0,this._layerViewsDirty=!1,this._shading=!0,this._isWebMercator=!1,this._isWebMercatorOnPlateeCarree=!1,this._isGlobal=!((t=(e=i.view)==null?void 0:e.state)!=null&&t.isLocal)}initialize(){this._lercDecoder=K6(this.view.resourceController),this._tilePool=this.view.state.isLocal?new lo(YK):new lo(JK);const i=this.view.resourceController.memoryController;this._upsampleMapCache=i.newCache("esri.views.3d.terrain.upsample",a=>a.unloadMapData()),this._elevationQueryCache=new TY(i.newCache("elevation-query")),this._set("overlayManager",new Hs({surface:this})),this._handles.add([te(()=>this.overlayManager.hasHighlights,a=>this._renderer.setNeedsHighlight(a)),te(()=>this.overlayManager.rendersOccluded,a=>this._renderer.setRenderOccludedOverlay(a)),te(()=>this.overlayManager.renderer.isEmpty,()=>this._evaluateTransparency())],"overlayManager"),this._renderer=new xa({_overlayRenderer:this.overlayManager.renderer,_ellipsoidRadius:Et(this.view.spatialReference).radius,_stage:this.view._stage,_allTiles:this._allTiles}),this._handles.add([te(()=>this.baseOpacity,()=>{this._handleLayerViewChanges(),this._updateTileTextures(this._evaluateTransparency()?or.UNFADED:or.IMMEDIATE)},Qi),te(()=>this.hasCompositeBlendMode,()=>this._updateTileTextures(this._evaluateTransparency()?or.UNFADED:or.IMMEDIATE),Qi),te(()=>this.renderingDisabled,()=>{var a,n;return(n=(a=this.view)==null?void 0:a._stage)==null?void 0:n.renderer.setParameters({terrainRenderingEnabled:!this.renderingDisabled})},Bt),te(()=>this.backgroundColor,a=>{this._handleLayerViewChanges(),this._renderer.updateTileBackground(a)},Qi),te(()=>this.snapLevel,()=>this._viewChanged=!0,Bt),te(()=>this.view.pointsOfInterest,a=>{this._renderer.pointsOfInterest=a,this._watchUpdatingTracking.removeAll(),a&&this._watchUpdatingTracking.add(()=>a.focus.renderLocation,()=>this._allTilesSorted=!1)}),te(()=>Ot.TERRAIN_TILE_TREE_SHOW_TILES,a=>{a&&!this._treeDebugger?_e(()=>import("./TerrainTileTree3DDebugger-7418db77.js"),["assets/TerrainTileTree3DDebugger-7418db77.js","assets/calcite-8912bd40.js","assets/index-00759e4a.js","assets/index-5026a37a.css","assets/calcite-96fa36fd.css","assets/TileTreeDebugger-1592735f.js"]).then(({TerrainTileTree3DDebugger:n})=>{!this._treeDebugger&&Ot.TERRAIN_TILE_TREE_SHOW_TILES&&(this._treeDebugger=new n({view:this.view}))}):a||(this._treeDebugger=Te(this._treeDebugger))},Ji)]);const{spatialReference:e}=this.view;this._extentHelper=OY(this.viewingMode,{layers:this.view.map.allLayers,layerViews:this.view.allLayerViews,viewSpatialReference:e});const t=new i9({getCollections:()=>{var a,n,o;return(o=(n=(a=this.view)==null?void 0:a.defaultsFromMap)==null?void 0:n.mapCollections)==null?void 0:o.map(({layers:l})=>l)},getChildrenFunction:a=>a&&"layers"in a?a.layers:null}),r=new Ho({layers:t,extentHelper:this._extentHelper,viewingMode:this.viewingMode,viewSpatialReference:e});this._set("tilingSchemeLogic",r),this._updateTilingScheme(),this._elevationDataRequester=this.view.resourceController.createStreamDataRequester(Jo.ELEVATION),this._mapDataRequester=this.view.resourceController.createStreamDataRequester(Jo.BASEMAP);const s=this.view.resourceController.scheduler;this._frameTask=s.registerTask(Zi.TERRAIN_SURFACE,this),this._handles.add([te(()=>this._extentHelper.stencilEnabledExtents,a=>this._renderer.setStencilEnabledLayerExtents(a),Ji),te(()=>this.tilingSchemeLogic.tilingScheme,()=>this._updateTilingScheme(),Bt),te(()=>this.extent,()=>this._updateRootTiles(),Ji),this.view.on("resize",()=>this._viewChangeUpdate()),te(()=>{var o,l;const a=this.view,n=a.state;return[this._lodBias,this.lodSnapping,(l=(o=a.resourceController)==null?void 0:o.memoryController)==null?void 0:l.memoryFactor,n.camera,n.contentCamera,n.fixedContentCamera]},()=>this._viewChangeUpdate(),Qi),te(()=>{var a,n;return(n=(a=this.view.qualitySettings)==null?void 0:a.tiledSurface)==null?void 0:n.textureFadeDuration},a=>this._renderer.textureFadingEnabled=a>0,Ji),te(()=>{var a;return(a=this.view.qualitySettings)==null?void 0:a.physicallyBasedRenderingEnabled},a=>this._renderer.pbrMode=a?Wt.Terrain:Wt.Disabled,Ji),te(()=>this._userClippingExtent,()=>this._updateClippingExtent(),Bt)]),this._handles.add(this.view.allLayerViews.on("after-changes",()=>this._layerViewsDirty=!0)),this._handles.add([te(()=>{var a;return(a=this.view)==null?void 0:a.map.ground.shading},()=>{this._updateShadingIfChanged()})]),this._updateShading(),this._layerViewsDirty=!0,this._handleLayerViewChanges()}destroy(){this._frameTask.remove(),this._handles.destroy(),this._watchUpdatingTracking.destroy(),this._lercDecoder=er(this._lercDecoder),this._removeAllTiles(),this._upsampleMapCache=Te(this._upsampleMapCache),this._elevationQueryCache=Te(this._elevationQueryCache);const i=this.tilingSchemeLogic.layers;this._set("tilingSchemeLogic",Te(this.tilingSchemeLogic)),i.destroy(),this._basemapLayerViewHandles.forEach((e,t)=>this._unregisterTiledLayerView(t)),this._elevationDataRequester=null,this._mapDataRequester=null,this._set("overlayManager",Te(this.overlayManager)),this._tilePool=Te(this._tilePool),uS.prune(),this._treeDebugger=Te(this._treeDebugger),this._renderer=Te(this._renderer),this._iteratorPool=Te(this._iteratorPool),this._set("view",null),this._upsampleInfoPool=Te(this._upsampleInfoPool),t8(),hK()}get renderer(){return this._renderer}get frustum(){return this._frustum}get snapLevel(){var i,e;if(this.lodSnapping===Ig.ON){const t=this.view,r=this.tilingScheme,s=(e=(i=t.pointsOfInterest)==null?void 0:i.cameraOnSurface)==null?void 0:e.scale;if(s&&r){const a=t.state.contentCamera;let n=Fv(t,a.eye,a.viewForward,a.up).tilt;n>90&&(n=180-n);const o=2*(n/90)**2,l=r.levelAtScale(s)-o;return Math.round(l)}}return null}get lodSnapping(){return this.view.qualitySettings.tiledSurface.reduceTileLevelDifferences?Ig.ON:Ig.OFF}get upsampleInfoPool(){return this._upsampleInfoPool}get upsampleMapCache(){return this._upsampleMapCache}get elevationQueryCache(){return this._elevationQueryCache}get mapTileRequester(){return this._mapDataRequester}get _userClippingExtent(){const{spatialReference:i}=this,{clippingArea:e}=this.view;if(P(e)||P(i))return null;const t=yt(),r=C$(e,t,i)?t:null,s=this._get("extent");return xd(r,s)?s:r}get rootTilesExtent(){return this._rootTilesExtent}get extent(){const i=Tx(this.groundExtent,this._userClippingExtent,yt()),e=this._get("extent");return xd(i,e)?e:i}get groundExtent(){return g(this._tilingSchemeExtent)?this._tilingSchemeExtent:this._rootTilesExtent}get _tilingSchemeExtent(){var i;return(i=this.tilingSchemeLogic)==null?void 0:i.extent}get updating(){return this._hasPendingUpdates||(this._maxNumUpdating=1),!!((this.running||this._watchUpdatingTracking.updating||this._asyncWorkItems>0)&&this.ready&&!this.suspended||this.overlayManager.updating)}get running(){return(this._hasPendingUpdates||this._viewChanged||this._allTilesDirty||!this._allTilesSorted||this._layerViewsDirty||this._scaleRangeQueries.updating||this._frameTask.updating)&&this.ready&&!this.suspended}get updatingProgressValue(){return this._maxNumUpdating=Math.max(this._pendingUpdates,this._maxNumUpdating),1-this._pendingUpdates/this._maxNumUpdating}get baseOpacity(){return this.view.map.ground.opacity}set baseOpacity(i){this.view.map.ground.opacity=i}get viewingMode(){return this.view.state.viewingMode}get ready(){return g(this._rootTiles)}set renderOrder(i){this._renderer.renderOrder=i,this._set("renderOrder",i)}get rootTiles(){return this._rootTiles}get spatialReference(){var i;return((i=this.tilingScheme)==null?void 0:i.spatialReference)??null}get backgroundColor(){return this.view.map.ground.surfaceColor}set backgroundColor(i){this.view.map.ground.surfaceColor=i}set slicePlaneEnabled(i){this._renderer.slicePlaneEnabled=i,this._set("slicePlaneEnabled",i),this._evaluateTransparency()}get tilingSchemeLocked(){var i;return((i=this.tilingSchemeLogic)==null?void 0:i.tilingSchemeLocked)??!1}set velvetOverground(i){this._renderer.velvetOverground=i,this._set("velvetOverground",i)}get wireframe(){return this._renderer.wireframe}set wireframe(i){i!==this._renderer.wireframe&&(this._renderer.wireframe=i,this._updateAllTileGeometries())}set _visible(i){i!==this._visibleCached&&(this._visibleCached=i,this._renderer.setVisibility(i),this.suspended=!i)}get opaque(){return this._renderer.transparency===vr.Opaque}set suspended(i){this._set("suspended",i),this._viewChangeUpdate()}get textureFadeDuration(){return this.view.qualitySettings.tiledSurface.textureFadeDuration??0}intersect(i,e,t,r){this._renderer.intersect(i,e,t,r)}getElevation(i,e,t,r){const s=this._rootTiles;if(P(s)||!s.length||s[0].layerInfo[ot.ELEVATION].length===0)return null;const a=zs;return a[0]=i,a[1]=e,a[2]=t,Jr(a,r,a,this._spatialReference)?FE(s,a[0],a[1]):(Pe.getLogger(this.declaredClass).error("TerrainSurface.getElevation(): could not project given point to tiling scheme coordinate system"),null)}getElevations(i,e,t){const r=this._rootTiles,s=r?r[0].layerInfo[ot.ELEVATION].length:0;if(!P(r)&&r.length&&s!==0)for(let a=0;a<e;++a){const n=3*a;t(a,FE(r,i[n+0],i[n+1]))}else for(let a=0;a<e;++a)t(a,null)}getScale(i){if(!this.tilingScheme)return null;if(!ts(i,zs,this.spatialReference))return Pe.getLogger(this.declaredClass).error("TerrainSurface.getScale(): could not project given point to tiling scheme coordinate system"),null;const e=this._rootTiles;if(g(e)){for(const t of e)if(t!=null&&t.containsPoint(zs)){let r=t;for(;r.children[0]&&!r.rendered;){const s=r.children[0].extent;let a=0;zs[0]>s[2]&&(a+=1),zs[1]<s[1]&&(a+=2),r=r.children[a]}return this._getLodBiasCorrectedScale(r.level)}}return 1/0}getSphereElevationBounds(i,e,t,r,s){var c;if(zs[0]=i,zs[1]=e,zs[2]=t,zs[3]=r,!Jr(zs,s,zs,(c=this.tilingScheme)==null?void 0:c.spatialReference))return Pe.getLogger(this.declaredClass).error("TerrainSurface.getSphereElevationBounds(): could not project given point to tiling scheme coordinate system"),null;let a=1/0,n=-1/0;const o=h=>{if(h&&qS(h.extent,zs))if(h.isLeaf||h.rendered)a=Math.min(a,h.elevationBounds[0]),n=Math.max(n,h.elevationBounds[1]);else for(const u of h.children)o(u)},l=this._rootTiles;if(g(l))for(const h of l)o(h);return{min:a,max:n}}getSphereScale(i,e){if(!this.tilingScheme)return null;if(!ts(i,zs,this.spatialReference))return Pe.getLogger(this.declaredClass).error("TerrainSurface.getSphereScale(): could not project given point to tiling scheme coordinate system"),null;zs[3]=e;let t=null;const r=a=>{if(a&&qS(a.extent,zs)){const n=a.children;if(n[0]&&!a.rendered)for(const o of n)r(o);else{const o=this._getLodBiasCorrectedScale(a.level);t=t==null?o:Math.min(t,o)}}},s=this._rootTiles;if(g(s))for(const a of s)r(a);return t}queryVisibleScaleRange(i,e,t,r){const s=e?this.tilingScheme.levelAtScale(e):0,a=t?this.tilingScheme.levelAtScale(t):1/0,n=this._lodBias;this._scaleRangeQueries.queryVisibleLevelRange(i,s+n,a+n,r)}_evaluateTransparency(){var a,n;const i=this.baseOpacity,e=this.overlayManager.renderer.isEmpty,t=this._renderer.transparency,r=this._allSurfaceLayersTransparent()?e?vr.Empty:vr.TransparentWithDraped:i>=1&&!this.hasCompositeBlendMode&&!this._renderer.slicePlaneEnabled?vr.Opaque:vr.Semitransparent,s=t!==r;return s&&(this._renderer.transparency=r,(n=(a=this.view)==null?void 0:a._stage)==null||n.renderer.setParameters({terrainTransparency:this._renderer.transparency})),s}_updateTilingScheme(){var t,r,s;const i=this.tilingSchemeLogic.tilingScheme;if(i===this.tilingScheme)return;Xo(!!i,"tiling scheme cannot be reset to undefined"),this._isGlobal=!((r=(t=this.view)==null?void 0:t.state)!=null&&r.isLocal),this.tilingScheme&&this._removeAllTiles();const e=(i==null?void 0:i.spatialReference)??li.WebMercator;this._spatialReference=e,this._isWebMercator=!!(e!=null&&e.isWebMercator),this._isWebMercatorOnPlateeCarree=this._isWebMercator&&l3((s=this.view)==null?void 0:s.renderSpatialReference),this._set("tilingScheme",i),this._updateClippingExtent(),i&&(this._updateTiledLayers(),this._renderer.setTileSize(i.pixelSize),this.overlayManager.setSpatialReference(i.spatialReference),this._updateRootTiles())}_acquireTile(i,e,t,r){const s=this._tilePool.acquire();return _0[0]=i,_0[1]=e,_0[2]=t,s.init(_0,r,this),s}get updatingRootTiles(){return this._updatingRootTiles}_updateRootTiles(){const{extent:i,tilingScheme:e}=this;if(!e)return;const t=AJ;let r=e.rootTilesInExtent(i,t,5*dp);if(g(this._rootTiles)){if(r.length>dp)return void Pe.getLogger(this.declaredClass).warn(Q8);const s=this._rootTiles.map(n=>n.lij),a=r9(s,r,NE);if(this._updatingRootTiles=!0,a.removed.length>0||a.added.length>0){const n=this._rootTiles.filter(o=>!(a.removed.findIndex(l=>NE(l,o.lij))>-1)||(this._purgeTile(o),!1));a.added.forEach(o=>n.push(this._newRootTile(o))),this._setRootTiles(n)}}else this._updatingRootTiles=!0,r.length>dp&&(Pe.getLogger(this.declaredClass).warn(Z8),r=e.rootTilesInExtent(i,t,dp)),this._setRootTiles(r.map(s=>this._newRootTile(s)));xd(t,this._rootTilesExtent)||(this._rootTilesExtent=yt(t)),this._visible=!0,this._viewChangeUpdate(),this.overlayManager.setPlacementDirty(),this.notifyChange("ready"),this._updateAllTileGeometries(),this._updatingRootTiles=!1,this.checkAllTilesWaterproofness()}_updateAllTileGeometries(){const i=this._allTiles.filter(e=>e.isLoaded&&e.intersectsClippingArea);i.forEach(e=>this._renderer.updateTileGeometryState(e)),i.forEach(e=>e.renderData.updateNeighborData()),this._updateTilesGeometries(i),this._pendingTilesToUpdate.clear()}_updateTilesGeometries(i){if(i.length===0)return;i.sort(ql);const e=this.renderer;i.forEach(t=>e.updateGeometryIfNeeded(t)),i.forEach(t=>this._pendingTilesForElevationUpdateEvent.add(t))}_shouldSplit(i){return i.shouldSplit(this._splitLimits,this._eyePosRenderSR,this.snapLevel)===Le.SPLIT}_newRootTile(i){const e=this._acquireTile(0,i[1],i[2],null);return this._shouldSplit(e)&&e.setPendingUpdate(Le.SPLIT),this._loadTile(e),this._markTileToUpdate(e),this._updateRootTileElevationBounds(),e}_setRootTiles(i){if(this._rootTiles=i,this._allTiles.clear(),g(i)){const e=this._iteratorPool.acquire();for(e.reset(i);!e.done;)this._allTiles.push(e.next());e.remove()}this._renderer.setRootTiles(this._rootTiles),this._updateTilesVisibility(i)}_runViewChangeUpdateIfDirty(){this._viewChangeUpdateDirty&&(this._viewChangeUpdateDirty=!1,this._viewChangeUpdate())}_viewChangeUpdate(){this.view&&!this.suspended&&this.tilingScheme&&this._visibleCached&&(this._inFrameTask?this._viewChangeUpdateDirty=!0:(this._viewChangeUpdateDirty=!1,this._updateViewDependentParameters(),this._updateTilesVisibility(this._rootTiles)))}_updateClippingStatus(i){i.updateClippingStatus(this.extent)&&i.resetPendingUpdate(Le.GEOMETRY)&&this._updateTileGeometryState(i)}_updateTilesVisibility(i){if(P(i))return;const e=XY(i),t=this.visibleElevationBounds;let r=e?t.min:1/0,s=e?t.max:-1/0;const a=this.extent,n=this._viewProjectionMatrix;this.setTileTreeDirty();const o=this._iteratorPool.acquire();for(o.reset(i);!o.done;){const l=o.next();l.updateClippingStatus(a)&&l.resetPendingUpdate(Le.GEOMETRY)&&this._updateTileGeometryState(l),l.setPendingUpdate(Le.RENDERDATA),l.computeVisibility(),l.updateScreenDepth(n),l.renderData&&(r=Math.min(l.elevationBounds[0],r),s=Math.max(l.elevationBounds[1],s))}o.remove(),this._viewChanged=!0,this._allTilesDirty=!0,this._batchUpdatePendingTileGeometries(),isFinite(r)&&isFinite(s)&&(t.min!==r||t.max!==s)&&(this.visibleElevationBounds=new xp(r,s))}_updateRootTileElevationBounds(){let i=1/0,e=-1/0;const t=this._rootTiles;g(t)&&t.forEach(({elevationBounds:s})=>{i=Math.min(i,s[0]),e=Math.max(e,s[1])});const r=this.rootTileElevationBounds;r.min===i&&r.max===e||(this.rootTileElevationBounds=new xp(i,e))}_updateViewDependentParameters(){const{camera:i,contentCamera:e}=this.view.state,t=Math.tan(.5*e.fovX),r=Math.tan(.5*e.fovY),s=this.tilingScheme.pixelSize,a=2**-this._lodBias*i.pixelRatio;this._splitLimits.aboveGround=i.aboveGround,this._splitLimits.fovX=t,this._splitLimits.fovY=r,this._splitLimits.relativeWidthLimit=s/i.width*this.maxTextureScale*a,this._splitLimits.relativeHeightLimit=s/i.height*this.maxTextureScale*a,this._splitLimits.maxLod=this.tilingScheme.getMaxLod(),this._splitLimits.angledSplitBias=this.view.qualitySettings.tiledSurface.angledSplitBias,this.view.state.fixedContentCamera?(P(this._splitLimits.frustum)&&(this._splitLimits.frustum=tf()),gy(this._splitLimits.frustum,e.frustum)):this._splitLimits.frustum=null,gy(this._frustum,i.frustum),pr(this._viewProjectionMatrix,e.projectionMatrix,e.viewMatrix),H(this._eyePosRenderSR,e.eye),Jr(i.eye,this.view.renderSpatialReference,this._eyePosSurfaceSR,this.spatialReference)}_updateRenderData(i){i.rendered&&!i.shouldLoad&&(m5(i)?this._loadChildren(i):EJ(i)&&this._loadParent(i))}_updateTileGeometryState(i){i.updateVisibility(),this._renderer.updateTileGeometryState(i)&&this._markTileToUpdate(i),this._usedMemory=null}_markAllTileNeighborsForGeometryUpdate(i){const e=this._pendingTilesToUpdate;i.forEachLoadedNeighbor(t=>{e.add(t)})}_updateTileTexture(i,e){const t=i.resetPendingUpdate(Le.TEXTURE_FADING)?Le.TEXTURE_FADING:!!i.resetPendingUpdate(Le.TEXTURE_NOFADING)&&Le.TEXTURE_NOFADING;t&&(this._renderer.updateTileTexture(i,t),this._usedMemory=null,e.madeProgress())}_emitElevationUpdateEventForTiles(){const i=ax.extent;bo(i),this._pendingTilesForElevationUpdateEvent.forEach(e=>eh(i,e.extent,i)),this._pendingTilesForElevationUpdateEvent.clear(),ax.spatialReference=this.spatialReference,this.emit("elevation-change",ax)}runTask(i){this._handleLayerViewChanges(i),this._frameTask.processQueue(i),this.renderer.processScaleRangeQueries(this._scaleRangeQueries,i),this._inFrameTask=!0,this._pendingUpdates=0,this._hasPendingUpdates=!1,this._updateAllTilesStatus(i),this._sortTiles(i);const e=!this.view.state.fixedContentCamera;this._mergeAndSplit(i,e),this._updateElevation(i),this._updateTextures(i),e||this._mergeAndSplit(i,!0),this._inFrameTask=!1,this._runViewChangeUpdateIfDirty(),this._batchUpdatePendingTileGeometries(),this._emitElevationUpdateEventForTiles(),i.done&&i.hasProgressed?this.requestUpdate():this.getUsedMemory(),this.notifyChange("updatingProgressValue")}_updateAllTilesStatus(i){if(!this._viewChanged||!this._rootTiles||i.done)return;this._viewChanged=!1;const e=this._iteratorPool.acquire();e.reset(this._rootTiles);const t=this.snapLevel,r=this._splitLimits,s=this._eyePosRenderSR;for(;!e.done;){const a=e.next(),n=a.shouldSplit(r,s,t);if(n!==Le.SPLIT){if(a.resetPendingUpdate(Le.SPLIT)&&a.updateAgentSuspension(),n===Le.VSPLITMERGE&&a.updateAgents(ot.ELEVATION),e.skipSubtree(),!a.isLeaf){a.setPendingUpdate(Le.MERGE),a.resetPendingUpdate(Le.SPLIT);const o=this._iteratorPool.acquire();o.resetOne(a);const l=this._viewProjectionMatrix;for(let c=o.next();!o.done;c=o.next())this._updateClippingStatus(c),c.updateVisibility(),c.updateScreenDepth(l);o.remove()}}else a.resetPendingUpdate(Le.MERGE),a.isLeaf&&(a.setPendingUpdate(Le.SPLIT),e.skipSubtree()),a.rendered&&a.setPendingUpdate(Le.RENDERDATA)}e.remove(),this.requestUpdate(),(this.shortBatches||!this.oneBatchPerFrameTask)&&this._batchUpdatePendingTileGeometries(),i.madeProgress()}_sortTiles(i){i.done||this._allTilesSorted||(qY(this._allTiles,this.view.pointsOfInterest.focus.renderLocation),this._allTilesSorted=!0,this._treeDebugger&&this._treeDebugger.update(),i.madeProgress())}_markTileToUpdate(i){Z(i.isLoaded),i.intersectsClippingArea&&(this._pendingTilesToUpdate.add(i),this._markAllTileNeighborsForGeometryUpdate(i))}_batchUpdatePendingTileGeometries(){const i=this._pendingTilesToUpdate;if(i.size===0)return;const e=Array.from(this._pendingTilesToUpdate.keys()).filter(s=>s.isLoaded&&s.intersectsClippingArea),t=(s,a)=>{!(a!=null&&a.isLoaded)||!a.intersectsClippingArea||a.level<s.level||i.has(a)||(i.add(a),e.push(a),a.renderData.updateNeighborData())};e.sort(ql);const r=e.length;for(let s=0;s<r;++s){const a=e[s];Z(a.isLoaded),Z(a.intersectsClippingArea);const n=a.renderData;n.updateNeighborData();const o=n._dirtyEdgeResolutions,l=n.geometryState.neighborData;for(let c=0;c<4;++c)if(o&1<<c){const h=n.geometryState.neighborData.edgePeerNeighbors[c];h&&(h==null?void 0:h.level)>=a.level&&h.forAllSubtreeOnSide(Ky(al[c]),u=>!(!u.isLoaded||!u.intersectsClippingArea)&&(Z(i.has(u)||ql(a,u)<0),t(a,u),!0)),t(a,l.cornerPeerNeighbors[c]),t(a,l.cornerPeerNeighbors[(c+1)%4])}}i.clear(),this._updateTilesGeometries(e),ur&&Qy&&this.checkAllTilesWaterproofness()}_mergeAndSplit(i,e){if(this.suspended||i.done||!this._allTilesDirty)return;this._allTilesDirty=!1,this.requestUpdate();let t=!1;const r=this.view.state.fixedContentCamera;let s=!1;for(;!i.done;){s=!0;let a=!1;const n=!this._allTiles.some(o=>{var c;if(!t&&!r&&!o.visible)return i.done;let l=o;if(o.resetPendingUpdate(Le.MERGE)){if(!e)return o.setPendingUpdate(Le.MERGE),i.done;for(;(c=l.parent)!=null&&c.resetPendingUpdate(Le.MERGE);)l=l.parent;this._mergeTile(l),a=!0,i.madeProgress()}else o.resetPendingUpdate(Le.SPLIT)&&(this._splitTile(o),a=!0,i.madeProgress());return!i.done&&l===o&&o.resetPendingUpdate(Le.RENDERDATA)&&(this._updateRenderData(o),i.madeProgress()),i.done});if(a&&(this._allTilesSorted=!1,this._allTilesDirty=!0),n){if(!t){t=!0;continue}if(!a)break}else this._allTilesDirty=!0}s?i.madeProgress():this._allTilesDirty=!0,!this.oneBatchPerFrameTask&&this._batchUpdatePendingTileGeometries(),this._sortTiles(i)}_updateElevation(i){i.done||(this._allTiles.some(e=>(e.resetPendingUpdate(Le.GEOMETRY)&&(this._updateTileGeometryState(e),this._updateTileTexture(e,i),this.shortBatches&&this._batchUpdatePendingTileGeometries(),i.madeProgress()),i.done)),!this.oneBatchPerFrameTask&&this._batchUpdatePendingTileGeometries())}_updateTextures(i){i.done||this._allTiles.some(e=>(this._updateTileTexture(e,i),i.done))}_updateClippingExtent(){this.spatialReference&&(this.updateTileOverlayParams(Wi.UPDATE),this.overlayManager.setPlacementDirty(),this._updateRootTiles())}get _lodBias(){const i=this.view.resourceController.memoryController.memoryFactor;return this.view.qualitySettings.tiledSurface.lodBias-(1-i)*W8}_getLodBiasCorrectedScale(i){const e=this.tilingScheme.levels,t=ee(i-this._lodBias,0,e.length-1),r=t-Math.floor(t);return e[Math.floor(t)].scale*(1-r)+e[Math.ceil(t)].scale*r}_removeAllTiles(){g(this._rootTiles)&&(this._rootTiles.forEach(i=>this._purgeTile(i)),this._setRootTiles(null),this.notifyChange("ready")),this._allTiles.clear(),this._visible=!1}_purgeDescendantTiles(i){if(!i.children[0])return!1;let e=!1;for(let t=0;t<4;++t)e=this._purgeTile(i.children[t])||e;return i.unsetChildren(),e}_purgeTile(i){const e=this._purgeDescendantTiles(i)||i.rendered;return this._allTiles.removeUnordered(i),this._unloadTile(i),this._tilePool.release(i),e}_unloadTile(i){this._pendingTilesToUpdate.delete(i),this._pendingTilesForElevationUpdateEvent.delete(i),i.unload(this._renderer)}_splitTile(i){Xo(i.isLeaf,"tile that is already split should not be split again!");const e=i.level+1,t=2*i.lij[1],r=2*i.lij[2];i.setChildren(this._createTile(e,t,r,i),this._createTile(e,t,r+1,i),this._createTile(e,t+1,r,i),this._createTile(e,t+1,r+1,i)),i.setPendingUpdate(Le.RENDERDATA),i.updateAgentSuspension(),this._allTiles.pushArray(i.children),this._allTilesDirty=!0,++this._performanceInfo.numSplit}_emitTileScaleChange(i,e=i.level){y0.spatialReference=this.spatialReference,y0.extent=i.extent,y0.scale=this._getLodBiasCorrectedScale(e),this.emit("scale-change",y0)}_createTile(i,e,t,r){Xo(!!r,"_createTile sanity check");const s=this._acquireTile(i,e,t,r);return s.updateClippingStatus(this.extent),s.updateScreenDepth(this._viewProjectionMatrix),this._shouldSplit(s)&&s.setPendingUpdate(Le.SPLIT),s}get shortBatches(){return this.view.state.mode!==ii.IDLE}_mergeTile(i){Xo(!i.hasPendingUpdate(Le.SPLIT),"_mergeTile sanity check"),this._purgeDescendantTiles(i)&&(Xo(!i.renderData,"_mergeTile sanity check"),this._loadTile(i),this._markTileToUpdate(i),this._emitTileScaleChange(i),this.shortBatches&&this._batchUpdatePendingTileGeometries()),this._allTilesDirty=!0,++this._performanceInfo.numMerged}_loadChildren(i){Xo(i.rendered,"parent should be rendered"),this._unloadTile(i);const e=i.children;e.forEach(t=>this._loadTile(t)),e.forEach(t=>this._pendingTilesToUpdate.add(t)),this._markAllTileNeighborsForGeometryUpdate(i),this._emitTileScaleChange(i,i.level+1),this.shortBatches&&this._batchUpdatePendingTileGeometries()}_loadParent(i){const e=i.parent;this._unloadChildren(e),this._loadTile(e),this._markTileToUpdate(e),this._emitTileScaleChange(e,e.level),this.shortBatches&&this._batchUpdatePendingTileGeometries()}_unloadChildren(i){const e=i.children;if(e[0])for(let t=0;t<4;++t){const r=e[t];this._unloadChildren(r),this._unloadTile(r)}}_loadTile(i){i.load(),i.setPendingUpdate(Le.RENDERDATA),this.requestUpdate(),this._allTilesDirty=!0,this.overlayManager&&this.overlayManager.hasOverlays&&this.overlayManager.setTileParameters(i)}_elevationDataArrived(i,e,t){const r=new SY(i.lij,i.extent,t);i.dataArrived(e,ot.ELEVATION,r);const s=[i],a=i.level,n=this._iteratorPool.acquire();for(n.reset(s);!n.done;){const o=n.next();o.findElevationBoundsForLayer(e,a),o.computeElevationBounds()}a===0&&this._updateRootTileElevationBounds(),n.remove(),this._updateTilesVisibility(s)}_handleLayerViewChanges(i=Ea){if(!this._layerViewsDirty)return;this._layerViewsDirty=!1;let e=!1;const t=new Set;let r=-1;for(const s of this.view.allLayerViews.items)if(t.add(s.uid),Af(s)||Gm(s))if(this._basemapLayerViewHandles.has(s.uid)&&!Gm(s)){const a=this._layerClassFromLayerView(s),n=this._getLayerIdxByUID(a,s.uid);g(n)&&((n<r||P(r))&&(e=!0),r=n)}else this._registerTiledLayerView(s),s.layer.loaded&&(e=!0);this._basemapLayerViewHandles.forEach((s,a)=>{t.has(a)||(this._unregisterTiledLayerView(a),e=!0)}),e&&this._updateTiledLayers(),this.hasCompositeBlendMode=this._hasCompositeBlendMode(),this._evaluateTransparency(),i.madeProgress()}_allSurfaceLayersTransparent(){var e,t;let i=((t=(e=this.view.map)==null?void 0:e.ground)==null?void 0:t.opacity)===0;for(const r of this.view.allLayerViews.items)if(Uw(r)&&!c3(r.layer)&&r.fullOpacity!==0)return i=!1,i;return i}_hasCompositeBlendMode(){for(const i of this.view.allLayerViews.items)if((Yy(i)||Gm(i))&&eK(kw[i.layer.blendMode]))return!0;return!1}_layerClassFromLayerView(i){return zw(i)?ot.ELEVATION:ot.MAP}_registerTiledLayerView(i){const e=[];if((Yy(i)||Gm(i))&&e.push(te(()=>i.layer.blendMode,()=>{this.hasCompositeBlendMode=this._hasCompositeBlendMode(),this._updateTileTextures(or.UNFADED)})),Gm(i))return;const t=this._layerClassFromLayerView(i);e.push(te(()=>i.suspended,()=>this._updateTiledLayers())),e.push(te(()=>i.fullOpacity,()=>this._updateTileTextures(or.UNFADED))),e.push(te(()=>"effectiveScaleRange"in i.layer?i.layer.effectiveScaleRange:null,()=>this._restartAllAgents(t))),i.on("data-changed",()=>{const r=this._getLayerIdxByUID(t,i.uid);g(r)&&this._invalidateLayerData(r,t)}),this._basemapLayerViewHandles.set(i.uid,e)}_unregisterTiledLayerView(i){const e=this._basemapLayerViewHandles.get(i);if(e){for(let t=0;t<e.length;t++)e[t].remove();this._basemapLayerViewHandles.delete(i)}}_updateTiledLayers(){if(!this.tilingScheme||this.view.suspended)return;const i=this.view.allLayerViews,e=[[],[]];let t=null;i.forEach(r=>{if(!r.layer||r.suspended||!Af(r)||!r.fullExtent)return;const s=this._layerClassFromLayerView(r);if(s===ot.MAP){const a=r.displayLevelRange.maxLevel;a!==1/0&&(t===null||a>t)&&(t=a)}e[s].push(r)});for(const r of cd){const s=this._layerViews[r],a=e[r];a.reverse();const n=a.length;let o=s.length!==n;const l=new Array(n),c=new Array(s.length);this._layerIndexByUid[r].clear();for(let h=0;h<n;h++){const u=a[h].uid;this._layerIndexByUid[r].set(u,h);const p=s.indexOf(a[h]);l[h]=p,h!==p&&(o=!0),p>-1&&(c[p]=h)}if(o){const h=this._postorderIterator;for(h.reset(this._rootTiles);!h.done;)h.next().modifyLayers(c,l,r);this._layerViews[r]=a,this._restartAllAgents(r),this._updateTilesVisibility(this._rootTiles)}}this.tilingScheme.ensureMaxLod(t)&&this._viewChangeUpdate()}_restartAllAgents(i){const e=this._postorderIterator;for(e.reset(this._rootTiles);!e.done;){const t=e.next();t.restartAgents(i),i===ot.ELEVATION&&t.computeElevationBounds()}this._updateRootTileElevationBounds()}layerViewByIndex(i,e){return this._layerViews[e][i]}numLayers(i){return this._layerViews[i].length}_updateTileTextures(i){this._allTiles.forAll(e=>{e.updateAgents(ot.MAP),i===or.IMMEDIATE?this.renderer.updateTileTexture(e,Le.TEXTURE_NOFADING):e.updateRenderData(ot.MAP,i)}),this._evaluateTransparency()}_invalidateLayerData(i,e){this._allTiles.forAll(t=>t.removeLayerAgent(i,e)),this._allTiles.forAll(t=>t.invalidateLayerData(i,e))}setTileTreeDirty(){this._allTilesDirty=!0}requestRender(i=Wi.UPDATE){this.renderer.setNeedsRender(i)}requestUpdate(){++this._pendingUpdates==1&&(this._hasPendingUpdates=!0)}requestTileData(i,e,t,r){const s=this.layerViewByIndex(e,t),a=s.layer;return!a.tilemapCache||Ef(s)?this._requestTileData(i,t,s,r):(++this._asyncWorkItems,a.tilemapCache.fetchAvailability(i.lij[0],i.lij[1],i.lij[2],{...r,timeout:6e3}).then(()=>--this._asyncWorkItems).catch(n=>{throw--this._asyncWorkItems,lr(r),yo(n)||this._dataMissing(i,t,s,{notInTilemap:!0}),n}).then(()=>this._frameTask.schedule(()=>this._requestTileData(i,t,s,r),r.signal)))}_requestTileData(i,e,t,r){return e===ot.ELEVATION?zw(t)?this._requestElevationTileData(i,t,r):Promise.reject():Uw(t)?this._requestMapTileData(i,t,r):Promise.reject()}_requestElevationTileData(i,e,t){++this._asyncWorkItems;const r=n=>{if(Qo(t))return;const o=this._layerIndexByUid[ot.ELEVATION].get(e.uid);o!=null?(this._usedMemory=null,this.requestUpdate(),this._elevationDataArrived(i,o,n)):Pe.getLogger(this.declaredClass).warn("TerrainSurface: received data from unknown layer %d %s",ot.ELEVATION,i.lij.toString())},s=n=>{yo(n)||(this._dataMissing(i,ot.ELEVATION,e,n),this.requestUpdate())};if(aE(e.layer))return e.layer.fetchTile(i.lij[0],i.lij[1],i.lij[2],{noDataValue:hf,signal:t.signal}).then(n=>{if(!Qo(t))return this._frameTask.schedule(()=>r(n),t.signal,s);Pe.getLogger(this.declaredClass).warnOnce("A call to fetchTile resolved even though the request was aborted. fetchTile should not resolve if options.signal.aborted is true.")},s).finally(()=>{--this._asyncWorkItems});const a=e.getTileUrl(i.lij[0],i.lij[1],i.lij[2]);return this._elevationDataRequester.request(a,"binary",t).then(n=>this._lercDecoder.decode(n,{noDataValue:hf},t.signal)).then(n=>{n?r(new J6(n)):s(new Error("LERC decoding failed"))},s).finally(()=>{--this._asyncWorkItems})}_requestMapTileData(i,e,t){++this._asyncWorkItems;const r=(c,h)=>{--this._asyncWorkItems,Mp(h),Qo(t)||(this._dataMissing(i,ot.MAP,e,c),this.requestUpdate())},s=c=>h=>r(h,c),a=c=>this._frameTask.schedule(()=>{--this._asyncWorkItems,this.requestUpdate(),Qo(t)?Mp(c):this._mapTileDataArrived(i,e,c)},t.signal,s(c)).catch(s(c)),n=(c,h=null)=>this._frameTask.schedule(()=>r(c,h));if(Ef(e)){const c=e.schemaHelper.getLevelRowColumn(i.lij);return e.fetchTile(c[0],c[1],c[2],t).then(a,n)}if(jv(e))return e.fetchTile(i.lij[0],i.lij[1],i.lij[2],t).then(a,n);if(oS(e)&&aE(e.layer))return e.layer.fetchTile(i.lij[0],i.lij[1],i.lij[2],t).then(c=>{if(Qo(t))return Pe.getLogger(this.declaredClass).warnOnce("A call to fetchTile resolved even though the request was aborted. fetchTile should not resolve if options.signal.aborted is true."),void n(ea());a(c)},n);let o=e.getTileUrl(i.lij[0],i.lij[1],i.lij[2]);s9(e.layer)&&e.layer.refreshTimestamp&&(o+=`${o.includes("?")?"&":"?"}_ts=${e.layer.refreshTimestamp}`);const l=e.hasMixedImageFormats?"image+type":"image";return this._mapDataRequester.request(o,l,t).then(a,n)}_mapTileDataArrived(i,e,t){const r=this._getLayerIdxByUID(ot.MAP,e.uid);g(r)?i.dataArrived(r,ot.MAP,t):(Mp(t),Pe.getLogger(this.declaredClass).warn("TerrainSurface: received data from unknown layer"))}_getLayerIdxByUID(i,e){return this._layerIndexByUid[i].get(e)}_dataMissing(i,e,t,r){const s=this._getLayerIdxByUID(e,t.uid);g(s)?i.dataMissing(s,e,r):Pe.getLogger(this.declaredClass).warn("TerrainSurface: received data from unknown layer")}updateTileOverlayParams(i){this._rootTiles&&this.overlayManager&&(this._allTiles.forAll(e=>{e.renderData&&this.overlayManager.setTileParameters(e)}),this._renderer.setNeedsRender(i))}get performanceInfo(){const i=this._performanceInfo;return i.numNodes=this._allTiles.length,i.numLeaves=i.numVisible=i.numRendered=i.numLoadedPerLevel.length=i.numRenderedPerLevel.length=0,this._allTiles.forAll(e=>{e.isLeaf&&i.numLeaves++;const t=e.level;e.renderData&&(i.numLoadedPerLevel[t]=(i.numLoadedPerLevel[t]||0)+1),e.visible&&(i.numVisible++,e.rendered&&(i.numRenderedPerLevel[t]=(i.numRenderedPerLevel[t]||0)+1,i.numRendered++))}),i}getUsedMemory(){return this.tilingScheme?(P(this._usedMemory)&&(this._usedMemory=this._recalculateUsedMemory()),g(this._usedMemory)?this._usedMemory:0):0}_recalculateUsedMemory(){return this.tilingScheme?this._allTiles.reduce((i,e)=>i+e.usedMemory,0):null}getUsedMemoryForLayerView(i){let e=0;const t=this._layerClassFromLayerView(i),r=this._getLayerIdxByUID(t,i.uid);return g(r)&&this._allTiles.forAll(s=>e+=s.getUsedMemoryForLayer(t,r)),e}getTile(i){if(P(i)||P(this._rootTiles))return null;const e=i.split("/").map(n=>+n);if(e[0]===0)return this._rootTiles.find(n=>n.lij[1]===e[1]&&n.lij[2]===e[2]);const t=2**e[0],r=Math.floor(e[1]/t),s=Math.floor(e[2]/t);let a;if(this._rootTiles.some(n=>n.lij[1]===r&&n.lij[2]===s&&(a=n,!0)),a){let n=1<<e[0]-1;for(;a.lij[0]<e[0];){let o=e[1]&n?2:0;if((e[2]&n)>0&&o++,!a.children[o])return null;a=a.children[o],n>>=1}return Xo(a.lij[0]===e[0]&&a.lij[1]===e[1]&&a.lij[2]===e[2],"not the right tile?"),a}return null}get renderPatchBorders(){return this._renderer.renderPatchBorders}set renderPatchBorders(i){this._renderer.renderPatchBorders=i}get visualizeNormals(){return this._renderer.visualizeNormals}set visualizeNormals(i){this._renderer.visualizeNormals=i}get renderingDisabled(){return this._renderer.renderingDisabled}set renderingDisabled(i){this._renderer.renderingDisabled=i}get test(){const i=this;return{renderer:i._renderer,lercDecoder:i._lercDecoder,forceReload:()=>{g(i._rootTiles)&&i._rootTiles.length>0&&(i._mergeTile(i._rootTiles[0]),i._viewChangeUpdate())},getTiles:()=>i._allTiles.toArray(),getRenderedTiles(){sx.clear(),i._allTiles.forAll(t=>{t.visible&&t.rendered&&sx.push(t)});const e=sx.toArray();return I$(i.renderOrder,e),e},lockTilingScheme(e,t){i._extentHelper.defaultTiledLayersExtent=t,i.tilingSchemeLogic.test.lockTilingScheme(e)}}}checkAllTilesWaterproofness(){if(!Qy)return;const i=this._rootTiles;if(P(i))return;const e=a=>{var n,o,l;return((l=(o=(n=a==null?void 0:a.renderData)==null?void 0:n.geometryInfo)==null?void 0:o.indices)==null?void 0:l.length)>0},t=(a,n)=>{e(a)&&console.error("Tile[",a.lij,"] has geometry although parent[",n.lij,"] has geom")},r=a=>{var n,o;if(a.intersectsClippingArea)if(a.renderData&&!a.renderData.geometryState&&console.error("Tile[",a.lij,"] has renderData but not geometryState"),a.renderData&&!a.renderData.geometryInfo&&console.error("Tile[",a.lij,"] has renderData but not geometryInfo"),!((n=a.renderData)!=null&&n.geometryInfo)||(((o=a.renderData.geometryInfo.indices)==null?void 0:o.length)??0)>0||console.error("Tile[",a.lij,"] has renderData but no indices - geometryInfo: ",a.renderData.geometryInfo),e(a)){a.checkGeometryWaterproofness();for(const l of a.children)t(l,a)}else if(a.isLeaf)console.error("Tile[",a.lij,"] has no geometry and no children, from root to leaf");else for(const l of a.children)r(l)},s=a=>{var c;const n=((c=a.parent)==null?void 0:c.visible)??!0,o=a.visible;a.computeVisibility();const l=a.visible;if(o!==l&&n&&console.error(" Tile[",a.lij,"] has out of date visibility: ",o," instead of ",l),!a.isLeaf)for(const h of a.children)s(h)};for(const a of i)r(a),s(a)}get isGlobal(){return this._isGlobal}get shading(){return this._shading}_updateShadingIfChanged(){var e,t,r;((r=(t=(e=this.view)==null?void 0:e.map)==null?void 0:t.ground)==null?void 0:r.shading)!==this._shading&&this._updateShading()}_updateShading(){var e,t,r;const i=(r=(t=(e=this.view)==null?void 0:e.map)==null?void 0:t.ground)==null?void 0:r.shading;this._shading=i,this.renderer&&(this.renderer.shading=i,this.renderer.setNeedsRender()),this._updateAllTileGeometries()}get isWebMercator(){return this._isWebMercator}get isWebMercatorOnPlateeCarree(){return this._isWebMercatorOnPlateeCarree}isEastEndWrap(i){return this.isGlobal&&i[2]===this.lijEastEnd(i[0])-1}isWestEndWrap(i){return this.isGlobal&&i[2]===0}lijEastEnd(i){return 2**(i+(g(this.spatialReference)&&this.spatialReference.isGeographic?1:0))}wrapEastWest(i){const e=this.lijEastEnd(i[0]),t=i[2];if(0<=t&&t<e)return i;if(!this.isGlobal)return null;const r=(t+(t<0?e:0))%e;return[i[0],i[1],r]}enableInternalChecks(i){qZ(i)}enableWaterproofnessChecks(i){jZ(i)}};d([v()],Qe.prototype,"_renderer",void 0),d([v({constructOnly:!0})],Qe.prototype,"_scaleRangeQueries",void 0),d([v()],Qe.prototype,"_hasPendingUpdates",void 0),d([v()],Qe.prototype,"_asyncWorkItems",void 0),d([v()],Qe.prototype,"_allTilesDirty",void 0),d([v()],Qe.prototype,"_allTilesSorted",void 0),d([v()],Qe.prototype,"_viewChanged",void 0),d([v({readOnly:!0})],Qe.prototype,"_watchUpdatingTracking",void 0),d([v()],Qe.prototype,"_frameTask",void 0),d([v({readOnly:!0})],Qe.prototype,"snapLevel",null),d([v({readOnly:!0})],Qe.prototype,"lodSnapping",null),d([v({constructOnly:!0})],Qe.prototype,"view",void 0),d([v()],Qe.prototype,"_userClippingExtent",null),d([v()],Qe.prototype,"_rootTilesExtent",void 0),d([v({readOnly:!0})],Qe.prototype,"extent",null),d([v({readOnly:!0})],Qe.prototype,"groundExtent",null),d([v({readOnly:!0})],Qe.prototype,"_tilingSchemeExtent",null),d([v({readOnly:!0})],Qe.prototype,"updating",null),d([v({readOnly:!0})],Qe.prototype,"running",null),d([v(CY)],Qe.prototype,"updatingProgress",void 0),d([v({readOnly:!0})],Qe.prototype,"updatingProgressValue",null),d([v()],Qe.prototype,"_maxNumUpdating",void 0),d([v()],Qe.prototype,"baseOpacity",null),d([v()],Qe.prototype,"hasCompositeBlendMode",void 0),d([v({readOnly:!0})],Qe.prototype,"overlayManager",void 0),d([v({readOnly:!0})],Qe.prototype,"viewingMode",null),d([v()],Qe.prototype,"maxTextureScale",void 0),d([v({readOnly:!0})],Qe.prototype,"ready",null),d([v({value:Zp.FRONT_TO_BACK})],Qe.prototype,"renderOrder",null),d([v({readOnly:!0})],Qe.prototype,"rootTiles",null),d([v()],Qe.prototype,"_rootTiles",void 0),d([v({readOnly:!0})],Qe.prototype,"spatialReference",null),d([v({type:ui})],Qe.prototype,"backgroundColor",null),d([v({value:!1})],Qe.prototype,"slicePlaneEnabled",null),d([v({readOnly:!0})],Qe.prototype,"tilingScheme",void 0),d([v({readOnly:!0})],Qe.prototype,"tilingSchemeLocked",null),d([v({readOnly:!0})],Qe.prototype,"tilingSchemeLogic",void 0),d([v({value:!0})],Qe.prototype,"velvetOverground",null),d([v()],Qe.prototype,"wireframe",null),d([v({value:!1})],Qe.prototype,"suspended",null),d([v()],Qe.prototype,"textureFadeDuration",null),d([v()],Qe.prototype,"visibleElevationBounds",void 0),d([v()],Qe.prototype,"rootTileElevationBounds",void 0),d([v()],Qe.prototype,"_layerViewsDirty",void 0),d([v()],Qe.prototype,"renderPatchBorders",null),d([v()],Qe.prototype,"visualizeNormals",null),d([v()],Qe.prototype,"renderingDisabled",null),Qe=d([Y("esri.views.3d.terrain.TerrainSurface")],Qe);const RJ=Qe;function NE(i,e){return i[0]===e[0]&&i[1]===e[1]&&i[2]===e[2]}function m5(i){const e=i.children;if(!e[0])return!1;for(const t of e)if(t.shouldLoad)return!0;for(const t of e)if(m5(t))return!0;return!1}function EJ(i){var e;return i.isLeaf&&(((e=i.parent)==null?void 0:e.shouldLoad)??!1)}const zs=Pt(),AJ=yt(),_0=[0,0,0],sx=new At,ax={spatialReference:null,extent:yt(),context:"ground"},y0={spatialReference:null,extent:null,scale:0};function FE(i,e,t){var r;for(const s of i){if(!s.containsPointXY(e,t))continue;let a=s;for(;a&&!a.renderData;){const o=(e>a.extentMidX?1:0)+(t<a.extentMidY?2:0);a=a.children[o]}const n=((r=a==null?void 0:a.renderData)==null?void 0:r.geometryState.samplerData)??null;return ri(e,t,n)}return null}let MJ=class{constructor(e,t,r){this.operation=e,this.geometry=t,this.states=r}},fg=class extends Ie{constructor(e){super(e),this._residentGeomRecords=new Map,this._dirtyGeomRecords=new Map,this.dirty=!1}commitLayer(e,t){const r=this._dirtyGeomRecords.get(e);r&&(r.forEach((s,a)=>{const n=this._ensureGeomRecord(e,a);s.forEach(({geometry:o,operation:l,states:c},h)=>{let u=!1;if(l===fi.UPDATE){const p=n.get(h);if(p){if(c&br.TRANSFORMATION){const m=this.model.getObject(a);this.model.updateRenderGeometryTransformation(m,o,p)&&(u=!0)}u||t.updates.push({renderGeometry:p,updateType:c})}else dt(!1,"ModelDirtySet.getAddRemoveListFilteredByLayers: invalid update")}if(l===fi.REMOVE||u){const p=n.get(h);p?(t.removes.push(p),n.delete(h)):l===fi.REMOVE&&dt(!1,"ModelDirtySet.getAddRemoveListFilteredByLayers: invalid remove")}if(l===fi.ADD||u){const p=this.model.getObject(a);if(g(p)){const m=this.model.getRenderGeometry(p,o);t.adds.push(m),n.set(h,m)}}}),n.size===0&&this._residentGeomRecords.get(e).delete(a)}),this._residentGeomRecords.get(e).size===0&&this._residentGeomRecords.delete(e),this._dirtyGeomRecords.delete(e),this.dirty=this._hasDirtyGeometryRecords)}getResidentRenderGeometries(e,t){const r=this._residentGeomRecords.get(e);r&&r.forEach(s=>s.forEach(a=>t.push(a)))}_objectStateChanged(e,t){for(const r of t.geometries)this._updateOrCreateDirtyRecord(t,r,null,fi.UPDATE,e)}visibilityChanged(e){this._objectStateChanged(br.VISIBILITY,e)}highlightChanged(e){this._objectStateChanged(br.HIGHLIGHT,e)}occlusionChanged(e){this._objectStateChanged(br.OCCLUDEE,e)}objectGeometryUpdated(e){this._updateOrCreateDirtyRecord(e.object,e.geometry,null,fi.UPDATE,br.GEOMETRY)}layerAdded(e){e.objects.forAll(t=>this._layerObjectAdded(e,t))}layerRemoved(e){e.objects.forAll(t=>this._layerObjectRemoved(e,t))}layerObjectAdded(e){this._layerObjectAdded(e.layer,e.object)}_layerObjectAdded(e,t){const r=e.id;for(const s of t.geometries)this._objectGeometryAdded(t,s,r)}layerObjectRemoved(e){this._layerObjectRemoved(e.layer,e.object)}layerObjectsAdded(e){for(const t of e.objects)this._layerObjectAdded(e.layer,t)}layerObjectsRemoved(e){for(const t of e.objects)this._layerObjectRemoved(e.layer,t)}_layerObjectRemoved(e,t){const r=e.id;for(const s of t.geometries)this._objectGeometryRemoved(t,s,r)}shaderTransformationChanged(e){const t=this._residentGeomRecords.get(e.id);t&&t.forEach((r,s)=>{const a=this.model.getObject(s);a&&a.hasVolativeTransformation()&&r.forEach(n=>n.shaderTransformationChanged())})}objectTransformation(e){const t=this._getParentLayerId(e),r=e.id;this._ensureGeomRecord(t,r).forEach(s=>{this._updateOrCreateDirtyRecord(e,s.geometry,t,fi.UPDATE,br.TRANSFORMATION)})}objectGeometryAdded(e){this._objectGeometryAdded(e.object,e.geometry)}_objectGeometryAdded(e,t,r=null){this._updateOrCreateDirtyRecord(e,t,r,fi.ADD)}objectGeometryRemoved(e){this._objectGeometryRemoved(e.object,e.geometry)}_objectGeometryRemoved(e,t,r=null){this._updateOrCreateDirtyRecord(e,t,r,fi.REMOVE)}_updateOrCreateDirtyRecord(e,t,r,s,a=br.NONE){r=je(r,this._getParentLayerId(e));const n=e.id,o=t.id,l=this._ensureDirtyRecord(r,n),c=l.get(o);if(c){const h=c.operation;h===fi.REMOVE&&s===fi.ADD&&c.states!==br.NONE?c.operation=fi.UPDATE:h===fi.REMOVE&&s===fi.ADD||h===fi.ADD&&s===fi.REMOVE?l.delete(o):h!==fi.UPDATE||s!==fi.REMOVE&&s!==fi.UPDATE?(dt((h===fi.REMOVE||h===fi.ADD)&&s===fi.UPDATE,"ModelDirtySet.objectGeometryAdded: inconsistent state"),c.states|=a):(c.operation=s,c.states|=a)}else l.set(o,new MJ(s,t,a));this.dirty=this._hasDirtyGeometryRecords}_ensureGeomRecord(e,t){let r=this._residentGeomRecords.get(e);r||(r=new Map,this._residentGeomRecords.set(e,r));let s=r.get(t);return s||(s=new Map,r.set(t,s)),s}get _hasDirtyGeometryRecords(){return Ks(this._dirtyGeomRecords,e=>Ks(e,t=>t&&t.size>0))}_ensureDirtyRecord(e,t){let r=this._dirtyGeomRecords.get(e);r||(r=new Map,this._dirtyGeomRecords.set(e,r));let s=r.get(t);return s||(s=new Map,r.set(t,s)),s}_getParentLayerId(e){return g(e.parentLayer)?e.parentLayer.id:a9}formatDebugInfo(){const e=["ADD","UPD",void 0,"REM"];let t="";return this._dirtyGeomRecords.forEach((r,s)=>{r.forEach((a,n)=>{t.length>0&&(t+=`
`),t+=s+"."+n;const o=[];a.forEach(l=>{const c=l.operation;o[c]||(o[c]=[]),o[c].push(l.geometry.id)});for(let l=0;l<o.length;l++)if(o[l]){t+=" "+e[l-1]+": ";for(let c=0;c<o[l].length;c++)t+=o[l][c]+", "}})}),t}get test(){const e=this;return{get residentLayerCount(){return e._residentGeomRecords.size},get residentObjectCount(){return Array.from(e._residentGeomRecords.values()).reduce((t,r)=>t+r.size,0)},commit:t=>e._dirtyGeomRecords.forEach((r,s)=>e.commitLayer(s,t))}}};d([v({constructOnly:!0})],fg.prototype,"model",void 0),d([v()],fg.prototype,"dirty",void 0),fg=d([Y("esri.views.3d.webgl-engine.lib.ModelDirtySet")],fg);const DJ=fg;let ty=class extends Ie{constructor(){super(...arguments),this.dirtySet=new DJ({model:this}),this._content=new Map,this._originFactory=new kC(null)}getObject(e){return this._content.get(e)}add(e){const t=e.id;dt(!this._content.has(t),"Model/Stage already contains object to be added"),this._content.set(t,e),By(e)&&this.dirtySet.layerAdded(e)}remove(e){dt(this._content.has(e.id),"Model/Stage doesn't contain object to be removed"),this._content.delete(e.id),e.unload(),By(e)&&this.dirtySet.layerRemoved(e)}addMany(e){for(const t of e)g(t)&&(dt(!this._content.has(t.id),"Model/Stage already contains object to be added"),this._content.set(t.id,t))}removeMany(e){for(const t of e)dt(this._content.has(t.id),"Model/Stage doesn't contain object to be removed"),this._content.delete(t.id),t.unload()}has(e){return this._content.has(e.id)}forEachOfType(e,t){this._content.forEach(r=>{r.type===e&&t(r)})}getRenderGeometry(e,t){const{shaderTransformer:r,localOrigin:s}=t,a=new Qp(t,{boundingInfo:t.boundingInfo,shaderTransformer:r,castShadow:e.castShadow});return a.updateTransformation(n=>e.getCombinedStaticTransformation(t,n)),a.localOrigin=g(s)?s:this._originFactory.getOrigin(a.boundingSphere),a}updateRenderGeometryTransformation(e,t,r){if(P(e))return!1;r.updateTransformation(a=>e.getCombinedStaticTransformation(t,a));const s=this._originFactory.getOrigin(r.boundingSphere);return r.localOrigin!==s}getStats(){const e={},t=Array.from(this._content.values());for(let r=0;r<ps.COUNT;++r)e[r]=t.filter(s=>s.type===r).length;return{contentTypes:e,dirtySet:this.dirtySet.formatDebugInfo()}}get test(){return{content:Array.from(this._content.values())}}};d([v({constructOnly:!0})],ty.prototype,"dirtySet",void 0),ty=d([Y("esri.views.3d.webgl-engine.parts.Model")],ty);let IJ=class{constructor(e){this._totalCount=e,this._indexRanges=[0,e]}allVisible(){return this.componentCount()===this._totalCount}allInvisible(){return this._indexRanges.length===0}componentCount(){const e=this._indexRanges;let t=0;for(let r=0;r<e.length;r+=2)t+=e[r+1];return t}reset(e){e==="all"||e.length===this._totalCount?this._indexRanges=[0,this._totalCount]:this._indexRanges=LJ(e)}forEachComponent(e){const t=this._indexRanges;for(let r=0;r<t.length;r+=2){const s=t[r],a=s+t[r+1];for(let n=s;n<a;n++)if(!e(n))return!1}return!0}forEachComponentRange(e){const t=this._indexRanges;for(let r=0;r<t.length;r+=2){const s=t[r];if(!e(s,s+t[r+1]))return!1}return!0}computeOffsetRanges(e){const t=new Array(this._indexRanges.length),r=this._indexRanges;for(let s=0;s<r.length;s+=2){const a=r[s],n=a+r[s+1],o=e[a],l=e[n];t[s]=o,t[s+1]=l-o}return t}};function LJ(i){const e=new Array;if(i.length===0)return e;let t=i[0],r=1;for(let s=1;s<i.length;s++){const a=i[s];t+r===a?r+=1:(e.push(t),e.push(r),t=a,r=1)}return e.push(t),e.push(r),e}let $J=class{constructor(e,t){this.pickability=null,this.highlightCounts=null,this.verticalOffsets=null,this.cachedGeometryRanges=null,this.cachedHighlightRanges=null,this.cachedDefaultRanges=null,this.offsets=t.slice();const r=this.count;this.visibility=new IJ(r),this.materialDataBuffer=e.getBuffer(r),this.materialDataIndices=new Uint16Array(r);for(let s=0;s<r;s++)this.materialDataIndices[s]=this.materialDataBuffer.acquireIndex()}destroy(){for(let e=0;e<this.count;e++)this.materialDataBuffer.releaseIndex(this.materialDataIndices[e])}get count(){return this.offsets.length-1}get geometryRanges(){return P(this.cachedGeometryRanges)&&(this.cachedGeometryRanges=this.visibility.computeOffsetRanges(this.offsets)),this.cachedGeometryRanges}get highlightRanges(){return P(this.highlightCounts)?null:(this._updateCachedHighlightRanges(),this.cachedHighlightRanges)}get defaultShadowMapRanges(){return P(this.highlightCounts)?this.geometryRanges:(this._updateCachedHighlightRanges(),this.cachedDefaultRanges)}highlightsDirty(){this.cachedHighlightRanges=null,this.cachedDefaultRanges=null}visibilityDirty(){this.cachedGeometryRanges=null,this.highlightsDirty()}_updateCachedHighlightRanges(){if((P(this.cachedHighlightRanges)||P(this.cachedDefaultRanges))&&g(this.highlightCounts)){const{highlightRanges:e,defaultRanges:t}=NJ(this.highlightCounts,this.visibility,this.offsets);this.cachedHighlightRanges=e,this.cachedDefaultRanges=t}}};function NJ(i,e,t){const r=[],s=[];let a=t.length,n=t.length;return e.forEachComponent(o=>(i[o]>0?(a!==o-1&&(r.length&&r.push(t[a+1]-r[r.length-1]),r.push(t[o])),a=o):(n!==o-1&&(s.length&&s.push(t[n+1]-s[s.length-1]),s.push(t[o])),n=o),!0)),r.length&&r.push(t[a+1]-r[r.length-1]),s.length&&s.push(t[n+1]-s[s.length-1]),{highlightRanges:r,defaultRanges:s}}let _g=class extends Ie{constructor(){super(...arguments),this.visible=Ip.Hidden}};var Ip;d([v({autoDestroy:!0})],_g.prototype,"renderable",void 0),d([v({autoDestroy:!0})],_g.prototype,"components",void 0),_g=d([Y("esri.views.3d.webgl-engine.collections.Component.ComponentObject")],_g),function(i){i[i.Hidden=0]="Hidden",i[i.Visible=1]="Visible"}(Ip||(Ip={}));function FJ(i,e,t,r){if(t>=e)return i;i==null&&(i=zJ());const s=i.isVisibleBit;let a=i.data;const n=f5(a),o=t/n|0,l=t-n*o,c=(e-1)/n|0,h=a,u=r===s;if(!(t<h.length*n)&&u){const m=o+1,f=Math.ceil(h.length*1.5),y=c+1;let b=Math.max(m,f);b=Math.min(b,y),a=new Uint32Array(b),a.set(h)}return o<a.length&&(a[o]=VJ(a[o],l,u)),i.data=a,i}function g5(i,e){if(i==null)return!0;const{isVisibleBit:t,data:r}=i,s=f5(r);return e<r.length*s?UJ(t,r,e,s):!i.isVisibleBit}function zJ(i=!0){return{isVisibleBit:!i,data:new Uint32Array(0)}}function UJ(i,e,t,r){const s=t/r|0,a=t-s*r;return GJ(e[s],a)===i}function f5(i){return i.BYTES_PER_ELEMENT*8}function VJ(i,e,t){return i&~(1<<e)|(t?1:0)<<e}function GJ(i,e){return(i&1<<e)!=0}let BJ=class{constructor(e,t){this._indices=g(e.indices)?e.indices:kT(e.positions.length/3),this._positions=new _h(e.positions),this._components=t,this._componentIntersectionData=new Array(t.count)}getComponentAabb(e,t){if(g(this._perComponentAabbs)){for(let r=0;r<6;r++)t[r]=this._perComponentAabbs[6*e+r];return t}return this._computePerComponentAabbs(),this.getComponentAabb(e,t)}getComponentPositions(e,t){t.indices=this._indices,t.data=this._positions.typedBuffer,t.stride=this._positions.typedBufferStride,t.startIndex=this._components.offsets[e],t.endIndex=this._components.offsets[e+1]}intersect(e,t,r,s,a,n,o){const l=new be(this._positions.typedBuffer,3,!1,this._positions.typedBufferStride),c=this._indices,h=this._components.offsets,u=GF(e,t,HJ),p=e[2],m=t[2];this._components.visibility.forEachComponent(f=>{if(!g5(this._components.pickability,f))return!0;const y=this.getComponentAabb(f,kJ);if(g(n)){const O=n[f];g(a)?a.componentOffset=O:(e[2]=p-O,t[2]=m-O)}if(g(a)&&a.applyToAabb(y),!H3(y,e,u,r))return!0;const b=h[f]/3,x=h[f+1]/3,S=x-b,C=(O,R,E)=>o(f,O,el(R,R,s),E);return P(a)&&S>u5?(this._componentIntersectionData[f]==null&&(this._componentIntersectionData[f]=new yS(this._indices,b,x,l)),this._componentIntersectionData[f].intersectRay({r0:e,r1:t},C)):$T(e,t,b,x,c,l,void 0,a,C),!0})}_computePerComponentAabbs(){const e=this._components.count;this._perComponentAabbs=new Float32Array(6*e);const t=this._indices,r=this._positions.typedBuffer,s=this._positions.typedBufferStride,a=this._components.offsets;let n=0;for(let o=0;o<e;o++){const l=a[o],c=a[o+1];let h=1/0,u=1/0,p=1/0,m=-1/0,f=-1/0,y=-1/0;for(let b=l;b<c;b++){const x=t[b]*s,S=r[x],C=r[x+1],O=r[x+2];h=Math.min(h,S),u=Math.min(u,C),p=Math.min(p,O),m=Math.max(m,S),f=Math.max(f,C),y=Math.max(y,O)}this._perComponentAabbs[n++]=h,this._perComponentAabbs[n++]=u,this._perComponentAabbs[n++]=p,this._perComponentAabbs[n++]=m,this._perComponentAabbs[n++]=f,this._perComponentAabbs[n++]=y}}get positions(){return this._positions}get indices(){return this._indices}};const HJ=T(),kJ=_s();let jJ=class{constructor(e,t,r){this.material=e,this.geometry=t,this.meta=r}destroy(){this.material.dispose(),this.geometry.dispose()}},qJ=class{constructor(e,t,r,s){this.vao=e,this.primitiveType=t,this.parameters=r,this.indexed=s}dispose(){this.vao.dispose()}},WJ=class{constructor(){this.near=Number.MAX_VALUE,this.far=-Number.MAX_VALUE}};function XJ(i,e){return{near:i,far:e}}function Yf(i){return i?Df(i,1/0,-1/0):XJ(1/0,-1/0)}function Df(i,e,t){return i.near=e,i.far=t,i}function Yp(i,e,t=i){return e!=null&&(t.near=Math.min(i.near,e.near),t.far=Math.max(i.far,e.far)),t}function v0(i,e){return i.near<=e&&e<=i.far}const Qw={near:0,far:0};function QJ(i,e){const t=Yf(),{eye:r,frustum:s,viewForward:a}=i;e.forAll(n=>{const o=g(n.offsetObb)?n.offsetObb:n.obb,l=J(Xr(Wa,o.center,r),a),c=G6(o,a);if(v0(t,l-c)&&v0(t,l+c))return;const h=eee(o,s);if(h===-1)return;if(h===0)return Ml.far=l+c,Ml.near=l-c,void Yp(t,Ml);const u=b0.pushNew();u.near=l-c,u.far=l+c,u.mask=h,u.object=n});for(let n=0;n<b0.length;n++){const o=b0.data[n];if(v0(t,o.near)&&v0(t,o.far))continue;Ml.far=o.far,Ml.near=1/0,JJ(g(o.object.offsetObb)?o.object.offsetObb:o.object.obb,r,ZJ,c=>{let h=YJ;for(let u=0;u<_5&&c.length>0;u++){if(!(o.mask&1<<u))continue;KJ(s[u],c,h);const p=c;c=h,h=p}for(let u=0;u<c.length;u+=3){j(qs,c.data[u+0],c.data[u+1],c.data[u+2]);const p=J(Xr(qs,qs,r),a);Ml.near=Math.min(Ml.near,p)}})===0&&(Ml.near=0),Yp(t,Ml)}return b0.length=0,t}const b0=new At({allocator:i=>i||{near:1/0,far:-1/0,mask:0,object:null},deallocator:i=>(i.object=Cx(i.object),i)}),Ml=Yf(),qs=T(),ed=T(),ZJ=new At({deallocator:null}),YJ=new At({deallocator:null});function KJ(i,e,t){t.length=0;const r=e.length-3;nx(qs,e,r);const s=Ri(i,qs);s<=0&&(t.push(qs[0]),t.push(qs[1]),t.push(qs[2]));let a=0,n=s;for(;a<r;a+=3){nx(ed,e,a);const o=Ri(i,ed);n*o<0&&(Gr(qs,ed,qs,o/(o-n)),Ws(t,qs)),o<=0&&Ws(t,ed),n=o,H(qs,ed)}n*s<0&&(nx(ed,e,r),Gr(qs,ed,qs,s/(s-n)),Ws(t,qs))}function nx(i,e,t){return j(i,e.data[t+0],e.data[t+1],e.data[t+2])}function Ws(i,e){i.push(e[0]),i.push(e[1]),i.push(e[2])}function JJ(i,e,t,r){D6(UE,i.quaternion),Xr(Wa,e,i.center),n9(Wa,Wa,UE);const s=8*((Wa[0]<-i.halfSize[0]?-1:Wa[0]>i.halfSize[0]?1:0)+3*(Wa[1]<-i.halfSize[1]?-1:Wa[1]>i.halfSize[1]?1:0)+9*(Wa[2]<-i.halfSize[2]?-1:Wa[2]>i.halfSize[2]?1:0)+13),a=zE[s];if(a===0)return a;o9(x0,i.quaternion),l9(x0,x0,i.halfSize);const n=(o,l)=>{const c=zE[s+l+1];return j(o,((1&c)<<1)-1,(2&c)-1,((4&c)>>1)-1),el(o,o,x0),X(o,i.center,o)};return t.length=0,Ws(t,n(ox,0)),Ws(t,n(VE,1)),Ws(t,n(Wa,2)),Ws(t,n(GE,3)),r(t),a===1||(t.length=0,Ws(t,ox),Ws(t,GE),Ws(t,n(Wa,4)),Ws(t,n(BE,5)),r(t),a===2||(t.length=0,Ws(t,ox),Ws(t,BE),Ws(t,n(Wa,6)),Ws(t,VE),r(t))),a}const zE=(()=>{const i=new Int8Array(216);let e=0;const t=r=>{for(let s=0;s<r.length;s++)i[e+s]=r[s];e+=8};return t([3,0,6,2,3,1,5,4]),t([2,0,2,3,1,5,4,0]),t([3,1,0,2,3,7,5,4]),t([2,0,1,3,2,6,4,0]),t([1,0,1,3,2,0,0,0]),t([2,1,5,7,3,2,0,0]),t([3,2,0,1,3,7,6,4]),t([2,2,0,1,3,7,6,0]),t([3,3,0,1,5,7,6,2]),t([2,0,1,5,4,6,2,0]),t([1,0,1,5,4,0,0,0]),t([2,1,3,7,5,4,0,0]),t([1,0,2,6,4,0,0,0]),t([0,0,0,0,0,0,0,0]),t([1,1,3,7,5,0,0,0]),t([2,2,3,7,6,4,0,0]),t([1,2,3,7,6,0,0,0]),t([2,3,1,5,7,6,2,0]),t([3,4,0,1,5,7,6,2]),t([2,5,7,6,4,0,1,0]),t([3,5,0,1,3,7,6,4]),t([2,4,5,7,6,2,0,0]),t([1,4,5,7,6,0,0,0]),t([2,5,1,3,7,6,4,0]),t([3,6,0,2,3,7,5,4]),t([2,6,2,3,7,5,4,0]),t([3,7,6,2,3,1,5,4]),i})(),_5=4;function eee(i,e){let t=0;for(let r=0;r<_5;r++){const s=B6(i,e[r]);if(s>0)return-1;s===0&&(t|=1<<r)}return t}const x0=ys(),UE=I6(),Wa=T(),ox=T(),VE=T(),GE=T(),BE=T();let tee=class{constructor(e){this._objects=e}submit(e,t){this._objects.preSubmit(t),this._objects.visibleObjects.forAll(r=>r.renderable.material.submit(e,t,r))}queryShadowCasterDepthRange(e){return this._objects.visibleObjects.length?QJ(e,this._objects.visibleObjects):null}};function iee(i){const e=mr().vec3f(w.POSITION);return i.normals&&e.vec2i16(w.NORMALCOMPRESSED,{glNormalized:!0}),i.textureCoordinates===mh.Default?e.vec2f(w.UV0):i.textureCoordinates===mh.Atlas&&(e.vec2f(w.UV0),e.vec4u16(w.UVREGION,{glNormalized:!0})),i.colors&&e.vec4u8(w.COLOR,{glNormalized:!0}),e.alignTo(4)}let ree=class{constructor(){this.externalColor=Pt(),this.externalColorMixMode=fy.Multiply,this.castShadows=!0,this.pickable=!0,this.elevationOffset=0}},see=class extends Ch{constructor(e,t){super(e,"int",fv.Draw,(r,s,a)=>r.setUniform1i(e,t(s,a)))}};var hl;(function(i){i[i.Uniform=0]="Uniform",i[i.Varying=1]="Varying",i[i.COUNT=2]="COUNT"})(hl||(hl={}));const vS=429496.7296;function y5(i,e){af(i/vS*.5+.5,e)}function aee(i,e){switch(e.componentData){case hl.Varying:return nee(i,e);case hl.Uniform:return oee(i);case hl.COUNT:return;default:_o(e.componentData)}}function nee(i,e){const{vertex:t,fragment:r}=i;t.include(To),t.uniforms.add(vv("componentColorTex",a=>a.componentParameters.texture.texture,e.hasWebGL2Context?ms.None:ms.Size)),i.attributes.add(w.COMPONENTINDEX,"float"),i.varyings.add("vExternalColorMixMode","mediump float"),i.varyings.add("vExternalColor","vec4");const s=e.output===A.ObjectAndLayerIdColor;s&&i.varyings.add("vObjectAndLayerIdColor","vec4"),i.include(BF),t.constants.add("elevationScale","float",2*vS),t.constants.add("stride","float",vi("enable-feature:objectAndLayerId-rendering")?3:2),t.code.add(_`
  vec2 getComponentTextureCoordinates(float componentIndex, float typeOffset) {
    vec2 textureSize = ${sm(e,"componentColorTex")};

    float index = componentIndex * stride + typeOffset;
    float coordX = mod(index, textureSize.x);
    float coordY = floor(index / textureSize.x);

    return vec2(coordX, coordY) + 0.5;
  }
  `),t.code.add(_`
  vec4 _readComponentColor() {
    vec2 textureCoordinates = getComponentTextureCoordinates(componentIndex, 0.0);

    return ${ia(e,"componentColorTex","textureCoordinates","1.0 / componentColorTexSize")};
   }

   float readElevationOffset() {
    vec2 textureCoordinates = getComponentTextureCoordinates(componentIndex, 1.0);

    vec4 encodedElevation = ${ia(e,"componentColorTex","textureCoordinates","1.0 / componentColorTexSize")};
    return (rgba2float(encodedElevation) - 0.5) * elevationScale;
  }

  ${s?_`
          void forwardObjectAndLayerIdColor() {
            vec2 textureCoordinates = getComponentTextureCoordinates(componentIndex, 2.0);

            vObjectAndLayerIdColor = ${ia(e,"componentColorTex","textureCoordinates","1.0 / componentColorTexSize")};
          }`:_`void forwardObjectAndLayerIdColor() {}`}

  vec4 forwardExternalColor(out bool castShadows) {
    vec4 componentColor = _readComponentColor() * 255.0;

    float shadowFlag = mod(componentColor.b * 255.0, 2.0);
    componentColor.b -= shadowFlag;
    castShadows = shadowFlag >= 1.0;

    int decodedColorMixMode;
    vExternalColor = decodeSymbolColor(componentColor, decodedColorMixMode) * 0.003921568627451; // = 1/255;
    vExternalColorMixMode = float(decodedColorMixMode) + 0.5; // add 0.5 to avoid interpolation artifacts

    return vExternalColor;
  }
`),r.code.add(_`
  void readExternalColor(out vec4 externalColor, out int externalColorMixMode) {
    externalColor = vExternalColor;
    externalColorMixMode = int(vExternalColorMixMode);
  }

  void outputObjectAndLayerIdColor() {
     ${s?_`gl_FragColor = vObjectAndLayerIdColor;`:""}
  }
`)}function oee(i){const{vertex:e,fragment:t}=i;e.uniforms.add(new ev("externalColor",r=>r.componentParameters.externalColor)),t.uniforms.add(new see("externalColorMixMode",r=>r.componentParameters.externalColorMixMode)),i.varyings.add("vExternalColor","vec4"),e.code.add(_`float readElevationOffset() {
return 0.0;
}
void forwardObjectAndLayerIdColor() {
}
vec4 forwardExternalColor(out bool castShadows) {
vExternalColor = externalColor;
castShadows = true;
return externalColor;
}`),t.code.add(_`void readExternalColor(out vec4 color, out int colorMixMode) {
color = vExternalColor;
colorMixMode = externalColorMixMode;
}
void outputObjectAndLayerIdColor() {
gl_FragColor = vec4(1.0,0.0,0.0,0.0);
}`)}var En;function lee(i,e){const t=i.vertex;switch(t.code.add(_`#define VERTEX_DISCARD_CUTOFF (1.0 - 1.0 / 255.0)`),e.vertexDiscardMode){case En.None:t.code.add(_`#define vertexDiscardByOpacity(_opacity_) {}`);break;case En.Opaque:t.code.add(_`#define vertexDiscardByOpacity(_opacity_) { if (_opacity_ >  VERTEX_DISCARD_CUTOFF) {  gl_Position = vec4(1e38, 1e38, 1e38, 1.0); return; } }`);break;case En.Transparent:t.code.add(_`#define vertexDiscardByOpacity(_opacity_) { if (_opacity_ <= VERTEX_DISCARD_CUTOFF) {  gl_Position = vec4(1e38, 1e38, 1e38, 1.0); return; } }`)}}(function(i){i[i.None=0]="None",i[i.Transparent=1]="Transparent",i[i.Opaque=2]="Opaque",i[i.COUNT=3]="COUNT"})(En||(En={}));var dl;function Cde(i){return i&&Ff(i)?dl.Mars:i&&zf(i)?dl.Moon:dl.Earth}(function(i){i[i.Earth=1]="Earth",i[i.Mars=2]="Mars",i[i.Moon=3]="Moon",i[i.COUNT=4]="COUNT"})(dl||(dl={}));var rn;(function(i){i[i.None=0]="None",i[i.NoOverlay=1]="NoOverlay",i[i.ColorOverlay=2]="ColorOverlay",i[i.ColorOverlayWithWater=3]="ColorOverlayWithWater",i[i.COUNT=4]="COUNT"})(rn||(rn={}));let ct=class extends ua{constructor(){super(...arguments),this.output=A.Color,this.textureCoordinateType=mh.None,this.componentData=hl.Uniform,this.cullFace=Tr.Back,this.vertexDiscardMode=En.None,this.doubleSidedMode=Ia.WindingOrder,this.alphaDiscardMode=en.Opaque,this.integratedMeshMode=rn.None,this.transparencyPassType=We.NONE,this.ellipsoidMode=dl.Earth,this.pbrMode=Wt.Disabled,this.normalType=Rn.Attribute,this.spherical=!1,this.doublePrecisionRequiresObfuscation=!1,this.hasVertexColors=!1,this.hasNormals=!1,this.hasSlicePlane=!1,this.hasBaseColorTexture=!1,this.receiveAmbientOcclusion=!0,this.receiveShadows=!0,this.blendingEnabled=!0,this.hasScreenSpaceReflections=!1,this.hasPolygonOffset=!1,this.hasMetallicRoughnessTexture=!1,this.hasEmissionTexture=!1,this.hasOcclusionTexture=!1,this.hasNormalTexture=!1,this.hasOccludees=!1,this.hasMultipassTerrain=!1,this.cullAboveGround=!1,this.useLegacyTerrainShading=!1,this.hasCloudsReflections=!0,this.snowCover=!1,this.objectAndLayerIdColor=!1,this.hasWebGL2Context=!1}};d([D({count:A.COUNT})],ct.prototype,"output",void 0),d([D({count:mh.COUNT})],ct.prototype,"textureCoordinateType",void 0),d([D({count:hl.COUNT})],ct.prototype,"componentData",void 0),d([D({count:Tr.COUNT})],ct.prototype,"cullFace",void 0),d([D({count:En.COUNT})],ct.prototype,"vertexDiscardMode",void 0),d([D({count:Ia.COUNT})],ct.prototype,"doubleSidedMode",void 0),d([D({count:en.COUNT})],ct.prototype,"alphaDiscardMode",void 0),d([D({count:rn.COUNT})],ct.prototype,"integratedMeshMode",void 0),d([D({count:We.COUNT})],ct.prototype,"transparencyPassType",void 0),d([D({count:dl.COUNT})],ct.prototype,"ellipsoidMode",void 0),d([D({count:Wt.COUNT})],ct.prototype,"pbrMode",void 0),d([D({count:Rn.COUNT})],ct.prototype,"normalType",void 0),d([D()],ct.prototype,"spherical",void 0),d([D()],ct.prototype,"doublePrecisionRequiresObfuscation",void 0),d([D()],ct.prototype,"hasVertexColors",void 0),d([D()],ct.prototype,"hasNormals",void 0),d([D()],ct.prototype,"hasSlicePlane",void 0),d([D()],ct.prototype,"hasBaseColorTexture",void 0),d([D()],ct.prototype,"receiveAmbientOcclusion",void 0),d([D()],ct.prototype,"receiveShadows",void 0),d([D()],ct.prototype,"blendingEnabled",void 0),d([D()],ct.prototype,"hasScreenSpaceReflections",void 0),d([D()],ct.prototype,"hasPolygonOffset",void 0),d([D()],ct.prototype,"hasMetallicRoughnessTexture",void 0),d([D()],ct.prototype,"hasEmissionTexture",void 0),d([D()],ct.prototype,"hasOcclusionTexture",void 0),d([D()],ct.prototype,"hasNormalTexture",void 0),d([D()],ct.prototype,"hasOccludees",void 0),d([D()],ct.prototype,"hasMultipassTerrain",void 0),d([D()],ct.prototype,"cullAboveGround",void 0),d([D()],ct.prototype,"useLegacyTerrainShading",void 0),d([D()],ct.prototype,"hasCloudsReflections",void 0),d([D()],ct.prototype,"snowCover",void 0),d([D()],ct.prototype,"objectAndLayerIdColor",void 0),d([D()],ct.prototype,"hasWebGL2Context",void 0),d([D({constValue:fv.Draw})],ct.prototype,"pbrTextureBindType",void 0),d([D({constValue:!0})],ct.prototype,"hasSliceHighlight",void 0),d([D({constValue:!1})],ct.prototype,"hasSliceInVertexProgram",void 0),d([D({constValue:!1})],ct.prototype,"useCustomDTRExponentForWater",void 0),d([D({constValue:!1})],ct.prototype,"hasVertexTangents",void 0),d([D({constValue:!0})],ct.prototype,"supportsTextureAtlas",void 0),d([D({constValue:!1})],ct.prototype,"highStepCount",void 0),d([D({constValue:!1})],ct.prototype,"instancedDoublePrecision",void 0),d([D({constValue:!0})],ct.prototype,"useFillLights",void 0),d([D({constValue:!1})],ct.prototype,"objectAndLayerIdColorInstanced",void 0);function HE(i,e){i.include(jf,e),i.fragment.include(HF);const t=i.fragment;t.uniforms.add(new ev("baseColor",r=>r.baseColor)),t.uniforms.add(new Tp("objectOpacity",r=>r.objectOpacity)),e.hasVertexColors?t.code.add(_`vec3 _baseColor() {
return baseColor.rgb * vColor.rgb;
}
float _baseOpacity() {
return baseColor.a * vColor.a;
}`):t.code.add(_`vec3 _baseColor() {
return baseColor.rgb;
}
float _baseOpacity() {
return baseColor.a;
}`),t.code.add(_`vec4 computeMaterialColor(vec4 textureColor, vec4 externalColor, int externalColorMixMode) {
vec3 baseColor = _baseColor();
float baseOpacity = _baseOpacity();
vec3 color = mixExternalColor(
baseColor,
textureColor.rgb,
externalColor.rgb,
externalColorMixMode
);
float opacity = objectOpacity * mixExternalOpacity(
baseOpacity,
textureColor.a,
externalColor.a,
externalColorMixMode
);
return vec4(color, opacity);
}`)}function kE(i,e){const t=i.fragment;switch(e.doubleSidedMode){case Ia.None:t.code.add(_`vec3 _adjustDoublesided(vec3 normal) {
return normal;
}`);break;case Ia.View:i.include(A0,e),t.code.add(_`vec3 _adjustDoublesided(vec3 normal) {
return dot(normal, vPositionWorldCameraRelative) > 0.0 ? -normal : normal;
}`);break;case Ia.WindingOrder:t.code.add(_`vec3 _adjustDoublesided(vec3 normal) {
return gl_FrontFacing ? normal : -normal;
}`);break;default:_o(e.doubleSidedMode);case Ia.COUNT:}switch(e.normalType){case Rn.Attribute:case Rn.CompressedAttribute:i.include(X3,e),t.code.add(_`vec3 shadingNormalWorld() {
return _adjustDoublesided(normalize(vNormalWorld));
}
vec3 shadingNormal_view() {
vec3 normal = normalize(vNormalView);
return gl_FrontFacing ? normal : -normal;
}`);break;case Rn.ScreenDerivative:i.extensions.add("GL_OES_standard_derivatives"),i.include(A0,e),t.code.add(_`vec3 shadingNormalWorld() {
return normalize(cross(
dFdx(vPositionWorldCameraRelative),
dFdy(vPositionWorldCameraRelative)
));
}
vec3 shadingNormal_view() {
return normalize(cross(dFdx(vPosition_view),dFdy(vPosition_view)));
}`);break;case Rn.Ground:e.spherical?(i.include(A0,e),t.code.add(_`vec3 shadingNormalWorld() {
return normalize(positionWorld());
}`)):t.code.add(_`vec3 shadingNormalWorld() {
return vec3(0.0, 0.0, 1.0);
}`),i.extensions.add("GL_OES_standard_derivatives"),t.code.add(_`vec3 shadingNormal_view() {
return normalize(cross(dFdx(vPosition_view),dFdy(vPosition_view))).xyz;
}`);break;default:_o(e.normalType);case Rn.COUNT:}}function cee(i,e){const t=i.fragment;if(e.hasBaseColorTexture&&(e.output===A.Color||e.alphaDiscardMode!==en.Opaque)){i.include(kF,e);const r=e.textureCoordinateType===mh.Atlas;t.uniforms.add(vv("baseColorTexture",s=>s.texture,r?e.hasWebGL2Context?ms.None:ms.Size:ms.None)),r?(i.include(jF),t.code.add(_`
        vec4 readBaseColorTexture() {
          vec2 textureSize = ${sm(e,"baseColorTexture")};
          return textureAtlasLookup(baseColorTexture, textureSize, vuv0, vuvRegion);
        }
      `)):t.code.add(_`vec4 readBaseColorTexture() {
return texture2D(baseColorTexture, vuv0);
}`)}else t.code.add(_`vec4 readBaseColorTexture() { return vec4(1.0); }`)}function hee(i){const e=new $t;e.include(A0,i),e.include(X3,i),e.include(jf,i),e.include(gv,i),e.include(yv,i),e.include(aee,i),e.include(qF,i),e.include(WF,i),e.include(cee,i),e.include(lee,i);const{vertex:t,fragment:r}=e;i.pbrMode!==Wt.Normal&&i.pbrMode!==Wt.Schematic||(e.include(XF,i),i.hasNormalTexture&&e.include(QF,i));const s=i.output===A.Shadow||i.output===A.ShadowHighlight||i.output===A.ShadowExcludeHighlight;s&&i.componentData===hl.Varying?t.code.add(_`#define discardShadows(castShadows) { if(!castShadows) { gl_Position = vec4(1e38, 1e38, 1e38, 1.0); return; } }`):t.code.add(_`#define discardShadows(castShadows) {}`);const a=i.integratedMeshMode===rn.ColorOverlay||i.integratedMeshMode===rn.ColorOverlayWithWater,n=a&&i.output===A.Color&&i.pbrMode===Wt.WaterOnIntegratedMesh;return a&&(e.include(ef,i),e.include(wK,i),i.spherical?t.code.add(_`
      const float invEllipsoidRadius = ${_.float(1/(i.ellipsoidMode===dl.Earth?Ys.radius:i.ellipsoidMode===dl.Mars?c9.radius:h9.radius))};
      vec2 projectOverlay(vec3 pos) {
        return pos.xy / (1.0 + invEllipsoidRadius * pos.z);
      }
      `):t.code.add(_`vec2 projectOverlay(vec3 pos) { return pos.xy; }`)),n&&(e.varyings.add("tbnTangent","vec3"),e.varyings.add("tbnBiTangent","vec3"),e.varyings.add("groundNormal","vec3")),t.code.add(_`
    void main() {
      bool castShadows;
      vec4 externalColor = forwardExternalColor(castShadows);
      discardShadows(castShadows);

      vertexDiscardByOpacity(externalColor.a);

      ${i.output===A.ObjectAndLayerIdColor?_`externalColor.a = 1.0;`:""}

      if (externalColor.a < ${_.float(ra)}) {
        // Discard this vertex
        gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
        return;
      }

      forwardPosition(readElevationOffset());
      forwardNormal();
      forwardTextureCoordinates();
      forwardVertexColor();
      forwardLinearDepth();
      ${i.output===A.ObjectAndLayerIdColor?_`forwardObjectAndLayerIdColor();`:""}
      ${n?i.spherical?_`
                groundNormal = normalize(positionWorld());
                tbnTangent = normalize(cross(vec3(0.0, 0.0, 1.0), groundNormal));
                tbnBiTangent = normalize(cross(groundNormal, tbnTangent));`:_`
                groundNormal = vec3(0.0, 0.0, 1.0);
                tbnTangent = vec3(1.0, 0.0, 0.0);
                tbnBiTangent = vec3(0.0, 1.0, 0.0);`:""}
      ${a?_`setOverlayVTC(projectOverlay(position));`:""}
    }
  `),i.output===A.Alpha&&(r.include(ml),e.include(Yl,i),e.include(HE,i),a&&r.uniforms.add(new lt("ovColorTex",(o,l)=>qw(o,l))),r.code.add(_`
      void main() {
        discardBySlice(vPositionWorldCameraRelative);
        ${i.hasMultipassTerrain?_`terrainDepthTest(gl_FragCoord, vPosition_view.z);`:""}

        vec4 textureColor = readBaseColorTexture();
        discardOrAdjustAlpha(textureColor);

        vec4 externalColor;
        int externalColorMixMode;
        readExternalColor(externalColor, externalColorMixMode);

        vec4 materialColor = computeMaterialColor(
          textureColor,
          externalColor,
          externalColorMixMode
        );
        ${a?_`
                vec4 overlayColor = getOverlayColor(ovColorTex, vtcOverlay);
                materialColor = materialColor * (1.0 - overlayColor.a) + overlayColor;`:""}

        gl_FragColor = vec4(materialColor.a);
      }
    `)),i.output===A.Color&&(r.include(ml),e.include(Yl,i),e.include(HE,i),e.include(kE,i),e.include(ef,i),i.receiveShadows?(e.include(Q3,i),r.code.add(_`float evaluateShadow() {
return readShadowMap(vPositionWorldCameraRelative, linearDepth);
}`)):r.code.add(_`float evaluateShadow() { return 0.0; }`),a&&r.uniforms.add(new lt("ovColorTex",(o,l)=>qw(o,l))),r.code.add(_`
      void main() {
        discardBySlice(vPositionWorldCameraRelative);
        ${i.hasMultipassTerrain?_`terrainDepthTest(gl_FragCoord, vPosition_view.z);`:""}

        vec4 textureColor = readBaseColorTexture();
        discardOrAdjustAlpha(textureColor);

        vec4 externalColor;
        int externalColorMixMode;
        readExternalColor(externalColor, externalColorMixMode);

        vec4 materialColor = computeMaterialColor(
          textureColor,
          externalColor,
          externalColorMixMode
        );
        ${a?_`vec4 overlayColor = getOverlayColor(ovColorTex, vtcOverlay);`:""}
    `),i.pbrMode===Wt.Normal||i.pbrMode===Wt.Schematic?(im(r),r.code.add(_`
        ${i.pbrMode===Wt.Normal?_`
                applyPBRFactors();
                if (int(externalColorMixMode) == 3) {
                  mrr = vec3(0.0, 0.6, 0.2);
                }`:""}
        vec3 normalVertex = shadingNormalWorld();
        float additionalIrradiance = 0.02 * mainLightIntensity[2];
      `),i.hasNormalTexture?r.code.add(_`mat3 tangentSpace = computeTangentSpace(normalVertex, vPositionWorldCameraRelative, vuv0);
vec3 shadingNormal = computeTextureNormal(tangentSpace, vuv0);`):r.code.add(_`vec3 shadingNormal = normalVertex;`),r.code.add(_`${i.spherical?_`vec3 normalGround = normalize(positionWorld());`:_`vec3 normalGround = vec3(0.0, 0.0, 1.0);`}
      `),r.code.add(_`
        vec3 viewDir = normalize(vPositionWorldCameraRelative);
        float ssao = 1.0 - occlusion * (1.0 - evaluateAmbientOcclusion());

        ${i.snowCover?_`
                vec3 surfaceNormal = normalize(shadingNormalWorld());
                float snow = smoothstep(0.5, 0.55, dot(surfaceNormal, normalize(positionWorld())));
                materialColor.rgb = mix(materialColor.rgb, vec3(1), snow);

                shadingNormal = mix(shadingNormal, surfaceNormal, snow);
                ssao = mix(ssao, 0.0, snow);
                mrr = mix(mrr, vec3(0.0, 1.0, 0.04), snow);
                emission = mix(emission, vec3(0.0), snow);`:""}

        ${a?_` materialColor = materialColor * (1.0 - overlayColor.a) + overlayColor;`:""}

        vec3 additionalLight = evaluateAdditionalLighting(ssao, positionWorld());
        vec4 shadedColor = vec4(evaluateSceneLightingPBR(shadingNormal, materialColor.rgb, evaluateShadow(), ssao, additionalLight, viewDir, normalGround, mrr, emission, additionalIrradiance), materialColor.a);
        `)):(i.receiveShadows?r.code.add(_`float shadow = evaluateShadow();`):i.spherical?(NT(r),r.code.add(_`float additionalAmbientScale = additionalDirectedAmbientLight(positionWorld());
float shadow = lightingGlobalFactor * (1.0 - additionalAmbientScale);`)):r.code.add(_`float shadow = 0.0;`),n&&r.uniforms.add(new lt("ovNormalTex",(o,l)=>bS(l))),i.snowCover&&(e.extensions.add("GL_OES_standard_derivatives"),r.code.add(_`vec3 surfaceNormal = normalize(cross(dFdx(vPositionWorldCameraRelative), dFdy(vPositionWorldCameraRelative)));
float snow = smoothstep(0.5, 0.55, dot(surfaceNormal, normalize(positionWorld())));
materialColor.rgb = mix(materialColor.rgb, vec3(1), snow);`)),r.code.add(_`
        float ambientOcclusion = evaluateAmbientOcclusion();
        vec3 additionalLight = evaluateAdditionalLighting(ambientOcclusion, positionWorld());

        ${a?_` materialColor = materialColor * (1.0 - overlayColor.a) + overlayColor;`:""}

        vec4 shadedColor = vec4(evaluateSceneLighting(shadingNormalWorld(), materialColor.rgb, shadow, ambientOcclusion, additionalLight), materialColor.a);
      ${n?_`
              vec4 overlayWaterMask = getOverlayColor(ovNormalTex, vtcOverlay);
              float waterNormalLength = length(overlayWaterMask);
              if (waterNormalLength > 0.95) {
                mat3 tbnMatrix = mat3(tbnTangent, tbnBiTangent, groundNormal);
                vec4 waterColorLinear = getOverlayWaterColor(overlayWaterMask, overlayColor, -normalize(vPositionWorldCameraRelative), shadow, groundNormal, tbnMatrix, vPosition_view, positionWorld());
                vec4 waterColorNonLinear = delinearizeGamma(vec4(waterColorLinear.xyz, 1.0));
                // un-gamma the ground color to mix in linear space
                shadedColor = mix(shadedColor, waterColorNonLinear, waterColorLinear.w);
              }`:""}
      `)),r.code.add(_`
        gl_FragColor = highlightSlice(shadedColor, vPositionWorldCameraRelative);
        ${i.transparencyPassType===We.Color?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}
      }
    `)),(i.output===A.Depth||s)&&(e.include(gh,i),r.code.add(_`void main() {
discardBySlice(vPositionWorldCameraRelative);
vec4 textureColor = readBaseColorTexture();
discardOrAdjustAlpha(textureColor);
outputDepth(linearDepth);
}`)),i.output===A.Normal&&(e.include(kE,i),r.code.add(_`
      void main() {
        discardBySlice(vPositionWorldCameraRelative);

        vec4 textureColor = readBaseColorTexture();
        discardOrAdjustAlpha(textureColor);

        // note: the alpha component needs to be 1.0 in order for this material
        // to influence ambient occlusion, see the ssao fragment shader
        float alpha = ${i.normalType===Rn.Ground?"0.0":"1.0"};
        gl_FragColor = vec4(vec3(.5) + .5 * shadingNormal_view(), alpha);
      }
    `)),i.output===A.ObjectAndLayerIdColor&&e.fragment.code.add(_`
      void main() {
        discardBySlice(vPositionWorldCameraRelative);

        vec4 textureColor = readBaseColorTexture();
        discardOrAdjustAlpha(textureColor);

        ${a?_`gl_FragColor = getOverlayColorTexel(vtcOverlay);`:"outputObjectAndLayerIdColor();"}
      }
    `),i.output===A.Highlight&&(e.include(Sh,i),r.code.add(_`
      void main() {
        discardBySlice(vPositionWorldCameraRelative);

        vec4 textureColor = readBaseColorTexture();
        discardOrAdjustAlpha(textureColor);

        ${a?_`
                vec4 overlayColor = getCombinedOverlayColor();
                if (overlayColor.a == 0.0) {
                  gl_FragColor = vec4(0.0);
                  return;
                }`:""}

        outputHighlight();
      }
    `)),e}function bS(i){return i.overlays.length===0?null:i.overlays[oi.INNER].getValidTexture(Ci.Water)}const dee=Object.freeze(Object.defineProperty({__proto__:null,build:hee,getOverlayNormalTexture:bS},Symbol.toStringTag,{value:"Module"}));let v5=class b5 extends Mt{initializeConfiguration(e,t){t.hasWebGL2Context=e.rctx.type===da.WEBGL2,t.spherical=e.viewingMode===ve.Global,t.doublePrecisionRequiresObfuscation=e.rctx.driverTest.doublePrecisionRequiresObfuscation.result}initializeProgram(e){return new Rt(e.rctx,b5.shader.get().build(this.configuration),x5)}_setPipelineState(e){const t=this.configuration,r=t.integratedMeshMode!==rn.None,s=e===We.NONE,a=e===We.FrontFace;return qe({blending:t.output!==A.Color&&t.output!==A.Alpha||!t.blendingEnabled?null:s?In:Ph(e),culling:HT(t.cullFace),depthTest:{func:Xd(e)},depthWrite:s||a?cn:null,colorWrite:at,stencilWrite:r||t.hasOccludees?Kl:null,stencilTest:r?ZF(Tg.IntegratedMeshMaskExcluded):t.hasOccludees?Wd:null,polygonOffset:s||a?t.hasPolygonOffset?{factor:2,units:2}:null:VT})}initializePipeline(){return this._setPipelineState(this.configuration.transparencyPassType)}};v5.shader=new Dt(dee,()=>_e(()=>import("./ComponentShader.glsl-839b992b.js"),["assets/ComponentShader.glsl-839b992b.js","assets/objectResourceUtils-782953c3.js","assets/devEnvironmentUtils-5002a058.js","assets/calcite-8912bd40.js","assets/index-00759e4a.js","assets/index-5026a37a.css","assets/calcite-96fa36fd.css","assets/mat3f64-50f3b9f6.js","assets/mat4f64-abdda1bb.js","assets/BufferView-379a78a4.js","assets/vec33-69c9e93b.js","assets/DefaultMaterial_COLOR_GAMMA-6ed76d86.js","assets/types-e1c0a5bf.js","assets/enums-e2e92c86.js","assets/Version-aa0a1d91.js","assets/quat-7b70e9a8.js","assets/quatf64-f8f1c132.js","assets/resourceUtils-527631ac.js","assets/basicInterfaces-7449a8bf.js","assets/Indices-d8bff7b2.js","assets/NestedMap-1b5db22e.js","assets/requestImageUtils-d1ba3b36.js","assets/symbolColorUtils-c9d24716.js","assets/Util-6d3f024a.js","assets/sphere-d0e5285d.js","assets/VertexAttribute-15d1866a.js","assets/doublePrecisionUtils-e3c3d0d8.js","assets/OrderIndependentTransparency-5f7257d7.js","assets/Texture-563cf5e5.js","assets/FramebufferObject-8b18fc0c.js","assets/VertexElementDescriptor-2925c6af.js","assets/InterleavedLayout-d57c91d0.js","assets/vec3f32-01c06d8d.js","assets/plane-5e2b046c.js","assets/spatialReferenceEllipsoidUtils-afb35af9.js","assets/scaleUtils-d13015f2.js","assets/ElevationSamplerData-e3118b17.js","assets/Octree-499541ed.js","assets/edgeProcessing-20e12367.js","assets/deduplicate-769a6f51.js","assets/MeshComponent-788e605a.js","assets/earcut-61f7b102.js","assets/imageUtils-c2d0d1ae.js","assets/projection-5969b753.js","assets/ZoomMomentumEstimator-ef57e6a4.js","assets/floatRGBA-ca2b39ca.js","assets/dehydratedFeatures-3a140d03.js","assets/quantizationUtils-b3b2ae2a.js","assets/labelFormatUtils-71e1f841.js","assets/orientedBoundingBox-a14b97b5.js","assets/quatf32-51a323b8.js","assets/SnappingCandidate-970faec6.js","assets/callExpressionWithFeature-df1a8f01.js","assets/DefaultVertexAttributeLayouts-5f20d8dd.js","assets/geometryServiceUtils-a536bb19.js","assets/project-909a4219.js","assets/LercDecoder-65586d50.js","assets/VectorTile-d41a1f0f.js","assets/enums-fb086c25.js","assets/config-1337d16e.js","assets/TiledDisplayObject-419c008b.js","assets/DisplayObject-87c37b69.js","assets/rasterUtils-7694cc98.js","assets/resources-7587d8f4.js","assets/workerHelper-6131d203.js","assets/webgl-debug-7f880832.js","assets/RenderingContext-0f21aa0e.js","assets/ProgramCache-f29c900e.js","assets/Program-77209250.js","assets/MediaLayer-4c42fc2f.js","assets/MediaElementView-06baa4d4.js","assets/normalizeUtilsSync-3ea564a9.js","assets/resourceExtension-f31d9f10.js","assets/BoundsStore-00da37da.js","assets/PooledRBush-5a11bc7e.js","assets/prism-line-numbers-eff41b13.js","assets/label2-a2f37e65.js","assets/interactive-1de2e238.js","assets/loadable-6afd516d.js","assets/t9n-81df3a71.js","assets/observers-c89705b8.js","assets/icon-8e47fbec.js","assets/loader-c773e800.js","assets/guid-51402ee7.js","assets/prism-line-numbers-7c5d72ff.css"]));const x5=new Map([[w.POSITION,0],[w.NORMAL,1],[w.NORMALCOMPRESSED,1],[w.COLOR,2],[w.UV0,3],[w.UVREGION,4],[w.COMPONENTINDEX,5]]);let uee=class extends Gi{constructor(){super(...arguments),this._dirty=!0}_setDirty(){this._dirty=!0}_setClean(){if(this._dirty=!1,this._parameterBlocks!=null)for(const e of this._parameterBlocks)this[e]._setClean()}get dirty(){return this._dirty||this._checkParameterBlocksDirty()}_checkParameterBlocksDirty(){if(this._parameterBlocks==null)return!1;for(const e of this._parameterBlocks)if(this[e].dirty)return!0;return!1}},xS=class{constructor(){this._dirty=!0}_setDirty(){this._dirty=!0}_setClean(){this._dirty=!1}get dirty(){return this._dirty}};function Ti(i={}){return(e,t)=>{const r=e._parameterCount??0;if(e._parameterCount=r+1,i.vectorOps){const s=i.vectorOps;Object.defineProperty(e,t,{get(){return this[r]},set(a){const n=this[r];if(n==null)this[r]=a;else{if(s.equals(n,a))return;s.copy(n,a)}this._setDirty()}})}else Object.defineProperty(e,t,{get(){return this[r]},set(s){this[r]!==s&&(i.dispose&&this[r]&&this[r].dispose(),this[r]=s,this._setDirty())}})}}function jE(){return(i,e)=>{const t=i._parameterCount??0;i._parameterCount=t+1,i._parameterBlocks=i._parameterBlocks||[],i._parameterBlocks.push(t),Object.defineProperty(i,e,{get(){return this[t]},set(r){this[t]!==r&&(this[t]=r,this._setDirty())}})}}let Zv=class{constructor(e){this._low=Li(),this._high=Li(),e&&this.set(e)}get low(){return this._low}get high(){return this._high}set(e){const t=this._low,r=this._high;H(t,e),Xr(r,e,t)}setElements(e,t,r){j(qE,e,t,r),this.set(qE)}get(e){return X(e,this._low,this._high)}getLowScaled(e){return B(e,this._low,1)}};const qE=T();let Or=class extends uee{constructor(e,t){super(),this.toMapSpace=t,this.baseColor=lf(1,1,1,1),this.usePBR=!1,this.hasParametersFromSource=!1,this.mrrFactors=qt(1,1,.5),this.emissiveFactor=qt(0,0,0),this.baseColorTexture=null,this.metallicRoughnessTexture=null,this.emissionTexture=null,this.occlusionTexture=null,this.normalTexture=null,this.objectOpacity=1,this.commonMaterialParameters=new iy,this.componentParameters=new Ug,this.textureAlphaCutoff=Ex,this.alphaDiscardMode=en.Opaque,this.isIntegratedMesh=!1,this.polygonOffsetEnabled=!1,this.ellipsoidMode=dl.Earth,this.hasOccludees=!1,this._techniqueConfiguration=new ct;const r=new Zv(e.position),s=d9(e.rotationScale);Jp(s,s),this.transformNormalGlobalFromModel=ic(s,s),this.transformWorldFromModelTL=r.low,this.transformWorldFromModelTH=r.high,this.transformWorldFromModelRS=e.rotationScale}dispose(){this._technique=er(this._technique),this.baseColorTexture=null,this.metallicRoughnessTexture=null,this.emissionTexture=null,this.occlusionTexture=null,this.normalTexture=null}get texture(){return g(this.baseColorTexture)?this.baseColorTexture.glTexture:null}get textureMetallicRoughness(){return g(this.metallicRoughnessTexture)?this.metallicRoughnessTexture.glTexture:null}get textureEmissive(){return g(this.emissionTexture)?this.emissionTexture.glTexture:null}get textureOcclusion(){return g(this.occlusionTexture)?this.occlusionTexture.glTexture:null}get textureNormal(){return g(this.normalTexture)?this.normalTexture.glTexture:null}prepareTechnique(e,t,r,s){const a=this._techniqueConfiguration;a.hasVertexColors=s.colors,a.hasNormals=s.normals,a.textureCoordinateType=s.textureCoordinates,a.hasMetallicRoughnessTexture=g(this.metallicRoughnessTexture),a.hasEmissionTexture=g(this.emissionTexture),a.hasOcclusionTexture=g(this.occlusionTexture),a.hasNormalTexture=g(this.normalTexture),a.transparencyPassType=t.identifier===Da.Material&&r.transparencyPassType!=null?r.transparencyPassType:We.NONE,a.hasMultipassTerrain=t.identifier===Da.Material&&r.multipassTerrain!=null&&r.multipassTerrain.enabled,a.cullAboveGround=t.identifier===Da.Material&&r.multipassTerrain!=null&&r.multipassTerrain.cullAboveGround,a.ellipsoidMode=this.ellipsoidMode,a.componentData=this.componentParameters.type,a.cullFace=this.commonMaterialParameters.cullFace,a.doubleSidedMode=this.commonMaterialParameters.doubleSided?Ia.View:Ia.None,a.hasBaseColorTexture=g(this.baseColorTexture);const n=this._computeWhichMaterialPass();a.blendingEnabled=n===Ss.Transparent||n===Ss.OpaqueAndTransparent,a.alphaDiscardMode=this.alphaDiscardMode,a.integratedMeshMode=this.isIntegratedMesh?mee(r)?bS(r)?rn.ColorOverlayWithWater:rn.ColorOverlay:rn.NoOverlay:rn.None,a.useLegacyTerrainShading=this.isIntegratedMesh&&Ot.TERRAIN_USE_LEGACY_SHADING,a.hasPolygonOffset=this.polygonOffsetEnabled;const o=this.hasParametersFromSource&&P(this.baseColorTexture);if(a.pbrMode=a.integratedMeshMode===rn.ColorOverlayWithWater?Wt.WaterOnIntegratedMesh:this.usePBR?o?Wt.Schematic:Wt.Normal:Wt.Disabled,a.normalType=a.integratedMeshMode===rn.None?a.hasNormals?Rn.CompressedAttribute:Rn.ScreenDerivative:Rn.Ground,a.hasSlicePlane=g(r.slicePlane)&&this.commonMaterialParameters.hasSlicePlane,t.identifier===Da.ShadowMap)a.output=A.Shadow,a.vertexDiscardMode=En.None;else if(t.identifier===Da.Highlight)a.output=A.Highlight,a.vertexDiscardMode=En.None;else{switch(this._computeWhichMaterialPass()===Ss.OpaqueAndTransparent?a.vertexDiscardMode=t.transparent?En.Opaque:En.Transparent:a.vertexDiscardMode=En.None,a.output=t.output,a.receiveAmbientOcclusion=!1,a.receiveShadows=!1,t.output){case A.Color:a.receiveAmbientOcclusion=r.ssaoHelper.active,a.hasOccludees=r.hasOccludees,a.receiveShadows=r.shadowMap.ready,a.hasScreenSpaceReflections=r.ssr.enabled,a.hasCloudsReflections=g(r.cloudsFade.data);break;case A.Alpha:a.hasOccludees=r.hasOccludees;break;case A.ObjectAndLayerIdColor:a.objectAndLayerIdColor=!0}a.snowCover=this.hasSnowCover(r)}return this._technique=e.releaseAndAcquire(v5,a,this._technique),this._setClean(),this._technique}hasSnowCover(e){return g(e.weather)&&e.weatherVisible&&e.weather.type==="snowy"&&e.weather.snowCover==="enabled"}submit(e,t,r){if(this.objectOpacity===0)return;const s=r.renderable.geometry,a=r.components,n=r.renderable.meta.cameraDepthSquared,o=a.geometryRanges,l=a.highlightRanges,c=a.defaultShadowMapRanges;switch(this._computeWhichMaterialPass()){case Ss.Opaque:e.materialOpaque.submitDraw(this,s,o,n);break;case Ss.Transparent:e.materialTransparent.submitDraw(this,s,o,n);break;case Ss.OpaqueAndTransparent:e.materialOpaque.submitDraw(this,s,o,n),e.materialTransparent.submitDraw(this,s,o,n);break;case Ss.IntegratedMesh:e.materialIntegratedMesh.submitDraw(this,s,o,n),pee(t)&&e.highlightIntegratedMesh.submitDraw(this,s,o,n)}const h=this.componentParameters.castShadows!==wr.None;h&&e.shadowMap.submitDraw(this,s,o,n),g(l)&&(e.highlight.submitDraw(this,s,l,n),h&&e.highlightShadowMap.submitDraw(this,s,l,n)),h&&g(c)&&e.defaultShadowMap.submitDraw(this,s,c,n)}_computeWhichMaterialPass(){return this.isIntegratedMesh?Ss.IntegratedMesh:this.objectOpacity<1?Ss.Transparent:this.componentParameters.opaqueOverride===wr.All?Ss.Opaque:this.baseColor[3]<1||this.alphaDiscardMode===en.Blend||this.alphaDiscardMode===en.MaskBlend?Ss.Transparent:this.componentParameters.transparent===wr.None?Ss.Opaque:this.componentParameters.transparent===wr.All?Ss.Transparent:Ss.OpaqueAndTransparent}};var Ss,wr;d([Ti({vectorOps:h3})],Or.prototype,"baseColor",void 0),d([Ti()],Or.prototype,"usePBR",void 0),d([Ti()],Or.prototype,"hasParametersFromSource",void 0),d([Ti({vectorOps:WS})],Or.prototype,"mrrFactors",void 0),d([Ti({vectorOps:WS})],Or.prototype,"emissiveFactor",void 0),d([Ti({dispose:!0})],Or.prototype,"baseColorTexture",void 0),d([Ti({dispose:!0})],Or.prototype,"metallicRoughnessTexture",void 0),d([Ti({dispose:!0})],Or.prototype,"emissionTexture",void 0),d([Ti({dispose:!0})],Or.prototype,"occlusionTexture",void 0),d([Ti({dispose:!0})],Or.prototype,"normalTexture",void 0),d([Ti()],Or.prototype,"objectOpacity",void 0),d([jE()],Or.prototype,"commonMaterialParameters",void 0),d([jE()],Or.prototype,"componentParameters",void 0),d([Ti()],Or.prototype,"textureAlphaCutoff",void 0),d([Ti()],Or.prototype,"alphaDiscardMode",void 0),d([Ti()],Or.prototype,"isIntegratedMesh",void 0),d([Ti()],Or.prototype,"polygonOffsetEnabled",void 0),d([Ti()],Or.prototype,"ellipsoidMode",void 0),d([Ti()],Or.prototype,"hasOccludees",void 0),function(i){i[i.Opaque=0]="Opaque",i[i.Transparent=1]="Transparent",i[i.OpaqueAndTransparent=2]="OpaqueAndTransparent",i[i.IntegratedMesh=3]="IntegratedMesh"}(Ss||(Ss={}));let iy=class extends xS{constructor(){super(...arguments),this.doubleSided=!1,this.cullFace=Tr.Back,this.hasSlicePlane=!0}};d([Ti()],iy.prototype,"doubleSided",void 0),d([Ti()],iy.prototype,"cullFace",void 0),d([Ti()],iy.prototype,"hasSlicePlane",void 0);let Ug=class extends xS{constructor(){super(...arguments),this.externalColor=hi(1,1,1,1),this.externalColorMixMode=fy.Multiply,this.castShadows=wr.All}get transparent(){return this.externalColor[3]<1?wr.All:wr.None}get opaqueOverride(){return this.externalColorMixMode===fy.Replace&&this.externalColor[3]===1?wr.All:wr.None}get visible(){return this.externalColor[3]>0?wr.All:wr.None}get type(){return hl.Uniform}};d([Ti({vectorOps:h3})],Ug.prototype,"externalColor",void 0),d([Ti()],Ug.prototype,"externalColorMixMode",void 0),d([Ti()],Ug.prototype,"castShadows",void 0),function(i){i[i.All=0]="All",i[i.Some=1]="Some",i[i.None=2]="None"}(wr||(wr={}));let yg=class extends xS{constructor(){super(...arguments),this.texture=null,this.transparent=wr.None,this.opaqueOverride=wr.None,this.castShadows=wr.None}get type(){return hl.Varying}};function pee(i){return i.overlays.length!==0&&g(i.overlays[oi.INNER].getValidTexture(Ci.Highlight))}function mee(i){return i.overlays.length!==0&&g(i.overlays[oi.INNER].getColorTextureNoRasterImage())}d([Ti()],yg.prototype,"texture",void 0),d([Ti()],yg.prototype,"transparent",void 0),d([Ti()],yg.prototype,"opaqueOverride",void 0),d([Ti()],yg.prototype,"castShadows",void 0);let gee=class{constructor(e){this._maxCount=e,this._nextIndex=0,this._recycledIndices=[]}get activeCount(){return this._nextIndex-this._recycledIndices.length}get availableCount(){return this._recycledIndices.length+this._maxCount-this._nextIndex}acquire(){return this._recycledIndices.length>0?this._recycledIndices.pop():this.availableCount?this._nextIndex++:void 0}release(e){this._recycledIndices.push(e)}},fee=class{constructor(e,t=1){this._rctx=e,this._fieldCount=t,this.textureWidth=4096,this._dirty=!0,this._texture=new Ai(this._rctx,{target:tr.TEXTURE_2D,pixelFormat:St.RGBA,dataType:Zt.UNSIGNED_BYTE,samplingMode:Qt.NEAREST,wrapMode:kt.CLAMP_TO_EDGE,width:this.textureWidth,height:1,flipped:!1}),this._data=new fh(new ArrayBuffer(4*this.textureWidth))}dispose(){this._texture.dispose(),this._texture=void 0,this._data=void 0}setData(e,t,r,s,a,n){const o=e*this._fieldCount+t;this._dirty=!0,this._data.set(o,0,r),this._data.set(o,1,s),this._data.set(o,2,a),this._data.set(o,3,n)}setDataElement(e,t,r,s){const a=e*this._fieldCount+t;this._dirty=!0,this._data.set(a,r,s)}resizeToFit(e){const t=e*this._fieldCount;if(t>=this._data.count){const r=Math.ceil((t+1)/this.textureWidth)*this.textureWidth,s=new fh(new ArrayBuffer(4*r));s.typedBuffer.set(this._data.typedBuffer),this._data=s}}updateTexture(){if(!this._dirty)return;const e=this._texture.descriptor.width,t=this._texture.descriptor.height;this._data.count>e*t&&this._texture.resize(e,this._data.count/e),this._texture.setData(this._data.typedBuffer),this._dirty=!1}get texture(){return this._texture}};const w5=65536;let _ee=class{constructor(e,t=1){this.textureBuffer=new fee(e,t),this._indexManager=new gee(w5)}dispose(){this.textureBuffer.dispose(),this.textureBuffer=void 0}get availableCount(){return this._indexManager.availableCount}get activeCount(){return this._indexManager.activeCount}acquireIndex(){const e=this._indexManager.acquire();return this.textureBuffer.resizeToFit(e),e}releaseIndex(e){this._indexManager.release(e)}},T5=class{constructor(e,t=1){this._rctx=e,this._fieldCount=t,this._buffers=[]}garbageCollect(){this._buffers=this._buffers.filter(e=>e.activeCount!==0||(e.dispose(),!1))}destroy(){this._buffers.forEach(e=>e.dispose()),this._buffers=[]}getBuffer(e){for(const r of this._buffers)if(r.availableCount>=e)return r;if(e>w5)return null;const t=new _ee(this._rctx,this._fieldCount);return this._buffers.push(t),t}updateTextures(){for(const e of this._buffers)e.textureBuffer.updateTexture()}};const WE=Pe.getLogger("esri.views.3d.webgl-engine.collections.Component.ComponentObjectCollection");class yee{constructor(e,t){this._renderManager=e,this._viewingMode=t,this._objects=[new At,new At],this._renderSubmit=new tee(this),this._renderManager.register(this._renderSubmit),this._hasObjectAndLayerId=vi("enable-feature:objectAndLayerId-rendering"),this._componentBufferManager=new T5(e.rctx,2+(this._hasObjectAndLayerId?1:0))}destroy(){dt(this._objects[Ip.Hidden].length===0&&this._objects[Ip.Visible].length===0,"ObjectCollection should be empty upon disposal"),this._componentBufferManager.destroy()}createObject(e){const t=new _g;return t.toMapSpace=e.toMapSpace,t.transform=e.transform,t.obb=v2(e.obb),t.components=new $J(this._componentBufferManager,e.geometry.componentOffsets),t.renderable=this._createRenderable(e,t.components),t.intersectionGeometry=new BJ(e.geometry.positionData,t.components),this._objects[t.visible].push(t),t}destroyObject(e){const t=e;this._objects[t.visible].removeUnordered(t),t.destroy(),this._notifyDirty()}setObjectVisibility(e,t){const r=e;t!==r.visible&&(this._objects[r.visible].removeUnordered(r),this._objects[t].push(r),r.visible=t,this._notifyDirty())}preSubmit(e){const t=e.camera.eye;this.visibleObjects.forAll(r=>r.renderable.meta.cameraDepthSquared=ol(t,r.obb.center))}getMaterial(e){return e.renderable.material}updateMaterial(e,t){const r=e.renderable.material;t(r),r.dirty&&this._notifyDirty()}setAllComponentVisibilities(e,t){const r=e;r.components.visibility.reset(t),r.components.visibilityDirty(),this._notifyDirty()}forEachVisibleComponent(e,t){return e.components.visibility.forEachComponent(t)}getComponentCount(e){const t=e,r=t.components.visibility.componentCount();return{visible:r,invisible:t.components.count-r}}setComponentData(e,t){const r=e,s=r.renderable.material,a=r.components,n=a.materialDataBuffer,o=a.materialDataIndices,l=new ree,c=n.textureBuffer,h=new Uint8Array(4),u=new Uint32Array(h.buffer);let p=0,m=0,f=0,y=a.verticalOffsets,b=1/0,x=-1/0,S=!1,C=!1,O=0;for(let R=0;R<a.count;R++){t(R,l),p+=+(l.externalColor[3]<1),m+=+(l.externalColorMixMode===fy.Replace&&l.externalColor[3]===1),f+=+l.castShadows,nM(l.externalColor,l.externalColorMixMode,h),h[2]=254&h[2]|+l.castShadows,c.setData(o[R],0,h[0],h[1],h[2],h[3]),S||(S=R>0&&O!==u[0]),O=u[0],C||(C=l.elevationOffset!==0),C&&P(y)&&(y=new Array(R).fill(0)),g(y)&&(y[R]=l.elevationOffset),b=Math.min(b,l.elevationOffset),x=Math.max(x,l.elevationOffset),y5(l.elevationOffset,h),c.setData(o[R],1,h[0],h[1],h[2],h[3]);const E=l.objectAndLayerIdColor;g(E)&&c.setData(o[R],2,E[0],E[1],E[2],E[3]),l.pickable!==g5(a.pickability,R)&&(a.pickability=FJ(a.pickability,a.count,R,l.pickable))}a.verticalOffsets=C?y:null,r.offsetObb=C?H6(r.obb,b,x,this._viewingMode,g(r.offsetObb)?r.offsetObb:v2(r.obb)):null,S||C||this._hasObjectAndLayerId?(s.componentParameters=new yg,s.componentParameters.castShadows=lx(f,a.count),s.componentParameters.transparent=lx(p,a.count),s.componentParameters.opaqueOverride=lx(m,a.count),s.componentParameters.texture=c,c.updateTexture()):(s.componentParameters=new Ug,s.componentParameters.castShadows=l.castShadows?wr.All:wr.None,s.componentParameters.externalColor=l.externalColor,s.componentParameters.externalColorMixMode=l.externalColorMixMode),this._notifyDirty()}getComponentAabb(e,t,r,s=!1){e.intersectionGeometry.getComponentAabb(t,r);const a=e,n=a.components.verticalOffsets;if(s||P(n))return r;const o=n[t];if(this._viewingMode===ve.Local||o===0)return r[2]+=o,r[5]+=o,r;const l=Si(YF(o));return l.localOrigin=a.transform.position,l.applyToAabb(r)}getComponentObb(e){return e.obb}getObjectTransform(e){return e.transform}getComponentPositions(e,t,r){return e.intersectionGeometry.getComponentPositions(t,r)}intersect(e,t,r,s,a,n){const o=e;g(a)&&(a.localOrigin=o.transform.position);const l=Jp(XE,o.transform.rotationScale);Xr(w0,t,o.transform.position),Xr(T0,r,o.transform.position),el(w0,w0,l),el(T0,T0,l);const c=ic(XE,l);return o.intersectionGeometry.intersect(w0,T0,s,c,a,o.components.verticalOffsets,n)}addEdges(e,t,r,s){const a=e,{indices:n,positions:o}=a.intersectionGeometry,l=a.components.offsets;return t.addComponentObject(e,a.transform,{center:a.obb.center,radius:k6(a.obb)},o,n,l,r,s)}async extractEdgeInformation(e,t,r){const s=e,a=s.components.visibility;if(a.allInvisible())return{buffer:f6.createBuffer(0),origin:[0,0,0]};const{indices:n,positions:o}=s.intersectionGeometry,l=s.components.offsets,c=Mx.createBuffer(o.count);pM(c.position,o),vy(c.position,c.position,s.transform.rotationScale),this._setComponentIndices(c.componentIndex,n,l);const h=c.count,u=this._computeVisibilityIndices(n,a,l,h);return{origin:aa(s.transform.position),buffer:await t.extractComponentsEdgeLocations({indices:u,indicesLength:u.length,skipDeduplicate:!0,data:c,writerSettings:{reducedPrecision:!1,variants:0}},r)}}_setComponentIndices(e,t,r){let s=0;for(let a=0;a<r.length-1;a++){const n=r[a],o=r[a+1];for(let l=n;l<o;l++){const c=t?t[l]:l;e.set(c,s)}s++}}_computeVisibilityIndices(e,t,r,s){if(e&&t.allVisible())return e;let a=0;t.forEachComponentRange((l,c)=>(a+=r[c]-r[l],!0));const n=Array.isArray(e)?new Array(a):(e==null?void 0:e.BYTES_PER_ELEMENT)===2||s<=65536?new Uint16Array(a):new Uint32Array(a);let o=0;return t.forEachComponentRange((l,c)=>{const h=r[l],u=r[c];for(let p=h;p<u;p++)n[o++]=e?e[p]:p;return!0}),n}addComponentHighlight(e,t){const r=e.components;P(r.highlightCounts)&&(r.highlightCounts=new Uint32Array(r.count+1)),r.highlightCounts[t]++===0&&(r.highlightsDirty(),this._notifyDirty()),r.highlightCounts[r.count]++}removeComponentHighlight(e,t){const r=e.components;if(P(r.highlightCounts))return void WE.warn("Removing non-existing highlight.");const s=r.highlightCounts[t],a=r.highlightCounts[r.count];if(s!==0){if(s>1)return r.highlightCounts[t]=s-1,void(r.highlightCounts[r.count]=a-1);r.highlightCounts[t]=0,r.highlightsDirty(),this._notifyDirty(),a===1?r.highlightCounts=null:r.highlightCounts[r.count]=a-1}else WE.warn("Removing non-existing highlight.")}clearHighlights(e){const t=e.components;g(t.highlightCounts)&&(t.highlightCounts=null,t.highlightsDirty(),this._notifyDirty())}getObjectGPUMemoryUsage(e){return e.renderable.meta.gpuMemoryEstimate}get visibleObjects(){return this._objects[Ip.Visible]}_createRenderable(e,t){const r=this._renderManager.rctx,s=e.geometry,a=s.vertices.layoutParameters,n=gs.createVertex(r,ca.STATIC_DRAW,s.vertices.data),o=th(s.indices,y=>gs.createIndex(r,ca.STATIC_DRAW,y)),l=Co(iee(a)),c=new Uint16Array(s.vertices.count);for(let y=0;y<t.count;y++){const b=t.offsets[y],x=t.offsets[y+1],S=t.materialDataIndices[y];if(g(s.indices))for(let C=b;C<x;C++)c[s.indices[C]]=S;else for(let C=b;C<x;C++)c[C]=S}const h=gs.createVertex(r,ca.STATIC_DRAW,c.buffer),u=new Or(e.transform,e.toMapSpace),p=new l6(r,x5,{data:l,componentIndices:vee},{data:n,componentIndices:h},Si(o)),m=new qJ(p,Ut.TRIANGLES,a,g(o)),f={cameraDepthSquared:.5,gpuMemoryEstimate:n.byteSize+h.byteSize+(g(o)?o.byteSize:0)};return new jJ(u,m,f)}_notifyDirty(){this._renderManager.notifyDirty()}}const vee=Co(mr().u16(w.COMPONENTINDEX));function lx(i,e){return i===e?wr.All:i===0?wr.None:wr.Some}const XE=d3(),w0=T(),T0=T();let C5=class extends Gi{constructor(){super(...arguments),this.opacity=1}};function bee(i){const e=new $t;return e.include(sc),e.fragment.uniforms.add(new lt("tex",t=>t.texture)),i.hasOpacityFactor&&e.fragment.uniforms.add(new ue("opacity",t=>t.opacity)),e.fragment.code.add(_`
    void main() {
      gl_FragColor = texture2D(tex, uv) ${i.hasOpacityFactor?"* opacity":""};
    }`),e}const xee=Object.freeze(Object.defineProperty({__proto__:null,CompositingPassParameters:C5,build:bee},Symbol.toStringTag,{value:"Module"}));var us;(function(i){i[i.None=0]="None",i[i.Alpha=1]="Alpha",i[i.PremultipliedAlpha=2]="PremultipliedAlpha",i[i.COUNT=3]="COUNT"})(us||(us={}));let Zw=class extends ua{constructor(){super(...arguments),this.alphaMode=us.None,this.hasOpacityFactor=!1}};d([D({count:us.COUNT})],Zw.prototype,"alphaMode",void 0),d([D()],Zw.prototype,"hasOpacityFactor",void 0);let S5=class P5 extends Mt{initializeProgram(e){return new Rt(e.rctx,P5.shader.get().build(this.configuration),Lt)}initializePipeline(){switch(this.configuration.alphaMode){case us.None:return qe({colorWrite:at});case us.Alpha:return qe({blending:Ar(ae.SRC_ALPHA,ae.ONE,ae.ONE_MINUS_SRC_ALPHA,ae.ONE_MINUS_SRC_ALPHA),colorWrite:at});case us.PremultipliedAlpha:case us.COUNT:return qe({blending:oc(ae.ONE,ae.ONE_MINUS_SRC_ALPHA),colorWrite:at})}}};S5.shader=new Dt(xee,()=>_e(()=>import("./Compositing.glsl-0b633bad.js"),["assets/Compositing.glsl-0b633bad.js","assets/OrderIndependentTransparency-5f7257d7.js","assets/enums-e2e92c86.js","assets/basicInterfaces-7449a8bf.js","assets/VertexAttribute-15d1866a.js","assets/objectResourceUtils-782953c3.js","assets/devEnvironmentUtils-5002a058.js","assets/calcite-8912bd40.js","assets/index-00759e4a.js","assets/index-5026a37a.css","assets/calcite-96fa36fd.css","assets/mat3f64-50f3b9f6.js","assets/mat4f64-abdda1bb.js","assets/BufferView-379a78a4.js","assets/vec33-69c9e93b.js","assets/DefaultMaterial_COLOR_GAMMA-6ed76d86.js","assets/types-e1c0a5bf.js","assets/Version-aa0a1d91.js","assets/quat-7b70e9a8.js","assets/quatf64-f8f1c132.js","assets/resourceUtils-527631ac.js","assets/Indices-d8bff7b2.js","assets/NestedMap-1b5db22e.js","assets/requestImageUtils-d1ba3b36.js","assets/symbolColorUtils-c9d24716.js","assets/Util-6d3f024a.js","assets/sphere-d0e5285d.js","assets/doublePrecisionUtils-e3c3d0d8.js","assets/Texture-563cf5e5.js","assets/FramebufferObject-8b18fc0c.js","assets/VertexElementDescriptor-2925c6af.js","assets/InterleavedLayout-d57c91d0.js","assets/vec3f32-01c06d8d.js","assets/plane-5e2b046c.js","assets/spatialReferenceEllipsoidUtils-afb35af9.js","assets/scaleUtils-d13015f2.js","assets/ElevationSamplerData-e3118b17.js","assets/Octree-499541ed.js","assets/edgeProcessing-20e12367.js","assets/deduplicate-769a6f51.js","assets/MeshComponent-788e605a.js","assets/earcut-61f7b102.js","assets/imageUtils-c2d0d1ae.js","assets/projection-5969b753.js","assets/ZoomMomentumEstimator-ef57e6a4.js","assets/floatRGBA-ca2b39ca.js","assets/dehydratedFeatures-3a140d03.js","assets/quantizationUtils-b3b2ae2a.js","assets/labelFormatUtils-71e1f841.js","assets/orientedBoundingBox-a14b97b5.js","assets/quatf32-51a323b8.js","assets/SnappingCandidate-970faec6.js","assets/callExpressionWithFeature-df1a8f01.js","assets/DefaultVertexAttributeLayouts-5f20d8dd.js","assets/geometryServiceUtils-a536bb19.js","assets/project-909a4219.js","assets/LercDecoder-65586d50.js","assets/VectorTile-d41a1f0f.js","assets/enums-fb086c25.js","assets/config-1337d16e.js","assets/TiledDisplayObject-419c008b.js","assets/DisplayObject-87c37b69.js","assets/rasterUtils-7694cc98.js","assets/resources-7587d8f4.js","assets/workerHelper-6131d203.js","assets/webgl-debug-7f880832.js","assets/RenderingContext-0f21aa0e.js","assets/ProgramCache-f29c900e.js","assets/Program-77209250.js","assets/MediaLayer-4c42fc2f.js","assets/MediaElementView-06baa4d4.js","assets/normalizeUtilsSync-3ea564a9.js","assets/resourceExtension-f31d9f10.js","assets/BoundsStore-00da37da.js","assets/PooledRBush-5a11bc7e.js","assets/prism-line-numbers-eff41b13.js","assets/label2-a2f37e65.js","assets/interactive-1de2e238.js","assets/loadable-6afd516d.js","assets/t9n-81df3a71.js","assets/observers-c89705b8.js","assets/icon-8e47fbec.js","assets/loader-c773e800.js","assets/guid-51402ee7.js","assets/prism-line-numbers-7c5d72ff.css"]));let O5=class extends Gi{};function wee(){const i=new $t;return i.include(sc),i.fragment.uniforms.add(new lt("tex",e=>e.texture)),i.fragment.code.add(_`void main() {
gl_FragColor = vec4(1.0 - texture2D(tex, uv).a);
}`),i}const Tee=Object.freeze(Object.defineProperty({__proto__:null,HUDCompositingPassParameters:O5,build:wee},Symbol.toStringTag,{value:"Module"}));let R5=class E5 extends Mt{initializeProgram(e){return new Rt(e.rctx,E5.shader.get().build(),Lt)}initializePipeline(){return qe({colorWrite:{r:!1,g:!0,b:!1,a:!1}})}};R5.shader=new Dt(Tee,()=>_e(()=>import("./HUDCompositing.glsl-7be4a9fd.js"),["assets/HUDCompositing.glsl-7be4a9fd.js","assets/OrderIndependentTransparency-5f7257d7.js","assets/enums-e2e92c86.js","assets/basicInterfaces-7449a8bf.js","assets/VertexAttribute-15d1866a.js","assets/objectResourceUtils-782953c3.js","assets/devEnvironmentUtils-5002a058.js","assets/calcite-8912bd40.js","assets/index-00759e4a.js","assets/index-5026a37a.css","assets/calcite-96fa36fd.css","assets/mat3f64-50f3b9f6.js","assets/mat4f64-abdda1bb.js","assets/BufferView-379a78a4.js","assets/vec33-69c9e93b.js","assets/DefaultMaterial_COLOR_GAMMA-6ed76d86.js","assets/types-e1c0a5bf.js","assets/Version-aa0a1d91.js","assets/quat-7b70e9a8.js","assets/quatf64-f8f1c132.js","assets/resourceUtils-527631ac.js","assets/Indices-d8bff7b2.js","assets/NestedMap-1b5db22e.js","assets/requestImageUtils-d1ba3b36.js","assets/symbolColorUtils-c9d24716.js","assets/Util-6d3f024a.js","assets/sphere-d0e5285d.js","assets/doublePrecisionUtils-e3c3d0d8.js","assets/Texture-563cf5e5.js","assets/FramebufferObject-8b18fc0c.js","assets/VertexElementDescriptor-2925c6af.js","assets/InterleavedLayout-d57c91d0.js","assets/vec3f32-01c06d8d.js","assets/plane-5e2b046c.js","assets/spatialReferenceEllipsoidUtils-afb35af9.js","assets/scaleUtils-d13015f2.js","assets/ElevationSamplerData-e3118b17.js","assets/Octree-499541ed.js","assets/edgeProcessing-20e12367.js","assets/deduplicate-769a6f51.js","assets/MeshComponent-788e605a.js","assets/earcut-61f7b102.js","assets/imageUtils-c2d0d1ae.js","assets/projection-5969b753.js","assets/ZoomMomentumEstimator-ef57e6a4.js","assets/floatRGBA-ca2b39ca.js","assets/dehydratedFeatures-3a140d03.js","assets/quantizationUtils-b3b2ae2a.js","assets/labelFormatUtils-71e1f841.js","assets/orientedBoundingBox-a14b97b5.js","assets/quatf32-51a323b8.js","assets/SnappingCandidate-970faec6.js","assets/callExpressionWithFeature-df1a8f01.js","assets/DefaultVertexAttributeLayouts-5f20d8dd.js","assets/geometryServiceUtils-a536bb19.js","assets/project-909a4219.js","assets/LercDecoder-65586d50.js","assets/VectorTile-d41a1f0f.js","assets/enums-fb086c25.js","assets/config-1337d16e.js","assets/TiledDisplayObject-419c008b.js","assets/DisplayObject-87c37b69.js","assets/rasterUtils-7694cc98.js","assets/resources-7587d8f4.js","assets/workerHelper-6131d203.js","assets/webgl-debug-7f880832.js","assets/RenderingContext-0f21aa0e.js","assets/ProgramCache-f29c900e.js","assets/Program-77209250.js","assets/MediaLayer-4c42fc2f.js","assets/MediaElementView-06baa4d4.js","assets/normalizeUtilsSync-3ea564a9.js","assets/resourceExtension-f31d9f10.js","assets/BoundsStore-00da37da.js","assets/PooledRBush-5a11bc7e.js","assets/prism-line-numbers-eff41b13.js","assets/label2-a2f37e65.js","assets/interactive-1de2e238.js","assets/loadable-6afd516d.js","assets/t9n-81df3a71.js","assets/observers-c89705b8.js","assets/icon-8e47fbec.js","assets/loader-c773e800.js","assets/guid-51402ee7.js","assets/prism-line-numbers-7c5d72ff.css"]));let A5=class extends Gi{};function Cee(){const i=new $t;return i.include(sc),i.fragment.uniforms.add([new lt("colorTexture",e=>e.colorTexture),new lt("alphaTexture",e=>e.alphaTexture),new lt("frontFaceTexture",e=>e.frontFaceTexture)]),i.fragment.code.add(_`void main() {
vec4 srcColor = texture2D(colorTexture, uv);
if(srcColor.a <= 1e-5){
discard;
}
float srcAlpha = texture2D(alphaTexture, uv).r;
vec4 frontFace = texture2D(frontFaceTexture, uv);
gl_FragColor = vec4(mix(srcColor.rgb/srcColor.a, frontFace.rgb, frontFace.a), 1.0 - srcAlpha);
}`),i}const See=Object.freeze(Object.defineProperty({__proto__:null,OITCompositingPassParameters:A5,build:Cee},Symbol.toStringTag,{value:"Module"}));let M5=class D5 extends Mt{initializeProgram(e){return new Rt(e.rctx,D5.shader.get().build(),Lt)}initializePipeline(){return qe({blending:Ar(ae.SRC_ALPHA,ae.ONE,ae.ONE_MINUS_SRC_ALPHA,ae.ONE_MINUS_SRC_ALPHA),colorWrite:at})}};M5.shader=new Dt(See,()=>_e(()=>import("./OITCompositing.glsl-995ad1b3.js"),["assets/OITCompositing.glsl-995ad1b3.js","assets/OrderIndependentTransparency-5f7257d7.js","assets/enums-e2e92c86.js","assets/basicInterfaces-7449a8bf.js","assets/VertexAttribute-15d1866a.js","assets/objectResourceUtils-782953c3.js","assets/devEnvironmentUtils-5002a058.js","assets/calcite-8912bd40.js","assets/index-00759e4a.js","assets/index-5026a37a.css","assets/calcite-96fa36fd.css","assets/mat3f64-50f3b9f6.js","assets/mat4f64-abdda1bb.js","assets/BufferView-379a78a4.js","assets/vec33-69c9e93b.js","assets/DefaultMaterial_COLOR_GAMMA-6ed76d86.js","assets/types-e1c0a5bf.js","assets/Version-aa0a1d91.js","assets/quat-7b70e9a8.js","assets/quatf64-f8f1c132.js","assets/resourceUtils-527631ac.js","assets/Indices-d8bff7b2.js","assets/NestedMap-1b5db22e.js","assets/requestImageUtils-d1ba3b36.js","assets/symbolColorUtils-c9d24716.js","assets/Util-6d3f024a.js","assets/sphere-d0e5285d.js","assets/doublePrecisionUtils-e3c3d0d8.js","assets/Texture-563cf5e5.js","assets/FramebufferObject-8b18fc0c.js","assets/VertexElementDescriptor-2925c6af.js","assets/InterleavedLayout-d57c91d0.js","assets/vec3f32-01c06d8d.js","assets/plane-5e2b046c.js","assets/spatialReferenceEllipsoidUtils-afb35af9.js","assets/scaleUtils-d13015f2.js","assets/ElevationSamplerData-e3118b17.js","assets/Octree-499541ed.js","assets/edgeProcessing-20e12367.js","assets/deduplicate-769a6f51.js","assets/MeshComponent-788e605a.js","assets/earcut-61f7b102.js","assets/imageUtils-c2d0d1ae.js","assets/projection-5969b753.js","assets/ZoomMomentumEstimator-ef57e6a4.js","assets/floatRGBA-ca2b39ca.js","assets/dehydratedFeatures-3a140d03.js","assets/quantizationUtils-b3b2ae2a.js","assets/labelFormatUtils-71e1f841.js","assets/orientedBoundingBox-a14b97b5.js","assets/quatf32-51a323b8.js","assets/SnappingCandidate-970faec6.js","assets/callExpressionWithFeature-df1a8f01.js","assets/DefaultVertexAttributeLayouts-5f20d8dd.js","assets/geometryServiceUtils-a536bb19.js","assets/project-909a4219.js","assets/LercDecoder-65586d50.js","assets/VectorTile-d41a1f0f.js","assets/enums-fb086c25.js","assets/config-1337d16e.js","assets/TiledDisplayObject-419c008b.js","assets/DisplayObject-87c37b69.js","assets/rasterUtils-7694cc98.js","assets/resources-7587d8f4.js","assets/workerHelper-6131d203.js","assets/webgl-debug-7f880832.js","assets/RenderingContext-0f21aa0e.js","assets/ProgramCache-f29c900e.js","assets/Program-77209250.js","assets/MediaLayer-4c42fc2f.js","assets/MediaElementView-06baa4d4.js","assets/normalizeUtilsSync-3ea564a9.js","assets/resourceExtension-f31d9f10.js","assets/BoundsStore-00da37da.js","assets/PooledRBush-5a11bc7e.js","assets/prism-line-numbers-eff41b13.js","assets/label2-a2f37e65.js","assets/interactive-1de2e238.js","assets/loadable-6afd516d.js","assets/t9n-81df3a71.js","assets/observers-c89705b8.js","assets/icon-8e47fbec.js","assets/loader-c773e800.js","assets/guid-51402ee7.js","assets/prism-line-numbers-7c5d72ff.css"]));let I5=class extends Gi{constructor(){super(...arguments),this.overlayIndex=oi.INNER,this.opacity=1}};function Pee(){const i=new $t;return i.include(sc),i.fragment.uniforms.add(new lt("tex",e=>e.texture)),i.fragment.uniforms.add(new FT("overlayIdx",e=>e.overlayIndex)),i.fragment.uniforms.add(new ue("opacity",e=>e.opacity)),i.fragment.code.add(_`void main() {
vec2 overlayUV = overlayIdx == 0 ? vec2(uv.x * 0.5, uv.y) : vec2(uv.x * 0.5 + 0.5, uv.y);
gl_FragColor = texture2D(tex, overlayUV) * opacity;
}`),i}const Oee=Object.freeze(Object.defineProperty({__proto__:null,OverlayCompositingPassParameters:I5,build:Pee},Symbol.toStringTag,{value:"Module"}));let L5=class $5 extends Mt{initializeProgram(e){return new Rt(e.rctx,$5.shader.get().build(),Lt)}initializePipeline(){return qe({blending:oc(ae.ONE,ae.ONE_MINUS_SRC_ALPHA),colorWrite:at})}};L5.shader=new Dt(Oee,()=>_e(()=>import("./OverlayCompositing.glsl-166077b3.js"),["assets/OverlayCompositing.glsl-166077b3.js","assets/OrderIndependentTransparency-5f7257d7.js","assets/enums-e2e92c86.js","assets/basicInterfaces-7449a8bf.js","assets/VertexAttribute-15d1866a.js","assets/objectResourceUtils-782953c3.js","assets/devEnvironmentUtils-5002a058.js","assets/calcite-8912bd40.js","assets/index-00759e4a.js","assets/index-5026a37a.css","assets/calcite-96fa36fd.css","assets/mat3f64-50f3b9f6.js","assets/mat4f64-abdda1bb.js","assets/BufferView-379a78a4.js","assets/vec33-69c9e93b.js","assets/DefaultMaterial_COLOR_GAMMA-6ed76d86.js","assets/types-e1c0a5bf.js","assets/Version-aa0a1d91.js","assets/quat-7b70e9a8.js","assets/quatf64-f8f1c132.js","assets/resourceUtils-527631ac.js","assets/Indices-d8bff7b2.js","assets/NestedMap-1b5db22e.js","assets/requestImageUtils-d1ba3b36.js","assets/symbolColorUtils-c9d24716.js","assets/Util-6d3f024a.js","assets/sphere-d0e5285d.js","assets/doublePrecisionUtils-e3c3d0d8.js","assets/Texture-563cf5e5.js","assets/FramebufferObject-8b18fc0c.js","assets/VertexElementDescriptor-2925c6af.js","assets/InterleavedLayout-d57c91d0.js","assets/vec3f32-01c06d8d.js","assets/plane-5e2b046c.js","assets/spatialReferenceEllipsoidUtils-afb35af9.js","assets/scaleUtils-d13015f2.js","assets/ElevationSamplerData-e3118b17.js","assets/Octree-499541ed.js","assets/edgeProcessing-20e12367.js","assets/deduplicate-769a6f51.js","assets/MeshComponent-788e605a.js","assets/earcut-61f7b102.js","assets/imageUtils-c2d0d1ae.js","assets/projection-5969b753.js","assets/ZoomMomentumEstimator-ef57e6a4.js","assets/floatRGBA-ca2b39ca.js","assets/dehydratedFeatures-3a140d03.js","assets/quantizationUtils-b3b2ae2a.js","assets/labelFormatUtils-71e1f841.js","assets/orientedBoundingBox-a14b97b5.js","assets/quatf32-51a323b8.js","assets/SnappingCandidate-970faec6.js","assets/callExpressionWithFeature-df1a8f01.js","assets/DefaultVertexAttributeLayouts-5f20d8dd.js","assets/geometryServiceUtils-a536bb19.js","assets/project-909a4219.js","assets/LercDecoder-65586d50.js","assets/VectorTile-d41a1f0f.js","assets/enums-fb086c25.js","assets/config-1337d16e.js","assets/TiledDisplayObject-419c008b.js","assets/DisplayObject-87c37b69.js","assets/rasterUtils-7694cc98.js","assets/resources-7587d8f4.js","assets/workerHelper-6131d203.js","assets/webgl-debug-7f880832.js","assets/RenderingContext-0f21aa0e.js","assets/ProgramCache-f29c900e.js","assets/Program-77209250.js","assets/MediaLayer-4c42fc2f.js","assets/MediaElementView-06baa4d4.js","assets/normalizeUtilsSync-3ea564a9.js","assets/resourceExtension-f31d9f10.js","assets/BoundsStore-00da37da.js","assets/PooledRBush-5a11bc7e.js","assets/prism-line-numbers-eff41b13.js","assets/label2-a2f37e65.js","assets/interactive-1de2e238.js","assets/loadable-6afd516d.js","assets/t9n-81df3a71.js","assets/observers-c89705b8.js","assets/icon-8e47fbec.js","assets/loader-c773e800.js","assets/guid-51402ee7.js","assets/prism-line-numbers-7c5d72ff.css"]));let Ree=class{constructor(e,t){this._rctx=e,this._techniqueRepository=t,this._configuration=new Zw,this._passParameters=new C5,this._oitParameters=new A5,this._hudParameters=new O5,this._overlayParameters=new I5}destroy(){this._vao=De(this._vao)}compositeOIT(e,t,r,s){this._oitParameters.colorTexture=t,this._oitParameters.alphaTexture=r,this._oitParameters.frontFaceTexture=s;const a=this._rctx,n=this._techniqueRepository.acquire(M5);a.bindTechnique(n,this._oitParameters,e);const o=this._ensureVAO();a.bindVAO(o),a.drawArrays(Ut.TRIANGLE_STRIP,0,Os(o,"geometry")),n.release()}compositeHUD(e,t){this._hudParameters.texture=t;const r=this._rctx,s=this._techniqueRepository.acquire(R5);r.bindTechnique(s,this._hudParameters,e);const a=this._ensureVAO();r.bindVAO(a),r.drawArrays(Ut.TRIANGLE_STRIP,0,Os(a,"geometry")),s.release()}compositeOverlay(e,t,r,s){this._overlayParameters.texture=t,this._overlayParameters.opacity=r,this._overlayParameters.overlayIndex=s;const a=this._rctx,n=this._techniqueRepository.acquire(L5);a.bindTechnique(n,this._overlayParameters,e);const o=this._ensureVAO();a.bindVAO(o),a.drawArrays(Ut.TRIANGLE_STRIP,0,Os(o,"geometry")),n.release()}composite(e,t,r=us.None,s=1){const a=this._rctx;this._configuration.alphaMode=r,this._configuration.hasOpacityFactor=s!==1,this._passParameters.texture=t,this._passParameters.opacity=s;const n=this._techniqueRepository.acquire(S5,this._configuration);a.bindTechnique(n,this._passParameters,e);const o=this._ensureVAO();a.bindVAO(o),a.drawArrays(Ut.TRIANGLE_STRIP,0,Os(o,"geometry")),n.release()}_ensureVAO(){return P(this._vao)&&(this._vao=pa(this._rctx)),this._vao}};const Eee=1e4,Yw=100,Aee=500,Mee=500,Dee=.1;function Iee(i,e,t){return N6(e,i)*(t[1]-t[0])+t[0]}function Lee(i,e,t){let r=0;if(!e.some(a=>(r+=a.numGeometries,r>=Eee)))return Bee.compute(i,e);const s=Yf();return t.forAll(a=>{a.visible&&Yp(s,$ee(i,a))}),s}function $ee(i,e){if(!e.visible)return;const t=Yf(),r=e.getSpatialQueryAccelerator();return g(r)?Nee(t,i,r):Fee(t,i,e.objects),t}function Nee(i,e,t){const r=e.eye,s=e.viewForward,a=e.frustum,n=l=>l.visible,o=t.objectCount;if(o<Aee)Df(xn,e.near,Math.min(i.near,e.far)),t.forEachInDepthRange(r,s,ho.DepthOrder.FRONT_TO_BACK,xn,(l,c)=>{Kw(i,e,l),xn.far=i.near,c.setRange(xn)},a,n),Df(xn,Math.max(i.far,e.near),e.far),t.forEachInDepthRange(r,s,ho.DepthOrder.BACK_TO_FRONT,xn,(l,c)=>{Kw(i,e,l),xn.near=i.far,c.setRange(xn)},a,n);else{const l=Math.max(Math.min(o,Mee),Math.ceil(o*Dee)),c=t.findClosest(s,ho.DepthOrder.FRONT_TO_BACK,a,n,l),h=t.findClosest(s,ho.DepthOrder.BACK_TO_FRONT,a,n,l);c&&h&&(QE(i,e,c.boundingVolumeWorldSpace.bounds),QE(i,e,h.boundingVolumeWorldSpace.bounds))}}function Fee(i,e,t){Qu.clear(),t.forAll(r=>{r.visible&&r.geometries.length!==0&&Qu.add(r)}),Qu.empty||(Qu.sort(e),Df(xn,e.near,Math.min(i.near,e.far)),Qu.forEachInDepthRange(xn,ho.DepthOrder.FRONT_TO_BACK,(r,s)=>{s<i.near&&Kw(i,e,r)}),Df(xn,Math.max(i.far,e.near),e.far),Qu.forEachInDepthRange(xn,ho.DepthOrder.BACK_TO_FRONT,(r,s,a)=>{i.far=Math.max(i.far,a)}))}function Kw(i,e,t){if(!t.visible||!xv(e.frustum,t.boundingVolumeWorldSpace.bounds))return;const r=t.transformation,s=Gee;t.geometries.forEach(a=>{pr(s,r,a.shaderTransformation);const n=Dd(s);N5(i,e,a.boundingInfo,s,n)})}function N5(i,e,t,r,s){if(P(t))return;xe(qr,t.center,r);const{eye:a,viewForward:n}=e,o=n[0]*(qr[0]-a[0])+n[1]*(qr[1]-a[1])+n[2]*(qr[2]-a[2]);if(qr[3]=t.radius*s,!(o-qr[3]>i.near&&o+qr[3]<i.far)&&xv(e.frustum,qr))if(t.radius>Yw&&t.getChildren())for(const l of t.getChildren())N5(i,e,l,r,s);else Jw.unionDepthRangeWithAABB(i,e.viewProjectionMatrix,r,t.bbMin,t.bbMax)}function QE(i,e,t){const r=e.eye,s=e.viewForward,a=(t[0]-r[0])*s[0]+(t[1]-r[1])*s[1]+(t[2]-r[2])*s[2];i.near=Math.min(i.near,a-t[3]),i.far=Math.max(i.far,a+t[3])}class zee{constructor(){this._items=new At({allocator:e=>e||{obj:null,distance:0,near:0,far:0},deallocator:e=>(e.obj=null,e.distance=0,e.near=0,e.far=0,e)})}get length(){return this._items.length}get empty(){return this._items.length===0}clear(){this._items.clear()}add(e){this._items.pushNew().obj=e}sort(e){const t=e.eye,r=e.viewForward;this._items.forAll(s=>{const a=s.obj.boundingVolumeWorldSpace.bounds,n=(a[0]-t[0])*r[0]+(a[1]-t[1])*r[1]+(a[2]-t[2])*r[2];s.distance=n,s.near=n-a[3],s.far=n+a[3]}),this._items.sort((s,a)=>s.distance-a.distance)}forEachInDepthRange(e,t,r){if(t===ho.DepthOrder.FRONT_TO_BACK)for(let s=0;s<this._items.length;++s){const a=this._items.data[s];a.far<e.near||a.near>e.far||r(a.obj,a.near,a.far)}else for(let s=this._items.length-1;s>=0;--s){const a=this._items.data[s];a.far<e.near||a.near>e.far||r(a.obj,a.near,a.far)}}}let Uee=class{constructor(){this._view=ce(),this._viewProj=ce(),this._frustum=tf(),this._geometries=new Array,this._near=[],this._far=[],this._nearCandidates=[],this._farCandidates=[],this._looseRange={near:0,far:0}}compute(e,t){this._reset(),Kr(this._view,e.viewMatrix),pr(this._viewProj,e.projectionMatrix,this._view),gy(this._frustum,e.frustum);const r=this._view,s=r[2],a=r[6],n=r[10],o=r[14];t.forAll(p=>p.forEachGeometry(m=>{if(!m.visible||!m.castShadow)return;let f;m.hasShaderTransformation?(m.computeBoundingSphere(m.shaderTransformation,qr,1),f=qr):f=m.boundingSphere;const y=s*f[0]+a*f[1]+n*f[2]+o,b=y-f[3],x=y+f[3];this._geometries.push(m),this._near.push(-x),this._far.push(-b)}));const l=new WJ;if(this._geometries.length===0)return l;for(let p=0;p<this._geometries.length;++p)this._near[p]>l.far&&(l.far=this._near[p]),this._near[p]>2&&this._far[p]<l.near&&(l.near=this._far[p]);const c=this._looseRange;c.near=Math.max(.5*l.near,2),c.far=2*l.far;let h=0,u=0;for(let p=0;p<this._geometries.length;++p)this._near[p]<l.near&&(this._near[p]>=c.near?l.near=this._near[p]:this._nearCandidates[h++]=p),this._far[p]>l.far&&(this._far[p]<=c.far?l.far=this._far[p]:this._farCandidates[u++]=p);if(this._nearCandidates.length===0&&this._farCandidates.length===0)return l;this._nearCandidates.sort((p,m)=>this._near[p]<this._near[m]?-1:this._near[p]>this._near[m]?1:0),this._farCandidates.sort((p,m)=>this._far[p]<this._far[m]?1:this._far[p]>this._far[m]?-1:0);for(let p=0;p<this._nearCandidates.length;++p){const m=this._nearCandidates[p];if(this._near[m]<l.near){const f=this._geometries[m],y=f.boundingInfo;this._includeNearBoundingInfoRec(y,f.shaderTransformation,l)}}for(let p=0;p<this._farCandidates.length;++p){const m=this._farCandidates[p];if(this._far[m]>l.far){const f=this._geometries[m],y=f.boundingInfo;this._includeFarBoundingInfoRec(y,f.shaderTransformation,l)}}return this._reset(),l}_reset(){this._geometries.length=0,this._near.length=0,this._far.length=0,this._nearCandidates.length=0,this._farCandidates.length=0}_includeNearBoundingInfoRec(e,t,r){if(P(e))return;const s=e.center;xe(qr,s,t);const a=Dd(t),n=qr[0],o=qr[1],l=qr[2],c=e.radius*a,h=this._frustum;if(h[0][0]*n+h[0][1]*o+h[0][2]*l+h[0][3]>c||h[1][0]*n+h[1][1]*o+h[1][2]*l+h[1][3]>c||h[2][0]*n+h[2][1]*o+h[2][2]*l+h[2][3]>c||h[3][0]*n+h[3][1]*o+h[3][2]*l+h[3][3]>c)return;const u=this._view[2]*n+this._view[6]*o+this._view[10]*l+this._view[14],p=u+c;if(!(-(u-c)<2||-p>=r.near))if(-p>this._looseRange.near)r.near=-p;else{if(c>Yw){const m=e.getChildren();if(m!==void 0){for(const f of m)this._includeNearBoundingInfoRec(f,t,r);return}}Jw.unionDepthRangeWithAABB(r,this._viewProj,t,e.bbMin,e.bbMax)}}_includeFarBoundingInfoRec(e,t,r){if(P(e))return;let s=e.radius;const a=e.center;xe(qr,a,t);const n=Dd(t),o=qr[0],l=qr[1],c=qr[2];s*=n;const h=this._frustum;if(h[0][0]*o+h[0][1]*l+h[0][2]*c+h[0][3]>s||h[1][0]*o+h[1][1]*l+h[1][2]*c+h[1][3]>s||h[2][0]*o+h[2][1]*l+h[2][2]*c+h[2][3]>s||h[3][0]*o+h[3][1]*l+h[3][2]*c+h[3][3]>s)return;const u=this._view[2]*o+this._view[6]*l+this._view[10]*c+this._view[14]-s;if(!(-u<=r.far))if(-u<this._looseRange.far)r.far=-u;else{if(s>Yw){const p=e.getChildren();if(p!==void 0){for(const m of p)this._includeFarBoundingInfoRec(m,t,r);return}}Jw.unionDepthRangeWithAABB(r,this._viewProj,t,e.bbMin,e.bbMax)}}},Vee=class{constructor(){this._modelViewProj=ce(),this._clipPosition=[Pt(),Pt(),Pt(),Pt(),Pt(),Pt(),Pt(),Pt()]}unionDepthRangeWithAABB(e,t,r,s,a){const n=this._modelViewProj;pr(n,t,r);let o=!1;for(let l=0;l<8;++l){const c=this._clipPosition[l],h=l===0||l===3||l===4||l===7?s[0]:a[0],u=l===0||l===1||l===4||l===5?s[1]:a[1],p=l<4?s[2]:a[2];c[0]=n[0]*h+n[4]*u+n[8]*p+n[12],c[1]=n[1]*h+n[5]*u+n[9]*p+n[13],c[2]=n[2]*h+n[6]*u+n[10]*p+n[14],c[3]=n[3]*h+n[7]*u+n[11]*p+n[15]}for(let l=0;l<12;++l){const c=this._clipPosition[cx[l][0]],h=this._clipPosition[cx[l][1]],u=this._clipPosition[cx[l][2]],p=this._clipTriangle(c,h,u);let m=!0;for(let f=0;f<p.length;++f)if(p[f][3]>=2){m=!1;break}if(!m){o=!0;for(let f=0;f<p.length;++f){const y=p[f][3];Number.isFinite(y)&&(e.near=Math.min(y,e.near),e.far=Math.max(y,e.far))}}}return o}_inside(e,t){return t===0?e[0]>=-e[3]:t===1?e[1]>=-e[3]:t===2?e[0]<=e[3]:t===3?e[1]<=e[3]:void dt(!1)}_intersect(e,t,r){let s=0;return r===0?s=(-e[3]-e[0])/(t[0]-e[0]+t[3]-e[3]):r===1?s=(-e[3]-e[1])/(t[1]-e[1]+t[3]-e[3]):r===2?s=(e[3]-e[0])/(t[0]-e[0]-t[3]+e[3]):r===3&&(s=(e[3]-e[1])/(t[1]-e[1]-t[3]+e[3])),u9(Pt(),e,t,s)}_clipTriangle(e,t,r){let s=[e,t,r];for(let a=0;a<4;++a){const n=s;s=[];for(let o=0;o<n.length;++o){const l=n[o],c=n[(o+1)%n.length];this._inside(c,a)?(this._inside(l,a)||s.push(this._intersect(l,c,a)),s.push(c)):this._inside(l,a)&&s.push(this._intersect(l,c,a))}}return s}};const cx=[[0,1,3],[2,3,1],[1,5,2],[6,2,5],[5,4,6],[7,6,4],[4,0,7],[3,7,0],[3,2,7],[6,7,2],[4,5,0],[1,0,5]],qr=Nn(),Gee=ce(),xn=Yf(),Qu=new zee,Bee=new Uee,Jw=new Vee;let Hee=class{},kee=class extends Gi{constructor(){super(...arguments),this.textures=new Hee}};function jee(){const i=new $t;return i.attributes.add(w.POSITION,"vec2"),i.vertex.uniforms.add(new ai("drawPosition",(e,t)=>qee(e,t))),i.varyings.add("vUV","vec2"),i.vertex.code.add(_`void main(void) {
vUV = position;
gl_Position = vec4(drawPosition.xy + vec2(position - 0.5) * drawPosition.zw, 0.0, 1.0);
}`),i.fragment.uniforms.add(new lt("textureInput",e=>e.textures.input)),i.fragment.uniforms.add(new lt("textureMask",e=>e.textures.mask)),i.fragment.uniforms.add(new lt("textureOverlay",e=>e.textures.overlay)),i.fragment.uniforms.add(new ih("maskEnabled",e=>e.magnifier.maskEnabled)),i.fragment.uniforms.add(new ih("overlayEnabled",e=>e.magnifier.overlayEnabled)),i.fragment.code.add(_`const float barrelFactor = 1.1;
vec2 barrel(vec2 uv) {
vec2 uvn = uv * 2.0 - 1.0;
if (uvn.x == 0.0 && uvn.y == 0.0) {
return vec2(0.5, 0.5);
}
float theta = atan(uvn.y, uvn.x);
float r = pow(length(uvn), barrelFactor);
return r * vec2(cos(theta), sin(theta)) * 0.5 + 0.5;
}
void main() {
float mask = maskEnabled ? texture2D(textureMask, vUV).a : 1.0;
vec4 inputColor = texture2D(textureInput, barrel(vUV)) * mask;
vec4 overlayColor = overlayEnabled ? texture2D(textureOverlay, vUV) : vec4(0);
gl_FragColor = overlayColor + (1.0 - overlayColor.a) * inputColor;
}`),i}function qee(i,e){const t=e.camera.pixelRatio,r=i.magnifier.offset.x*t,s=i.magnifier.offset.y*t;Zo(i.magnifier.position,ZE);const a=e.camera.screenToRender(ZE,Wee),n=Math.ceil(t*i.magnifier.size),o=e.camera.fullWidth,l=e.camera.fullHeight;return Br(Xee,(a[0]+r)/o*2-1,(a[1]-s)/l*2-1,n/o*2,n/l*2)}const ZE=Pi(),Wee=u3(),Xee=Pt();let cp=class extends Ie{constructor(){super(...arguments),this._handles=new Vi,this._magnifier=null,this._imageSources=null,this._imageLoadTask=null,this._resources=null,this._passParameters=new kee,this.events=new Ms,this.attributeLocations=new Map([[w.POSITION,0]]),this._tmpScreenPoint=Pi(),this._tmpRenderPoint=u3()}get updating(){return P(this._imageSources)&&g(this._imageLoadTask)&&!this._imageLoadTask.task.finished}get magnifier(){return this._magnifier}set magnifier(e){if(e===this._magnifier)return;this._handles.removeAll(),this._magnifier=e;const t=()=>{this._updateResourceLoading(),this.events.emit("request-render")};g(this._magnifier)&&this._handles.add(te(()=>th(this._magnifier,r=>r.version),t)),t()}get enabled(){return g(this._validMagnifier)}get _validMagnifier(){return g(this._magnifier)&&this._magnifier.visible&&g(this._magnifier.position)&&this._magnifier.size>0?this._magnifier:null}get _factor(){return g(this._magnifier)&&this._magnifier.factor||1}destroy(){this._magnifier=null,this._handles.destroy(),g(this._imageLoadTask)&&(this._imageLoadTask.task.abort(),this._imageLoadTask=null),this._disposeResources()}render(e,t){const r=this._validMagnifier;if(P(r))return;const s=t.camera.pixelRatio,a=Math.ceil(s*r.size);if(this._updateResources(e,a),P(this._resources))return;const n=this._passParameters.textures,o=Math.ceil(1/this._factor*a);n.input.resize(o,o),Zo(r.position,this._tmpScreenPoint);const l=t.camera.screenToRender(this._tmpScreenPoint,this._tmpRenderPoint),c=t.camera.fullWidth,h=t.camera.fullHeight,u=.5*o,p=.5*o;l[0]=ee(l[0],u,c-u-1),l[1]=ee(l[1],p,h-p-1);const m=Math.floor(l[0]-u),f=Math.floor(l[1]-p),y=this._resources.program;y.bindTexture("textureInput",n.input),e.gl.copyTexImage2D(n.input.descriptor.target,0,n.input.descriptor.pixelFormat,m,f,o,o,0),this._passParameters.magnifier=r,e.useProgram(y),y.bindPass(this._passParameters,t),e.bindVAO(this._resources.vao),e.setPipelineState(this._resources.pipelineState),e.drawArrays(Ut.TRIANGLE_STRIP,0,4)}_updateResourceLoading(){const e=this._validMagnifier;if(P(e))return;const t=e.maskUrl,r=e.overlayUrl;!g(this._imageLoadTask)||this._imageLoadTask.maskUrl===t&&this._imageLoadTask.overlayUrl===r||(this._imageLoadTask.task.abort(),this._imageLoadTask=null,this._imageSources=null),g(this._imageSources)||g(this._imageLoadTask)||(this._imageLoadTask={maskUrl:t,overlayUrl:r,task:rT(async s=>{const a=P(t)||P(r)?l8(s):null,n=g(t)?cf(t,{signal:s}):a.then(l=>l.mask),o=g(r)?cf(r,{signal:s}):a.then(l=>l.overlay);this._imageSources={mask:await n,overlay:await o},this._disposeResources(),this.events.emit("request-render")})},this._imageLoadTask.task.promise.then(()=>this.notifyChange("updating"),()=>this.notifyChange("updating")))}_updateResources(e,t){if(!this.enabled)return void this._disposeResources();if(g(this._resources)){if(this._passParameters.textures.size!==t){const s=this._createTextureResources(e,t);if(P(s))return void this._disposeResources();this._disposeTextureResources(this._passParameters.textures),this._passParameters.textures=s}return}const r=this._createTextureResources(e,t);P(r)||(this._resources={program:this._createProgram(e),vao:pa(e,KF,this.attributeLocations,0,1),pipelineState:qe({blending:oc(ae.ONE,ae.ONE_MINUS_SRC_ALPHA),depthTest:null,depthWrite:null,colorWrite:at})},this._passParameters.textures=r)}_disposeResources(){P(this._resources)||(this._disposeTextureResources(this._passParameters.textures),this._resources.program.dispose(),this._resources.vao.dispose(),this._resources=null)}_disposeTextureResources(e){e.mask.dispose(),e.overlay.dispose(),e.input.dispose()}_createTextureResources(e,t){if(P(this._imageSources))return null;this._imageSources.overlay.width=t,this._imageSources.overlay.height=t,this._imageSources.mask.width=t,this._imageSources.mask.height=t;const r=new Ai(e,{target:tr.TEXTURE_2D,pixelFormat:St.RGBA,internalFormat:St.RGBA,dataType:Zt.UNSIGNED_BYTE,wrapMode:kt.CLAMP_TO_EDGE,samplingMode:Qt.LINEAR,flipped:!0,preMultiplyAlpha:!n3(this._imageSources.overlay.src)||!e.driverTest.svgPremultipliesAlpha.result},this._imageSources.overlay),s=new Ai(e,{target:tr.TEXTURE_2D,pixelFormat:St.ALPHA,internalFormat:St.ALPHA,dataType:Zt.UNSIGNED_BYTE,wrapMode:kt.CLAMP_TO_EDGE,samplingMode:Qt.LINEAR,flipped:!0},this._imageSources.mask);return{input:new Ai(e,{target:tr.TEXTURE_2D,pixelFormat:St.RGBA,internalFormat:St.RGBA,dataType:Zt.UNSIGNED_BYTE,wrapMode:kt.CLAMP_TO_EDGE,samplingMode:Qt.LINEAR,flipped:!1}),mask:s,overlay:r,size:t}}_createProgram(e){return new Rt(e,jee(),this.attributeLocations)}};d([v()],cp.prototype,"_imageSources",void 0),d([v()],cp.prototype,"_imageLoadTask",void 0),d([v({readOnly:!0})],cp.prototype,"updating",null),cp=d([Y("esri/views/3d/webgl-engine/lib/MagnifierHelper")],cp);let Qee=class{constructor(){this.declaredClass="esri.views.3d.webgl-engine.lib.ObjectAndLayerIdRenderHelper",this.colorZero=new fh(new ArrayBuffer(4)),this._uidToRenderColor=new Map,this._colorToUID=new Map,this._layerUidToGraphicsUidToObjectId=new Map,this._layerUidToId=new Map,this._layerUidToPopupEnabled=new Map}setUidToObjectAndLayerId(e,t,r,s,a,n=null,o=null,l=null){if(!(e&&t&&r&&s)||(this._layerUidToId.set(s,r),this._layerUidToPopupEnabled.set(s,a),!a))return;let c=this._layerUidToGraphicsUidToObjectId.get(s);c||(c=new Map,this._layerUidToGraphicsUidToObjectId.set(s,c)),c.set(t,{objectId:e,attributeNodeId:n,attributeIndex:o,subLayerId:l})}getObjectAndLayerIdColor(e){const t=this.getObjectAndLayerIdColorArray(e);return hi(t.get(0,1),t.get(0,2),t.get(0,3),255)}getObjectAndLayerIdColorArray(e){if(!e.layerUid||!e.graphicUid)return this.colorZero;const t=this._layerUidToPopupEnabled.get(e.layerUid);if(t===void 0)return Pe.getLogger(this.declaredClass).warn("popupEnabled is undefined for layerUid "+e.layerUid),this.colorZero;if(t===!1)return this.colorZero;let r=this._uidToRenderColor.get(e.layerUid);r||(r=new Map,this._uidToRenderColor.set(e.layerUid,r));let s=r.get(e.graphicUid);if(!s){for(;!s;){const n=Math.floor(16777214*Math.random())+1;this._colorToUID.has(n)||(s=n)}if(s>16777215)throw new Error("Object ID Overflow");r.set(e.graphicUid,s),this._colorToUID.set(s,e)}const a=new ArrayBuffer(4);return new DataView(a).setUint32(0,s,!1),new fh(a)}getColorToObjectAndLayerIdMapping(){const e=new Map;for(const[t,r]of this._colorToUID.entries()){const s=this._layerUidToGraphicsUidToObjectId.get(r.layerUid);let a=null;s?(a=s.get(r.graphicUid),a||Pe.getLogger(this.declaredClass).warn("getColorMapping: no entry found for graphicsId "+r.graphicUid)):Pe.getLogger(this.declaredClass).warn("getColorMapping: no entry found for layerUid "+r.layerUid);const n=this._layerUidToId.get(r.layerUid);n||Pe.getLogger(this.declaredClass).warn("no layerId found for uid "+r.layerUid),a&&n&&e.set(t,a.attributeNodeId?{type:"object-and-layer-and-i3s-id",oid:a.objectId,lid:n,attrId:a.attributeNodeId,attrIdx:a.attributeIndex,subLayerId:a.subLayerId}:{type:"object-and-layer-id",oid:a.objectId,lid:n})}return e}};var If;(function(i){i[i.FrontToBack=0]="FrontToBack",i[i.BackToFront=1]="BackToFront"})(If||(If={}));let Lc=class{constructor(e,t,r=If.FrontToBack){this._rctx=e,this._techniqueRepository=t,this._sorting=r,this._draws=new At({initialSize:32,allocator:s=>s||{material:null,geometry:null,geometryRanges:null,bindDrawParams:null,depthSquaredHint:0,indexType:0}}),this._previouslyBoundDraw=new Map}submitDraw(e,t,r,s){const a=this._draws.pushNew();a.geometry=t,a.geometryRanges=r,a.material=e,a.depthSquaredHint=s,a.indexType=(t.indexed?Si(t.vao.indexBuffer).indexType:null)??0}dispatch(e,t){const r=this._rctx;this._previouslyBoundDraw.clear();let s=null;const a=this._draws.map(o=>o.material.prepareTechnique(this._techniqueRepository,e,t,o.geometry.parameters)),n=this._draws.length;for(let o=0;o<n;o++){const l=a[o];l===s&&l.configuration.transparencyPassType===We.NONE||(r.bindTechnique(l,e,t),s=l);const c=this._draws.data[o],h=c.geometry;r.bindVAO(h.vao),this._previouslyBoundDraw.get(l)!==c.material&&(l.program.bindDraw(c.material,t,e),this._previouslyBoundDraw.set(l,c.material));const u=c.geometryRanges,p=u.length;if(c.indexType!==0){const m=ry.get(c.indexType);for(let f=0;f<p;f+=2){const y=u[f],b=u[f+1];r.drawElements(h.primitiveType,b,c.indexType,y*m)}}else for(let m=0;m<p;m+=2){const f=u[m],y=u[m+1];r.drawArrays(h.primitiveType,f,y)}}}prepareSubmit(){this._draws.clear()}finishSubmit(){const e=this._sorting===If.FrontToBack?1:-1;this._draws.sort((t,r)=>{const s=e*(t.depthSquaredHint-r.depthSquaredHint);return s!==0?s:t.geometry.vao.size-r.geometry.vao.size})}get count(){return this._draws.length}};const ry=new Map;ry.set(Cp.UNSIGNED_BYTE,1),ry.set(Cp.UNSIGNED_SHORT,2),ry.set(Cp.UNSIGNED_INT,4);let Zee=class{constructor(e,t){this.rctx=e,this.shaderTechniqueRepository=t,this.canRender=!0,this._materialPassParameters=new vK,this._shadowPassParameters=new bK,this._highlightPassParameters=new xK,this._systems=new Set,this._passes={materialOpaque:new Lc(e,t),materialTransparent:new Lc(e,t,If.BackToFront),materialIntegratedMesh:new Lc(e,t),shadowMap:new Lc(e,t),highlight:new Lc(e,t),highlightIntegratedMesh:new Lc(e,t),highlightShadowMap:new Lc(e,t),defaultShadowMap:new Lc(e,t)}}register(e){this._systems.add(e)}prepareRender(e){if(this._systems.size!==0){for(const t of Object.values(this._passes))t.prepareSubmit();this._systems.forEach(t=>t.submit(this._passes,e.bindParameters));for(const t of Object.values(this._passes))t.finishSubmit();this.shaderTechniqueRepository.frameUpdate()}}render(e){if(this._systems.size!==0)switch(this._configure(e),this._materialPassParameters.output=e.output,e.bindParameters.slot){case K.OPAQUE_MATERIAL:switch(e.output){case A.Color:case A.Depth:case A.Normal:return this._passes.materialOpaque.dispatch(this._materialPassParameters,e.bindParameters);case A.Highlight:return this._passes.highlight.dispatch(this._highlightPassParameters,e.bindParameters);case A.Shadow:return this._passes.shadowMap.dispatch(this._shadowPassParameters,e.bindParameters);case A.ShadowHighlight:return this._passes.highlightShadowMap.dispatch(this._shadowPassParameters,e.bindParameters);case A.ShadowExcludeHighlight:return this._passes.defaultShadowMap.dispatch(this._shadowPassParameters,e.bindParameters);case A.ObjectAndLayerIdColor:return this._passes.materialOpaque.dispatch(this._materialPassParameters,e.bindParameters)}return;case K.TRANSPARENT_MATERIAL:switch(e.output){case A.Color:case A.Alpha:case A.Depth:case A.Normal:case A.ObjectAndLayerIdColor:return this._passes.materialTransparent.dispatch(this._materialPassParameters,e.bindParameters)}return;case K.INTEGRATED_MESH:switch(e.output){case A.Color:case A.Depth:case A.Normal:return this._passes.materialIntegratedMesh.dispatch(this._materialPassParameters,e.bindParameters);case A.Highlight:return this._passes.highlightIntegratedMesh.dispatch(this._highlightPassParameters,e.bindParameters);case A.ObjectAndLayerIdColor:return this._passes.materialIntegratedMesh.dispatch(this._materialPassParameters,e.bindParameters)}return}}notifyDirty(){this._context.requestRender()}slots(){return[K.OPAQUE_MATERIAL,K.TRANSPARENT_MATERIAL,K.INTEGRATED_MESH]}initializeRenderContext(e){this._context=e}uninitializeRenderContext(){}queryDepthRange(e){const t={near:1/0,far:-1/0};return this._systems.forEach(r=>{const s=r.queryShadowCasterDepthRange(e);g(s)&&Yp(t,s,t)}),t}_configure(e){const t=e.output===A.Shadow||e.output===A.ShadowHighlight||e.output===A.ShadowExcludeHighlight?this._shadowPassParameters:e.output===A.Highlight?this._highlightPassParameters:this._materialPassParameters;this._updateParameters(e,t)}_updateParameters(e,t){const r=e.bindParameters.camera,s=r.viewInverseTransposeMatrix;j(hx,s[3],s[7],s[11]),dx.set(hx),H(t.transformWorldFromViewTH,dx.high),H(t.transformWorldFromViewTL,dx.low),H(t.slicePlaneLocalOrigin,hx),Xl(t.transformViewFromCameraRelativeRS,r.viewMatrix),Kr(t.transformProjFromView,r.projectionMatrix),t.identifier===Da.Material&&(this._materialPassParameters.transparent=e.bindParameters.slot===K.TRANSPARENT_MATERIAL,this._materialPassParameters.integratedMesh=e.bindParameters.slot===K.INTEGRATED_MESH,ic(YE,t.transformViewFromCameraRelativeRS),Jp(t.transformNormalViewFromGlobal,YE))}get needsHighlight(){return this._passes.highlight.count>0||this._passes.highlightIntegratedMesh.count>0}get needsTransparentPass(){return this._passes.materialTransparent.count>0}};const hx=T(),YE=ys(),dx=new Zv;let Yee=class{constructor(){this._step=eA,this._dilation=1,this._firstIdleTime=Je(0)}frame(e,t){if(t?this._firstIdleTime===0&&(this._firstIdleTime=Je(performance.now())):this._firstIdleTime=Je(0),vi("enable-feature:high-quality-idle")){const s=t?performance.now()-this._firstIdleTime:0;if(s>=KE+Jee)return this._step=Je(1/0),void(this._dilation=1);this._dilation=s>=KE?ete:1}else this._dilation=1;const r=ee(e/Kee,eA,ite);this._step===1/0?this._step=Je(r):this._step=Je(this._step*JE+r*(1-JE))}get value(){return this._step}get timeDilation(){return this._dilation}clear(){this._step=this._firstIdleTime=Je(0)}};const Kee=.5,KE=Je(6e4),Jee=Je(5e3),ete=10,JE=.9,tte=30,eA=Je(1e3/1),ite=Je(1e3/tte),rte=8.6,ste=.4;function ate(){const i=new $t,{vertex:e,fragment:t}=i,r=e.code,s=t.code;return i.attributes.add(w.POSITION,"vec2"),i.varyings.add("uv","vec2"),i.attributes.add(w.UV0,"vec2"),e.uniforms.add(new lt("coverageTex",a=>a.coverageTexture)),r.add(_`void main() {
vec4 cov = texture2D(coverageTex, uv0);
if (cov.r == 0.0) {
gl_Position = vec4(0.0);
return;
}
gl_Position = vec4(position, 0.0, 1.0);
uv = position.xy * 0.5 + vec2(0.5);
}`),t.uniforms.add(new lt("tex",a=>a.blurColorTexture)),t.uniforms.add(new lt("origin",a=>a.highlightColorTexture)),t.uniforms.add(new ai("uColor",a=>a.color)),t.uniforms.add(new ai("haloColor",a=>a.haloColor)),t.uniforms.add(new ai("opacities",a=>Br(nte,a.haloOpacity,a.haloOpacityOccluded,a.fillOpacity,a.fillOpacityOccluded))),t.constants.add("outlineSize","float",rte),t.constants.add("blurSize","float",ste),s.add(_`void main() {
vec4 blurredHighlightValue = texture2D(tex, uv);
float highlightIntensity = blurredHighlightValue.a;
if (highlightIntensity == 0.0) {
discard;
}
vec4 origin_color = texture2D(origin, uv);
float outlineIntensity;
float fillIntensity;
if (blurredHighlightValue.g > blurredHighlightValue.b) {
outlineIntensity = haloColor.w * opacities[1];
fillIntensity = uColor.w * opacities[3];
}
else {
outlineIntensity = haloColor.w * opacities[0];
fillIntensity = uColor.w * opacities[2];
}
float inner = 1.0 - outlineSize / 9.0;
float outer = 1.0 - (outlineSize + blurSize) / 9.0;
float outlineFactor = smoothstep(outer, inner, highlightIntensity);
float fillFactor = any(notEqual(origin_color, vec4(0.0, 0.0, 0.0, 0.0))) ? 1.0 : 0.0;
float intensity = outlineIntensity * outlineFactor * (1.0 - fillFactor) + fillIntensity * fillFactor;
gl_FragColor = vec4(mix(haloColor.rgb, uColor.rgb, fillFactor), intensity);
}`),i}const nte=Pt(),ote=Object.freeze(Object.defineProperty({__proto__:null,build:ate},Symbol.toStringTag,{value:"Module"}));let F5=class z5 extends Mt{initializeProgram(e){return new Rt(e.rctx,z5.shader.get().build(),Lt)}initializePipeline(){return qe({blending:Ar(ae.SRC_ALPHA,ae.ONE,ae.ONE_MINUS_SRC_ALPHA,ae.ONE_MINUS_SRC_ALPHA),colorWrite:at})}};F5.shader=new Dt(ote,()=>_e(()=>import("./HighlightApply.glsl-d545ac22.js"),["assets/HighlightApply.glsl-d545ac22.js","assets/calcite-8912bd40.js","assets/index-00759e4a.js","assets/index-5026a37a.css","assets/calcite-96fa36fd.css","assets/objectResourceUtils-782953c3.js","assets/devEnvironmentUtils-5002a058.js","assets/mat3f64-50f3b9f6.js","assets/mat4f64-abdda1bb.js","assets/BufferView-379a78a4.js","assets/vec33-69c9e93b.js","assets/DefaultMaterial_COLOR_GAMMA-6ed76d86.js","assets/types-e1c0a5bf.js","assets/enums-e2e92c86.js","assets/Version-aa0a1d91.js","assets/quat-7b70e9a8.js","assets/quatf64-f8f1c132.js","assets/resourceUtils-527631ac.js","assets/basicInterfaces-7449a8bf.js","assets/Indices-d8bff7b2.js","assets/NestedMap-1b5db22e.js","assets/requestImageUtils-d1ba3b36.js","assets/symbolColorUtils-c9d24716.js","assets/Util-6d3f024a.js","assets/sphere-d0e5285d.js","assets/VertexAttribute-15d1866a.js","assets/doublePrecisionUtils-e3c3d0d8.js","assets/OrderIndependentTransparency-5f7257d7.js","assets/Texture-563cf5e5.js","assets/FramebufferObject-8b18fc0c.js","assets/VertexElementDescriptor-2925c6af.js","assets/InterleavedLayout-d57c91d0.js","assets/vec3f32-01c06d8d.js","assets/plane-5e2b046c.js","assets/spatialReferenceEllipsoidUtils-afb35af9.js","assets/scaleUtils-d13015f2.js","assets/ElevationSamplerData-e3118b17.js","assets/Octree-499541ed.js","assets/edgeProcessing-20e12367.js","assets/deduplicate-769a6f51.js","assets/MeshComponent-788e605a.js","assets/earcut-61f7b102.js","assets/imageUtils-c2d0d1ae.js","assets/projection-5969b753.js","assets/ZoomMomentumEstimator-ef57e6a4.js","assets/floatRGBA-ca2b39ca.js","assets/dehydratedFeatures-3a140d03.js","assets/quantizationUtils-b3b2ae2a.js","assets/labelFormatUtils-71e1f841.js","assets/orientedBoundingBox-a14b97b5.js","assets/quatf32-51a323b8.js","assets/SnappingCandidate-970faec6.js","assets/callExpressionWithFeature-df1a8f01.js","assets/DefaultVertexAttributeLayouts-5f20d8dd.js","assets/geometryServiceUtils-a536bb19.js","assets/project-909a4219.js","assets/LercDecoder-65586d50.js","assets/VectorTile-d41a1f0f.js","assets/enums-fb086c25.js","assets/config-1337d16e.js","assets/TiledDisplayObject-419c008b.js","assets/DisplayObject-87c37b69.js","assets/rasterUtils-7694cc98.js","assets/resources-7587d8f4.js","assets/workerHelper-6131d203.js","assets/webgl-debug-7f880832.js","assets/RenderingContext-0f21aa0e.js","assets/ProgramCache-f29c900e.js","assets/Program-77209250.js","assets/MediaLayer-4c42fc2f.js","assets/MediaElementView-06baa4d4.js","assets/normalizeUtilsSync-3ea564a9.js","assets/resourceExtension-f31d9f10.js","assets/BoundsStore-00da37da.js","assets/PooledRBush-5a11bc7e.js","assets/prism-line-numbers-eff41b13.js","assets/label2-a2f37e65.js","assets/interactive-1de2e238.js","assets/loadable-6afd516d.js","assets/t9n-81df3a71.js","assets/observers-c89705b8.js","assets/icon-8e47fbec.js","assets/loader-c773e800.js","assets/guid-51402ee7.js","assets/prism-line-numbers-7c5d72ff.css"]));let U5=class extends Gi{constructor(){super(...arguments),this.blurSize=$e()}};function lte(){const i=new $t,{vertex:e,fragment:t}=i,r=e.code,s=t.code;return i.attributes.add(w.POSITION,"vec2"),i.attributes.add(w.UV0,"vec2"),i.varyings.add("blurCoordinate","vec3"),e.uniforms.add(new lt("coverageTex",a=>a.coverageTexture)),t.uniforms.add(new Z3("blurSize",a=>a.blurSize)),r.add(_`void main() {
gl_Position = vec4(position, 0.0, 1.0);
vec4 cov = texture2D(coverageTex, uv0);
if (cov.r == 0.0) {
gl_Position = vec4(0.0);
}
blurCoordinate = vec3(gl_Position.xy * 0.5 + vec2(0.5), max(cov.g, cov.b));
}`),t.uniforms.add(new zT("tex",a=>a.blurInputTexture)),s.add(_`void main() {
vec2 uv = blurCoordinate.xy;
vec4 center = texture2D(tex, uv);
if (blurCoordinate.z == 1.0) {
gl_FragColor = center;
} else {
vec4 sum = vec4(0.0);
sum += center * 0.204164;
sum += texture2D(tex, uv + blurSize * 1.407333) * 0.304005;
sum += texture2D(tex, uv - blurSize * 1.407333) * 0.304005;
sum += texture2D(tex, uv + blurSize * 3.294215) * 0.093913;
sum += texture2D(tex, uv - blurSize * 3.294215) * 0.093913;
gl_FragColor = sum;
}
}`),i}const cte=Object.freeze(Object.defineProperty({__proto__:null,HighlightBlurDrawParameters:U5,build:lte},Symbol.toStringTag,{value:"Module"}));let V5=class G5 extends Mt{initializeProgram(e){return new Rt(e.rctx,G5.shader.get().build(),Lt)}initializePipeline(){return qe({colorWrite:at})}};V5.shader=new Dt(cte,()=>_e(()=>import("./HighlightBlur.glsl-e1281934.js"),["assets/HighlightBlur.glsl-e1281934.js","assets/calcite-8912bd40.js","assets/index-00759e4a.js","assets/index-5026a37a.css","assets/calcite-96fa36fd.css","assets/objectResourceUtils-782953c3.js","assets/devEnvironmentUtils-5002a058.js","assets/mat3f64-50f3b9f6.js","assets/mat4f64-abdda1bb.js","assets/BufferView-379a78a4.js","assets/vec33-69c9e93b.js","assets/DefaultMaterial_COLOR_GAMMA-6ed76d86.js","assets/types-e1c0a5bf.js","assets/enums-e2e92c86.js","assets/Version-aa0a1d91.js","assets/quat-7b70e9a8.js","assets/quatf64-f8f1c132.js","assets/resourceUtils-527631ac.js","assets/basicInterfaces-7449a8bf.js","assets/Indices-d8bff7b2.js","assets/NestedMap-1b5db22e.js","assets/requestImageUtils-d1ba3b36.js","assets/symbolColorUtils-c9d24716.js","assets/Util-6d3f024a.js","assets/sphere-d0e5285d.js","assets/VertexAttribute-15d1866a.js","assets/doublePrecisionUtils-e3c3d0d8.js","assets/OrderIndependentTransparency-5f7257d7.js","assets/Texture-563cf5e5.js","assets/FramebufferObject-8b18fc0c.js","assets/VertexElementDescriptor-2925c6af.js","assets/InterleavedLayout-d57c91d0.js","assets/vec3f32-01c06d8d.js","assets/plane-5e2b046c.js","assets/spatialReferenceEllipsoidUtils-afb35af9.js","assets/scaleUtils-d13015f2.js","assets/ElevationSamplerData-e3118b17.js","assets/Octree-499541ed.js","assets/edgeProcessing-20e12367.js","assets/deduplicate-769a6f51.js","assets/MeshComponent-788e605a.js","assets/earcut-61f7b102.js","assets/imageUtils-c2d0d1ae.js","assets/projection-5969b753.js","assets/ZoomMomentumEstimator-ef57e6a4.js","assets/floatRGBA-ca2b39ca.js","assets/dehydratedFeatures-3a140d03.js","assets/quantizationUtils-b3b2ae2a.js","assets/labelFormatUtils-71e1f841.js","assets/orientedBoundingBox-a14b97b5.js","assets/quatf32-51a323b8.js","assets/SnappingCandidate-970faec6.js","assets/callExpressionWithFeature-df1a8f01.js","assets/DefaultVertexAttributeLayouts-5f20d8dd.js","assets/geometryServiceUtils-a536bb19.js","assets/project-909a4219.js","assets/LercDecoder-65586d50.js","assets/VectorTile-d41a1f0f.js","assets/enums-fb086c25.js","assets/config-1337d16e.js","assets/TiledDisplayObject-419c008b.js","assets/DisplayObject-87c37b69.js","assets/rasterUtils-7694cc98.js","assets/resources-7587d8f4.js","assets/workerHelper-6131d203.js","assets/webgl-debug-7f880832.js","assets/RenderingContext-0f21aa0e.js","assets/ProgramCache-f29c900e.js","assets/Program-77209250.js","assets/MediaLayer-4c42fc2f.js","assets/MediaElementView-06baa4d4.js","assets/normalizeUtilsSync-3ea564a9.js","assets/resourceExtension-f31d9f10.js","assets/BoundsStore-00da37da.js","assets/PooledRBush-5a11bc7e.js","assets/prism-line-numbers-eff41b13.js","assets/label2-a2f37e65.js","assets/interactive-1de2e238.js","assets/loadable-6afd516d.js","assets/t9n-81df3a71.js","assets/observers-c89705b8.js","assets/icon-8e47fbec.js","assets/loader-c773e800.js","assets/guid-51402ee7.js","assets/prism-line-numbers-7c5d72ff.css"]));let B5=class extends Gi{constructor(){super(...arguments),this.invFramebufferDim=$e()}};function hte(){const i=new $t,{vertex:e,fragment:t}=i,r=e.code,s=t.code;return i.attributes.add(w.POSITION,"vec2"),r.add(_`void main() {
gl_Position = vec4(vec2(1.0) - position * 2.0, 0.0, 1.0);
}`),t.uniforms.add(new zT("tex",a=>a.inputTexture)),t.uniforms.add(new Z3("invFramebufferDim",a=>a.invFramebufferDim)),s.add(_`void main() {
vec2 coord = gl_FragCoord.xy * invFramebufferDim;
vec4 value = texture2D(tex, coord);
float mx = floor(max(value.g, value.b));
gl_FragColor = vec4(ceil(value.r), mx, mx, 1.0);
}`),i}const dte=Object.freeze(Object.defineProperty({__proto__:null,HighlightDownsampleDrawParameters:B5,build:hte},Symbol.toStringTag,{value:"Module"}));let H5=class k5 extends Mt{initializeProgram(e){return new Rt(e.rctx,k5.shader.get().build(),Lt)}initializePipeline(){return qe({colorWrite:at})}};H5.shader=new Dt(dte,()=>_e(()=>import("./HighlightDownsample.glsl-e4532584.js"),["assets/HighlightDownsample.glsl-e4532584.js","assets/calcite-8912bd40.js","assets/index-00759e4a.js","assets/index-5026a37a.css","assets/calcite-96fa36fd.css","assets/objectResourceUtils-782953c3.js","assets/devEnvironmentUtils-5002a058.js","assets/mat3f64-50f3b9f6.js","assets/mat4f64-abdda1bb.js","assets/BufferView-379a78a4.js","assets/vec33-69c9e93b.js","assets/DefaultMaterial_COLOR_GAMMA-6ed76d86.js","assets/types-e1c0a5bf.js","assets/enums-e2e92c86.js","assets/Version-aa0a1d91.js","assets/quat-7b70e9a8.js","assets/quatf64-f8f1c132.js","assets/resourceUtils-527631ac.js","assets/basicInterfaces-7449a8bf.js","assets/Indices-d8bff7b2.js","assets/NestedMap-1b5db22e.js","assets/requestImageUtils-d1ba3b36.js","assets/symbolColorUtils-c9d24716.js","assets/Util-6d3f024a.js","assets/sphere-d0e5285d.js","assets/VertexAttribute-15d1866a.js","assets/doublePrecisionUtils-e3c3d0d8.js","assets/OrderIndependentTransparency-5f7257d7.js","assets/Texture-563cf5e5.js","assets/FramebufferObject-8b18fc0c.js","assets/VertexElementDescriptor-2925c6af.js","assets/InterleavedLayout-d57c91d0.js","assets/vec3f32-01c06d8d.js","assets/plane-5e2b046c.js","assets/spatialReferenceEllipsoidUtils-afb35af9.js","assets/scaleUtils-d13015f2.js","assets/ElevationSamplerData-e3118b17.js","assets/Octree-499541ed.js","assets/edgeProcessing-20e12367.js","assets/deduplicate-769a6f51.js","assets/MeshComponent-788e605a.js","assets/earcut-61f7b102.js","assets/imageUtils-c2d0d1ae.js","assets/projection-5969b753.js","assets/ZoomMomentumEstimator-ef57e6a4.js","assets/floatRGBA-ca2b39ca.js","assets/dehydratedFeatures-3a140d03.js","assets/quantizationUtils-b3b2ae2a.js","assets/labelFormatUtils-71e1f841.js","assets/orientedBoundingBox-a14b97b5.js","assets/quatf32-51a323b8.js","assets/SnappingCandidate-970faec6.js","assets/callExpressionWithFeature-df1a8f01.js","assets/DefaultVertexAttributeLayouts-5f20d8dd.js","assets/geometryServiceUtils-a536bb19.js","assets/project-909a4219.js","assets/LercDecoder-65586d50.js","assets/VectorTile-d41a1f0f.js","assets/enums-fb086c25.js","assets/config-1337d16e.js","assets/TiledDisplayObject-419c008b.js","assets/DisplayObject-87c37b69.js","assets/rasterUtils-7694cc98.js","assets/resources-7587d8f4.js","assets/workerHelper-6131d203.js","assets/webgl-debug-7f880832.js","assets/RenderingContext-0f21aa0e.js","assets/ProgramCache-f29c900e.js","assets/Program-77209250.js","assets/MediaLayer-4c42fc2f.js","assets/MediaElementView-06baa4d4.js","assets/normalizeUtilsSync-3ea564a9.js","assets/resourceExtension-f31d9f10.js","assets/BoundsStore-00da37da.js","assets/PooledRBush-5a11bc7e.js","assets/prism-line-numbers-eff41b13.js","assets/label2-a2f37e65.js","assets/interactive-1de2e238.js","assets/loadable-6afd516d.js","assets/t9n-81df3a71.js","assets/observers-c89705b8.js","assets/icon-8e47fbec.js","assets/loader-c773e800.js","assets/guid-51402ee7.js","assets/prism-line-numbers-7c5d72ff.css"]));let tA=class extends Gi{constructor(){super(...arguments),this.color=lf(1,0,1,1),this.haloColor=lf(1,0,1,1),this.haloOpacity=1,this.haloOpacityOccluded=.25,this.fillOpacity=.2,this.fillOpacityOccluded=.05,this.shadowColor=hi(1,0,1,1),this.shadowOpacity=.15,this.occludedShadowOpacity=.075}};const ute=32;class pte{constructor(e,t){this._techniqueRep=e,this._rctx=t,this._viewportToRestore=Pt(),this._passParameters=new tA,this._downsampleDrawParameters=new B5,this._blurDrawParameters=new U5,this._grid={coverageMipmap:null,vao:null,verticalCellCount:0,horizontalCellCount:0,cellPixelSize:0,mipmapLevels:0,viewportWidth:0,viewportHeight:0}}_assertResources(){if(this._quadVAO)return;this._quadVAO=pa(this._rctx);const e={colorTarget:la.TEXTURE,depthStencilTarget:La.NONE,width:0,height:0},t={target:tr.TEXTURE_2D,pixelFormat:St.RGBA,dataType:Zt.UNSIGNED_BYTE,samplingMode:Qt.LINEAR,wrapMode:kt.CLAMP_TO_EDGE,width:0,height:0};this._blur0Fbo=new Rs(this._rctx,e,t),this._blur1Fbo=new Rs(this._rctx,e,t),this._blurTechnique=this._techniqueRep.acquire(V5),this._downsampleTechnique=this._techniqueRep.acquire(H5),this._applyTechnique=this._techniqueRep.acquire(F5)}dispose(){if(this._blurTechnique=er(this._blurTechnique),this._downsampleTechnique=er(this._downsampleTechnique),this._applyTechnique=er(this._applyTechnique),this._grid.coverageMipmap)for(let e=1;e<this._grid.coverageMipmap.length;e++)this._grid.coverageMipmap[e].dispose();this._grid.vao&&this._grid.vao.dispose(!0),this._quadVAO&&(this._quadVAO.dispose(!0),this._quadVAO=null),this._blur0Fbo=De(this._blur0Fbo),this._blur1Fbo=De(this._blur1Fbo)}setDefaultOptions(e){this._passParameters={...new tA,...e}}render(e,t,r){this._passParameters.highlightColorTexture=t.colorTexture,this._assertResources();const s=e.camera;Zc(this._viewportToRestore,s.fullViewport);const a=s.fullWidth,n=s.fullHeight,o=s.pixelRatio,l=Math.ceil(a/o),c=Math.ceil(n/o);this._blur0Fbo.resize(l,c),this._blur1Fbo.resize(l,c);const h=this._rctx;h.bindVAO(this._quadVAO);let u=null;this._gridUpdateResources(t,ute),this._gridComputeMipmap(e),this._passParameters.coverageTexture=this._grid.coverageMipmap[this._grid.mipmapLevels].colorTexture,u=this._grid.vao;const p=h.bindTechnique(this._blurTechnique,this._passParameters,e);h.bindVAO(u),h.bindFramebuffer(this._blur0Fbo),h.setViewport(0,0,l,c),h.setClearColor(0,0,0,0),h.clear(Xi.COLOR_BUFFER_BIT),this._blurDrawParameters.blurInputTexture=t.colorTexture,zt(this._blurDrawParameters.blurSize,1/l,0),p.bindDraw(this._blurDrawParameters,e,this._passParameters),h.drawArrays(this._blurTechnique.primitiveType,0,Os(u,"geometry")),h.bindFramebuffer(this._blur1Fbo),h.clear(Xi.COLOR_BUFFER_BIT),this._blurDrawParameters.blurInputTexture=this._blur0Fbo.colorTexture,zt(this._blurDrawParameters.blurSize,0,1/c),p.bindDraw(this._blurDrawParameters,e,this._passParameters),h.drawArrays(this._blurTechnique.primitiveType,0,Os(u,"geometry")),h.bindFramebuffer(r),h.setViewport(this._viewportToRestore[0],this._viewportToRestore[1],this._viewportToRestore[2],this._viewportToRestore[3]),this._passParameters.blurColorTexture=this._blur1Fbo.colorTexture,h.bindTechnique(this._applyTechnique,this._passParameters,e),h.drawArrays(this._applyTechnique.primitiveType,0,Os(u,"geometry")),h.bindVAO(null)}_gridUpdateResources(e,t){const r=this._rctx,s=this._grid;let a=!1;if(s.coverageMipmap===null&&(s.coverageMipmap=[e],a=!0),s.viewportWidth===e.width&&s.viewportHeight===e.height||(a=!0,s.viewportWidth=e.width,s.viewportHeight=e.height),s.coverageMipmap[0]=e,s.cellPixelSize!==t&&(s.cellPixelSize=t,a=!0),a){for(let l=1;l<s.coverageMipmap.length;l++)s.coverageMipmap[l].dispose();s.mipmapLevels=Math.ceil(Math.log(s.cellPixelSize)*Math.LOG2E),s.coverageMipmap.length=s.mipmapLevels+1;for(let l=0;l<s.mipmapLevels;l++){const c=s.coverageMipmap[l],h={target:tr.TEXTURE_2D,pixelFormat:St.RGB,dataType:Zt.UNSIGNED_SHORT_5_6_5,samplingMode:Qt.LINEAR,wrapMode:kt.CLAMP_TO_EDGE,width:Math.ceil(c.width/2),height:Math.ceil(c.height/2)},u={colorTarget:la.TEXTURE,depthStencilTarget:La.NONE,width:Math.ceil(c.width/2),height:Math.ceil(c.height/2)};s.coverageMipmap[l+1]=new Rs(r,u,h)}}const n=Math.ceil(e.height/s.cellPixelSize),o=Math.ceil(e.width/s.cellPixelSize);if(!s.vao||s.verticalCellCount!==n||s.horizontalCellCount!==o){s.verticalCellCount=n,s.horizontalCellCount=o;const l=n+1,c=o+1,h=1/n,u=1/o,p=6,m=4,f=new Float32Array(p*m*l*c);let y=0;for(let b=0;b<l;b++)for(let x=0;x<c;x++)f[y+0]=(x-.5)*u*2-1,f[y+1]=(b-.5)*h*2-1,f[y+2]=x*u,f[y+3]=b*h,f[y+4]=(x+.5)*u*2-1,f[y+5]=(b-.5)*h*2-1,f[y+6]=x*u,f[y+7]=b*h,f[y+8]=(x-.5)*u*2-1,f[y+9]=(b+.5)*h*2-1,f[y+10]=x*u,f[y+11]=b*h,f[y+12]=(x-.5)*u*2-1,f[y+13]=(b+.5)*h*2-1,f[y+14]=x*u,f[y+15]=b*h,f[y+16]=(x+.5)*u*2-1,f[y+17]=(b-.5)*h*2-1,f[y+18]=x*u,f[y+19]=b*h,f[y+20]=(x+.5)*u*2-1,f[y+21]=(b+.5)*h*2-1,f[y+22]=x*u,f[y+23]=b*h,y+=p*m;s.vao&&s.vao.dispose(!0),s.vao=new ac(r,Lt,{geometry:Gf},{geometry:gs.createVertex(r,ca.STATIC_DRAW,f)})}}_gridComputeMipmap(e){const t=this._rctx,r=this._grid,s=t.bindTechnique(this._downsampleTechnique,this._passParameters,e);t.bindVAO(this._quadVAO);for(let a=0;a<r.mipmapLevels;a++){t.bindFramebuffer(r.coverageMipmap[a+1]);const n=r.coverageMipmap[a+1].width,o=r.coverageMipmap[a+1].height;this._downsampleDrawParameters.inputTexture=r.coverageMipmap[a].colorTexture,zt(this._downsampleDrawParameters.invFramebufferDim,1/n,1/o),s.bindDraw(this._downsampleDrawParameters,e,this._passParameters),t.setViewport(0,0,n,o),t.drawArrays(Ut.TRIANGLE_STRIP,0,Os(this._quadVAO,"geometry"))}}get gpuMemoryUsage(){let e=(g(this._blur0Fbo)?this._blur0Fbo.gpuMemoryUsage:0)+(g(this._blur1Fbo)?this._blur1Fbo.gpuMemoryUsage:0);if(this._grid.coverageMipmap)for(const t of this._grid.coverageMipmap)e+=t.gpuMemoryUsage;return e}get test(){return{coverage:this._grid.coverageMipmap,blur:[this._blur0Fbo,this._blur1Fbo]}}}const mte={dataType:Zt.UNSIGNED_BYTE,internalFormat:St.RGBA},gte={};let fte=class{constructor(e){this._rctx=e,this._activeTargets=new Set,this._depthTextures=new Map,this._depthBuffers=new Map,this._colorTextures=new Map,this._framebuffers=new Map,this.depthTextureSupported=e.capabilities.depthTexture}dispose(){this._depthBuffers.forEach(e=>e.dispose()),this._depthBuffers.clear(),this._depthTextures.forEach(e=>e.dispose()),this._depthTextures.clear(),this._colorTextures.forEach(e=>e.dispose()),this._colorTextures.clear(),this._framebuffers.forEach(e=>e.dispose()),this._framebuffers.clear(),this._activeTargets.clear()}disposeTargetResource(e){const t=e.id;this._activeTargets.has(t)&&(this._activeTargets.delete(t),this._disposeWithFramebuffers(this._depthTextures,t),this._disposeWithFramebuffers(this._depthBuffers,t),this._disposeWithFramebuffers(this._colorTextures,t))}_disposeWithFramebuffers(e,t){const r=e.get(t);r&&(this._framebuffers.forEach((s,a)=>{s.colorAttachment!==r&&s.depthStencilAttachment!==r||(s.detachAll(),s.dispose(),this._framebuffers.delete(a))}),r.dispose(),e.delete(t))}getDepthTexture(e,t){if(!this.depthTextureSupported)return null;let r=this._depthTextures.get(e.id);return!r||r.descriptor.width===t.width&&r.descriptor.height===t.height||(r.dispose(),r=Cx()),r||(r=new Ai(this._rctx,{target:tr.TEXTURE_2D,pixelFormat:St.DEPTH_STENCIL,dataType:Zt.UNSIGNED_INT_24_8,samplingMode:Qt.NEAREST,wrapMode:kt.CLAMP_TO_EDGE,width:t.width,height:t.height}),this._depthTextures.set(e.id,r),this._activeTargets.add(e.id)),r}getAllocatedDepthTexture(e){return this._depthTextures.get(e.id)}getDepthBuffer(e,t){if(this.depthTextureSupported)return null;let r=this._depthBuffers.get(e.id);return r?r.descriptor.width===t.width&&r.descriptor.height===t.height||r.resize(t.width,t.height):(r=new c6(this._rctx,{internalFormat:n6.DEPTH_STENCIL,...t}),this._depthBuffers.set(e.id,r),this._activeTargets.add(e.id)),r}getColorTexture(e,t){let r=this._colorTextures.get(e.id);return r&&(r.descriptor.width===t.width&&r.descriptor.height===t.height||(r.dispose(),r=Cx())),r||(r=new Ai(this._rctx,{target:tr.TEXTURE_2D,pixelFormat:St.RGBA,internalFormat:e.internalFormat,dataType:e.dataType,samplingMode:e.samplingMode!=null?e.samplingMode:Qt.LINEAR,wrapMode:kt.CLAMP_TO_EDGE,width:t.width,height:t.height}),this._colorTextures.set(e.id,r),this._activeTargets.add(e.id)),r}getAllocatedColorTexture(e){return this._colorTextures.get(e.id)}registerDepthTarget(e={}){return{id:Up(),...gte,...e}}registerColorTarget(e={}){return{id:Up(),...mte,...e}}getFramebuffer(e,t,r){const s=this._getKey(t,r);let a=this._framebuffers.get(s);const n=this.getColorTexture(t,e);if(this.depthTextureSupported){const l=r?this.getDepthTexture(r,e):void 0;return a?((a.width!==e.width||a.height!==e.height||a.colorTexture!==n||a.depthStencilTexture!==l)&&(a.detachAll(),a.resize(e.width,e.height),a.attachColorTexture(n),a.attachDepthStencilTexture(l)),a):(a=g(r)?new Rs(this._rctx,{colorTarget:la.TEXTURE,depthStencilTarget:La.DEPTH_STENCIL_TEXTURE},n,l):new Rs(this._rctx,{colorTarget:la.TEXTURE,depthStencilTarget:La.NONE},n),this._framebuffers.set(s,a),a)}const o=r?this.getDepthBuffer(r,e):void 0;return a?((a.width!==e.width||a.height!==e.height||a.colorTexture!==n)&&(a.detachAll(),a.resize(e.width,e.height),a.attachColorTexture(n),a.attachDepthStencilBuffer(o)),a):(a=new Rs(this._rctx,{colorTarget:la.TEXTURE,depthStencilTarget:r?La.DEPTH_STENCIL_RENDER_BUFFER:La.NONE},n,o),this._framebuffers.set(s,a),a)}_getKey(e,t){return`${e.id}_${t?t.id:"X"}_${e.name}${t?"_"+t.name:""}`}get gpuMemoryUsage(){let e=0;const t=new Set,r=s=>{t.has(s)||(t.add(s),e+=my(s))};return this._depthTextures.forEach(r),this._colorTextures.forEach(r),this._depthBuffers.forEach(r),e}},_te=class{constructor(e,t){this._rctx=e,this._compositingHelper=t,this._mainColorTarget=0,this._dimensions={width:4,height:4},this._background={type:"color",color:[0,0,0,1]};const r=e.type===da.WEBGL2;this._renderTargetHelper=new fte(e);const s=this._renderTargetHelper;this._mainColorTargets=[s.registerColorTarget({name:"mainColorTarget0"}),s.registerColorTarget({name:"mainColorTarget1"})],this.frontFaceTarget=s.registerColorTarget({name:"frontFaceTarget"});const a=n=>s.registerColorTarget({name:n,dataType:Zt.FLOAT,internalFormat:r?g1.RGBA32F:St.RGBA,samplingMode:Qt.NEAREST});this.colorFloatTarget=a("colorFloatTarget"),this.alphaFloatTarget=a("alphaFloatTarget"),this.mainDepth=s.registerDepthTarget({name:"mainDepth"}),this.linearDepth=s.registerColorTarget({name:"linearDepth",samplingMode:Qt.NEAREST}),this.terrainLinearDepth=s.registerColorTarget({name:"terrainLinearDepth"}),this.geometryLinearDepth=s.registerColorTarget({name:"geometryLinearDepth"}),this.normal=s.registerColorTarget({name:"normal"}),this.highlight=s.registerColorTarget({name:"highlight",internalFormat:r?g1.RGBA4:St.RGBA,dataType:Zt.UNSIGNED_SHORT_4_4_4_4}),this.hudVisibility=s.registerColorTarget({name:"hudVisibility",internalFormat:r?g1.RGBA4:St.RGBA,dataType:Zt.UNSIGNED_SHORT_4_4_4_4}),this.tmpColor=s.registerColorTarget({name:"tmpColor"}),this.tmpDepth=s.registerDepthTarget({name:"tmpDepth"}),this.hudColor=s.registerColorTarget({name:"hudColor"})}dispose(){this._renderTargetHelper.dispose()}get width(){return this._dimensions.width}get height(){return this._dimensions.height}set background(e){this._background=e}get background(){return this._background}get currentColorTarget(){return this._mainColorTargets[this._mainColorTarget]}get previousColorTarget(){return this._mainColorTargets[1-this._mainColorTarget]}get framebuffer(){return this.getFramebuffer(this.currentColorTarget,this.mainDepth)}getFramebuffer(e,t){return this._renderTargetHelper.getFramebuffer(this._dimensions,e,t)}get colorTexture(){return this._renderTargetHelper.getAllocatedColorTexture(this.currentColorTarget)}get depthTexture(){return this._renderTargetHelper.getAllocatedDepthTexture(this.mainDepth)}get linearDepthTexture(){return this._renderTargetHelper.getAllocatedColorTexture(this.linearDepth)}get terrainLinearDepthTexture(){return this._renderTargetHelper.getAllocatedColorTexture(this.terrainLinearDepth)}get geometryLinearDepthTexture(){return this._renderTargetHelper.getAllocatedColorTexture(this.geometryLinearDepth)}get lastFrameColorTexture(){return this._renderTargetHelper.getAllocatedColorTexture(this.previousColorTarget)}get normalTexture(){return this._renderTargetHelper.getAllocatedColorTexture(this.normal)}get highlightTexture(){return this._renderTargetHelper.getAllocatedColorTexture(this.highlight)}get hudVisibilityTexture(){return this._getColorTexture(this.hudVisibility)}get tmpColorTexture(){return this._getColorTexture(this.tmpColor)}get hudColorTexture(){return this._getColorTexture(this.hudColor)}get mainColorTexture(){return this._getColorTexture(this.currentColorTarget)}setupRenderTarget(e){e||(this._mainColorTarget=0,this.disposeTarget(this._mainColorTargets[1])),this._mainColorTarget=this._mainColorTarget===0&&e?1:0}initializeFrame(e){const t=this._rctx;this._dimensions.width=e.fullWidth,this._dimensions.height=e.fullHeight,this.bindTarget(this.currentColorTarget,this.mainDepth),t.setClearStencil(0);const r=this._background.color;t.setClearColor(r[0]*r[3],r[1]*r[3],r[2]*r[3],r[3]),t.clearSafe(Xi.COLOR_BUFFER_BIT|Xi.DEPTH_BUFFER_BIT|Xi.STENCIL_BUFFER_BIT)}composite(e){g(this.colorTexture)&&this._compositingHelper.composite(e,this.colorTexture,us.None)}renderTmpAndCompositeToMain(e,t,r,s=!1){this.renderToTargets(e,this.tmpColor,s?this.tmpDepth:this.mainDepth,yte),this._compositingHelper.composite(t,this._getColorTexture(this.tmpColor),r)}renderHUDVisibility(e,t=!1){this.renderToTargets(e,this.hudVisibility,t?this.tmpDepth:this.mainDepth,vte)}compositeTransparentTerrainOntoHUDVisibility(e){this.renderToTargets(()=>this._compositingHelper.compositeHUD(e,this._getColorTexture(this.tmpColor)),this.hudVisibility,this.tmpDepth)}renderOITPass(e,t,r){let s,a;switch(t){case We.Color:s=this.colorFloatTarget,a=[0,0,0,0];break;case We.Alpha:s=this.alphaFloatTarget,a=[1,1,1,1];break;case We.FrontFace:s=this.frontFaceTarget,a=[0,0,0,0]}r?this.renderToTargets(e,s,this.tmpDepth,a,!0,!0):this.renderToTargets(e,s,this.mainDepth,a,!1)}compositeTransparentTerrainOntoMain(e){this.bindFramebuffer(),this._compositingHelper.composite(e,this._getColorTexture(this.tmpColor),us.PremultipliedAlpha)}compositeOccludedOntoMain(e,t){this.bindFramebuffer(),this._compositingHelper.composite(e,this._getColorTexture(this.tmpColor),us.PremultipliedAlpha,t)}compositeTransparentOntoOpaque(e,t){t?(this.bindTarget(this.hudColor,this.tmpDepth),this._rctx.setClearColor(0,0,0,1e-13),this._rctx.clearSafe(Xi.COLOR_BUFFER_BIT)):this.bindFramebuffer(),this._compositingHelper.compositeOIT(e,this._getColorTexture(this.colorFloatTarget),this._getColorTexture(this.alphaFloatTarget),this._getColorTexture(this.frontFaceTarget))}bindFramebuffer(){this._rctx.bindFramebuffer(this.framebuffer)}renderDepthDetached(e){this.bindTarget(this.currentColorTarget),e(),this.bindTarget(this.currentColorTarget,this.mainDepth)}disposeTarget(e){this._renderTargetHelper.disposeTargetResource(e)}renderToFBO(e,t,r=!1,s=!1){const a=this._rctx;let n=0;if(t){const l=Math.max(1e-13,t[3]);a.setClearColor(t[0],t[1],t[2],l),n|=Xi.COLOR_BUFFER_BIT}r&&(n|=Xi.DEPTH_BUFFER_BIT),s===!1?s=0:(s===!0&&(s=255),n|=Xi.STENCIL_BUFFER_BIT),n&&a.clearSafe(n,s),e(),a.gl.flush(),this.bindTarget(this.currentColorTarget,this.mainDepth)}renderToTargets(e,t,r,s,a=!1,n=!1){const o=this.bindTarget(t,r);return this.renderToFBO(e,s,a,n),o}bindTarget(e,t){const r=this._renderTargetHelper.getFramebuffer(this._dimensions,e,t);return this._rctx.bindFramebuffer(r),r}_getColorTexture(e){return this._renderTargetHelper.getColorTexture(e,this._dimensions)}get gpuMemoryUsage(){let e=0;return this._renderTargetHelper&&(e+=this._renderTargetHelper.gpuMemoryUsage),e}};const yte=[0,0,0,0],vte=[0,1,0,1];let bte=class{constructor(e){this._context=e,this._renderPlugins=new At,this._slots=[];for(let t=0;t<K.MAX_SLOTS;++t)this._slots[t]=[]}add(e,t,r){const s=()=>{if(r!=null&&r.aborted)throw t.uninitializeRenderContext(),ea();this._renderPlugins.push(t);for(const n of e)this._slots[n].push(t);this._context.requestRender()},a=t.initializeRenderContext(this._context,r);if(dv(a))return a.then(s);s()}remove(e){if(this._renderPlugins.removeUnordered(e)!=null){for(let t=0;t<this._slots.length;++t)this._slots[t]=this._slots[t].filter(r=>r!==e);e.uninitializeRenderContext(),this._context.requestRender()}}prepareRender(){this._renderPlugins.forAll(e=>{e.prepareRender&&e.prepareRender(this._context.renderContext)})}updateAnimation(e){let t=!1;return this._renderPlugins.forAll(r=>{r.updateAnimation&&(t=r.updateAnimation(e)||t)}),t}render(){const e=this._slots[this._context.renderContext.bindParameters.slot],t=new Array;e.filter(r=>{if(!r.canRender)return!1;if(xte(r)){const s=r.prepareTechnique(this._context.renderContext);return!!s&&(t.push(s),!0)}return t.push(null),!0}).forEach((r,s)=>r.render(this._context.renderContext,t[s]))}queryDepthRange(e){const t=wte;return t.near=1/0,t.far=-1/0,this._renderPlugins.forAll(r=>{if(r.queryDepthRange){const s=r.queryDepthRange(e);s&&Yp(t,s,t)}}),t}get needsTransparentPass(){return this._renderPlugins.some(e=>!!e.needsTransparentPass)}get needsHighlight(){return this._renderPlugins.some(e=>!!e.needsHighlight)}get needsLinearDepth(){return this._renderPlugins.some(e=>!!e.needsLinearDepth)}get needsLaserlineWithContrastControl(){const e=this._slots[K.LASERLINES_CONTRAST_CONTROL];return!!e&&e.length>0}get renderOccludedFlags(){return this._renderPlugins.reduce((e,t)=>e|t.renderOccludedFlags,0)}};function xte(i){return"prepareTechnique"in i}const wte={near:0,far:0};let j5=class extends Y3{};const Yv=255,Tte=1/Yv;function Cte(i){const e=new $t,t=e.fragment;return t.include(To),t.include(ml),e.include(UT),e.include(sc),e.include(Q3,i),t.uniforms.add([new lt("depthMap",r=>r.linearDepthTexture),new ir("inverseViewMatrix",(r,s)=>$a(iA,pl(iA,s.camera.viewMatrix,s.camera.center))),new pi("nearFar",(r,s)=>s.camera.nearFar)]),t.constants.add("sampleValue","float",Tte),t.code.add(_`void main(void) {
float depth = rgba2float(texture2D(depthMap, uv));
if (depth == 0.0) {
discard;
}
float currentPixelDepth = linearDepthFromFloat(depth, nearFar);
if (-currentPixelDepth > nearFar.y || -currentPixelDepth < nearFar.x) {
discard;
}
vec4 currentPixelPos = vec4(reconstructPosition(gl_FragCoord.xy, currentPixelDepth), 1.0);
vec4 worldSpacePos = inverseViewMatrix * currentPixelPos;
mat4 shadowMatrix;
float linearDepth = -currentPixelDepth;
int i = chooseCascade(linearDepth, shadowMatrix);
if (i >= numCascades) {
discard;
}
vec3 lvpos = lightSpacePosition(worldSpacePos.xyz, shadowMatrix);
if (lvpos.z >= 1.0 || lvpos.x < 0.0 || lvpos.x > 1.0 || lvpos.y < 0.0 || lvpos.y > 1.0) {
discard;
}
vec2 uvShadow = cascadeCoordinates(i, lvpos);
float depthShadow = readShadowMapDepth(uvShadow, shadowMapTex);
bool shadow = depthShadow < lvpos.z;
if (!shadow) {
discard;
}
gl_FragColor = vec4(sampleValue);
}`),e}const iA=ce(),Ste=Object.freeze(Object.defineProperty({__proto__:null,ShadowCastAccumulatePassParameters:j5,ShadowCastMaxSamples:Yv,build:Cte},Symbol.toStringTag,{value:"Module"}));var Gd;(function(i){i[i.Gradient=0]="Gradient",i[i.Threshold=1]="Threshold",i[i.COUNT=2]="COUNT"})(Gd||(Gd={}));let eT=class extends ua{constructor(){super(...arguments),this.visualization=Gd.Gradient,this.bandsEnabled=!1}};d([D({count:Gd.COUNT})],eT.prototype,"visualization",void 0),d([D()],eT.prototype,"bandsEnabled",void 0);let q5=class extends Gi{constructor(e){super(),this.shadowCastMap=e,this.sampleScale=0,this.opacityFromElevation=1,this.color=lv(Pte),this.bandSize=.1,this.threshold=.5}};const Pte=hi(.01,0,.25,1);function Ote(i){const e=new $t,t=e.fragment;t.include(To),t.include(ml),e.include(UT),e.include(sc);const{visualization:r,bandsEnabled:s}=i;t.constants.add("inverseSampleValue","float",Yv),t.uniforms.add([new lt("shadowCastMap",o=>o.shadowCastMap),new ue("sampleScale",o=>o.sampleScale),new ue("opacityFromElevation",o=>o.opacityFromElevation),new ai("uColor",o=>o.color)]);const a=r===Gd.Gradient,n=r===Gd.Threshold;return a&&s?t.uniforms.add(new ue("bandSize",o=>o.bandSize)):n&&t.uniforms.add(new ue("threshold",o=>o.threshold)),t.code.add(_`
      void main(void) {
        vec4 record = texture2D(shadowCastMap, uv);
        float pixelSamples = record.r * inverseSampleValue;
        if (pixelSamples < 1.0) {
          discard;
        }

        float strength = pixelSamples * sampleScale;

        ${n?_`
            if (strength <= threshold) {
              discard;
            }`:""}

        ${a&&s?_`strength = ceil(strength / bandSize) * bandSize;`:""}

        gl_FragColor = vec4(uColor.xyz, uColor.a * opacityFromElevation ${a?_`* strength`:""});
      }
    `),e}const Rte=Object.freeze(Object.defineProperty({__proto__:null,ShadowCastVisualizePassParameters:q5,build:Ote},Symbol.toStringTag,{value:"Module"}));let W5=class X5 extends Mt{constructor(e,t){super(e,t,()=>this.destroy())}initializeProgram(e){return new Rt(e.rctx,X5.shader.get().build(this.configuration),Lt)}initializePipeline(){return qe({blending:In,colorWrite:at,depthTest:null,depthWrite:null})}get primitiveType(){return Ut.TRIANGLE_STRIP}};W5.shader=new Dt(Rte,()=>_e(()=>import("./ShadowCastVisualize.glsl-3882609b.js"),["assets/ShadowCastVisualize.glsl-3882609b.js","assets/calcite-8912bd40.js","assets/index-00759e4a.js","assets/index-5026a37a.css","assets/calcite-96fa36fd.css","assets/OrderIndependentTransparency-5f7257d7.js","assets/enums-e2e92c86.js","assets/basicInterfaces-7449a8bf.js","assets/VertexAttribute-15d1866a.js","assets/objectResourceUtils-782953c3.js","assets/devEnvironmentUtils-5002a058.js","assets/mat3f64-50f3b9f6.js","assets/mat4f64-abdda1bb.js","assets/BufferView-379a78a4.js","assets/vec33-69c9e93b.js","assets/DefaultMaterial_COLOR_GAMMA-6ed76d86.js","assets/types-e1c0a5bf.js","assets/Version-aa0a1d91.js","assets/quat-7b70e9a8.js","assets/quatf64-f8f1c132.js","assets/resourceUtils-527631ac.js","assets/Indices-d8bff7b2.js","assets/NestedMap-1b5db22e.js","assets/requestImageUtils-d1ba3b36.js","assets/symbolColorUtils-c9d24716.js","assets/Util-6d3f024a.js","assets/sphere-d0e5285d.js","assets/doublePrecisionUtils-e3c3d0d8.js","assets/Texture-563cf5e5.js","assets/FramebufferObject-8b18fc0c.js","assets/VertexElementDescriptor-2925c6af.js","assets/InterleavedLayout-d57c91d0.js","assets/vec3f32-01c06d8d.js","assets/plane-5e2b046c.js","assets/spatialReferenceEllipsoidUtils-afb35af9.js","assets/scaleUtils-d13015f2.js","assets/ElevationSamplerData-e3118b17.js","assets/Octree-499541ed.js","assets/edgeProcessing-20e12367.js","assets/deduplicate-769a6f51.js","assets/MeshComponent-788e605a.js","assets/earcut-61f7b102.js","assets/imageUtils-c2d0d1ae.js","assets/projection-5969b753.js","assets/ZoomMomentumEstimator-ef57e6a4.js","assets/floatRGBA-ca2b39ca.js","assets/dehydratedFeatures-3a140d03.js","assets/quantizationUtils-b3b2ae2a.js","assets/labelFormatUtils-71e1f841.js","assets/orientedBoundingBox-a14b97b5.js","assets/quatf32-51a323b8.js","assets/SnappingCandidate-970faec6.js","assets/callExpressionWithFeature-df1a8f01.js","assets/DefaultVertexAttributeLayouts-5f20d8dd.js","assets/geometryServiceUtils-a536bb19.js","assets/project-909a4219.js","assets/LercDecoder-65586d50.js","assets/VectorTile-d41a1f0f.js","assets/enums-fb086c25.js","assets/config-1337d16e.js","assets/TiledDisplayObject-419c008b.js","assets/DisplayObject-87c37b69.js","assets/rasterUtils-7694cc98.js","assets/resources-7587d8f4.js","assets/workerHelper-6131d203.js","assets/webgl-debug-7f880832.js","assets/RenderingContext-0f21aa0e.js","assets/ProgramCache-f29c900e.js","assets/Program-77209250.js","assets/MediaLayer-4c42fc2f.js","assets/MediaElementView-06baa4d4.js","assets/normalizeUtilsSync-3ea564a9.js","assets/resourceExtension-f31d9f10.js","assets/BoundsStore-00da37da.js","assets/PooledRBush-5a11bc7e.js","assets/prism-line-numbers-eff41b13.js","assets/label2-a2f37e65.js","assets/interactive-1de2e238.js","assets/loadable-6afd516d.js","assets/t9n-81df3a71.js","assets/observers-c89705b8.js","assets/icon-8e47fbec.js","assets/loader-c773e800.js","assets/guid-51402ee7.js","assets/prism-line-numbers-7c5d72ff.css"]));const Ete=4e4,Ate=5e4,Q5=1/512;let sy=class extends Ie{constructor(e,t,r,s){super({}),this._techniqueRepository=e,this._rctx=t,this._data=r,this._requestRender=s,this._passParameters=new q5(this._data.shadowCastTexture),this._techniqueConfig=new eT,this._enabled=!1,this._vao=pa(t),this._techniqueConfig.visualization=Gd.Gradient}normalizeCtorArgs(){return{}}dispose(){this._stop(),this._vao=De(this._vao),this._techniqueRepository.release(this._technique),this._technique=null}get _visualizeShadowCastTechnique(){return this._technique=this._techniqueRepository.releaseAndAcquire(W5,this._techniqueConfig,this._technique),this._technique}render(e){if(!this._showVisualization)return;this._passParameters.sampleScale=1/this._data.computedSamples;const t=this._visualizeShadowCastTechnique;this._rctx.bindVAO(this._vao),this._rctx.bindTechnique(t,this._passParameters,e),this._rctx.drawArrays(t.primitiveType,0,Os(this._vao,"geometry"))}setOptions(e){e.enabled!==void 0&&this._setEnabled(e.enabled),e.color!==void 0&&this._setColor(e.color),e.threshold!==void 0&&(this._threshold=e.threshold),e.visualization!==void 0&&(this._visualization=e.visualization),e.bandSize!==void 0&&(this._bandSize=e.bandSize),e.bandsEnabled!==void 0&&(this._bandsEnabled=e.bandsEnabled)}get opacityFromElevation(){return this._passParameters.opacityFromElevation}set opacityFromElevation(e){this._passParameters.opacityFromElevation!==e&&(this._passParameters.opacityFromElevation=e,this.notifyChange("opacityFromElevation"))}get _showVisualization(){return this._enabled&&this._data.computedSamples>0&&this.opacityFromElevation>Q5}get _threshold(){return this._passParameters.threshold}set _threshold(e){this._threshold!==e&&(this._passParameters.threshold=e,this._requestRenderIfRunning())}get _visualization(){return this._techniqueConfig.visualization}set _visualization(e){e!==this._visualization&&(this._techniqueConfig.visualization=e,this._techniqueRepository.release(this._technique),this._technique=null,this._requestRenderIfRunning())}get _bandSize(){return this._passParameters.bandSize}set _bandSize(e){e!==this._bandSize&&(this._passParameters.bandSize=e,this._requestRenderIfRunning())}get _bandsEnabled(){return this._techniqueConfig.bandsEnabled}set _bandsEnabled(e){e!==this._bandsEnabled&&(this._techniqueConfig.bandsEnabled=e,this._techniqueRepository.release(this._technique),this._technique=null,this._requestRenderIfRunning())}_setColor(e){const t=this._passParameters.color;E0(e,t)||(Zc(this._passParameters.color,e),this._requestRenderIfRunning())}_setEnabled(e){e!==this._enabled&&(e?this._start():this._stop())}_requestRenderIfRunning(){this._enabled&&this._requestRender()}_start(){this._enabled=!0,this._requestRender()}_stop(){this._enabled=!1,this._requestRender()}};d([v()],sy.prototype,"opacityFromElevation",null),sy=d([Y("esri.views.3d.webgl-engine.lib.ShadowCastRenderer")],sy);let rv=class extends ua{constructor(){super(...arguments),this.receiveShadows=!0,this.hasWebGL2Context=!1}};d([D()],rv.prototype,"receiveShadows",void 0),d([D()],rv.prototype,"hasWebGL2Context",void 0);let Z5=class Y5 extends Mt{constructor(e){super(e,new rv,()=>this.destroy())}initializeConfiguration(e,t){t.hasWebGL2Context=e.rctx.type===da.WEBGL2}initializeProgram(e){return new Rt(e.rctx,Y5.shader.get().build(this.configuration),Lt)}initializePipeline(){return qe({blending:Ar(ae.ONE,ae.ONE,ae.ONE,ae.ONE),colorWrite:at,depthTest:null,depthWrite:null})}get primitiveType(){return Ut.TRIANGLE_STRIP}};Z5.shader=new Dt(Ste,()=>_e(()=>import("./ShadowCastAccumulate.glsl-99991223.js"),["assets/ShadowCastAccumulate.glsl-99991223.js","assets/calcite-8912bd40.js","assets/index-00759e4a.js","assets/index-5026a37a.css","assets/calcite-96fa36fd.css","assets/mat4f64-abdda1bb.js","assets/OrderIndependentTransparency-5f7257d7.js","assets/enums-e2e92c86.js","assets/basicInterfaces-7449a8bf.js","assets/VertexAttribute-15d1866a.js","assets/objectResourceUtils-782953c3.js","assets/devEnvironmentUtils-5002a058.js","assets/mat3f64-50f3b9f6.js","assets/BufferView-379a78a4.js","assets/vec33-69c9e93b.js","assets/DefaultMaterial_COLOR_GAMMA-6ed76d86.js","assets/types-e1c0a5bf.js","assets/Version-aa0a1d91.js","assets/quat-7b70e9a8.js","assets/quatf64-f8f1c132.js","assets/resourceUtils-527631ac.js","assets/Indices-d8bff7b2.js","assets/NestedMap-1b5db22e.js","assets/requestImageUtils-d1ba3b36.js","assets/symbolColorUtils-c9d24716.js","assets/Util-6d3f024a.js","assets/sphere-d0e5285d.js","assets/doublePrecisionUtils-e3c3d0d8.js","assets/Texture-563cf5e5.js","assets/FramebufferObject-8b18fc0c.js","assets/VertexElementDescriptor-2925c6af.js","assets/InterleavedLayout-d57c91d0.js","assets/vec3f32-01c06d8d.js","assets/plane-5e2b046c.js","assets/spatialReferenceEllipsoidUtils-afb35af9.js","assets/scaleUtils-d13015f2.js","assets/ElevationSamplerData-e3118b17.js","assets/Octree-499541ed.js","assets/edgeProcessing-20e12367.js","assets/deduplicate-769a6f51.js","assets/MeshComponent-788e605a.js","assets/earcut-61f7b102.js","assets/imageUtils-c2d0d1ae.js","assets/projection-5969b753.js","assets/ZoomMomentumEstimator-ef57e6a4.js","assets/floatRGBA-ca2b39ca.js","assets/dehydratedFeatures-3a140d03.js","assets/quantizationUtils-b3b2ae2a.js","assets/labelFormatUtils-71e1f841.js","assets/orientedBoundingBox-a14b97b5.js","assets/quatf32-51a323b8.js","assets/SnappingCandidate-970faec6.js","assets/callExpressionWithFeature-df1a8f01.js","assets/DefaultVertexAttributeLayouts-5f20d8dd.js","assets/geometryServiceUtils-a536bb19.js","assets/project-909a4219.js","assets/LercDecoder-65586d50.js","assets/VectorTile-d41a1f0f.js","assets/enums-fb086c25.js","assets/config-1337d16e.js","assets/TiledDisplayObject-419c008b.js","assets/DisplayObject-87c37b69.js","assets/rasterUtils-7694cc98.js","assets/resources-7587d8f4.js","assets/workerHelper-6131d203.js","assets/webgl-debug-7f880832.js","assets/RenderingContext-0f21aa0e.js","assets/ProgramCache-f29c900e.js","assets/Program-77209250.js","assets/MediaLayer-4c42fc2f.js","assets/MediaElementView-06baa4d4.js","assets/normalizeUtilsSync-3ea564a9.js","assets/resourceExtension-f31d9f10.js","assets/BoundsStore-00da37da.js","assets/PooledRBush-5a11bc7e.js","assets/prism-line-numbers-eff41b13.js","assets/label2-a2f37e65.js","assets/interactive-1de2e238.js","assets/loadable-6afd516d.js","assets/t9n-81df3a71.js","assets/observers-c89705b8.js","assets/icon-8e47fbec.js","assets/loader-c773e800.js","assets/guid-51402ee7.js","assets/prism-line-numbers-7c5d72ff.css"]));let ks=class extends Ie{constructor(e,t,r,s,a,n){super({}),this._rctx=e,this._stage=r,this._prepareForShadowMapPass=s,this._renderToShadowMap=a,this._requestRender=n,this._progress=0,this._sampleCount=0,this._passParameters=new j5,this._enabledInternal=!1,this._cachedLightDirections=[],this._depthRange=Qw,this._previewing=!1,this._handles=new Vi,this._cameraForcedForScreenshot=!1,this._bindParameters=new Rv(new jC(e,r.viewingMode),null,null),this._bindParameters.shadowMap.enabled=!0,this._vao=pa(e);const o={colorTarget:la.TEXTURE,depthStencilTarget:La.NONE,width:0,height:0},l={target:tr.TEXTURE_2D,pixelFormat:St.RGBA,dataType:Zt.UNSIGNED_BYTE,samplingMode:Qt.LINEAR,wrapMode:kt.CLAMP_TO_EDGE,width:0,height:0};this._fbo=new Rs(e,o,l),this._accumulationRenderer=new sy(t,e,this,n);const c=this._stage.view.resourceController.scheduler;this._handles.add([c.registerTask(Zi.SHADOW_ACCUMULATOR,this),te(()=>r.renderView,h=>{this._handles.remove(rA),g(h)&&this._handles.add(h.events.on("force-camera-for-screenshot",()=>this._cameraForcedForScreenshot=!0),rA)},Qi),te(()=>this._previewing,()=>this._requestRenderIfEnabled(),Bt)])}normalizeCtorArgs(){return{}}get computedSamples(){return this._progress}get shadowCastTexture(){return this._fbo.colorTexture}get isAccumulating(){return this._isPreviewing||this._isRefining}get _accumulationTechnique(){if(P(this._accumulationTechniqueCached)){const e={rctx:this._rctx,viewingMode:this._stage.viewingMode};this._accumulationTechniqueCached=new Z5(e)}return this._accumulationTechniqueCached}get _isRefining(){return this._isActive&&!this._isDoneAccumulating&&!this._previewing}get _isPreviewing(){return this._isActive&&this._previewing}get _isActive(){return this._enabledInternal&&this._sampleCount>0}get canAccumulate(){return this._passParameters.linearDepthTexture!==null&&this._depthRange!==Qw&&this._opacityFromElevation>Q5}get _isDoneAccumulating(){return this._progress>=this._sampleCount}get _lightDirections(){return this._cachedLightDirections}set _lightDirections(e){const t=this._cachedLightDirections;if(TT(t,e,Ed))return;const r=Math.min(Yv,e.length);t.length=r,this._sampleCount=r;for(let s=0;s<r;++s)t[s]=H(t[s]??T(),e[s]);this._invalidate()}get _opacityFromElevation(){return this._accumulationRenderer.opacityFromElevation}set _opacityFromElevation(e){this._accumulationRenderer.opacityFromElevation=e}get running(){return this._isRefining&&this.canAccumulate&&this._progress>0}runTask(e){for(this._prepareForShadowMapPass(this._bindParameters);!e.done&&!this._isDoneAccumulating;)this._accumulateShadow(),e.madeProgress();this._requestRender()}renderAccumulation(e,t,r,s){if(this._depthRange=t,this._updateCamera(r),this._bindParameters.contentCamera=s,this._passParameters.linearDepthTexture=e,this._passParameters.origin=this._bindParameters.camera.center,this.notifyChange("canAccumulate"),!this.isAccumulating||!this.canAccumulate)return;(this._previewing||this._progress===0||this._cameraForcedForScreenshot)&&this._clear();const a=this._cameraForcedForScreenshot?this._sampleCount:Math.min(Mte,this._sampleCount-this._progress);for(let n=0;n<a;++n)this._accumulateShadow();this._cameraForcedForScreenshot=!1,this._requestRender()}render(e){this._accumulationRenderer.render(e)}dispose(){this._stop(),this._handles.destroy(),this._accumulationRenderer=De(this._accumulationRenderer),this._bindParameters.shadowMap.dispose(),this._fbo=De(this._fbo),this._vao=De(this._vao),this._accumulationTechniqueCached=er(this._accumulationTechniqueCached),this._cachedLightDirections.length=0,this._sampleCount=0}setOptions(e){e.enabled!==void 0&&(this._enabled=e.enabled),e.previewing!==void 0&&(this._previewing=e.previewing),e.lightDirections!==void 0&&(this._lightDirections=e.lightDirections),this._accumulationRenderer.setOptions(e)}readAccumulatedShadow(e,t){return!this._isActive||this._progress<1||e<0||e>this._fbo.width||t<0||t>this._fbo.height?0:(this._fbo.readPixels(e,t,1,1,St.RGBA,Zt.UNSIGNED_BYTE,sA),sA[0]/this._progress)}_start(){this._progress=0,this._enabledInternal=!0}_stop(){this._enabledInternal=!1}_invalidate(){this._progress=0,this._requestRenderIfEnabled()}_clear(){this._rctx.bindFramebuffer(this._fbo),this._rctx.setClearColor(0,0,0,0),this._rctx.clearSafe(Xi.COLOR_BUFFER_BIT),this._progress=0}_accumulateShadow(){this._renderToShadowMap(this._bindParameters,this._sampleLightDirection(),this._depthRange);const e=this._accumulationTechnique;this._rctx.bindFramebuffer(this._fbo),this._rctx.bindTechnique(e,this._passParameters,this._bindParameters),this._rctx.bindVAO(this._vao),this._rctx.drawArrays(e.primitiveType,0,Os(this._vao,"geometry"))}_sampleLightDirection(){return this._progress++,this._lightDirections[this._progress*Dte%this._lightDirections.length]}_updateCamera(e){e.equals(this._bindParameters.camera)||(this._bindParameters.camera.copyFrom(e),this._fbo.resize(e.fullWidth,e.fullHeight),this._opacityFromElevation=1-Lp(Ete,Ate,e.relativeElevation))}set _enabled(e){e!==this._enabledInternal&&(e?this._start():this._stop())}_requestRenderIfEnabled(){this._enabledInternal&&this._requestRender()}get test(){const e=this;return{lightDirections:this._lightDirections,get isDone(){return e._isDoneAccumulating},get isActive(){return e._isActive}}}};d([v()],ks.prototype,"_progress",void 0),d([v()],ks.prototype,"_sampleCount",void 0),d([v()],ks.prototype,"_enabledInternal",void 0),d([v()],ks.prototype,"_depthRange",void 0),d([v()],ks.prototype,"_previewing",void 0),d([v()],ks.prototype,"_accumulationRenderer",void 0),d([v()],ks.prototype,"_isRefining",null),d([v()],ks.prototype,"_isActive",null),d([v()],ks.prototype,"canAccumulate",null),d([v()],ks.prototype,"_isDoneAccumulating",null),d([v()],ks.prototype,"_opacityFromElevation",null),d([v()],ks.prototype,"running",null),ks=d([Y("esri.views.3d.webgl-engine.lib.ShadowAccumulator")],ks);const Mte=6,rA="renderView",Dte=104729,sA=new Uint8Array(4),aA={highlightedThreshold:.99999,selfShadowThreshold:.025};function Ite(i){const e=new $t;e.include(Yg,i);const t=e.fragment;return t.include(To),t.include(ml),e.include(UT),e.include(sc),t.uniforms.add([new lt("defaultDepthTex",(r,s)=>s.shadowMap.getSnapshot(Xp.Default)),new lt("highlightDepthTex",(r,s)=>s.shadowMap.getSnapshot(Xp.Highlight)),new lt("depthMap",(r,s)=>s.linearDepthTexture),new lt("highlightMap",(r,s)=>s.highlightColorTexture),new ai("uColor",r=>r.shadowColor),new pi("nearFar",(r,s)=>s.camera.nearFar),new ue("opacity",r=>r.shadowOpacity),new ue("occludedOpacity",r=>r.occludedShadowOpacity),new ue("terminationFactor",r=>r.opacityElevation*r.dayNightTerminator),new si("lightingMainDirectionView",(r,s)=>W(oA,xe(oA,s.lighting.mainLight.direction,s.camera.viewInverseTransposeMatrix))),new pi("texelSize",(r,s)=>g(s.linearDepthTexture)?zt(Lte,1/s.linearDepthTexture.descriptor.width,1/s.linearDepthTexture.descriptor.height):uh),new ir("inverseViewMatrix",(r,s)=>$a(nA,pl(nA,s.camera.viewMatrix,s.camera.center)))]),t.constants.add("unoccludedHighlightFlag","vec4",JF).add("highlightedThreshold","float",aA.highlightedThreshold).add("selfShadowThreshold","float",aA.selfShadowThreshold),t.code.add(_`vec3 normalFromDepth(vec3 pixelPos, vec2 fragCoord, vec2 uv, vec2 texelSize, sampler2D depthMap, vec2 nearFar) {
float leftPixelDepth = linearDepthFromTexture(depthMap, uv + vec2(-1.0, 0.0) * texelSize, nearFar);
float rightPixelDepth = linearDepthFromTexture(depthMap, uv + vec2(1.0, 0.0) * texelSize, nearFar);
float bottomPixelDepth = linearDepthFromTexture(depthMap, uv + vec2(0.0, -1.0) * texelSize, nearFar);
float topPixelDepth = linearDepthFromTexture(depthMap, uv + vec2(0.0, 1.0) * texelSize, nearFar);
bool pickLeft = abs(pixelPos.z - leftPixelDepth) < abs(pixelPos.z - rightPixelDepth);
bool pickBottom = abs(pixelPos.z - bottomPixelDepth) < abs(pixelPos.z - topPixelDepth);
vec3 fragCoordHorizontal = pickLeft
? vec3(fragCoord + vec2(-1.0, 0.0), leftPixelDepth)
: vec3(fragCoord + vec2(1.0, 0.0), rightPixelDepth);
vec3 fragCoordVertical = pickBottom
? vec3(fragCoord + vec2(0.0, -1.0), bottomPixelDepth)
: vec3(fragCoord + vec2(0.0, 1.0), topPixelDepth);
vec3 verticalPixelPos = reconstructPosition(fragCoordHorizontal.xy, fragCoordHorizontal.z);
vec3 horizontalPixelPos = reconstructPosition(fragCoordVertical.xy, fragCoordVertical.z);
vec3 normal = normalize(cross(verticalPixelPos - pixelPos, horizontalPixelPos - pixelPos));
return pickLeft == pickBottom ? normal : -normal;
}`),t.code.add(_`void main(void) {
vec4 highlightInfo = texture2D(highlightMap, uv);
float visiblyHighlighted = (1.0 - clamp(distance(unoccludedHighlightFlag, highlightInfo), 0.0, 1.0)) * highlightInfo.a;
if (visiblyHighlighted > highlightedThreshold) {
discard;
}
float depth = rgba2float(texture2D(depthMap, uv));
if (depth == 0.0) {
discard;
}
float currentPixelDepth = linearDepthFromFloat(depth, nearFar);
if (-currentPixelDepth>nearFar.y || -currentPixelDepth<nearFar.x) {
discard;
}
vec4 currentPixelPos = vec4(reconstructPosition(gl_FragCoord.xy, currentPixelDepth), 1.0);
vec4 worldSpacePos = inverseViewMatrix * currentPixelPos;
mat4 shadowMatrix;
float linearDepth = -currentPixelDepth;
int i = chooseCascade(linearDepth, shadowMatrix);
if (i >= numCascades) {
discard;
}
vec3 lvpos = lightSpacePosition(worldSpacePos.xyz, shadowMatrix);
if (lvpos.z >= 1.0 || lvpos.x < 0.0 || lvpos.x > 1.0 || lvpos.y < 0.0 || lvpos.y > 1.0) {
discard;
}
vec2 uvShadow = cascadeCoordinates(i, lvpos);
float depthHighlight = readShadowMapDepth(uvShadow, highlightDepthTex);
bool shadowHighlight = depthHighlight < lvpos.z;
if (!shadowHighlight) {
discard;
}
float depthDefault = readShadowMapDepth(uvShadow, defaultDepthTex);
bool shadowDefault = depthDefault < lvpos.z;
vec3 normal = normalFromDepth(currentPixelPos.xyz, gl_FragCoord.xy, uv, texelSize, depthMap, nearFar);
bool shaded = dot(normal, lightingMainDirectionView) < selfShadowThreshold;
float fragOpacity = (shadowDefault || shaded) ? occludedOpacity : opacity;
gl_FragColor = vec4(uColor.rgb, uColor.a * fragOpacity * terminationFactor);
}`),e}const nA=ce(),oA=T(),Lte=$e(),$te=Object.freeze(Object.defineProperty({__proto__:null,build:Ite},Symbol.toStringTag,{value:"Module"}));let Nte=class extends Gi{constructor(){super(...arguments),this.shadowColor=hi(1,0,1,1),this.shadowOpacity=.2,this.occludedShadowOpacity=.1,this.opacityElevation=1,this.dayNightTerminator=1}},K5=class J5 extends Mt{constructor(e){super(e,new rv,()=>this.destroy())}initializeConfiguration(e,t){t.hasWebGL2Context=e.rctx.type===da.WEBGL2}initializeProgram(e){return new Rt(e.rctx,J5.shader.get().build(this.configuration),Lt)}initializePipeline(){return qe({blending:Ar(ae.SRC_ALPHA,ae.ONE,ae.ONE_MINUS_SRC_ALPHA,ae.ONE_MINUS_SRC_ALPHA),colorWrite:at,depthTest:null,depthWrite:null})}get primitiveType(){return Ut.TRIANGLE_STRIP}};K5.shader=new Dt($te,()=>_e(()=>import("./ShadowHighlight.glsl-3f561041.js"),["assets/ShadowHighlight.glsl-3f561041.js","assets/calcite-8912bd40.js","assets/index-00759e4a.js","assets/index-5026a37a.css","assets/calcite-96fa36fd.css","assets/mat4f64-abdda1bb.js","assets/OrderIndependentTransparency-5f7257d7.js","assets/enums-e2e92c86.js","assets/basicInterfaces-7449a8bf.js","assets/VertexAttribute-15d1866a.js","assets/objectResourceUtils-782953c3.js","assets/devEnvironmentUtils-5002a058.js","assets/mat3f64-50f3b9f6.js","assets/BufferView-379a78a4.js","assets/vec33-69c9e93b.js","assets/DefaultMaterial_COLOR_GAMMA-6ed76d86.js","assets/types-e1c0a5bf.js","assets/Version-aa0a1d91.js","assets/quat-7b70e9a8.js","assets/quatf64-f8f1c132.js","assets/resourceUtils-527631ac.js","assets/Indices-d8bff7b2.js","assets/NestedMap-1b5db22e.js","assets/requestImageUtils-d1ba3b36.js","assets/symbolColorUtils-c9d24716.js","assets/Util-6d3f024a.js","assets/sphere-d0e5285d.js","assets/doublePrecisionUtils-e3c3d0d8.js","assets/Texture-563cf5e5.js","assets/FramebufferObject-8b18fc0c.js","assets/VertexElementDescriptor-2925c6af.js","assets/InterleavedLayout-d57c91d0.js","assets/vec3f32-01c06d8d.js","assets/plane-5e2b046c.js","assets/spatialReferenceEllipsoidUtils-afb35af9.js","assets/scaleUtils-d13015f2.js","assets/ElevationSamplerData-e3118b17.js","assets/Octree-499541ed.js","assets/edgeProcessing-20e12367.js","assets/deduplicate-769a6f51.js","assets/MeshComponent-788e605a.js","assets/earcut-61f7b102.js","assets/imageUtils-c2d0d1ae.js","assets/projection-5969b753.js","assets/ZoomMomentumEstimator-ef57e6a4.js","assets/floatRGBA-ca2b39ca.js","assets/dehydratedFeatures-3a140d03.js","assets/quantizationUtils-b3b2ae2a.js","assets/labelFormatUtils-71e1f841.js","assets/orientedBoundingBox-a14b97b5.js","assets/quatf32-51a323b8.js","assets/SnappingCandidate-970faec6.js","assets/callExpressionWithFeature-df1a8f01.js","assets/DefaultVertexAttributeLayouts-5f20d8dd.js","assets/geometryServiceUtils-a536bb19.js","assets/project-909a4219.js","assets/LercDecoder-65586d50.js","assets/VectorTile-d41a1f0f.js","assets/enums-fb086c25.js","assets/config-1337d16e.js","assets/TiledDisplayObject-419c008b.js","assets/DisplayObject-87c37b69.js","assets/rasterUtils-7694cc98.js","assets/resources-7587d8f4.js","assets/workerHelper-6131d203.js","assets/webgl-debug-7f880832.js","assets/RenderingContext-0f21aa0e.js","assets/ProgramCache-f29c900e.js","assets/Program-77209250.js","assets/MediaLayer-4c42fc2f.js","assets/MediaElementView-06baa4d4.js","assets/normalizeUtilsSync-3ea564a9.js","assets/resourceExtension-f31d9f10.js","assets/BoundsStore-00da37da.js","assets/PooledRBush-5a11bc7e.js","assets/prism-line-numbers-eff41b13.js","assets/label2-a2f37e65.js","assets/interactive-1de2e238.js","assets/loadable-6afd516d.js","assets/t9n-81df3a71.js","assets/observers-c89705b8.js","assets/icon-8e47fbec.js","assets/loader-c773e800.js","assets/guid-51402ee7.js","assets/prism-line-numbers-7c5d72ff.css"]));const Fte=.001953125,zte=4e4,Ute=5e4;class Vte{constructor(e,t){this._rctx=e,this._viewingMode=t,this._maxOpacity=1,this._passParameters=new Nte,this._drawParameters=new Y3,this._vao=pa(this._rctx)}get _technique(){return P(this._techniqueCached)&&(this._techniqueCached=new K5({rctx:this._rctx,viewingMode:this._viewingMode})),this._techniqueCached}render(e,t){if(!e.shadowMap.enabled||!e.linearDepthTexture||!this.isVisible)return;const r=this._technique;this._drawParameters.origin=e.camera.center,this._rctx.bindFramebuffer(t),this._rctx.bindTechnique(r,this._passParameters,e).bindDraw(this._drawParameters,e,this._passParameters),this._rctx.bindVAO(this._vao),this._rctx.drawArrays(r.primitiveType,0,Os(this._vao,"geometry"))}get gpuMemoryUsage(){var e;return((e=this._vao)==null?void 0:e.size)??0}setDefaultOptions(e){this._passParameters={...this._passParameters,...e},this._updateMaxOpacity()}updateParameters(e,t){this._passParameters.opacityElevation=1-Lp(zte,Ute,e.relativeElevation);const r=this._viewingMode===ve.Global?W(lA,e.center):j(lA,0,0,1),s=J(r,t);this._passParameters.dayNightTerminator=Lp(0,1,ee(30*s,0,1))}dispose(){this._vao=De(this._vao),this._techniqueCached=er(this._techniqueCached)}get isVisible(){const{opacityElevation:e,dayNightTerminator:t}=this._passParameters;return this._maxOpacity*e*t>=Fte}_updateMaxOpacity(){const e=Math.max(this._passParameters.shadowOpacity,this._passParameters.occludedShadowOpacity);this._maxOpacity=e*this._passParameters.shadowColor[3]}}const lA=T(),cA=cc();let Gte=class{constructor(){this._plane=cc()}get isEnabled(){return!xM(this.plane,cA)}get plane(){return this._plane}set plane(e){Qd(e||cA,this._plane)}},Bte=class extends Gi{};function Lf(i){i.uniforms.add(new ai("resolution",e=>{const{descriptor:t}=e.colorTexture,r=t.width,s=t.height;return Br(Hte,1/r,1/s,r,s)}))}const Hte=Pt(),Zu={maxSearchSteps:8,maxDistanceAreaTex:16};function kte(){const i=new $t,{attributes:e,varyings:t,vertex:r,fragment:s}=i;return e.add(w.POSITION,"vec2"),t.add("uv","vec2"),t.add("offsets[2]","vec4"),t.add("maxOffset","vec4"),t.add("pixelCoord","vec2"),Lf(r),r.code.add(_`
      void main() {
        uv = position * 0.5 + vec2(0.5);
        gl_Position = vec4(position, 0, 1);

        pixelCoord = uv * resolution.zw;
        offsets[0] = uv.xyxy + resolution.xyxy * vec4( -0.25, 0.125, 1.25, 0.125 );
        offsets[1] = uv.xyxy + resolution.xyxy * vec4( -0.125, 0.25, -0.125, -1.25 );
        maxOffset = vec4( offsets[0].xz, offsets[1].yw ) + vec4( -2.0, 2.0, -2.0, 2.0 ) * resolution.xxyy * float( ${_.int(Zu.maxSearchSteps)} );
      }
    `),s.uniforms.add(new lt("edgesTexture",a=>a.edges.colorTexture)),s.uniforms.add(new lt("areaTexture",a=>a.areaTexture)),s.uniforms.add(new lt("searchTexture",a=>a.searchTexture)),Lf(s),s.code.add(_`
      #define SMAA_AREATEX_PIXEL_SIZE ( 1.0 / vec2( 160.0, 560.0 ) )
      #define SMAA_AREATEX_SUBTEX_SIZE ( 1.0 / 7.0 )

      vec4 sampleLevelZeroOffset(sampler2D texture, vec2 coord, vec2 offset) {
        return texture2D(texture, coord + offset.x * resolution.xy, 0.0);
      }

      vec2 round( vec2 x ) {
        return sign(x) * floor(abs(x) + 0.5);
      }

      float searchLength(sampler2D searchTex, vec2 e, float bias, float scale) {
        e.r = bias + e.r * scale;
        return 255.0 * texture2D( searchTex, e, 0.0 ).r;
      }

      float searchXLeft( sampler2D edgesTex, sampler2D searchTex, vec2 texcoord, float end ) {
        vec2 e = vec2( 0.0, 1.0 );
        for ( int i = 0; i < ${_.int(Zu.maxSearchSteps)}; i ++ ) {
          e = texture2D( edgesTex, texcoord, 0.0 ).rg;
          texcoord -= vec2( 2.0, 0.0 ) * resolution.xy;
          if ( ! ( texcoord.x > end && e.g > 0.8281 && e.r == 0.0 ) ) break;
        }
        texcoord.x += 0.25 * resolution.x;
        texcoord.x += resolution.x;
        texcoord.x += 2.0 * resolution.x;
        texcoord.x -= resolution.x * searchLength(searchTex, e, 0.0, 0.5);
        return texcoord.x;
      }

      float searchXRight( sampler2D edgesTex, sampler2D searchTex, vec2 texcoord, float end ) {
        vec2 e = vec2( 0.0, 1.0 );
        for ( int i = 0; i < ${_.int(Zu.maxSearchSteps)}; i ++ ) {
          e = texture2D( edgesTex, texcoord, 0.0 ).rg;
          texcoord += vec2( 2.0, 0.0 ) * resolution.xy;
          if ( ! ( texcoord.x < end && e.g > 0.8281 && e.r == 0.0 ) ) break;
        }
        texcoord.x -= 0.25 * resolution.x;
        texcoord.x -= resolution.x;
        texcoord.x -= 2.0 * resolution.x;
        texcoord.x += resolution.x * searchLength( searchTex, e, 0.5, 0.5 );
        return texcoord.x;
      }

      float searchYUp( sampler2D edgesTex, sampler2D searchTex, vec2 texcoord, float end ) {
        vec2 e = vec2( 1.0, 0.0 );
        for ( int i = 0; i < ${_.int(Zu.maxSearchSteps)}; i ++ ) {
          e = texture2D( edgesTex, texcoord, 0.0 ).rg;
          texcoord += vec2( 0.0, 2.0 ) * resolution.xy;
          if ( ! ( texcoord.y > end && e.r > 0.8281 && e.g == 0.0 ) ) break;
        }
        texcoord.y -= 0.25 * resolution.y;
        texcoord.y -= resolution.y;
        texcoord.y -= 2.0 * resolution.y;
        texcoord.y += resolution.y * searchLength( searchTex, e.gr, 0.0, 0.5 );
        return texcoord.y;
      }

      float searchYDown( sampler2D edgesTex, sampler2D searchTex, vec2 texcoord, float end ) {
        vec2 e = vec2( 1.0, 0.0 );
        for ( int i = 0; i < ${_.int(Zu.maxSearchSteps)}; i ++ ) {
          e = texture2D( edgesTex, texcoord, 0.0 ).rg;
          texcoord -= vec2( 0.0, 2.0 ) * resolution.xy;
          if ( ! ( texcoord.y < end && e.r > 0.8281 && e.g == 0.0 ) ) break;
        }
        texcoord.y += 0.25 * resolution.y;
        texcoord.y += resolution.y;
        texcoord.y += 2.0 * resolution.y;
        texcoord.y -= resolution.y * searchLength( searchTex, e.gr, 0.5, 0.5 );
        return texcoord.y;
      }

      vec2 getArea( sampler2D areaTex, vec2 dist, float e1, float e2, float offset ) {
        vec2 texcoord = float( ${_.int(Zu.maxDistanceAreaTex)} ) * round( 4.0 * vec2( e1, e2 ) ) + dist;
        texcoord = SMAA_AREATEX_PIXEL_SIZE * texcoord + ( 0.5 * SMAA_AREATEX_PIXEL_SIZE );
        texcoord.y += SMAA_AREATEX_SUBTEX_SIZE * offset;
        return texture2D( areaTex, texcoord, 0.0 ).rg;
      }

      void main() {
        ivec4 subsampleIndices = ivec4(0.0);
        vec4 weights = vec4(0.0);
        vec2 e = texture2D( edgesTexture, uv ).rg;
        if ( e.g > 0.0 ) {
          vec2 d;
          vec2 coords;
          coords.x = searchXLeft( edgesTexture, searchTexture, offsets[0].xy, maxOffset.x );
          coords.y = offsets[1].y;
          d.x = coords.x;
          float e1 = texture2D( edgesTexture, coords, 0.0 ).r;
          coords.x = searchXRight( edgesTexture, searchTexture, offsets[0].zw, maxOffset.y );
          d.y = coords.x;
          d = d * resolution.z - pixelCoord.x;
          vec2 sqrt_d = sqrt( abs(d) );
          coords.y -= 1.0 * resolution.y;
          float e2 = sampleLevelZeroOffset( edgesTexture, coords, vec2( 1.0, 0.0 ) ).r;
          weights.rg = getArea( areaTexture, sqrt_d, e1, e2, float( subsampleIndices.y ) );
        }

        if ( e.r > 0.0 ) {
          vec2 d;
          vec2 coords;
          coords.y = searchYUp( edgesTexture, searchTexture, offsets[1].xy, maxOffset.z );
          coords.x = offsets[0].x;
          d.x = coords.y;
          float e1 = texture2D( edgesTexture, coords, 0.0 ).g;
          coords.y = searchYDown( edgesTexture, searchTexture, offsets[1].zw, maxOffset.w );
          d.y = coords.y;
          d = d * resolution.w - pixelCoord.y;
          vec2 sqrt_d = sqrt(abs(d));
          coords.y -= 1.0 * resolution.y;
          float e2 = sampleLevelZeroOffset( edgesTexture, coords, vec2(0.0, 1.0)).g;
          weights.ba = getArea( areaTexture, sqrt_d, e1, e2, float( subsampleIndices.x ) );

          // for some reason the following lines are necessary to prevent
          // texture lookup precision issues on some Intel integrated graphics chips
          vec4 dbg = (offsets[0] + offsets[1] + maxOffset + coords.xyyx);
          weights.r += 0.00000001 * dot(vec4(0, 1, 0, 1), dbg);
        }
        gl_FragColor = weights;
      }
    `),i}const jte=Object.freeze(Object.defineProperty({__proto__:null,build:kte},Symbol.toStringTag,{value:"Module"}));let e4=class t4 extends Mt{initializeProgram(e){return new Rt(e.rctx,t4.shader.get().build(),Lt)}initializePipeline(){return qe({colorWrite:at})}};e4.shader=new Dt(jte,()=>_e(()=>import("./BlendWeights.glsl-b4ed5c7a.js"),["assets/BlendWeights.glsl-b4ed5c7a.js","assets/OrderIndependentTransparency-5f7257d7.js","assets/enums-e2e92c86.js","assets/basicInterfaces-7449a8bf.js","assets/objectResourceUtils-782953c3.js","assets/devEnvironmentUtils-5002a058.js","assets/calcite-8912bd40.js","assets/index-00759e4a.js","assets/index-5026a37a.css","assets/calcite-96fa36fd.css","assets/mat3f64-50f3b9f6.js","assets/mat4f64-abdda1bb.js","assets/BufferView-379a78a4.js","assets/vec33-69c9e93b.js","assets/DefaultMaterial_COLOR_GAMMA-6ed76d86.js","assets/types-e1c0a5bf.js","assets/Version-aa0a1d91.js","assets/quat-7b70e9a8.js","assets/quatf64-f8f1c132.js","assets/resourceUtils-527631ac.js","assets/Indices-d8bff7b2.js","assets/NestedMap-1b5db22e.js","assets/requestImageUtils-d1ba3b36.js","assets/symbolColorUtils-c9d24716.js","assets/Util-6d3f024a.js","assets/sphere-d0e5285d.js","assets/VertexAttribute-15d1866a.js","assets/doublePrecisionUtils-e3c3d0d8.js","assets/Texture-563cf5e5.js","assets/FramebufferObject-8b18fc0c.js","assets/VertexElementDescriptor-2925c6af.js","assets/InterleavedLayout-d57c91d0.js","assets/vec3f32-01c06d8d.js","assets/plane-5e2b046c.js","assets/spatialReferenceEllipsoidUtils-afb35af9.js","assets/scaleUtils-d13015f2.js","assets/ElevationSamplerData-e3118b17.js","assets/Octree-499541ed.js","assets/edgeProcessing-20e12367.js","assets/deduplicate-769a6f51.js","assets/MeshComponent-788e605a.js","assets/earcut-61f7b102.js","assets/imageUtils-c2d0d1ae.js","assets/projection-5969b753.js","assets/ZoomMomentumEstimator-ef57e6a4.js","assets/floatRGBA-ca2b39ca.js","assets/dehydratedFeatures-3a140d03.js","assets/quantizationUtils-b3b2ae2a.js","assets/labelFormatUtils-71e1f841.js","assets/orientedBoundingBox-a14b97b5.js","assets/quatf32-51a323b8.js","assets/SnappingCandidate-970faec6.js","assets/callExpressionWithFeature-df1a8f01.js","assets/DefaultVertexAttributeLayouts-5f20d8dd.js","assets/geometryServiceUtils-a536bb19.js","assets/project-909a4219.js","assets/LercDecoder-65586d50.js","assets/VectorTile-d41a1f0f.js","assets/enums-fb086c25.js","assets/config-1337d16e.js","assets/TiledDisplayObject-419c008b.js","assets/DisplayObject-87c37b69.js","assets/rasterUtils-7694cc98.js","assets/resources-7587d8f4.js","assets/workerHelper-6131d203.js","assets/webgl-debug-7f880832.js","assets/RenderingContext-0f21aa0e.js","assets/ProgramCache-f29c900e.js","assets/Program-77209250.js","assets/MediaLayer-4c42fc2f.js","assets/MediaElementView-06baa4d4.js","assets/normalizeUtilsSync-3ea564a9.js","assets/resourceExtension-f31d9f10.js","assets/BoundsStore-00da37da.js","assets/PooledRBush-5a11bc7e.js","assets/prism-line-numbers-eff41b13.js","assets/label2-a2f37e65.js","assets/interactive-1de2e238.js","assets/loadable-6afd516d.js","assets/t9n-81df3a71.js","assets/observers-c89705b8.js","assets/icon-8e47fbec.js","assets/loader-c773e800.js","assets/guid-51402ee7.js","assets/prism-line-numbers-7c5d72ff.css"]));function qte(){const i=new $t,{attributes:e,varyings:t,vertex:r,fragment:s}=i;return e.add(w.POSITION,"vec2"),t.add("uv","vec2"),t.add("offsets[2]","vec4"),Lf(r),r.code.add(_`void main() {
uv = position * 0.5 + vec2(0.5);
gl_Position = vec4(position, 0, 1);
offsets[0] = uv.xyxy + resolution.xyxy * vec4( -1.0, 0.0, 0.0, 1.0 );
offsets[1] = uv.xyxy + resolution.xyxy * vec4( 1.0, 0.0, 0.0, -1.0 );
}`),s.uniforms.add(new lt("blendWeightsTexture",a=>a.blend.colorTexture)),s.uniforms.add(new lt("colorTexture",a=>a.colorTexture)),Lf(s),s.code.add(_`void main() {
vec4 a;
a.rb = texture2D(blendWeightsTexture, uv).rb;
a.g = texture2D(blendWeightsTexture, offsets[1].zw).g;
a.a = texture2D(blendWeightsTexture, offsets[1].xy).a;
if ( dot(a, vec4(1.0)) < 1e-5 ) {
gl_FragColor = texture2D( colorTexture, uv, 0.0 );
} else {
vec2 offset;
offset.x = a.a > a.b ? a.a : -a.b;
offset.y = a.g > a.r ? -a.g : a.r;
if ( abs( offset.x ) > abs( offset.y )) {
offset.y = 0.0;
} else {
offset.x = 0.0;
}
vec4 C = texture2D( colorTexture, uv, 0.0 );
vec4 Cop = texture2D( colorTexture, uv + sign( offset ) * resolution.xy, 0.0 );
float s = abs( offset.x ) > abs( offset.y ) ? abs( offset.x ) : abs( offset.y );
gl_FragColor = mix(C, Cop, s);
}
}`),i}const Wte=Object.freeze(Object.defineProperty({__proto__:null,build:qte},Symbol.toStringTag,{value:"Module"}));let i4=class r4 extends Mt{initializeProgram(e){return new Rt(e.rctx,r4.shader.get().build(),Lt)}initializePipeline(){return qe({colorWrite:at})}};i4.shader=new Dt(Wte,()=>_e(()=>import("./Blur.glsl-9a3a3c2f.js"),["assets/Blur.glsl-9a3a3c2f.js","assets/OrderIndependentTransparency-5f7257d7.js","assets/enums-e2e92c86.js","assets/basicInterfaces-7449a8bf.js","assets/objectResourceUtils-782953c3.js","assets/devEnvironmentUtils-5002a058.js","assets/calcite-8912bd40.js","assets/index-00759e4a.js","assets/index-5026a37a.css","assets/calcite-96fa36fd.css","assets/mat3f64-50f3b9f6.js","assets/mat4f64-abdda1bb.js","assets/BufferView-379a78a4.js","assets/vec33-69c9e93b.js","assets/DefaultMaterial_COLOR_GAMMA-6ed76d86.js","assets/types-e1c0a5bf.js","assets/Version-aa0a1d91.js","assets/quat-7b70e9a8.js","assets/quatf64-f8f1c132.js","assets/resourceUtils-527631ac.js","assets/Indices-d8bff7b2.js","assets/NestedMap-1b5db22e.js","assets/requestImageUtils-d1ba3b36.js","assets/symbolColorUtils-c9d24716.js","assets/Util-6d3f024a.js","assets/sphere-d0e5285d.js","assets/VertexAttribute-15d1866a.js","assets/doublePrecisionUtils-e3c3d0d8.js","assets/Texture-563cf5e5.js","assets/FramebufferObject-8b18fc0c.js","assets/VertexElementDescriptor-2925c6af.js","assets/InterleavedLayout-d57c91d0.js","assets/vec3f32-01c06d8d.js","assets/plane-5e2b046c.js","assets/spatialReferenceEllipsoidUtils-afb35af9.js","assets/scaleUtils-d13015f2.js","assets/ElevationSamplerData-e3118b17.js","assets/Octree-499541ed.js","assets/edgeProcessing-20e12367.js","assets/deduplicate-769a6f51.js","assets/MeshComponent-788e605a.js","assets/earcut-61f7b102.js","assets/imageUtils-c2d0d1ae.js","assets/projection-5969b753.js","assets/ZoomMomentumEstimator-ef57e6a4.js","assets/floatRGBA-ca2b39ca.js","assets/dehydratedFeatures-3a140d03.js","assets/quantizationUtils-b3b2ae2a.js","assets/labelFormatUtils-71e1f841.js","assets/orientedBoundingBox-a14b97b5.js","assets/quatf32-51a323b8.js","assets/SnappingCandidate-970faec6.js","assets/callExpressionWithFeature-df1a8f01.js","assets/DefaultVertexAttributeLayouts-5f20d8dd.js","assets/geometryServiceUtils-a536bb19.js","assets/project-909a4219.js","assets/LercDecoder-65586d50.js","assets/VectorTile-d41a1f0f.js","assets/enums-fb086c25.js","assets/config-1337d16e.js","assets/TiledDisplayObject-419c008b.js","assets/DisplayObject-87c37b69.js","assets/rasterUtils-7694cc98.js","assets/resources-7587d8f4.js","assets/workerHelper-6131d203.js","assets/webgl-debug-7f880832.js","assets/RenderingContext-0f21aa0e.js","assets/ProgramCache-f29c900e.js","assets/Program-77209250.js","assets/MediaLayer-4c42fc2f.js","assets/MediaElementView-06baa4d4.js","assets/normalizeUtilsSync-3ea564a9.js","assets/resourceExtension-f31d9f10.js","assets/BoundsStore-00da37da.js","assets/PooledRBush-5a11bc7e.js","assets/prism-line-numbers-eff41b13.js","assets/label2-a2f37e65.js","assets/interactive-1de2e238.js","assets/loadable-6afd516d.js","assets/t9n-81df3a71.js","assets/observers-c89705b8.js","assets/icon-8e47fbec.js","assets/loader-c773e800.js","assets/guid-51402ee7.js","assets/prism-line-numbers-7c5d72ff.css"]));const hA={threshold:.05,localConstrastAdaption:2};function Xte(){const i=new $t,{attributes:e,varyings:t,vertex:r,fragment:s}=i;return e.add(w.POSITION,"vec2"),Lf(r),t.add("uv","vec2"),t.add("offsets[3]","vec4"),r.code.add(_`void main() {
uv = position * 0.5 + vec2(0.5);
gl_Position = vec4(position, 0, 1);
offsets[0] = uv.xyxy + resolution.xyxy * vec4( -1.0, 0.0, 0.0,  1.0 );
offsets[1] = uv.xyxy + resolution.xyxy * vec4(  1.0, 0.0, 0.0, -1.0 );
offsets[2] = uv.xyxy + resolution.xyxy * vec4( -2.0, 0.0, 0.0,  2.0 );
}`),s.uniforms.add(new lt("colorTexture",a=>a.colorTexture)),s.code.add(_`
    float absMax3(vec3 v) {
      vec3 t = abs(v);
      return max(max(t.r, t.g), t.b);
    }

    void main() {
      // Calculate color deltas:
      vec4 delta;
      vec3 C = texture2D(colorTexture, uv).rgb;

      vec3 Cleft = texture2D(colorTexture, offsets[0].xy).rgb;
      delta.x = absMax3(C - Cleft);

      vec3 Ctop = texture2D(colorTexture, offsets[0].zw).rgb;
      delta.y = absMax3(C - Ctop);

      vec2 edges = step(vec2(${_.float(hA.threshold)}), delta.xy);

      // discard if there is no edge:
      if (dot(edges, vec2(1.0)) == 0.0) {
        discard;
      }

      // Calculate right and bottom deltas:
      vec3 Cright = texture2D(colorTexture, offsets[1].xy).rgb;
      delta.z = absMax3(C - Cright);

      vec3 Cbottom  = texture2D(colorTexture, offsets[1].zw).rgb;
      delta.w = absMax3(C - Cbottom);

      // Calculate the maximum delta in the direct neighborhood:
      float maxDelta = max(max(max(delta.x, delta.y), delta.z), delta.w);

      // Calculate left-left and top-top deltas:
      vec3 Cleftleft  = texture2D(colorTexture, offsets[2].xy).rgb;
      delta.z = absMax3(C - Cleftleft);

      vec3 Ctoptop = texture2D(colorTexture, offsets[2].zw).rgb;
      delta.w = absMax3(C - Ctoptop);

      // Calculate the final maximum delta:
      maxDelta = max(max(maxDelta, delta.z), delta.w);

      // Local contrast adaptation in action:
      edges.xy *= step(maxDelta, float(${_.float(hA.localConstrastAdaption)}) * delta.xy);

      gl_FragColor = vec4(edges, 0.0, 0.0);
    }
  `),i}const Qte=Object.freeze(Object.defineProperty({__proto__:null,build:Xte},Symbol.toStringTag,{value:"Module"}));let s4=class a4 extends Mt{initializeProgram(e){return new Rt(e.rctx,a4.shader.get().build(),Lt)}initializePipeline(){return qe({colorWrite:at})}};s4.shader=new Dt(Qte,()=>_e(()=>import("./EdgeDetect.glsl-c87c8b75.js"),["assets/EdgeDetect.glsl-c87c8b75.js","assets/OrderIndependentTransparency-5f7257d7.js","assets/enums-e2e92c86.js","assets/basicInterfaces-7449a8bf.js","assets/objectResourceUtils-782953c3.js","assets/devEnvironmentUtils-5002a058.js","assets/calcite-8912bd40.js","assets/index-00759e4a.js","assets/index-5026a37a.css","assets/calcite-96fa36fd.css","assets/mat3f64-50f3b9f6.js","assets/mat4f64-abdda1bb.js","assets/BufferView-379a78a4.js","assets/vec33-69c9e93b.js","assets/DefaultMaterial_COLOR_GAMMA-6ed76d86.js","assets/types-e1c0a5bf.js","assets/Version-aa0a1d91.js","assets/quat-7b70e9a8.js","assets/quatf64-f8f1c132.js","assets/resourceUtils-527631ac.js","assets/Indices-d8bff7b2.js","assets/NestedMap-1b5db22e.js","assets/requestImageUtils-d1ba3b36.js","assets/symbolColorUtils-c9d24716.js","assets/Util-6d3f024a.js","assets/sphere-d0e5285d.js","assets/VertexAttribute-15d1866a.js","assets/doublePrecisionUtils-e3c3d0d8.js","assets/Texture-563cf5e5.js","assets/FramebufferObject-8b18fc0c.js","assets/VertexElementDescriptor-2925c6af.js","assets/InterleavedLayout-d57c91d0.js","assets/vec3f32-01c06d8d.js","assets/plane-5e2b046c.js","assets/spatialReferenceEllipsoidUtils-afb35af9.js","assets/scaleUtils-d13015f2.js","assets/ElevationSamplerData-e3118b17.js","assets/Octree-499541ed.js","assets/edgeProcessing-20e12367.js","assets/deduplicate-769a6f51.js","assets/MeshComponent-788e605a.js","assets/earcut-61f7b102.js","assets/imageUtils-c2d0d1ae.js","assets/projection-5969b753.js","assets/ZoomMomentumEstimator-ef57e6a4.js","assets/floatRGBA-ca2b39ca.js","assets/dehydratedFeatures-3a140d03.js","assets/quantizationUtils-b3b2ae2a.js","assets/labelFormatUtils-71e1f841.js","assets/orientedBoundingBox-a14b97b5.js","assets/quatf32-51a323b8.js","assets/SnappingCandidate-970faec6.js","assets/callExpressionWithFeature-df1a8f01.js","assets/DefaultVertexAttributeLayouts-5f20d8dd.js","assets/geometryServiceUtils-a536bb19.js","assets/project-909a4219.js","assets/LercDecoder-65586d50.js","assets/VectorTile-d41a1f0f.js","assets/enums-fb086c25.js","assets/config-1337d16e.js","assets/TiledDisplayObject-419c008b.js","assets/DisplayObject-87c37b69.js","assets/rasterUtils-7694cc98.js","assets/resources-7587d8f4.js","assets/workerHelper-6131d203.js","assets/webgl-debug-7f880832.js","assets/RenderingContext-0f21aa0e.js","assets/ProgramCache-f29c900e.js","assets/Program-77209250.js","assets/MediaLayer-4c42fc2f.js","assets/MediaElementView-06baa4d4.js","assets/normalizeUtilsSync-3ea564a9.js","assets/resourceExtension-f31d9f10.js","assets/BoundsStore-00da37da.js","assets/PooledRBush-5a11bc7e.js","assets/prism-line-numbers-eff41b13.js","assets/label2-a2f37e65.js","assets/interactive-1de2e238.js","assets/loadable-6afd516d.js","assets/t9n-81df3a71.js","assets/observers-c89705b8.js","assets/icon-8e47fbec.js","assets/loader-c773e800.js","assets/guid-51402ee7.js","assets/prism-line-numbers-7c5d72ff.css"]));let vg=class extends Ie{constructor(e,t){super({}),this._rctx=e,this._techniqueRep=t,this._passParameters=new Bte,this._isEnabled=!1}normalizeCtorArgs(){return{}}dispose(){this._abortController=Th(this._abortController),this.disable()}_loadResources(e){if(g(this._abortController))return!1;if(g(this._passParameters.searchTexture))return!0;this._abortController=new AbortController;const t=this._abortController.signal;return _e(()=>import("./SmaaRenderPassData-660b7d34.js"),[]).then(r=>this._loadTextures(r,t)).then(()=>e()).finally(()=>this._abortController=null),!1}_loadTextures(e,t){return lr(t),Promise.all([this._loadTextureFromBase64(e.areaTexture,Qt.LINEAR,St.RGB),this._loadTextureFromBase64(e.searchTexure,Qt.NEAREST,St.LUMINANCE)]).then(([r,s])=>{Qo(t)?(r.dispose(),s.dispose(),lr(t)):(this._passParameters.areaTexture=r,this._passParameters.searchTexture=s)})}get updating(){return g(this._abortController)}enable(e){if(this._isEnabled)return!0;if(!this._edgeDetectTechnique||!this._blendWeightsTechnique||!this._blurTechnique){const t=new ua;this._edgeDetectTechnique=this._techniqueRep.releaseAndAcquire(s4,t,this._edgeDetectTechnique),this._blendWeightsTechnique=this._techniqueRep.releaseAndAcquire(e4,t,this._blendWeightsTechnique),this._blurTechnique=this._techniqueRep.releaseAndAcquire(i4,t,this._blurTechnique)}return!!this._loadResources(e)&&(this._vao=e6(this._rctx),this._passParameters.edges=new Rs(this._rctx,{colorTarget:la.TEXTURE,depthStencilTarget:La.NONE},{target:tr.TEXTURE_2D,pixelFormat:St.RGB,dataType:Zt.UNSIGNED_BYTE,samplingMode:Qt.LINEAR,wrapMode:kt.CLAMP_TO_EDGE,width:4,height:4}),this._passParameters.blend=new Rs(this._rctx,{colorTarget:la.TEXTURE,depthStencilTarget:La.NONE},{target:tr.TEXTURE_2D,pixelFormat:St.RGBA,dataType:Zt.UNSIGNED_BYTE,samplingMode:Qt.LINEAR,wrapMode:kt.CLAMP_TO_EDGE,width:4,height:4}),this._isEnabled=!0,!0)}disable(){this._isEnabled&&(this._vao=De(this._vao),this._passParameters.areaTexture=De(this._passParameters.areaTexture),this._passParameters.searchTexture=De(this._passParameters.searchTexture),this._passParameters.blend=De(this._passParameters.blend),this._passParameters.edges=De(this._passParameters.edges),this._isEnabled=!1)}get _validPassParameters(){return this._isEnabled?this._passParameters:null}render(e){const t=this._validPassParameters;if(P(t))return;t.colorTexture=e;const r=this._rctx,s=r.getBoundFramebufferObject(),a=e.descriptor.width,n=e.descriptor.height;r.bindVAO(this._vao),r.setViewport(0,0,a,n),t.edges.resize(a,n),r.bindFramebuffer(t.edges),r.setClearColor(0,0,0,1),r.clear(Xi.COLOR_BUFFER_BIT),r.bindTechnique(this._edgeDetectTechnique,t,null),r.drawArrays(Ut.TRIANGLES,0,3),t.blend.resize(a,n),r.bindFramebuffer(t.blend),r.setClearColor(0,0,1,1),r.clear(Xi.COLOR_BUFFER_BIT),r.bindTechnique(this._blendWeightsTechnique,t,null),r.drawArrays(Ut.TRIANGLES,0,3),r.bindFramebuffer(s),r.setClearColor(0,1,0,1),r.clear(Xi.COLOR_BUFFER_BIT),r.bindTechnique(this._blurTechnique,t,null),r.drawArrays(Ut.TRIANGLES,0,3)}_loadTextureFromBase64(e,t,r){return cf(e).then(s=>new Ai(this._rctx,{pixelFormat:r,dataType:Zt.UNSIGNED_BYTE,wrapMode:kt.CLAMP_TO_EDGE,width:s.width,height:s.height,samplingMode:t},s))}};d([v()],vg.prototype,"_abortController",void 0),d([v({readOnly:!0})],vg.prototype,"updating",null),vg=d([Y("esri.views.3d.webgl-engine.lib.SmaaRenderPass")],vg);function Zte(i,e){const t=-i[0],r=-i[1],s=-i[2],a=e[3],n=e[7],o=e[11],l=e[15];e[0]+=a*t,e[1]+=a*r,e[2]+=a*s,e[4]+=n*t,e[5]+=n*r,e[6]+=n*s,e[8]+=o*t,e[9]+=o*r,e[10]+=o*s,e[12]+=l*t,e[13]+=l*r,e[14]+=l*s}function Yte(i,e){const t=i[0],r=i[1],s=i[2];e[12]+=t*e[0]+r*e[4]+s*e[8],e[13]+=t*e[1]+r*e[5]+s*e[9],e[14]+=t*e[2]+r*e[6]+s*e[10],e[14]+=t*e[3]+r*e[7]+s*e[11]}let Kte=class{constructor(e){this._factory=e,this._originData=new Map}acquire(e){return this.register(this._factory.getOrigin(e))}register(e){const t=this._originData.get(e.id)||new Jte(e);return t.refCount++,this._originData.has(t.origin.id)||this._originData.set(t.origin.id,t),t}release(e){e.refCount--,e.refCount===0&&this._originData.delete(e.origin.id)}updateViewMatrices(e){this._originData.forEach(t=>{Kr(t.viewMatrix,e),Yte(t.origin.vec3,t.viewMatrix)})}},Jte=class{constructor(e){this.origin=e,this.refCount=0,this.viewMatrix=ce()}},eie=class extends t6{constructor(e,t){super(),this.distanceFalloffFactor=e,this.transparency=t,this.transformNormalViewFromGlobal=ys()}},tie=class extends i6{constructor(){super(...arguments),this.transformNormalViewFromGlobal=ys(),this.slicePlaneLocalOrigin=T(),this.transformNormalGlobalFromModel=ys()}};function iie(i){const e=_`bool isNaN( float val )
{
return ( val < 0.0 || 0.0 < val || val == 0.0 ) ? false : true;
}`;i.code.add(e)}const rie=It(.5,-4e-4);function sie(i,e){const t=i.vertex;t.include(iie),t.constants.add("depthBias","vec2",rie),t.uniforms.add(new pi("inverseViewport",(r,s)=>s.inverseViewport)),e.legacy?(t.uniforms.add(new ir("proj",(r,s)=>s.camera.projectionMatrix)),t.code.add(_`vec2 calculateProjectedBiasXY(vec4 projPos, vec3 globalNormal) {
float offsetXY = depthBias.x;
vec4 projNormal = proj * localView * vec4(globalNormal, 0.0);
return offsetXY * projPos.w * 2.0 * inverseViewport * normalize(projNormal.xyz).xy;
}`)):(t.uniforms.add(new K3("transformNormalViewFromGlobal",r=>r.transformNormalViewFromGlobal)),t.uniforms.add(new ir("transformProjFromView",r=>r.transformProjFromView)),t.code.add(_`vec2 calculateProjectedBiasXY(vec4 projPos, vec3 globalNormal) {
float offsetXY = depthBias.x;
vec4 projNormal = transformProjFromView * vec4(transformNormalViewFromGlobal * globalNormal, 0.0);
return offsetXY * projPos.w * 2.0 * inverseViewport * normalize(projNormal.xyz).xy;
}`)),t.code.add(_`float _calculateProjectedBiasZ(vec4 projPos) {
float offsetZ = depthBias.y;
return sqrt(max(projPos.z,0.0)) * offsetZ;
}
vec4 adjustProjectedPosition(vec4 projPos, vec3 worldNormal, float lineWidth) {
vec2 offsetXY = calculateProjectedBiasXY(projPos, worldNormal);
if (!isNaN(offsetXY.x) && !isNaN(offsetXY.y)) {
projPos.xy += offsetXY;
}
projPos.z += _calculateProjectedBiasZ(projPos);
return projPos;
}`)}function aie(i,e){const t=i.fragment;t.constants.add("coverageTestThreshold","float",.01),e.antialiasing?t.code.add(_`#define discardByCoverage(radius, coverage) { if (coverage < coverageTestThreshold) discard; }`):t.code.add(_`#define discardByCoverage(radius, coverage) { float coverageLimit = radius <= 0.5 ? coverageTestThreshold : 0.75; if (coverage < coverageLimit) discard; }`)}function nie(i,e){const t=i.vertex;e.silhouette?(t.code.add(_`bool isSilhouetteEdge(vec3 viewDir, vec3 normalA, vec3 normalB) {
float faceAVisible = dot(viewDir, normalA);
float faceBVisible = dot(viewDir, normalB);
return faceAVisible * faceBVisible < 0.0;
}`),e.legacy?t.code.add(_`bool discardNonSilhouetteEdges(vec3 viewPos, vec3 worldPos) {
vec3 viewNormalA = _modelToViewNormal(normalA);
vec3 viewNormalB = _modelToViewNormal(normalB);
vec3 viewDir = -viewPos;
if (isSilhouetteEdge(viewDir, viewNormalA, viewNormalB)) {
return false;
}
gl_Position = vec4(10.0, 10.0, 10.0, 1.0);
return true;
}`):t.code.add(_`bool discardNonSilhouetteEdges(vec3 viewPos, vec3 worldPos) {
vec3 worldNormalA = _modelToWorldNormal(normalA);
vec3 worldNormalB = _modelToWorldNormal(normalB);
vec3 viewDir = -worldPos;
if (isSilhouetteEdge(viewDir, worldNormalA, worldNormalB)) {
return false;
}
gl_Position = vec4(10.0, 10.0, 10.0, 1.0);
return true;
}`)):t.code.add(_`bool discardNonSilhouetteEdges(vec3 viewPos, vec3 worldPos) {
return false;
}`)}function oie(i,e){const t=i.vertex;t.include(To),t.uniforms.add(new ue("distanceFalloffFactor",r=>r.distanceFalloffFactor)),t.code.add(_`float distanceBasedPerspectiveFactor(float distance) {
return clamp(sqrt(distanceFalloffFactor / distance), 0.0, 1.0);
}`),t.uniforms.add(vv("componentDataTex",r=>r.componentDataTexture,e.hasWebGL2Context?ms.None:ms.InvSize)),i.attributes.add(w.COMPONENTINDEX,"float"),t.constants.add("componentColorFieldOffset","float",0),t.constants.add("componentOtherFieldOffset","float",1),t.constants.add("componentVerticalOffsetFieldOffset","float",2),t.constants.add("componentFieldCount","float",3),t.constants.add("lineWidthFractionFactor","float",8),t.constants.add("extensionLengthOffset","float",128),t.constants.add("verticalOffsetScale","float",2*vS),t.code.add(_`
    vec2 _componentTextureCoords(float componentIndex, float fieldOffset) {
      float fieldIndex = componentFieldCount * componentIndex + fieldOffset;

      vec2 textureSizeInverse = ${sm(e,"componentDataTex",!0)};

      float colIndex = mod(fieldIndex, 1.0 / textureSizeInverse.x);
      float rowIndex = floor(fieldIndex * textureSizeInverse.x);

      return vec2(colIndex, rowIndex) + 0.5;
    }

    struct ComponentData {
      vec4 color;
      float lineWidth;
      float extensionLength;
      float type;
      float verticalOffset;
    };

    ComponentData readComponentData() {
      vec2 colorIndex = _componentTextureCoords(componentIndex, componentColorFieldOffset);
      vec2 otherIndex = _componentTextureCoords(componentIndex, componentOtherFieldOffset);
      vec2 verticalOffsetIndex = _componentTextureCoords(componentIndex, componentVerticalOffsetFieldOffset);

      vec4 colorValue = ${ia(e,"componentDataTex","colorIndex")};
      vec4 otherValue = ${ia(e,"componentDataTex","otherIndex")};
      float verticalOffset = (rgba2float(${ia(e,"componentDataTex","verticalOffsetIndex")}) - 0.5) * verticalOffsetScale;

      return ComponentData(
        vec4(colorValue.rgb, colorValue.a * otherValue.w), // otherValue.w stores separate opacity
        otherValue.x * (255.0 / lineWidthFractionFactor),
        otherValue.y * 255.0 - extensionLengthOffset,
        -(otherValue.z * 255.0) + 0.5, // SOLID (=0/255) needs to be > 0.0, SKETCHY (=1/255) needs to be <= 0;
        verticalOffset
      );
    }
  `),e.legacy?t.code.add(_`vec3 _modelToWorldNormal(vec3 normal) {
return (model * vec4(normal, 0.0)).xyz;
}
vec3 _modelToViewNormal(vec3 normal) {
return (localView * model * vec4(normal, 0.0)).xyz;
}`):(t.uniforms.add(new Rx("transformNormalGlobalFromModel",r=>r.transformNormalGlobalFromModel)),t.code.add(_`vec3 _modelToWorldNormal(vec3 normal) {
return transformNormalGlobalFromModel * normal;
}`)),e.silhouette?(i.attributes.add(w.NORMALA,"vec3"),i.attributes.add(w.NORMALB,"vec3"),t.code.add(_`vec3 worldNormal() {
return _modelToWorldNormal(normalize(normalA + normalB));
}`)):(i.attributes.add(w.NORMAL,"vec3"),t.code.add(_`vec3 worldNormal() {
return _modelToWorldNormal(normal);
}`)),e.legacy?t.code.add(_`void worldAndViewFromModelPosition(vec3 modelPos, float verticalOffset, out vec3 worldPos, out vec3 viewPos) {
worldPos = (model * vec4(modelPos, 1.0)).xyz;
viewPos = (localView * vec4(worldPos, 1.0)).xyz;
}`):(t.include(d2,e),t.include(d2,e),t.uniforms.add([new K3("transformViewFromCameraRelativeRS",r=>r.transformViewFromCameraRelativeRS),new Rx("transformWorldFromModelRS",r=>r.transformWorldFromModelRS),new u2("transformWorldFromModelTL",r=>r.transformWorldFromModelTL),new u2("transformWorldFromModelTH",r=>r.transformWorldFromModelTH),new si("transformWorldFromViewTL",r=>r.transformWorldFromViewTL),new si("transformWorldFromViewTH",r=>r.transformWorldFromViewTH)]),t.code.add(_`
      void worldAndViewFromModelPosition(vec3 modelPos, float verticalOffset, out vec3 worldPos, out vec3 viewPos) {
        vec3 rotatedModelPosition = transformWorldFromModelRS * modelPos;

        vec3 transformCameraRelativeFromModel = dpAdd(
          transformWorldFromModelTL,
          transformWorldFromModelTH,
          -transformWorldFromViewTL,
          -transformWorldFromViewTH
        );

        worldPos = transformCameraRelativeFromModel + rotatedModelPosition;

        if (verticalOffset != 0.0) {
          vec3 vUp = ${e.spherical?_`normalize(transformWorldFromModelTL + rotatedModelPosition);`:_`vec3(0.0, 0.0, 1.0);`}
          worldPos += verticalOffset * vUp;
        }

        viewPos = transformViewFromCameraRelativeRS * worldPos;
      }
    `)),t.uniforms.add(new ir("transformProjFromView",(r,s)=>s.camera.projectionMatrix)),t.code.add(_`vec4 projFromViewPosition(vec3 position) {
return transformProjFromView * vec4(position, 1.0);
}`),t.code.add(_`float calculateExtensionLength(float extensionLength, float lineLength) {
return extensionLength / (log2(max(1.0, 256.0 / lineLength)) * 0.2 + 1.0);
}`)}function lie(i){return i.mode===hr.SKETCH||i.mode===hr.MIXED}var hr,gd;(function(i){i[i.SOLID=0]="SOLID",i[i.SKETCH=1]="SKETCH",i[i.MIXED=2]="MIXED",i[i.COUNT=3]="COUNT"})(hr||(hr={})),function(i){i[i.REGULAR=0]="REGULAR",i[i.SILHOUETTE=1]="SILHOUETTE"}(gd||(gd={}));function wS(i,e){const t=i.vertex;switch(i.attributes.add(w.SIDENESS,"vec2"),e.mode===hr.MIXED?t.code.add(_`struct UnpackedAttributes {
vec2 sideness;
vec2 sidenessNorm;
float lineWidthPixels;
float extensionLengthPixels;
float type;
};`):t.code.add(_`struct UnpackedAttributes {
vec2 sideness;
vec2 sidenessNorm;
float lineWidthPixels;
float extensionLengthPixels;
};`),e.mode){case hr.MIXED:t.code.add(_`UnpackedAttributes unpackAttributes(ComponentData component) {
vec2 sidenessNorm = sideness;
vec2 sideness = sidenessNorm * 2.0 - 1.0;
float fType = component.type;
float extensionLengthPixels = component.extensionLength;
float lineWidth = component.lineWidth;
if (fType <= 0.0) {
extensionLengthPixels *= variantExtension * 2.0 - 1.0;
}
return UnpackedAttributes(sideness, sidenessNorm, lineWidth, extensionLengthPixels, fType);
}`);break;case hr.SKETCH:t.code.add(_`UnpackedAttributes unpackAttributes(ComponentData component) {
vec2 sidenessNorm = sideness;
vec2 sideness = sidenessNorm * 2.0 - 1.0;
float extensionLengthPixels = component.extensionLength;
extensionLengthPixels *= variantExtension * 2.0 - 1.0;
float lineWidth = component.lineWidth;
return UnpackedAttributes(sideness, sidenessNorm, lineWidth, extensionLengthPixels);
}`);break;case hr.SOLID:t.code.add(_`UnpackedAttributes unpackAttributes(ComponentData component) {
vec2 sidenessNorm = sideness;
vec2 sideness = sidenessNorm * 2.0 - 1.0;
float extensionLengthPixels = component.extensionLength;
float lineWidth = component.lineWidth;
return UnpackedAttributes(sideness, sidenessNorm, lineWidth, extensionLengthPixels);
}`);break;case hr.COUNT:break;default:_o(e.mode)}}function cie(i,e){const t=i.vertex;switch(i.include(wS,e),e.mode){case hr.SOLID:t.code.add(_`float calculateLineAmplitude(UnpackedAttributes unpackedAttributes) {
return 0.0;
}`);break;case hr.SKETCH:t.uniforms.add(new Tp("strokesAmplitude",r=>r.strokesTexture.amplitude)),t.code.add(_`float calculateLineAmplitude(UnpackedAttributes unpackedAttributes) {
return strokesAmplitude;
}`);break;case hr.MIXED:t.uniforms.add(new Tp("strokesAmplitude",r=>r.strokesTexture.amplitude)),t.code.add(_`float calculateLineAmplitude(UnpackedAttributes unpackedAttributes) {
float type = unpackedAttributes.type;
if (type <= 0.0) {
return strokesAmplitude;
}
else {
return 0.0;
}
}`)}}function hie(i,e){i.include(wS,e);const{vertex:t,fragment:r}=i;switch(lie(e)&&(t.uniforms.add(vv("strokesTexture",s=>s.strokesTexture.texture,e.hasWebGL2Context?ms.None:ms.InvSize)),t.uniforms.add([new Tp("strokesLog2Resolution",s=>Math.log2(s.strokesTexture.resolution)),new Tp("strokeVariants",s=>s.strokesTexture.variants)]),i.varyings.add("vStrokeUV","vec2"),r.uniforms.add([new zT("strokesTexture",s=>s.strokesTexture.texture),new Tp("strokesNormalizationScale",s=>s.strokesTexture.normalizationScale)]),t.code.add(_`
      void calculateStyleOutputsSketch(float lineLength, UnpackedAttributes unpackedAttributes) {
        vec2 sidenessNorm = unpackedAttributes.sidenessNorm;

        float lineIndex = clamp(ceil(log2(lineLength)), 0.0, strokesLog2Resolution);

        vec2 textureSizeInverse = ${sm(e,"strokesTexture",!0)};
        vStrokeUV = vec2(exp2(lineIndex) * sidenessNorm.y, lineIndex * strokeVariants + variantStroke + 0.5) * textureSizeInverse;
        vStrokeUV.x += variantOffset;
      }
    `),i.fragment.include(To),r.code.add(_`float calculateLineOffsetSketch() {
float offsetNorm = rgba2float(texture2D(strokesTexture, vStrokeUV));
return (offsetNorm - 0.5) * strokesNormalizationScale;
}
float calculateLinePressureSketch() {
return rgba2float(texture2D(strokesTexture, vStrokeUV + vec2(0.0, 0.5)));
}`)),e.mode){case hr.SOLID:t.code.add(_`void calculateStyleOutputs(UnpackedAttributes unpackedAttributes) {}`),r.code.add(_`float calculateLineOffset() {
return 0.0;
}
float calculateLinePressure() {
return 1.0;
}`);break;case hr.SKETCH:t.code.add(_`void calculateStyleOutputs(UnpackedAttributes unpackedAttributes)
{
calculateStyleOutputsSketch(vLineLengthPixels, unpackedAttributes);
}`),r.code.add(_`float calculateLineOffset() {
return calculateLineOffsetSketch();
}
float calculateLinePressure() {
return calculateLinePressureSketch();
}`);break;case hr.MIXED:i.varyings.add("vType","float"),t.code.add(_`void calculateStyleOutputs(UnpackedAttributes unpackedAttributes)
{
vType = unpackedAttributes.type;
if (unpackedAttributes.type <= 0.0) {
calculateStyleOutputsSketch(vLineLengthPixels, unpackedAttributes);
}
}`),r.code.add(_`float calculateLineOffset() {
if (vType <= 0.0) {
return calculateLineOffsetSketch();
}
else {
return 0.0;
}
}
float calculateLinePressure() {
if (vType <= 0.0) {
return calculateLinePressureSketch();
}
else {
return 1.0;
}
}`)}}function die(i){const e=new $t,{vertex:t,fragment:r}=e;return i.legacy&&t.uniforms.add([new dA("model"),new dA("localView")]),e.include(sie,i),e.include(oie,i),e.include(cie,i),e.include(wS,i),e.include(hie,i),e.include(Qr,i),e.include(nie,i),e.include(aie,i),e.include(Yl,i),e.varyings.add("vColor","vec4"),e.varyings.add("vRadius","float"),e.varyings.add("vPosition","vec3"),e.varyings.add("vWorldPosition","vec3"),e.varyings.add("vViewPos","vec3"),e.varyings.add("vLineLengthPixels","float"),e.varyings.add("vSizeFalloffFactor","float"),t.uniforms.add([new pi("pixelToNDC",(s,a)=>zt(uie,2/a.camera.fullViewport[2],2/a.camera.fullViewport[3])),new ai("viewport",(s,a)=>a.camera.fullViewport),new ue("pixelRatio",(s,a)=>a.camera.pixelRatio)]),e.attributes.add(w.POSITION0,"vec3"),e.attributes.add(w.POSITION1,"vec3"),e.attributes.add(w.VARIANTOFFSET,"float"),e.attributes.add(w.VARIANTSTROKE,"float"),e.attributes.add(w.VARIANTEXTENSION,"float"),t.code.add(_`
    const float opaqueCutoff = 1.0 / 255.0;

    void calculateGeometricOutputs(vec3 viewPosV0, vec3 viewPosV1, vec3 worldPosV0, vec3 worldPosV1, vec3 worldNormal, UnpackedAttributes unpackedAttributes) {
      vec2 sideness = unpackedAttributes.sideness;
      vec2 sidenessNorm = unpackedAttributes.sidenessNorm;

      vWorldPosition = mix(worldPosV0, worldPosV1, sidenessNorm.y).xyz;

      vec3 viewPos = mix(viewPosV0, viewPosV1, sidenessNorm.y);
      vViewPos = viewPos;

      vec4 projPosV0 = projFromViewPosition(viewPosV0);
      vec4 projPosV1 = projFromViewPosition(viewPosV1);
      vec4 projPos = projFromViewPosition(viewPos);

      vec3 screenSpaceLineNDC = (projPosV1.xyz / projPosV1.w - projPosV0.xyz / projPosV0.w);
      vec2 ndcToPixel = viewport.zw * 0.5;
      vec2 screenSpaceLinePixels = screenSpaceLineNDC.xy * ndcToPixel;
      float lineLengthPixels = length(screenSpaceLinePixels);

      float dzPerPixel = screenSpaceLineNDC.z / lineLengthPixels;
      vec2 screenSpaceDirection = screenSpaceLinePixels / lineLengthPixels;
      vec2 perpendicularScreenSpaceDirection = vec2(screenSpaceDirection.y, -screenSpaceDirection.x) * sideness.x;

      float falloffFactor = distanceBasedPerspectiveFactor(-viewPos.z) * pixelRatio;
      float lineWidthPixels = unpackedAttributes.lineWidthPixels * falloffFactor;

      float extensionLengthPixels = calculateExtensionLength(unpackedAttributes.extensionLengthPixels, lineLengthPixels) * falloffFactor;
      float lineAmplitudePixels = calculateLineAmplitude(unpackedAttributes) * pixelRatio;

      vSizeFalloffFactor = falloffFactor;

      float lineWidthAndAmplitudePixels = lineWidthPixels + lineAmplitudePixels + lineAmplitudePixels;
      float extendedLineLengthPixels = lineLengthPixels + extensionLengthPixels + extensionLengthPixels;

      ${i.antialiasing?_`
        const float aaPaddingPixels = 1.0;

        // Line size with padding
        float halfAAPaddedLineWidthAndAmplitudePixels = lineWidthAndAmplitudePixels * 0.5 + aaPaddingPixels;
        float aaPaddedRoundedCapSizePixels = lineWidthPixels * 0.5 + aaPaddingPixels;`:_`
        float halfAAPaddedLineWidthAndAmplitudePixels = max(lineWidthAndAmplitudePixels, 1.0) * 0.5;
        float aaPaddedRoundedCapSizePixels = max(lineWidthPixels, 1.0) * 0.5;`}

      // Half line width in NDC including padding for anti aliasing
      vec2 halfAAPaddedLineWidthAndAmplitudeNDC = halfAAPaddedLineWidthAndAmplitudePixels * pixelToNDC;
      vec2 aaPaddedRoundedCapSizeNDC = aaPaddedRoundedCapSizePixels * pixelToNDC;
      vec2 extensionLengthNDC = extensionLengthPixels * pixelToNDC;

      // Compute screen space position of vertex, offsetting for line size and end caps
      vec2 ndcOffset = (
          screenSpaceDirection * sideness.y * (aaPaddedRoundedCapSizeNDC + extensionLengthNDC)
        + perpendicularScreenSpaceDirection * halfAAPaddedLineWidthAndAmplitudeNDC
      );

      projPos.xy += ndcOffset * projPos.w;
      projPos.z += (dzPerPixel * (aaPaddedRoundedCapSizePixels + extensionLengthPixels)) * sideness.y * projPos.w;

      projPos = adjustProjectedPosition(projPos, worldNormal, 1.0 + max((lineWidthAndAmplitudePixels - 1.0) * 0.5, 0.0));

      // Line length with end caps
      float aaPaddedLineWithCapsLengthPixels = extendedLineLengthPixels + aaPaddedRoundedCapSizePixels + aaPaddedRoundedCapSizePixels;

      float pixelPositionAlongLine = aaPaddedLineWithCapsLengthPixels * sidenessNorm.y - aaPaddedRoundedCapSizePixels;

      // Position in pixels with origin at first vertex of line segment
      vPosition = vec3(
        halfAAPaddedLineWidthAndAmplitudePixels * sideness.x,
        pixelPositionAlongLine,
        pixelPositionAlongLine / extendedLineLengthPixels
      );

      // The line width radius in pixels
      vRadius = lineWidthPixels * 0.5;
      vLineLengthPixels = extendedLineLengthPixels;

      // discard short edges below a certain length threshold
      ${i.mode===hr.SKETCH?_`
        if (lineLengthPixels <= 3.0) {
          gl_Position = vec4(10.0, 10.0, 10.0, 1.0);
          return;
        }`:i.mode===hr.MIXED?_`
        if (lineLengthPixels <= 3.0 && unpackedAttributes.type <= 0.0) {
           gl_Position = vec4(10.0, 10.0, 10.0, 1.0);
           return;
        }`:""}
      gl_Position = projPos;
    }

    void main() {
      ComponentData component = readComponentData();
      UnpackedAttributes unpackedAttributes = unpackAttributes(component);

      vec3 worldPosV0, worldPosV1, viewPosV0, viewPosV1;
      worldAndViewFromModelPosition(position0, component.verticalOffset, worldPosV0, viewPosV0);
      worldAndViewFromModelPosition(position1, component.verticalOffset, worldPosV1, viewPosV1);

      // Component color
      vColor = component.color;

      // Discard fully transparent edges
      if (vColor.a < opaqueCutoff) {
        gl_Position = vec4(10.0, 10.0, 10.0, 1.0);
        return;
      }

      if (discardNonSilhouetteEdges(viewPosV0, worldPosV0)) {
        return;
      }

      // General geometric computation for all types of edges
      calculateGeometricOutputs(viewPosV0, viewPosV1, worldPosV0, worldPosV1, worldNormal(), unpackedAttributes);

      // Specific computation for different edge styles
      calculateStyleOutputs(unpackedAttributes);
    }
  `),r.code.add(_`
    vec2 lineWithCapsDistance(float radius, vec2 position, float lineLength) {
      float positionX = position.x - calculateLineOffset();

      if (radius < 1.0) {
        float coverageX = clamp(min(radius, positionX + 0.5) - max(-radius, positionX - 0.5), 0.0, 1.0);
        float coverageY = clamp(min(lineLength, position.y + 0.5) - max(0.0, position.y - 0.5), 0.0, 1.0);
        return vec2(0.5 - min(coverageX, coverageY), 0.0);
      }
      else {
        // Between -radius -> 0 for start cap, 0 for line, 0 -> radius
        float positionOnCap = position.y - clamp(position.y, 0.0, lineLength);

        vec2 lineToPosition = vec2(positionX, positionOnCap);
        return vec2(length(lineToPosition) - radius, positionOnCap / radius);
      }
    }

    void main() {
      ${i.hasMultipassTerrain?"terrainDepthTest(gl_FragCoord, vViewPos.z);":""}
      float radius = vRadius * calculateLinePressure();

      vec2 distance = lineWithCapsDistance(radius, vPosition.xy, vLineLengthPixels);
      float coverage = clamp(0.5 - distance.x, 0.0, 1.0);

      discardByCoverage(radius, coverage);
      discardBySlice(vWorldPosition);

      gl_FragColor = vec4(vColor.rgb, vColor.a * coverage);
    }
  `),e}const uie=$e();class dA extends Ch{constructor(e){super(e,"mat4")}}const pie=Object.freeze(Object.defineProperty({__proto__:null,build:die},Symbol.toStringTag,{value:"Module"}));let n4=class o4 extends Mt{initializeConfiguration(e,t){t.hasWebGL2Context=e.rctx.type===da.WEBGL2}initializeProgram(e){return new Rt(e.rctx,o4.shader.get().build(this.configuration),aM)}initializePipeline(e){return e.blendMinMax?qe({blending:Ar(ae.ONE,ae.ONE,ae.ZERO,ae.ONE,eM.ADD,e.blendMinMax.MAX),depthTest:{func:Fa.LEQUAL},colorWrite:at}):qe({depthTest:{func:Fa.LEQUAL},depthWrite:cn,colorWrite:at})}};n4.shader=new Dt(pie,()=>_e(()=>import("./EdgeShader.glsl-0f4ef304.js"),["assets/EdgeShader.glsl-0f4ef304.js","assets/calcite-8912bd40.js","assets/index-00759e4a.js","assets/index-5026a37a.css","assets/calcite-96fa36fd.css","assets/mat4f64-abdda1bb.js","assets/objectResourceUtils-782953c3.js","assets/devEnvironmentUtils-5002a058.js","assets/mat3f64-50f3b9f6.js","assets/BufferView-379a78a4.js","assets/vec33-69c9e93b.js","assets/DefaultMaterial_COLOR_GAMMA-6ed76d86.js","assets/types-e1c0a5bf.js","assets/enums-e2e92c86.js","assets/Version-aa0a1d91.js","assets/quat-7b70e9a8.js","assets/quatf64-f8f1c132.js","assets/resourceUtils-527631ac.js","assets/basicInterfaces-7449a8bf.js","assets/Indices-d8bff7b2.js","assets/NestedMap-1b5db22e.js","assets/requestImageUtils-d1ba3b36.js","assets/symbolColorUtils-c9d24716.js","assets/Util-6d3f024a.js","assets/sphere-d0e5285d.js","assets/VertexAttribute-15d1866a.js","assets/doublePrecisionUtils-e3c3d0d8.js","assets/OrderIndependentTransparency-5f7257d7.js","assets/Texture-563cf5e5.js","assets/FramebufferObject-8b18fc0c.js","assets/VertexElementDescriptor-2925c6af.js","assets/InterleavedLayout-d57c91d0.js","assets/vec3f32-01c06d8d.js","assets/plane-5e2b046c.js","assets/spatialReferenceEllipsoidUtils-afb35af9.js","assets/scaleUtils-d13015f2.js","assets/ElevationSamplerData-e3118b17.js","assets/Octree-499541ed.js","assets/edgeProcessing-20e12367.js","assets/deduplicate-769a6f51.js","assets/MeshComponent-788e605a.js","assets/earcut-61f7b102.js","assets/imageUtils-c2d0d1ae.js","assets/projection-5969b753.js","assets/ZoomMomentumEstimator-ef57e6a4.js","assets/floatRGBA-ca2b39ca.js","assets/dehydratedFeatures-3a140d03.js","assets/quantizationUtils-b3b2ae2a.js","assets/labelFormatUtils-71e1f841.js","assets/orientedBoundingBox-a14b97b5.js","assets/quatf32-51a323b8.js","assets/SnappingCandidate-970faec6.js","assets/callExpressionWithFeature-df1a8f01.js","assets/DefaultVertexAttributeLayouts-5f20d8dd.js","assets/geometryServiceUtils-a536bb19.js","assets/project-909a4219.js","assets/LercDecoder-65586d50.js","assets/VectorTile-d41a1f0f.js","assets/enums-fb086c25.js","assets/config-1337d16e.js","assets/TiledDisplayObject-419c008b.js","assets/DisplayObject-87c37b69.js","assets/rasterUtils-7694cc98.js","assets/resources-7587d8f4.js","assets/workerHelper-6131d203.js","assets/webgl-debug-7f880832.js","assets/RenderingContext-0f21aa0e.js","assets/ProgramCache-f29c900e.js","assets/Program-77209250.js","assets/MediaLayer-4c42fc2f.js","assets/MediaElementView-06baa4d4.js","assets/normalizeUtilsSync-3ea564a9.js","assets/resourceExtension-f31d9f10.js","assets/BoundsStore-00da37da.js","assets/PooledRBush-5a11bc7e.js","assets/prism-line-numbers-eff41b13.js","assets/label2-a2f37e65.js","assets/interactive-1de2e238.js","assets/loadable-6afd516d.js","assets/t9n-81df3a71.js","assets/observers-c89705b8.js","assets/icon-8e47fbec.js","assets/loader-c773e800.js","assets/guid-51402ee7.js","assets/prism-line-numbers-7c5d72ff.css"]));let ko=class extends Vn{constructor(){super(...arguments),this.mode=hr.SOLID,this.hasSlicePlane=!1,this.silhouette=!1,this.legacy=!1,this.antialiasing=!1,this.doublePrecisionRequiresObfuscation=!1,this.hasMultipassTerrain=!1,this.cullAboveGround=!1,this.spherical=!1}};d([D({count:hr.COUNT})],ko.prototype,"mode",void 0),d([D()],ko.prototype,"hasSlicePlane",void 0),d([D()],ko.prototype,"silhouette",void 0),d([D()],ko.prototype,"legacy",void 0),d([D()],ko.prototype,"antialiasing",void 0),d([D()],ko.prototype,"doublePrecisionRequiresObfuscation",void 0),d([D()],ko.prototype,"hasMultipassTerrain",void 0),d([D()],ko.prototype,"cullAboveGround",void 0),d([D()],ko.prototype,"spherical",void 0);const mie=8,ux=128,gie={type:"uber",hasSlicePlane:!1,strokesTexture:null,legacy:!0,spherical:!0},fie={solid:hr.SOLID,sketch:hr.SKETCH,uber:hr.MIXED};let px=class l4{constructor(e,t,r){this._rctx=e,this._shaderTechniqueRepository=t,this._configuration=new ko,this.refCount=0,this._renderables=new Set,this._sortedRenderables={[ht.TRANSPARENT]:{[ht.TRANSPARENT]:new At,[ht.OPAQUE]:new At},[ht.OPAQUE]:{[ht.TRANSPARENT]:new At,[ht.OPAQUE]:new At}},this._renderablesDirty=!1,this._drawParameters=new tie,this._settings={...gie,...r},this.key=l4.getKey(this._settings.type,this._settings.hasSlicePlane,this._settings.legacy);const s=this._settings.strokesTexture.variants;this.writerSettings={variants:s,reducedPrecision:Ot.TESTS_DISABLE_OPTIMIZATIONS},this._configuration.legacy=this._settings.legacy,this._configuration.mode=fie[this._settings.type],this._configuration.silhouette=!1,this._configuration.antialiasing=!!this._rctx.capabilities.blendMinMax,this._configuration.hasSlicePlane=this._settings.hasSlicePlane,this._configuration.doublePrecisionRequiresObfuscation=e.driverTest.doublePrecisionRequiresObfuscation.result,this._configuration.spherical=r.spherical}dispose(){this._technique=er(this._technique)}addRenderable(e){this._renderables.add(e),this._renderablesDirty=!0}removeRenderable(e){this._renderables.delete(e),this._renderablesDirty=!0}setRenderablesDirty(){this._renderablesDirty=!0}forEachRenderable(e,t){this._renderablesDirty&&this._sortRenderables(),this._sortedRenderables[t][ht.TRANSPARENT].forAll(e),this._sortedRenderables[t][ht.OPAQUE].forAll(e)}updateTechnique(e,t){return this._configuration.hasMultipassTerrain=!!e.multipassTerrain.enabled,this._configuration.cullAboveGround=!!e.multipassTerrain.cullAboveGround,this._configuration.silhouette=t,this._technique=this._shaderTechniqueRepository.releaseAndAcquire(n4,this._configuration,this._technique),this._technique}bindRegularEdges(e,t){return this._lastOriginId=null,this._rctx.bindTechnique(this.updateTechnique(t,!1),e,t)}bindSilhouetteEdges(e,t){return this._lastOriginId=null,this._rctx.bindTechnique(this.updateTechnique(t,!0),e,t)}renderRegularEdges(e,t,r,s,a){this._render(e,t,t.regular.vao,r,s,a)}renderSilhouetteEdges(e,t,r,s,a){this._render(e,t,t.silhouette.vao,r,s,a)}_render(e,t,r,s,a,n){n>0&&(this._bindDraw(e,t,s,a),this._rctx.bindVAO(r),this._rctx.capabilities.instancing.drawArraysInstanced(Ut.TRIANGLE_FAN,0,4,n))}_bindDraw(e,t,r,s){if(this._drawParameters.componentDataTexture=t.components.buffer.textureBuffer.texture,this._drawParameters.strokesTexture=this._settings.strokesTexture,"origin"in t.transform)this._lastOriginId!==t.transform.origin.origin.id&&(e.setUniformMatrix4fv("localView",t.transform.origin.viewMatrix),this._lastOriginId=t.transform.origin.origin.id),e.setUniformMatrix4fv("model",t.transform.modelMatrix),this._drawParameters.slicePlaneLocalOrigin=t.transform.origin.origin.vec3;else{const a=new Zv(t.transform.position),n=ic(uA,Jp(uA,t.transform.rotationScale));this._drawParameters.transformWorldFromModelTL=a.low,this._drawParameters.transformWorldFromModelTH=a.high,this._drawParameters.transformWorldFromModelRS=t.transform.rotationScale,this._drawParameters.transformNormalGlobalFromModel=n;const o=s.camera.viewInverseTransposeMatrix;j(this._drawParameters.slicePlaneLocalOrigin,o[3],o[7],o[11])}e.bindDraw(this._drawParameters,s,r)}_sortRenderables(){this._renderablesDirty=!1,this._sortedRenderables[ht.TRANSPARENT][ht.TRANSPARENT].clear(),this._sortedRenderables[ht.TRANSPARENT][ht.OPAQUE].clear(),this._sortedRenderables[ht.OPAQUE][ht.TRANSPARENT].clear(),this._sortedRenderables[ht.OPAQUE][ht.OPAQUE].clear(),this._renderables.forEach(t=>{t.objectTransparency!==ht.INVISIBLE&&t.edgeTransparency!==ht.INVISIBLE&&this._sortedRenderables[t.objectTransparency][t.edgeTransparency].push(t)});const e=(t,r)=>"origin"in t.transform?"origin"in r.transform?t.transform.origin.origin.id<r.transform.origin.origin.id?-1:t.transform.origin.origin.id>r.transform.origin.origin.id?1:0:1:0;this._sortedRenderables[ht.TRANSPARENT][ht.TRANSPARENT].sort(e),this._sortedRenderables[ht.TRANSPARENT][ht.OPAQUE].sort(e),this._sortedRenderables[ht.OPAQUE][ht.TRANSPARENT].sort(e),this._sortedRenderables[ht.OPAQUE][ht.OPAQUE].sort(e)}static getKey(e,t,r){return`edges-t:${e}:${t}:${r}`}};const uA=d3();let _ie=class extends e8{constructor(e){super("EdgeProcessingWorker","extract",{extract:t=>[t.dataBuffer],extractComponentsEdgeLocations:t=>[t.dataBuffer],extractEdgeLocations:t=>[t.dataBuffer]},e)}async process(e,t,r){if(r)return _6(e);const s=await this.invoke(new mx(e),t);return this._unpackOutput(s)}async extractEdgeLocations(e,t){const r=await this.invokeMethod("extractEdgeLocations",new mx(e),t);return a_(r)}async extractComponentsEdgeLocations(e,t){const r=await this.invokeMethod("extractComponentsEdgeLocations",new mx(e),t);return a_(r)}_unpackOutput(e){return{regular:{instancesData:a_(e.regular.instancesData),lodInfo:{lengths:new Float32Array(e.regular.lodInfo.lengths)}},silhouette:{instancesData:a_(e.silhouette.instancesData),lodInfo:{lengths:new Float32Array(e.silhouette.lodInfo.lengths)}},averageEdgeLength:e.averageEdgeLength}}},mx=class{constructor(e){this.dataBuffer=e.data.buffer,this.writerSettings=e.writerSettings,this.skipDeduplicate=e.skipDeduplicate,this.indices=Array.isArray(e.indices)?e.indices:e.indices.buffer,this.indicesType=Array.isArray(e.indices)?"Array":p9(e.indices)?"Uint32Array":"Uint16Array",this.indicesLength=e.indicesLength}};function yie(i){const t=qm.resolution,r=t/2,s=new Uint8Array(4*t*t),a=4*t*r,n=qm.amplitude,o=2*n,l=4*t,c=Math.log2(t)+1,h=qm.strokes.length;let u=(c-1)*h*l;for(const{distance:m,pressure:f}of qm.strokes){let y=m,b=f,x=u;for(let S=0;S<c;S++){S!==0&&(y=pA(y,$f.DISTANCE),b=pA(b,$f.PRESSURE));for(let C=0;C<qm.resolution;C++){const O=.5+(y?y[C%y.length]/o:0),R=b?b[C%b.length]:1;af(O,s,x),af(R,s,x+a),x+=4}x-=l*(h+1)}u+=l}const p=new Ai(i,{pixelFormat:St.RGBA,dataType:Zt.UNSIGNED_BYTE,hasMipmap:!1,samplingMode:Qt.LINEAR,width:t,height:t,wrapMode:kt.REPEAT},s);return new bie(t,o,n,h,p)}function pA(i,e){if(!i)return null;const t=i.length/2,r=vie*t,s=new Array(t);let a=0;const n=e===$f.PRESSURE;for(let o=0;o<i.length;o+=2){const l=(i[o]+i[o+1])/2;s[a++]=n?Math.min(r,1-(1-l)*mA):Math.min(r,l*mA)}return s}var $f;(function(i){i[i.DISTANCE=0]="DISTANCE",i[i.PRESSURE=1]="PRESSURE"})($f||($f={}));const vie=.1,mA=.5;let bie=class{constructor(e,t,r,s,a){this.resolution=e,this.normalizationScale=t,this.amplitude=r,this.variants=s,this.texture=a}dispose(){this.texture=De(this.texture)}};const qm={amplitude:8,resolution:256,strokes:[{distance:[-1.59027,-1.59426,-1.59674,-1.59766,-1.59702,-1.59479,-1.59095,-1.5855,-1.57843,-1.56973,-1.55942,-1.5475,-1.53398,-1.5189,-1.50226,-1.4841,-1.46446,-1.44337,-1.42088,-1.39703,-1.37188,-1.34547,-1.31786,-1.28912,-1.2593,-1.22847,-1.19668,-1.16402,-1.13053,-1.09629,-1.06137,-1.02582,-.98972,-.95313,-.91611,-.87872,-.84102,-.80306,-.76488,-.72654,-.68807,-.64952,-.61092,-.57232,-.53375,-.49527,-.45692,-.41874,-.38078,-.34309,-.3057,-.26867,-.23204,-.19585,-.16015,-.12497,-.09036,-.05634,-.02296,.00977,.04183,.07321,.10389,.13386,.16313,.19169,.21956,.24672,.27321,.299,.32413,.34858,.37237,.3955,.41798,.43981,.461,.48154,.50145,.52073,.53939,.55744,.57488,.5917,.6079,.62347,.63837,.65259,.66609,.67885,.69083,.70201,.71235,.72183,.73042,.73812,.7449,.75076,.7557,.75973,.76284,.76507,.76642,.76692,.76659,.76545,.76352,.76083,.7574,.75324,.74837,.74279,.73652,.72959,.72199,.71377,.70493,.69553,.68558,.67515,.66426,.65298,.64135,.62944,.6173,.60499,.59257,.58008,.56759,.55513,.54275,.5305,.51842,.50654,.4949,.48353,.47246,.4617,.45128,.44121,.43149,.42213,.41313,.40448,.39617,.38818,.3805,.37309,.36594,.35902,.35229,.34572,.33927,.33292,.32663,.32035,.31407,.30774,.30135,.29486,.28824,.28148,.27454,.26739,.26002,.25241,.24454,.23639,.22796,.21922,.21016,.20076,.19098,.18082,.17023,.1592,.14768,.13566,.1231,.10996,.09624,.08188,.06688,.05121,.03485,.01778,0,-.0185,-.03771,-.05763,-.07824,-.09952,-.12144,-.14396,-.16706,-.19069,-.21481,-.23938,-.26436,-.28971,-.31539,-.34136,-.36759,-.39404,-.42067,-.44746,-.47437,-.50136,-.52839,-.55544,-.58248,-.60948,-.63642,-.66329,-.6901,-.71684,-.74352,-.77015,-.79675,-.82332,-.84988,-.87644,-.90301,-.92958,-.95615,-.98272,-1.00926,-1.03575,-1.06217,-1.08847,-1.11463,-1.1406,-1.16633,-1.19178,-1.2169,-1.24164,-1.26595,-1.28979,-1.31312,-1.3359,-1.35809,-1.37963,-1.4005,-1.42064,-1.44,-1.45853,-1.47616,-1.49285,-1.50853,-1.52313,-1.53659,-1.54886,-1.55986,-1.56955,-1.57788,-1.5848],pressure:[-.01365,-.00206,.01025,.02327,.03696,.05129,.06619,.08163,.09755,.11393,.1307,.14784,.16531,.18308,.20111,.21938,.23786,.25651,.2753,.29419,.31315,.33215,.35115,.37015,.38913,.40806,.42694,.44576,.46449,.48313,.50167,.5201,.53839,.55653,.57448,.59222,.60971,.62692,.6438,.66033,.67648,.69221,.70753,.72242,.73688,.75093,.76456,.77779,.79063,.80309,.81517,.82686,.83817,.84911,.85967,.86987,.87972,.88924,.89845,.90734,.91594,.92425,.93229,.94005,.94754,.95475,.96166,.96826,.97451,.9804,.98588,.99092,.99549,.99957,.99685,.99381,.99131,.98936,.98796,.98711,.98681,.98706,.98787,.98923,.99113,.99357,.99654,1,.99607,.99171,.98695,.98181,.97634,.97057,.96452,.95824,.95175,.94506,.93818,.93113,.92389,.91647,.90887,.90109,.89314,.88501,.87672,.86831,.85978,.85119,.84256,.83393,.82533,.8168,.80836,.80002,.79181,.78374,.77582,.7681,.76059,.75331,.74629,.73955,.73311,.72697,.72116,.71568,.71054,.70572,.70121,.697,.69304,.68931,.68576,.68236,.67905,.67582,.67262,.66941,.66619,.66291,.65957,.65613,.65259,.64892,.6451,.6411,.6369,.63248,.62783,.62295,.61783,.61247,.60688,.60104,.59498,.58868,.58216,.57542,.56845,.56125,.5538,.5461,.53813,.52986,.52129,.51239,.50316,.49359,.4837,.47349,.46299,.45223,.44124,.43005,.41869,.40719,.39557,.38386,.37207,.36023,.34836,.33648,.32464,.31287,.30119,.28963,.27822,.26698,.25594,.2451,.23448,.22409,.21391,.20394,.19415,.18452,.17503,.16565,.15636,.14713,.13794,.1288,.11968,.11058,.10151,.09247,.08346,.07447,.06552,.05659,.0477,.03885,.03007,.02137,.01278,.00433,-.00393,-.012,-.01983,-.02738,-.03463,-.04155,-.0481,-.05429,-.0601,-.06553,-.07057,-.07524,-.07954,-.08347,-.08703,-.09022,-.09303,-.09544,-.09744,-.09898,-.10004,-.10059,-.1006,-.10005,-.09892,-.0972,-.09487,-.09192,-.08833,-.08409,-.07918,-.07357,-.06724,-.06019,-.0524,-.04386,-.03455,-.02448]},{distance:[-3.46259,-3.47131,-3.47668,-3.47863,-3.47712,-3.4721,-3.46352,-3.45138,-3.43566,-3.41635,-3.39347,-3.36704,-3.33709,-3.30368,-3.26684,-3.22667,-3.18322,-3.1366,-3.08689,-3.0342,-2.97865,-2.92036,-2.85946,-2.79607,-2.73034,-2.66241,-2.59242,-2.52052,-2.44686,-2.37159,-2.29485,-2.2168,-2.13757,-2.05731,-1.97616,-1.89426,-1.81174,-1.72875,-1.64543,-1.56191,-1.47833,-1.39483,-1.3115,-1.22847,-1.14581,-1.06361,-.98193,-.90083,-.82036,-.74054,-.66141,-.583,-.50532,-.4284,-.35228,-.277,-.20261,-.12916,-.05672,.01463,.08485,.15384,.22153,.28784,.35269,.41602,.47776,.53787,.59629,.653,.70799,.76123,.81274,.86253,.9106,.95698,1.0017,1.04477,1.0862,1.126,1.16415,1.20065,1.23546,1.26857,1.29994,1.32953,1.35731,1.38321,1.40719,1.42921,1.44922,1.46719,1.48309,1.49691,1.50862,1.51825,1.52581,1.53133,1.53486,1.53644,1.53616,1.53409,1.53031,1.52493,1.51803,1.50972,1.50009,1.48924,1.47725,1.46421,1.45019,1.43527,1.4195,1.40295,1.38568,1.36778,1.34929,1.3303,1.31087,1.29108,1.27099,1.25066,1.23018,1.2096,1.18898,1.16838,1.14785,1.12745,1.10721,1.08719,1.06741,1.04791,1.02871,1.00986,.99136,.97324,.95551,.93819,.92127,.90476,.88866,.87296,.85767,.84277,.82823,.81406,.80022,.7867,.77346,.76049,.74774,.73519,.72278,.71049,.69827,.68606,.67381,.66145,.64893,.63618,.62313,.60973,.5959,.5816,.56675,.5513,.53516,.51826,.50053,.4819,.46231,.44169,.42002,.39725,.37336,.34834,.32219,.2949,.2665,.23698,.20638,.17469,.14193,.10809,.07316,.03714,0,-.03827,-.07772,-.11836,-.16022,-.20332,-.24768,-.29332,-.34024,-.38844,-.43788,-.48854,-.54036,-.59329,-.64724,-.70211,-.75782,-.81425,-.87128,-.92881,-.98674,-1.04498,-1.10346,-1.1621,-1.22086,-1.27969,-1.33854,-1.3974,-1.45625,-1.51511,-1.57396,-1.63283,-1.69173,-1.75067,-1.80968,-1.86875,-1.9279,-1.98712,-2.04639,-2.10568,-2.16495,-2.22416,-2.28322,-2.34208,-2.40063,-2.4588,-2.51647,-2.57354,-2.62989,-2.68543,-2.74002,-2.79357,-2.84597,-2.89711,-2.94689,-2.99521,-3.04195,-3.087,-3.13023,-3.17152,-3.21075,-3.24779,-3.28252,-3.3148,-3.34451,-3.37154,-3.39577,-3.41709,-3.43539,-3.45059],pressure:[.87183,.87151,.87129,.87118,.87117,.87128,.87149,.87182,.87225,.8728,.87347,.87424,.87513,.87613,.87723,.87845,.87978,.88122,.88276,.88441,.88616,.88801,.88996,.892,.89414,.89637,.89868,.90108,.90356,.90611,.90874,.91144,.91421,.91704,.91993,.92287,.92587,.92892,.93201,.93514,.93831,.94151,.94474,.94799,.95126,.95456,.95786,.96118,.9645,.96783,.97116,.97448,.9778,.98111,.98441,.9877,.99096,.99421,.99742,.99938,.99622,.9931,.99001,.98697,.98397,.98101,.97811,.97526,.97246,.96972,.96703,.96441,.96185,.95935,.95691,.95455,.95225,.95002,.94786,.94577,.94376,.94182,.93995,.93817,.93646,.93483,.93328,.93181,.93042,.92911,.92788,.92673,.92566,.92467,.92376,.92293,.92217,.92149,.92088,.92034,.91987,.91947,.91913,.91886,.91864,.91849,.91838,.91833,.91834,.91839,.91849,.91863,.91883,.91907,.91935,.91968,.92005,.92046,.92092,.92142,.92195,.92253,.92314,.9238,.92449,.92521,.92598,.92677,.9276,.92847,.92936,.93029,.93125,.93224,.93325,.9343,.93537,.93646,.93758,.93872,.93988,.94106,.94225,.94346,.94469,.94593,.94718,.94844,.94971,.95098,.95226,.95354,.95482,.9561,.95738,.95867,.95995,.96122,.9625,.96377,.96504,.9663,.96757,.96883,.97009,.97135,.97261,.97387,.97513,.9764,.97767,.97895,.98023,.98153,.98284,.98416,.98549,.98684,.98821,.9896,.99101,.99244,.99389,.99537,.99688,.99842,1,.99839,.99675,.99508,.99336,.99161,.98982,.98799,.98613,.98422,.98228,.98029,.97827,.97622,.97414,.97202,.96987,.9677,.96551,.9633,.96107,.95882,.95656,.9543,.95202,.94975,.94747,.94519,.94292,.94065,.93838,.93613,.93388,.93164,.92941,.9272,.92499,.9228,.92062,.91846,.91631,.91418,.91207,.90998,.90792,.90588,.90387,.90189,.89995,.89804,.89617,.89434,.89256,.89083,.88914,.88752,.88595,.88443,.88299,.88161,.8803,.87907,.87791,.87683,.87584,.87494,.87412,.8734,.87278,.87225]},{distance:[.39335,.43437,.47737,.52234,.56923,.61801,.66864,.72109,.7753,.83123,.88882,.94801,1.00875,1.07097,1.13461,1.1996,1.26586,1.33333,1.40193,1.47158,1.54221,1.61373,1.68607,1.75913,1.83284,1.90711,1.98186,2.05699,2.13243,2.20809,2.28387,2.35971,2.4355,2.51117,2.58663,2.66179,2.73658,2.81092,2.88473,2.95792,3.03043,3.10217,3.17308,3.24309,3.31211,3.3801,3.44697,3.51267,3.57712,3.64028,3.70208,3.76247,3.8214,3.87881,3.93467,3.98892,4.04152,4.09244,4.14164,4.18908,4.23474,4.27859,4.32061,4.36077,4.39905,4.43544,4.46992,4.50249,4.53314,4.56185,4.58864,4.61349,4.63642,4.65745,4.67657,4.69381,4.7092,4.72274,4.73447,4.74441,4.75259,4.75903,4.76376,4.76682,4.76822,4.768,4.76618,4.76279,4.75786,4.75142,4.74348,4.73409,4.72326,4.71102,4.69739,4.68241,4.6661,4.64849,4.6296,4.60948,4.58816,4.56567,4.54204,4.51732,4.49154,4.46473,4.43694,4.4082,4.37854,4.348,4.31662,4.28443,4.25145,4.21773,4.1833,4.14819,4.11243,4.07606,4.03912,4.00162,3.96361,3.92512,3.88618,3.84683,3.80708,3.76697,3.72653,3.68579,3.64478,3.60351,3.56202,3.52033,3.47845,3.43642,3.39425,3.35196,3.30957,3.2671,3.22455,3.18196,3.13933,3.09668,3.05402,3.01136,2.96873,2.92613,2.88357,2.84108,2.79865,2.75631,2.71407,2.67195,2.62994,2.58807,2.54634,2.50477,2.46338,2.42216,2.38114,2.34032,2.29971,2.25933,2.21916,2.17923,2.13954,2.10008,2.06087,2.02189,1.98316,1.94468,1.90644,1.86845,1.83069,1.79316,1.75586,1.71877,1.68189,1.6452,1.60868,1.57232,1.53611,1.50004,1.46407,1.4282,1.39241,1.35668,1.321,1.28535,1.24972,1.2141,1.17849,1.14286,1.10723,1.07158,1.03593,1.00028,.96464,.92902,.89344,.85793,.8225,.78719,.75203,.71705,.68231,.64784,.61369,.57991,.54656,.51368,.48134,.44959,.41849,.3881,.35848,.32967,.30174,.27474,.24872,.22373,.19982,.17702,.15539,.13497,.11579,.09791,.08137,.06621,.05248,.04022,.02948,.02029,.01271,.00677,.00252,0,-76e-5,27e-5,.00314,.00788,.01451,.02307,.03357,.04604,.0605,.07697,.09546,.11599,.13858,.16322,.18992,.21869,.24952,.28241,.31735,.35434],pressure:[.95248,.95236,.95228,.95223,.95222,.95224,.95231,.95241,.95256,.95274,.95296,.95322,.95352,.95385,.95423,.95465,.9551,.9556,.95613,.9567,.95731,.95796,.95864,.95936,.96012,.96091,.96173,.96259,.96348,.9644,.96535,.96633,.96734,.96838,.96944,.97053,.97164,.97277,.97393,.9751,.97629,.9775,.97873,.97997,.98122,.98249,.98376,.98505,.98634,.98763,.98893,.99023,.99154,.99284,.99414,.99544,.99673,.99802,.9993,.99942,.99816,.99691,.99568,.99445,.99324,.99205,.99087,.98972,.98858,.98746,.98636,.98528,.98423,.9832,.98219,.98121,.98025,.97931,.9784,.97752,.97666,.97582,.97501,.97423,.97347,.97274,.97203,.97135,.9707,.97007,.96948,.9689,.96836,.96784,.96735,.96689,.96646,.96605,.96567,.96533,.965,.96471,.96445,.96421,.964,.96382,.96367,.96355,.96346,.96339,.96335,.96334,.96336,.9634,.96348,.96358,.9637,.96385,.96403,.96423,.96446,.96471,.96499,.96529,.96561,.96595,.96631,.96669,.96709,.96751,.96795,.9684,.96887,.96935,.96984,.97035,.97087,.9714,.97194,.97249,.97304,.97361,.97418,.97476,.97534,.97592,.97651,.97711,.9777,.9783,.9789,.9795,.9801,.9807,.9813,.9819,.9825,.98309,.98369,.98428,.98486,.98545,.98603,.98661,.98718,.98775,.98832,.98888,.98944,.99,.99056,.99112,.99167,.99223,.99279,.99335,.99392,.99449,.99507,.99565,.99624,.99684,.99745,.99807,.9987,.99934,1,.99933,.99866,.99797,.99727,.99656,.99583,.9951,.99435,.99359,.99283,.99205,.99126,.99046,.98966,.98885,.98803,.9872,.98637,.98554,.9847,.98387,.98303,.98219,.98134,.9805,.97967,.97883,.978,.97717,.97634,.97552,.97471,.97389,.97309,.97229,.9715,.97071,.96993,.96915,.96838,.96762,.96687,.96612,.96539,.96466,.96395,.96324,.96255,.96187,.9612,.96055,.95991,.95929,.95869,.95811,.95754,.957,.95648,.95599,.95552,.95508,.95467,.95428,.95393,.9536,.95331,.95305,.95283,.95264]},{distance:[2.85606,2.86149,2.86432,2.8645,2.862,2.85686,2.84912,2.83886,2.82618,2.81117,2.79393,2.77456,2.75314,2.72975,2.70447,2.67734,2.64844,2.61784,2.58564,2.55196,2.5169,2.48057,2.44305,2.40438,2.36462,2.32383,2.28208,2.23943,2.19591,2.15153,2.10628,2.06016,2.01321,1.96548,1.91702,1.86793,1.8183,1.76829,1.71803,1.66767,1.61737,1.56726,1.51746,1.46803,1.41902,1.37044,1.32228,1.27452,1.22716,1.18023,1.13376,1.08781,1.04244,.99769,.95357,.91003,.86701,.82447,.78238,.74069,.69938,.65836,.61758,.57699,.53656,.49627,.45611,.41611,.37632,.33683,.29776,.25924,.22141,.18441,.14839,.11346,.07972,.04727,.01619,-.01348,-.0417,-.0684,-.09351,-.11698,-.13875,-.1588,-.17713,-.19381,-.20889,-.22242,-.23444,-.24501,-.25421,-.26216,-.26897,-.27473,-.27951,-.28336,-.28631,-.28836,-.28948,-.28963,-.28873,-.28673,-.28355,-.27916,-.27354,-.26673,-.25878,-.2498,-.23992,-.22929,-.21802,-.20623,-.19398,-.18134,-.16836,-.1551,-.14163,-.12809,-.11461,-.1013,-.08826,-.07557,-.06335,-.0517,-.04077,-.03065,-.02143,-.01321,-.00606,0,.00496,.00888,.01181,.01385,.01511,.0157,.01574,.01533,.01458,.01358,.0124,.01112,.00979,.00851,.00738,.0065,.006,.00596,.00646,.00754,.00924,.01161,.01471,.01858,.02323,.02865,.03481,.04169,.0493,.05765,.06677,.07671,.08754,.09934,.11222,.12628,.14159,.15823,.17624,.19561,.21632,.23828,.26142,.28563,.31083,.33696,.36397,.39185,.42057,.4501,.48036,.51125,.54264,.5744,.60646,.63871,.67105,.70337,.73556,.76751,.79918,.83048,.86139,.8919,.92202,.95184,.98144,1.01094,1.04045,1.0701,1.10002,1.13029,1.16103,1.1923,1.22416,1.25664,1.28979,1.32364,1.35824,1.39363,1.42985,1.4669,1.50475,1.54332,1.58252,1.62227,1.6625,1.70312,1.744,1.78501,1.82598,1.8668,1.90734,1.94754,1.98732,2.02666,2.06555,2.10402,2.1421,2.17985,2.2173,2.25448,2.29139,2.328,2.36424,2.4,2.43515,2.46955,2.50309,2.53565,2.56717,2.59761,2.62692,2.65505,2.68191,2.7074,2.73138,2.75375,2.7744,2.79324,2.81017,2.82504,2.83772,2.8481],pressure:[.22758,.23641,.24578,.25568,.26609,.27699,.28835,.30016,.31237,.32495,.33789,.35113,.36466,.37843,.39241,.40658,.4209,.43535,.44989,.4645,.47916,.49385,.50853,.5232,.53784,.55243,.56696,.58141,.59578,.61004,.62419,.63821,.65209,.6658,.67934,.69268,.70582,.71873,.73139,.7438,.75594,.76779,.77935,.79061,.80156,.81221,.82254,.83258,.84231,.85176,.86091,.86978,.87837,.88669,.89473,.9025,.91,.91725,.92425,.931,.93752,.9438,.94985,.95566,.96124,.96658,.97168,.97652,.98109,.98539,.98939,.99309,.99646,.99949,.99783,.99552,.99361,.99209,.99098,.99029,.99003,.99019,.99079,.99181,.99324,.9951,.99735,1,.99698,.99361,.98992,.98592,.98163,.97709,.97231,.96731,.96212,.95676,.95122,.94554,.93973,.93378,.92773,.92157,.91532,.90899,.90258,.89612,.88961,.88308,.87653,.87,.8635,.85705,.85068,.8444,.83823,.83219,.82628,.82052,.81493,.80952,.8043,.79929,.7945,.78994,.78561,.78151,.77765,.77402,.77062,.76742,.76443,.76161,.75896,.75645,.75406,.75175,.74951,.7473,.74511,.74289,.74064,.73833,.73592,.73341,.73078,.728,.72507,.72197,.71869,.71522,.71156,.70769,.70363,.69936,.69489,.69021,.68533,.68023,.67492,.66939,.66363,.65765,.65145,.64501,.63833,.63143,.62428,.61691,.60931,.60148,.59344,.58521,.57679,.5682,.55948,.55063,.54167,.53264,.52354,.51439,.50522,.49603,.48686,.47773,.46865,.45964,.45072,.44192,.43324,.42469,.41629,.40804,.39994,.392,.3842,.37655,.36903,.36164,.35437,.3472,.34012,.33312,.3262,.31933,.31251,.30574,.299,.2923,.28563,.27899,.27239,.26583,.25933,.25288,.24652,.24025,.2341,.22808,.22221,.21653,.21104,.20576,.20072,.19592,.19138,.18712,.18313,.17943,.17602,.17292,.17013,.16766,.16551,.16369,.16222,.1611,.16036,.16001,.16007,.16055,.16148,.16286,.16471,.16705,.16988,.17321,.17706,.18144,.18636,.19182,.19785,.20443,.21158,.2193]},{distance:[-2.31317,-2.3191,-2.32189,-2.32154,-2.31811,-2.31174,-2.30254,-2.29062,-2.27609,-2.25904,-2.23954,-2.21767,-2.19355,-2.16732,-2.13907,-2.10885,-2.07672,-2.04268,-2.00677,-1.96911,-1.92985,-1.88914,-1.84713,-1.80397,-1.75979,-1.71467,-1.66864,-1.62171,-1.57395,-1.52546,-1.47625,-1.42628,-1.3755,-1.32384,-1.27131,-1.218,-1.16408,-1.10972,-1.05508,-1.00031,-.94551,-.89077,-.83615,-.7817,-.72757,-.6739,-.62076,-.56821,-.51625,-.46484,-.41397,-.36366,-.314,-.26506,-.21689,-.16957,-.12316,-.07766,-.03301,.01085,.05399,.09643,.13827,.17967,.22079,.26176,.30265,.34342,.38397,.42414,.46381,.50285,.54115,.57863,.61524,.65093,.6856,.71914,.75153,.78275,.81283,.84182,.86972,.89651,.92208,.94634,.96919,.99052,1.01025,1.02835,1.04484,1.05976,1.07309,1.08479,1.09492,1.1036,1.11096,1.11714,1.12224,1.12627,1.12916,1.13083,1.13125,1.13036,1.12816,1.12466,1.11992,1.11397,1.10677,1.09827,1.08849,1.07746,1.06527,1.05203,1.03786,1.02283,1.00695,.99025,.97279,.9546,.93573,.9163,.8965,.8765,.85647,.83652,.81687,.79775,.77939,.76199,.74568,.73049,.71635,.70316,.69082,.67925,.66834,.65804,.64831,.63911,.63032,.62184,.61363,.60564,.59788,.59036,.58308,.57597,.5689,.56177,.55447,.5469,.53896,.53062,.5219,.51283,.5034,.49355,.48335,.47287,.46223,.45154,.44085,.43012,.41923,.40805,.39648,.38441,.37176,.35849,.34458,.32999,.31461,.29833,.28109,.26288,.2437,.22361,.20265,.18082,.15807,.13434,.1096,.0838,.0569,.02894,0,-.0298,-.0604,-.09173,-.12364,-.15594,-.18843,-.22092,-.25331,-.28559,-.31781,-.35006,-.38244,-.41502,-.44785,-.48098,-.5144,-.54811,-.58218,-.61666,-.65153,-.68677,-.72232,-.75807,-.79397,-.83002,-.86628,-.90281,-.93968,-.97693,-1.01465,-1.05282,-1.09139,-1.13031,-1.16956,-1.20917,-1.24905,-1.28907,-1.32908,-1.36891,-1.40844,-1.44765,-1.48658,-1.52527,-1.56376,-1.60206,-1.64016,-1.67801,-1.71552,-1.75264,-1.78936,-1.8257,-1.86161,-1.89702,-1.93182,-1.96584,-1.99894,-2.03102,-2.06203,-2.0919,-2.12056,-2.14794,-2.17397,-2.19852,-2.22138,-2.24235,-2.26129,-2.27805,-2.29243,-2.30422],pressure:[.9681,.97424,.98046,.98674,.99309,.9995,.99404,.98754,.981,.97444,.96785,.96124,.95462,.94801,.94139,.93479,.92822,.92167,.91515,.90868,.90225,.89589,.88959,.88336,.87722,.87115,.86519,.85932,.85356,.84792,.84239,.83699,.83173,.8266,.82162,.81679,.81211,.80759,.80324,.79906,.79505,.79121,.78756,.78409,.78081,.77771,.77481,.77211,.76959,.76728,.76516,.76324,.76153,.76001,.75869,.75757,.75665,.75593,.7554,.75507,.75493,.75498,.75523,.75565,.75627,.75706,.75803,.75917,.76049,.76197,.76361,.76541,.76737,.76947,.77172,.77409,.7766,.77923,.78198,.78484,.7878,.79086,.79401,.79724,.80055,.80394,.8074,.81092,.8145,.81813,.82182,.82556,.82934,.83317,.83703,.84093,.84487,.84884,.85284,.85687,.86094,.86503,.86915,.87329,.87746,.88166,.88587,.89011,.89436,.89863,.90291,.9072,.91149,.91579,.92009,.92438,.92867,.93295,.9372,.94144,.94566,.94985,.954,.95812,.96219,.96623,.97021,.97415,.97802,.98184,.9856,.9893,.99293,.9965,1,.99657,.9932,.98991,.98668,.98352,.98042,.97738,.9744,.97148,.9686,.96577,.96298,.96023,.95751,.95482,.95214,.94949,.94684,.9442,.94156,.93892,.93627,.93361,.93094,.92825,.92555,.92284,.9201,.91735,.91458,.91179,.90899,.90616,.90332,.90047,.8976,.89472,.89183,.88893,.88603,.88314,.88024,.87735,.87448,.87162,.86878,.86597,.86319,.86044,.85774,.85508,.85247,.84993,.84744,.84503,.84269,.84042,.83825,.83616,.83417,.83227,.83048,.8288,.82724,.82578,.82445,.82324,.82215,.82119,.82037,.81967,.81911,.81868,.81839,.81824,.81823,.81835,.81862,.81903,.81957,.82026,.82109,.82206,.82317,.82443,.82583,.82737,.82906,.83089,.83287,.83499,.83726,.83968,.84223,.84494,.84778,.85077,.8539,.85717,.86058,.86412,.86781,.87163,.87559,.87968,.88391,.88826,.89275,.89737,.90211,.90698,.91198,.91709,.92233,.92768,.93315,.93873,.94441,.95019,.95607,.96205]},{distance:[4.72925,4.81721,4.9037,4.98859,5.07177,5.15311,5.23249,5.3098,5.38491,5.45772,5.52811,5.59598,5.66122,5.72375,5.78346,5.84028,5.8941,5.94486,5.99248,6.03689,6.07803,6.11584,6.15028,6.18128,6.20882,6.23285,6.25336,6.27031,6.28369,6.29348,6.29969,6.3023,6.30133,6.29678,6.28867,6.27703,6.26187,6.24324,6.22116,6.19567,6.16683,6.13468,6.09928,6.06068,6.01896,5.97417,5.92639,5.87569,5.82217,5.76589,5.70696,5.64545,5.58147,5.5151,5.44644,5.37559,5.30265,5.2277,5.15085,5.0722,4.99184,4.90987,4.82639,4.74151,4.65533,4.56794,4.47945,4.38996,4.29959,4.20843,4.11658,4.02416,3.93125,3.83796,3.74437,3.65057,3.55666,3.46272,3.36884,3.27509,3.18155,3.08831,2.99545,2.90303,2.81114,2.71984,2.62922,2.53933,2.45026,2.36207,2.27484,2.18862,2.10349,2.01951,1.93675,1.85528,1.77515,1.69644,1.61919,1.54348,1.46935,1.39685,1.32605,1.25698,1.18967,1.12417,1.06049,.99863,.93862,.88044,.82408,.76953,.71676,.66574,.61644,.56882,.52282,.47841,.43553,.39413,.35414,.31551,.27817,.24206,.20712,.17328,.14048,.10866,.07776,.04772,.01848,-.00999,-.03776,-.06487,-.09134,-.11721,-.14251,-.16725,-.19144,-.21509,-.2382,-.26076,-.28275,-.30416,-.32496,-.34511,-.36459,-.38334,-.40134,-.41852,-.43485,-.45026,-.46471,-.47815,-.49052,-.50179,-.51189,-.52081,-.52849,-.5349,-.54003,-.54383,-.54627,-.54734,-.54702,-.54528,-.54211,-.53752,-.53149,-.52403,-.51515,-.50487,-.4932,-.48015,-.46575,-.45001,-.43297,-.41463,-.39503,-.37419,-.35213,-.32887,-.30443,-.27885,-.25214,-.22432,-.19541,-.16544,-.13442,-.10235,-.06926,-.03514,0,.03616,.07336,.11159,.15088,.19125,.23272,.27531,.31906,.36401,.41019,.45764,.5064,.55651,.60802,.66096,.71538,.77129,.82874,.88776,.94836,1.01056,1.07438,1.13982,1.20687,1.27554,1.34581,1.41766,1.49107,1.56599,1.64239,1.72025,1.79951,1.88013,1.96209,2.04532,2.12979,2.21546,2.30226,2.39017,2.47911,2.56905,2.65991,2.75164,2.84416,2.93742,3.03133,3.12582,3.2208,3.31619,3.41191,3.50785,3.60393,3.70006,3.79612,3.89202,3.98765,4.08291,4.17767,4.27182,4.36525,4.45783,4.54944,4.63995],pressure:[.30942,.30838,.30765,.30724,.30715,.30738,.30795,.30884,.31007,.31164,.31354,.31578,.31837,.32129,.32455,.32815,.33209,.33636,.34097,.34591,.35117,.35675,.36265,.36887,.37539,.38221,.38933,.39674,.40442,.41238,.4206,.42907,.43779,.44675,.45593,.46533,.47493,.48473,.49471,.50486,.51517,.52563,.53623,.54694,.55777,.5687,.57971,.59079,.60194,.61313,.62435,.6356,.64686,.65811,.66935,.68056,.69174,.70286,.71391,.72489,.73579,.74659,.75728,.76785,.7783,.7886,.79876,.80877,.81861,.82827,.83776,.84706,.85617,.86507,.87378,.88227,.89056,.89863,.90649,.91412,.92153,.92872,.93568,.94241,.94892,.95519,.96122,.96702,.97258,.97791,.98299,.98783,.99242,.99677,.99911,.99525,.99164,.98827,.98515,.98228,.97966,.97728,.97514,.97324,.97159,.97017,.96898,.96801,.96727,.96674,.96641,.96629,.96635,.96661,.96703,.96762,.96838,.96928,.97032,.97149,.97279,.9742,.97572,.97734,.97905,.98085,.98273,.98468,.98669,.98877,.99091,.99311,.99535,.99765,1,.9976,.99516,.99267,.99014,.98755,.98491,.98222,.97947,.97666,.97378,.97083,.96781,.96471,.96153,.95826,.9549,.95144,.94787,.9442,.94042,.93651,.93249,.92834,.92407,.91966,.91512,.91045,.90564,.90069,.8956,.89037,.885,.87949,.87384,.86806,.86214,.85608,.84988,.84356,.83711,.83053,.82383,.81702,.81009,.80306,.79594,.78872,.78141,.77403,.76657,.75905,.75148,.74385,.73619,.72849,.72076,.71302,.70526,.69749,.68972,.68195,.67419,.66644,.65871,.65099,.64329,.63561,.62795,.62032,.61271,.60512,.59755,.59001,.58248,.57497,.56749,.56002,.55256,.54512,.5377,.5303,.52291,.51554,.50819,.50087,.49358,.48632,.4791,.47192,.4648,.45773,.45072,.44378,.43692,.43015,.42346,.41687,.41039,.40403,.39779,.39168,.38571,.37989,.37423,.36873,.36342,.35828,.35335,.34862,.34409,.3398,.33573,.3319,.32831,.32498,.32192,.31912,.3166,.31436,.31242,.31077]}]};function gA(i){let e=null;for(const t of i){const r=t.type;if(xie(t)){if(P(e))e=r;else if(e!==r)return"uber"}}return g(e)?e:"uber"}function fA(i){let e=ht.INVISIBLE;for(const{material:t}of i)if(c4(t)){if(t.color[3]*t.opacity<1)return ht.TRANSPARENT;e=ht.OPAQUE}return e}function _A(i){let e=ht.INVISIBLE;for(const{material:t}of i)if(c4(t)){switch(t.objectTransparency){case ht.TRANSPARENT:case ht.INVISIBLE:return ht.TRANSPARENT;case ht.OPAQUE:if(t.opacity<1)return ht.TRANSPARENT}e=ht.OPAQUE}return e}function c4(i){return i.size*i.color[3]*i.opacity>0}function xie(i){return i.size*i.color[3]>0}function yA(i,e,t,r){for(let s=0;s<i.length;s++){const a=i[s].index,n=e[s],o=e[s+1];if(r)for(let l=n;l<o;l++){const c=r[l];t.set(c,a)}else for(let l=n;l<o;l++)t.set(l,a)}}let Kn=class extends Ie{constructor(i){super(i),this._updatingHandles=new av,this._perObjectData=new Map,this._perObjectDataEvictionCache=new Set,this._renderers=new Map,this._gpuMemoryUsage=0,this._workerAbort=new AbortController,this._tmpModelPosition=T(),this._localOrigins=new Kte(new kC(i.renderSR))}initialize(){this._worker=new _ie(this.schedule),this._componentColorManager=new T5(this.rctx,3);const i=y6.createBuffer(4);for(let e=0;e<4;e++)i.sideness.set(e,0,e===0||e===3?0:1),i.sideness.set(e,1,e===0||e===1?0:1);this._verticesBufferObject=gs.createVertex(this.rctx,ca.STATIC_DRAW,i.buffer)}destroy(){this.destroyed||(this._perObjectData.forEach(i=>this._discardObjectEntry(i)),this._perObjectData.clear(),this._strokesTexture=De(this._strokesTexture),this._componentColorManager=Te(this._componentColorManager),this._workerAbort.abort(),this._worker.destroy(),this._verticesBufferObject=De(this._verticesBufferObject),this._renderers.clear(),this._updatingHandles.destroy())}get updating(){return this._updatingHandles.updating}get usedMemory(){return this._gpuMemoryUsage}shouldRender(){return this._renderers.size>0}async addComponentObject(i,e,t,r,s,a,n,o){if(this.hasObject(i))return this.getObjectMemoryUsage(i);let l;const c=new bA(new Promise(u=>l=u),t.center,t.radius);this._perObjectData.set(i,c);const h=await this._updatingHandles.addPromise(this._addComponentGeometry(e,c,r,s,a,n,o));return this.setNeedsRender(),l(),h}async addOrUpdateObject3D(i,e,t,r){if(this.destroyed)return void Pe.getLogger(this.declaredClass).warn("Attempt to add an object to a destroyed instance");const s=this._perObjectData.get(i);let a;(s==null?void 0:s.renderables.length)>0&&this._perObjectDataEvictionCache.add(s);const n=i.boundingVolumeWorldSpace.bounds,o=new bA(new Promise(c=>a=c),OT(n),f3(n));this._perObjectData.set(i,o);const l=new Array;if(t.mergeGeometries&&i.geometries.length>1&&wie(i))l.push(this._addObjectMergedGeometries(i,o,e,t,r));else for(let c=0;c<i.geometries.length;c++){const h=i.geometries[c];h.material.supportsEdges&&l.push(this._addGeometry(i,o,h,e[0],t,r))}await this._updatingHandles.addPromise(Promise.all(l)),this._perObjectDataEvictionCache.delete(o),this._discardObjectEntry(s),this.setNeedsRender(),a()}_discardObjectEntry(i){i&&(i.renderables.length&&(i.renderables.forEach(e=>this._removeRenderable(e)),this.setNeedsRender()),i.loaded=null)}hasObject(i){return this._perObjectData.has(i)}async updateAllComponentOpacities(i,e){const t=await this._updatingHandles.addPromise(this._getObjectEntry(i));if(P(t))return;const r=e instanceof Array?s=>e[s]:()=>e;t.renderables.forEach(s=>{const a=s.components.meta.length;for(let n=0;n<a;n++){const o=r(n),l=s.components.meta[n],c=l.index;l.material.opacity=o,s.components.buffer.textureBuffer.setDataElement(c,1,3,255*o)}this._updateTransparency(s)}),this.setNeedsRender()}async getObjectMemoryUsage(i){const e=await this._getObjectEntry(i);return g(e)?e.renderables.reduce((t,r)=>t+r.statistics.gpuMemoryUsage,0):0}async updateAllComponentMaterials(i,e,t,r){const s=i instanceof hc,a=!!t.hasSlicePlane,n=gA(e),o=px.getKey(n,a,s),l=await this._updatingHandles.addPromise(this._getObjectEntry(i));P(l)||(l.renderables.forEach(c=>{if(o!==c.rendererKey){const h=this._renderers.get(c.rendererKey),u=this._acquireRenderer(n,a,s);h.removeRenderable(c),--h.refCount,c.rendererKey=o,u.addRenderable(c)}for(let h=0;h<e.length;h++)c.components.meta[h].material=e[h];r&&this._updateComponentBuffer(c.components),this._updateTransparency(c)}),this.setNeedsRender())}async updateAllVerticalOffsets(i,e){const t=await this._updatingHandles.addPromise(this._getObjectEntry(i));P(t)||(t.renderables.forEach(r=>{const s=r.components.meta;for(let a=0;a<s.length;a++)r.components.meta[a].verticalOffset=(e==null?void 0:e[a])??0;this._updateComponentBuffer(r.components)}),this.setNeedsRender())}async updateObjectVisibility(i,e){const t=await this._updatingHandles.addPromise(this._getObjectEntry(i));g(t)&&(t.renderables.forEach(r=>r.visible=e),this.setNeedsRender())}removeObject(i){const e=this._perObjectData.get(i);e&&(this._perObjectData.delete(i),this._discardObjectEntry(e))}async _getObjectEntry(i){const e=this._perObjectData.get(i);if(!e)throw new Error("no object");return await e.loaded,e.loaded==null?null:e}render(i,e){if(P(this._componentColorManager))return;this._localOrigins.updateViewMatrices(i.camera.viewMatrix);const t=i.camera.viewInverseTransposeMatrix,r=T(),s=new Zv;let a=0,n=0;if(this._renderers.forEach(l=>{if(l.refCount===0)this._renderers.delete(l.key),l.dispose();else{let c=!0,h=!0;l.forEachRenderable(u=>{u.visible&&(a+=u.statistics.averageEdgeLength,n++,c&&u.regular&&(l.updateTechnique(i,!1),c=!1),h&&u.silhouette&&(l.updateTechnique(i,!0),h=!1))},e)}}),this._componentColorManager.garbageCollect(),this._componentColorManager.updateTextures(),n===0)return;const o=new eie(40*a/n,e);j(r,t[3],t[7],t[11]),s.set(r),H(o.transformWorldFromViewTH,s.high),H(o.transformWorldFromViewTL,s.low),Xl(o.transformViewFromCameraRelativeRS,i.camera.viewMatrix),ic(CA,o.transformViewFromCameraRelativeRS),Jp(o.transformNormalViewFromGlobal,CA),o.transformProjFromView=i.camera.projectionMatrix,this._updateObjectCameraDistances(i),this._renderers.forEach(l=>{this._renderRegularEdges(l,i,o),this._renderSilhouetteEdges(l,i,o)})}_updateTransparency(i){const e=fA(i.components.meta),t=_A(i.components.meta);e===i.edgeTransparency&&t===i.objectTransparency||(i.edgeTransparency=e,i.objectTransparency=t,this._renderers.get(i.rendererKey).setRenderablesDirty())}_computeModelTransformWithLocalOrigin(i,e,t){i.getCombinedStaticTransformation(e,t);const r=g(e.localOrigin)?this._localOrigins.register(e.localOrigin):this._localOrigins.acquire(j(this._tmpModelPosition,t[12],t[13],t[14]));return e.localOrigin=r.origin,Zte(r.origin.vec3,t),r}_updateComponentBuffer(i){const{meta:e,buffer:t}=i,r=new Uint8Array(4);for(let s=0;s<e.length;s++){const a=e[s].material,n=e[s].index,o=ee(Math.round(a.size*mie),0,255),l=ee(a.extensionLength,-ux,255-ux)+ux,c=a.type==="solid"?m2.SOLID:m2.SKETCH,h=255*a.opacity,u=a.color,p=255*u[0],m=255*u[1],f=255*u[2],y=255*u[3];t.textureBuffer.setData(n,0,p,m,f,y),t.textureBuffer.setData(n,1,o,l,c,h),y5(e[s].verticalOffset,r),t.textureBuffer.setData(n,2,r[0],r[1],r[2],r[3])}}_createComponentBuffers(i){if(P(this._componentColorManager))return null;const e=new Array,t=this._componentColorManager.getBuffer(i.length);for(let s=0;s<i.length;s++){const a=i[s],n=t.acquireIndex();e.push({index:n,verticalOffset:0,material:a})}const r=new Tie(t,e);return this._updateComponentBuffer(r),r}_extractEdges(i,e,t,r,s,a=s.length){return this._worker.process({data:e,indices:s,indicesLength:a,writerSettings:i,skipDeduplicate:t},this._workerAbort.signal,r)}_createRenderable(i,e,t,r,s){const a=c=>g(this._verticesBufferObject)?new Cie(new ac(this.rctx,aM,{vertices:v6,instances:c===gd.REGULAR?b6.glLayout:x6.glLayout},{vertices:this._verticesBufferObject,instances:gs.createVertex(this.rctx,ca.STATIC_DRAW,c===gd.REGULAR?i.regular.instancesData.buffer:i.silhouette.instancesData.buffer)}),c===gd.REGULAR?i.regular.lodInfo:i.silhouette.lodInfo):null,n=i.regular.lodInfo.lengths.length>0?a(gd.REGULAR):null,o=i.silhouette.lodInfo.lengths.length>0?a(gd.SILHOUETTE):null,l=(g(n)?n.vao.size:0)+(g(o)?o.vao.size:0);return new Pie(n,o,{gpuMemoryUsage:l,externalMemoryUsage:s,averageEdgeLength:i.averageEdgeLength},t,fA(e.meta),_A(e.meta),e,r)}async _addGeometry(i,e,t,r,s,a){const n=t.vertexAttributes.get(w.POSITION),o=t.indices.get(w.POSITION),l=ce(),c=this._computeModelTransformWithLocalOrigin(i,t,l),h=new TA(n,o,l,c);return this._addPositionData(e,h,t.edgeIndicesLength,r,s,a)}async _addPositionData(i,e,t,r,s,a=!1){if(i.loaded==null)return;const n=this._createComponentBuffers([r]);if(P(n)||t<=0)return;const o=this._acquireRenderer(r.type,!!s.hasSlicePlane,!0),{modelTransform:l,origin:c}=e,h=e.indices,u=e.position,p=u.data.length/u.size,m=Mx.createBuffer(p);for(let b=0;b<p;b++)m.position.set(b,0,u.data[b*u.size+0]),m.position.set(b,1,u.data[b*u.size+1]),m.position.set(b,2,u.data[b*u.size+2]);yA(n.meta,[0,m.componentIndex.count],m.componentIndex);const f=await this._updatingHandles.addPromise(this._extractEdges(o.writerSettings,m,!1,a,h,t));if(i.loaded==null)return;const y=this._createRenderable(f,n,new Sie(l,c),o.key,!1);i.renderables.push(y),o.addRenderable(y),this._gpuMemoryUsage+=y.statistics.gpuMemoryUsage}async _addComponentGeometry(i,e,t,r,s,a,n){if(e.loaded==null)return 0;const o=this._createComponentBuffers(a);if(P(o))return 0;const l=gA(a),c=this._acquireRenderer(l,n.hasSlicePlane||!1,!1),h=Mx.createBuffer(t.count);pM(h.position,t),yA(o.meta,s,h.componentIndex,r);const u=!0,p=c.writerSettings,m=await this._updatingHandles.addPromise(this._extractEdges(p,h,u,!1,r));if(e.loaded==null)return 0;const f=this._createRenderable(m,o,i,c.key,!0);return e.renderables.push(f),c.addRenderable(f),f.statistics.gpuMemoryUsage}async _addObjectMergedGeometries(i,e,t,r,s){const a=new Map;let n=0,o=null,l=0;for(let x=0;x<i.geometries.length;x++){const S=i.geometries[x];if(!S.material.supportsEdges)continue;!o&&S.localOrigin&&(o=S);const C=S.vertexAttributes.get(w.POSITION);l+=C.data.length/C.size,n+=S.edgeIndicesLength}const c=l>=65536?Uint32Array:Uint16Array,h=n?new c(n):null,u=[];let p=0;for(let x=0;x<i.geometries.length;x++){const S=i.geometries[x];if(!S.material.supportsEdges)continue;const C=S.vertexAttributes.get(w.POSITION),O=S.indices.get(w.POSITION);let R=a.get(C.data);if(R==null){R=u.length/3;for(let E=0;E<C.data.length;E+=C.size)u.push(C.data[E+0]),u.push(C.data[E+1]),u.push(C.data[E+2]);a.set(C.data,R)}if(O)for(let E=0;E<S.edgeIndicesLength;E++)h[p++]=R+O[E]}const m=o||i.geometries[0],f=ce(),y=this._computeModelTransformWithLocalOrigin(i,m,f);for(let x=0;x<i.geometries.length;x++)i.geometries[x].localOrigin=y.origin;const b=new TA({data:u,size:3},h,f,y);await this._updatingHandles.addPromise(this._addPositionData(e,b,h.length,t[0],r,s))}_acquireRenderer(i,e,t){const r=px.getKey(i,e,t);let s=this._renderers.get(r);return P(this._strokesTexture)&&(this._strokesTexture=yie(this.rctx)),s||(s=new px(this.rctx,this.techniqueRepository,{type:i,hasSlicePlane:e,strokesTexture:this._strokesTexture,legacy:t,spherical:this.viewingMode===ve.Global}),this._renderers.set(r,s)),++s.refCount,s}_removeRenderable(i){vA(i.regular),vA(i.silhouette);const e=this._renderers.get(i.rendererKey);if(e){e.removeRenderable(i),--e.refCount,"origin"in i.transform&&this._localOrigins.release(i.transform.origin),this._gpuMemoryUsage-=i.statistics.externalMemoryUsage?0:i.statistics.gpuMemoryUsage;for(const t of i.components.meta)i.components.buffer.releaseIndex(t.index)}}_updateObjectCameraDistances(i){const e=i.camera.eye,t=i.camera.viewForward,r=T(),s=a=>{Xr(r,a.center,e);const n=J(r,t),o=a.radius,l=n<-o?1/0:n<o?0:n-o;a.renderables.forEach(c=>c.distanceToCamera=l)};this._perObjectData.forEach(s),this._perObjectDataEvictionCache.forEach(s)}_renderRegularEdges(i,e,t){const r=i.bindRegularEdges(t,e),s=t.transparency,a=e.camera.perScreenPixelRatio;i.forEachRenderable(n=>{if(!xA(n)||!n.visible)return;const o=C0(n.regular.lod.lengths,n.distanceToCamera,a);i.renderRegularEdges(r,n,t,e,o)},s)}_renderSilhouetteEdges(i,e,t){const r=i.bindSilhouetteEdges(t,e),s=t.transparency,a=e.camera.perScreenPixelRatio;i.forEachRenderable(n=>{if(!wA(n)||!n.visible)return;const o=C0(n.silhouette.lod.lengths,n.distanceToCamera,a);i.renderSilhouetteEdges(r,n,t,e,o)},s)}get test(){return{hasRenderedPrimitives:i=>{let e=!1;const t=i.perScreenPixelRatio,r=(s,a)=>s.forEachRenderable(n=>{n.visible&&!e&&(xA(n)&&(e=C0(n.regular.lod.lengths,n.distanceToCamera,t)>0),!e&&wA(n)&&(e=C0(n.silhouette.lod.lengths,n.distanceToCamera,t)>0))},a);return this._renderers.forEach(s=>{e||(r(s,ht.OPAQUE),r(s,ht.TRANSPARENT))}),e}}}};function vA(i){g(i)&&(i.vao.vertexBuffers.instances.dispose(),i.vao.dispose(!1),i.vao=null)}function wie(i){let e=null,t=null;for(let r=0;r<i.geometries.length;r++){const s=i.geometries[r];if(s.material.supportsEdges){if(e){if(!TT(e,s.transformation))return!1}else e=s.transformation;if(!t&&g(s.localOrigin))t=s;else if(t&&g(t.localOrigin)&&g(s.localOrigin)&&t.localOrigin.id!==s.localOrigin.id)return!1}}return!0}d([v({constructOnly:!0})],Kn.prototype,"rctx",void 0),d([v({constructOnly:!0})],Kn.prototype,"renderSR",void 0),d([v({constructOnly:!0})],Kn.prototype,"viewingMode",void 0),d([v({constructOnly:!0})],Kn.prototype,"techniqueRepository",void 0),d([v({constructOnly:!0})],Kn.prototype,"setNeedsRender",void 0),d([v({constructOnly:!0})],Kn.prototype,"schedule",void 0),d([v({readOnly:!0})],Kn.prototype,"_updatingHandles",void 0),d([v({readOnly:!0})],Kn.prototype,"updating",null),Kn=d([Y("esri.views.3d.webgl-engine.lib.edgeRendering.EdgeView")],Kn);class bA{constructor(e,t,r){this.center=t,this.radius=r,this.renderables=new Array,this.loaded=e,this.loaded.then(()=>{this.loaded!=null&&(this.loaded=!0)})}}class Tie{constructor(e,t){this.buffer=e,this.meta=t}}let Cie=class{constructor(e,t){this.vao=e,this.lod=t}};class Sie{constructor(e,t){this.modelMatrix=e,this.origin=t}}class Pie{constructor(e,t,r,s,a,n,o,l){this.regular=e,this.silhouette=t,this.statistics=r,this.transform=s,this.edgeTransparency=a,this.objectTransparency=n,this.components=o,this.rendererKey=l,this.distanceToCamera=0,this.visible=!0}}function xA(i){return g(i.regular)}function wA(i){return g(i.silhouette)}function C0(i,e,t){const r=e*t,s=m9(i,r,!0);return s===-1?r<i[0]?i.length:0:i.length-s}let TA=class{constructor(e,t,r,s){this.position=e,this.indices=t,this.modelTransform=r,this.origin=s}};const CA=ys();function Oie(i,e){const t=i.capabilities.disjointTimerQuery;return P(t)?null:new Rie(t,e)}let Rie=class{constructor(e,t){this._timer=e,this._queryPool=new Array,this._queryResults=new Map,this._currentQuery=null,t.forEach(r=>{const s=this._timer.createQuery(),a=this._timer.createQuery();this._queryPool.push(s,a),this._queryResults.set(r,null)})}start(){c8||(this._currentQuery=this._queryPool.pop(),P(this._currentQuery)||(this._timer.disjoint(),this._timer.beginTimeElapsed(this._currentQuery)))}stop(e){if(this._timer.disjoint()||P(this._currentQuery)||!this._queryResults.has(e))return this.abort(),null;this._timer.endTimeElapsed();const t=this._queryResults.get(e);if(P(t))return this._queryResults.set(e,this._currentQuery),this._currentQuery=null,null;if(!this._timer.resultAvailable(t))return this._queryPool.unshift(this._currentQuery),this._currentQuery=null,null;const r=this._timer.getResult(t)/1e6;return this._queryPool.unshift(t),this._queryResults.set(e,this._currentQuery),this._currentQuery=null,r}abort(){g(this._currentQuery)&&(this._timer.deleteQuery(this._currentQuery),this._queryPool.unshift(this._timer.createQuery()),this._currentQuery=null)}dispose(){g(this._currentQuery)&&this._timer.deleteQuery(this._currentQuery),this._queryPool.forEach(e=>{this._timer.deleteQuery(e)}),this._queryResults.forEach(e=>{P(e)||this._timer.deleteQuery(e)})}};var jt;(function(i){i.OVERLAY="overlay",i.PREPARE="prepare",i.SHADOW_MAP="shadow map",i.LINEAR_DEPTH="linear depth",i.ACCUMULATED_SHADOWS="accumulated shadows",i.NORMALS="normals",i.OBJECT_AND_LAYER_ID_COLOR="object/layer id color",i.SSAO="SSAO",i.OPAQUE="opaque",i.OPAQUE_EDGES="opaque edges",i.VOXEL="voxel",i.TRANSPARENT="transparent",i.TRANSPARENT_EDGES="transparent edges",i.HUD_VISIBILITY="HUD visibility",i.TRANSPARENT_TERRAIN="transparent terrain",i.ENVIRONMENT="environment",i.LASER_LINE="laser line",i.OCCLUDED="occluded",i.ANTIALIASING="antialiasing",i.HIGHLIGHTS="highlights",i.HUD="HUD",i.HUD_OCCLUDED="HUD occluded",i.FINISH="finish"})(jt||(jt={}));const SA="Total";let Eie=class{constructor(e){this._rctx=e,this._startTimeStampCPU=Je(0),this._lastTimeStampCPU=Je(0),this._totalCPUTime=new r_(SA),this._cpuTimeSamplers=new Map(Object.values(jt).map(t=>[t,new r_(t)])),this._enableGPUTimer=0,this._totalGPUTime=new r_("GPU"),this._gpuTimeSamplers=new Map(Object.values(jt).map(t=>[t,new r_(t)])),this._totalTime=Je(0),this._totalFrameCount=0}get totalCPUTimeSampler(){return this._totalCPUTime}get cpuTimeSamplers(){return Array.from(this._cpuTimeSamplers.values())}get totalGPUTimeSampler(){return this._totalGPUTime}get gpuTimeSamplers(){return Array.from(this._gpuTimeSamplers.values())}get gpuSamplingEnabled(){return g(this._gpuTimerPool)}get totalTime(){return this._totalTime}get totalFrameCount(){return this._totalFrameCount}get elapsedTime(){return Je(performance.now()-this._startTimeStampCPU)}enableGPUPerformanceInfo(){if(P(this._gpuTimerPool)){const e=[...Object.values(jt),SA];this._gpuTimerPool=Oie(this._rctx,e)}return P(this._gpuTimerPool)?{hasGPUTimerSupport:!1,remove:()=>{}}:(++this._enableGPUTimer,{hasGPUTimerSupport:!0,remove:g9(()=>{--this._enableGPUTimer,this._enableGPUTimer===0&&(this._gpuTimerPool=De(this._gpuTimerPool))})})}startFrame(){this._startTimeStampCPU=this._lastTimeStampCPU=Je(performance.now()),g(this._gpuTimerPool)&&this._gpuTimerPool.start()}advance(e){const t=Je(performance.now());if(this._cpuTimeSamplers.get(e).record(t-this._lastTimeStampCPU),this._lastTimeStampCPU=t,g(this._gpuTimerPool)){const r=this._gpuTimerPool.stop(e);this._gpuTimeSamplers.get(e).record(r),this._gpuTimerPool.start()}}finishFrame(){if(g(this._gpuTimerPool)){const t=this._gpuTimerPool.stop(jt.FINISH);this._gpuTimeSamplers.get(jt.FINISH).record(t)}const e=Je(performance.now()-this._startTimeStampCPU);this._totalTime=Je(this._totalTime+e),this._totalCPUTime.record(e),g(this._gpuTimerPool)&&this._totalGPUTime.record(this.gpuTimeSamplers.reduce((t,r)=>t+(r.last||0),0)),++this._totalFrameCount}},Xa=class extends Ie{get _bindParameters(){return this._renderContext.bindParameters}isFeatureEnabled(i,e=this._state){return je(this._renderStateFeatures.get(e,i),!1)}setFeatureEnabled(i,e,t){this._renderStateFeatures.set(e,i,t),this.notifyChange("_renderStateFeatures"),this._requestRender()}get _antialiasing(){return this._antialiasingEnabled||this.isFeatureEnabled(Ii.Antialiasing)}get _highQualityTransparency(){return this._highQualityTransparencyEnabled||this.isFeatureEnabled(Ii.HighQualityTransparency)}get hasWaterReflection(){return this.hasWater&&(this._waterReflectionEnabled||this.isFeatureEnabled(Ii.WaterReflection))}get hasWater(){return this._hasWater||this._hasOverlayWater}constructor(i,e,t,r,s,a,n,o){super({}),this._stage=i,this._materialRepository=e,this._shaderTechniqueRepository=r,this._rctx=s,this._compositingHelper=a,this._magnifierHelper=n,this._requestRender=o,this._materialRenderers=new At,this._needsTransparentPass=!1,this._hasHUDElements=!1,this._hasHighlights=!1,this._hasWater=!1,this._hasOverlayWater=!1,this._renderOverlay=l=>{},this._isRendering=!1,this._fallbackDepthStencilTexture=null,this._sliceHelper=new Gte,this._state=ii.IDLE,this._renderStateFeatures=rP(),this._antialiasingEnabled=!0,this._highQualityTransparencyEnabled=!0,this._terrainRenderingEnabled=!0,this._terrainTransparency=vr.Opaque,this._waterReflectionEnabled=!1,this._ssaoEnabled=!1,this._hasAnimations=!1,this._animationTimestep=new Yee,this._handles=new Vi,this._renderHiddenTransparentEdges=()=>{},this._oitUsed=!1,this._smaaPass=new vg(this._rctx,r),o(),this._offscreen=new _te(this._rctx,this._compositingHelper),this.performanceInfo=new Eie(this._rctx),this._shadowMap=new jC(this._rctx,i.viewingMode),this._ssaoHelper=new z3(i.view,r,this._rctx,o),this._highlight=new pte(r,this._rctx),this._shadowHighlight=new Vte(this._rctx,i.viewingMode),this._shadowAccumulator=new ks(this._rctx,r,i,l=>{const c=this.shadowsEnabled;this._shadowMap.enabled=!0,this._prepare(l.camera,l.contentCamera),this._renderPlugins.prepareRender(),this._shadowMap.enabled=c},(l,c,h)=>{l.shadowMap.start(l.camera,c,h),this._renderShadowCascades(A.Shadow,l.shadowMap),l.camera.setGLViewport(this._rctx),this._prepare(l.camera,l.contentCamera)},o),this._renderContext=new bj(this._rctx,this._offscreen,this._shadowMap,this._ssaoHelper,this._sliceHelper),this._renderPlugins=new bte({renderContext:this._renderContext,techniqueRepository:r,textureRepository:t,materialRepository:this._materialRepository,requestRender:o,controller:i}),this.renderPassManager=new Zee(this._rctx,this._shaderTechniqueRepository),this._renderPlugins.add(this.renderPassManager.slots(),this.renderPassManager),this._handles.add([te(()=>this._stage.view.state.camera,()=>o(),Qi),te(()=>Ot.EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES,l=>{this._renderHiddenTransparentEdges=l?()=>this._renderEdges(ht.TRANSPARENT):()=>{},o()},Ji),te(()=>this._ssaoEnabled||this.isFeatureEnabled(Ii.SSAO),l=>this._ssaoHelper.enabled=l,Qi)])}normalizeCtorArgs(){return{}}destroy(){this._handles.destroy(),this._smaaPass.dispose(),this._gpuTimerHandle=fo(this._gpuTimerHandle),this._materialRenderers.forAll(i=>i.dispose()),this._materialRenderers.clear(),this._offscreen.dispose(),this._fallbackDepthStencilTexture=De(this._fallbackDepthStencilTexture),this._shadowMap.dispose(),this._ssaoHelper.dispose(),this._highlight.dispose(),this._shadowHighlight.dispose(),this._shadowAccumulator.dispose(),r6.prune()}disposeOffscreenBuffers(){this._offscreen.dispose(),this._shadowMap.disposeOffscreenBuffers(),this._smaaPass.disable(),this._ssaoHelper.disposeOffscreenBuffers()}get updating(){return this._antialiasing&&this._smaaPass.updating||g(this._edgeView)&&this._edgeView.updating||this._shadowAccumulator.running||!this.isCameraFinal}ensureEdgeView(){return P(this._edgeView)&&(this._edgeView=new Kn({rctx:this._rctx,renderSR:this._stage.view.renderSpatialReference,viewingMode:this._stage.viewingMode,techniqueRepository:this._shaderTechniqueRepository,setNeedsRender:()=>this._requestRender(),schedule:i=>this._stage.view.resourceController.immediate.schedule(i)}),this._handles.add(te(()=>th(this._edgeView,i=>i.updating),()=>this._requestRender(),Bt)),this._requestRender()),this._edgeView}get edgeView(){return this._edgeView}get isCameraFinal(){return DA(this._bindParameters.ssr.reprojectionMatrix,ph)}set _reprojectionMatrix(i){f9(this._bindParameters.ssr.reprojectionMatrix,i)&&this.notifyChange("isCameraFinal")}get shadowsEnabled(){var i;return!!((i=this._shadowMap)!=null&&i.enabled)}setParameters(i){const{_shadowMap:e,_bindParameters:t}=this;if(i.screenSpaceReflectionsEnabled!==void 0&&t.ssr.enabled!==i.screenSpaceReflectionsEnabled&&(t.ssr.enabled=i.screenSpaceReflectionsEnabled,this._requestRender()),i.shadowMap!==void 0&&this._shadowMap.enabled!==i.shadowMap&&(this._shadowMap.enabled=i.shadowMap,this._requestRender()),i.shadowMapMaxCascades!==void 0&&e.maxCascades!==i.shadowMapMaxCascades&&(e.maxCascades=i.shadowMapMaxCascades,this._requestRender()),g(i.environment)){g(i.environment.weather)&&(this._bindParameters.weather=i.environment.weather,this._bindParameters.weatherVisible=!!i.weatherVisible),i.environment.lighting.ambientOcclusionEnabled!==void 0&&this._ssaoEnabled!==i.environment.lighting.ambientOcclusionEnabled&&(this._ssaoEnabled=i.environment.lighting.ambientOcclusionEnabled,this._requestRender()),i.environment.lighting.waterReflectionEnabled!==void 0&&this._waterReflectionEnabled!==i.environment.lighting.waterReflectionEnabled&&(this._waterReflectionEnabled=i.environment.lighting.waterReflectionEnabled,this._requestRender());const r=i.environment.lighting.type!=="virtual";t.enableFillLights!==r&&(t.enableFillLights=r,this._requestRender())}i.background&&this._offscreen.background!==i.background&&(this._offscreen.background=i.background,this._requestRender()),i.antialiasingEnabled!==void 0&&this._antialiasingEnabled!==i.antialiasingEnabled&&(this._antialiasingEnabled=i.antialiasingEnabled,this._requestRender()),i.highQualityTransparency!==void 0&&this._highQualityTransparencyEnabled!==i.highQualityTransparency&&(this._highQualityTransparencyEnabled=i.highQualityTransparency,this._requestRender()),i.defaultHighlightOptions!==void 0&&(this._highlight.setDefaultOptions(i.defaultHighlightOptions),this._shadowHighlight.setDefaultOptions(i.defaultHighlightOptions),this._requestRender()),i.overlays!==void 0&&this._bindParameters.overlays!==i.overlays&&(this._bindParameters.overlays=i.overlays,this._requestRender()),i.hasOverlayWater!==void 0&&this._hasOverlayWater!==i.hasOverlayWater&&(this._hasOverlayWater=i.hasOverlayWater,this._requestRender()),i.renderOverlay!==void 0&&this._renderOverlay!==i.renderOverlay&&(this._renderOverlay=i.renderOverlay,this._requestRender()),i.slicePlane!==void 0&&this._sliceHelper.plane!==i.slicePlane&&(this._sliceHelper.plane=Si(i.slicePlane),this._requestRender()),i.terrainRenderingEnabled!==void 0&&this._terrainRenderingEnabled!==i.terrainRenderingEnabled&&(this._terrainRenderingEnabled=i.terrainRenderingEnabled,this._requestRender()),i.terrainTransparency!==void 0&&this._terrainTransparency!==i.terrainTransparency&&(this._terrainTransparency=i.terrainTransparency,this._requestRender()),i.shadowCastOptions!==void 0&&this._shadowAccumulator.setOptions(i.shadowCastOptions)}get hasSlicePlane(){return!!this._sliceHelper.plane}get renderPlugins(){return this._renderPlugins}get _hasOITSupport(){return this._rctx.driverTest.floatBufferBlend.result}get _oitEnabled(){return this._highQualityTransparency&&this._hasOITSupport}modify(i,e){this._isRendering&&console.warn("Renderer.modify called while rendering");const{adds:t,removes:r,updates:s}=i;if(t.length===0&&r.length===0&&s.length===0)return;const a=wL(i);let n=!1;a.forEach((o,l)=>{if(e.done)return;let c=this._materialRenderers.find(h=>h.material===l);P(c)&&o.adds.length>0&&(c=new AL(this._rctx,this._materialRepository,l),this._materialRenderers.push(c)),c&&(c.modify(o),c.isEmpty&&(n=!0)),o.removes.forEach(h=>i.removes.removeUnordered(h)),o.adds.forEach(h=>i.adds.removeUnordered(h)),o.updates.forEach(h=>i.updates.removeUnordered(h)),e.madeProgress()}),n&&this._materialRenderers.filterInPlace(o=>!o.isEmpty||(o.dispose(),!1)),this._hasHighlights=this._materialRenderers.some(o=>o.hasHighlights),this._bindParameters.hasOccludees=this._materialRenderers.some(o=>o.hasOccludees),this._hasWater=this._materialRenderers.some(o=>o.hasWater),this._hasHUDElements=this._materialRenderers.some(o=>o.requiresSlot(K.LINE_CALLOUTS_HUD_DEPTH,A.Color)||o.requiresSlot(K.HUD_MATERIAL,A.Color)||o.requiresSlot(K.LABEL_MATERIAL,A.Color)),this._requestRender()}updateAnimation(i){const e=this._hasAnimations;return this._hasAnimations=!1,this._materialRenderers.forAll(t=>this._hasAnimations=t.updateAnimation(i)||this._hasAnimations),this._hasAnimations=this._renderPlugins.updateAnimation(i)||this._hasAnimations,this._hasAnimations!==e&&(this._gpuTimerHandle=e?fo(this._gpuTimerHandle):this.performanceInfo.enableGPUPerformanceInfo()),this._hasAnimations}get animationTimestep(){return this._animationTimestep.value}get animationTimeDilation(){return this._animationTimestep.timeDilation}resetAnimation(){this._animationTimestep.clear()}render(i,e,t,r,s){this._isRendering=!0,this.performanceInfo.startFrame();const{camera:a,contentCamera:n,mode:o}=t;this._state=o,this._renderOverlay(s),this.performanceInfo.advance(jt.OVERLAY),this._renderContext.time=s,this._bindParameters.transparencyPassType=We.NONE;const l=this._offscreen;l.setupRenderTarget(this.hasWaterReflection);const c=cc(this._sliceHelper.plane);r===nf.OFF&&(this._sliceHelper.plane=null),this._rctx.bindFramebuffer(i),a.setGLViewport(this._rctx),this._prepare(a,n),this._renderPlugins.prepareRender(),this.performanceInfo.advance(jt.PREPARE);const h=this._computeDepthRange(a);this._renderShadowMap(i,a,this._bindParameters.lighting.mainLight.direction,h),this.performanceInfo.advance(jt.SHADOW_MAP),l.initializeFrame(a),this._ensureBindParameters(a,n),this._renderLinearDepth(),this.performanceInfo.advance(jt.LINEAR_DEPTH),this._accumulateShadows(h,a,n),this.performanceInfo.advance(jt.ACCUMULATED_SHADOWS),this._renderNormal(),this.performanceInfo.advance(jt.NORMALS),this._ensureBindParametersSSR(s),this._renderSSAO(s),this.performanceInfo.advance(jt.SSAO),this._renderContext.output=A.Color,l.bindFramebuffer(),this._renderOpaqueGeometry(),this.performanceInfo.advance(jt.OPAQUE);const u=this._terrainRenderingEnabled&&(this._terrainTransparency===vr.Semitransparent||this._terrainTransparency===vr.TransparentWithDraped),p=this._highQualityTransparency&&u;this._renderTerrainLinearDepth(p),this._setMultipassEnabled(p),this._setTerrainCulling(p),this._renderEdges(ht.OPAQUE),this.performanceInfo.advance(jt.OPAQUE_EDGES),this._offscreen.bindTarget(this._offscreen.currentColorTarget,this._offscreen.mainDepth),this._renderSlot(K.VOXEL),this.performanceInfo.advance(jt.VOXEL),this._renderHiddenTransparentEdges();const m=this._needsTransparentPass||this._renderPlugins.needsTransparentPass;m&&(this._oitEnabled?this._renderOrderIndependentTransparency(()=>this._renderTransparentGeometry(),!1):this._renderTransparentGeometry()),this.performanceInfo.advance(jt.TRANSPARENT),this._renderGeometryLinearDepth(p);const f=this._renderHUDVisibility(p);p||this._renderInternalSlot(K.LINE_CALLOUTS),this.performanceInfo.advance(jt.HUD_VISIBILITY),this._renderObjectAndLayerIdColor(e),this.performanceInfo.advance(jt.OBJECT_AND_LAYER_ID_COLOR),this._renderEdges(ht.TRANSPARENT,p),this.performanceInfo.advance(jt.TRANSPARENT_EDGES),this._renderTransparentTerrain(),u&&f&&(p?this._renderLineCallouts(Ya.Occluded):l.compositeTransparentTerrainOntoHUDVisibility(this._bindParameters),this._renderHUD(Ya.Occluded,l.framebuffer),this.performanceInfo.advance(jt.HUD_OCCLUDED)),this.performanceInfo.advance(jt.TRANSPARENT_TERRAIN),this._setTerrainCulling(!1),u&&(l.compositeTransparentTerrainOntoMain(this._bindParameters),p&&(this._renderEdges(ht.OPAQUE),this.performanceInfo.advance(jt.OPAQUE_EDGES),m&&(this._oitEnabled?this._renderOrderIndependentTransparency(()=>this._renderTransparentGeometry(),!1):this._renderTransparentGeometry()),this.performanceInfo.advance(jt.TRANSPARENT),this._renderEdges(ht.TRANSPARENT),this.performanceInfo.advance(jt.TRANSPARENT_EDGES))),p&&this._renderLineCallouts(Ya.NotOccluded),this._setMultipassEnabled(!1),this._shadowAccumulator.render(this._bindParameters),l.renderToTargets(()=>{this._renderInternalSlot(K.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL),this._renderSlot(K.POSTPROCESSING_ENVIRONMENT_TRANSPARENT),this._renderSlot(K.LASERLINES)},l.currentColorTarget,l.mainDepth),this.performanceInfo.advance(jt.ENVIRONMENT),this._renderPlugins.needsLaserlineWithContrastControl&&l.renderTmpAndCompositeToMain(()=>this._renderSlot(K.LASERLINES_CONTRAST_CONTROL),this._bindParameters,us.PremultipliedAlpha),this.performanceInfo.advance(jt.LASER_LINE),this._renderOccluded(),this.performanceInfo.advance(jt.OCCLUDED);const y=r===nf.ON&&this._magnifierHelper.enabled,b=y&&P(i)?this._offscreen.getFramebuffer(this._offscreen.tmpColor,this._offscreen.tmpDepth):i;this._rctx.bindFramebuffer(b);const x=this._offscreen.colorTexture;!this._renderAntiAliasing(x)&&g(x)&&this._compositingHelper.composite(this._bindParameters,x,us.None),this.performanceInfo.advance(jt.ANTIALIASING),this._renderHUD(Ya.NotOccluded,b),this.performanceInfo.advance(jt.HUD),this._renderHighlights(b,this._bindParameters),this.performanceInfo.advance(jt.HIGHLIGHTS),y&&this._magnifierHelper.render(this._rctx,this._bindParameters),b!==i&&(this._rctx.bindFramebuffer(i),this._compositingHelper.composite(this._bindParameters,this._offscreen.tmpColorTexture,us.None)),this._disposeOITBuffers(),this._renderContext.lastFrameCamera.copyFrom(this._bindParameters.camera),this._sliceHelper.plane=c,this._isRendering=!1,this.onPostRender&&this.onPostRender(),this.performanceInfo.finishFrame()}_renderObjectAndLayerIdColor(i){if(g(i)&&vi("enable-feature:objectAndLayerId-rendering")){const e=this._renderContext.output;this._rctx.bindFramebuffer(i),this._offscreen.renderToFBO(()=>this._renderGeometryAndTransparentTerrainPass(A.ObjectAndLayerIdColor),[0,0,0,0],!0,!0),this._rctx.bindFramebuffer(i),this._offscreen.renderToFBO(()=>{this._bindParameters.renderTransparentlyOccludedHUD=Ya.NotOccluded,this._renderInternalSlot(K.HUD_MATERIAL)},void 0,!0,!0),this._renderContext.output=e}}finish(i){this._hasAnimations||this._animationTimestep.clear();const e=this.performanceInfo.gpuSamplingEnabled,t=i===Wi.BACKGROUND;if(t||e){const r=t?this.performanceInfo.elapsedTime:0,s=e?this.performanceInfo.totalGPUTimeSampler.last:this._rctx.gl.getError(),a=Math.max(r,s);this._animationTimestep.frame(a,t)}}readDepthPixels(i,e,t){const r=this._offscreen.bindTarget(this._offscreen.linearDepth,this._offscreen.tmpDepth);if(!this._needsLinearDepth){this._ensureBindParameters(i,i),this._bindParameters.camera.setGLViewport(this._rctx),this._rctx.setClearColor(0,0,0,0);const s=Xi.COLOR_BUFFER_BIT|Xi.DEPTH_BUFFER_BIT|Xi.STENCIL_BUFFER_BIT;this._rctx.clearSafe(s),this._renderGeometryAndTransparentTerrainPass(A.Depth)}r.readPixels(e[0],e[1],e[2],e[3],St.RGBA,Zt.UNSIGNED_BYTE,t)}readHUDVisibility(i,e,t,r,s){this._offscreen.bindTarget(this._offscreen.hudVisibility).readPixels(i,e,t,r,St.RGBA,Zt.UNSIGNED_BYTE,s)}readAccumulatedShadow(i){return this._shadowAccumulator.readAccumulatedShadow(i[0],i[1])}_setMultipassEnabled(i){this._bindParameters.multipassTerrain.enabled=this._bindParameters.multipassGeometry.enabled=i}_setTerrainCulling(i){this._bindParameters.multipassTerrain.cullAboveGround=i}_renderSlot(i){this._bindParameters.slot=i,this._renderPlugins.render()}_renderEdges(i,e=!1){const t=this._edgeView;g(t)&&t.shouldRender()&&this._offscreen.renderTmpAndCompositeToMain(()=>t.render(this._bindParameters,i),this._bindParameters,us.Alpha,e)}_renderShadowMap(i,e,t,r){const s=this._shadowMap;s.enabled&&this.isFeatureEnabled(Ii.ShadowMapUpdate)&&(s.start(e,t,r),this._shadowHighlight.updateParameters(e,t),this._needsShadowHighlight?(this._renderShadowCascades(A.ShadowHighlight,this._shadowMap,a=>s.takeCascadeSnapshotTo(a,Xp.Highlight)),s.clear(),this._renderShadowCascades(A.ShadowExcludeHighlight,this._shadowMap,a=>{s.takeCascadeSnapshotTo(a,Xp.Default),this._renderGeometryAndTransparentTerrainPass(A.ShadowHighlight)})):this._renderShadowCascades(A.Shadow),s.finish(i),e.setGLViewport(this._rctx))}_renderShadowCascades(i,e=this._shadowMap,t=r=>{}){for(const r of e.cascades)r.camera.setGLViewport(this._rctx),this._prepare(r.camera,r.camera),this._renderGeometryAndTransparentTerrainPass(i),t(r)}get _needsLinearDepth(){return this._ssaoHelper.active||this._renderPlugins.needsLinearDepth||this.hasWaterReflection||this._needsShadowHighlight||this._needsShadowCast}_renderLinearDepth(){this._needsLinearDepth?this._offscreen.renderToTargets(()=>this._renderGeometryAndTransparentTerrainPass(A.Depth),this._offscreen.linearDepth,this._offscreen.tmpDepth,[0,0,0,0],!0,!0):this._offscreen.disposeTarget(this._offscreen.linearDepth),this._bindParameters.linearDepthTexture=this._offscreen.linearDepthTexture}_renderTerrainLinearDepth(i){if(i){const e=this._renderContext.output;this._renderContext.output=A.Depth,this._offscreen.renderToTargets(()=>this._renderTransparentTerrain(),this._offscreen.terrainLinearDepth,this._offscreen.tmpDepth,[-1e10,-1e10,-1e10,1],!0,!0),this._renderContext.output=e}else this._offscreen.disposeTarget(this._offscreen.terrainLinearDepth);this._bindParameters.multipassTerrain.linearDepthTexture=this._offscreen.terrainLinearDepthTexture}_renderGeometryLinearDepth(i){if(i){const e=this._renderContext.output;this._offscreen.renderToTargets(()=>this._renderGeometryPass(A.Depth),this._offscreen.geometryLinearDepth,this._offscreen.tmpDepth,[1,1,1,1],!0,!0),this._renderContext.output=e}else this._offscreen.disposeTarget(this._offscreen.geometryLinearDepth);this._bindParameters.multipassGeometry.linearDepthTexture=this._offscreen.geometryLinearDepthTexture}get _needsNormal(){return this._ssaoHelper.active}_renderNormal(){this._needsNormal?this._offscreen.renderToTargets(()=>{this._renderGeometryAndTransparentTerrainPass(A.Normal)},this._offscreen.normal,this._offscreen.tmpDepth,[0,0,0,0],!0,!0):this._offscreen.disposeTarget(this._offscreen.normal)}get _needsDepthRange(){return this._shadowMap.enabled||this._needsShadowCast}_computeDepthRange(i){if(!this._needsDepthRange)return Qw;const e=Lee(i,this._materialRenderers,this._stage.layers);return Yp(e,this.renderPlugins.queryDepthRange(i)),e.near=Math.max(i.near,e.near),e.far=Math.min(i.far,e.far),e}_renderGeometryAndTransparentTerrainPass(i){this._renderContext.output=i,this._renderGeometryPass(i),this._renderTransparentTerrain()}_renderGeometryPass(i){this._renderContext.output=i,this._renderOpaqueGeometry(),this._renderTransparentGeometry()}_renderSSAO(i){this._ssaoHelper.render(this._bindParameters,i,this._offscreen.linearDepthTexture,this._offscreen.normalTexture)}_renderOpaqueGeometry(){this._renderSlot(K.INTEGRATED_MESH),this._renderSlot(K.OPAQUE_TERRAIN),this._renderInternalSlot(K.OPAQUE_MATERIAL),this._renderSlot(K.OPAQUE_MATERIAL),this._renderSlot(K.POSTPROCESSING_ENVIRONMENT_OPAQUE)}_renderTransparentGeometry(){this._renderInternalSlot(K.TRANSPARENT_MATERIAL),this._renderSlot(K.TRANSPARENT_MATERIAL)}_renderTransparentTerrain(){this._renderSlot(K.TRANSPARENT_TERRAIN)}_renderHUDVisibility(i){let e=!1;return this._renderContext.offscreenRenderingHelper&&this._renderContext.offscreenRenderingHelper.renderHUDVisibility(()=>{this._bindParameters.hudVisibilityTexture=this._renderContext.offscreenRenderingHelper.hudVisibilityTexture,e=this._renderInternalSlot(K.OCCLUSION_PIXELS)},i),e}_renderLineCallouts(i){this._bindParameters.renderTransparentlyOccludedHUD=i,i===Ya.Occluded?this._offscreen.renderToTargets(()=>this._renderInternalSlot(K.LINE_CALLOUTS),this._offscreen.currentColorTarget,this._offscreen.tmpDepth,void 0,!0,!0):this._renderInternalSlot(K.LINE_CALLOUTS)}_renderHUD(i,e){this._hasHUDElements&&(this._oitEnabled?(this._renderOrderIndependentTransparency(()=>this._renderHUDElements(i),!0),this._rctx.bindFramebuffer(e),this._compositingHelper.composite(this._bindParameters,this._offscreen.hudColorTexture,us.PremultipliedAlpha)):i===Ya.Occluded?this._offscreen.renderToTargets(()=>this._renderHUDElements(Ya.Occluded),this._offscreen.currentColorTarget,this._offscreen.tmpDepth,void 0,!0,!0):this._renderHUDElements(i))}_renderHUDElements(i){this._bindParameters.renderTransparentlyOccludedHUD=i,this._renderInternalSlot(K.LINE_CALLOUTS_HUD_DEPTH),this._renderInternalSlot(K.HUD_MATERIAL),this._renderInternalSlot(K.LABEL_MATERIAL)}get _needsHighlight(){return this._hasHighlights||this._renderPlugins.needsHighlight}get _needsShadowHighlight(){return this._shadowMap.enabled&&this._shadowHighlight.isVisible&&this._needsHighlight}_renderHighlights(i,e){if(!this._needsHighlight)return void this._offscreen.disposeTarget(this._offscreen.highlight);const t=this._highlight,r=this._offscreen.renderToTargets(()=>{this._renderGeometryAndTransparentTerrainPass(A.Highlight),this._rctx.clearSafe(Xi.DEPTH_BUFFER_BIT),this._renderHUDElements(Ya.Both)},this._offscreen.highlight,this._offscreen.tmpDepth,[0,0,0,0],!0,!0);this._bindParameters.highlightColorTexture=r.colorTexture,this._needsShadowHighlight&&this._shadowHighlight.render(e,i),t.render(this._bindParameters,r,i)}get _needsShadowCast(){return this._shadowAccumulator.isAccumulating}_accumulateShadows(i,e,t){this._needsShadowCast&&g(this._offscreen.linearDepthTexture)&&this._shadowAccumulator.renderAccumulation(this._offscreen.linearDepthTexture,i,e,t)}_renderOrderIndependentTransparency(i,e){const t=s=>{this._bindParameters.transparencyPassType=s,this._offscreen.renderOITPass(()=>i(),s,e)},r=this._renderContext.output;this._renderContext.output=A.Alpha,t(We.Alpha),this._renderContext.output=A.Color,t(We.Color),t(We.FrontFace),this._offscreen.compositeTransparentOntoOpaque(this._bindParameters,e),this._bindParameters.transparencyPassType=We.NONE,this._renderContext.output=r,this._oitUsed=!0}_disposeOITBuffers(){this._oitUsed||(this._offscreen.disposeTarget(this._offscreen.alphaFloatTarget),this._offscreen.disposeTarget(this._offscreen.colorFloatTarget),this._offscreen.disposeTarget(this._offscreen.frontFaceTarget)),this._oitUsed=!1}_renderOccluded(){let i=0;Wn.clear(),this._materialRenderers.forAll(a=>{a.material&&a.material.isVisible()&&a.material.renderOccluded===qi.OccludeAndTransparentStencil&&(i|=a.material.renderOccluded,Wn.push(a))});const e=this._offscreen,t=(a,n,o,l,c)=>{i&n&&(e.renderToTargets(o,e.tmpColor,e.mainDepth,[0,0,0,0],l,c),e.compositeOccludedOntoMain(this._bindParameters,a))};Wn.length!==0&&(this._renderInternalSlot(K.OCCLUDER_MATERIAL,Wn),t(.5,qi.OccludeAndTransparentStencil,()=>this._renderInternalSlot(K.TRANSPARENT_OCCLUDER_MATERIAL,Wn),!1,!1)),Wn.clear(),this._materialRenderers.forAll(a=>{a.material&&a.material.isVisible()&&(a.material.renderOccluded===qi.OccludeAndTransparent||a.material.renderOccluded===qi.Transparent||a.material.renderOccluded===qi.Opaque)&&(i|=a.material.renderOccluded,Wn.push(a))});const r=this._renderPlugins.renderOccludedFlags;if(i|=r,!i)return;const s=a=>{this._renderContext.renderOccludedMask=a,r>qi.Occlude&&this._renderSlot(K.OCCLUDED_TERRAIN),this._renderInternalSlot(K.OPAQUE_MATERIAL,Wn),this._renderInternalSlot(K.TRANSPARENT_MATERIAL,Wn),this._renderInternalSlot(K.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL,Wn),this._renderContext.resetRenderOccludedMask()};this._renderContext.output=A.Color,t(.5,qi.OccludeAndTransparent,()=>s(qi.OccludeAndTransparent),!0,Tg.OutlineVisualElementMask),t(.5,qi.Transparent,()=>s(qi.Transparent),!0,Tg.OutlineVisualElementMask),t(1,qi.Opaque,()=>s(qi.Opaque),!0,Tg.OutlineVisualElementMask),Wn.clear()}_renderAntiAliasing(i){if(this._antialiasing){if(this._smaaPass.enable(()=>this._requestRender())&&g(i))return this._smaaPass.render(i),!0}else this._smaaPass.disable();return!1}_prepare(i,e){this._needsTransparentPass=this._materialRenderers.some(t=>t.requiresSlot(K.TRANSPARENT_MATERIAL,A.Color)),this._bindParameters.camera=i,this._bindParameters.contentCamera=e}_ensureBindParameters(i,e){this._bindParameters.camera=i,this._bindParameters.contentCamera=e;const t=this._renderContext.offscreenRenderingHelper;this._bindParameters.hudVisibilityTexture=t.hudVisibilityTexture,this._bindParameters.mainColorTexture=t.mainColorTexture,this._bindParameters.highlightDepthTexture=t.depthTexture??this._getFallbackDepthTexture()}_ensureBindParametersSSR(i){if(this._bindParameters.ssr.enabled=this.hasWaterReflection,this._bindParameters.ssr.enabled){P(this._waterReflectionEnableTime)&&(this._waterReflectionEnableTime=i),this._renderContext.lastFrameCamera.equals(this._bindParameters.camera)?this._reprojectionMatrix=ph:($a(OA,this._bindParameters.camera.viewMatrix),$a(PA,this._bindParameters.camera.projectionMatrix),pr(Yu,OA,PA),pr(Yu,this._renderContext.lastFrameCamera.viewMatrix,Yu),pr(Yu,this._renderContext.lastFrameCamera.projectionMatrix,Yu),this._reprojectionMatrix=Yu),this._bindParameters.ssr.lastFrameColorTexture=this._offscreen.lastFrameColorTexture;const e=this._stage.view.qualitySettings.fadeDuration;this._bindParameters.ssr.fadeFactor=e>0?Math.min(e,i-this._waterReflectionEnableTime)/e:1,this._bindParameters.ssr.fadeFactor<1&&this._requestRender()}else this._bindParameters.ssr.lastFrameColorTexture=null,this._waterReflectionEnableTime=null}_renderInternalSlot(i,e=this._materialRenderers){let t=!1;return this._bindParameters.slot=i,e.forAll(r=>{r.material.shouldRender(this._renderContext)&&r.render(this._renderContext.output,this._bindParameters)&&(t=!0)}),t}_getFallbackDepthTexture(){return this._fallbackDepthStencilTexture||(this._fallbackDepthStencilTexture=U3(this._rctx)),this._fallbackDepthStencilTexture}get gpuMemoryUsage(){var i,e,t,r,s;return{offscreen:((i=this._offscreen)==null?void 0:i.gpuMemoryUsage)??0,highlights:(((e=this._highlight)==null?void 0:e.gpuMemoryUsage)??0)+(((t=this._shadowHighlight)==null?void 0:t.gpuMemoryUsage)??0),shadows:((r=this._shadowMap)==null?void 0:r.gpuMemoryUsage)??0,ssao:((s=this._ssaoHelper)==null?void 0:s.gpuMemoryUsage)??0}}get test(){const i=this;return{offscreen:this._offscreen,shadowMap:this._shadowMap,ssao:this._ssaoHelper,highlight:this._highlight,lighting:this._bindParameters.lighting,materialRenderers:this._materialRenderers,shadowAccumulator:this._shadowAccumulator,weatherIsFading:this._bindParameters.cloudsFade.isFading,resetRenderStateFeatures:()=>{i._renderStateFeatures=rP()},getFramebufferTexture:e=>{switch(e){case Hc.Color:return i._offscreen.colorTexture;case Hc.LinearDepth:return i._offscreen.linearDepthTexture;case Hc.Normals:return i._offscreen.normalTexture;case Hc.ShadowMap:return i._shadowMap.depthTexture;case Hc.HudVisibility:return i._offscreen.hudVisibilityTexture;case Hc.Highlight:return i._offscreen.highlightTexture}}}}};var Hc;d([v()],Xa.prototype,"_shadowAccumulator",void 0),d([v()],Xa.prototype,"_state",void 0),d([v()],Xa.prototype,"_renderStateFeatures",void 0),d([v()],Xa.prototype,"_antialiasingEnabled",void 0),d([v({readOnly:!0})],Xa.prototype,"_antialiasing",null),d([v()],Xa.prototype,"_ssaoEnabled",void 0),d([v()],Xa.prototype,"_smaaPass",void 0),d([v({autoDestroy:!0})],Xa.prototype,"_edgeView",void 0),d([v()],Xa.prototype,"updating",null),d([v()],Xa.prototype,"isCameraFinal",null),Xa=d([Y("esri.views.3d.webgl-engine.lib.Renderer")],Xa),function(i){i[i.Color=0]="Color",i[i.LinearDepth=1]="LinearDepth",i[i.Normals=2]="Normals",i[i.ShadowMap=3]="ShadowMap",i[i.HudVisibility=4]="HudVisibility",i[i.Highlight=5]="Highlight"}(Hc||(Hc={}));const Wn=new At,PA=ce(),OA=ce(),Yu=ce();class Aie extends h8{constructor(e,t,r){super(e,t),this.newCache=r,this._refCount=1}destroy(){--this._refCount>0||this.dispose()}ref(){++this._refCount}bindTechnique(e,t,r,s){return this.useProgram(e.program),e.bindPipelineState(this,r==null?void 0:r.slot,!!s),e.program.bindPass(t,r),e.program}get test(){return this.programCache.test}}let hp=class extends Ie{constructor(e,t,r){super({}),this._stage=e,this._techniqueRepository=t,this._rctx=r,this._textures=new Map,this._loadingCount=0,this._frameUpdates=new Map,this.events=new Ms,this._frameTask=e.view.resourceController.scheduler.registerTask(Zi.TEXTURE_UNLOAD)}normalizeCtorArgs(){return{}}destroy(){this._frameTask.remove(),this._stage.forEachOfType(ps.Texture,e=>e.unload())}get updating(){return this._loadingCount>0||this._frameTask.updating}get textureTechnique(){return P(this._textureTechnique)&&(this._textureTechnique=this._techniqueRepository.acquire(XC,new QC)),this._textureTechnique}acquire(e){const t=this._textures.get(e);return t?(t.ref(),je(t.loadingPromise,t)):this._createNewRef(e)}update(){let e=!1;this._frameUpdates.forEach(t=>{const r=t.texture.frameUpdate(this._rctx,this.textureTechnique,t.previousToken);r>=0&&r!==t.previousToken&&(t.previousToken=r,e=!0)}),e&&this.events.emit("changed",Wi.BACKGROUND)}_createNewRef(e){const t=this._stage.getObject(e);if(P(t))return dt(t!==void 0),null;const r=t.events.on("unloaded",()=>{r.remove(),this._onTextureUnloaded(e)}),s=new Mie(e,()=>{this._frameTask.schedule(()=>{s.isUnreferenced&&t.unload()})});return this._textures.set(e,s),s.ref(),g(t.glTexture)?(this._updateGLTexture(s,t.glTexture),t.requiresFrameUpdates&&this._frameUpdates.set(e,{texture:t,previousToken:-1}),s):(this._loadingCount++,s.loadingPromise=this._stage.schedule(()=>{const a=t.load(this._rctx,()=>this.textureTechnique),n=l=>(this._loadingCount--,s.loadingPromise=null,this._updateGLTexture(s,l),t.requiresFrameUpdates&&this._frameUpdates.set(e,{texture:t,previousToken:-1}),s),o=l=>(this._loadingCount--,s.loadingPromise=null,yo(l)||Pe.getLogger(this.declaredClass).error(l),null);return dv(a)?a.then(n,o):n(a)}),s.loadingPromise)}_updateGLTexture(e,t){e.glTexture=t,this.events.emit("changed",Wi.UPDATE)}_onTextureUnloaded(e){this._textures.delete(e),this._frameUpdates.delete(e)}};d([v()],hp.prototype,"_loadingCount",void 0),d([v()],hp.prototype,"_frameTask",void 0),d([v()],hp.prototype,"updating",null),hp=d([Y("esri.views.3d.webgl-engine.lib.TextureRepository")],hp);class Mie{constructor(e,t){this.id=e,this._release=t,this._refCount=0}get isUnreferenced(){return this._refCount===0}ref(){++this._refCount}release(){--this._refCount,this._refCount>0||(this._refCount!==0?(Pe.getLogger("esri.views.3d.webgl-engine.lib.TextureRepository.RefCountedTextureImpl").error("Cannot dereference texture that has no references!"),this._refCount=0):this._release())}}let bg=class extends Ie{constructor(){super(...arguments),this._passParameters=new Die,this._loading=0}get passParameters(){return this._passParameters}destroy(){this._passParameters.waveNormal=De(this._passParameters.waveNormal),this._passParameters.wavePertubation=De(this._passParameters.wavePertubation)}get updating(){return this._loading>0}ensureResources(i){if(this._loading>0)return M0.LOADING;if(g(this._passParameters.waveNormal)&&g(this._passParameters.wavePertubation))return M0.LOADED;const e={target:tr.TEXTURE_2D,pixelFormat:St.RGBA,dataType:Zt.UNSIGNED_BYTE,wrapMode:kt.REPEAT,samplingMode:Qt.LINEAR_MIPMAP_LINEAR,hasMipmap:!0,maxAnisotropy:8};return++this._loading,cf(XS("esri/images/materials/water/normals.jpg")).then(t=>this._passParameters.waveNormal=new Ai(i,{...e,width:t.width,height:t.height},t)).catch(t=>Pe.getLogger(this.declaredClass).error("Failed to load water material normal texture.",t)).finally(()=>--this._loading),++this._loading,cf(XS("esri/images/materials/water/perturbation.jpg")).then(t=>this._passParameters.wavePertubation=new Ai(i,{...e,width:t.width,height:t.height},t)).catch(t=>Pe.getLogger(this.declaredClass).error("Failed to load water material pertubation texture.",t)).finally(()=>--this._loading),M0.LOADING}};d([v()],bg.prototype,"_loading",void 0),d([v({type:Boolean,readOnly:!0})],bg.prototype,"updating",null),bg=d([Y("esri.views.3d.webgl-engine.materials.internal.WaterTextureRepository")],bg);let Die=class extends Gi{};class Iie{constructor(e,t){this.viewCamera=e,this.frameHasDecorations=t}}class Lie{constructor(e,t,r,s){this._rctx=e,this._renderFunctions=t,this._forceCameraHook=r,this._disposeOffscreenBuffers=s,this.supersample=!0,this._screenshotQueue=new Array}destroy(){this._rctx=null}async takeScreenshot(e){await this._renderFunctions.prepareOverlay(),this._renderFunctions.requestRenderScene(Wi.BACKGROUND);const t=Uf();return this._screenshotQueue.push({settings:e,resolver:t}),t.promise}update(e,t){for(const r of this._screenshotQueue){if(this._rctx==null){r.resolver.reject();continue}const s={...r.settings,pixelRatio:r.settings.pixelRatio*e.viewCamera.pixelRatio},a=this._renderScreenshot(e,s,t);r.resolver(a)}this._screenshotQueue.length=0}_renderScreenshotOverlay(e,t,r){e.width=t.width,e.height=t.height;const s=e.getContext("2d"),a=r.pixelRatio;return s.save(),s.translate(0,t.height),s.scale(1,-1),r.region&&s.translate(-r.region.x,-r.region.y),s.scale(a,a),t=this._renderFunctions.renderOverlay(e,t),s.restore(),t}_readbackScreenshot(e,t){return e.resample?this._readbackScreenshotResampled({...e,resample:e.resample},t):this._readbackScreenshotImmediate(e,t)}_readbackScreenshotResampled(e,t){const{framebufferWidth:r,framebufferHeight:s,region:a,resample:n}=e,o=this._ensureScreenshotEncodeCanvas();let l=b1(r,s,o);this._rctx.gl.readPixels(0,0,r,s,St.RGBA,Cp.UNSIGNED_BYTE,new Uint8Array(l.data.buffer)),t(),l=this._renderScreenshotOverlay(o,l,{...e,region:void 0});const c=b1(a.width,a.height,o);return _9(l,c,!0,n.region.x,s-(n.region.y+n.region.height),n.region.width,n.region.height)}_readbackScreenshotImmediate(e,t){const{framebufferHeight:r,region:s}=e,a=this._ensureScreenshotEncodeCanvas(),n=b1(s.width,s.height,a);return this._rctx.gl.readPixels(s.x,r-(s.y+s.height),s.width,s.height,St.RGBA,Cp.UNSIGNED_BYTE,new Uint8Array(n.data.buffer)),t(),this._renderScreenshotOverlay(a,n,e)}_renderScreenshot(e,t,r){let s=null,a=null;const n=e.viewCamera,{framebufferWidth:o,framebufferHeight:l}=t;let c=!1;const h=t.disableDecorations&&e.frameHasDecorations,u=o!==n.fullWidth||l!==n.fullHeight,p=t.ignorePadding&&n.pixelRatio!==t.pixelRatio,m=u||h||p||t.objectAndLayerIdColor;if(t.objectAndLayerIdColor&&(a=new Rs(this._rctx,{width:o,height:l,colorTarget:la.TEXTURE,depthStencilTarget:La.DEPTH_STENCIL_RENDER_BUFFER})),m){const x=n.clone();if(t.ignorePadding){const O=lv(x.padding);for(let R=0;R<4;R++)O[R]=Math.round(O[R]/x.pixelRatio*t.pixelRatio);x.padding=O}x.fullWidth=o,x.fullHeight=l,x.pixelRatio=t.pixelRatio;const S=n.fovX-x.fovX,C=n.fovY-x.fovY;S<0&&S<C?x.fovX=n.fovX:C<0&&C<S&&(x.fovY=n.fovY),this._forceCameraHook(x),c=!0,s=new Rs(this._rctx,{width:x.fullWidth,height:x.fullHeight,colorTarget:la.TEXTURE,depthStencilTarget:La.DEPTH_STENCIL_RENDER_BUFFER}),this._renderFunctions.renderScene(s,a,x,t.disableDecorations?nf.OFF:nf.ON,r),this._disposeOffscreenBuffers()}const f=()=>{this._rctx.bindFramebuffer(null),De(s)},y=this._readbackScreenshot(t,f);f();let b=null;if(t.objectAndLayerIdColor){const x=()=>{this._rctx.bindFramebuffer(null),De(a)};this._rctx.bindFramebuffer(a),b=this._readbackScreenshot(t,x),this._rctx.bindFramebuffer(null),x()}if(m&&!this._rctx.contextAttributes.alpha)for(let x=3;x<y.data.length;x+=4)y.data[x]=255;if(b&&!this._rctx.contextAttributes.alpha)for(let x=3;x<b.data.length;x+=4)b.data[x]=255;return c&&this._forceCameraHook(n),[y,b]}_ensureScreenshotEncodeCanvas(){return this._screenshotEncodeCanvas||(this._screenshotEncodeCanvas=document.createElement("canvas")),this._screenshotEncodeCanvas}}let $r=class extends Ie{constructor(e){super({}),this.events=new Ms,this.waterTextureRepository=new bg,this._magnifierHelper=new cp,this.objectAndLayerIdRenderHelper=vi("enable-feature:objectAndLayerId-rendering")?new Qee:null,this._needsUpdate=!0,this._needsRender=!0,this._idleSuspend=!0,this._needsWaterReflectionUpdate=!1,this._lastAnimationUpdate=0,this._container=e.container,this._viewingMode=e.viewingMode,this._initializeContext(e),te(()=>{var r;return(r=this.waterTextureRepository)==null?void 0:r.updating},()=>this.requestRender(),Ji),this._magnifierHelper.events.on("request-render",()=>this.requestRender()),this._stippleTextureRepository=new lL(this._rctx),this._shaderTechniqueRepository=new sL({rctx:this._rctx,viewingMode:e.viewingMode,stippleTextureRepository:this._stippleTextureRepository,waterTextureRepository:this.waterTextureRepository}),this._textureRepository=new hp(e,this._shaderTechniqueRepository,this._rctx),this._textureRepository.events.on("changed",r=>this.requestRender(r)),this._materialRepository=new aL(this._textureRepository,this._shaderTechniqueRepository,()=>this.requestRender(),()=>this.requestRender()),this._compositingHelper=new Ree(this._rctx,this._shaderTechniqueRepository),this.renderer=new Xa(e,this._materialRepository,this._textureRepository,this._shaderTechniqueRepository,this._rctx,this._compositingHelper,this._magnifierHelper,r=>this.requestRender(r));const t={renderScene:(r,s,a,n,o)=>this.renderer.render(r,s,{camera:a,contentCamera:a,mode:ii.IDLE},n,o),requestRenderScene:r=>this.requestRender(r),prepareOverlay:()=>e.options.screenshot.prepareOverlay(),renderOverlay:(r,s)=>e.options.screenshot.renderOverlay(r,s)};this._screenshotManager=new Lie(this._rctx,t,r=>this.events.emit("force-camera-for-screenshot",r),()=>this.renderer.disposeOffscreenBuffers()),this._registerFrameTask(e)}normalizeCtorArgs(){return{}}destroy(){this._container.contains(this._canvas)&&this._container.removeChild(this._canvas),this._frameTask=fo(this._frameTask),this._shaderTechniqueRepository=Te(this._shaderTechniqueRepository)}get performanceInfo(){const e=this._rctx.gl;return{renderer:this.renderer.performanceInfo,textureMemory:e.getUsedTextureMemory!==void 0?e.getUsedTextureMemory():void 0,renderbufferMemory:e.getUsedRenderbufferMemory!==void 0?e.getUsedRenderbufferMemory():void 0,VBOMemory:e.getUsedVBOMemory!==void 0?e.getUsedVBOMemory():void 0}}requestRender(e=Wi.UPDATE){this._needsRender=!0,e===Wi.UPDATE&&(this._needsUpdate=!0)}get updating(){return this._needsUpdate||this._needsWaterReflectionUpdate||this.renderer.updating||this._textureRepository.updating||this.waterTextureRepository.updating||this._magnifierHelper.updating}get textureRepository(){return this._textureRepository}get compositingHelper(){return this._compositingHelper}set magnifier(e){this._magnifierHelper.magnifier=e}setIdleSuspend(e){this._idleSuspend!==e&&(this._idleSuspend=e,this.requestRender())}get renderingContext(){return this._rctx}get capabilities(){return this._rctx.capabilities}get canvas(){return this._canvas}takeScreenshot(e){return this._screenshotManager.takeScreenshot(e).then(t=>t[0])}takeScreenshotWithOID(e){return e.objectAndLayerIdColor=!0,this._screenshotManager.takeScreenshot(e)}getAlpha(){return!!this._rctx.contextAttributes.alpha}getMinimalDepthForArea(e,t,r,s,a,n=a){const o=s.constrainWindowSize(t,r,a*s.pixelRatio,n*s.pixelRatio),l=this._ensureDepthBuffer(o);this.renderer.readDepthPixels(s,o,l);let c=Number.MAX_VALUE;for(let h=0;h<o[2]*o[3];h++){const u=Iee(4*h,l,s.nearFar);c>u&&u!==s.nearFar[0]&&u!==s.nearFar[1]&&(c=u)}if(g(e)){const h=e.pickDepth(t*s.pixelRatio,r*s.pixelRatio,s);g(h)&&c>h&&h!==s.nearFar[0]&&h!==s.nearFar[1]&&(c=h)}return c===Number.MAX_VALUE?void 0:c}_ensureDepthBuffer(e){const t=4*e[2]*e[3];return(P(this._tmpDepthBuffer)||this._tmpDepthBuffer.byteLength<t)&&(this._tmpDepthBuffer=new Uint8Array(t)),this._tmpDepthBuffer}async reloadShaders(){R$(),await this._shaderTechniqueRepository.reloadAll(),this.requestRender()}_registerFrameTask(e){const t=e.view.state;let r=!1,s=Wi.BACKGROUND,a=!1;const n={preRender:({time:o})=>{r=this.updating,s=this._needsUpdate?Wi.UPDATE:Wi.BACKGROUND,e.commitSyncLayers();const l=Je(o-this._lastAnimationUpdate);if(l>this.renderer.animationTimestep||g(t.forcedAnimationTime)||r||this._needsRender){const c=Je(l/this.renderer.animationTimeDilation),h=new j3(t.camera,c,t.forcedAnimationTime);this.renderer.updateAnimation(h)&&this.requestRender(Wi.BACKGROUND),this._lastAnimationUpdate=o}},render:({time:o})=>{if((this._needsRender||!this._idleSuspend||!this.renderer.isCameraFinal||this._needsWaterReflectionUpdate)&&t.camera.fullWidth>0&&t.camera.fullHeight>0){const l=this._needsUpdate&&this._idleSuspend&&this.renderer.isCameraFinal;this._needsRender=!1,this._needsUpdate=!1,this._needsWaterReflectionUpdate=!1,this.renderer.render(null,null,t,nf.ON,o),a=!0,l&&this.renderer.hasWaterReflection&&(this.requestRender(Wi.BACKGROUND),this._needsWaterReflectionUpdate=!0)}},update:({time:o})=>{const l=new Iie(t.camera,this.renderer.hasSlicePlane||this._magnifierHelper.enabled);this._textureRepository.update(),this._screenshotManager.update(l,o)},finish:()=>{a&&(this.renderer.finish(t.mode===ii.IDLE?s:Wi.UPDATE),a=!1)}};this._frameTask=uT(n)}_initializeContext(e){const t=e.options;this._canvas=t.canvas,this._canvas||(this._canvas=document.createElement("canvas")),this._canvas.setAttribute("style","width: 100%; height:100%; display:block;");const r={alpha:t.alpha||!1,premultipliedAlpha:!0,antialias:!1,depth:!0,stencil:t.stencil==null||t.stencil,powerPreference:"high-performance",preserveDrawingBuffer:t.preserveDrawingBuffer??!1},s=y9("3d",this._canvas,r);if(P(s)){const a=vi("esri-force-webgl");Pe.getLogger(this.declaredClass).error(a)}else this._rctx=this._newRenderingContext(s,e),this._loadShaderOnlyExtensions(),!t.alpha&&this._rctx.contextAttributes.alpha&&Pe.getLogger(this.declaredClass).error("WebGL context has alpha channel even though no alpha channel was requested"),!this._rctx.contextAttributes.alpha&&vi("safari")>=11&&(this._container.style.backgroundColor="black"),this._container.appendChild(this._canvas)}_newRenderingContext(e,t){const r={disabledExtensions:t.options.deactivatedWebGLExtensions||{},debugWebGLExtensions:t.options.debugWebGLExtensions||{},maxAnisotropy:8},s=(a,n)=>t.view.resourceController.memoryController.newCache(a,n);return new Aie(e,r,s)}_loadShaderOnlyExtensions(){this._rctx.capabilities.enable("standardDerivatives"),this._rctx.capabilities.enable("shaderTextureLOD"),this._rctx.capabilities.enable("textureFloat")}getObjectAndLayerIdColor(e){return g(this.objectAndLayerIdRenderHelper)?this.objectAndLayerIdRenderHelper.getObjectAndLayerIdColor(e):null}get componentObjectCollection(){return P(this._componentObjectCollection)&&(this._componentObjectCollection=new yee(this.renderer.renderPassManager,this._viewingMode)),this._componentObjectCollection}set componentObjectCollection(e){this._componentObjectCollection=e}};d([v({type:Boolean,readOnly:!0})],$r.prototype,"updating",null),d([v({autoDestroy:!0})],$r.prototype,"_rctx",void 0),d([v({autoDestroy:!0})],$r.prototype,"_container",void 0),d([v({autoDestroy:!0})],$r.prototype,"_canvas",void 0),d([v({autoDestroy:!0})],$r.prototype,"_stippleTextureRepository",void 0),d([v({autoDestroy:!0})],$r.prototype,"waterTextureRepository",void 0),d([v({autoDestroy:!0})],$r.prototype,"_magnifierHelper",void 0),d([v({readOnly:!0})],$r.prototype,"objectAndLayerIdRenderHelper",void 0),d([v({autoDestroy:!0})],$r.prototype,"_textureRepository",void 0),d([v({autoDestroy:!0})],$r.prototype,"_compositingHelper",void 0),d([v({autoDestroy:!0,readOnly:!0})],$r.prototype,"renderer",void 0),d([v({autoDestroy:!0})],$r.prototype,"_screenshotManager",void 0),d([v()],$r.prototype,"componentObjectCollection",null),d([v({autoDestroy:!0})],$r.prototype,"_componentObjectCollection",void 0),d([v()],$r.prototype,"_needsUpdate",void 0),d([v()],$r.prototype,"_needsWaterReflectionUpdate",void 0),$r=d([Y("esri.views.3d.webgl-engine.parts.RenderView")],$r);let wa=class extends Ie{constructor(i){super(i),this._handles=new Vi,this._model=new ty,this._layers=new At,this._asyncChangeSet=new Tw,this._syncChangeSet=new Tw,this._layerSyncSet=new Set}initialize(){this._set("renderView",new $r(this)),this._frameTask=this.view.resourceController.scheduler.registerTask(Zi.STAGE,this),this._handles.add(this._frameTask)}destroy(){this._handles.destroy()}get viewingMode(){return this.view.state.viewingMode}get updating(){return this.running||this.renderView.updating||this._frameTask.updating}get renderer(){var i;return(i=this.renderView)==null?void 0:i.renderer}add(i){this._model.add(i),By(i)&&(i.attachStage(this),this._addLayer(i)),this.renderView.requestRender()}remove(i){P(i)||(this.renderView.requestRender(),this._model.remove(i),By(i)&&(this._removeLayer(i),i.detachStage()))}addMany(i){g(i)&&(this._model.addMany(i),this.renderView.requestRender())}removeMany(i){g(i)&&(this._model.removeMany(i),this.renderView.requestRender())}async load(i,e){P(i)||(Array.isArray(i)||(i=[i]),await Promise.all(i.filter(t=>P(t.glTexture)).map(t=>this.schedule(()=>this._model.has(t)?t.load(this.renderView.renderingContext,()=>this.renderView.textureRepository.textureTechnique):null),e)))}loadImmediate(i){return i.load(this.renderView.renderingContext,()=>this.renderView.textureRepository.textureTechnique)}forEachOfType(i,e){this._model.forEachOfType(i,e)}handleEvent(i,e){this.destroyed||(this._model.dirtySet[i](e),this.renderView.requestRender())}get running(){return this._model.dirtySet.dirty||!this._asyncChangeSet.empty}runTask(i){this._frameTask.processQueue(i),this._commit(i)}_commit(i){const e=this._model.dirtySet;this._asyncChangeSet.empty||i.done||(this.renderer.modify(this._asyncChangeSet,i),this.renderView.requestRender(),i.madeProgress()),this._layers.forAll(t=>{if(i.done)return;const r=this._layerSyncSet.has(t.id)||t.updatePolicy===ah.SYNC,s=r?this._syncChangeSet:this._asyncChangeSet;e.commitLayer(t.id,s),this._layerSyncSet.delete(t.id),s.empty||(this.renderer.modify(s,r?Ea:i),this.renderView.requestRender(),i.madeProgress())}),this._syncChangeSet.empty||(this.renderer.modify(this._syncChangeSet,Ea),this.renderView.requestRender(),i.madeProgress()),this._layers.forAll(t=>{i.done||this._layerSyncSet.has(t.id)||t.updatePolicy!==ah.ASYNC||(e.commitLayer(t.id,this._asyncChangeSet),this._asyncChangeSet.empty||(this.renderer.modify(this._asyncChangeSet,i),this.renderView.requestRender(),i.madeProgress()))}),this._layerSyncSet.clear(),this.notifyChange("running")}commitSyncLayers(){const i=this._model.dirtySet;this._layers.forAll(e=>{(this._layerSyncSet.has(e.id)||e.updatePolicy===ah.SYNC)&&(i.commitLayer(e.id,this._syncChangeSet),this._layerSyncSet.delete(e.id))});for(const e of this._layerSyncSet)i.commitLayer(e,this._syncChangeSet);this._layerSyncSet.clear(),this._syncChangeSet.empty||(this.renderer.modify(this._syncChangeSet,Ea),this.renderView.requestRender())}_commitLayer(i){this._model.dirtySet.commitLayer(i.id,this._syncChangeSet),this._layerSyncSet.delete(i.id),this._syncChangeSet.empty||(this.renderer.modify(this._syncChangeSet,Ea),this.renderView.requestRender())}schedule(i,e){return this._frameTask.schedule(i,e)}reschedule(i,e){return this._frameTask.reschedule(i,e)}syncLayer(i){this._layerSyncSet.add(i),this.renderView.requestRender()}getObject(i){return this._model.getObject(i)}get layers(){return this._layers}_addLayer(i){this._layers.includes(i)||this._layers.push(i)}_removeLayer(i){this._commitLayer(i),this._layers.removeUnordered(i)!=null&&(this._model.dirtySet.getResidentRenderGeometries(i.id,this._syncChangeSet.removes),this.renderer.modify(this._syncChangeSet,Ea))}addRenderPlugin(i,e,t){const r=this.renderer.renderPlugins.add(i,e,t),s=()=>{XR(e)&&this.view.sceneIntersectionHelper.addIntersectionHandler(e)};if(dv(r))return r.then(s);s()}removeRenderPlugin(i){XR(i)&&this.view.sceneIntersectionHelper.removeIntersectionHandler(i),this.renderer.renderPlugins.remove(i)}get performanceInfo(){return{renderView:this.renderView.performanceInfo,model:this._model.getStats()}}get test(){const i=this;return{getCount:e=>i._model.test.content.filter(t=>t.type===e).length,model:i._model}}};wa.DebugSettings={endFrameContentValidation:!1},d([v({constructOnly:!0})],wa.prototype,"view",void 0),d([v({constructOnly:!0})],wa.prototype,"options",void 0),d([v({readOnly:!0})],wa.prototype,"viewingMode",null),d([v({constructOnly:!0})],wa.prototype,"container",void 0),d([v({constructOnly:!0})],wa.prototype,"_handles",void 0),d([v({readOnly:!0})],wa.prototype,"updating",null),d([v({constructOnly:!0})],wa.prototype,"_model",void 0),d([v({autoDestroy:!0})],wa.prototype,"renderView",void 0),d([v({readOnly:!0})],wa.prototype,"renderer",null),d([v({readOnly:!0})],wa.prototype,"running",null),wa=d([Y("esri.views.3d.webgl-engine.Stage")],wa);class Eue extends Ev{constructor(e,t,r,s){super(t,r),this.point=e,this.createGraphic=s}}function h4(i){return So(i)&&i.intersector===ci.PCL&&!!i.target}class Aue extends uD{constructor(e,t,r,s,a){super(e),this.layerUid=e,this.sublayerUid=t,this.nodeIndex=r,this.componentIndex=s,this.triangleNr=a}}class Mue extends Ev{constructor(e,t,r){super(t,null),this.point=e,this.createVoxelGraphic=r}}function Kv(i){return So(i)&&i.intersector===ci.I3S&&!!i.target}function d4(i){return So(i)&&i.intersector===ci.VOXEL&&!!i.target}function RA(i,e){var t,r;return Av(i)||Mv(i)?Nf((t=i.target)==null?void 0:t.object.metadata,e):Pj(i)?(r=e.map)==null?void 0:r.ground:h4(i)||Kv(i)||xL(i)||d4(i)?Nf(i.target,e):null}function Due(i,e){const t=tT(i,e);return g(t)&&t.type==="graphic"?t.graphic:null}function tT(i,e){var t;if(P(i))return null;if(Av(i)||Mv(i))return EA((t=i.target)==null?void 0:t.object.metadata,e);if(h4(i)){const r=i.target.createGraphic();return{type:"graphic",graphic:r,layer:r.layer}}if(d4(i)){const r=i.target.createVoxelGraphic();return{type:"graphic",graphic:r,layer:r.layer}}return xL(i)||eS(i)?EA(i.target,e):Kv(i)?$ie(i.target,e):null}function EA(i,e){if(P(i)||P(i.graphicUid))return null;const t=Nf(i,e);if(P(t))return null;if(t===e.graphics)return P(e.graphicsView)||typeof i.graphicUid!="number"?null:e.graphicsView.getHit(i.graphicUid);const r=e.allLayerViews.find(s=>s.layer===t);return!r||r.suspended||P(i.graphicUid)?null:"getHit"in r?r.getHit(i.graphicUid):null}function $ie(i,e){const t=Nf(i,e);if(P(t))return null;const r=e.allLayerViews.find(s=>s.layer===t);return r&&!r.suspended&&"getGraphicFromIntersectorTarget"in r?Fie(r.getGraphicFromIntersectorTarget(i)):null}function Nie(i,e){const t=Nf(i,e);if(P(t))return null;const r=e.allLayerViews.find(s=>s.layer===t);return r&&!r.suspended&&"getAABBFromIntersectorTarget"in r?r.getAABBFromIntersectorTarget(i):null}function Fie(i){return g(i)?{type:"graphic",graphic:i,layer:i.layer}:null}function Nf(i,e){return!i||P(i.layerUid)?null:g(e.graphicsView)&&i.layerUid===e.graphicsView.processor.layer.id?e.graphics:e.map.findLayerByUid(i.layerUid)}function Iue(i,e){if(Av(i)||Mv(i))return f3(i.target.object.boundingVolumeWorldSpace.bounds);if(eS(i)){v9(S0,i.transformation);const t=Math.max(S0[0],S0[1],S0[2]);return i.target.baseBoundingSphere.radius*t}return Kv(i)?th(Nie(i.target,e),t=>.5*r3(t)):null}function Lue(i){return!Av(i)&&!Mv(i)&&(eS(i)?i.target.numLodLevels>1:!!Kv(i))}const S0=T();async function zie(i,e){if(i.type==="2d")return i.hitTest(e);const t=await i.hitTest(e);if(t.results.length===0)return t;const r=t.results[0],s=(Si(r.distance)??0)*(1+Uie),a=t.results.findIndex(n=>(n.distance??0)>s);return a!==-1&&(t.results=t.results.slice(0,a)),t}const Uie=.05;let ay=class extends b9{constructor(i){super(i),this.components=["attribution","zoom","navigation-toggle","compass"]}};d([v()],ay.prototype,"components",void 0),ay=d([Y("esri.views.ui.3d.DefaultUI3D")],ay);const u4=ay;let Se=class extends x9(w9(T9(F9))){constructor(i){super(i),this._userClippingArea=null,this._clippingArea=null,this._initialDefaultSpatialReference=null,this._defaults={},this._externallySet={environment:!1},this._createGraphicsViewController=null,this._lostWebGLContextHandle=null,this._resolveWhenReady=[],this._propertiesPool=new hh({slicePlane:mM},this),this._resourceController=DZ(this),this._defaultToMapOptions={include:new Set},this._defaultHitTestOptions={exclude:new Set},this.deconflictor=new vw({view:this}),this.labeler=new ld({view:this,deconflictor:this.deconflictor.labels}),this.sharedSymbolResources=null,this.analyses=new p3,this.basemapTerrain=null,this.elevationProvider=null,this.canvas=null,this.constraints=new ud,this.environmentManager=new Xn,this.floors=new Od,this.fullOpacity=1,this.graphicsView=null,this.analysisViewManager=new iz({view:this}),this.groundView=null,this.map=null,this.screenSizePerspectiveEnabled=!0,this.state=new cZ,this.spatialReference=null,this.alphaCompositingEnabled=!1,this.preserveDrawingBufferEnabled=!1,this.supersampleScreenshotsEnabled=!0,this.type="3d",this.ui=new u4,this._numUpdating=0,this._lastUpdateTime=0,this.updatingProgress=.5,this.highlightOptions=new $w,this.voxelWasm=null,this.voxelWasmPromise=null,C9(),i&&i.environment||(this._defaults.environment=new rp,this.environment=this._defaults.environment);const e=(t=null)=>{g(t)&&t.type===t2.MOVE||(this._updatingChanged(),this.map&&this.map.allLayers.forEach(async r=>{try{await r.when()}catch{}this._updatingChanged()}))};this.handles.add([ll(()=>{var t;return(t=this.map)==null?void 0:t.allLayers},"after-changes",t=>e(t),{onListenerAdd:()=>e(),onListenerRemove:()=>e(),sync:!0}),this.allLayerViews.on("after-changes",t=>this._updateUpdatingMonitors(t)),te(()=>this.map,t=>{t&&"load"in t&&t.load&&t.load().catch(()=>{})})]),this.inputManager=new XB({view:this}),this.stateManager=new rr({view:this})}initialize(){this.groundView=new ez({view:this}),this._updateUpdatingMonitors();const i=()=>this._updateDefaultToMapOptions();this.handles.add(ll(()=>{var e;return(e=this.map)==null?void 0:e.allLayers},"after-changes",i,{onListenerAdd:i,onListenerRemove:i})),this.updatingHandles.add(()=>this.qualitySettings.memoryLimit,e=>{this.resourceController&&(this.resourceController.memoryController.maxMemory=e)},Ji),this.updatingHandles.add(()=>this.qualitySettings.additionalCacheMemory,e=>{this.resourceController&&(this.resourceController.memoryController.additionalCacheMemory=e)},Ji),this.updatingHandles.add(()=>this.qualitySettings.frameRate??0,e=>S9(e>0?1e3/Math.ceil(e):0),Ji),this.updatingHandles.add(()=>{var e;return(e=this.map)==null?void 0:e.ground},i,Qi),this.updatingHandles.add(()=>{var e,t;return(t=(e=this.map)==null?void 0:e.ground)==null?void 0:t.opacity},()=>this._updateDefaultHitTestOptions(),Qi),this.handles.add(te(()=>this.spatialReference,()=>this.notifyChange("clippingArea"),Bt))}destroy(){this.destroyed||(this.invalidate(),this.activeTool=null,this.layerViewManager.clear(),this._exitSurface(),this._disposeGraphicsView(),this.sharedSymbolResources=Te(this.sharedSymbolResources),this._set("labeler",Te(this.labeler)),this._set("deconflictor",Te(this.deconflictor)),this._resourceController=Te(this._resourceController),this._set("stateManager",Te(this.stateManager)),this._set("inputManager",Te(this.inputManager)),this.state.destroy(),this._propertiesPool.destroy(),this.handles.remove("updatingMonitors"),this._set("environmentManager",Te(this.environmentManager)),this.groundView=Te(this.groundView))}get renderSpatialReference(){return this.renderCoordsHelper&&this.renderCoordsHelper.spatialReference}get basemapSpatialReference(){var i;return(i=this.basemapTerrain)==null?void 0:i.spatialReference}get animation(){var i;return(i=this.state)==null?void 0:i.animation}get camera(){var i;return(i=this.stateManager)==null?void 0:i.camera}set camera(i){this.stateManager&&(this.stateManager.camera=i)}get contentCamera(){var i;return(i=this.stateManager)==null?void 0:i.contentCamera}set contentCamera(i){this.stateManager&&(this.stateManager.contentCamera=i)}installContentCameraReset(i={sticky:!1}){return this.stateManager.installContentCameraReset(i)}get center(){var i;return(i=this.stateManager)==null?void 0:i.center}set center(i){this.stateManager&&(this.stateManager.center=i)}get clippingArea(){var e;if(this.viewingMode==="global")return null;let i=this._userClippingArea||("clippingArea"in this.map?(e=this.map)==null?void 0:e.clippingArea:void 0);return!(this._userClippingArea||this.get("map.clippingEnabled"))||P(i)?(this._clippingArea=null,null):i instanceof ds?this.spatialReference&&(i=P0(i,this.spatialReference),P(i))?(Pe.getLogger(this.declaredClass).error("#clippingArea","setting clippingArea with incompatible SpatialReference"),this._clippingArea):(i=i.clone(),P(i.intersection(this._groundAndLayersExtent))&&(i.xmin=i.xmax,i.ymin=i.ymax),i.zmin=void 0,i.zmax=void 0,i.equals(this._clippingArea)||(this._clippingArea=i),this._clippingArea):(Pe.getLogger(this.declaredClass).error("#clippingArea","only clippingArea geometries of type Extent are supported"),this._clippingArea)}set clippingArea(i){this.ready&&this.viewingMode==="global"&&g(i)?Pe.getLogger(this.declaredClass).error("#clippingArea=","Clipping area is only supported in local viewingMode"):this._userClippingArea=i}get renderDataExtent(){if(this.state.viewingMode===ve.Global)return null;const i=this.renderSpatialReference,e=this.dataExtent;return P(e)||P(i)||e.spatialReference.equals(i)?e:P0(e,i)}get dataExtent(){let i=this._groundAndLayersExtent;const e=this.spatialReference||li.WGS84,t=P0(this.clippingArea,e);g(t)&&(i=g(i)?i.intersection(t):t);const r=this._get("dataExtent");return g(i)&&i.equals(r)?r:i}get _groundAndLayersExtent(){const i=this.spatialReference||li.WGS84;let e;const t=a=>{const n=P0(a,i);P(n)||(g(e)?e.union(n):e=n.clone())},r=this.basemapTerrain;if(r!=null&&r.spatialReference){const a=r.groundExtent;t(new ds({xmin:a[0],ymin:a[1],zmin:0,xmax:a[2],ymax:a[3],zmax:0,spatialReference:r.spatialReference}))}if(this.map){const a=n=>{!g(n.fullExtent)||n.type==="graphics"&&n.internal||t(n.fullExtent)};this.map.allLayers.forEach(n=>a(n))}if(P(e))return null;e.hasZ?(e.zmin=Math.min(0,e.zmin??0),e.zmax=Math.max(0,e.zmax??0)):(e.zmin=0,e.zmax=0);const s=this._get("_groundAndLayersExtent");return e.equals(s)?s:e}set environment(i){i!==this._defaults.environment&&(this._externallySet.environment=!0),this._set("environment",i)}castEnvironment(i){return i?i instanceof rp?i:i instanceof $M?this.environment!=null?this.environment.cloneWithWebsceneEnvironment(i):rp.fromWebsceneEnvironment(i):P9(rp,i):new rp}get extent(){var i;return(i=this.stateManager)==null?void 0:i.extent}set extent(i){this.stateManager&&(this.stateManager.extent=i)}get screenCenter(){var i;return(i=this.stateManager)==null?void 0:i.screenCenter}get frustum(){var i;return(i=this.stateManager)==null?void 0:i.frustum}get initialExtentRequired(){return this.stateManager&&!this.stateManager.hasInitialView}get _defaultsFromMapSettings(){return{required:{tileInfo:!1,heightModelInfo:!0,extent:!1}}}get interacting(){return this.navigating||g(this.activeTool)&&this.activeTool.visible}get stationary(){return!this.animation&&!this.resizing&&(P(this.state)||this.state.stationary)}get navigating(){var i;return((i=this.state)==null?void 0:i.navigating)??!1}get padding(){var i;return(i=this.stateManager)==null?void 0:i.padding}set padding(i){this.stateManager&&(this.stateManager.padding=i)}set qualityProfile(i){W0.isValidProfile(i)&&(W0.apply(i,this.qualitySettings),this._set("qualityProfile",i))}get qualityProfile(){return this._get("qualityProfile")||W0.getDefaultProfile()}set slicePlane(i){if(g(this._stage)&&this._stage.renderer.setParameters({slicePlane:i}),P(i))return void this._set("slicePlane",null);const e=this._propertiesPool.get("slicePlane");Qd(i,e),this._set("slicePlane",e)}get typeSpecificPreconditionsReady(){return!!this.viewingMode}get resolution(){return this.spatialReference!=null?oF(this.scale,this.spatialReference):0}get scale(){var i;return(i=this.stateManager)==null?void 0:i.scale}set scale(i){this.stateManager&&(this.stateManager.scale=i)}get heightModelInfo(){const i=this.getDefaultHeightModelInfo();return i!=null?O9.deriveUnitFromSR(i,this.spatialReference):null}get updating(){var s,a,n;if(this.destroyed)return!1;let i=0,e=this.layerViewManager.updating,t=e?this.layerViewManager.updatingRemaining:0;this.allLayerViews.forEach(o=>{if(o.isFulfilled()){if(o.updating){if(e=!0,o.suspended||Af(o))return;++t,i+=o.updatingProgress}}else++t});for(const o of[this.graphicsView,this.basemapView,this._resourceController,this._stage,this.featureTiles,this.pointsOfInterest,this.environmentManager,this.overlay,this._featureTreeDebugger,this.toolViewManager,this.analysisViewManager])g(o)&&o.updating&&(t+=.1,i+=.5*.1);for(const o of[this.deconflictor,this.labeler,this.basemapTerrain])g(o)&&o.updating&&(++t,i+=o.updatingProgress);const r=this.stateManager.test.updatingIgnoreRenderState?ii.IDLE:this.state.mode;if(e=!!(e||t>0||this.updatingHandles.updating||!this.ready||!this.stationary||r!==ii.IDLE||this._createGraphicsViewController||(s=this.inputManager)!=null&&s.hasPendingInputs||(n=(a=this.map)==null?void 0:a.allLayers)!=null&&n.some(o=>!o.isFulfilled())),e?(this._numUpdating=Math.max(t,this._numUpdating),i+=this._numUpdating-t):this._numUpdating=0,this._numUpdating>0?i/=this._numUpdating:i=e?0:1,this._get("updatingProgress")!==i){const o=performance.now();if(i<1){const l=Math.min((o-this._lastUpdateTime)/2e3,1);i=this.updatingProgress*(1-l)+i*l}this._set("updatingProgress",i),this._lastUpdateTime=e&&i<1?o:0}return e}get viewingMode(){var t;const i=this._predeterminedViewingMode;if(g(i))return d1(i);const e=this.spatialReference;return e?g((t=this.defaultsFromMap)==null?void 0:t.viewingMode)&&e.equals(this.defaultsFromMap.spatialReference)?d1(this.defaultsFromMap.viewingMode):Iy(e,ve.Global)?"global":"local":"global"}set viewingMode(i){this.ready?Pe.getLogger(this.declaredClass).error("#viewingMode","viewingMode cannot be set once view is ready"):this._overrideIfSome("viewingMode",i)}get viewpoint(){var i;return(i=this.stateManager)==null?void 0:i.viewpoint}set viewpoint(i){this.stateManager&&(this.stateManager.viewpoint=i)}get zoom(){return this.stateManager.zoom}set zoom(i){this.stateManager&&(this.stateManager.zoom=i)}get resourceController(){return this._resourceController}get performanceInfo(){return new sY(this)}on(i,e,t,r){return this.viewEvents.on(i,e,t,r)||super.on(i,e)}hasEventListener(i){return super.hasEventListener(i)||this.viewEvents.hasHandler(i)}toMap(i,e){if(!this.ready)return Pe.getLogger(this.declaredClass).error("#toMap()","Scene view cannot be used before it is ready"),null;const t=e?this.externalToInternalIntersectOptions(e):this._defaultToMapOptions,r=g(t.graphics)&&(g(t.graphics.include)||g(t.graphics.exclude)),s=QS(i)?ZS(this,i):i,a=Zo(s);t.enableDraped=t.include&&!t.include.has(jc)||t.exclude&&t.exclude.has(jc);const n=this.sceneIntersectionHelper,o=zn(this.state.viewingMode);if(o.options.selectionMode=!0,o.options.store=r?Vr.ALL:Vr.MIN,n.intersectIntersectorScreen(a,o,t),r){for(const l of o.results.all){const c=tT(l,this);if(P(c))return this._intersectResultToMapPoint(l);if(c.type!=="graphic"||this._testGraphicUidFilter(t.graphics,c.graphic))return this._intersectResultToMapPoint(l)}return null}return this._intersectResultToMapPoint(o.results.min)}toScreen(i){if(!this.ready)return Pe.getLogger(this.declaredClass).error("#toScreen()","Scene view cannot be used before it is ready"),null;const e=je(i.z==null?rl(this.elevationProvider,i):null,0);return ts(i,Ku,this.renderSpatialReference,e),this.state.camera.projectToScreen(Ku,gx),GA(gx[0],gx[1])}pixelSizeAt(i){return this.ready?i?(ts(i,Ku,this.renderSpatialReference),this.state.camera.computeScreenPixelSizeAt(Ku)):0:(Pe.getLogger(this.declaredClass).error("#pixelSizeAt()","Scene view cannot be used before it is ready"),null)}overlayPixelSizeInMapUnits(i){const e=this.basemapTerrain.overlayManager;return e?e.overlayPixelSizeInMapUnits(i):1}hitTest(i,e){if(!this.ready)return Pe.getLogger(this.declaredClass).error("#hitTest()","Scene view cannot be used before it is ready"),null;const t=QS(i)?ZS(this,i):i,r=Pi(t.x,t.y),s=e?this.externalToInternalIntersectOptions(e):this._defaultHitTestOptions;s.requiresGroundFeedback=!0,s.enableDraped=!0;const a=zn(this.state.viewingMode);a.options.selectionMode=!0,a.options.store=Vr.ALL,this.sceneIntersectionHelper.intersectIntersectorScreen(r,a,s);const n=this._intersectResultsToHits(a.results.all,s.graphics),o=a.results.ground,l=RA(o,this),c=g(l)&&"type"in l&&l.type==="integrated-mesh"?l:null,h={screenPoint:t,results:n,ground:{mapPoint:this._intersectResultToMapPoint(o),distance:So(o)?o.distanceInRenderSpace:0,layer:c}};return Ot.SCENEVIEW_HITTEST_RETURN_INTERSECTOR&&(h.intersector=a),Promise.resolve(h)}async popupHitTest(i){const{results:e,ground:t}=await zie(this,i);let r=null;return!(e.length===0||Math.abs(je(e[0].distance,0)-t.distance)<1e-5)||t.layer&&t.layer.type==="integrated-mesh"||(r=t.mapPoint),{results:e,screenPoint:i,mapPoint:r}}goTo(i,e){return this.updatingHandles.addPromise(this.stateManager.goTo(i,e))}async whenAnalysisView(i){if(P(i.parent))throw new bt("view:no-analysisview-for-analysis","The analysis has not been added to view.analyses",{analysis:i});switch(i.parent.type){case"line-of-sight":case"dimension":return(await this.whenLayerView(i.parent)).whenAnalysisView();default:return this.analysisViewManager.whenAnalysisView(i)}}whenLayerView(i){return super.whenLayerView(i)}async takeScreenshot(i){const e=this._completeSettings(i);await this.whenReady();const t=await this._stage.renderView.takeScreenshot(e);return u1(t,e,this._pixelFormat())}async _takeScreenshot(i){const e=this._completeSettings(i);await this.whenReady();const t=await this._stage.renderView.takeScreenshot(e);return p1(t,this._pixelFormat())}async _takeScreenshotWithObjectAndLayerId(i){const e=this._completeSettings(i);await this.whenReady();const t=await this._stage.renderView.takeScreenshotWithOID(e);return[p1(t[0],this._pixelFormat()),p1(t[1],this._pixelFormat())]}_completeSettings(i){const e=R9(i,this);return e.pixelRatio/=this.state.pixelRatio,E9(e,this.supersampleScreenshotsEnabled,this.padding)}_pixelFormat(){return{flipY:!0,premultipliedAlpha:this._stage.renderView.getAlpha()}}get test(){return{takeScreenshot:i=>this._takeScreenshot(i),takeScreenshotWithObjectAndLayerId:i=>this._takeScreenshotWithObjectAndLayerId(i)}}async takeScreenshotWithObjectAndLayerId(i){if(!vi("enable-feature:objectAndLayerId-rendering"))throw new Error("has enable-feature:objectAndLayerId-rendering must be true");const e=this._completeSettings(i);await this.whenReady();const t=await this._stage.renderView.takeScreenshotWithOID(e),r=u1(t[0],e,this._pixelFormat()),s=this._completeSettings(i);return s.format="png",[r,u1(t[1],s,this._pixelFormat())]}getColorToObjectAndLayerIdMapping(){if(P(this._stage.renderView.objectAndLayerIdRenderHelper))throw new Error("has enable-feature:objectAndLayerId-rendering must be true");return this._stage.renderView.objectAndLayerIdRenderHelper.getColorToObjectAndLayerIdMapping()}addUpdatingPromise(i){return this.updatingHandles.addPromise(i)}importLayerView(i){return E2.importLayerView(i)}hasLayerViewModule(i){return E2.hasLayerViewModule(i)}forceDOMReadyCycle(){this.forceReadyCycle()}getDefaultSpatialReference(){var i,e,t,r;return this.map&&"initialViewProperties"in this.map&&((e=(i=this.map)==null?void 0:i.initialViewProperties)==null?void 0:e.spatialReference)||((t=this.defaultsFromMap)==null?void 0:t.spatialReference)||((r=this.defaultsFromMap)==null?void 0:r.ready)&&this._initialDefaultSpatialReference||null}async validate(){let i=A9(this.type);const e=vi("safari");if(e&&e<9&&(i=new bt("sceneview:browser-not-supported","This browser is not supported by SceneView (Safari < 9)",{type:"safari",requiredVersion:9,detectedVersion:e})),g(i))throw Pe.getLogger(this.declaredClass).warn("#validate()",i.message),i}get _predeterminedViewingMode(){var e;const i=this._isOverridden("viewingMode")?this._get("viewingMode"):(this.map&&"initialViewProperties"in this.map?(e=this.map.initialViewProperties)==null?void 0:e.viewingMode:null)??null;return g(i)?YS(i):null}getSpatialReferenceSupport({spatialReference:i,layer:e}){const t=this._predeterminedViewingMode;if(g(t))return this._validateSpatialReferenceForViewingMode(i,e,t)?{constraints:this._makeSpatialReferenceConstraints(i,e,t)}:null;const r=this._validateSpatialReferenceForViewingMode(i,e,ve.Local),s=this._validateSpatialReferenceForViewingMode(i,e,ve.Global);return r||s?r&&s?{constraints:this._makeSpatialReferenceConstraints(i,e,null)}:r?{constraints:this._makeSpatialReferenceConstraints(i,e,ve.Local)}:{constraints:this._makeSpatialReferenceConstraints(i,e,ve.Global)}:null}_validateSpatialReferenceForViewingMode(i,e,t){return!!Iy(i,t)&&(!!P(e)||!!KS(e)||(!xg(e)||!P(qv(e,i,t)))&&(!JS(e)||t!==ve.Global))}_makeSpatialReferenceConstraints(i,e,t){if(P(e))return[{spatialReference:i,viewingMode:t}];const r=i.isWebMercator,s=i.isWGS84;return KS(e)&&(r||s)?!s||t===ve.Local||lS(e.tileInfo,e.fullExtent,i,ve.Global)===null?[{spatialReference:i,viewingMode:t},{spatialReference:li.WebMercator,viewingMode:t}]:[{spatialReference:r?li.WGS84:li.WebMercator,viewingMode:t}]:xg(e)||JS(e)||!r&&!s?xg(e)&&r&&t!==ve.Global?[{spatialReference:i,viewingMode:t},{spatialReference:li.WGS84,viewingMode:ve.Local}]:[{spatialReference:i,viewingMode:t}]:[{spatialReference:i,viewingMode:t},{spatialReference:r?li.WGS84:li.WebMercator,viewingMode:t}]}_validateSpatialReference(i){const e=g(this.getSpatialReferenceSupport({spatialReference:i})),t=this._predeterminedViewingMode;return e||(g(t)?Pe.getLogger(this.declaredClass).warnOnce(`Spatial reference defined on view not supported in ${d1(t)} viewing mode.`):i.isGeographic&&Pe.getLogger(this.declaredClass).warnOnce("Spatial reference is geographic but not supported.")),e}whenReady(){return new Promise(i=>{this.ready?i(this):this._resolveWhenReady.push(i)})}computeMapPointFromVec3d(i,e){let t=this.spatialReference||li.WGS84;return Jr(i,this.renderSpatialReference,i,t)||(t=li.WGS84,Jr(i,this.renderSpatialReference,i,t)),e?(e.x=i[0],e.y=i[1],e.z=i[2],e.spatialReference=t):e=new Ht(i,t),e}trackGraphicState(i){if(!i.graphic)return Pe.getLogger(this.declaredClass).error("trackGraphicState","GraphicState.graphic must not be null or undefined to start tracking"),null;const e=this.getViewForGraphic(i.graphic);let t=null,r=!1;const s=a=>{var n;!r&&g(a)&&"processor"in a&&((n=a.processor)==null?void 0:n.type)==="graphics-3d"&&a.processor.graphicsCore&&(t=a.processor.graphicsCore.trackGraphicState(i))};return g(e)?s(e):this.whenViewForGraphic(i.graphic,{waitForLayer:!0}).then(a=>s(a),()=>{}).catch(()=>{}),{remove:()=>{r=!0,g(t)&&(t.remove(),t=null)}}}highlight(i){if(Array.isArray(i))return e2(i.map(t=>this.highlight(t)));if(Od.isCollection(i))return e2(i.toArray().map(t=>this.highlight(t)));const e=this.getViewForGraphic(i);return e&&"highlight"in e?e.highlight(i):wx()}maskOccludee(i){if(!i)return Pe.getLogger(this.declaredClass).error("maskOccludee","GraphicState.graphic must not be null or undefined to mask an occludee"),null;const e=this.getViewForGraphic(i);let t=null,r=!1;const s=a=>{!r&&g(a)&&$9(a)&&(t=a.maskOccludee(i))};return g(e)?s(e):this.whenViewForGraphic(i,{waitForLayer:!0}).then(a=>s(a),()=>{}).catch(()=>{}),{remove:()=>{r=!0,g(t)&&(t.remove(),t=null)}}}getViewForGraphic(i){return i.layer===this.graphics?this.graphicsView:i.layer?this.allLayerViews.find(e=>e.layer===i.layer):null}graphicChanged(i){g(this.graphicsView)&&this.graphicsView.graphicChanged(i)}async whenViewForGraphic(i,e){if(i.layer===this)return await _x(()=>this.graphicsView),this.graphicsView;if(!i.layer||!this.map)throw new bt("no-view-for-graphic");return e&&e.waitForLayer&&!this.map.allLayers.includes(i.layer)?new Promise((t,r)=>{const s=this.map.allLayers.on("change",a=>{a.added.includes(i.layer)&&(s.remove(),this.whenLayerView(i.layer).then(t,r))})}):this.whenLayerView(i.layer)}externalToInternalIntersectOptions(i){const e=this._externalToInternalRenderItems(i.include,Vg.INCLUDE),t=this._externalToInternalRenderItems(i.exclude,Vg.EXCLUDE);return{include:e.layerUids,exclude:t.layerUids,graphics:{include:e.graphicUids,exclude:t.graphicUids}}}_intersectResultToMapPoint(i,e){return i.getIntersectionPoint(Ku)?(e=this.computeMapPointFromVec3d(Ku,e),i.intersector===ci.TERRAIN&&this.basemapTerrain&&(e.z=je(rl(this.basemapTerrain,e),0)),e):null}_intersectResultsToHits(i,e){const t=new Array;let r=null;for(let s=0;s<i.length;s++){const a=i[s],n=RA(a,this);if(g(n)&&(n===this.map.ground||"type"in n&&n.type==="integrated-mesh"))break;const o=tT(a,this);if(P(o))continue;if(o.type==="graphic"){if(P(r)&&s!==i.length-1&&(r=new Set),g(r)){const h=this._getGraphicFilterUid(o.graphic);if(r.has(h))continue;r.add(h)}if(!this._testGraphicUidFilter(e,o.graphic))continue}const l=this._intersectResultToMapPoint(a),c=a.distanceInRenderSpace;t.push({...o,mapPoint:l,distance:c})}return t}_getGraphicFilterUid(i){var s;const e=i.sourceLayer,t=i.layer,r=e&&"objectIdField"in e?e:t&&"objectIdField"in t?t:e;if(r){const a=r.objectIdField??M9,n=(s=i.attributes)==null?void 0:s[a];if(n)return`o-${r.id}-${n}`}return`u-${i.uid}`}_testGraphicUidFilter(i,e){const t=this._getGraphicFilterUid(e);return P(i)||(P(i.include)||i.include.has(t))&&(P(i.exclude)||!i.exclude.has(t))}_externalToInternalRenderItems(i,e,t={layerUids:void 0,graphicUids:void 0}){if(!i)return t;if(i instanceof nv)Vie(t,this._getGraphicFilterUid(i)),e===Vg.INCLUDE&&(g(this.graphicsView)&&i.layer===this?Wm(t,this.graphicsView.processor.layer.id):i.layer&&Wm(t,i.layer.uid));else if(D9(i))for(const r of i)r===this.graphics&&g(this.graphicsView)?Wm(t,this.graphicsView.processor.layer.id):r===this.map.ground?Wm(t,jc):this._externalToInternalRenderItems(r,e,t);else"uid"in i&&Wm(t,i.uid);return t}_initBasemapTerrain(){this._set("basemapTerrain",new RJ({view:this})),this._set("elevationProvider",new pg({view:this})),this.elevationProvider.register("ground",this.basemapTerrain)}_exitBasemapTerrain(){this.basemapTerrain&&(this.elevationProvider.unregister(this.basemapTerrain),this.elevationProvider.destroy(),this._set("elevationProvider",null),this.basemapTerrain.destroy(),this._set("basemapTerrain",null))}_initGlobe(){this._initCoordinateSystem(),this.state.createInitialCamera(),this._initBasemapTerrain(),this._set("pointsOfInterest",new js({view:this})),this._set("featureTiles",new Nr({renderCoordsHelper:this.renderCoordsHelper,cameraOnSurface:this.pointsOfInterest.cameraOnSurface,focus:this.pointsOfInterest.focus,tilingSchemeOwner:this.basemapTerrain,viewState:this.state,scheduler:this._resourceController.scheduler,terrain:this.basemapTerrain}));const i=()=>{var t;const e=(t=this.basemapTerrain)==null?void 0:t.extent;if(this.clippingArea||e)if(e&&this.basemapTerrain.spatialReference){const r=g(this.basemapTerrain.extent)&&g(this.basemapTerrain.spatialReference)?oT(MA(this.basemapTerrain.extent,this.basemapTerrain.spatialReference),this.spatialReference):null;g(this.clippingArea)?this.featureTiles.filterExtent=this.clippingArea.intersection(r):this.featureTiles.filterExtent=r}else this.featureTiles.filterExtent=this.clippingArea;else this.featureTiles.filterExtent=null};this.handles.add([this.updatingHandles.add(()=>Ot.FEATURE_TILE_TREE_SHOW_TILES,e=>{e&&this.featureTiles&&!this._featureTreeDebugger?this.updatingHandles.addPromise(_e(()=>import("./FeatureTileTree3DDebugger-c93e6e13.js"),["assets/FeatureTileTree3DDebugger-c93e6e13.js","assets/calcite-8912bd40.js","assets/index-00759e4a.js","assets/index-5026a37a.css","assets/calcite-96fa36fd.css","assets/TileTreeDebugger-1592735f.js"])).then(({FeatureTileTree3DDebugger:t})=>{!this._featureTreeDebugger&&Ot.FEATURE_TILE_TREE_SHOW_TILES&&(this._featureTreeDebugger=new t({view:this}))}):e||!this._featureTreeDebugger||Ot.FEATURE_TILE_TREE_SHOW_TILES||(this._featureTreeDebugger.destroy(),this._featureTreeDebugger=null)},Qi),this.updatingHandles.add(()=>this.clippingArea,i,Qi),this.updatingHandles.add(()=>this.basemapTerrain.extent,i,Qi)],"feature-tiles"),this.stateManager.init()}_exitGlobe(){this.state&&(this.stateManager.exit(),this.handles.remove("render-coords-helper"),this.handles.remove("feature-tiles"),this.featureTiles.destroy(),this._set("featureTiles",null),this.pointsOfInterest.destroy(),this._set("pointsOfInterest",null),this._exitBasemapTerrain(),this.state.exit(),this._exitCoordinateSystem())}_initCoordinateSystem(){if(this.spatialReference){const i=this.spatialReference;this.mapCoordsHelper&&this.mapCoordsHelper.spatialReference.equals(i)||this._set("mapCoordsHelper",new mZ(this.map,i));const e=this.state.isGlobal,t=RM(e,i);t!==this.renderSpatialReference&&(this._set("renderCoordsHelper",yZ.create(this.state.viewingMode,t)),e||this.handles.add(te(()=>{var r;return(r=this.basemapTerrain)==null?void 0:r.extent},r=>{const s=this.renderCoordsHelper.spatialReference;g(r)&&(r[0]!==0||r[1]!==0||r[2]!==0||r[3]!==0)&&hv(r,this.basemapTerrain.spatialReference,AA,s)&&(this.renderCoordsHelper.extent=AA)},Bt),"render-coords-helper"),this.sceneIntersectionHelper&&this.sceneIntersectionHelper.setTolerance(kp/this.renderCoordsHelper.unitInMeters))}else this._set("mapCoordsHelper",null),this._set("renderCoordsHelper",null)}_exitCoordinateSystem(){this.mapCoordsHelper&&(this.handles.remove("render-coords-helper"),this._set("renderCoordsHelper",null),this._set("mapCoordsHelper",null))}_updatingChanged(){this.notifyChange("updating")}_updateUpdatingMonitors(i=null){g(i)&&i.type===t2.MOVE||(this.handles.remove("updatingMonitors"),this.allLayerViews.forEach(e=>{e.destroyed||(this.handles.add(te(()=>[e.updating,e.updatingProgress],()=>this._updatingChanged(),Bt),"updatingMonitors"),e.when(()=>this._updatingChanged(),()=>this._updatingChanged()))}),this._updatingChanged())}async _prepareScreenshotOverlay(){this.overlay&&await this.overlay.prepare()}_renderScreenshotOverlay(i,e){if(!this.overlay||!this.overlay.hasVisibleItems)return e;const t=i.getContext("2d");return t.putImageData(e,0,0),this.overlay.renderCanvas(i),t.getImageData(0,0,e.width,e.height)}_initStage(){const i={deactivatedWebGLExtensions:this.deactivatedWebGLExtensions,debugWebGLExtensions:this.debugWebGLExtensions,alpha:this.alphaCompositingEnabled,preserveDrawingBuffer:this.preserveDrawingBufferEnabled,canvas:this.renderCanvas,screenshot:{prepareOverlay:()=>this._prepareScreenshotOverlay(),renderOverlay:(s,a)=>this._renderScreenshotOverlay(s,a)}},e=new hZ(this.state.viewingMode,s=>this._stage.layers.forAll(s),this);this._set("sceneIntersectionHelper",e);const t=I9(this.surface);this._stage=new wa({view:this,options:i,container:t}),this._stage.renderer.setParameters({slicePlane:this.slicePlane}),this._lostWebGLContextHandle=L9(this._stage.renderView.canvas,"webglcontextlost",()=>this.fatalError=new bt("webgl-context-lost")),this.handles.add([this.updatingHandles.add(()=>this.qualitySettings.antialiasingEnabled,()=>this._stage.renderer.setParameters({antialiasingEnabled:this.qualitySettings.antialiasingEnabled}),Ji),this.updatingHandles.add(()=>this.qualitySettings.highQualityTransparency,s=>this._stage.renderer.setParameters({highQualityTransparency:s}),Ji),te(()=>this.magnifier,s=>this._stage.renderView.magnifier=s,Qi),this.on("pointer-move",()=>{var s;return(s=this._stage)==null?void 0:s.renderer.resetAnimation()})],"stage");const r=()=>{this._stage.renderer.setParameters({defaultHighlightOptions:$w.toEngineOptions(this.highlightOptions)})};this.handles.add(this.updatingHandles.add(()=>[this.highlightOptions.color,this.highlightOptions.haloColor,this.highlightOptions.haloOpacity,this.highlightOptions.fillOpacity,this.highlightOptions.shadowOpacity,this.highlightOptions.shadowColor,this.highlightOptions.shadowDifference],r),"stage"),r(),this.renderCoordsHelper&&this.sceneIntersectionHelper.setTolerance(kp/this.renderCoordsHelper.unitInMeters),this._set("canvas",this._stage.renderView.canvas)}_exitStage(){this._set("sceneIntersectionHelper",null),this._stage=Te(this._stage),this._lostWebGLContextHandle=fo(this._lostWebGLContextHandle),this.handles.remove("stage"),this._set("canvas",null)}_initSurface(i){this._exitSurface(),this.state.init(i,this.spatialReference),this._initStage(),this._initGlobe(),this.sharedSymbolResources=new oY({view:this,viewingMode:i,resourceController:this._resourceController,pointsOfInterest:this.pointsOfInterest,viewState:this.state})}_exitSurface(){this.sharedSymbolResources&&(this.sharedSymbolResources.objectResourceCache.destroy(),this.sharedSymbolResources.destroy(),this.sharedSymbolResources=null,this._exitGlobe(),this._exitStage())}_createGraphicsViewIfNeeded(){if(this.graphicsView||this._createGraphicsViewController||this.graphics.length===0)return;this.handles.remove("graphics-view"),this._createGraphicsViewController=new AbortController;const i=()=>{this._createGraphicsViewController=null,this._updatingChanged()};this._createGraphicsViewAsync(this._createGraphicsViewController.signal).then(i,i),this._updatingChanged()}async _createGraphicsViewAsync(i){const e=(await _e(()=>import("./GraphicsView3D-635340a9.js"),["assets/GraphicsView3D-635340a9.js","assets/calcite-8912bd40.js","assets/index-00759e4a.js","assets/index-5026a37a.css","assets/calcite-96fa36fd.css","assets/GraphicsProcessor-d49a2131.js","assets/Graphics3DObjectStates-8688d43e.js","assets/dehydratedFeatures-3a140d03.js","assets/quantizationUtils-b3b2ae2a.js","assets/optimizedFeatureQueryEngineAdapter-b6d8def7.js","assets/centroid-bf48eee6.js","assets/PooledRBush-5a11bc7e.js","assets/basicInterfaces-7449a8bf.js","assets/GraphicsView-d1a40b68.js","assets/sphere-d0e5285d.js","assets/mat3f64-50f3b9f6.js","assets/mat4f64-abdda1bb.js","assets/quatf64-f8f1c132.js","assets/Util-6d3f024a.js","assets/plane-5e2b046c.js","assets/spatialReferenceEllipsoidUtils-afb35af9.js","assets/scaleUtils-d13015f2.js","assets/ElevationSamplerData-e3118b17.js","assets/objectResourceUtils-782953c3.js","assets/devEnvironmentUtils-5002a058.js","assets/BufferView-379a78a4.js","assets/vec33-69c9e93b.js","assets/DefaultMaterial_COLOR_GAMMA-6ed76d86.js","assets/types-e1c0a5bf.js","assets/enums-e2e92c86.js","assets/Version-aa0a1d91.js","assets/quat-7b70e9a8.js","assets/resourceUtils-527631ac.js","assets/Indices-d8bff7b2.js","assets/NestedMap-1b5db22e.js","assets/requestImageUtils-d1ba3b36.js","assets/symbolColorUtils-c9d24716.js","assets/VertexAttribute-15d1866a.js","assets/doublePrecisionUtils-e3c3d0d8.js","assets/OrderIndependentTransparency-5f7257d7.js","assets/Texture-563cf5e5.js","assets/FramebufferObject-8b18fc0c.js","assets/VertexElementDescriptor-2925c6af.js","assets/InterleavedLayout-d57c91d0.js","assets/vec3f32-01c06d8d.js","assets/Octree-499541ed.js","assets/edgeProcessing-20e12367.js","assets/deduplicate-769a6f51.js","assets/MeshComponent-788e605a.js","assets/earcut-61f7b102.js","assets/imageUtils-c2d0d1ae.js","assets/projection-5969b753.js","assets/ZoomMomentumEstimator-ef57e6a4.js","assets/floatRGBA-ca2b39ca.js","assets/labelFormatUtils-71e1f841.js","assets/orientedBoundingBox-a14b97b5.js","assets/quatf32-51a323b8.js","assets/SnappingCandidate-970faec6.js","assets/callExpressionWithFeature-df1a8f01.js","assets/DefaultVertexAttributeLayouts-5f20d8dd.js","assets/geometryServiceUtils-a536bb19.js","assets/project-909a4219.js","assets/LercDecoder-65586d50.js","assets/VectorTile-d41a1f0f.js","assets/enums-fb086c25.js","assets/config-1337d16e.js","assets/TiledDisplayObject-419c008b.js","assets/DisplayObject-87c37b69.js","assets/rasterUtils-7694cc98.js","assets/resources-7587d8f4.js","assets/workerHelper-6131d203.js","assets/webgl-debug-7f880832.js","assets/RenderingContext-0f21aa0e.js","assets/ProgramCache-f29c900e.js","assets/Program-77209250.js","assets/MediaLayer-4c42fc2f.js","assets/MediaElementView-06baa4d4.js","assets/normalizeUtilsSync-3ea564a9.js","assets/resourceExtension-f31d9f10.js","assets/BoundsStore-00da37da.js","assets/prism-line-numbers-eff41b13.js","assets/label2-a2f37e65.js","assets/interactive-1de2e238.js","assets/loadable-6afd516d.js","assets/t9n-81df3a71.js","assets/observers-c89705b8.js","assets/icon-8e47fbec.js","assets/loader-c773e800.js","assets/guid-51402ee7.js","assets/prism-line-numbers-7c5d72ff.css"])).default;lr(i),await _x(()=>{var t;return(t=this.basemapTerrain)==null?void 0:t.ready},i),this._set("graphicsView",new e({view:this}))}_disposeGraphicsView(){this._createGraphicsViewController&&(this._createGraphicsViewController.abort(),this._createGraphicsViewController=null),this.handles.remove("graphics-view"),g(this.graphicsView)&&(this.handles.remove(this.graphicsView.processor.layer.id),this.graphicsView.destroy(),this._set("graphicsView",null))}_startup(){const i=YS(this.viewingMode);if(i===ve.Global&&(this._clippingArea=null),this._initSurface(i),this._set("ready",!0),this.handles.add(ll(()=>this.graphics,"after-changes",()=>this._createGraphicsViewIfNeeded()),"graphics-view"),this._createGraphicsViewIfNeeded(),!this._externallySet.environment){const t=this.get("map.initialViewProperties.environment");t&&(this.environment=t)}this.labeler.setup(),this.environmentManager.connectView(this),this.inputManager.connect();const e=this._resolveWhenReady;this._resolveWhenReady=[],e.forEach(t=>t(this))}_teardown(){this._initialDefaultSpatialReference=null,this.inputManager.disconnect(),this.environmentManager.disconnectView(),this.labeler.dispose(),this._disposeGraphicsView(),this.handles.remove("graphics-view"),this._exitSurface(),this._set("ready",!1)}_updateDefaultToMapOptions(){if(this._defaultToMapOptions.include.clear(),this.map){this.map.ground&&this._defaultToMapOptions.include.add(jc);for(const i of this.map.allLayers.items)i.type==="integrated-mesh"&&this._defaultToMapOptions.include.add(i.uid)}}_updateDefaultHitTestOptions(){if(this._defaultHitTestOptions.exclude.clear(),this.map){this.map.ground&&this.map.ground.opacity<1&&this._defaultHitTestOptions.exclude.add(jc);for(const i of this.map.allLayers.items)i.type==="integrated-mesh"&&i.opacity<1&&this._defaultHitTestOptions.exclude.add(i.uid)}}addVoxelLayerViewToWasm(i){return P(this.voxelWasm)?(P(this.voxelWasmPromise)&&(this.voxelWasmPromise=_e(()=>import("./VoxelWasmPerSceneView-debd403c.js"),["assets/VoxelWasmPerSceneView-debd403c.js","assets/calcite-8912bd40.js","assets/index-00759e4a.js","assets/index-5026a37a.css","assets/calcite-96fa36fd.css","assets/Octree-499541ed.js","assets/sphere-d0e5285d.js","assets/mat3f64-50f3b9f6.js","assets/mat4f64-abdda1bb.js","assets/quatf64-f8f1c132.js","assets/plane-5e2b046c.js","assets/Util-6d3f024a.js","assets/objectResourceUtils-782953c3.js","assets/devEnvironmentUtils-5002a058.js","assets/BufferView-379a78a4.js","assets/vec33-69c9e93b.js","assets/DefaultMaterial_COLOR_GAMMA-6ed76d86.js","assets/types-e1c0a5bf.js","assets/enums-e2e92c86.js","assets/Version-aa0a1d91.js","assets/quat-7b70e9a8.js","assets/resourceUtils-527631ac.js","assets/basicInterfaces-7449a8bf.js","assets/Indices-d8bff7b2.js","assets/NestedMap-1b5db22e.js","assets/requestImageUtils-d1ba3b36.js","assets/symbolColorUtils-c9d24716.js","assets/VertexAttribute-15d1866a.js","assets/doublePrecisionUtils-e3c3d0d8.js","assets/OrderIndependentTransparency-5f7257d7.js","assets/Texture-563cf5e5.js","assets/FramebufferObject-8b18fc0c.js","assets/VertexElementDescriptor-2925c6af.js","assets/InterleavedLayout-d57c91d0.js","assets/vec3f32-01c06d8d.js","assets/spatialReferenceEllipsoidUtils-afb35af9.js","assets/scaleUtils-d13015f2.js","assets/ElevationSamplerData-e3118b17.js","assets/edgeProcessing-20e12367.js","assets/deduplicate-769a6f51.js","assets/MeshComponent-788e605a.js","assets/earcut-61f7b102.js","assets/imageUtils-c2d0d1ae.js","assets/projection-5969b753.js","assets/ZoomMomentumEstimator-ef57e6a4.js","assets/floatRGBA-ca2b39ca.js","assets/dehydratedFeatures-3a140d03.js","assets/quantizationUtils-b3b2ae2a.js","assets/labelFormatUtils-71e1f841.js","assets/orientedBoundingBox-a14b97b5.js","assets/quatf32-51a323b8.js","assets/SnappingCandidate-970faec6.js","assets/callExpressionWithFeature-df1a8f01.js","assets/DefaultVertexAttributeLayouts-5f20d8dd.js","assets/geometryServiceUtils-a536bb19.js","assets/project-909a4219.js","assets/LercDecoder-65586d50.js","assets/VectorTile-d41a1f0f.js","assets/enums-fb086c25.js","assets/config-1337d16e.js","assets/TiledDisplayObject-419c008b.js","assets/DisplayObject-87c37b69.js","assets/rasterUtils-7694cc98.js","assets/resources-7587d8f4.js","assets/workerHelper-6131d203.js","assets/webgl-debug-7f880832.js","assets/RenderingContext-0f21aa0e.js","assets/ProgramCache-f29c900e.js","assets/Program-77209250.js","assets/MediaLayer-4c42fc2f.js","assets/MediaElementView-06baa4d4.js","assets/normalizeUtilsSync-3ea564a9.js","assets/resourceExtension-f31d9f10.js","assets/BoundsStore-00da37da.js","assets/PooledRBush-5a11bc7e.js","assets/prism-line-numbers-eff41b13.js","assets/label2-a2f37e65.js","assets/interactive-1de2e238.js","assets/loadable-6afd516d.js","assets/t9n-81df3a71.js","assets/observers-c89705b8.js","assets/icon-8e47fbec.js","assets/loader-c773e800.js","assets/guid-51402ee7.js","assets/prism-line-numbers-7c5d72ff.css"]).then(e=>(this.voxelWasm=new e.default(this),this.voxelWasm))),this.voxelWasmPromise.then(e=>e.addVoxelLayer(i))):this.voxelWasm.addVoxelLayer(i)}removeVoxelLayerViewFromWasm(i){g(this.voxelWasm)&&this.voxelWasm.removeVoxelLayer(i)<1&&(this.voxelWasm=null,this.voxelWasmPromise=null)}};function Wm(i,e){i.layerUids||(i.layerUids=new Set),i.layerUids.add(e)}function Vie(i,e){i.graphicUids||(i.graphicUids=new Set),i.graphicUids.add(e)}function P0(i,e){return g(i)&&i3(i.spatialReference,e)?oT(i,e):null}var Vg;Se.type="3d",d([v()],Se.prototype,"_userClippingArea",void 0),d([v()],Se.prototype,"_resourceController",void 0),d([v()],Se.prototype,"_stage",void 0),d([v({readOnly:!0})],Se.prototype,"deconflictor",void 0),d([v({readOnly:!0})],Se.prototype,"labeler",void 0),d([v(N9(p3,"analyses"))],Se.prototype,"analyses",void 0),d([v({type:$p,readOnly:!0})],Se.prototype,"animation",null),d([v({readOnly:!0})],Se.prototype,"basemapTerrain",void 0),d([v({readOnly:!0})],Se.prototype,"elevationProvider",void 0),d([v()],Se.prototype,"camera",null),d([v({type:vo})],Se.prototype,"contentCamera",null),d([v({readOnly:!0})],Se.prototype,"canvas",void 0),d([v({type:Ht})],Se.prototype,"center",null),d([v({type:ds})],Se.prototype,"clippingArea",null),d([v({type:ud})],Se.prototype,"constraints",void 0),d([v({type:ds,readOnly:!0})],Se.prototype,"renderDataExtent",null),d([v({type:ds,readOnly:!0})],Se.prototype,"dataExtent",null),d([v({type:ds,readOnly:!0})],Se.prototype,"_groundAndLayersExtent",null),d([v({value:null,type:rp})],Se.prototype,"environment",null),d([Gg("environment")],Se.prototype,"castEnvironment",null),d([v({readOnly:!0})],Se.prototype,"environmentManager",void 0),d([v({type:ds})],Se.prototype,"extent",null),d([v()],Se.prototype,"floors",void 0),d([v()],Se.prototype,"screenCenter",null),d([v()],Se.prototype,"frustum",null),d([v({type:Number,readOnly:!0})],Se.prototype,"fullOpacity",void 0),d([v({readOnly:!0})],Se.prototype,"graphicsView",void 0),d([v({readOnly:!0})],Se.prototype,"analysisViewManager",void 0),d([v()],Se.prototype,"groundView",void 0),d([v({type:Boolean})],Se.prototype,"initialExtentRequired",null),d([v()],Se.prototype,"_defaultsFromMapSettings",null),d([v()],Se.prototype,"interacting",null),d([v()],Se.prototype,"stationary",null),d([v()],Se.prototype,"navigating",null),d([v()],Se.prototype,"map",void 0),d([v({readOnly:!0})],Se.prototype,"mapCoordsHelper",void 0),d([v()],Se.prototype,"padding",null),d([v({type:js,readOnly:!0})],Se.prototype,"pointsOfInterest",void 0),d([v({type:Nr,readOnly:!0})],Se.prototype,"featureTiles",void 0),d([v()],Se.prototype,"_featureTreeDebugger",void 0),d([v({type:Boolean})],Se.prototype,"screenSizePerspectiveEnabled",void 0),d([v({constructOnly:!0})],Se.prototype,"deactivatedWebGLExtensions",void 0),d([v({constructOnly:!0})],Se.prototype,"debugWebGLExtensions",void 0),d([v({constructOnly:!0})],Se.prototype,"renderCanvas",void 0),d([v({constructOnly:!0})],Se.prototype,"state",void 0),d([v({readOnly:!0})],Se.prototype,"inputManager",void 0),d([v({readOnly:!0})],Se.prototype,"stateManager",void 0),d([v({type:["low","medium","high"]})],Se.prototype,"qualityProfile",null),d([v({type:iE,get(){let i=this._get("qualitySettings");return i||(i=new iE,W0.apply(this.qualityProfile,i)),i}})],Se.prototype,"qualitySettings",void 0),d([v()],Se.prototype,"slicePlane",null),d([v({readOnly:!0})],Se.prototype,"typeSpecificPreconditionsReady",null),d([v({readOnly:!0})],Se.prototype,"renderCoordsHelper",void 0),d([v({readOnly:!0})],Se.prototype,"sceneIntersectionHelper",void 0),d([v({type:Number,dependsOn:["scale","spatialReference"],readOnly:!0})],Se.prototype,"resolution",null),d([v({type:Number})],Se.prototype,"scale",null),d([v()],Se.prototype,"heightModelInfo",null),d([v()],Se.prototype,"spatialReference",void 0),d([v({type:Boolean,constructOnly:!0})],Se.prototype,"alphaCompositingEnabled",void 0),d([v({constructOnly:!0})],Se.prototype,"preserveDrawingBufferEnabled",void 0),d([v({type:Boolean})],Se.prototype,"supersampleScreenshotsEnabled",void 0),d([v({readOnly:!0})],Se.prototype,"type",void 0),d([v({type:u4})],Se.prototype,"ui",void 0),d([v({type:Boolean,readOnly:!0,dependsOn:["graphicsView.updating","basemapView.updating","basemapTerrain.updating","layerViewManager.updating","layerViewManager.updatingRemaining","_resourceController.updating","_stage.updating","featureTiles.updating","pointsOfInterest.updating","environmentManager.updating","overlay.updating","updatingHandles.updating","featureTreeDebugger.updating","labeler.updating","deconflictor.updating","ready","stationary","inputManager.hasPendingInputs","toolViewManager.updating","analysisViewManager.updating","state.mode"]})],Se.prototype,"updating",null),d([v({type:Number,readOnly:!0,dependsOn:["updating"]})],Se.prototype,"updatingProgress",void 0),d([v({type:["global","local"]})],Se.prototype,"viewingMode",null),d([v({type:Ql})],Se.prototype,"viewpoint",null),d([v({type:Number})],Se.prototype,"zoom",null),d([v({type:$w})],Se.prototype,"highlightOptions",void 0),Se=d([Y("esri.views.SceneView")],Se),function(i){i[i.INCLUDE=0]="INCLUDE",i[i.EXCLUDE=1]="EXCLUDE"}(Vg||(Vg={}));const Ku=T(),gx=Pi(),AA=yt(),Gie=Se;function Bie(){const i=ou.useRef(null),e=ou.useRef(null),t=ou.useRef(null),[r,s]=ou.useState(null),[a,n]=ou.useState(null);ou.useEffect(()=>{o()},[]);async function o(){if(m8.highlightAll(),!(i!=null&&i.current))return;z9.portalUrl="http://arcgis.com/";const h=new U9({basemap:{portalItem:{id:"eb303185d14e45e9be8bbbc1c0daf7ab"}}}),u=new Gie({container:i==null?void 0:i.current,map:h,center:[-65,40],constraints:{altitude:{min:2e6}}});u.ui.add([new g8({view:u,content:e==null?void 0:e.current,expanded:!0,group:"group1",expandTooltip:"MediaLayer"})],"top-left"),s(u)}async function l(){const h=new d8({video:"https://arcgis.github.io/arcgis-samples-javascript/sample-data/media-layer/videos/hurricanes_aerosol-aug.mp4",georeference:new u8({extent:new ds({xmin:-150,ymin:1,xmax:20,ymax:80,spatialReference:{wkid:4326}})})}),u=new p8({source:[h],title:"2017 Hurricanes and Aerosols Simulation",copyright:"NASA's Goddard Space Flight Center"});r.map.layers.add(u),await r.when(),await u.when(),n(u)}return DS("div",{className:"App",children:[lu("div",{id:"view",ref:i}),DS("div",{ref:e,className:"card",children:[lu("p",{className:"title",children:"MediaLayer"}),lu("pre",{className:"line-numbers",children:lu("code",{className:"language-js",children:`new MediaLayer({ 
  source: new VideoElement({
    video: "/aerosol.mp4",
    georeference: 
      new ExtentAndRotationGeoreference({
        extent: new Extent({
          xmin: -150, 
          ymin: 1, 
          xmax: 20, 
          ymax: 80,
          spatialReference: { wkid: 4326 }
        })
      })
  }) 
});`})}),lu("div",{ref:t,className:"slider"}),lu(f8,{className:"btn","icon-start":"play",onClick:l})]})]})}const $ue=Object.freeze(Object.defineProperty({__proto__:null,default:Bie},Symbol.toStringTag,{value:"Module"}));export{s0 as $,DC as A,Ii as B,ah as C,Mk as D,Fr as E,RM as F,Mue as G,CY as H,the as I,lS as J,Ase as K,zi as L,fi as M,QQ as N,Qp as O,qC as P,Dj as Q,Aue as R,iee as S,oi as T,hC as U,Ip as V,hne as W,Cde as X,Po as Y,une as Z,KH as _,Lne as a,vz as a$,Jo as a0,bZ as a1,fhe as a2,Ra as a3,Qa as a4,ZC as a5,br as a6,AI as a7,cm as a8,Zf as a9,Fe as aA,one as aB,CD as aC,aR as aD,OR as aE,yI as aF,Wp as aG,Kx as aH,MC as aI,Kv as aJ,Pj as aK,Due as aL,Lue as aM,Iue as aN,qT as aO,oG as aP,WT as aQ,cc as aR,E8 as aS,Jl as aT,Cv as aU,G2 as aV,Mse as aW,Qd as aX,G$ as aY,RK as aZ,Sg as a_,ww as aa,Eue as ab,dce as ac,cK as ad,KZ as ae,JZ as af,qre as ag,Hre as ah,kre as ai,rl as aj,Yoe as ak,hc as al,yp as am,qoe as an,Ew as ao,jre as ap,y8 as aq,WH as ar,Dse as as,nj as at,Gy as au,$I as av,Ese as aw,eW as ax,lj as ay,Fd as az,Voe as b,Pz as b0,BM as b1,GM as b2,Iz as b3,iC as b4,Xz as b5,YM as b6,aC as b7,Jz as b8,v7 as b9,lte as bA,B5 as bB,hte as bC,j5 as bD,Yv as bE,Cte as bF,Ite as bG,kte as bH,qte as bI,Xte as bJ,zj as bK,q5 as bL,Ote as bM,die as bN,Kq as bO,dW as bP,DX as bQ,JX as bR,WX as bS,fM as bT,S8 as bU,ls as bV,_ie as bW,$ue as bX,F7 as ba,dH as bb,Uy as bc,Tk as bd,Vd as be,iJ as bf,hee as bg,bS as bh,C5 as bi,bee as bj,O5 as bk,wee as bl,A5 as bm,Cee as bn,I5 as bo,Pee as bp,jM as bq,Nz as br,rK as bs,iK as bt,Wv as bu,sK as bv,Hy as bw,cj as bx,ate as by,U5 as bz,Ik as c,Ma as d,Dg as e,_ce as f,kC as g,mne as h,pne as i,nL as j,cne as k,wne as l,xne as m,tn as n,EQ as o,RQ as p,dr as q,gk as r,$ne as s,Vr as t,kH as u,C$ as v,ci as w,zn as x,yZ as y,Wc as z};
