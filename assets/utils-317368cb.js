import{e as H}from"./mat3f32-d3d088e8.js";import{e as m,y as _,n as U,m as I}from"./cast-fcb46737.js";import{h as B,y as R}from"./string-a318751c.js";import{s as G,a as M}from"./Error-ec6249b9.js";import"./ArrayPool-a8ee9378.js";import{d as P,n as Y,e as z}from"./parser-498c8be0.js";import{d as L}from"./DefaultVertexAttributeLayouts-2bcf3941.js";import{E as V,S as A}from"./enums-4ca4641f.js";import{U as k}from"./MaterialKey-0093a242.js";import{r as w}from"./typedArrayUtil-4d7bb04c.js";import{b as y}from"./Utils-69cc114d.js";import{r as q,s as D}from"./enums-2658a65c.js";import{C as l}from"./enums-64ab819c.js";import{u as N}from"./screenUtils-410d12c0.js";import{u as W}from"./heatmapUtils-aaea3f32.js";import{l as j}from"./Color-fb64d77d.js";const S=-1;let p=class extends I{constructor(t){super(t),this._from=null,this._to=null,this._final=null,this._current=[],this._time=0,this.duration=B("mapview-transitions-duration"),this.effects=[]}set effect(t){if(this._get("effect")!==(t=t||"")){this._set("effect",t);try{this._transitionTo(x(t))}catch(e){this._transitionTo([]),G.getLogger(this.declaredClass).warn("Invalid Effect",{effect:t,error:e})}}}get hasEffects(){return this.transitioning||!!this.effects.length}set scale(t){this._updateForScale(t)}get transitioning(){return this._to!==null}canTransitionTo(t){try{return this.scale>0&&F(this._current,x(t),this.scale)}catch{return!1}}transitionStep(t,e){this._applyTimeTransition(t),this._updateForScale(e)}endTransitions(){this._applyTimeTransition(this.duration)}_transitionTo(t){this.scale>0&&F(this._current,t,this.scale)?(this._final=t,this._to=R(t),K(this._current,this._to,this.scale),this._from=R(this._current),this._time=0):(this._from=this._to=this._final=null,this._current=t),this._set("effects",this._current[0]?R(this._current[0].effects):[])}_applyTimeTransition(t){if(!(this._to&&this._from&&this._current&&this._final))return;this._time+=t;const e=Math.min(1,this._time/this.duration);for(let r=0;r<this._current.length;r++){const n=this._current[r],a=this._from[r],o=this._to[r];n.scale=J(a.scale,o.scale,e);for(let i=0;i<n.effects.length;i++){const c=n.effects[i],s=a.effects[i],d=o.effects[i];c.interpolate(s,d,e)}}e===1&&(this._current=this._final,this._set("effects",this._current[0]?R(this._current[0].effects):[]),this._from=this._to=this._final=null)}_updateForScale(t){if(this._set("scale",t),this._current.length===0)return;const e=this._current,r=this._current.length-1;let n,a,o=1;if(e.length===1||t>=e[0].scale)a=n=e[0].effects;else if(t<=e[r].scale)a=n=e[r].effects;else for(let i=0;i<r;i++){const c=e[i],s=e[i+1];if(c.scale>=t&&s.scale<=t){o=(t-c.scale)/(s.scale-c.scale),n=c.effects,a=s.effects;break}}for(let i=0;i<this.effects.length;i++)this.effects[i].interpolate(n[i],a[i],o)}};function x(t){const e=P(t)||[];return Q(e)?[{scale:S,effects:e}]:e}function F(t,e,r){var n,a,o,i;return!((n=t[0])!=null&&n.effects)||!((a=e[0])!=null&&a.effects)?!0:!((((o=t[0])==null?void 0:o.scale)===S||((i=e[0])==null?void 0:i.scale)===S)&&(t.length>1||e.length>1)&&r<=0)&&Y(t[0].effects,e[0].effects)}function K(t,e,r){const n=t.length>e.length?t:e,a=t.length>e.length?e:t,o=a[a.length-1],i=(o==null?void 0:o.scale)??r,c=(o==null?void 0:o.effects)??[];for(let s=a.length;s<n.length;s++)a.push({scale:i,effects:[...c]});for(let s=0;s<n.length;s++)a[s].scale=a[s].scale===S?r:a[s].scale,n[s].scale=n[s].scale===S?r:n[s].scale,z(a[s].effects,n[s].effects)}function J(t,e,r){return t+(e-t)*r}function Q(t){const e=t[0];return!!e&&"type"in e}m([_()],p.prototype,"_to",void 0),m([_()],p.prototype,"duration",void 0),m([_({value:""})],p.prototype,"effect",null),m([_({readOnly:!0})],p.prototype,"effects",void 0),m([_({readOnly:!0})],p.prototype,"hasEffects",null),m([_({value:0})],p.prototype,"scale",null),m([_({readOnly:!0})],p.prototype,"transitioning",null),p=m([U("esri.layers.effects.EffectView")],p);class pe extends L{constructor(){super(...arguments),this._childrenSet=new Set,this._needsSort=!1,this.children=[],this._effectView=null}get blendMode(){return this._blendMode}set blendMode(e){this._blendMode=e,this.requestRender()}get clips(){return this._clips}set clips(e){this._clips=e,this.children.forEach(r=>r.clips=e)}get computedEffects(){var e;return((e=this._effectView)==null?void 0:e.effects)??null}get effect(){var e;return((e=this._effectView)==null?void 0:e.effect)??""}set effect(e){(this._effectView||e)&&(this._effectView||(this._effectView=new p),this._effectView.effect=e,this.requestRender())}updateTransitionProperties(e,r){super.updateTransitionProperties(e,r),this._effectView&&(this._effectView.transitionStep(e,r),this._effectView.transitioning&&this.requestRender())}doRender(e){const r=this.createRenderParams(e);this.renderChildren(r)}addChild(e){return this.addChildAt(e,this.children.length)}addChildAt(e,r=this.children.length){if(!e||this.contains(e))return e;this._needsSort=!0;const n=e.parent;return n&&n!==this&&n.removeChild(e),r>=this.children.length?this.children.push(e):this.children.splice(r,0,e),this._childrenSet.add(e),e.parent=this,e.stage=this.stage,this!==this.stage&&(e.clips=this.clips),this.requestRender(),e}contains(e){return this._childrenSet.has(e)}endTransitions(){super.endTransitions(),this._effectView&&(this._effectView.endTransitions(),this.requestRender())}removeAllChildren(){this._childrenSet.clear(),this._needsSort=!0;for(const e of this.children)this!==this.stage&&(e.clips=null),e.stage=null,e.parent=null;this.children.length=0}removeChild(e){return this.contains(e)?this.removeChildAt(this.children.indexOf(e)):e}removeChildAt(e){if(e<0||e>=this.children.length)return null;this._needsSort=!0;const r=this.children.splice(e,1)[0];return this._childrenSet.delete(r),this!==this.stage&&(r.clips=null),r.stage=null,r.parent=null,r}sortChildren(e){this._needsSort&&(this.children.sort(e),this._needsSort=!1)}beforeRender(e){super.beforeRender(e);for(const r of this.children)r.beforeRender(e)}afterRender(e){super.afterRender(e);for(const r of this.children)r.afterRender(e)}_createTransforms(){return{dvs:H()}}onAttach(){super.onAttach();const e=this.stage;for(const r of this.children)r.stage=e}onDetach(){super.onDetach();for(const e of this.children)e.stage=null}renderChildren(e){for(const r of this.children)r.processRender(e)}createRenderParams(e){return{...e,blendMode:this.blendMode,effects:this.computedEffects,globalOpacity:e.globalOpacity*this.computedOpacity,inFadeTransition:this.inFadeTransition}}}class g{static getStorageSpec(e){return null}static createOrUpdateRendererSchema(e,r){return w(e)&&e.type==="default"?e:{type:"default"}}static getVariation(e){return{}}static getVariationHash(e){return 0}}g.type="default",g.programSpec=null;let b=class extends g{static getStorageSpec({attributes:e}){return{visualVariables:!1,attributes:e??null}}static _createRendererSchema(){return{type:"dot-density",colors:new Float32Array(32),dotValue:-1,dotSize:-1,dotScale:-1,dotBlending:!1,backgroundColor:new Float32Array(4),activeDots:new Float32Array(8),seed:-1}}static createOrUpdateRendererSchema(e,r){const{attributes:n,dotValue:a,referenceScale:o,dotSize:i,dotBlendingEnabled:c,seed:s,backgroundColor:d}=r,u=w(e)&&e.type==="dot-density"?e:this._createRendererSchema();u.dotValue=a,u.dotSize=i,u.dotScale=o,u.dotBlending=c,u.seed=s;const{colors:O,activeDots:T,backgroundColor:f}=u;for(let h=0;h<q;h++){const C=h>=n.length?null:n[h].color;y(O,C,4*h)}for(let h=0;h<8;h++)T[h]=h<r.attributes.length?1:0;return y(f,d),u}static getVariation(e){return{ddDotBlending:e.dotBlending}}static getVariationHash(e){return e.dotBlending?1:0}};b.type="dot-density",b.programSpec={shader:"materials/fill",vertexLayout:{geometry:[{location:0,name:"a_pos",count:2,type:l.SHORT},{location:1,name:"a_id",count:3,type:l.UNSIGNED_BYTE},{location:2,name:"a_bitset",count:1,type:l.UNSIGNED_BYTE},{location:3,name:"a_inverseArea",count:1,type:l.FLOAT}]}};class E extends g{static getStorageSpec({field:e,valueExpression:r}){return{visualVariables:!1,attributes:e||r?[{field:e,valueExpression:r}]:null}}static _createRendererSchema(){return{type:"heatmap",radius:-1,referenceScale:-1,isFieldActive:0,minDensity:-1,densityRange:-1,kernel:null,gradient:null,gradientHash:"invalid"}}static createOrUpdateRendererSchema(e,r){const{radius:n,minDensity:a,maxDensity:o,referenceScale:i,field:c,valueExpression:s,colorStops:d}=r,u=o-a,O=c||s?1:0,T=d.map(({color:C,ratio:$})=>`${$}:${C.toString()}`).join();let f,h=!0;return w(e)&&e.type==="heatmap"?(f=e,h=T!==e.gradientHash):f=this._createRendererSchema(),f.radius=N(n),f.minDensity=a,f.densityRange=u,f.referenceScale=i,f.isFieldActive=O,h&&(f.gradient=W(d),f.gradientHash=T),f}}E.type="heatmap",E.programSpec={shader:"materials/icon/heatmapAccumulate",vertexLayout:{geometry:[{location:0,name:"a_pos",count:2,type:l.SHORT},{location:1,name:"a_vertexOffset",count:2,type:l.SHORT},{location:4,name:"a_id",count:4,type:l.UNSIGNED_BYTE}]}};class v extends g{static getStorageSpec({attributes:e}){return{visualVariables:!0,attributes:e??null}}static _createRendererSchema(){return{type:"pie-chart",colors:new Float32Array(4*D),defaultColor:new Float32Array(4),othersColor:new Float32Array(4),outlineColor:new Float32Array(4),holePercentage:0,sectorThreshold:0,outlineWidth:1,numberOfFields:10}}static createOrUpdateRendererSchema(e,r){const{attributes:n,defaultColor:a,holePercentage:o,othersCategory:i,outline:c}=r,s=w(e)&&e.type==="pie-chart"?e:this._createRendererSchema();for(let d=0;d<D;d++){const u=d>=n.length?new j([0,0,0,0]):n[d].color;y(s.colors,u,4*d)}return y(s.defaultColor,a),y(s.othersColor,i==null?void 0:i.color),y(s.outlineColor,c==null?void 0:c.color),s.outlineWidth=N((c==null?void 0:c.width)||0),s.holePercentage=o,s.sectorThreshold=(i==null?void 0:i.threshold)||0,s.numberOfFields=n.length,s}static getVariation(e){return{numberOfFields:e.numberOfFields}}static getVariationHash(e){return e.numberOfFields}}v.type="pie-chart",v.programSpec={shader:"materials/pie",vertexLayout:{geometry:[{location:0,name:"a_pos",count:2,type:l.SHORT},{location:1,name:"a_vertexOffset",count:2,type:l.SHORT},{location:2,name:"a_texCoords",count:2,type:l.UNSIGNED_SHORT},{location:3,name:"a_bitSetAndDistRatio",count:2,type:l.UNSIGNED_SHORT},{location:4,name:"a_id",count:4,type:l.UNSIGNED_BYTE},{location:5,name:"a_color",count:4,type:l.UNSIGNED_BYTE,normalized:!0},{location:6,name:"a_outlineColor",count:4,type:l.UNSIGNED_BYTE,normalized:!0},{location:7,name:"a_sizeAndOutlineWidth",count:4,type:l.UNSIGNED_BYTE},{location:8,name:"a_zoomRange",count:2,type:l.UNSIGNED_SHORT}]},hittestAttributes:["a_vertexOffset","a_texCoords"]};function _e(t,e){if(t.type!==e)throw new M("material-view-model:unexpected-renderer-schema",`expected to find renderer schema of type "${e}" but found type "${t.type}"`)}function ge(t){switch(t==null?void 0:t.type){case"dot-density":return b;case"heatmap":return E;case"pie-chart":return v;default:return g}}function ye(t){const{geometryType:e,symbologyType:r}=k.load(t);switch(e){case V.FILL:if(r===A.DOT_DENSITY)return b;break;case V.MARKER:switch(r){case A.HEATMAP:return E;case A.PIE_CHART:return v}}return g}export{p as a,ge as c,g as e,pe as i,ye as p,_e as s};
