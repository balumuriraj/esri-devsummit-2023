import{d5 as z,d4 as B,aL as N,r as _,e as A,bb as G,da as U,mh as F,mi as j,c as k,I as W,R as f,v as Y,W as K,mj as Q,mk as J,cY as X,eh as Z,a2 as ee,a1 as P,ac as C,ad as w,af as te}from"./index-51930907.js";import{r as ie,i as se,l as re,n as ae,t as le}from"./TileInfoViewPOT-eafcecca.js";import{i as x,a as p}from"./StyleDefinition-7d58136b.js";import{d as ne,m as oe,c as he,a as ce,M as de}from"./WGLBrushVTLSymbol-e8c49a01.js";import{o as ue}from"./VTLMaterialManager-c25094ad.js";import{l as $}from"./StyleRepository-30524876.js";import{n as me}from"./LayerView3D-68bdf258.js";import{c as ge}from"./TiledLayerView3D-5ca53d22.js";import{u as pe}from"./LayerView-db7ff94b.js";import"./Rect-ea14f53a.js";import"./rasterizingUtils-37f0f33e.js";import"./enums-4b2a86a0.js";import"./definitions-3ddd14a8.js";import"./enums-b1d611e3.js";import"./number-b10bd8f5.js";import"./GeometryUtils-dd03fc25.js";import"./ShaderCompiler-77d0dcb6.js";import"./programUtils-f035fe8a.js";import"./colorUtils-c0f43caf.js";import"./GeometryUtils-53652037.js";class _e{constructor(e,t){this._lockedSchemaPixelSize=e,this._isGCS=t}getLevelRowColumn(e){return this._isGCS?[e[0],e[1]>>1,e[2]>>1]:this._lockedSchemaPixelSize===256&&e[0]>0?[e[0]-1,e[1]>>1,e[2]>>1]:e}adjustLevel(e){return this._isGCS?e:this._lockedSchemaPixelSize===256?e>0?e-1:0:e}getShift(e,t){let s=0,a=0;return(this._lockedSchemaPixelSize===256||this._isGCS)&&(e[2]%2&&(s=t),e[1]%2&&(a=t)),[s,a]}getScale(e){if(this._isGCS){if(this._lockedSchemaPixelSize===512)return 4}else if(this._lockedSchemaPixelSize===256&&e===0)return 1;return 2}}function ye(l,e){const t=[],s=new ie(4096,t,()=>{const r=new B;return r.show=!1,r.parts.push({startTime:0,startOpacity:0,targetOpacity:0,show:!1}),r.parts.push({startTime:0,startOpacity:0,targetOpacity:0,show:!1}),r}),a=new se(t,s,(r,i,o)=>new re(r,i,o,l.styleRepository,l.key.level,0),(r,i)=>{z(r,i,!1)},()=>0,r=>{const i=e.getStyleLayerByUID(r).getLayoutProperty("visibility");return!i||i.getValue()!==x.NONE});t.push(l),s.add(l),a.setScreenSize(512,512),a.continue(1/0)}class H extends ae{constructor(e,t,s,a,r){super(e,t,s),this._memCache=a,this._loader=r,this._ongoingTileRequests=new Map,this._ongoingRequestToController=new Map,this._tileInfoView=new le(e.tileInfo,e.fullExtent)}destroy(){super.destroy(),this._ongoingRequestToController.forEach(e=>e.abort()),this._ongoingRequestToController.clear(),this._ongoingTileRequests.clear()}async getVectorTile(e,t,s,a){const r=new N(e,t,s,0);let i=this._memCache.get(r.id);if(_(i))return i.retain(),i;const o=await this._getVectorTileData(r);if(A(a),!this._layer)return null;if(i=this._memCache.get(r.id),_(i))return i.retain(),i;const h=this._layer.tileInfo.getTileBounds(G(),r),y=this._tileInfoView.getTileResolution(e);return i=new U(r,y,h[0],h[3],512,512,this._styleRepository,this._memCache),_(o)?(i.setData(o),i.retain(),this._memCache.put(r.id,i,i.memoryUsage*i.referenced,F)):i.setData(null),i.neededForCoverage=!0,i.transforms.tileUnitsToPixels=j(1/8,0,0,0,1/8,0,0,0,1),ye(i,this._styleRepository),i}_getVectorTileData(e){const t=e.id;if(this._ongoingTileRequests.has(t))return this._ongoingTileRequests.get(t);const s=new AbortController,a={signal:s.signal},r=this._getParsedVectorTileData(e,a).then(i=>(this._ongoingTileRequests.delete(t),this._ongoingRequestToController.delete(t),i)).catch(()=>(this._ongoingTileRequests.delete(t),this._ongoingRequestToController.delete(t),null));return this._ongoingTileRequests.set(t,r),this._ongoingRequestToController.set(t,s),r}_getParsedVectorTileData(e,t){return this.fetchTileData(e,t).then(s=>this.parseTileData({key:e,data:s},t))}request(e,t){return this._loader.request(e,"binary",t)}}const fe={vtlBackground:ne,vtlFill:oe,vtlLine:he,vtlCircle:ce,vtlSymbol:de},M=1e-6;class E{constructor(e,t){this.spriteMosaic=e,this.glyphMosaic=t,this._brushCache=new Map,this._vtlMaterialManager=new ue}dispose(){this._brushCache&&(this._brushCache.forEach(e=>e.dispose()),this._brushCache=null),this._vtlMaterialManager=k(this._vtlMaterialManager),this.spriteMosaic.dispose(),this.glyphMosaic.dispose()}get vectorTilesMaterialManager(){return this._vtlMaterialManager}drawTile(e,t,s){const{context:a}=e,r=s.layers;s.backgroundBucketIds.length>0&&(e.renderPass="background",s.backgroundBucketIds.forEach(i=>this._renderStyleLayer(s.getLayerById(i),e,t,!0))),a.setBlendingEnabled(!1),a.setDepthTestEnabled(!0),a.setDepthWriteEnabled(!0),a.setDepthFunction(W.LEQUAL),e.renderPass="opaque";for(let i=r.length-1;i>=0;i--)this._renderStyleLayer(r[i],e,t,!1);a.setDepthWriteEnabled(!1),a.setBlendingEnabled(!0),a.setBlendFunctionSeparate(f.ONE,f.ONE_MINUS_SRC_ALPHA,f.ONE,f.ONE_MINUS_SRC_ALPHA),e.renderPass="translucent";for(let i=0;i<r.length;i++)this._renderStyleLayer(r[i],e,t,!1);a.setDepthTestEnabled(!1),a.bindVAO()}_renderStyleLayer(e,t,s,a=!1){if(!(a||e&&s.layerData.has(e.uid)))return;const r=e.getLayoutProperty("visibility");if(r&&r.getValue()===x.NONE)return;const{renderPass:i}=t;let o;switch(e.type){case p.BACKGROUND:if(i!=="background")return;o="vtlBackground";break;case p.FILL:if(i!=="opaque"&&t.renderPass!=="translucent")return;o="vtlFill";break;case p.LINE:if(i!=="translucent")return;o="vtlLine";break;case p.CIRCLE:if(i!=="translucent")return;o="vtlCircle";break;case p.SYMBOL:if(i!=="translucent")return;o="vtlSymbol"}const h=t.displayLevel;e.minzoom!==void 0&&e.minzoom>h+M||e.maxzoom!==void 0&&e.maxzoom<=h-M||(t.styleLayerUID=e.uid,t.styleLayer=e,this._drawWithBrush(t,s,o))}_drawWithBrush(e,t,s){if(!this._brushCache.has(s)){const a=fe[s];this._brushCache.set(s,new a)}this._brushCache.get(s).drawMany(e,[t])}}let m=class extends ge(me(pe)){constructor(){super(...arguments),this._tileHandlerController=null,this.type="vector-tile-3d"}initialize(){if(Y(this.layer.fullExtent))return void this.addResolvingPromise(Promise.reject(new K("vectortilelayerview:full-extent-undefined","This layer view's layer does not define a fullExtent.")));const{basemapTerrain:l,spatialReference:e,state:t,viewingMode:s}=this.view,a=s==="local"&&!Q(e)||J.force512VTL,r=this.layer.tileInfo.spatialReference.isGeographic,i=a?this.layer.tileInfo:this.layer.tileInfo.getOrCreateCompatible(256,r?1:2),o=this._getTileInfoSupportError(i,this.layer.fullExtent);if(_(o))return this.addResolvingPromise(Promise.reject(o));const h=X(()=>{var n,c;return(c=(n=this.view)==null?void 0:n.basemapTerrain)==null?void 0:c.tilingSchemeLocked}).then(()=>{var g;const n=l.tilingScheme,c=n.pixelSize;let u;if(this.schemaHelper=new _e(c,_(l.spatialReference)&&l.spatialReference.isGeographic),c===256){const v=this.layer.tileInfo.spatialReference.isGeographic;u=this.layer.tileInfo.getOrCreateCompatible(256,v?1:2)}else u=(g=this.view.spatialReference)!=null&&g.isGeographic?this.layer.tileInfo.getOrCreateCompatible(512,.5):this.layer.tileInfo;const d=this._getTileInfoCompatibilityError(u,n);if(d)throw d;this.tileInfo=u});this._tileHandlerController=new AbortController;const y=this.view.resourceController;this._memCache=y.memoryController.newCache(this.layer.uid,n=>{n.release()});const q=new $(this.layer.currentStyleInfo.style),b=l.mapTileRequester;this._tileHandler=new H(this.layer,q,t.contentPixelRatio,this._memCache,b);const R=this._tileHandlerController.signal,S=n=>y.immediate.schedule(n),T=this._tileHandler.start({signal:R,schedule:S}),L=this._tileHandler.spriteMosaic;L.then(n=>{!Z(R)&&this._tileHandler&&(this.painter=new E(n,this._tileHandler.glyphMosaic))}),T.then(()=>this._tileHandlerController=null),this.updatingHandles.add(()=>{var n;return{style:this.layer.currentStyleInfo.style,pixelRatio:(n=this.view.state)==null?void 0:n.contentPixelRatio}},({style:n,pixelRatio:c})=>{this._tileHandlerController&&this._tileHandlerController.abort(),this._tileHandlerController=new AbortController,this._memCache.clear();const u=new $(n),d=new H(this.layer,u,c,this._memCache,b),g=d.start({signal:this._tileHandlerController.signal,schedule:S}),v=d.spriteMosaic;g.then(()=>this._tileHandlerController=null),this.updatingHandles.addPromise(Promise.all([g,v]).then(([,O])=>{const V=this._tileHandler,I=this.painter;this.painter=new E(O,d.glyphMosaic),this._tileHandler=d,this.emit("data-changed"),V.destroy(),I&&I.dispose()}))});const D=Promise.all([h,T,L]);this.addResolvingPromise(D)}destroy(){this.painter=k(this.painter),this._tileHandlerController=ee(this._tileHandlerController),P(this._tileHandler),this._memCache=P(this._memCache),this._tileHandler=null}get dataLevelRange(){const l=this.tileInfo.lods,e=l[0].scale,t=l[l.length-1].scale,s=this.levelRangeFromScaleRange(e,t);return s.minLevel===1&&this.tileInfo.size[0]===256&&(s.minLevel=0),s}async fetchTile(l,e,t,s){return this._tileHandler.getVectorTile(l,e,t,s)}};C([w()],m.prototype,"layer",void 0),C([w()],m.prototype,"dataLevelRange",null),C([w()],m.prototype,"updatingProgressValue",void 0),m=C([te("esri.views.3d.layers.VectorTileLayerView3D")],m);const ze=m;export{ze as default};
