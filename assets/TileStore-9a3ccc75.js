import{it as E,R as b,ca as P,ee as S,iu as N,ag as F,$ as R,eb as C,ae as T,iv as j,gZ as k,Q as A,w as O,iw as z,ix as V,a6 as L,aJ as D}from"./calcite-8912bd40.js";import{l as J}from"./TileInfoView-9dfc6c79.js";let Q=class{constructor(e,s){this.item=e,this.controller=s,this.promise=null}},te=class{constructor(e){this._deferreds=new Map,this._controllers=new Map,this._processingItems=new Map,this._isPaused=!1,this._schedule=null,this._task=null,this.concurrency=1,e.concurrency&&(this.concurrency=e.concurrency),this._queue=new E(e.peeker),this.process=e.process;const s=e.scheduler;e.priority&&b(s)&&(this._task=s.registerTask(e.priority,this))}destroy(){this.clear(),this._schedule&&(this._schedule.remove(),this._schedule=null),this._task&&(this._task.remove(),this._task=null)}get length(){return this._processingItems.size+this._queue.length}abort(e){const s=this._controllers.get(e);s&&s.abort()}clear(){this._queue.clear();const e=[];this._controllers.forEach(s=>e.push(s)),this._controllers.clear(),e.forEach(s=>s.abort()),this._processingItems.clear(),this._cancelNext()}forEach(e){this._deferreds.forEach((s,i)=>e(i))}get(e){const s=this._deferreds.get(e);return s?s.promise:void 0}isOngoing(e){return this._processingItems.has(e)}has(e){return this._deferreds.has(e)}pause(){this._isPaused||(this._isPaused=!0,this._cancelNext())}push(e,s){const i=this.get(e);if(i)return i;const n=new AbortController;let h=null;s&&(h=P(s,()=>n.abort()));const r=()=>{const c=this._processingItems.get(e);c&&c.controller.abort(),o(),l.reject(T())},o=()=>{a.remove(),b(h)&&h.remove(),this._deferreds.delete(e),this._controllers.delete(e),this._queue.remove(e),this._processingItems.delete(e),this._scheduleNext()},a=S(n.signal,r),l=N();return this._deferreds.set(e,l),this._controllers.set(e,n),l.promise.then(o,o),this._queue.push(e),this._scheduleNext(),l.promise}last(){return this._queue.last()}peek(){return this._queue.peek()}popLast(){return this._queue.popLast()}reset(){const e=[];this._processingItems.forEach(s=>e.push(s)),this._processingItems.clear();for(const s of e)this._queue.push(s.item),s.controller.abort();this._scheduleNext()}resume(){this._isPaused&&(this._isPaused=!1,this._scheduleNext())}takeAll(){const e=[];for(;this._queue.length;)e.push(this._queue.pop());return this.clear(),e}get running(){return!this._isPaused&&this._queue.length>0&&this._processingItems.size<this.concurrency}runTask(e){for(;!e.done&&this._queue.length>0&&this._processingItems.size<this.concurrency;)this._process(this._queue.pop()),e.madeProgress()}_scheduleNext(){this._task||this._isPaused||this._schedule||(this._schedule=F(()=>{this._schedule=null,this._next()}))}_next(){for(;this._queue.length>0&&this._processingItems.size<this.concurrency;)this._process(this._queue.pop())}_cancelNext(){this._schedule&&(this._schedule.remove(),this._schedule=null)}_processResult(e,s){this._canProcessFulfillment(e)&&(this._scheduleNext(),this._deferreds.get(e.item).resolve(s))}_processError(e,s){this._canProcessFulfillment(e)&&(this._scheduleNext(),this._deferreds.get(e.item).reject(s))}_canProcessFulfillment(e){return!!this._deferreds.get(e.item)&&this._processingItems.get(e.item)===e}_process(e){if(R(e))return;let s;const i=new AbortController,n=new Q(e,i);this._processingItems.set(e,n);try{s=this.process(e,i.signal)}catch(h){this._processError(n,h)}C(s)?(n.promise=s,s.then(h=>this._processResult(n,h),h=>this._processError(n,h))):this._processResult(n,s)}get test(){return{update:e=>this.runTask(e)}}};function v(t,e){if(!(this instanceof v))return new v(t,e);this._maxEntries=Math.max(4,t||9),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),e&&(typeof e=="function"?this.toBBox=e:this._initFormat(e)),this.clear()}function K(t,e,s){if(!s)return e.indexOf(t);for(var i=0;i<e.length;i++)if(s(t,e[i]))return i;return-1}function m(t,e){_(t,0,t.children.length,e,t)}function _(t,e,s,i,n){n||(n=f(null)),n.minX=1/0,n.minY=1/0,n.maxX=-1/0,n.maxY=-1/0;for(var h,r=e;r<s;r++)h=t.children[r],p(n,t.leaf?i(h):h);return n}function p(t,e){return t.minX=Math.min(t.minX,e.minX),t.minY=Math.min(t.minY,e.minY),t.maxX=Math.max(t.maxX,e.maxX),t.maxY=Math.max(t.maxY,e.maxY),t}function w(t,e){return t.minX-e.minX}function I(t,e){return t.minY-e.minY}function X(t){return(t.maxX-t.minX)*(t.maxY-t.minY)}function g(t){return t.maxX-t.minX+(t.maxY-t.minY)}function W(t,e){return(Math.max(e.maxX,t.maxX)-Math.min(e.minX,t.minX))*(Math.max(e.maxY,t.maxY)-Math.min(e.minY,t.minY))}function Z(t,e){var s=Math.max(t.minX,e.minX),i=Math.max(t.minY,e.minY),n=Math.min(t.maxX,e.maxX),h=Math.min(t.maxY,e.maxY);return Math.max(0,n-s)*Math.max(0,h-i)}function Y(t,e){return t.minX<=e.minX&&t.minY<=e.minY&&e.maxX<=t.maxX&&e.maxY<=t.maxY}function x(t,e){return e.minX<=t.maxX&&e.minY<=t.maxY&&e.maxX>=t.minX&&e.maxY>=t.minY}function f(t){return{children:t,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function y(t,e,s,i,n){for(var h,r=[e,s];r.length;)(s=r.pop())-(e=r.pop())<=i||(h=e+Math.ceil((s-e)/i/2)*i,j(t,h,e,s,n),r.push(e,h,h,s))}v.prototype={all:function(){return this._all(this.data,[])},search:function(t){var e=this.data,s=[],i=this.toBBox;if(!x(t,e))return s;for(var n,h,r,o,a=[];e;){for(n=0,h=e.children.length;n<h;n++)r=e.children[n],x(t,o=e.leaf?i(r):r)&&(e.leaf?s.push(r):Y(t,o)?this._all(r,s):a.push(r));e=a.pop()}return s},collides:function(t){var e=this.data,s=this.toBBox;if(!x(t,e))return!1;for(var i,n,h,r,o=[];e;){for(i=0,n=e.children.length;i<n;i++)if(h=e.children[i],x(t,r=e.leaf?s(h):h)){if(e.leaf||Y(t,r))return!0;o.push(h)}e=o.pop()}return!1},load:function(t){if(!t||!t.length)return this;if(t.length<this._minEntries){for(var e=0,s=t.length;e<s;e++)this.insert(t[e]);return this}var i=this._build(t.slice(),0,t.length-1,0);if(this.data.children.length)if(this.data.height===i.height)this._splitRoot(this.data,i);else{if(this.data.height<i.height){var n=this.data;this.data=i,i=n}this._insert(i,this.data.height-i.height-1,!0)}else this.data=i;return this},insert:function(t){return t&&this._insert(t,this.data.height-1),this},clear:function(){return this.data=f([]),this},remove:function(t,e){if(!t)return this;for(var s,i,n,h,r=this.data,o=this.toBBox(t),a=[],l=[];r||a.length;){if(r||(r=a.pop(),i=a[a.length-1],s=l.pop(),h=!0),r.leaf&&(n=K(t,r.children,e))!==-1)return r.children.splice(n,1),a.push(r),this._condense(a),this;h||r.leaf||!Y(r,o)?i?(s++,r=i.children[s],h=!1):r=null:(a.push(r),l.push(s),s=0,i=r,r=r.children[0])}return this},toBBox:function(t){return t},compareMinX:w,compareMinY:I,toJSON:function(){return this.data},fromJSON:function(t){return this.data=t,this},_all:function(t,e){for(var s=[];t;)t.leaf?e.push.apply(e,t.children):s.push.apply(s,t.children),t=s.pop();return e},_build:function(t,e,s,i){var n,h=s-e+1,r=this._maxEntries;if(h<=r)return m(n=f(t.slice(e,s+1)),this.toBBox),n;i||(i=Math.ceil(Math.log(h)/Math.log(r)),r=Math.ceil(h/Math.pow(r,i-1))),(n=f([])).leaf=!1,n.height=i;var o,a,l,c,u=Math.ceil(h/r),M=u*Math.ceil(Math.sqrt(r));for(y(t,e,s,M,this.compareMinX),o=e;o<=s;o+=M)for(y(t,o,l=Math.min(o+M-1,s),u,this.compareMinY),a=o;a<=l;a+=u)c=Math.min(a+u-1,l),n.children.push(this._build(t,a,c,i-1));return m(n,this.toBBox),n},_chooseSubtree:function(t,e,s,i){for(var n,h,r,o,a,l,c,u;i.push(e),!e.leaf&&i.length-1!==s;){for(c=u=1/0,n=0,h=e.children.length;n<h;n++)a=X(r=e.children[n]),(l=W(t,r)-a)<u?(u=l,c=a<c?a:c,o=r):l===u&&a<c&&(c=a,o=r);e=o||e.children[0]}return e},_insert:function(t,e,s){var i=this.toBBox,n=s?t:i(t),h=[],r=this._chooseSubtree(n,this.data,e,h);for(r.children.push(t),p(r,n);e>=0&&h[e].children.length>this._maxEntries;)this._split(h,e),e--;this._adjustParentBBoxes(n,h,e)},_split:function(t,e){var s=t[e],i=s.children.length,n=this._minEntries;this._chooseSplitAxis(s,n,i);var h=this._chooseSplitIndex(s,n,i),r=f(s.children.splice(h,s.children.length-h));r.height=s.height,r.leaf=s.leaf,m(s,this.toBBox),m(r,this.toBBox),e?t[e-1].children.push(r):this._splitRoot(s,r)},_splitRoot:function(t,e){this.data=f([t,e]),this.data.height=t.height+1,this.data.leaf=!1,m(this.data,this.toBBox)},_chooseSplitIndex:function(t,e,s){var i,n,h,r,o,a,l,c;for(a=l=1/0,i=e;i<=s-e;i++)r=Z(n=_(t,0,i,this.toBBox),h=_(t,i,s,this.toBBox)),o=X(n)+X(h),r<a?(a=r,c=i,l=o<l?o:l):r===a&&o<l&&(l=o,c=i);return c},_chooseSplitAxis:function(t,e,s){var i=t.leaf?this.compareMinX:w,n=t.leaf?this.compareMinY:I;this._allDistMargin(t,e,s,i)<this._allDistMargin(t,e,s,n)&&t.children.sort(i)},_allDistMargin:function(t,e,s,i){t.children.sort(i);var n,h,r=this.toBBox,o=_(t,0,e,r),a=_(t,s-e,s,r),l=g(o)+g(a);for(n=e;n<s-e;n++)h=t.children[n],p(o,t.leaf?r(h):h),l+=g(o);for(n=s-e-1;n>=e;n--)h=t.children[n],p(a,t.leaf?r(h):h),l+=g(a);return l},_adjustParentBBoxes:function(t,e,s){for(var i=s;i>=0;i--)p(e[i],t)},_condense:function(t){for(var e,s=t.length-1;s>=0;s--)t[s].children.length===0?s>0?(e=t[s-1].children).splice(e.indexOf(t[s]),1):this.clear():m(t[s],this.toBBox)},_initFormat:function(t){var e=["return a"," - b",";"];this.compareMinX=new Function("a","b",e.join(t[0])),this.compareMinY=new Function("a","b",e.join(t[1])),this.toBBox=new Function("a","return {minX: a"+t[0]+", minY: a"+t[1]+", maxX: a"+t[2]+", maxY: a"+t[3]+"};")}};let $=class q{constructor(e,s){this.key=new k(0,0,0,0),this.bounds=A(),this.objectIds=new Set,this.key.set(s);const i=e.getLODInfoAt(this.key);this.tileInfoView=e,this.tileInfoView.getTileBounds(this.bounds,this.key,!0),this.resolution=i.resolution,this.scale=i.scale,this.level=i.level}get id(){return this.key.id}get extent(){return O.fromBounds(this.bounds,this.tileInfoView.tileInfo.spatialReference)}get transform(){return{originPosition:"upperLeft",scale:[this.resolution,this.resolution],translate:[this.bounds[0],this.bounds[3]]}}createChildTiles(){const e=this.key.getChildKeys(),s=z.acquire();for(let i=0;i<e.length;i++)s[i]=new q(this.tileInfoView,e[i]);return s}getQuantizationParameters(){return V.fromJSON({mode:"view",originPosition:"upperLeft",tolerance:this.resolution,extent:{xmin:this.bounds[0],ymin:this.bounds[1],xmax:this.bounds[2],ymax:this.bounds[3],spatialReference:this.tileInfoView.tileInfo.spatialReference}})}};const d={added:[],removed:[]},B=new Set,G=new k(0,0,0,0);let ie=class extends L{constructor(e){super(),this._tiles=new Map,this._index=v(9,D("esri-csp-restrictions")?s=>({minX:s.bounds[0],minY:s.bounds[1],maxX:s.bounds[2],maxY:s.bounds[3]}):[".bounds[0]",".bounds[1]",".bounds[2]",".bounds[3]"]),this.tiles=[],this.tileScheme=e}destroy(){this.clear()}clear(){this.tiles.length=0,this._tiles.clear(),this._index.clear()}has(e){return this._tiles.has(e)}get(e){return this._tiles.get(e)}boundsIntersections(e){return this._index.search({minX:e[0],minY:e[1],maxX:e[2],maxY:e[3]})}updateTiles(e){const s={added:[],removed:[]};for(const i of e.added)if(!this.has(i)){const n=new $(this.tileScheme,i);this._tiles.set(i,n),this._index.insert(n),s.added.push(n)}for(const i of e.removed)if(this.has(i)){const n=this.get(i);this._tiles.delete(i),this._index.remove(n),s.removed.push(n)}this.tiles.length=0,this._tiles.forEach(i=>this.tiles.push(i)),(s.added.length||s.removed.length)&&this.emit("update",s)}setViewState(e){const s=this.tileScheme.getTileCoverage(e,0);if(!s)return;const{spans:i,lodInfo:n}=s,{level:h}=n;if(i.length>0)for(const{row:r,colFrom:o,colTo:a}of i)for(let l=o;l<=a;l++){const c=G.set(h,r,n.normalizeCol(l),n.getWorldForColumn(l)).id;if(B.add(c),!this.has(c)){const u=new $(this.tileScheme,c);this._tiles.set(c,u),this._index.insert(u),this.tiles.push(u),d.added.push(u)}}for(let r=this.tiles.length-1;r>=0;r--){const o=this.tiles[r];B.has(o.id)||(this._tiles.delete(o.id),this.tiles.splice(r,1),this._index.remove(o),d.removed.push(o))}(d.added.length||d.removed.length)&&this.emit("update",d),J.pool.release(s),B.clear(),d.added.length=0,d.removed.length=0}};export{ie as d,v as i,te as l};
