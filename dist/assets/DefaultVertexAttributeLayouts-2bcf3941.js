import{s as Se,i as we}from"./mat3-3fc68e72.js";import{n as De}from"./Evented-a45c8b0f.js";import{h as be}from"./string-a318751c.js";import{t as re,r as F,x as Ae}from"./typedArrayUtil-4d7bb04c.js";import{D as j}from"./promiseUtils-1e54421e.js";import{e as Le}from"./TileKey-5aef17b6.js";import{f as X}from"./vec2f64-30dc1443.js";import{r as w}from"./context-util-a4ce3a7b.js";import{G as D,M as I,P as y,U as ie,L as b,D as B,o as g,H as x,t as R,C as A}from"./enums-64ab819c.js";import{E as V,c as k}from"./Texture-243be4d7.js";import{t as L}from"./VertexElementDescriptor-2925c6af.js";function ae(){return new Float32Array(4)}function Ce(r){const e=new Float32Array(4);return e[0]=r[0],e[1]=r[1],e[2]=r[2],e[3]=r[3],e}function E(r,e,i,t){const a=new Float32Array(4);return a[0]=r,a[1]=e,a[2]=i,a[3]=t,a}function Oe(r,e){return new Float32Array(r,e,4)}function oe(){return ae()}function ne(){return E(1,1,1,1)}function se(){return E(1,0,0,0)}function le(){return E(0,1,0,0)}function ce(){return E(0,0,1,0)}function ue(){return E(0,0,0,1)}const Pe=oe(),$e=ne(),Fe=se(),ke=le(),Ie=ce(),Be=ue();Object.freeze(Object.defineProperty({__proto__:null,create:ae,clone:Ce,fromValues:E,createView:Oe,zeros:oe,ones:ne,unitX:se,unitY:le,unitZ:ce,unitW:ue,ZEROS:Pe,ONES:$e,UNIT_X:Fe,UNIT_Y:ke,UNIT_Z:Ie,UNIT_W:Be},Symbol.toStringTag,{value:"Module"}));const Ve=1/be("mapview-transitions-duration");let Ge=class extends De{constructor(){super(...arguments),this._fadeOutResolver=null,this._fadeInResolver=null,this._clips=null,this.computedVisible=!0,this.computedOpacity=1,this.fadeTransitionEnabled=!1,this.inFadeTransition=!1,this._isReady=!1,this._opacity=1,this._stage=null,this._visible=!0}get clips(){return this._clips}set clips(e){this._clips=e,this.requestRender()}get isReady(){return this._isReady}get opacity(){return this._opacity}set opacity(e){this._opacity!==e&&(this._opacity=Math.min(1,Math.max(e,0)),this.requestRender())}get stage(){return this._stage}set stage(e){if(this._stage===e)return;const i=this._stage;this._stage=e,e?this._stage.untrashDisplayObject(this)||(this.onAttach(),this.emit("attach")):i.trashDisplayObject(this)}get transforms(){return this._getTransforms()}_getTransforms(){return re(this._transforms)&&(this._transforms=this._createTransforms()),this._transforms}get visible(){return this._visible}set visible(e){this._visible!==e&&(this._visible=e,this.requestRender())}fadeIn(){return this._fadeInResolver||(this._fadeOutResolver&&(this._fadeOutResolver(),this._fadeOutResolver=null),this.opacity=1,this.computedOpacity=0,this.fadeTransitionEnabled=!0,this._fadeInResolver=j(),this.requestRender()),this._fadeInResolver.promise}fadeOut(){return this._fadeOutResolver||(this.opacity=0,this._fadeInResolver&&(this._fadeInResolver(),this._fadeInResolver=null),this.fadeTransitionEnabled=!0,this._fadeOutResolver=j(),this.requestRender()),this._fadeOutResolver.promise}endTransitions(){var e,i;(e=this._fadeInResolver)==null||e.call(this),this._fadeInResolver=null,(i=this._fadeOutResolver)==null||i.call(this),this._fadeOutResolver=null,this.computedOpacity=this.visible?this.opacity:0,this.requestRender()}beforeRender(e){this.updateTransitionProperties(e.deltaTime,e.state.scale)}afterRender(e){this._fadeInResolver&&this.computedOpacity===this.opacity?(this._fadeInResolver(),this._fadeInResolver=null):this._fadeOutResolver&&this.computedOpacity===0&&(this._fadeOutResolver(),this._fadeOutResolver=null)}remove(){var e;(e=this.parent)==null||e.removeChild(this)}setTransform(e){}processRender(e){this.stage&&this.computedVisible&&this.doRender(e)}requestRender(){this.stage&&this.stage.requestRender()}processDetach(){this._fadeInResolver&&(this._fadeInResolver(),this._fadeInResolver=null),this._fadeOutResolver&&(this._fadeOutResolver(),this._fadeOutResolver=null),this.onDetach(),this.emit("detach")}updateTransitionProperties(e,i){if(this.fadeTransitionEnabled){const t=this._fadeOutResolver||!this.visible?0:this.opacity,a=this.computedOpacity;if(a===t)this.computedVisible=this.visible;else{const n=e*Ve;this.computedOpacity=a>t?Math.max(t,a-n):Math.min(t,a+n),this.computedVisible=this.computedOpacity>0;const o=t===this.computedOpacity;this.inFadeTransition=!o,o||this.requestRender()}}else this.computedOpacity=this.opacity,this.computedVisible=this.visible}onAttach(){}onDetach(){}doRender(e){}ready(){this._isReady||(this._isReady=!0,this.emit("isReady"),this.requestRender())}},Mt=class extends Ge{constructor(e,i,t,a,n,o,u=n,l=o){super(),this.triangleCountReportedInDebug=0,this.triangleCount=0,this.texture=null,this.key=new Le(e),this.resolution=i,this.x=t,this.y=a,this.width=n,this.height=o,this.rangeX=u,this.rangeY=l}destroy(){this.texture&&(this.texture.dispose(),this.texture=null)}setTransform(e){const i=this.resolution/(e.resolution*e.pixelRatio),t=this.transforms.tileMat3,[a,n]=e.toScreenNoRotation([0,0],[this.x,this.y]),o=this.width/this.rangeX*i,u=this.height/this.rangeY*i;Se(t,o,0,0,0,u,0,a,n,1),we(this.transforms.dvs,e.displayViewMat3,t)}};function Rt(r,e,i="nearest",t=!1){var s;const a=!(t&&e.pixelType==="u8"),n=a?D.FLOAT:D.UNSIGNED_BYTE,o=e.pixels==null||e.pixels.length===0?null:a?e.getAsRGBAFloat():e.getAsRGBA(),u=(s=r.capabilities.textureFloat)==null?void 0:s.textureFloatLinear,l={width:e.width,height:e.height,target:I.TEXTURE_2D,pixelFormat:y.RGBA,internalFormat:r.type===w.WEBGL2&&a?ie.RGBA32F:y.RGBA,samplingMode:!u||i!=="bilinear"&&i!=="cubic"?b.NEAREST:b.LINEAR,dataType:n,wrapMode:B.CLAMP_TO_EDGE,flipped:!1};return new V(r,l,o)}function St(r,e){const{spacing:i,offsets:t,coefficients:a,size:[n,o]}=e,u=i[0]>1,l={width:u?4*n:n,height:o,target:I.TEXTURE_2D,pixelFormat:y.RGBA,internalFormat:r.type===w.WEBGL2?ie.RGBA32F:y.RGBA,dataType:D.FLOAT,samplingMode:b.NEAREST,wrapMode:B.CLAMP_TO_EDGE,flipped:!1},s=new Float32Array(u?n*o*16:2*t.length);if(u)for(let c=0,f=0;c<a.length;c++)s[f++]=a[c],c%3==2&&(s[f++]=1);else for(let c=0;c<o;c++)for(let f=0;f<n;f++){const d=4*(c*n+f),h=2*(f*o+c);s[d]=t[h],s[d+1]=t[h+1],s[d+3]=t[h]===-1?0:1}return new V(r,l,s)}function wt(r,e){const i={width:e.length/4,height:1,target:I.TEXTURE_2D,pixelFormat:y.RGBA,internalFormat:y.RGBA,dataType:D.UNSIGNED_BYTE,samplingMode:b.NEAREST,wrapMode:B.CLAMP_TO_EDGE,flipped:!1};return new V(r,i,e)}function Dt(r,e,i,t=1,a=!0){return{u_flipY:a,u_applyTransform:!!r,u_opacity:t,u_transformSpacing:r?r.spacing:X,u_transformGridSize:r?r.size:X,u_targetImageSize:e,u_srcImageSize:i}}function bt(r,e){return{u_colormapOffset:e||0,u_colormapMaxIndex:r?r.length/4-1:0}}function At(r,e){return{u_scale:r,u_offset:e}}function Lt(r){return{u_bandCount:r.bandCount,u_minOutput:r.outMin,u_maxOutput:r.outMax,u_minCutOff:r.minCutOff,u_maxCutOff:r.maxCutOff,u_factor:r.factor,u_useGamma:r.useGamma,u_gamma:r.gamma,u_gammaCorrection:r.gammaCorrection}}function Ct(r){return{u_hillshadeType:r.hillshadeType,u_sinZcosAs:r.sinZcosAs,u_sinZsinAs:r.sinZsinAs,u_cosZs:r.cosZs,u_weights:r.weights,u_factor:r.factor,u_minValue:r.minValue,u_maxValue:r.maxValue}}function Ot(r,e){const i=r.gl,t=e.glName,a=i.getProgramParameter(t,i.ACTIVE_UNIFORMS),n=new Map;let o;for(let u=0;u<a;u++)o=i.getActiveUniform(t,u),o&&n.set(o.name,{location:i.getUniformLocation(t,o.name),info:o});return n}function Pt(r,e,i){Object.keys(i).forEach(t=>{const a=e.get(t)||e.get(t+"[0]");a&&Ne(r,t,i[t],a)})}function $t(r,e,i,t){i.length===t.length&&(t.some(a=>a==null)||i.some(a=>a==null)||i.forEach((a,n)=>{e.setUniform1i(a,n),r.bindTexture(t[n],n)}))}function Ne(r,e,i,t){if(t===null||i==null)return!1;const{info:a}=t;switch(a.type){case g.FLOAT:a.size>1?r.setUniform1fv(e,i):r.setUniform1f(e,i);break;case g.FLOAT_VEC2:r.setUniform2fv(e,i);break;case g.FLOAT_VEC3:r.setUniform3fv(e,i);break;case g.FLOAT_VEC4:r.setUniform4fv(e,i);break;case g.FLOAT_MAT3:r.setUniformMatrix3fv(e,i);break;case g.FLOAT_MAT4:r.setUniformMatrix4fv(e,i);break;case g.INT:a.size>1?r.setUniform1iv(e,i):r.setUniform1i(e,i);break;case g.BOOL:r.setUniform1i(e,i?1:0);break;case g.INT_VEC2:case g.BOOL_VEC2:r.setUniform2iv(e,i);break;case g.INT_VEC3:case g.BOOL_VEC3:r.setUniform3iv(e,i);break;case g.INT_VEC4:case g.BOOL_VEC4:r.setUniform4iv(e,i);break;default:return!1}return!0}const je=["layout","centroid","smooth","case","mat2x2","mat2x3","mat2x4","mat3x2","mat3x3","mat3x4","mat4x2","mat4x3","mat4x4","uint","uvec2","uvec3","uvec4","samplerCubeShadow","sampler2DArray","sampler2DArrayShadow","isampler2D","isampler3D","isamplerCube","isampler2DArray","usampler2D","usampler3D","usamplerCube","usampler2DArray","coherent","restrict","readonly","writeonly","resource","atomic_uint","noperspective","patch","sample","subroutine","common","partition","active","filter","image1D","image2D","image3D","imageCube","iimage1D","iimage2D","iimage3D","iimageCube","uimage1D","uimage2D","uimage3D","uimageCube","image1DArray","image2DArray","iimage1DArray","iimage2DArray","uimage1DArray","uimage2DArray","image1DShadow","image2DShadow","image1DArrayShadow","image2DArrayShadow","imageBuffer","iimageBuffer","uimageBuffer","sampler1DArray","sampler1DArrayShadow","isampler1D","isampler1DArray","usampler1D","usampler1DArray","isampler2DRect","usampler2DRect","samplerBuffer","isamplerBuffer","usamplerBuffer","sampler2DMS","isampler2DMS","usampler2DMS","sampler2DMSArray","isampler2DMSArray","usampler2DMSArray","trunc","round","roundEven","isnan","isinf","floatBitsToInt","floatBitsToUint","intBitsToFloat","uintBitsToFloat","packSnorm2x16","unpackSnorm2x16","packUnorm2x16","unpackUnorm2x16","packHalf2x16","unpackHalf2x16","outerProduct","transpose","determinant","inverse","texture","textureSize","textureProj","textureLod","textureOffset","texelFetch","texelFetchOffset","textureProjOffset","textureLodOffset","textureProjLod","textureProjLodOffset","textureGrad","textureGradOffset","textureProjGrad","textureProjGradOffset"];var H,fe={exports:{}};(H=["precision","highp","mediump","lowp","attribute","const","uniform","varying","break","continue","do","for","while","if","else","in","out","inout","float","int","void","bool","true","false","discard","return","mat2","mat3","mat4","vec2","vec3","vec4","ivec2","ivec3","ivec4","bvec2","bvec3","bvec4","sampler1D","sampler2D","sampler3D","samplerCube","sampler1DShadow","sampler2DShadow","struct","asm","class","union","enum","typedef","template","this","packed","goto","switch","default","inline","noinline","volatile","public","static","extern","external","interface","long","short","double","half","fixed","unsigned","input","output","hvec2","hvec3","hvec4","dvec2","dvec3","dvec4","fvec2","fvec3","fvec4","sampler2DRect","sampler3DRect","sampler2DRectShadow","sizeof","cast","namespace","using"])!==void 0&&(fe.exports=H);const Xe=fe.exports;var z,he={exports:{}};z=he,function(r){var e=["<<=",">>=","++","--","<<",">>","<=",">=","==","!=","&&","||","+=","-=","*=","/=","%=","&=","^^","^=","|=","(",")","[","]",".","!","~","*","/","%","+","-","<",">","&","^","|","?",":","=",",",";","{","}"];e!==void 0&&(z.exports=e)}();const q=he.exports;var me={exports:{}};(function(r){(function(e){var i=function(){return["abs","acos","all","any","asin","atan","ceil","clamp","cos","cross","dFdx","dFdy","degrees","distance","dot","equal","exp","exp2","faceforward","floor","fract","gl_BackColor","gl_BackLightModelProduct","gl_BackLightProduct","gl_BackMaterial","gl_BackSecondaryColor","gl_ClipPlane","gl_ClipVertex","gl_Color","gl_DepthRange","gl_DepthRangeParameters","gl_EyePlaneQ","gl_EyePlaneR","gl_EyePlaneS","gl_EyePlaneT","gl_Fog","gl_FogCoord","gl_FogFragCoord","gl_FogParameters","gl_FragColor","gl_FragCoord","gl_FragData","gl_FragDepth","gl_FragDepthEXT","gl_FrontColor","gl_FrontFacing","gl_FrontLightModelProduct","gl_FrontLightProduct","gl_FrontMaterial","gl_FrontSecondaryColor","gl_LightModel","gl_LightModelParameters","gl_LightModelProducts","gl_LightProducts","gl_LightSource","gl_LightSourceParameters","gl_MaterialParameters","gl_MaxClipPlanes","gl_MaxCombinedTextureImageUnits","gl_MaxDrawBuffers","gl_MaxFragmentUniformComponents","gl_MaxLights","gl_MaxTextureCoords","gl_MaxTextureImageUnits","gl_MaxTextureUnits","gl_MaxVaryingFloats","gl_MaxVertexAttribs","gl_MaxVertexTextureImageUnits","gl_MaxVertexUniformComponents","gl_ModelViewMatrix","gl_ModelViewMatrixInverse","gl_ModelViewMatrixInverseTranspose","gl_ModelViewMatrixTranspose","gl_ModelViewProjectionMatrix","gl_ModelViewProjectionMatrixInverse","gl_ModelViewProjectionMatrixInverseTranspose","gl_ModelViewProjectionMatrixTranspose","gl_MultiTexCoord0","gl_MultiTexCoord1","gl_MultiTexCoord2","gl_MultiTexCoord3","gl_MultiTexCoord4","gl_MultiTexCoord5","gl_MultiTexCoord6","gl_MultiTexCoord7","gl_Normal","gl_NormalMatrix","gl_NormalScale","gl_ObjectPlaneQ","gl_ObjectPlaneR","gl_ObjectPlaneS","gl_ObjectPlaneT","gl_Point","gl_PointCoord","gl_PointParameters","gl_PointSize","gl_Position","gl_ProjectionMatrix","gl_ProjectionMatrixInverse","gl_ProjectionMatrixInverseTranspose","gl_ProjectionMatrixTranspose","gl_SecondaryColor","gl_TexCoord","gl_TextureEnvColor","gl_TextureMatrix","gl_TextureMatrixInverse","gl_TextureMatrixInverseTranspose","gl_TextureMatrixTranspose","gl_Vertex","greaterThan","greaterThanEqual","inversesqrt","length","lessThan","lessThanEqual","log","log2","matrixCompMult","max","min","mix","mod","normalize","not","notEqual","pow","radians","reflect","refract","sign","sin","smoothstep","sqrt","step","tan","texture2D","texture2DLod","texture2DProj","texture2DProjLod","textureCube","textureCubeLod","texture2DLodEXT","texture2DProjLodEXT","textureCubeLodEXT","texture2DGradEXT","texture2DProjGradEXT","textureCubeGradEXT","textureSize","texelFetch"]}();i!==void 0&&(r.exports=i)})()})(me);const He=me.exports;var p=999,Y=9999,O=0,P=1,Z=2,W=3,K=4,S=5,ze=6,qe=7,Ye=8,Q=9,Ze=10,J=11,We=["block-comment","line-comment","preprocessor","operator","integer","float","ident","builtin","keyword","whitespace","eof","integer"];function Ke(){var r,e,i,t=0,a=0,n=p,o=[],u=[],l=1,s=0,c=0,f=!1,d=!1,h="";return function(m){return u=[],m!==null?_e(m.replace?m.replace(/\r\n/g,`
`):m):ge()};function _(m){m.length&&u.push({type:We[n],data:m,position:c,line:l,column:s})}function _e(m){var v;for(t=0,i=(h+=m).length;r=h[t],t<i;){switch(v=t,n){case O:t=ve();break;case P:t=Te();break;case Z:t=G();break;case W:t=ye();break;case K:t=Me();break;case J:t=Ee();break;case S:t=Ue();break;case Y:t=Re();break;case Q:t=xe();break;case p:t=pe()}v!==t&&(h[v]===`
`?(s=0,++l):++s)}return a+=t,h=h.slice(t),u}function ge(m){return o.length&&_(o.join("")),n=Ze,_("(eof)"),u}function pe(){return o=o.length?[]:o,e==="/"&&r==="*"?(c=a+t-1,n=O,e=r,t+1):e==="/"&&r==="/"?(c=a+t-1,n=P,e=r,t+1):r==="#"?(n=Z,c=a+t,t):/\s/.test(r)?(n=Q,c=a+t,t):(f=/\d/.test(r),d=/[^\w_]/.test(r),c=a+t,n=f?K:d?W:Y,t)}function xe(){return/[^\s]/g.test(r)?(_(o.join("")),n=p,t):(o.push(r),e=r,t+1)}function G(){return r!=="\r"&&r!==`
`||e==="\\"?(o.push(r),e=r,t+1):(_(o.join("")),n=p,t)}function Te(){return G()}function ve(){return r==="/"&&e==="*"?(o.push(r),_(o.join("")),n=p,t+1):(o.push(r),e=r,t+1)}function ye(){if(e==="."&&/\d/.test(r))return n=S,t;if(e==="/"&&r==="*")return n=O,t;if(e==="/"&&r==="/")return n=P,t;if(r==="."&&o.length){for(;C(o););return n=S,t}if(r===";"||r===")"||r==="("){if(o.length)for(;C(o););return _(r),n=p,t+1}var m=o.length===2&&r!=="=";if(/[\w_\d\s]/.test(r)||m){for(;C(o););return n=p,t}return o.push(r),e=r,t+1}function C(m){for(var v,M,N=0;;){if(v=q.indexOf(m.slice(0,m.length+N).join("")),M=q[v],v===-1){if(N--+m.length>0)continue;M=m.slice(0,1).join("")}return _(M),c+=M.length,(o=o.slice(M.length)).length}}function Ee(){return/[^a-fA-F0-9]/.test(r)?(_(o.join("")),n=p,t):(o.push(r),e=r,t+1)}function Me(){return r==="."||/[eE]/.test(r)?(o.push(r),n=S,e=r,t+1):r==="x"&&o.length===1&&o[0]==="0"?(n=J,o.push(r),e=r,t+1):/[^\d]/.test(r)?(_(o.join("")),n=p,t):(o.push(r),e=r,t+1)}function Ue(){return r==="f"&&(o.push(r),e=r,t+=1),/[eE]/.test(r)||r==="-"&&/[eE]/.test(e)?(o.push(r),e=r,t+1):/[^\d]/.test(r)?(_(o.join("")),n=p,t):(o.push(r),e=r,t+1)}function Re(){if(/[^\d\w_]/.test(r)){var m=o.join("");return n=Xe.indexOf(m)>-1?Ye:He.indexOf(m)>-1?qe:ze,_(o.join("")),n=p,t}return o.push(r),e=r,t+1}}function Qe(r){var e=Ke(),i=[];return i=(i=i.concat(e(r))).concat(e(null))}function Je(r){return Qe(r)}function et(r){return r.map(e=>e.type!=="eof"?e.data:"").join("")}const $=["GL_OES_standard_derivatives","GL_EXT_frag_depth","GL_EXT_draw_buffers","GL_EXT_shader_texture_lod"];function tt(r,e="100",i="300 es"){const t=/^\s*\#version\s+([0-9]+(\s+[a-zA-Z]+)?)\s*/;for(const a of r)if(a.type==="preprocessor"){const n=t.exec(a.data);if(n){const o=n[1].replace(/\s\s+/g," ");if(o===i)return o;if(o===e)return a.data="#version "+i,e;throw new Error("unknown glsl version: "+o)}}return r.splice(0,0,{type:"preprocessor",data:"#version "+i},{type:"whitespace",data:`
`}),null}function rt(r,e){for(let i=e-1;i>=0;i--){const t=r[i];if(t.type!=="whitespace"&&t.type!=="block-comment"){if(t.type!=="keyword")break;if(t.data==="attribute"||t.data==="in")return!0}}return!1}function U(r,e,i,t){t=t||i;for(const a of r)if(a.type==="ident"&&a.data===i)return t in e?e[t]++:e[t]=0,U(r,e,t+"_"+e[t],t);return i}function de(r,e,i="afterVersion"){function t(l,s){for(let c=s;c<l.length;c++){const f=l[c];if(f.type==="operator"&&f.data===";")return c}return null}function a(l){let s=-1,c=0,f=-1;for(let d=0;d<l.length;d++){const h=l[d];if(h.type==="preprocessor"&&(h.data.match(/\#(if|ifdef|ifndef)\s+.+/)?++c:h.data.match(/\#endif\s*.*/)&&--c),i!=="afterVersion"&&i!=="afterPrecision"||h.type==="preprocessor"&&/^#version/.test(h.data)&&(f=Math.max(f,d)),i==="afterPrecision"&&h.type==="keyword"&&h.data==="precision"){const _=t(l,d);if(_===null)throw new Error("precision statement not followed by any semicolons!");f=Math.max(f,_)}s<f&&c===0&&(s=d)}return s+1}const n={data:`
`,type:"whitespace"},o=l=>l<r.length&&/[^\r\n]$/.test(r[l].data);let u=a(r);o(u-1)&&r.splice(u++,0,n);for(const l of e)r.splice(u++,0,l);o(u-1)&&o(u)&&r.splice(u,0,n)}function it(r,e,i,t="lowp"){de(r,[{type:"keyword",data:"out"},{type:"whitespace",data:" "},{type:"keyword",data:t},{type:"whitespace",data:" "},{type:"keyword",data:i},{type:"whitespace",data:" "},{type:"ident",data:e},{type:"operator",data:";"}],"afterPrecision")}function at(r,e,i,t,a="lowp"){de(r,[{type:"keyword",data:"layout"},{type:"operator",data:"("},{type:"keyword",data:"location"},{type:"whitespace",data:" "},{type:"operator",data:"="},{type:"whitespace",data:" "},{type:"integer",data:t.toString()},{type:"operator",data:")"},{type:"whitespace",data:" "},{type:"keyword",data:"out"},{type:"whitespace",data:" "},{type:"keyword",data:a},{type:"whitespace",data:" "},{type:"keyword",data:i},{type:"whitespace",data:" "},{type:"ident",data:e},{type:"operator",data:";"}],"afterPrecision")}function ot(r,e){let i,t,a=-1;for(let n=e;n<r.length;n++){const o=r[n];if(o.type==="operator"&&(o.data==="["&&(i=n),o.data==="]")){t=n;break}o.type==="integer"&&(a=parseInt(o.data,10))}return i&&t&&r.splice(i,t-i+1),a}function ee(r,e){const i=nt();if(F(i))return i;const t=Je(r);if(tt(t,"100","300 es")==="300 es")return r;let a=null,n=null;const o={},u={};for(let l=0;l<t.length;++l){const s=t[l];switch(s.type){case"keyword":e===x.VERTEX_SHADER&&s.data==="attribute"?s.data="in":s.data==="varying"&&(s.data=e===x.VERTEX_SHADER?"out":"in");break;case"builtin":if(/^texture(2D|Cube)(Proj)?(Lod|Grad)?(EXT)?$/.test(s.data.trim())&&(s.data=s.data.replace(/(2D|Cube|EXT)/g,"")),e===x.FRAGMENT_SHADER&&s.data==="gl_FragColor"&&(a||(a=U(t,o,"fragColor"),it(t,a,"vec4")),s.data=a),e===x.FRAGMENT_SHADER&&s.data==="gl_FragData"){const c=ot(t,l+1),f=U(t,o,"fragData");at(t,f,"vec4",c,"mediump"),s.data=f}else e===x.FRAGMENT_SHADER&&s.data==="gl_FragDepthEXT"&&(n||(n=U(t,o,"gl_FragDepth")),s.data=n);break;case"ident":if(je.includes(s.data)){if(e===x.VERTEX_SHADER&&rt(t,l))throw new Error("attribute in vertex shader uses a name that is a reserved word in glsl 300 es");s.data in u||(u[s.data]=U(t,o,s.data)),s.data=u[s.data]}}}for(let l=t.length-1;l>=0;--l){const s=t[l];if(s.type==="preprocessor"){const c=s.data.match(/\#extension\s+(.*)\:/);if(c&&c[1]&&$.includes(c[1].trim())){const h=t[l+1];t.splice(l,h&&h.type==="whitespace"?2:1)}const f=s.data.match(/\#ifdef\s+(.*)/);f&&f[1]&&$.includes(f[1].trim())&&(s.data="#if 1");const d=s.data.match(/\#ifndef\s+(.*)/);d&&d[1]&&$.includes(d[1].trim())&&(s.data="#if 0")}}return st(r,et(t))}function nt(r){return null}function st(r,e){return e}const lt=4294967295;class Ft{constructor(e,i,t,a,n=new Map){this._context=e,this._locations=a,this._uniformBlockBindings=n,this._refCount=1,this._compiled=!1,this._nameToUniformLocation={},this._nameToUniform1={},this._nameToUniform1v=new Map,this._nameToUniform2=new Map,this._nameToUniform3=new Map,this._nameToUniform4=new Map,this._nameToUniformMatrix3=new Map,this._nameToUniformMatrix4=new Map,e||console.error("RenderingContext isn't initialized!"),i.length===0&&console.error("Shaders source should not be empty!"),this._context.type===w.WEBGL2&&(i=ee(i,x.VERTEX_SHADER),t=ee(t,x.FRAGMENT_SHADER)),this._vShader=te(this._context,x.VERTEX_SHADER,i),this._fShader=te(this._context,x.FRAGMENT_SHADER,t),this._vShader&&this._fShader||console.error("Error loading shaders!"),this._context.instanceCounter.increment(R.Shader,this),k()&&(this.vertexShader=i,this.fragmentShader=t)}get glName(){if(F(this._glName))return this._glName;if(re(this._vShader))return null;const e=this._context.gl,i=e.createProgram();if(e.attachShader(i,this._vShader),e.attachShader(i,this._fShader),this._locations.forEach((t,a)=>e.bindAttribLocation(i,t,a)),e.linkProgram(i),k()&&!e.getProgramParameter(i,e.LINK_STATUS)&&console.error(`Could not link shader
validated: ${e.getProgramParameter(i,e.VALIDATE_STATUS)}, gl error ${e.getError()}, vertex: ${e.getShaderParameter(this._vShader,e.COMPILE_STATUS)}, fragment: ${e.getShaderParameter(this._fShader,e.COMPILE_STATUS)}, info log: ${e.getProgramInfoLog(i)}, vertex source: ${this.vertexShader}, fragment source: ${this.fragmentShader}`),this._context.type===w.WEBGL2){const t=e;for(const[a,n]of this._uniformBlockBindings){const o=t.getUniformBlockIndex(i,a);o<lt&&t.uniformBlockBinding(i,o,n)}}return this._glName=i,this._context.instanceCounter.increment(R.Program,this),i}get hasGLName(){return F(this._glName)}get isCompiled(){if(this._compiled)return!0;const e=this._context.gl.getExtension("KHR_parallel_shader_compile");return e==null?(this._compiled=!0,!0):(this._compiled=!!this._context.gl.getProgramParameter(this.glName,e.COMPLETION_STATUS_KHR),this._compiled)}dispose(){if(--this._refCount>0)return;const e=this._context.gl;this._vShader&&(e.deleteShader(this._vShader),this._vShader=null,this._context.instanceCounter.decrement(R.Shader,this)),this._fShader&&(e.deleteShader(this._fShader),this._fShader=null),this._glName&&(e.deleteProgram(this._glName),this._glName=null,this._context.instanceCounter.decrement(R.Program,this))}ref(){++this._refCount}_getUniformLocation(e){return this._nameToUniformLocation[e]===void 0&&(this._nameToUniformLocation[e]=this._context.gl.getUniformLocation(this.glName,e)),this._nameToUniformLocation[e]}hasUniform(e){return this._getUniformLocation(e)!==null}setUniform1i(e,i){const t=this._nameToUniform1[e];t!==void 0&&i===t||(this._context.gl.uniform1i(this._getUniformLocation(e),i),this._nameToUniform1[e]=i)}setUniform1iv(e,i){T(this._nameToUniform1v,e,i)&&this._context.gl.uniform1iv(this._getUniformLocation(e),i)}setUniform2iv(e,i){T(this._nameToUniform2,e,i)&&this._context.gl.uniform2iv(this._getUniformLocation(e),i)}setUniform3iv(e,i){T(this._nameToUniform3,e,i)&&this._context.gl.uniform3iv(this._getUniformLocation(e),i)}setUniform4iv(e,i){T(this._nameToUniform4,e,i)&&this._context.gl.uniform4iv(this._getUniformLocation(e),i)}setUniform1f(e,i){const t=this._nameToUniform1[e];t!==void 0&&i===t||(this._context.gl.uniform1f(this._getUniformLocation(e),i),this._nameToUniform1[e]=i)}setUniform1fv(e,i){T(this._nameToUniform1v,e,i)&&this._context.gl.uniform1fv(this._getUniformLocation(e),i)}setUniform2f(e,i,t){const a=this._nameToUniform2.get(e);a===void 0?(this._context.gl.uniform2f(this._getUniformLocation(e),i,t),this._nameToUniform2.set(e,[i,t])):i===a[0]&&t===a[1]||(this._context.gl.uniform2f(this._getUniformLocation(e),i,t),a[0]=i,a[1]=t)}setUniform2fv(e,i){T(this._nameToUniform2,e,i)&&this._context.gl.uniform2fv(this._getUniformLocation(e),i)}setUniform3f(e,i,t,a){const n=this._nameToUniform3.get(e);n===void 0?(this._context.gl.uniform3f(this._getUniformLocation(e),i,t,a),this._nameToUniform3[e]=[i,t,a]):i===n[0]&&t===n[1]&&a===n[2]||(this._context.gl.uniform3f(this._getUniformLocation(e),i,t,a),n[0]=i,n[1]=t,n[2]=a)}setUniform3fv(e,i){T(this._nameToUniform3,e,i)&&this._context.gl.uniform3fv(this._getUniformLocation(e),i)}setUniform4f(e,i,t,a,n){const o=this._nameToUniform4.get(e);o===void 0?(this._context.gl.uniform4f(this._getUniformLocation(e),i,t,a,n),this._nameToUniform4.set(e,[i,t,a,n])):o!==void 0&&i===o[0]&&t===o[1]&&a===o[2]&&n===o[3]||(this._context.gl.uniform4f(this._getUniformLocation(e),i,t,a,n),o[0]=i,o[1]=t,o[2]=a,o[3]=n)}setUniform4fv(e,i){T(this._nameToUniform4,e,i)&&this._context.gl.uniform4fv(this._getUniformLocation(e),i)}setUniformMatrix3fv(e,i,t=!1){T(this._nameToUniformMatrix3,e,i)&&this._context.gl.uniformMatrix3fv(this._getUniformLocation(e),t,i)}setUniformMatrix4fv(e,i,t=!1){T(this._nameToUniformMatrix4,e,i)&&this._context.gl.uniformMatrix4fv(this._getUniformLocation(e),t,i)}stop(){}}function te(r,e,i){const t=r.gl,a=t.createShader(e);return t.shaderSource(a,i),t.compileShader(a),k()&&!t.getShaderParameter(a,t.COMPILE_STATUS)&&(console.error("Compile error in ".concat(e===x.VERTEX_SHADER?"vertex":"fragment"," shader")),console.error(t.getShaderInfoLog(a)),console.error(ct(i))),a}function ct(r){let e=2;return r.replace(/\n/g,()=>`
`+ut(e++)+":")}function ut(r){return r>=1e3?r.toString():("  "+r).slice(-3)}function T(r,e,i){const t=r.get(e);return t?Ae(t,i):(r.set(e,Array.from(i)),!0)}const kt={geometry:[new L("a_pos",2,A.BYTE,0,2)]},It={geometry:[new L("a_pos",2,A.BYTE,0,4),new L("a_tex",2,A.BYTE,2,4)]},Bt={geometry:[new L("a_pos",2,A.UNSIGNED_SHORT,0,4)]};export{Ot as A,Ct as E,$t as O,Lt as T,Dt as _,Mt as a,Bt as b,St as c,Ge as d,Pt as e,kt as f,At as g,Ft as h,Ce as i,wt as l,Rt as m,ae as n,bt as p,E as r,It as t};
